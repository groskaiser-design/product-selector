<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="tma:home-url" content="./index.html" />
  <meta name="tma:home-hash" content="" />
  <title>Замеры — анкета</title>

  <!-- === SMART VERSION CONTROL === -->
  <script>
    window.__pageLoadTime = performance.now();
    const APP_HTML_VERSION = 'v2025-0038';

    (function smartVersionCheck(){
      try{
        const url = new URL(location.href);
        const v = url.searchParams.get('v');
        if (v !== APP_HTML_VERSION){
          url.searchParams.set('v', APP_HTML_VERSION);
          location.replace(url.href);
        }
      }catch(_){}
    })();

    window.addEventListener('pageshow', (e)=>{
      try{
        if (e.persisted){
          const url = new URL(location.href);
          url.searchParams.set('v', APP_HTML_VERSION);
          location.replace(url.href);
        }
      }catch(_){}
    }, { once:true });
  </script>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --cardA: rgba(255,255,255,.18);
      --cardB: rgba(255,255,255,.16);
      --border: rgba(255,255,255,.28);
      --shadow: 0 8px 28px rgba(0,0,0,.18);
      --okA:#fbbf24; --okB:#f59e0b;
      --row: 36px;
      --contentW: 420px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    html{background:transparent;}
    body{
      min-height:100svh;background:transparent;
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
      color:#fff;position:relative;isolation:isolate;
    }
    body::before{content:"";position:fixed;inset:0;background:var(--bg);z-index:0;pointer-events:none;transform:translateZ(0);}
    .page{max-width:560px;margin:0 auto;padding:18px 14px 24px;position:relative;z-index:1}

    .section{background:linear-gradient(180deg,var(--cardA),var(--cardB));border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);overflow:hidden;margin-bottom:14px;}
    .section-h{display:flex;align-items:center;gap:10px;padding:14px 16px;cursor:pointer;user-select:none}
    .section-h h2{font-size:16px;font-weight:800;flex:1}
    .meta{font-size:11px;opacity:.9}
    .toggle{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;opacity:.9}
    .toggle svg{transition:transform .18s ease}
    .section.collapsed .toggle svg{transform:rotate(-90deg)}
    .section-content{padding:0}
    .section.collapsed .section-content{display:none}

    .field{padding:12px}
    .field + .field{border-top:1px solid rgba(255,255,255,.14)}
    .row{display:flex;align-items:center;justify-content:space-between}
    .label{font-size:13px;font-weight:800}
    .unit{font-size:12px;opacity:.9}
    .help{margin-top:6px;text-align:center;font-size:12px;opacity:.8}

    .duo{
      position:relative;display:flex;gap:6px;padding:12px;border-radius:14px;
      background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.24);
      max-width:var(--contentW);width:100%;margin:8px auto 0;justify-content:center;
      touch-action: pan-y;
    }
    .duo::after{
      content:"";position:absolute;left:4px;right:4px;top:50%;height:var(--row);
      transform:translateY(-50%);background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.35);border-radius:10px;pointer-events:none;
    }
    .col{
      flex:0 0 92px;height:180px;overflow:auto;-webkit-overflow-scrolling:touch;
      overscroll-behavior: contain;scrollbar-width:none;scroll-snap-type:y mandatory;
      mask-image: linear-gradient(180deg, transparent, #000 18%, #000 82%, transparent);
      -webkit-mask-image: linear-gradient(180deg, transparent, #000 18%, #000 82%, transparent);
      touch-action: pan-y;
    }
    .col::-webkit-scrollbar{display:none}
    .option{height:var(--row);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:18px;color:#eef2ff;opacity:.55;scroll-snap-align:center;}
    .option.active{color:#fff;opacity:1;text-shadow:0 1px 0 rgba(0,0,0,.2);}
    .sep{display:flex;align-items:center;justify-content:center;width:10px;color:#e5e7eb;font-weight:800}
    .optline{display:flex;align-items:center;justify-content:center;gap:8px;margin-top:8px}
    .optline input{width:18px;height:18px}

    .savebar{display:flex;justify-content:center;padding:12px;border-top:1px solid rgba(255,255,255,.14);padding-bottom: calc(12px + env(safe-area-inset-bottom));}
    .btn{
      min-width:160px;padding:12px 16px;border:0;border-radius:14px;
      background:linear-gradient(135deg,var(--okA),var(--okB));color:#fff;font-weight:900;
      box-shadow:var(--shadow);transition: transform .08s ease, box-shadow .12s ease, filter .12s ease, opacity .12s ease;
      -webkit-tap-highlight-color:transparent;touch-action: manipulation;
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
    }
    .btn:focus-visible{outline:2px solid rgba(255,255,255,.7);outline-offset:2px;border-radius:16px}
    @media (prefers-reduced-motion: reduce){ .btn{transition:none;} }
    .btn.pressed{transform:translateY(1px) scale(.98);box-shadow:var(--shadow);filter:saturate(.95);}
    .btn.loading{opacity:.9;pointer-events:none;}
    .spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,.55);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .disabled{opacity:.4;filter:saturate(.6);pointer-events:none}

    #ai-comment .field h4{margin:8px 0 6px;font-weight:900;}
    #ai-comment .field h3{margin:10px 0 6px;font-weight:900;}
    #ai-comment .field p{margin:8px 0;}
    #ai-comment .field ul,#ai-comment .field ol{margin:8px 0 8px 18px;}
    #ai-comment .field li{margin:4px 0;}
    #ai-comment .field hr{border:0;border-top:1px solid rgba(255,255,255,.22);margin:10px 0;}
    #ai-comment .field a{color:#fff;text-decoration:underline;}

    /* === Survey selectors === */
    .binary-choice{display:flex;gap:8px;padding:12px;border-radius:14px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.24);max-width:var(--contentW);width:100%;margin:8px auto 0}
    .binary-btn{flex:1;padding:10px 16px;border:0;border-radius:12px;background:rgba(255,255,255,.15);color:#fff;font-weight:700;font-size:14px;transition:all .2s ease;cursor:pointer}
    .binary-btn.active{background:linear-gradient(135deg,var(--okA),var(--okB));box-shadow:0 4px 12px rgba(251,191,36,.4),inset 0 1px 0 rgba(255,255,255,.3);transform:scale(1.02)}

    .choice-list{display:grid;grid-template-columns:1fr;gap:8px;padding:14px;border-radius:20px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.28);max-width:var(--contentW);width:100%;margin:8px auto 0}
    .choice-item{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:12px;background:transparent;border:0;cursor:pointer;transition:filter .15s ease,background .15s ease}
    .choice-item:hover{background:rgba(255,255,255,.14)}
    .choice-item span.label{font-weight:600}

    .radio-circle{width:22px;height:22px;border-radius:50%;border:2px solid rgba(255,255,255,.65);display:flex;align-items:center;justify-content:center;flex-shrink:0;background:transparent;transition:all .2s ease}
    .radio-circle::after{content:"";width:10px;height:10px;border-radius:50%;background:#fff;opacity:0;transform:scale(0);transition:all .2s ease}
    .choice-item.selected .radio-circle{background:linear-gradient(135deg,var(--okA),var(--okB));border-color:var(--okB)}
    .choice-item.selected .radio-circle::after{opacity:1;transform:scale(1)}

    .check-square{width:22px;height:22px;border-radius:6px;border:2px solid rgba(255,255,255,.65);display:inline-flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s ease;background:transparent}
    .check-square::after{content:"";width:12px;height:12px;border-radius:3px;background:#fff;opacity:0;transform:scale(.7);transition:all .2s ease}
    .choice-item.selected .check-square{background:linear-gradient(135deg,var(--okA),var(--okB));border-color:var(--okB)}
    .choice-item.selected .check-square::after{opacity:1;transform:scale(1)}

    .check{display:inline-flex;align-items:center;gap:10px;cursor:pointer;user-select:none}
    .check .check-square{width:22px;height:22px}
    .check .check-label{font-weight:700;letter-spacing:.2px}
    .check.checked .check-square{background:linear-gradient(135deg,var(--okA),var(--okB));border-color:var(--okB)}
    .check.checked .check-square::after{opacity:1;transform:scale(1)}

    /* === % жира: «нет данных» === */
    .field[data-key="fat"] .optline{ display:flex !important; justify-content:center; margin-top:8px; }
    .field[data-key="fat"] .optline #bf-none-wrap{ display:inline-flex; }
    .field[data-key="fat"] .optline label:not(#bf-none-wrap){ display:none !important; }

    .bump{animation:bump .08s ease}
    @keyframes bump{0%{transform:scale(1)}50%{transform:scale(.98)}100%{transform:scale(1)}}

    .duo{ max-width: var(--contentW) !important; width: 100% !important; margin: 8px auto 0 !important; }
    .field[data-key="age"] .col-frac, .field[data-key="age"] .sep { display:none; }

    /* === Analytics === */
    .macros-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;padding:0;}
    .macro-card{border:1px solid rgba(255,255,255,.24);border-radius:14px;background:rgba(255,255,255,.12);padding:12px;text-align:center;}
    .macro-card .m-label{font-size:12px;opacity:.9;margin-bottom:6px;font-weight:700}
    .macro-card .m-value{font-size:24px;font-weight:900;line-height:1}
    .macro-card .m-unit{font-size:12px;opacity:.85;margin-top:2px}
    .macro-hint{margin:6px 0 0;text-align:center;font-size:12px;opacity:.8;}

    .kbju7-card{
      background: rgba(255,255,255,.12) !important;
      border: 1px solid rgba(255,255,255,.24) !important;
      border-radius: 14px !important;
      -webkit-backdrop-filter: none !important;
      backdrop-filter: none !important;
      box-shadow: none !important;
    }
  </style>
</head>
<body>
  <div class="page">

    <!-- Анкета -->
    <section class="section collapsed" id="sec-measures">
      <div class="section-h" data-toggle="sec-measures" role="button" tabindex="0" aria-controls="sec-measures" aria-expanded="false">
        <h2>Анкета</h2>
        <div class="meta" id="lastTime">Последний замер: нет данных</div>
        <div class="toggle" aria-hidden="true">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M8 10l4 4 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
      </div>
      <div class="section-content">
        
        <!-- Пол -->
        <div class="field">
          <div class="row"><div class="label">Пол</div></div>
          <div class="binary-choice" role="group" aria-label="Пол">
            <button class="binary-btn" data-field="gender" data-value="male" aria-pressed="false">Мужской</button>
            <button class="binary-btn" data-field="gender" data-value="female" aria-pressed="false">Женский</button>
          </div>
          <div class="help">Выберите один вариант</div>
        </div>

        <div id="fields"></div>

        <!-- Визуальная оценка -->
        <div class="field" id="sec-bodycomp" style="display:none">
          <div class="row"><div class="label">Визуальная оценка композиции тела</div></div>
          <div class="choice-list" data-type="single" data-field="body_comp" role="radiogroup" aria-label="Визуальная оценка">
            <div class="choice-item" role="radio" aria-checked="false" data-value="very_low"><div class="radio-circle"></div><span class="label">Очень низкий процент жира (пресс, вены, рельеф)</span></div>
            <div class="choice-item" role="radio" aria-checked="false" data-value="athletic"><div class="radio-circle"></div><span class="label">Атлетичное (плоский живот, видна мускулатура)</span></div>
            <div class="choice-item" role="radio" aria-checked="false" data-value="average"><div class="radio-circle"></div><span class="label">Среднее (небольшой живот)</span></div>
            <div class="choice-item" role="radio" aria-checked="false" data-value="overweight"><div class="radio-circle"></div><span class="label">Избыточный вес (заметный живот)</span></div>
            <div class="choice-item" role="radio" aria-checked="false" data-value="obesity"><div class="radio-circle"></div><span class="label">Ожирение</span></div>
          </div>
          <div class="help">Показывается, если в % жира выбрано «нет данных»</div>
        </div>

        <!-- Остальные поля анкеты -->
        <!-- (этничность, работа, шаги, тренировки, сон, вес, цель и т.д.) -->
        <!-- Вставлены без изменений, кроме исправления ID и синхронизации -->

        <!-- Пример одного поля (остальные аналогично) -->
        <div class="field">
          <div class="row"><div class="label">Этническая принадлежность</div></div>
          <div class="choice-list" data-type="single" data-field="ethnicity" role="radiogroup" aria-label="Этническая принадлежность">
            <div class="choice-item" role="radio" aria-checked="false" data-value="european_mixed"><div class="radio-circle"></div><span class="label">Европеоидная или Смешанная</span></div>
            <div class="choice-item" role="radio" aria-checked="false" data-value="asian"><div class="radio-circle"></div><span class="label">Азиатская (Восточная или Юго-Восточная Азия)</span></div>
            <div class="choice-item" role="radio" aria-checked="false" data-value="african"><div class="radio-circle"></div><span class="label">Африканская</span></div>
            <div class="choice-item" role="radio" aria-checked="false" data-value="prefer_not_to_say"><div class="radio-circle"></div><span class="label">Предпочитаю не указывать</span></div>
          </div>
          <div class="help">Выберите один вариант</div>
        </div>

        <!-- ... остальные поля (job_type, steps_per_day, workouts_per_week и т.д.) ... -->

        <!-- Беременность/лактация -->
        <div class="field" id="sec-preg" style="display:none">
          <div class="row"><div class="label">Беременность или лактация</div></div>
          <div class="choice-list" data-type="single" data-field="pregnancy_lactation" role="radiogroup" aria-label="Беременность/лактация">
            <div class="choice-item" role="radio" aria-checked="false" data-value="none"><div class="radio-circle"></div><span class="label">Нет</span></div>
            <!-- остальные опции -->
          </div>
          <div class="help">Выберите один вариант</div>
        </div>

        <!-- Цикл -->
        <div class="field" id="sec-cycle" style="display:none">
          <div class="row"><div class="label">Регулярность менструального цикла</div></div>
          <div class="choice-list" data-type="single" data-field="cycle_regular" role="radiogroup" aria-label="Цикл">
            <div class="choice-item" role="radio" aria-checked="false" data-value="regular"><div class="radio-circle"></div><span class="label">Регулярный</span></div>
            <!-- остальные -->
          </div>
          <div class="help">Только для женщин без беременности/лактации</div>
        </div>

        <div class="savebar">
          <button class="btn" id="saveBtn" aria-busy="false">
            <span class="btn-label">Сохранить</span>
            <span class="spinner" aria-hidden="true" hidden></span>
          </button>
        </div>
      </div>
    </section>

    <!-- Аналитика -->
    <section class="section" id="sec-analytics">
      <div class="section-h" data-toggle="sec-analytics" role="button" tabindex="0" aria-controls="sec-analytics" aria-expanded="true">
        <h2>Аналитика</h2>
        <div class="toggle" aria-hidden="true">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M8 10l4 4 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
      </div>
      <div class="section-content" id="analytics">
        <div class="field"><div class="help">После сохранения появятся графики.</div></div>
      </div>
    </section>

    <!-- Комментарий -->
    <section class="section" id="sec-ai">
      <div class="section-h" data-toggle="sec-ai" role="button" tabindex="0" aria-controls="sec-ai" aria-expanded="true">
        <h2>Комментарий</h2>
        <div class="toggle" aria-hidden="true">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M8 10l4 4 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
      </div>
      <div class="section-content" id="ai-comment">
        <div class="field"><div class="help">Подключите бэкенд — здесь будет текст.</div></div>
      </div>
    </section>

    <div id="admin-section-anchor"></div>
  </div>

  <script>
    /* === Инициализация TMA === */
    (function initTMA(){
      const tg = window.Telegram?.WebApp;
      if (!tg) return;
      try { tg.ready(); tg.expand(); tg.setHeaderColor('secondary_bg_color'); } catch(_){}
      try {
        tg.BackButton?.offClick?.();
        tg.BackButton?.show();
        tg.BackButton?.onClick(()=>{ try{ window.location.href='router.html'; }catch(_){ } });
      } catch(_){}
    })();

    function isAdmin(){
      try{ return Number(window.Telegram?.WebApp?.initDataUnsafe?.user?.id) === 196047220; }catch(_){ return false; }
    }

    /* === UI utils === */
    const ROW_VAR = getComputedStyle(document.documentElement).getPropertyValue('--row').trim();
    const rowH = ROW_VAR.endsWith('px') ? parseFloat(ROW_VAR) : (parseFloat(ROW_VAR) || 36);
    const pad = 4;
    const clamp = (v,a,b) => Math.min(b, Math.max(a, v));

    function numOrNull(v){
      if (v == null) return null;
      if (typeof v === 'number') return Number.isFinite(v) ? v : null;
      if (typeof v === 'string'){
        const s = v.trim();
        if (!s || /^null$/i.test(s)) return null;
        const n = Number(s.replace(',', '.'));
        return Number.isFinite(n) ? n : null;
      }
      return null;
    }

    /* === Wheel Builder === */
    function buildWheel(fieldEl, initial){
      const min = +fieldEl.dataset.min;
      const max = +fieldEl.dataset.max;
      const minInt = Math.floor(min);
      const maxInt = Math.floor(max);
      const intRange = maxInt - minInt;
      const key = fieldEl.dataset.key;
      const onlyInt = fieldEl.dataset.onlyInt === '1' || fieldEl.dataset.onlyInt === 'true';

      const intCol = fieldEl.querySelector('.col-int');
      const fracCol = fieldEl.querySelector('.col-frac');
      const duo = fieldEl.querySelector('.duo');

      const opt = t => { const d=document.createElement('div'); d.className='option'; d.textContent=t; return d; };
      function fillCol(col, from, to){
        const frag=document.createDocumentFragment();
        for(let i=0;i<pad;i++) frag.appendChild(opt(''));
        for(let i=from;i<=to;i++) frag.appendChild(opt(i));
        for(let i=0;i<pad;i++) frag.appendChild(opt(''));
        col.innerHTML=''; col.appendChild(frag);
      }
      fillCol(intCol, minInt, maxInt);
      fillCol(fracCol, 0, onlyInt ? 0 : 9);

      const nearestIndex = col => Math.round((col.scrollTop + (col.clientHeight - rowH)/2)/rowH) - pad;

      const lastActiveIdx = new WeakMap();
      function markActive(col){
        const idx = nearestIndex(col) + pad;
        const prev = lastActiveIdx.get(col);
        if (typeof prev === 'number' && prev !== idx && !isProgrammatic) {
          try { window.Telegram?.WebApp?.HapticFeedback?.selectionChanged?.(); } catch(_){}
        }
        if (typeof prev === 'number' && col.children[prev]) col.children[prev].classList.remove('active');
        const el = col.children[idx];
        if (el) el.classList.add('active');
        lastActiveIdx.set(col, idx);
      }

      const setScrollInstant = (col, idx) => {
        const ch = col.clientHeight || rowH * 5;
        const top = (idx + pad) * rowH - (ch - rowH)/2;
        col.scrollTop = top;
        requestAnimationFrame(()=> markActive(col));
      };

      function withNoSnap(fn){
        const prevInt = intCol.style.scrollSnapType;
        const prevFrac = fracCol.style.scrollSnapType;
        intCol.style.scrollSnapType = 'none';
        fracCol.style.scrollSnapType = 'none';
        try { fn(); }
        finally {
          requestAnimationFrame(()=>{
            intCol.style.scrollSnapType = prevInt || '';
            fracCol.style.scrollSnapType = prevFrac || '';
            markActive(intCol); markActive(fracCol);
          });
        }
      }

      let isProgrammatic = false;
      let rafInt = 0, rafFrac = 0;
      let snapTimer = null;
      const supportsScrollEnd = ('onscrollend' in window);
      let disabled = false;

      let modelValue = (typeof initial === 'number') ? clamp(+initial, min, max) : clamp(min + (max - min) / 2, min, max);

      function applyFracLock(iVal){
        if (disabled) return;
        const lock = onlyInt || (iVal === maxInt);
        fracCol.style.pointerEvents = lock ? 'none' : 'auto';
        fracCol.style.opacity = lock ? 0.5 : 1;
      }

      function dispatchChange(){
        const v = api.value;
        document.dispatchEvent(new CustomEvent('wheelchange', { detail:{ key, value: v, programmatic: isProgrammatic } }));
      }

      function setValue(v){
        const clamped = clamp(+v, min, max);
        const rounded = onlyInt ? Math.round(clamped) : Math.round(clamped * 10) / 10;
        modelValue = rounded;

        const iVal = Math.trunc(rounded);
        let f = onlyInt ? 0 : Math.round((rounded - iVal) * 10);
        if (iVal === maxInt) f = 0;
        const iIdx = iVal - minInt;

        const prev = isProgrammatic; isProgrammatic = true;
        withNoSnap(()=>{
          setScrollInstant(intCol, iIdx);
          setScrollInstant(fracCol, f);
        });
        applyFracLock(iVal);
        markActive(intCol); markActive(fracCol);
        requestAnimationFrame(()=>{ isProgrammatic = prev; dispatchChange(); });
      }

      function snapNow(){
        if (isProgrammatic) return;
        let iIdx = clamp(nearestIndex(intCol), 0, intRange);
        let f = onlyInt ? 0 : clamp(nearestIndex(fracCol), 0, 9);
        const iVal = minInt + iIdx;
        if (iVal === maxInt) f = 0;

        modelValue = onlyInt ? iVal : +(iVal + f/10).toFixed(1);

        const prev = isProgrammatic; isProgrammatic = true;
        setScrollInstant(intCol, iIdx);
        setScrollInstant(fracCol, f);
        applyFracLock(iVal);
        markActive(intCol); markActive(fracCol);
        requestAnimationFrame(()=>{ isProgrammatic = prev; dispatchChange(); });
      }

      function onScrollInt(){
        if (isProgrammatic) return;
        if (rafInt) cancelAnimationFrame(rafInt);
        rafInt = requestAnimationFrame(()=>markActive(intCol));
        scheduleSnap();
      }
      function onScrollFrac(){
        if (isProgrammatic || onlyInt) return;
        if (rafFrac) cancelAnimationFrame(rafFrac);
        rafFrac = requestAnimationFrame(()=>markActive(fracCol));
        scheduleSnap();
      }

      function scheduleSnap(){
        clearTimeout(snapTimer);
        snapTimer = setTimeout(snapNow, 80);
      }

      intCol.addEventListener('scroll', onScrollInt, {passive:true});
      fracCol.addEventListener('scroll', onScrollFrac, {passive:true});
      if (supportsScrollEnd){
        intCol.addEventListener('scrollend', snapNow, {passive:true});
        if (!onlyInt) fracCol.addEventListener('scrollend', snapNow, {passive:true});
      }

      function setDisabled(dis, programmatic=false){
        const prev = isProgrammatic; if (programmatic) isProgrammatic = true;
        disabled = dis;
        duo.classList.toggle('disabled', dis);
        duo.setAttribute('aria-disabled', String(dis));
        [intCol, fracCol].forEach(c=>c.style.pointerEvents = dis ? 'none' : 'auto');
        if (!dis){
          const iIdx = clamp(nearestIndex(intCol), 0, intRange);
          const iVal = minInt + iIdx;
          applyFracLock(iVal);
        }
        dispatchChange();
        isProgrammatic = prev;
      }

      const initVal = (typeof initial==='number') ? initial : (min + (max - min) / 2);
      if (fieldEl.offsetParent !== null) {
        setValue(initVal);
      }

      const api = {
        setValue,
        get value(){
          const iIdx = clamp(nearestIndex(intCol), 0, intRange);
          let f = onlyInt ? 0 : clamp(nearestIndex(fracCol), 0, 9);
          const iVal = minInt + iIdx;
          if (iVal === maxInt) f = 0;
          return onlyInt ? iVal : +(iVal + f/10).toFixed(1);
        },
        getModelValue(){ return modelValue; },
        setDisabled,
        destroy(){
          clearTimeout(snapTimer);
          intCol.removeEventListener('scroll', onScrollInt);
          fracCol.removeEventListener('scroll', onScrollFrac);
          if (supportsScrollEnd){
            intCol.removeEventListener('scrollend', snapNow);
            if (!onlyInt) fracCol.removeEventListener('scrollend', snapNow);
          }
        }
      };
      return api;
    }

    const wheels = {};
    const wheelMap = new WeakMap();

    function ensureWheel(fieldEl, cfg){
      let w = wheelMap.get(fieldEl);
      if (w) return w;

      const pend = (window.__pendingInputs || {});
      const hasPend = Object.prototype.hasOwnProperty.call(pend, cfg.key);
      const pendVal = hasPend ? pend[cfg.key] : undefined;
      const parsed  = numOrNull(pendVal);
      const initVal = (parsed != null) ? parsed : cfg.initial;

      w = buildWheel(fieldEl, initVal);
      wheelMap.set(fieldEl, w);
      wheels[cfg.key] = w;

      if (cfg.optional){
        let cb = fieldEl.querySelector('#opt_'+cfg.key);
        if (!cb){
          const opt = document.createElement('div');
          opt.className = 'optline';
          opt.innerHTML = `<label style="display:flex;align-items:center;gap:8px;opacity:.95">
              <input type="checkbox" id="opt_${cfg.key}"> нет данных
            </label>`;
          fieldEl.appendChild(opt);
          cb = opt.querySelector('input');
        }
        if (!cb._bound){
          cb.addEventListener('change', ()=>{ w.setDisabled(cb.checked); }, {passive:true});
          cb._bound = true;
        }
        if (hasPend && pendVal == null){
          cb.checked = true;
          w.setDisabled(true, true);
        }
      }

      if (hasPend && parsed != null){
        delete pend[cfg.key];
      }
      return w;
    }

    /* === Поля и инициализация === */
    const FIELDS = [
      { key:'age',    label:'Возраст', unit:'лет', min:14, max:90, initial:30, onlyInt:true },
      { key:'weight', label:'Вес', unit:'кг', min:40, max:250, initial:70.0 },
      { key:'height', label:'Рост', unit:'см', min:120, max:230, initial:175.0 },
      { key:'fat',    label:'% жира', unit:'%', min:3,  max:60,  initial:18.0, optional:true }
    ];
    const CFG = Object.fromEntries(FIELDS.map(f=>[f.key, f]));
    const fieldsWrap = document.getElementById('fields');
    const fieldByKey = Object.create(null);
    window.__pendingInputs = window.__pendingInputs || {};

    for (const cfg of FIELDS){
      const f = document.createElement('div');
      f.className = 'field';
      f.dataset.key = cfg.key;
      f.dataset.min = cfg.min;
      f.dataset.max = cfg.max;
      if (cfg.onlyInt) f.dataset.onlyInt = '1';
      f.innerHTML = `
        <div class="row"><div class="label">${cfg.label}</div><div class="unit">${cfg.unit}</div></div>
        <div class="duo"><div class="col col-int"></div><div class="sep">,</div><div class="col col-frac"></div></div>
      `;
      const h = document.createElement('div');
      h.className = 'help';
      h.textContent = cfg.onlyInt ? 'целые годы' :
                      (cfg.unit==='кг' ? 'кг: целые и десятые' :
                      cfg.unit==='см' ? 'см: целые и десятые (1 десятая = 1 мм)' :
                      'проценты: целые и десятые');
      f.appendChild(h);
      fieldsWrap.appendChild(f);
      fieldByKey[cfg.key] = f;
    }

    function ensureAllWheelsOnce(){
      if (window.__wheelsInitDone) return;
      const t0 = performance.now();
      for (const cfg of FIELDS){
        const el = fieldByKey[cfg.key];
        if (el) ensureWheel(el, cfg);
      }
      window.__wheelsInitMs = +(performance.now() - t0).toFixed(1);
      window.__wheelsInitDone = true;
    }
    ensureAllWheelsOnce();

    /* === Сохранение === */
    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbxVJAJCpESY9SQL0PV7_upijy5UH9wTk1eEwFRWsPH3UkpNAtHTu5_OzSLu033_0uSfLw/exec';
    const APP_VERSION = 'frontend-2025-10-21';
    const REQUEST_TIMEOUT_MS = 33000;

    function nowIso(){ return new Date().toISOString(); }
    function todayLocalISO(tz){
      try{
        const d = new Date();
        const y = new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric'}).format(d);
        const m = new Intl.DateTimeFormat('en-CA',{timeZone:tz,month:'2-digit'}).format(d);
        const da = new Intl.DateTimeFormat('en-CA',{timeZone:tz,day:'2-digit'}).format(d);
        return `${y}-${m}-${da}`;
      }catch{ return new Date().toISOString().slice(0,10); }
    }
    function clientTZ(){ try{ return Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC'; } catch{ return 'UTC'; } }
    function genSaveId(){ return Date.now() + '_' + Math.random().toString(36).slice(2,10); }

    async function saveMeasurementsToDB(values, saveId){
      if (!values || typeof values !== 'object') throw new Error('Нет данных для сохранения.');
      const tg = window.Telegram?.WebApp;
      const tz = clientTZ();
      const dayLocal = todayLocalISO(tz);
      const payload = {
        action: 'save',
        init_data: String(tg?.initData || ''),
        tz, client_day_local: dayLocal,
        locale: tg?.initDataUnsafe?.user?.language_code || '',
        source: 'webapp', app_version: APP_VERSION,
        t_client: nowIso(), save_id: saveId || genSaveId(),
        data: values
      };

      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), REQUEST_TIMEOUT_MS);
      let resp, raw, json = null;
      try {
        resp = await fetch(BACKEND_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify(payload),
          cache: 'no-store', credentials: 'omit', mode: 'cors',
          signal: controller.signal
        });
        raw = await resp.text();
        try { json = raw ? JSON.parse(raw) : null; } catch {}
      } catch (err) {
        if (err && err.name === 'AbortError') { const e = new Error('Сервер не ответил вовремя'); e.code = 408; throw e; }
        throw err;
      } finally { clearTimeout(t); }

      const isRateLimited = resp?.status === 429 || (json && (json.code === 429 || json.status === 429)) || /(?:too\s*many\s*requests|rate[-_\s]*limit|429|слишком\s+часто)/i.test(String(json?.error || resp?.statusText || ''));

      if (!resp?.ok || !json || json.ok !== true) {
        const msg = (json && json.error) ? json.error : `HTTP ${resp?.status ?? '0'} ${resp?.statusText ?? ''}`.trim();
        if (isRateLimited) { const e = new Error('Too many requests'); e.code = 429; throw e; }
        if (msg === 'timeout' || /timeout|network/i.test(String(msg))) { const e = new Error('Сервер не ответил вовремя'); e.code = 408; throw e; }
        const e = new Error(msg || 'Save failed'); e.code = resp?.status ?? 0; throw e;
      }
      return {
        ok: true,
        day_local: json.day_local,
        ts_iso: json.ts_iso,
        row_all: Number(json.row_all),
        row_calc: Number(json.row_calc)
      };
    }

    /* === Валидация и сохранение === */
    function collectWheelValues(){
      const out = {};
      for (const cfg of FIELDS){
        const fieldEl = fieldByKey[cfg.key];
        const w = wheels[cfg.key] || ensureWheel(fieldEl, cfg);
        const cb = fieldEl?.querySelector('#opt_' + cfg.key);
        out[cfg.key] = (cfg.optional && cb && cb.checked) ? null : w.value;
      }
      if (typeof out.age === 'number') out.age = Math.round(out.age);
      return out;
    }

    function collectSurveyValues(){
      const out = {};
      const isHidden = (node) => {
        if (!node) return true;
        const field = node.closest?.('.field') || node;
        const cs = field && getComputedStyle(field);
        return !field || cs.display === 'none' || cs.visibility === 'hidden';
      };

      const g = document.querySelector('.binary-btn.active[data-field="gender"]');
      out.gender = g ? g.dataset.value : null;

      const single = (field) => {
        const list = document.querySelector(`.choice-list[data-type="single"][data-field="${field}"]`);
        if (!list || isHidden(list)) return null;
        const sel = list.querySelector('.choice-item.selected');
        return sel ? sel.dataset.value : null;
      };
      const multiple = (field) => {
        const list = document.querySelector(`.choice-list[data-type="multiple"][data-field="${field}"]`);
        if (!list || isHidden(list)) return null;
        const vals = [...list.querySelectorAll('.choice-item.selected')].map(i=>i.dataset.value);
        if (!vals.length) return null;
        if (vals.includes('none')) return ['none'];
        return vals;
      };

      out.body_comp = single('body_comp');
      out.ethnicity = single('ethnicity');
      out.job_type = single('job_type');
      out.steps_per_day = single('steps_per_day');
      out.workouts_per_week = single('workouts_per_week');
      out.workout_duration = single('workout_duration');
      out.workout_intensity = single('workout_intensity');
      out.neat_level = single('neat_level');
      out.sleep_hours = single('sleep_hours');
      out.weight_history = single('weight_history');
      out.main_goal = single('main_goal');
      out.goal_pace = single('goal_pace');
      out.chronic_conditions = multiple('chronic_conditions');
      out.pregnancy_lactation = single('pregnancy_lactation');
      out.cycle_regular = single('cycle_regular');

      if (out.gender === 'male'){ out.pregnancy_lactation = null; out.cycle_regular = null; }

      try{
        const bf = document.getElementById('bf-none');
        const sys = document.getElementById('opt_fat');
        const noFat = (bf && bf.checked) || (sys && sys.checked);
        if (!noFat) out.body_comp = null;
      }catch(_){}

      return out;
    }

    function isFormValid() {
      try {
        const wvals = collectWheelValues();
        const survey = collectSurveyValues();
        
        if (!wvals.age || !wvals.weight || !wvals.height) return false;
        if (!survey.gender) return false;
        
        const hasFat = wvals.fat !== null && wvals.fat !== 0;
        const hasBodyComp = survey.body_comp !== null;
        if (!hasFat && !hasBodyComp) return false;
        
        const required = ['ethnicity','job_type','steps_per_day','workouts_per_week','workout_duration','workout_intensity','neat_level','sleep_hours','weight_history','main_goal','goal_pace','chronic_conditions'];
        for (const field of required) {
          if (!survey[field]) return false;
        }
        
        if (survey.gender === 'female') {
          if (!survey.pregnancy_lactation) return false;
          if (survey.pregnancy_lactation === 'none' && !survey.cycle_regular) return false;
        }
        
        return true;
      } catch { return false; }
    }

    function updateSaveButton() {
      const btn = document.getElementById('saveBtn');
      if (!btn) return;
      const valid = isFormValid();
      btn.disabled = !valid;
      btn.classList.toggle('disabled', !valid);
    }

    document.addEventListener('wheelchange', () => requestAnimationFrame(updateSaveButton));
    document.addEventListener('click', (e) => {
      if (e.target?.closest?.('.binary-btn') || e.target?.closest?.('.choice-item')) {
        setTimeout(updateSaveButton, 50);
      }
    }, { passive: true });

    /* === Сохранение === */
    let SAVE_IN_PROGRESS = false;
    let COOLDOWN_MS = 60000;
    let COOLDOWN_KEY = 'save_unlock_time';

    function canSaveNow(){ 
      if (SAVE_IN_PROGRESS) return false; 
      return !(Number(localStorage.getItem(COOLDOWN_KEY) || 0) > Date.now()); 
    }

    function setSavingState(isSaving){
      const btn = document.getElementById('saveBtn');
      if (!btn) return;
      btn.classList.toggle('loading', isSaving);
      btn.setAttribute('aria-busy', String(isSaving));
      btn.querySelector('.spinner').hidden = !isSaving;
      btn.querySelector('.btn-label').textContent = isSaving ? 'Обработка…' : 'Сохранить';
    }

    function showPopup(title, message, haptic){
      const tg = window.Telegram?.WebApp;
      if (haptic && tg?.HapticFeedback?.notificationOccurred) { try { tg.HapticFeedback.notificationOccurred(haptic); } catch(_){} }
      if (tg?.showPopup) { tg.showPopup({ title, message, buttons: [{type:'ok'}] }); }
      else { alert(title + '\n\n' + message); }
    }

    function handleSaveClick(){
      if (!canSaveNow()) return showPopup('Too many requests','Не нужно так часто нажимать эту кнопку','error');
      if (!isFormValid()) return showPopup('Не все поля заполнены', 'Заполните все обязательные поля анкеты.', 'error');

      const tg = window.Telegram?.WebApp;
      const saveId = genSaveId();
      SAVE_IN_PROGRESS = true;
      localStorage.setItem(COOLDOWN_KEY, String(Date.now() + COOLDOWN_MS));
      setSavingState(true);

      const values = { ...collectWheelValues(), ...collectSurveyValues() };

      saveMeasurementsToDB(values, saveId)
        .then(res => {
          setLastMeasurementTime(Date.parse(res.ts_iso));
          showPopup('Готово','Данные сохранены.','success');
          document.getElementById('sec-measures').classList.add('collapsed');
          startFrontDataFlow(); window.startMacrosFlow(); window.startChartFlow();
        })
        .catch(err => {
          if (err.code === 429) showPopup('Too many requests','Не нужно так часто нажимать эту кнопку','error');
          else showPopup('Не сохранено','Произошла ошибка при сохранении.','error');
        })
        .finally(() => {
          setSavingState(false);
          SAVE_IN_PROGRESS = false;
        });
    }

    document.getElementById('saveBtn').addEventListener('click', handleSaveClick);

    /* === Видимость секций === */
    window.updateCycleVisibility = function(){
      const isFemale = !!document.querySelector('.binary-btn.active[data-value="female"]');
      const secPreg = document.getElementById('sec-preg');
      const secCycle = document.getElementById('sec-cycle');
      if (secPreg) secPreg.style.display = isFemale ? '' : 'none';
      if (secCycle) secCycle.style.display = (isFemale && document.querySelector('.choice-list[data-field="pregnancy_lactation"] .choice-item.selected')?.dataset.value === 'none') ? '' : 'none';
    };

    window.updateBodyCompVisibility = function(){
      const sec = document.getElementById('sec-bodycomp');
      if (!sec) return;
      const noFat = !!(document.getElementById('bf-none')?.checked || document.getElementById('opt_fat')?.checked);
      sec.style.display = noFat ? '' : 'none';
    };

    requestAnimationFrame(() => { updateCycleVisibility(); updateBodyCompVisibility(); });

    /* === Аккордеон === */
    document.addEventListener('click', (e) => {
      const h = e.target.closest('.section-h');
      if (!h) return;
      const id = h.dataset.toggle;
      const sec = document.getElementById(id);
      if (!sec) return;
      sec.classList.toggle('collapsed');
      h.setAttribute('aria-expanded', !sec.classList.contains('collapsed'));
      if (id === 'sec-measures' && !sec.classList.contains('collapsed')) {
        ensureAllWheelsOnce();
      }
    }, { passive: true });

    /* === Последний замер === */
    function updateLastTimeDisplay(timestamp){
      const el = document.getElementById('lastTime');
      if (!el || !timestamp) { el.textContent = 'Последний замер: нет данных'; return; }
      const date = new Date(timestamp);
      el.textContent = `Последний замер: ${date.toLocaleDateString('ru-RU', { day:'2-digit', month:'2-digit', year:'numeric' })} ${date.toLocaleTimeString('ru-RU', { hour:'2-digit', minute:'2-digit' })}`;
    }
    function setLastMeasurementTime(ts){ localStorage.setItem('last_measurement_time', ts); updateLastTimeDisplay(ts); }
    updateLastTimeDisplay(localStorage.getItem('last_measurement_time'));

    /* === Загрузка данных === */
    window.startFrontDataFlow = function(){ /* ... поллинг AI-комментария ... */ };
    window.startMacrosFlow = function(){ /* ... макросы ... */ };
    window.startChartFlow = function(){ /* ... график ... */ };

    // Инициализация
    setTimeout(updateSaveButton, 100);
    requestAnimationFrame(() => {
      document.querySelectorAll('.section-h').forEach(h => {
        const sec = document.getElementById(h.dataset.toggle);
        if (sec) h.setAttribute('aria-expanded', !sec.classList.contains('collapsed'));
      });
    });
  </script>
</body>
</html>
