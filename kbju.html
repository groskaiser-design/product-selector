<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="tma:home-url" content="./index.html" />
<meta name="tma:home-hash" content="" />
<title>Замеры — анкета</title>

<script>
/* ============================================================
 *  SMART VERSION CONTROL
 * ============================================================ */
window.__pageLoadTime = performance.now();
const APP_HTML_VERSION = 'v2025-0032';

(function smartVersionCheck(){
  try{
    const url = new URL(location.href);
    const v = url.searchParams.get('v');
    if (v !== APP_HTML_VERSION){ url.searchParams.set('v', APP_HTML_VERSION); location.replace(url.href); }
  }catch(_){}
})();

window.addEventListener('pageshow', (e)=>{
  try{
    if (e.persisted){
      const url = new URL(location.href);
      url.searchParams.set('v', APP_HTML_VERSION);
      location.replace(url.href);
    }
  }catch(_){}
}, { once:true });

/* ============================================================
 *  GLOBAL CONSTANTS & UTILITIES
 * ============================================================ */
const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbwvp2MZDJNuVx3t5qQ_XtFNzDZdt37WI5gYyBB9Ykx4Oag9gS-MlVYxw8h67YKC7oa8_A/exec';
const APP_VERSION = 'frontend-2025-10-32';
const REQUEST_TIMEOUT_MS = 30000;
const COOLDOWN_MS = 60000;

const ROW_VAR = getComputedStyle(document.documentElement).getPropertyValue('--row').trim();
const rowH = ROW_VAR.endsWith('px') ? parseFloat(ROW_VAR) : (parseFloat(ROW_VAR) || 36);
const pad = 4;
const clamp = (v,a,b) => Math.min(b, Math.max(a, v));

const FIELDS = [
  { key:'age',    label:'Возраст', unit:'лет', min:14, max:90, initial:30, onlyInt:true },
  { key:'weight', label:'Вес', unit:'кг', min:40, max:250, initial:70.0 },
  { key:'height', label:'Рост', unit:'см', min:120, max:230, initial:175.0 },
  { key:'fat',    label:'% жира', unit:'%', min:3,  max:60,  initial:18.0, optional:true }
];

const CFG = Object.fromEntries(FIELDS.map(f=>[f.key, f]));

// Global state
window.fieldByKey = {};
window.wheels = {};
window.__pendingInputs = {};
window.__wheelsInitDone = false;

var SAVE_IN_PROGRESS = false;

/* ============================================================
 *  UTILITY FUNCTIONS
 * ============================================================ */
function numOrNull(v){
  if (v == null) return null;
  if (typeof v === 'number') return Number.isFinite(v) ? v : null;
  if (typeof v === 'string'){
    const s = v.trim();
    if (!s || /^null$/i.test(s)) return null;
    const n = Number(s.replace(',', '.'));
    return Number.isFinite(n) ? n : null;
  }
  return null;
}

function isAdmin(){
  try{ return Number(window.Telegram?.WebApp?.initDataUnsafe?.user?.id) === 196047220; }catch(_){ return false; }
}

function nowIso(){ return new Date().toISOString(); }

function todayLocalISO(tz){
  try{
    const d = new Date();
    const y  = new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric'}).format(d);
    const m  = new Intl.DateTimeFormat('en-CA',{timeZone:tz,month:'2-digit'}).format(d);
    const da = new Intl.DateTimeFormat('en-CA',{timeZone:tz,day:'2-digit'}).format(d);
    return `${y}-${m}-${da}`;
  }catch{ return new Date().toISOString().slice(0,10); }
}

function clientTZ(){ 
  try{ return Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC'; } 
  catch{ return 'UTC'; } 
}

function genSaveId(){ 
  return Date.now() + '_' + Math.random().toString(36).slice(2,10); 
}

function currentUserId(){ 
  try { return window.Telegram?.WebApp?.initDataUnsafe?.user?.id || 'anon'; } 
  catch(_){ return 'anon'; } 
}

/* ============================================================
 *  STORAGE FUNCTIONS
 * ============================================================ */
const COOLDOWN_KEY = 'save_unlock_time';
const ROWCALC_KEY_PREFIX = 'macros:last_row_calc:';
const LASTTIME_KEY_PREFIX = 'macros:last_measurement_time:';
const MACROS_KEY_PREFIX = 'macros:vals:';
const KBJU_SERIES_KEY_PREFIX = 'kbju:series:';

function getUnlockTime(){ 
  try { return Number(localStorage.getItem(COOLDOWN_KEY)) || 0; } 
  catch(_) { return 0; } 
}

function setUnlockTime(time){ 
  try { localStorage.setItem(COOLDOWN_KEY, String(time)); } 
  catch(_){} 
}

function canSaveNow(){ 
  if (SAVE_IN_PROGRESS) return false; 
  return !(getUnlockTime() > Date.now()); 
}

function rowCalcKey(uid){ return ROWCALC_KEY_PREFIX + String(uid); }

function setRowCalcForUser(rowCalc, uid){
  if (typeof uid === 'undefined') uid = currentUserId();
  try { localStorage.setItem(rowCalcKey(uid), String(rowCalc)); }
  catch(_) { try { sessionStorage.setItem(rowCalcKey(uid), String(rowCalc)); } catch(_){} }
  if (!window.__rowCalcByUid) window.__rowCalcByUid = {};
  window.__rowCalcByUid[String(uid)] = Number(rowCalc);
}

function getRowCalcForUser(uid){
  if (typeof uid === 'undefined') uid = currentUserId();
  if (window.__rowCalcByUid && (String(uid) in window.__rowCalcByUid)) 
    return window.__rowCalcByUid[String(uid)];
  var v = null; 
  try { v = localStorage.getItem(rowCalcKey(uid)); } 
  catch(_) { try { v = sessionStorage.getItem(rowCalcKey(uid)); } catch(_){ } }
  var n = (v == null) ? null : Number(v);
  if (!window.__rowCalcByUid) window.__rowCalcByUid = {};
  window.__rowCalcByUid[String(uid)] = isNaN(n) ? null : n;
  return window.__rowCalcByUid[String(uid)];
}

function lastTimeKey(uid){ return LASTTIME_KEY_PREFIX + String(uid); }

function setLastMeasurementTime(timestamp, uid){
  if (typeof uid === 'undefined') uid = currentUserId();
  try { localStorage.setItem(lastTimeKey(uid), String(timestamp)); } 
  catch(_) { try { sessionStorage.setItem(lastTimeKey(uid), String(timestamp)); } catch(_){} }
  if (!window.__lastTimeByUid) window.__lastTimeByUid = {};
  window.__lastTimeByUid[String(uid)] = Number(timestamp);
  updateLastTimeDisplay(timestamp);
}

function getLastMeasurementTime(uid){
  if (typeof uid === 'undefined') uid = currentUserId();
  if (window.__lastTimeByUid && (String(uid) in window.__lastTimeByUid)) 
    return window.__lastTimeByUid[String(uid)];
  var v = null; 
  try { v = localStorage.getItem(lastTimeKey(uid)); } 
  catch(_) { try { v = sessionStorage.getItem(lastTimeKey(uid)); } catch(_){ } }
  var n = (v == null) ? null : Number(v);
  if (!window.__lastTimeByUid) window.__lastTimeByUid = {};
  window.__lastTimeByUid[String(uid)] = isNaN(n) ? null : n;
  return window.__lastTimeByUid[String(uid)];
}

function updateLastTimeDisplay(timestamp){
  var el = document.getElementById('lastTime');
  if (!el) return;
  if (!timestamp) { 
    el.textContent = 'Последний замер: нет данных'; 
    return; 
  }
  var date = new Date(timestamp);
  var dateStr = date.toLocaleDateString('ru-RU', { day:'2-digit', month:'2-digit', year:'numeric' });
  var timeStr = date.toLocaleTimeString('ru-RU', { hour:'2-digit', minute:'2-digit' });
  el.textContent = 'Последний замер: ' + dateStr + ' ' + timeStr;
}

function macrosKey(uid){
  const id = currentUserId();
  return MACROS_KEY_PREFIX + String(uid ?? id);
}

function saveMacrosCache(obj, uid){ 
  try { localStorage.setItem(macrosKey(uid), JSON.stringify(obj)); } 
  catch(_){} 
}

function loadMacrosCache(uid){
  try {
    const raw = localStorage.getItem(macrosKey(uid));
    return raw ? JSON.parse(raw) : null;
  } catch(_) { return null; }
}

function kbjuSeriesKey(uid){ 
  const id = currentUserId();
  return KBJU_SERIES_KEY_PREFIX + String(uid ?? id);
}

function saveKbjuSeriesCache(obj, uid){ 
  try{ localStorage.setItem(kbjuSeriesKey(uid), JSON.stringify(obj)); }
  catch(_){} 
}

function loadKbjuSeriesCache(uid){
  try {
    const raw = localStorage.getItem(kbjuSeriesKey(uid));
    return raw ? JSON.parse(raw) : null;
  } catch(_){ return null; }
}

function clearKbjuSeriesCache(uid){ 
  try{ localStorage.removeItem(kbjuSeriesKey(uid)); }
  catch(_){} 
}

window.clearKbjuSeriesCacheMemory = function(){
  try { 
    if (window._seriesCacheByRow) {
      for (const k in window._seriesCacheByRow) 
        delete window._seriesCacheByRow[k]; 
    }
  } catch(_){}
};

window.getRowCalcForUser = getRowCalcForUser;
window.setRowCalcForUser = setRowCalcForUser;
window.setLastMeasurementTime = setLastMeasurementTime;
window.getLastMeasurementTime = getLastMeasurementTime;

/* ============================================================
 *  WHEEL BUILDER
 * ============================================================ */
function buildWheel(fieldEl, initial){
  const min = +fieldEl.dataset.min;
  const max = +fieldEl.dataset.max;
  const minInt = Math.floor(min);
  const maxInt = Math.floor(max);
  const intRange = maxInt - minInt;
  const key = fieldEl.dataset.key;
  const onlyInt = fieldEl.dataset.onlyInt === '1' || fieldEl.dataset.onlyInt === 'true';

  const intCol = fieldEl.querySelector('.col-int');
  const fracCol = fieldEl.querySelector('.col-frac');
  const duo = fieldEl.querySelector('.duo');

  const opt = t => { 
    const d=document.createElement('div'); 
    d.className='option'; 
    d.textContent=t; 
    return d; 
  };

  function fillCol(col, from, to){
    const frag=document.createDocumentFragment();
    for(let i=0;i<pad;i++) frag.appendChild(opt(''));
    for(let i=from;i<=to;i++) frag.appendChild(opt(i));
    for(let i=0;i<pad;i++) frag.appendChild(opt(''));
    col.innerHTML=''; 
    col.appendChild(frag);
  }

  fillCol(intCol, minInt, maxInt);
  fillCol(fracCol, 0, onlyInt ? 0 : 9);

  const nearestIndex = col =>
    Math.round((col.scrollTop + (col.clientHeight - rowH)/2)/rowH) - pad;

  const lastActiveIdx = new WeakMap();
  
  function markActive(col){
    const idx = nearestIndex(col) + pad;
    const prev = lastActiveIdx.get(col);
    if (typeof prev === 'number' && prev !== idx && !isProgrammatic) {
      try { window.Telegram?.WebApp?.HapticFeedback?.selectionChanged?.(); } catch(_){}
    }
    if (typeof prev === 'number' && col.children[prev]) 
      col.children[prev].classList.remove('active');
    const el = col.children[idx];
    if (el) el.classList.add('active');
    lastActiveIdx.set(col, idx);
  }

  const setScrollInstant = (col, idx) => {
    const ch = col.clientHeight || rowH * 5;
    const top = (idx + pad) * rowH - (ch - rowH)/2;
    col.scrollTop = top;
    requestAnimationFrame(()=> markActive(col));
  };

  function withNoSnap(fn){
    const prevInt = intCol.style.scrollSnapType;
    const prevFrac = fracCol.style.scrollSnapType;
    intCol.style.scrollSnapType = 'none';
    fracCol.style.scrollSnapType = 'none';
    try { fn(); }
    finally {
      requestAnimationFrame(()=>{
        intCol.style.scrollSnapType = prevInt || '';
        fracCol.style.scrollSnapType = prevFrac || '';
        markActive(intCol); 
        markActive(fracCol);
      });
    }
  }

  let isProgrammatic = false;
  let rafInt = 0, rafFrac = 0;
  let snapTimer=null;
  const supportsScrollEnd = ('onscrollend' in window);
  let disabled = false;

  let modelValue = (typeof initial === 'number')
    ? clamp(+initial, min, max)
    : clamp(min + (max - min) / 2, min, max);

  function applyFracLock(iVal){
    if (disabled) return;
    const lock = onlyInt || (iVal === maxInt);
    fracCol.style.pointerEvents = lock ? 'none' : 'auto';
    fracCol.style.opacity = lock ? 0.5 : 1;
  }

  function dispatchChange(){
    const v = api.value;
    document.dispatchEvent(new CustomEvent('wheelchange', {
      detail:{ key, value: v, programmatic: isProgrammatic }
    }));
  }

  function setValue(v){
    const clamped = clamp(+v, min, max);
    const rounded = onlyInt ? Math.round(clamped) : Math.round(clamped * 10) / 10;
    modelValue = rounded;

    const iVal = Math.trunc(rounded);
    let f = onlyInt ? 0 : Math.round((rounded - iVal) * 10);
    if (iVal === maxInt) f = 0;
    const iIdx = iVal - minInt;

    const prev = isProgrammatic; 
    isProgrammatic = true;
    withNoSnap(()=>{
      setScrollInstant(intCol, iIdx);
      setScrollInstant(fracCol, f);
    });
    applyFracLock(iVal);
    markActive(intCol); 
    markActive(fracCol);
    requestAnimationFrame(()=>{ 
      isProgrammatic = prev; 
      dispatchChange(); 
    });
  }

  function snapNow(){
    if (isProgrammatic) return;
    let iIdx = clamp(nearestIndex(intCol), 0, intRange);
    let f = onlyInt ? 0 : clamp(nearestIndex(fracCol), 0, 9);
    const iVal = minInt + iIdx;
    if (iVal === maxInt) f = 0;

    modelValue = onlyInt ? (iVal) : +(iVal + f/10).toFixed(1);

    const prev = isProgrammatic; 
    isProgrammatic = true;
    setScrollInstant(intCol, iIdx);
    setScrollInstant(fracCol, f);
    applyFracLock(iVal);
    markActive(intCol); 
    markActive(fracCol);
    requestAnimationFrame(()=>{ 
      isProgrammatic = prev; 
      dispatchChange(); 
    });
  }

  function onScrollInt(){
    if (isProgrammatic) return;
    if (rafInt) cancelAnimationFrame(rafInt);
    rafInt = requestAnimationFrame(()=>markActive(intCol));
    scheduleSnap();
  }

  function onScrollFrac(){
    if (isProgrammatic || onlyInt) return;
    if (rafFrac) cancelAnimationFrame(rafFrac);
    rafFrac = requestAnimationFrame(()=>markActive(fracCol));
    scheduleSnap();
  }

  function scheduleSnap(){
    clearTimeout(snapTimer);
    snapTimer = setTimeout(snapNow, 80);
  }

  intCol.addEventListener('scroll', onScrollInt, {passive:true});
  fracCol.addEventListener('scroll', onScrollFrac, {passive:true});
  if (supportsScrollEnd){
    intCol.addEventListener('scrollend', snapNow, {passive:true});
    if (!onlyInt) fracCol.addEventListener('scrollend', snapNow, {passive:true});
  }

  function setDisabled(dis, programmatic=false){
    const prev = isProgrammatic; 
    if (programmatic) isProgrammatic = true;
    disabled = dis;
    duo.classList.toggle('disabled', dis);
    duo.setAttribute('aria-disabled', String(dis));
    [intCol, fracCol].forEach(c=>c.style.pointerEvents = dis ? 'none' : 'auto');
    if (!dis){
      const iIdx = clamp(nearestIndex(intCol), 0, intRange);
      const iVal = minInt + iIdx;
      applyFracLock(iVal);
    }
    dispatchChange();
    isProgrammatic = prev;
  }

  const initVal = (typeof initial==='number') ? initial : (min + (max - min) / 2);
  if (fieldEl.offsetParent !== null) {
    setValue(initVal);
  }

  const api = {
    setValue,
    get value(){
      const iIdx = clamp(nearestIndex(intCol), 0, intRange);
      let f = onlyInt ? 0 : clamp(nearestIndex(fracCol), 0, 9);
      const iVal = minInt + iIdx;
      if (iVal === maxInt) f = 0;
      return onlyInt ? iVal : +(iVal + f/10).toFixed(1);
    },
    getModelValue(){ return modelValue; },
    setDisabled,
    destroy(){
      clearTimeout(snapTimer);
      intCol.removeEventListener('scroll', onScrollInt);
      fracCol.removeEventListener('scroll', onScrollFrac);
      if (supportsScrollEnd){
        intCol.removeEventListener('scrollend', snapNow);
        if (!onlyInt) fracCol.removeEventListener('scrollend', snapNow);
      }
    }
  };
  return api;
}

const wheelMap = new WeakMap();

function ensureWheel(fieldEl, cfg){
  let w = wheelMap.get(fieldEl);
  if (w) return w;

  const pend = window.__pendingInputs || {};
  const hasPend = Object.prototype.hasOwnProperty.call(pend, cfg.key);
  const pendVal = hasPend ? pend[cfg.key] : undefined;
  const parsed  = numOrNull(pendVal);
  const initVal = (parsed != null) ? parsed : cfg.initial;

  w = buildWheel(fieldEl, initVal);
  wheelMap.set(fieldEl, w);
  window.wheels[cfg.key] = w;

  if (cfg.optional){
    let cb = fieldEl.querySelector('#opt_'+cfg.key);
    if (!cb){
      const opt = document.createElement('div');
      opt.className = 'optline';
      opt.innerHTML = `<label style="display:flex;align-items:center;gap:8px;opacity:.95">
          <input type="checkbox" id="opt_${cfg.key}"> нет данных
        </label>`;
      fieldEl.appendChild(opt);
      cb = opt.querySelector('input');
    }
    if (!cb._bound){
      cb.addEventListener('change', ()=>{ w.setDisabled(cb.checked); }, {passive:true});
      cb._bound = true;
    }
    if (hasPend && pendVal == null){
      cb.checked = true;
      w.setDisabled(true, true);
    }
  }

  if (hasPend && parsed != null){
    delete pend[cfg.key];
  }
  return w;
}

function ensureAllWheelsOnce(){
  if (window.__wheelsInitDone) return;
  const t0 = performance?.now ? performance.now() : Date.now();
  for (const cfg of FIELDS){
    const el = window.fieldByKey[cfg.key];
    if (el) ensureWheel(el, cfg);
  }
  const t1 = performance?.now ? performance.now() : Date.now();
  window.__wheelsInitMs = +(t1 - t0).toFixed(1);
  window.__wheelsInitDone = true;
  
  if (isAdmin() && typeof window.__pageLaunchToUpdateWheel !== 'number') {
    window.__pageLaunchToWheelsInit = performance.now() - window.__pageLoadTime;
    if (typeof window.updatePerfUI === 'function') window.updatePerfUI();
  }
}

window.forceInitAllWheels = ensureAllWheelsOnce;

/* ============================================================
 *  DATA COLLECTION
 * ============================================================ */
function collectWheelValues(){
  var out = {};
  for (var i=0; i<FIELDS.length; i++){
    var cfg = FIELDS[i];
    var fieldEl = window.fieldByKey[cfg.key];
    var w = (window.wheels[cfg.key] || ensureWheel(fieldEl, cfg));
    var cb = fieldEl ? fieldEl.querySelector('#opt_' + cfg.key) : null;
    out[cfg.key] = (cfg.optional && cb && cb.checked) ? null : w.value;
  }
  if (typeof out.age === 'number') out.age = Math.round(out.age);
  return out;
}

function collectSurveyValues(){
  const out = {};
  const isHidden = (node) => {
    if (!node) return true;
    const field = node.closest?.('.field') || node;
    const cs = field && getComputedStyle(field);
    return !field || cs.display === 'none' || cs.visibility === 'hidden';
  };

  const g = document.querySelector('.binary-btn.active[data-field="gender"]');
  out.gender = g ? g.dataset.value : null;

  const single = (field) => {
    const list = document.querySelector(`.choice-list[data-type="single"][data-field="${field}"]`);
    if (!list || isHidden(list)) return null;
    const sel = list.querySelector('.choice-item.selected');
    return sel ? sel.dataset.value : null;
  };

  const multiple = (field) => {
    const list = document.querySelector(`.choice-list[data-type="multiple"][data-field="${field}"]`);
    if (!list || isHidden(list)) return null;
    const vals = [...list.querySelectorAll('.choice-item.selected')].map(i=>i.dataset.value);
    if (!vals.length) return null;
    if (vals.includes('none')) return ['none'];
    return vals;
  };

  out.body_comp           = single('body_comp');
  out.ethnicity           = single('ethnicity');
  out.job_type            = single('job_type');
  out.steps_per_day       = single('steps_per_day');
  out.workouts_per_week   = single('workouts_per_week');
  out.workout_duration    = single('workout_duration');
  out.workout_intensity   = single('workout_intensity');
  out.neat_level          = single('neat_level');
  out.sleep_hours         = single('sleep_hours');
  out.weight_history      = single('weight_history');
  out.main_goal           = single('main_goal');
  out.goal_pace           = single('goal_pace');
  out.chronic_conditions  = multiple('chronic_conditions');
  out.pregnancy_lactation = single('pregnancy_lactation');
  out.cycle_regular       = single('cycle_regular');

  if (out.gender === 'male'){ 
    out.pregnancy_lactation = null; 
    out.cycle_regular = null; 
  }

  try{
    const bf = document.getElementById('bf-none');
    const sys = document.getElementById('opt_fat');
    const noFat = (bf && bf.checked) || (sys && sys.checked);
    if (!noFat) out.body_comp = null;
  }catch(_){}

  return out;
}

/* ============================================================
 *  FORM VALIDATION
 * ============================================================ */
function isFormValid() {
  try {
    const wheels = collectWheelValues();
    const survey = collectSurveyValues();
    
    if (!wheels.age || wheels.age === 0) return false;
    if (!wheels.weight || wheels.weight === 0) return false;
    if (!wheels.height || wheels.height === 0) return false;
    if (!survey.gender) return false;

    const hasFat = wheels.fat !== null && wheels.fat !== 0;
    const hasBodyComp = survey.body_comp !== null;
    if (!hasFat && !hasBodyComp) return false;

    const required = [
      'ethnicity','job_type','steps_per_day','workouts_per_week',
      'workout_duration','workout_intensity','neat_level','sleep_hours',
      'weight_history','main_goal','goal_pace','chronic_conditions'
    ];
    for (const f of required) if (!survey[f]) return false;

    if (survey.gender === 'female') {
      if (!survey.pregnancy_lactation) return false;
      if (survey.pregnancy_lactation === 'none' && !survey.cycle_regular) return false;
    }
    return true;
  } catch { return false; }
}

function updateSaveButton() {
  const btn = document.getElementById('saveBtn'); 
  if (!btn) return;
  const ok = isFormValid();
  btn.disabled = !ok;
  btn.classList.toggle('disabled', !ok);
  btn.style.cursor = ok ? 'pointer' : 'not-allowed';
}

/* ============================================================
 *  VISIBILITY HELPERS
 * ============================================================ */
function updateCycleVisibility(){
  const isFemale = document.querySelector('.binary-btn.active[data-value="female"]');
  const isMale   = document.querySelector('.binary-btn.active[data-value="male"]');
  const secPreg  = document.getElementById('sec-preg');
  const secCycle = document.getElementById('sec-cycle');
  if (!secPreg || !secCycle) return;
  
  if (isMale){
    secPreg.style.display='none'; 
    secCycle.style.display='none';
    secPreg.querySelectorAll('.choice-item.selected').forEach(i=>i.classList.remove('selected'));
    secCycle.querySelectorAll('.choice-item.selected').forEach(i=>i.classList.remove('selected'));
    return;
  }
  
  secPreg.style.display = isFemale ? '' : 'none';
  const preg = document.querySelector('.choice-list[data-field="pregnancy_lactation"] .choice-item.selected')?.dataset.value || null;
  const showCycle = !!isFemale && preg === 'none';
  secCycle.style.display = showCycle ? '' : 'none';
  if (!showCycle){ 
    secCycle.querySelectorAll('.choice-item.selected').forEach(i=>i.classList.remove('selected')); 
  }
}

function updateBodyCompVisibility(){
  const sec  = document.getElementById('sec-bodycomp');
  if (!sec) return;
  const bf = document.getElementById('bf-none');
  const sys = document.getElementById('opt_fat');
  const show = (bf && bf.checked) || (sys && sys.checked);
  sec.style.display = show ? '' : 'none';
  if (!show){ 
    sec.querySelectorAll('.choice-item.selected').forEach(i=>i.classList.remove('selected')); 
  }
}

window.updateCycleVisibility = updateCycleVisibility;
window.updateBodyCompVisibility = updateBodyCompVisibility;

/* ============================================================
 *  BACKEND COMMUNICATION
 * ============================================================ */
async function saveMeasurementsToDB(values, saveId){
  if (!values || typeof values !== 'object') 
    throw new Error('Нет данных для сохранения.');
  
  const tg = window.Telegram?.WebApp;
  const tz = clientTZ();
  const dayLocal = todayLocalISO(tz);
  
  const payload = {
    action: 'save',
    init_data: String(tg?.initData || ''),
    tz, 
    client_day_local: dayLocal,
    locale: tg?.initDataUnsafe?.user?.language_code || '',
    source: 'webapp', 
    app_version: APP_VERSION,
    t_client: nowIso(), 
    save_id: saveId || genSaveId(),
    data: values
  };

  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), REQUEST_TIMEOUT_MS);
  let resp, raw, json = null;
  
  try {
    resp = await fetch(BACKEND_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
      body: JSON.stringify(payload),
      redirect: 'follow', 
      cache: 'no-store', 
      credentials: 'omit', 
      mode: 'cors',
      signal: controller.signal
    });
    raw = await resp.text();
    try { json = raw ? JSON.parse(raw) : null; } catch {}
  } catch (err) {
    if (err && err.name === 'AbortError') { 
      const e = new Error('Сервер не ответил вовремя'); 
      e.code = 408; 
      throw e; 
    }
    throw err;
  } finally { 
    clearTimeout(t); 
  }

  const isRateLimited =
    resp?.status === 429 ||
    (json && (json.code === 429 || json.status === 429)) ||
    /(?:too\s*many\s*requests|rate[-_\s]*limit|429|слишком\s+часто)/i.test(String(json?.error || resp?.statusText || ''));

  if (!resp?.ok || !json || json.ok !== true) {
    const msg = (json && json.error) ? json.error : `HTTP ${resp?.status ?? '0'} ${resp?.statusText ?? ''}`.trim();
    if (isRateLimited) { 
      const e = new Error('Too many requests'); 
      e.code = 429; 
      throw e; 
    }
    if (msg === 'timeout' || /timeout|network/i.test(String(msg))) { 
      const e = new Error('Сервер не ответил вовремя'); 
      e.code = 408; 
      throw e; 
    }
    const e = new Error(msg || 'Save failed'); 
    e.code = resp?.status ?? 0; 
    throw e;
  }
  
  return {
    ok: true,
    day_local: json.day_local,
    ts_iso: json.ts_iso,
    row_all: Number(json.row_all),
    row_calc: Number(json.row_calc)
  };
}

async function fetchUserRow(){
  const tg = window.Telegram?.WebApp;
  try{
    const resp = await fetch(BACKEND_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
      body: JSON.stringify({ 
        action:'user_row', 
        init_data:String(tg?.initData || '') 
      }),
      cache:'no-store', 
      credentials:'omit', 
      mode:'cors'
    });
    const raw = await resp.text();
    const json = raw ? JSON.parse(raw) : null;
    if (!resp.ok || !json || json.ok !== true) return null;
    return json;
  } catch { 
    return null; 
  }
}

async function confirmSavedAfterTimeout(prevRowCalc){
  const row = await fetchUserRow().catch(()=>null);
  if (row && row.found && Number(row.row_calc) && 
      Number(row.row_calc) !== Number(prevRowCalc || 0)) {
    return Number(row.row_calc);
  }
  return null;
}

/* ============================================================
 *  UI HELPERS
 * ============================================================ */
function getSaveBtn(){ 
  return document.getElementById('saveBtn'); 
}

function setSavingState(isSaving){
  var btn = getSaveBtn(); 
  if (!btn) return;
  var label = btn.querySelector('.btn-label');
  var sp = btn.querySelector('.spinner');
  btn.classList.toggle('loading', !!isSaving);
  btn.setAttribute('aria-busy', String(!!isSaving));
  if (sp) sp.hidden = !isSaving;
  if (label) label.textContent = isSaving ? 'Обработка…' : 'Сохранить';
}

function showPopup(title, message, haptic){
  var tg = window.Telegram?.WebApp;
  if (haptic && tg?.HapticFeedback?.notificationOccurred) { 
    try { tg.HapticFeedback.notificationOccurred(haptic); } 
    catch(_){ } 
  }
  if (tg?.showPopup) { 
    tg.showPopup({ title, message, buttons: [{type:'ok'}] }); 
  } else { 
    alert(title + '\n\n' + message); 
  }
}

function collapseAccordionSafe(){
  var act = function(){
    try{
      var section = document.getElementById('sec-measures');
      if (section){ 
        section.classList.add('collapsed'); 
        section.setAttribute('aria-hidden','true'); 
      }
      document.querySelectorAll('[data-toggle="sec-measures"]').forEach(function(h){
        h.setAttribute('aria-expanded','false');
      });
    }catch(_){}
  };
  try { 
    requestAnimationFrame(function(){ 
      requestAnimationFrame(act); 
    }); 
  } catch(_){ 
    act(); 
  }
}

function scrollTopNoJump(){
  try{ document.activeElement?.blur?.(); }catch(_){}
  try{
    const html = document.documentElement, body = document.body;
    const prev = html.style.scrollBehavior; 
    html.style.scrollBehavior = 'auto';
    window.scrollTo(0,0); 
    html.scrollTop = 0; 
    body.scrollTop = 0;
    html.style.scrollBehavior = prev || '';
  }catch(_){}
}

/* ============================================================
 *  SAVE HANDLER
 * ============================================================ */
function handleSaveClick(e){
  if (e && e.preventDefault) { 
    try { e.preventDefault(); } 
    catch(_){} 
  }
  
  if (!canSaveNow()) { 
    showPopup('Too many requests','Не нужно так часто нажимать эту кнопку','error'); 
    return; 
  }

  if (!isFormValid()) {
    const tg = window.Telegram?.WebApp;
    try { tg?.HapticFeedback?.notificationOccurred?.('error'); } 
    catch(_){}
    showPopup('Не все поля заполнены', 'Заполните все обязательные поля анкеты.', 'error');
    return;
  }

  const tg = window.Telegram?.WebApp;
  const prevRowCalc = getRowCalcForUser();
  const saveId = genSaveId();

  SAVE_IN_PROGRESS = true;
  setUnlockTime(Date.now() + COOLDOWN_MS);
  setSavingState(true);
  try { tg?.HapticFeedback?.impactOccurred?.('light'); } 
  catch(_){}

  const values = { ...collectWheelValues(), ...collectSurveyValues() };

  try {
    const uid = currentUserId();
    localStorage.removeItem('macros:vals:' + String(uid));
    localStorage.removeItem('kbju:series:' + String(uid));
  } catch(_){}
  try { 
    window.clearKbjuSeriesCacheMemory && window.clearKbjuSeriesCacheMemory(); 
  } catch(_){}

  Promise.resolve()
    .then(() => saveMeasurementsToDB(values, saveId))
    .then(function(res){
      setRowCalcForUser(res.row_calc);
      setLastMeasurementTime(Date.parse(res.ts_iso));

      collapseAccordionSafe();
      requestAnimationFrame(()=>requestAnimationFrame(scrollTopNoJump));

      try { startFrontDataFlow(); } catch(_){}
      try { window.startMacrosFlow(); } catch(_){}

      try { tg?.HapticFeedback?.notificationOccurred?.('success'); } 
      catch(_){}
      showPopup('Готово','Данные сохранены.','success');
    })
    .catch(async function(err){
      const msg = String((err && err.message) || err || '');
      if ((err && err.code === 408) || /timeout|network/i.test(msg)) {
        const confirmed = await confirmSavedAfterTimeout(prevRowCalc).catch(()=>null);
        if (confirmed != null) {
          setRowCalcForUser(confirmed);
          setLastMeasurementTime(Date.now());
          setUnlockTime(Date.now() + 4000);

          collapseAccordionSafe();
          requestAnimationFrame(()=>requestAnimationFrame(scrollTopNoJump));

          try { startFrontDataFlow(); } catch(_){}
          try { window.startMacrosFlow(); } catch(_){}

          try { tg?.HapticFeedback?.notificationOccurred?.('success'); } 
          catch(_){}
          showPopup('Готово','Данные сохранены.','success');
          return;
        }
        setUnlockTime(Date.now() + 2000);
        showPopup('Не сохранено (возможно ушло)','Сервер не успел ответить вовремя. Возможно, данные уже сохранены. Проверьте «Последний замер».','error');
        try { startFrontDataFlow(); } catch(_){}
        return;
      }
      if ((err && err.code === 429) || /too\s*many\s*requests|rate[-_\s]*limit|слишком\s+часто|429/i.test(msg)){
        setUnlockTime(Date.now() + 4000);
        showPopup('Too many requests','Не нужно так часто нажимать эту кнопку','error');
        return;
      }
      setUnlockTime(Date.now() + 2000);
      showPopup('Не сохранено','Произошла ошибка при сохранении. Попробуйте позже.','error');
    })
    .finally(() => {
      setSavingState(false);
      SAVE_IN_PROGRESS = false;
    });
}

/* ============================================================
 *  KBJU CHART RENDERER
 * ============================================================ */
(function kbjuChartInit(){
  function renderKBJU7Impl(host, data, opts={}){
    const root = typeof host === 'string' ? document.getElementById(host) : host;
    if (!root) { 
      console.warn('KBJU: host not found'); 
      return; 
    }
    
    const scr  = root.querySelector('#kbju7-scroll');
    let svg = root.querySelector('#kbju7-svg');
    if (!svg) { 
      svg = document.createElementNS('http://www.w3.org/2000/svg','svg'); 
      svg.id='kbju7-svg'; 
      (scr||root).appendChild(svg); 
    }

    const infP = root.querySelector('#kbju7-p');
    const infF = root.querySelector('#kbju7-f');
    const infC = root.querySelector('#kbju7-c');

    const list = Array.isArray(data) ? 
      data.slice().sort((a,b)=> new Date(a.date) - new Date(b.date)) : [];
    
    if (!list.length){ 
      svg.innerHTML = '<text x="8" y="20" fill="#fff" opacity=".8">Нет данных</text>'; 
      svg.__lastData = []; 
      return; 
    }

    const H = 160, DATE_PAD = 18, LIFT = 8, TOP_PAD = Math.max(12, LIFT + 6);
    const visible = Number(opts.visible||7);
    const shape = opts.shape || 'clip-capsule';

    function computeBarW(){
      const W = (scr?.clientWidth) || root.clientWidth || 320;
      const gap = 8;
      const bar = Math.max(12, Math.floor((W - gap*(visible+1)) / visible));
      return { bar, gap };
    }
    
    function fmtD(d){ 
      try{ 
        return new Date(d).toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit'}); 
      }catch{ 
        return d; 
      } 
    }
    
    function rect(x,y,w,h,r=0){
      const e = document.createElementNS('http://www.w3.org/2000/svg','rect');
      e.setAttribute('x', x); 
      e.setAttribute('y', Math.max(0,y));
      e.setAttribute('width', w); 
      e.setAttribute('height', Math.max(0,h));
      if (r){ 
        e.setAttribute('rx', r); 
        e.setAttribute('ry', r); 
      }
      return e;
    }

    const { bar:BAR, gap:GAP } = computeBarW();
    const outerR = parseFloat(getComputedStyle(root).getPropertyValue('--r')) || 18;
    const contentW = list.length * (BAR + GAP) + GAP;
    const filter = root.getAttribute('data-filter') || 'all';

    let gramsMax;
    if (filter==='prot') 
      gramsMax = Math.max(50, ...list.map(d => +d.protein_g||0));
    else if (filter==='fat') 
      gramsMax = Math.max(50, ...list.map(d => +d.fat_g||0));
    else if (filter==='carb') 
      gramsMax = Math.max(50, ...list.map(d => +d.carbs_g||0));
    else 
      gramsMax = Math.max(50, ...list.map(d => (+d.protein_g||0)+(+d.fat_g||0)+(+d.carbs_g||0)));

    const yG = v => (H - TOP_PAD - DATE_PAD - 4) * (v/gramsMax);

    svg.setAttribute('viewBox', `0 0 ${contentW} ${H}`);
    svg.setAttribute('width', contentW);
    svg.setAttribute('height', H);

    const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
    const gBars = document.createElementNS('http://www.w3.org/2000/svg','g');
    const gSel  = document.createElementNS('http://www.w3.org/2000/svg','g');
    const gHit  = document.createElementNS('http://www.w3.org/2000/svg','g');

    const groups=[]; 
    const dates=[]; 
    const outlines=[];
    const yBase = H-2-DATE_PAD;
    const yDate = H-6;

    list.forEach((d, i)=>{
      const x = GAP + i*(BAR + GAP);
      let gC = +d.carbs_g||0, gP = +d.protein_g||0, gF = +d.fat_g||0;
      if (filter==='prot'){ gC = 0; gF = 0; }
      else if (filter==='fat'){ gC = 0; gP = 0; }
      else if (filter==='carb'){ gP = 0; gF = 0; }

      const hC = yG(gC), hP = yG(gP), hF = yG(gF);
      const sum = hC+hP+hF;
      const topY = yBase - Math.max(sum, 0);

      let clipId = null;
      if (shape === 'clip-capsule'){
        clipId = `clip_${i}`;
        const cp = document.createElementNS('http://www.w3.org/2000/svg','clipPath');
        cp.setAttribute('id', clipId);
        cp.appendChild(rect(x, Math.max(TOP_PAD, topY), BAR, Math.max(sum, 0.0001), outerR));
        defs.appendChild(cp);
      }

      const group = document.createElementNS('http://www.w3.org/2000/svg','g');
      if (clipId) group.setAttribute('clip-path', `url(#${clipId})`);
      group.style.transition = 'transform .2s ease';

      const rc = rect(x, yBase - hC, BAR, hC, shape==='rounded-segments' ? 6 : 0); 
      rc.setAttribute('fill', 'rgba(52,211,153,.85)');
      const rp = rect(x, yBase - (hC + hP), BAR, hP, shape==='rounded-segments' ? 6 : 0); 
      rp.setAttribute('fill', 'rgba(96,165,250,.85)');
      const rf = rect(x, yBase - (hC + hP + hF), BAR, hF, shape==='rounded-segments' ? 6 : 0); 
      rf.setAttribute('fill', 'rgba(245,158,11,.85)');
      
      rc.classList.add('bar-anim','seg','carb'); 
      rp.classList.add('bar-anim','seg','prot'); 
      rf.classList.add('bar-anim','seg','fat');
      
      group.appendChild(rc); 
      group.appendChild(rp); 
      group.appendChild(rf);
      gBars.appendChild(group);
      groups.push(group);

      if (filter !== 'all'){
        const gSelVal = filter==='prot' ? gP : filter==='fat' ? gF : gC;
        const hSel = filter==='prot' ? hP : filter==='fat' ? hF : hC;
        if (hSel > 22){
          const tx = document.createElementNS('http://www.w3.org/2000/svg','text');
          tx.textContent = String(Math.round(gSelVal));
          tx.setAttribute('x', x + BAR/2);
          tx.setAttribute('y', yBase - (hSel * 0.75));
          tx.setAttribute('text-anchor','middle');
          tx.setAttribute('font-size','14');
          tx.setAttribute('font-weight','900');
          tx.setAttribute('fill','#fff');
          tx.setAttribute('opacity','0.98');
          tx.style.pointerEvents = 'none';
          tx.style.dominantBaseline = 'middle';
          group.appendChild(tx);
        }
      }

      const tDate = document.createElementNS('http://www.w3.org/2000/svg','text');
      tDate.textContent = fmtD(d.date);
      tDate.setAttribute('x', x + BAR/2);
      tDate.setAttribute('y', yDate);
      tDate.setAttribute('text-anchor','middle');
      tDate.setAttribute('font-size','12');
      tDate.setAttribute('font-weight','700');
      tDate.setAttribute('fill','rgba(255,255,255,.9)');
      tDate.style.opacity = '0';
      tDate.style.transition = 'opacity .18s ease';
      tDate.style.pointerEvents = 'none';
      gBars.appendChild(tDate);
      dates.push(tDate);

      const selOutline = rect(x-1, topY, BAR+2, Math.max(sum,2), outerR);
      selOutline.setAttribute('class','sel-outline'); 
      selOutline.style.opacity = '0';
      selOutline.style.transition = 'transform .2s ease, opacity .12s ease';
      gSel.appendChild(selOutline);
      outlines.push(selOutline);

      const hit = rect(x, 0, BAR, H, outerR); 
      hit.setAttribute('fill','transparent'); 
      hit.style.cursor='pointer';
      hit.addEventListener('click', ()=> select(i, d));
      gHit.appendChild(hit);
    });

    svg.innerHTML = '';
    svg.appendChild(defs);
    svg.appendChild(gBars);
    svg.appendChild(gSel);
    svg.appendChild(gHit);

    requestAnimationFrame(()=>{ 
      svg.querySelectorAll('.bar-anim').forEach(el=> el.classList.add('show')); 
    });

    function select(idx, d){
      if (infP) infP.textContent = Math.round(+d.protein_g||0);
      if (infF) infF.textContent = Math.round(+d.fat_g||0);
      if (infC) infC.textContent = Math.round(+d.carbs_g||0);
      
      outlines.forEach((o,i)=>{ 
        o.style.opacity = (i===idx ? '1' : '0'); 
        o.style.transform = (i===idx ? `translateY(-${LIFT}px)` : 'translateY(0)'); 
      });
      
      groups.forEach((g,i)=>{ 
        g.style.transform = (i===idx ? `translateY(-${LIFT}px)` : 'translateY(0)'); 
      });
      
      dates.forEach((t,i)=>{ 
        t.style.opacity = (i===idx ? '1' : '0'); 
      });
      
      try{ 
        window.Telegram?.WebApp?.HapticFeedback?.selectionChanged?.(); 
      }catch(_){}
    }

    select(list.length-1, list[list.length-1]);
    if (scr) scr.scrollLeft = scr.scrollWidth;

    svg.__lastData = list.slice();
  }

  function bindLegend(root){
    if (!root || root.__legendBound) return;
    const info = root.querySelector('#kbju7-info'); 
    if (!info) return;
    
    info.addEventListener('click', (e)=>{
      const btn = e.target.closest?.('.legend-tap');
      if (!btn) return;
      const key = btn.dataset.key;
      const cur = root.getAttribute('data-filter') || 'all';
      const next = (cur === key) ? 'all' : key;
      root.setAttribute('data-filter', next);
      
      info.querySelectorAll('.legend-tap').forEach(b=>{
        const on = (next === b.dataset.key);
        b.classList.toggle('active', on);
        b.setAttribute('aria-pressed', String(on));
      });
      
      const svg = root.querySelector('#kbju7-svg');
      if (svg && Array.isArray(svg.__lastData)) {
        renderKBJU7Impl(root, svg.__lastData, { visible:7, shape:'clip-capsule' });
      }
    }, { passive: true });
    
    root.__legendBound = true;
  }

  window.renderKBJU7 = function(host, data, opts={}){
    const root = (typeof host === 'string') ? document.getElementById(host) : host;
    if (!root) return;
    bindLegend(root);
    return renderKBJU7Impl(root, data, opts);
  };

  if (window.__kbjuGlobalResizeBound !== true){
    window.__kbjuGlobalResizeBound = true;
    window.addEventListener('resize', ()=>{
      document.querySelectorAll('.kbju7').forEach(root=>{
        const svg = root.querySelector('#kbju7-svg');
        if (svg && Array.isArray(svg.__lastData)) {
          renderKBJU7Impl(root, svg.__lastData, { visible:7, shape:'clip-capsule' });
        }
      });
    }, { passive:true });
  }
})();

/* ============================================================
 *  FRONT DATA FLOW (AI COMMENTS + LAST INPUTS)
 * ============================================================ */
function initFrontDataFlow(){
  const tg = window.Telegram?.WebApp;
  const BACKEND = BACKEND_URL;

  const elAI = ()=>document.getElementById('ai-comment');
  const elAnalytics = ()=>document.getElementById('analytics');

  function setAIStatus(text){
    const host = elAI(); 
    if (!host) return;
    host.innerHTML = `<div class="field"><div class="help">${text}</div></div>`;
  }

  function setAnalyticsPlaceholder(){
    const host = elAnalytics(); 
    if (!host) return;
    host.innerHTML = `<div class="field"><div class="help">После сохранения появятся графики.</div></div>`;
  }

  async function apiFrontWait(timeoutSec){
    const payload = {
      action:'front_wait',
      init_data:String(tg?.initData || ''),
      timeout_sec: Math.max(0, Math.min(25, Number(timeoutSec)||25))
    };
    const t0 = performance?.now ? performance.now() : Date.now();
    const resp = await fetch(BACKEND, {
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=UTF-8'},
      body:JSON.stringify(payload),
      cache:'no-store', 
      credentials:'omit', 
      mode:'cors'
    });
    const raw = await resp.text();
    let json = null; 
    try{ json = raw ? JSON.parse(raw) : null; }
    catch(_){}
    const t1 = performance?.now ? performance.now() : Date.now();
    window.__frontWaitLastMs = +(t1 - t0).toFixed(1);
    try { updatePerfUI && updatePerfUI(); } catch(_){}
    if (!resp.ok || !json) throw new Error(`HTTP ${resp.status}`);
    return json;
  }

  async function apiLastInputs(){
    if (isAdmin() && typeof window.__pageLaunchToRequestSent !== 'number') {
      window.__pageLaunchToRequestSent = performance.now() - window.__pageLoadTime;
      if (typeof window.updatePerfUI === 'function') window.updatePerfUI();
    }
    
    const payload = { 
      action:'user_last_inputs', 
      init_data: String(tg?.initData || '') 
    };
    const t0 = performance?.now ? performance.now() : Date.now();
    const resp = await fetch(BACKEND, {
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=UTF-8'},
      body:JSON.stringify(payload),
      cache:'no-store', 
      credentials:'omit', 
      mode:'cors'
    });
    const raw = await resp.text();
    let json = null; 
    try{ json = raw ? JSON.parse(raw) : null; }
    catch(_){}
    const t1 = performance?.now ? performance.now() : Date.now();
    window.__lastInputsFetchMs = +(t1 - t0).toFixed(1);
    
    if (isAdmin() && typeof window.__pageLaunchToResponseReceived !== 'number') {
      window.__pageLaunchToResponseReceived = performance.now() - window.__pageLoadTime;
      if (typeof window.updatePerfUI === 'function') window.updatePerfUI();
    }
    
    try { updatePerfUI && updatePerfUI(); } catch(_){}
    if (!resp.ok || !json || json.ok !== true) 
      throw new Error(json?.error || `HTTP ${resp.status}`);
    return json;
  }

  function renderAIComment(html){
    if (isAdmin() && typeof window.__pageLaunchToUpdateComment !== 'number') {
      window.__pageLaunchToUpdateComment = performance.now() - window.__pageLoadTime;
      if (typeof window.updatePerfUI === 'function') window.updatePerfUI();
    }
    const host = elAI(); 
    if (!host) return;
    host.innerHTML = html
      ? `<div class="field">${html}</div>`
      : `<div class="field"><div class="help">Комментарий пока не готов…</div></div>`;
  }

  function applyInputsToWheels(inputs){
    if (!inputs || typeof inputs !== 'object') return;
    ensureAllWheelsOnce();

    for (const [k, vRaw] of Object.entries(inputs)){
      const cfg = CFG[k]; 
      if (!cfg) continue;
      const el  = window.fieldByKey[k];
      const w   = window.wheels[k];

      const v = numOrNull(vRaw);

      if (v == null){
        window.__pendingInputs = window.__pendingInputs || {};
        window.__pendingInputs[k] = null;
        if (cfg.optional && el){
          let cb = el.querySelector('#opt_'+k);
          if (!cb){
            const opt = document.createElement('div');
            opt.className = 'optline';
            opt.innerHTML = `<label style="display:flex;align-items:center;gap:8px;opacity:.95">
                <input type="checkbox" id="opt_${k}"> нет данных
              </label>`;
            el.appendChild(opt);
            cb = opt.querySelector('input');
          }
          cb.checked = true;
          if (w && w.setDisabled) w.setDisabled(true, true);
        }
        continue;
      }

      if (cfg.optional && el){
        const cb = el.querySelector('#opt_'+k);
        if (cb){ cb.checked = false; }
        if (w && w.setDisabled) w.setDisabled(false, true);
      }

      const target = (k === 'age') ? Math.round(v) : v;
      const cur = (w && typeof w.getModelValue === 'function') ? w.getModelValue() : (w ? w.value : null);
      const changed = (cur == null) || Math.abs(Number(cur) - Number(target)) > 0.001;

      if (changed){
        if (w) {
          w.setValue(target);
        } else {
          window.__pendingInputs = window.__pendingInputs || {};
          window.__pendingInputs[k] = target;
        }
      }
    }

    if (isAdmin() && typeof window.__pageLaunchToUpdateWheel === 'number' === false) {
      window.__pageLaunchToUpdateWheel = performance.now() - window.__pageLoadTime;
      try { updatePerfUI && updatePerfUI(); } catch(_){}
    }
  }

  function applyInputsToSurvey(inputs){
    if (!inputs || typeof inputs !== 'object') return;

    if (typeof inputs.gender === 'string'){
      document.querySelectorAll('.binary-btn[data-field="gender"]').forEach(b=>{
        const on = b.dataset.value === inputs.gender;
        b.classList.toggle('active', on);
        b.setAttribute('aria-pressed', on ? 'true':'false');
      });
    }

    const selectSingle = (field, val) => {
      const list = document.querySelector(`.choice-list[data-field="${field}"][data-type="single"]`);
      if (!list) return;
      list.querySelectorAll('.choice-item').forEach(i=>{
        const on = String(i.dataset.value) === String(val);
        i.classList.toggle('selected', on);
        i.setAttribute('aria-checked', on ? 'true':'false');
      });
    };

    const selectMultiple = (field, arr) => {
      const list = document.querySelector(`.choice-list[data-field="${field}"][data-type="multiple"]`);
      if (!list) return;
      const set = new Set(Array.isArray(arr) ? arr : []);
      if (set.has('none')){
        list.querySelectorAll('.choice-item').forEach(i=>{
          const on = i.dataset.value === 'none';
          i.classList.toggle('selected', on);
          i.setAttribute('aria-checked', on ? 'true':'false');
        });
        return;
      }
      list.querySelectorAll('.choice-item').forEach(i=>{
        const on = set.has(i.dataset.value);
        i.classList.toggle('selected', on);
        i.setAttribute('aria-checked', on ? 'true':'false');
      });
    };

    [
      'body_comp','ethnicity','job_type','steps_per_day','workouts_per_week','workout_duration',
      'workout_intensity','neat_level','sleep_hours','weight_history','main_goal','goal_pace',
      'pregnancy_lactation','cycle_regular'
    ].forEach(k=>{ if (inputs[k] != null) selectSingle(k, inputs[k]); });

    if (inputs.chronic_conditions) 
      selectMultiple('chronic_conditions', inputs.chronic_conditions);

    try{
      const sys = document.getElementById('opt_fat');
      const bfn = document.getElementById('bf-none');
      const duo = document.querySelector('.field[data-key="fat"] .duo');
      if (sys && bfn){
        bfn.checked = !!sys.checked;
        if (duo) duo.classList.toggle('disabled', bfn.checked);
      }
    }catch(_){}

    try { 
      updateCycleVisibility(); 
      updateBodyCompVisibility(); 
    } catch(_){}
  }

  let _pollTimer = 0;
  
  async function pollOnce(){
    try{
      const res = await apiFrontWait(25);
      if (res?.ready){
        renderAIComment(res.html || '');

        try {
          fetch(BACKEND, {
            method:'POST',
            headers:{'Content-Type':'text/plain;charset=UTF-8'},
            body: JSON.stringify({ 
              action:'front_ack', 
              init_data:String(tg?.initData || '') 
            }),
            cache:'no-store', 
            credentials:'omit', 
            mode:'cors'
          }).catch(()=>{});
        } catch(_){}

        return {done:true};
      }
      setAIStatus('Обрабатываем… (ждём комментарий)');
      const wait = Math.max(300, Math.min(2000, Number(res?.retry_after_ms) || 1000));
      return {done:false, wait};
    } catch(_){
      setAIStatus('Не удалось загрузить данные. Попробуйте позже.');
      return {done:false, wait:1500};
    }
  }

  async function pollLoop(){
    clearTimeout(_pollTimer);
    const r = await pollOnce();
    if (r.done) return;
    _pollTimer = setTimeout(()=>pollLoop(), r.wait);
  }

  window.startFrontDataFlow = function(){ 
    pollLoop(); 
  };

  setAIStatus('Ждём данные…');
  setAnalyticsPlaceholder();
  window.startFrontDataFlow();

  apiLastInputs()
    .then(r => {
      if (r && r.found && r.inputs){
        applyInputsToWheels(r.inputs);
        applyInputsToSurvey(r.inputs);
      } else {
        ensureAllWheelsOnce();
      }
    })
    .catch(()=>{ 
      ensureAllWheelsOnce(); 
    });
}

/* ============================================================
 *  MACROS ANALYTICS FLOW
 * ============================================================ */
function initMacrosAnalytics(){
  const tg = window.Telegram?.WebApp;
  const BACKEND = BACKEND_URL;
  const host = () => document.getElementById('analytics');

  let _seriesAbort = null;
  const _seriesCacheByRow = Object.create(null);
  window._seriesCacheByRow = _seriesCacheByRow;

  function pickKbjuSeriesFrom(res){
    return res?.kbju_series || res?.kbju || res?.series_kbju || res?.days_kbju || null;
  }

  async function fetchKbjuSeries(row, signal){
    if (!BACKEND) return null;
    const payload = {
      action: 'front_kbju_series',
      init_data: String(tg?.initData || ''),
      row: Number(row || 0) || undefined
    };
    const resp = await fetch(BACKEND, {
      method:'POST',
      headers:{ 'Content-Type':'text/plain;charset=UTF-8' },
      body: JSON.stringify(payload),
      cache:'no-store', 
      credentials:'omit', 
      mode:'cors',
      signal
    });
    const raw = await resp.text();
    let json = null; 
    try{ json = raw ? JSON.parse(raw) : null; }
    catch(_){}
    if (!resp.ok || !json) throw new Error(`HTTP ${resp.status}`);
    return pickKbjuSeriesFrom(json);
  }

  function renderKbjuIfHost(series){
    if (typeof window.renderKBJU7 !== 'function') return;
    const kbjuHost = document.getElementById('kbju7-host');
    if (!kbjuHost) return;
    window.renderKBJU7(kbjuHost, Array.isArray(series) ? series : [], { 
      visible:7, 
      shape:'clip-capsule' 
    });
  }

  function fmtInt(v){ 
    return (v==null || isNaN(v)) ? '—' : String(Math.round(Number(v))); 
  }

  function renderSkeleton(){
    const el = host(); 
    if (!el) return;
    el.innerHTML = `
      <div class="field">
        <div class="macros-grid" id="macros-cards">
          <div class="macro-card"><div class="m-label">Калории</div><div class="m-value" id="m_kcal">—</div><div class="m-unit">ккал</div></div>
          <div class="macro-card"><div class="m-label">Белки</div><div class="m-value" id="m_protein">—</div><div class="m-unit">г</div></div>
          <div class="macro-card"><div class="m-label">Жиры</div><div class="m-value" id="m_fat">—</div><div class="m-unit">г</div></div>
          <div class="macro-card"><div class="m-label">Углеводы</div><div class="m-value" id="m_carbs">—</div><div class="m-unit">г</div></div>
        </div>
        <div class="macro-hint" id="macros-hint">После сохранения появятся расчёты.</div>
      </div>

      <div class="field" id="kbju7-field">
        <div class="kbju7 kbju7-card" id="kbju7-host" aria-label="История БЖУ">
          <div class="kbju7-viewport">
            <div class="kbju7-scroll" id="kbju7-scroll">
              <svg id="kbju7-svg" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="График БЖУ"></svg>
            </div>
          </div>
          <div class="kbju7-info" id="kbju7-info" role="tablist" aria-label="Выбор нутриента">
            <button type="button" class="legend-tap" data-key="prot" aria-pressed="false"><span class="dot" aria-hidden="true"></span><span>Б:</span> <b class="v" id="kbju7-p">—</b> г</button>
            <button type="button" class="legend-tap" data-key="fat"  aria-pressed="false"><span class="dot" aria-hidden="true"></span><span>Ж:</span> <b class="v" id="kbju7-f">—</b> г</button>
            <button type="button" class="legend-tap" data-key="carb" aria-pressed="false"><span class="dot" aria-hidden="true"></span><span>У:</span> <b class="v" id="kbju7-c">—</b> г</button>
          </div>
        </div>
      </div>
    `;
  }

  function renderValues(macros, opts){
    const o = opts || {};
    const set = (id, val) => { 
      const el = document.getElementById(id); 
      if (el) el.textContent = fmtInt(val); 
    };
    set('m_kcal',   macros?.kcal);
    set('m_protein',macros?.protein_g);
    set('m_fat',    macros?.fat_g);
    set('m_carbs',  macros?.carbs_g);

    const hint = document.getElementById('macros-hint');
    if (!hint) return;
    if (o.status === 'READY'){ 
      hint.textContent = 'Ваша норма в день'; 
    }
    else if (o.status === 'PARTIAL'){ 
      hint.textContent = 'Обновляем… часть значений уже готова.'; 
    }
    else if (o.status === 'WAITING'){ 
      hint.textContent = 'Считаем…'; 
    }
    else if (o.status === 'NO_ROW'){ 
      hint.textContent = 'Сначала заполните анкету и сохраните.'; 
    }
    else { 
      hint.textContent = '—'; 
    }
  }

  let _macrosTimer = 0;
  let _macrosRunId = 0;
  let _macrosAbort = null;
  let _macrosStatus = 'INIT';
  const STATUS_RANK = { INIT:0, NO_ROW:1, WAITING:2, PARTIAL:3, READY:4 };

  function renderValuesSafe(macros, nextStatus){
    const cur = STATUS_RANK[_macrosStatus] ?? 0;
    const nxt = STATUS_RANK[nextStatus] ?? 0;
    if (nxt < cur) return;
    renderValues(macros, { status: nextStatus });
    _macrosStatus = nextStatus;
  }

  async function apiFrontMacros(requestedRow, signal){
    const payload = {
      action: 'front_macros',
      init_data: String(tg?.initData || ''),
      row: Number(requestedRow || 0) || undefined
    };
    const resp = await fetch(BACKEND, {
      method:'POST',
      headers:{ 'Content-Type':'text/plain;charset=UTF-8' },
      body: JSON.stringify(payload),
      cache:'no-store', 
      credentials:'omit', 
      mode:'cors',
      signal
    });
    const raw = await resp.text();
    let json = null; 
    try { json = raw ? JSON.parse(raw) : null; } 
    catch(_){}
    if (!resp.ok || !json) throw new Error(`HTTP ${resp.status}`);
    return json;
  }

  async function pollOnce(runId){
    if (runId !== _macrosRunId) return { done:true };
    const reqRow = getRowCalcForUser();

    if (_macrosAbort) { 
      try{ _macrosAbort.abort(); }
      catch(_){ } 
    }
    const controller = new AbortController();
    _macrosAbort = controller;

    try{
      const res = await apiFrontMacros(reqRow, controller.signal);
      if (runId !== _macrosRunId) return { done:true };

      if (res?.row && res.row !== reqRow){
        setRowCalcForUser(res.row);
      }

      renderValuesSafe(res?.macros || {}, res?.status || 'WAITING');

      const kbjuInline = pickKbjuSeriesFrom(res);
      if (kbjuInline && Array.isArray(kbjuInline)) {
        const r = res.row || 0;
        _seriesCacheByRow[r] = kbjuInline;
        saveKbjuSeriesCache({ 
          row: r, 
          series: kbjuInline, 
          updated_at: res.updated_at || Date.now() 
        });
        renderKbjuIfHost(kbjuInline);
      } else {
        const rowToLoad = getRowCalcForUser();
        if (rowToLoad != null) {
          if (_seriesCacheByRow[rowToLoad]) {
            renderKbjuIfHost(_seriesCacheByRow[rowToLoad]);
          } else {
            if (_seriesAbort) { 
              try{ _seriesAbort.abort(); }
              catch(_){ } 
            }
            const ctrl = new AbortController(); 
            _seriesAbort = ctrl;
            fetchKbjuSeries(rowToLoad, ctrl.signal)
              .then(series => {
                if (series){
                  _seriesCacheByRow[rowToLoad] = series;
                  saveKbjuSeriesCache({ 
                    row: rowToLoad, 
                    series, 
                    updated_at: Date.now() 
                  });
                  renderKbjuIfHost(series);
                }
              })
              .catch(()=>{})
              .finally(()=>{ _seriesAbort = null; });
          }
        }
      }

      if (res?.ready){
        saveMacrosCache({ 
          row: res.row, 
          macros: res.macros, 
          updated_at: res.updated_at 
        });
        return { done:true };
      }
      const wait = Math.max(200, Math.min(1000, Number(res?.retry_after_ms) || 500));
      return { done:false, wait };
    } catch(err){
      if (err?.name === 'AbortError') return { done:true };
      if (runId !== _macrosRunId) return { done:true };
      return { done:false, wait: 1000 };
    }
  }

  async function pollLoop(runId){
    if (runId !== _macrosRunId) return;
    clearTimeout(_macrosTimer);
    const r = await pollOnce(runId);
    if (r.done || runId !== _macrosRunId) return;
    _macrosTimer = setTimeout(()=>pollLoop(runId), r.wait);
  }

  window.startMacrosFlow = function forceStart(){
    _macrosRunId += 1;
    const runId = _macrosRunId;
    _macrosStatus = 'INIT';

    renderSkeleton();

    try {
      const cached = loadMacrosCache();
      if (cached && cached.macros) 
        renderValuesSafe(cached.macros, 'READY');
    } catch(_){}

    try {
      const scached = loadKbjuSeriesCache();
      if (scached && Array.isArray(scached.series)) {
        renderKbjuIfHost(scached.series);
      } else {
        const row = getRowCalcForUser();
        if (row != null && _seriesCacheByRow[row]) {
          renderKbjuIfHost(_seriesCacheByRow[row]);
        }
      }
    } catch(_){}

    clearTimeout(_macrosTimer);
    if (_macrosAbort){ 
      try{ _macrosAbort.abort(); }
      catch(_){ } 
      _macrosAbort = null; 
    }
    if (_seriesAbort){ 
      try{ _seriesAbort.abort(); }
      catch(_){ } 
      _seriesAbort = null; 
    }

    pollLoop(runId);
  };

  document.addEventListener('visibilitychange', ()=>{
    if (document.visibilityState === 'hidden'){
      clearTimeout(_macrosTimer);
      if (_macrosAbort){ 
        try{ _macrosAbort.abort(); }
        catch(_){ } 
        _macrosAbort = null; 
      }
      if (_seriesAbort){ 
        try{ _seriesAbort.abort(); }
        catch(_){ } 
        _seriesAbort = null; 
      }
    } else {
      window.startMacrosFlow();
    }
  });

  window.startMacrosFlow();
}

/* ============================================================
 *  ADMIN PERFORMANCE SECTION
 * ============================================================ */
function maybeInjectAdminSection(){
  if (!isAdmin()) return;
  
  const anchor = document.getElementById('admin-section-anchor');
  if (!anchor) return;
  
  if (document.getElementById('sec-performance')) return;

  const sec = document.createElement('section');
  sec.className = 'section collapsed';
  sec.id = 'sec-performance';
  sec.innerHTML = `
    <div class="section-h" data-toggle="sec-performance" role="button" tabindex="0" aria-controls="sec-performance" aria-expanded="false">
      <h2>Скорость работы</h2>
      <div class="toggle" aria-hidden="true">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M8 10l4 4 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
    </div>
    <div class="section-content" id="perf-section">
      <div class="field">
        <div class="help" id="perfText" style="white-space:pre-line;text-align:left;font-family:monospace;font-size:13px"></div>
      </div>
    </div>
  `;
  anchor.replaceWith(sec);

  window.updatePerfUI = function(){
    const wheelsInit = (typeof window.__pageLaunchToWheelsInit === 'number') 
      ? (window.__pageLaunchToWheelsInit / 1000).toFixed(3) 
      : '—';
    const requestSent = (typeof window.__pageLaunchToRequestSent === 'number') 
      ? (window.__pageLaunchToRequestSent / 1000).toFixed(3) 
      : '—';
    const responseReceived = (typeof window.__pageLaunchToResponseReceived === 'number') 
      ? (window.__pageLaunchToResponseReceived / 1000).toFixed(3) 
      : '—';
    const wheel = (typeof window.__pageLaunchToUpdateWheel === 'number') 
      ? (window.__pageLaunchToUpdateWheel / 1000).toFixed(3) 
      : '—';
    const comment = (typeof window.__pageLaunchToUpdateComment === 'number') 
      ? (window.__pageLaunchToUpdateComment / 1000).toFixed(3) 
      : '—';
    
    const block = 
`PageLaunch→WheelsInit: ${wheelsInit} s
PageLaunch→RequestSent: ${requestSent} s
PageLaunch→ResponseReceived: ${responseReceived} s
PageLaunch→UpdateWheel: ${wheel} s
PageLaunch→UpdateComment: ${comment} s`;
    
    const el = document.getElementById('perfText');
    if (el) el.textContent = block;
  };

  try { updatePerfUI(); } catch(_){}
}

/* ============================================================
 *  MAIN INITIALIZATION (DOM READY)
 * ============================================================ */
function initApp(){
  console.log('[APP] Starting initialization...');
  
  // 1. TMA init
  (function initTMA(){
    const tg = window.Telegram?.WebApp;
    if (!tg) return;
    try { 
      tg.ready(); 
      tg.expand(); 
      tg.setHeaderColor('secondary_bg_color'); 
    } catch(_){}
    try {
      tg.BackButton?.offClick?.();
      tg.BackButton?.show();
      tg.BackButton?.onClick(()=>{ 
        try{ window.location.href='router.html'; }
        catch(_){ } 
      });
    } catch(_){}
  })();
  
  // 2. Build fields HTML
  const fieldsWrap = document.getElementById('fields');
  if (!fieldsWrap) {
    console.error('[APP] #fields not found!');
    return;
  }
  
  for (const cfg of FIELDS) {
    const f = document.createElement('div');
    f.className = 'field';
    f.dataset.key = cfg.key;
    f.dataset.min = cfg.min;
    f.dataset.max = cfg.max;
    if (cfg.onlyInt) f.dataset.onlyInt = '1';
    f.innerHTML = `
      <div class="row"><div class="label">${cfg.label}</div><div class="unit">${cfg.unit}</div></div>
      <div class="duo"><div class="col col-int"></div><div class="sep">,</div><div class="col col-frac"></div></div>
      <div class="help">${cfg.onlyInt ? 'целые годы' : (cfg.unit==='кг' ? 'кг: целые и десятые' : cfg.unit==='см' ? 'см: целые и десятые (1 десятая = 1 мм)' : 'проценты: целые и десятые')}</div>
    `;
    fieldsWrap.appendChild(f);
    window.fieldByKey[cfg.key] = f;
  }
  
  // 3. Init wheels (lazy - will init on first accordion open)
  // ensureAllWheelsOnce();
  
  // 4. Accordions
  (function initAccordions(){
    if (window.__accordionClickHandler) {
      document.removeEventListener('click', window.__accordionClickHandler, true);
    }

    window.__accordionClickHandler = function(e) {
      const h = e.target.closest('.section-h');
      if (!h) return;
      
      const id = h.getAttribute('data-toggle');
      const sec = document.getElementById(id);
      if (!sec) return;

      const willBeCollapsed = sec.classList.toggle('collapsed');
      h.setAttribute('aria-expanded', String(!willBeCollapsed));

      if (id === 'sec-measures' && !willBeCollapsed) {
        try { 
          ensureAllWheelsOnce(); 
          setTimeout(() => updateSaveButton(), 100);
        } catch(_){}
      }
    };

    document.addEventListener('click', window.__accordionClickHandler, { capture: true });

    document.querySelectorAll('.section-h').forEach(h => {
      const id = h.getAttribute('data-toggle');
      const sec = document.getElementById(id);
      if (sec) {
        h.setAttribute('aria-controls', id);
        h.setAttribute('aria-expanded', String(!sec.classList.contains('collapsed')));
      }
    });
  })();
  
  // 5. Save button
  (function bindSaveButton(){
    const btn = document.getElementById('saveBtn');
    if (!btn) {
      console.error('[APP] #saveBtn not found!');
      return;
    }
    
    const newBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(newBtn, btn);
    newBtn.addEventListener('click', handleSaveClick, false);
  })();
  
  // 6. Survey handlers
  (function initSurveyHandlers(){
    const hapticImpact = (type='light') => {
      try { window.Telegram?.WebApp?.HapticFeedback?.impactOccurred?.(type); } 
      catch(_){}
    };
    const hapticSelect = () => {
      try { window.Telegram?.WebApp?.HapticFeedback?.selectionChanged?.(); } 
      catch(_){}
    };

    document.addEventListener('click', (e) => {
      const bbtn = e.target.closest('.binary-btn');
      if (bbtn) {
        const field = bbtn.dataset.field;
        document.querySelectorAll('.binary-btn[data-field="'+field+'"]').forEach(b => {
          b.classList.remove('active');
          b.setAttribute('aria-pressed', 'false');
        });
        bbtn.classList.add('active');
        bbtn.setAttribute('aria-pressed', 'true');
        hapticSelect();
        updateCycleVisibility();
        updateSaveButton();
        return;
      }

      const item = e.target.closest('.choice-item');
      if (item) {
        const list = item.closest('.choice-list');
        if (!list) return;
        
        if (list.dataset.type === 'single') {
          list.querySelectorAll('.choice-item').forEach(i => {
            i.classList.remove('selected');
            i.setAttribute('aria-checked', 'false');
          });
          item.classList.add('selected');
          item.setAttribute('aria-checked', 'true');
          hapticSelect();
          
          if (list.dataset.field === 'pregnancy_lactation') {
            updateCycleVisibility();
          }
        } else if (list.dataset.type === 'multiple') {
          const nowSel = item.classList.toggle('selected');
          item.setAttribute('aria-checked', nowSel ? 'true' : 'false');
          hapticSelect();
          
          if (list.dataset.field === 'chronic_conditions') {
            if (item.dataset.value === 'none' && nowSel) {
              list.querySelectorAll('.choice-item').forEach(i => {
                if (i !== item) {
                  i.classList.remove('selected');
                  i.setAttribute('aria-checked', 'false');
                }
              });
            } else if (item.dataset.value !== 'none' && nowSel) {
              const noneItem = list.querySelector('.choice-item[data-value="none"]');
              if (noneItem) {
                noneItem.classList.remove('selected');
                noneItem.setAttribute('aria-checked', 'false');
              }
            }
          }
        }
        updateSaveButton();
        return;
      }

      const chk = e.target.closest('#bf-none-wrap');
      if (chk) {
        const input = chk.querySelector('input');
        input.checked = !input.checked;
        chk.classList.toggle('checked', input.checked);
        
        const optFat = document.querySelector('#opt_fat');
        if (optFat) optFat.checked = input.checked;
        
        const fatField = document.querySelector('.field[data-key="fat"]');
        const duo = fatField?.querySelector('.duo');
        if (duo) duo.classList.toggle('disabled', input.checked);
        
        const w = window.wheels?.fat;
        if (w?.setDisabled) w.setDisabled(input.checked, true);
        
        updateBodyCompVisibility();
        updateSaveButton();
        hapticSelect();
      }
    }, { passive: true });

    document.addEventListener('pointerdown', (e) => {
      const el = e.target.closest('.binary-btn, .choice-item, #bf-none-wrap, #saveBtn');
      if (el) hapticImpact('light');
    }, { passive: true });
  })();
  
  // 7. Validation listener
  (function setupValidation() {
    setTimeout(updateSaveButton, 100);
    
    document.addEventListener('wheelchange', () => {
      requestAnimationFrame(updateSaveButton);
    }, { passive: true });
    
    document.addEventListener('click', (e) => {
      const target = e.target?.closest?.('.binary-btn, .choice-item, #bf-none-wrap');
      if (target) {
        setTimeout(updateSaveButton, 50);
      }
    }, { passive: true });
  })();
  
  // 8. Ensure fat optline styled
  requestAnimationFrame(()=>{
    const fatField = document.querySelector('.field[data-key="fat"]');
    if (!fatField) return;
    const optline = fatField.querySelector('.optline');
    if (!optline) return;
    if (!optline.querySelector('#bf-none-wrap')){
      const wrap = document.createElement('label');
      wrap.className = 'check';
      wrap.id = 'bf-none-wrap';
      wrap.innerHTML = '<input type="checkbox" id="bf-none" hidden />'
        + '<span class="check-square" aria-hidden="true"></span>'
        + '<span class="check-label">нет данных</span>';
      optline.appendChild(wrap);
      const sys = document.getElementById('opt_fat');
      const duo = fatField.querySelector('.duo');
      if (sys){ wrap.querySelector('#bf-none').checked = !!sys.checked; }
      if (duo){ duo.classList.toggle('disabled', wrap.querySelector('#bf-none').checked); }
    }
  });
  
  // 9. Data flows
  initFrontDataFlow();
  initMacrosAnalytics();
  
  // 10. Admin section
  setTimeout(maybeInjectAdminSection, 300);
  
  // 11. Update last time display
  try {
    const lastTime = getLastMeasurementTime();
    if (lastTime) updateLastTimeDisplay(lastTime);
  } catch(_){}
  
  // 12. Update visibility
  requestAnimationFrame(()=>{ 
    updateCycleVisibility(); 
    updateBodyCompVisibility(); 
  });
  
  console.log('[APP] Initialization complete');
}

// === ENTRY POINT ===
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initApp, { once: true });
} else {
  initApp();
}

</script>
</body>
</html>
