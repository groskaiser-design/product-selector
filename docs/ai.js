const a0_0x2880dc=a0_0x20db;function a0_0xb8c0(){const _0x1c0fd0=['floor','preventDefault','now','messageInput','setItem','touchstart','message-bubble','getElementById','6qOnOWI','viewportHeight','remove','impactOccurred','parse','search','signal','Начнется\x20новый\x20диалог.','show-delete','contains','paddingBottom','innerHTML','warn','stopPropagation','initData','message\x20ai','getMinutes','padStart','viewportChanged','modalCancel','add','5972260WDjoRl','expand','error','appendChild','keydown','typingIndicator','text','role','WebApp','flex','https://script.google.com/macros/s/AKfycbzvlDKUH6qsON-A6iSHYvMU_6XWtReZc5oXnnZOMTgETfvZqMMh2zUbdQJF-iOanMBc/exec','show','(((.+)+)+)+$','Пустой\x20ответ','1658835CtsFck','modalText','input','confirmModal','toString','touchend','min','onClick','onclick','BackButton','apply','timestamp','20fyxAec','scrollHeight','getItem','click','194170vjYCwh','618kRglXG','children','inputArea','setHeaderColor','trim','debug_uid','modalTitle','notificationOccurred','addEventListener','none','height','POST','initDataUnsafe','Enter','removeItem','function','2460960WYHSyt','querySelectorAll','key','clear_history','sendBtn','240375QmgVuJ','Ошибка\x20сервера','#050505','isVersionAtLeast','Очистить\x20историю?','content','username','send_message','querySelector','scrollTop','ready','value','HapticFeedback','createElement','offClick','href','Удалить?','first_name','clearBtn','innerHeight','length','textContent','className','1968736JmfGmf','Ошибка\x20сети','<br>','modalConfirm','.message.show-delete','json','classList','div','replace','ai_chat_messages','offsetHeight','style','light','success','11403sxShBn','emptyState','push','user','forEach','target','stringify','.container','shiftKey','focus','disableVerticalSwipes'];a0_0xb8c0=function(){return _0x1c0fd0;};return a0_0xb8c0();}(function(_0xefcbd,_0x53964c){const _0x3cd630=a0_0x20db,_0x42573c=_0xefcbd();while(!![]){try{const _0x58a391=-parseInt(_0x3cd630(0xb9))/0x1*(parseInt(_0x3cd630(0xec))/0x2)+parseInt(_0x3cd630(0x81))/0x3*(parseInt(_0x3cd630(0xe8))/0x4)+parseInt(_0x3cd630(0x7c))/0x5+-parseInt(_0x3cd630(0xed))/0x6*(parseInt(_0x3cd630(0xa6))/0x7)+-parseInt(_0x3cd630(0x98))/0x8+-parseInt(_0x3cd630(0xdc))/0x9+parseInt(_0x3cd630(0xce))/0xa;if(_0x58a391===_0x53964c)break;else _0x42573c['push'](_0x42573c['shift']());}catch(_0x1e9507){_0x42573c['push'](_0x42573c['shift']());}}}(a0_0xb8c0,0x4b85b));const tg=window['Telegram']?.[a0_0x2880dc(0xd6)],HOME_URL='./router.html';function setupTelegramBackButton(){const _0x4bf539=a0_0x2880dc;if(!tg)return;try{tg[_0x4bf539(0x8b)](),tg[_0x4bf539(0xcf)](),tg[_0x4bf539(0xf0)]?.(_0x4bf539(0x83));if(tg[_0x4bf539(0x84)]?.('6.1'))tg[_0x4bf539(0xb0)]?.();const _0x56644c=tg[_0x4bf539(0xe5)];if(_0x56644c){_0x56644c[_0x4bf539(0xd9)]();if(typeof _0x56644c['offClick']===_0x4bf539(0x7b))try{_0x56644c[_0x4bf539(0x8f)]();}catch(_0x2e02c4){}_0x56644c[_0x4bf539(0xe3)](()=>{const _0x40025d=_0x4bf539;if(tg['HapticFeedback'])tg[_0x40025d(0x8d)][_0x40025d(0xbc)](_0x40025d(0xa4));location[_0x40025d(0x90)]=HOME_URL;});}}catch(_0x556c30){console[_0x4bf539(0xc5)]('TG\x20setup\x20error:',_0x556c30);}}(function initStableLayout(){const _0x316ba5=a0_0x2880dc,_0x5853fc=(function(){let _0x20cdd3=!![];return function(_0x14a2c2,_0x4173d9){const _0x498bfc=_0x20cdd3?function(){const _0x18eb28=a0_0x20db;if(_0x4173d9){const _0x28910b=_0x4173d9[_0x18eb28(0xe6)](_0x14a2c2,arguments);return _0x4173d9=null,_0x28910b;}}:function(){};return _0x20cdd3=![],_0x498bfc;};}()),_0x474951=document[_0x316ba5(0x89)](_0x316ba5(0xad)),_0x309ac4=document[_0x316ba5(0xb8)](_0x316ba5(0xef)),_0xcd142e=document[_0x316ba5(0xb8)]('chatArea'),_0x5db959=document[_0x316ba5(0xb8)]('messageInput');function _0x32a9d6(){const _0x5563af=_0x316ba5,_0x723a8a=_0x5853fc(this,function(){const _0x2998f5=a0_0x20db;return _0x723a8a[_0x2998f5(0xe0)]()[_0x2998f5(0xbe)](_0x2998f5(0xda))[_0x2998f5(0xe0)]()['constructor'](_0x723a8a)[_0x2998f5(0xbe)](_0x2998f5(0xda));});_0x723a8a();if(!_0x474951)return;const _0x172f03=tg&&tg[_0x5563af(0xba)]?tg[_0x5563af(0xba)]:window[_0x5563af(0x94)];_0x474951[_0x5563af(0xa3)]['height']=_0x172f03+'px';if(_0x309ac4){const _0x5ce55e=_0x309ac4[_0x5563af(0xa2)];_0xcd142e[_0x5563af(0xa3)][_0x5563af(0xc3)]=_0x5ce55e+0x28+'px';}}tg?tg['onEvent'](_0x316ba5(0xcb),({isStateStable:_0x414f3d})=>{_0x32a9d6();if(_0x414f3d)requestAnimationFrame(()=>{const _0x4f5fbd=a0_0x20db;_0xcd142e[_0x4f5fbd(0x8a)]=_0xcd142e['scrollHeight'];});}):window[_0x316ba5(0x74)]('resize',_0x32a9d6),_0x32a9d6(),_0x5db959&&(_0x5db959[_0x316ba5(0x74)](_0x316ba5(0xde),()=>{requestAnimationFrame(_0x32a9d6);}),_0x5db959[_0x316ba5(0x74)](_0x316ba5(0xaf),()=>{setTimeout(()=>{const _0x334438=a0_0x20db;_0xcd142e[_0x334438(0x8a)]=_0xcd142e[_0x334438(0xe9)];},0x12c);}));}(),setupTelegramBackButton());const BACKEND_URL=a0_0x2880dc(0xd8),REQUEST_TIMEOUT_MS=0xafc8;let messages=[],isTyping=![];const chatArea=document[a0_0x2880dc(0xb8)]('chatArea'),emptyState=document[a0_0x2880dc(0xb8)](a0_0x2880dc(0xa7)),messageInput=document[a0_0x2880dc(0xb8)](a0_0x2880dc(0xb4)),sendBtn=document[a0_0x2880dc(0xb8)](a0_0x2880dc(0x80)),clearBtn=document[a0_0x2880dc(0xb8)](a0_0x2880dc(0x93)),modal=document[a0_0x2880dc(0xb8)](a0_0x2880dc(0xdf)),mTitle=document['getElementById'](a0_0x2880dc(0x72)),mText=document['getElementById'](a0_0x2880dc(0xdd));let modalCallback=null;async function callBackend(_0x1fa95c,_0x15a709){const _0x5b1dbc=a0_0x2880dc,_0x39d9c8=tg?.[_0x5b1dbc(0x78)]?.[_0x5b1dbc(0xa9)]||{},_0x59aa49=_0x39d9c8['id']||localStorage[_0x5b1dbc(0xea)]('debug_uid')||'d-'+Math[_0x5b1dbc(0xb1)](Math['random']()*0x3b9aca00);if(!_0x39d9c8['id'])localStorage[_0x5b1dbc(0xb5)](_0x5b1dbc(0xf2),_0x59aa49);const _0x34365f={'action':_0x1fa95c,'user_id':_0x59aa49,'user_data':{'first_name':_0x39d9c8[_0x5b1dbc(0x92)],'username':_0x39d9c8[_0x5b1dbc(0x87)]},'init_data':tg?.[_0x5b1dbc(0xc7)]||'',..._0x15a709},_0x523183=new AbortController(),_0x4f20f4=setTimeout(()=>_0x523183['abort'](),REQUEST_TIMEOUT_MS);try{const _0x2633c8=await fetch(BACKEND_URL,{'method':_0x5b1dbc(0x77),'headers':{'Content-Type':'text/plain'},'body':JSON[_0x5b1dbc(0xac)](_0x34365f),'signal':_0x523183[_0x5b1dbc(0xbf)]});return clearTimeout(_0x4f20f4),await _0x2633c8[_0x5b1dbc(0x9d)]();}catch(_0x579f2e){return{'success':![],'error':String(_0x579f2e)};}}function formatTime(_0x1bb4c9){const _0x31f7a4=a0_0x2880dc,_0x4f147a=new Date(_0x1bb4c9);return String(_0x4f147a['getHours']())[_0x31f7a4(0xca)](0x2,'0')+':'+String(_0x4f147a[_0x31f7a4(0xc9)]())[_0x31f7a4(0xca)](0x2,'0');}function createMessageElement(_0x2ba81e,_0x136e71){const _0x1d4273=a0_0x2880dc,_0x7ee14=document[_0x1d4273(0x8e)]('div');_0x7ee14[_0x1d4273(0x97)]='message\x20'+_0x2ba81e[_0x1d4273(0xd5)];const _0x4c7e72=document[_0x1d4273(0x8e)](_0x1d4273(0x9f));_0x4c7e72[_0x1d4273(0x97)]=_0x1d4273(0xb7),_0x4c7e72[_0x1d4273(0xc4)]=_0x2ba81e[_0x1d4273(0x86)][_0x1d4273(0xa0)](/\n/g,_0x1d4273(0x9a));const _0x57588=document[_0x1d4273(0x8e)](_0x1d4273(0x9f));_0x57588['className']='delete-btn',_0x57588[_0x1d4273(0xc4)]='<svg\x20viewBox=\x220\x200\x2024\x2024\x22\x20fill=\x22none\x22\x20stroke=\x22currentColor\x22\x20stroke-width=\x222\x22\x20width=\x2216\x22\x20height=\x2216\x22><path\x20d=\x22M3\x206h18M19\x206v14a2\x202\x200\x2001-2\x202H7a2\x202\x200\x2001-2-2V6m3\x200V4a2\x202\x200\x20012-2h4a2\x202\x200\x20012\x202v2M10\x2011v6M14\x2011v6\x22/></svg>',_0x57588[_0x1d4273(0xe4)]=_0x3a6f83=>{const _0x5c7f99=_0x1d4273;_0x3a6f83[_0x5c7f99(0xc6)](),confirmDelete(_0x136e71);};let _0x16b5d2;_0x4c7e72[_0x1d4273(0x74)](_0x1d4273(0xb6),()=>_0x16b5d2=setTimeout(()=>{const _0x4a972f=_0x1d4273;_0x7ee14[_0x4a972f(0x9e)][_0x4a972f(0xcd)](_0x4a972f(0xc1));if(tg?.[_0x4a972f(0x8d)])tg['HapticFeedback'][_0x4a972f(0xbc)]('medium');},0x1f4)),_0x4c7e72[_0x1d4273(0x74)](_0x1d4273(0xe1),()=>clearTimeout(_0x16b5d2));const _0x344a5a=document[_0x1d4273(0x8e)]('div');return _0x344a5a[_0x1d4273(0x97)]='message-time',_0x344a5a[_0x1d4273(0x96)]=formatTime(_0x2ba81e[_0x1d4273(0xe7)]),_0x7ee14[_0x1d4273(0xd1)](_0x57588),_0x7ee14[_0x1d4273(0xd1)](_0x4c7e72),_0x7ee14[_0x1d4273(0xd1)](_0x344a5a),_0x7ee14;}function createTypingIndicator(){const _0x371902=a0_0x2880dc,_0x21f4da=document[_0x371902(0x8e)](_0x371902(0x9f));return _0x21f4da[_0x371902(0x97)]=_0x371902(0xc8),_0x21f4da['id']=_0x371902(0xd3),_0x21f4da['innerHTML']='<div\x20class=\x22message-bubble\x22><div\x20class=\x22typing-indicator\x22><div\x20class=\x22typing-dot\x22></div><div\x20class=\x22typing-dot\x22></div><div\x20class=\x22typing-dot\x22></div></div></div>',_0x21f4da;}function renderMessages(){const _0x22a039=a0_0x2880dc;Array['from'](chatArea[_0x22a039(0xee)])[_0x22a039(0xaa)](_0x2ac3e9=>{const _0x123bf3=_0x22a039;if(_0x2ac3e9['id']!=='emptyState')_0x2ac3e9[_0x123bf3(0xbb)]();}),messages[_0x22a039(0x95)]>0x0?(emptyState[_0x22a039(0xa3)]['display']=_0x22a039(0x75),messages['forEach']((_0x453445,_0xc366a0)=>chatArea[_0x22a039(0xd1)](createMessageElement(_0x453445,_0xc366a0)))):emptyState['style']['display']=_0x22a039(0xd7),requestAnimationFrame(()=>chatArea['scrollTop']=chatArea[_0x22a039(0xe9)]);}function autoResizeTextarea(){const _0x171fe6=a0_0x2880dc;messageInput[_0x171fe6(0xa3)][_0x171fe6(0x76)]='auto',messageInput['style'][_0x171fe6(0x76)]=Math[_0x171fe6(0xe2)](messageInput['scrollHeight'],0x78)+'px';}function updateSendButton(){const _0x47dddf=a0_0x2880dc,_0x2f0c95=messageInput[_0x47dddf(0x8c)]['trim']();sendBtn['disabled']=!_0x2f0c95||isTyping;}async function sendMessage(){const _0x2f9908=a0_0x2880dc,_0x3b19ab=messageInput[_0x2f9908(0x8c)][_0x2f9908(0xf1)]();if(!_0x3b19ab||isTyping)return;if(tg?.['HapticFeedback'])tg['HapticFeedback'][_0x2f9908(0xbc)](_0x2f9908(0xa4));messages[_0x2f9908(0xa8)]({'role':_0x2f9908(0xa9),'content':_0x3b19ab,'timestamp':Date[_0x2f9908(0xb3)]()}),localStorage[_0x2f9908(0xb5)](_0x2f9908(0xa1),JSON[_0x2f9908(0xac)](messages)),renderMessages(),messageInput[_0x2f9908(0x8c)]='',autoResizeTextarea(),updateSendButton(),isTyping=!![],chatArea[_0x2f9908(0xd1)](createTypingIndicator()),chatArea[_0x2f9908(0x8a)]=chatArea[_0x2f9908(0xe9)];const _0x53801d=await callBackend(_0x2f9908(0x88),{'message':_0x3b19ab});isTyping=![];const _0x1250cb=document[_0x2f9908(0xb8)]('typingIndicator');if(_0x1250cb)_0x1250cb[_0x2f9908(0xbb)]();let _0x4ddc27=_0x2f9908(0x99);if(_0x53801d['success']){_0x4ddc27=_0x53801d[_0x2f9908(0xd4)]||_0x2f9908(0xdb);if(tg?.[_0x2f9908(0x8d)])tg[_0x2f9908(0x8d)][_0x2f9908(0x73)](_0x2f9908(0xa5));}else{_0x4ddc27=_0x53801d[_0x2f9908(0xd0)]||_0x2f9908(0x82);if(tg?.[_0x2f9908(0x8d)])tg[_0x2f9908(0x8d)][_0x2f9908(0x73)](_0x2f9908(0xd0));}messages['push']({'role':'ai','content':_0x4ddc27,'timestamp':Date['now']()}),localStorage[_0x2f9908(0xb5)](_0x2f9908(0xa1),JSON[_0x2f9908(0xac)](messages)),renderMessages();}function confirmDelete(_0x27fd22){const _0x12fbbd=a0_0x2880dc;if(mTitle)mTitle['textContent']=_0x12fbbd(0x91);if(mText)mText['textContent']='Действие\x20необратимо.';modalCallback=()=>{const _0x21163d=_0x12fbbd;messages['splice'](_0x27fd22,0x1),localStorage[_0x21163d(0xb5)]('ai_chat_messages',JSON['stringify'](messages)),renderMessages();},modal[_0x12fbbd(0x9e)][_0x12fbbd(0xcd)](_0x12fbbd(0xd9));}if(clearBtn)clearBtn[a0_0x2880dc(0xe4)]=()=>{const _0xc05a09=a0_0x2880dc;if(!messages[_0xc05a09(0x95)])return;if(mTitle)mTitle['textContent']=_0xc05a09(0x85);if(mText)mText[_0xc05a09(0x96)]=_0xc05a09(0xc0);modalCallback=async()=>{const _0x1fb452=_0xc05a09;messages=[],localStorage[_0x1fb452(0x7a)](_0x1fb452(0xa1)),renderMessages(),callBackend(_0x1fb452(0x7f),{});},modal['classList'][_0xc05a09(0xcd)](_0xc05a09(0xd9));};function a0_0x20db(_0x472f2a,_0x490cbf){_0x472f2a=_0x472f2a-0x72;const _0x2c5ad4=a0_0xb8c0();let _0x1372ea=_0x2c5ad4[_0x472f2a];return _0x1372ea;}document[a0_0x2880dc(0xb8)](a0_0x2880dc(0xcc))['onclick']=()=>modal['classList'][a0_0x2880dc(0xbb)]('show'),document[a0_0x2880dc(0xb8)](a0_0x2880dc(0x9b))[a0_0x2880dc(0xe4)]=()=>{const _0x4bb396=a0_0x2880dc;if(modalCallback)modalCallback();modal[_0x4bb396(0x9e)]['remove'](_0x4bb396(0xd9));},messageInput['addEventListener'](a0_0x2880dc(0xde),()=>{updateSendButton(),autoResizeTextarea();}),messageInput[a0_0x2880dc(0x74)](a0_0x2880dc(0xd2),_0xf47dae=>{const _0x161678=a0_0x2880dc;_0xf47dae[_0x161678(0x7e)]===_0x161678(0x79)&&!_0xf47dae[_0x161678(0xae)]&&(_0xf47dae[_0x161678(0xb2)](),sendMessage());}),sendBtn['onclick']=sendMessage,document[a0_0x2880dc(0x74)](a0_0x2880dc(0xeb),_0xb753b6=>{const _0x5f586d=a0_0x2880dc;document[_0x5f586d(0x7d)](_0x5f586d(0x9c))[_0x5f586d(0xaa)](_0x578e18=>{const _0x54c7f9=_0x5f586d;if(!_0x578e18[_0x54c7f9(0xc2)](_0xb753b6[_0x54c7f9(0xab)]))_0x578e18[_0x54c7f9(0x9e)][_0x54c7f9(0xbb)]('show-delete');});});const saved=localStorage[a0_0x2880dc(0xea)](a0_0x2880dc(0xa1));if(saved)try{messages=JSON[a0_0x2880dc(0xbd)](saved),renderMessages();}catch(a0_0x14fa6b){}updateSendButton();