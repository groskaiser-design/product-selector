<!DOCTYPE html>
<html lang="ru">
<head>
<script src="version-control.js?t=1"></script>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<meta charset="UTF-8" />
<title>–ú–æ–π –†–∞—Ü–∏–æ–Ω</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  /* === BASE & RESET === */
  :root {
    --bg-core: #050505;
    --text-main: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.55);
    
    /* --- GLASS STYLE --- */
    --glass-bg: rgba(0, 0, 0, 0.3);
    --glass-border: 1px solid rgba(255, 255, 255, 0.1);
    --glass-border-top: 1px solid rgba(255, 255, 255, 0.2);
    --glass-shadow: 0 8px 24px rgba(0,0,0,0.2);
    --glass-blur: blur(20px);
    
    /* Accents */
    --acc-orange: #ff9f0a;
    --acc-green: #30d158;
    --acc-blue: #0a84ff;
    
    --radius-xl: 28px;
    --radius-l: 24px;
    --radius-m: 16px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  
  body {
    background-color: var(--bg-core);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', Roboto, sans-serif;
    color: var(--text-main);
    min-height: 100vh;
    padding-bottom: 100px; /* –£–≤–µ–ª–∏—á–∏–ª –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –¥–ª—è –∫–Ω–æ–ø–∫–∏ */
  }

  /* –°–∫—Ä—ã—Ç–∏–µ —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
  ::-webkit-scrollbar { width: 0; height: 0; display: none; }
  * { -ms-overflow-style: none; scrollbar-width: none; }

  /* === BACKGROUND FX === */
  .fx-layer { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
  .orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.4; animation: float 20s infinite ease-in-out; }
  .orb-1 { width: 300px; height: 300px; background: #bf5af2; top: -10%; left: -10%; animation-delay: 0s; }
  .orb-2 { width: 250px; height: 250px; background: var(--acc-blue); bottom: 10%; right: -10%; animation-delay: -5s; }
  
  @keyframes float { 
    0%, 100% { transform: translate(0, 0) scale(1); } 
    50% { transform: translate(20px, -20px) scale(1.1); } 
  }

  .noise {
    position: fixed; inset: 0; z-index: -1; opacity: 0.05;
    background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  }

  /* === LAYOUT === */
  .page {
    max-width: 600px;
    margin: 0 auto;
    padding: 16px;
    position: relative;
    z-index: 1;
  }

  /* === HEADER: 4 CARDS GRID === */
  .summary-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 24px;
  }

  .s-card {
    background: var(--glass-bg);
    border: var(--glass-border);
    border-top: var(--glass-border-top);
    border-radius: 20px;
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    box-shadow: var(--glass-shadow);
    padding: 16px 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    transition: transform 0.2s;
  }
  
  /* –ê–Ω–∏–º–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–∏—Ñ—Ä */
  .val-anim { animation: valFade 0.3s ease-out; }
  @keyframes valFade { 
    0% { opacity: 0.5; transform: scale(0.95); } 
    100% { opacity: 1; transform: scale(1); } 
  }

  .s-label { font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; letter-spacing: 0.3px; }
  .s-val { font-size: 28px; font-weight: 800; line-height: 1.1; color: #fff; font-variant-numeric: tabular-nums; margin-bottom: 2px; }
  .s-unit { font-size: 12px; font-weight: 500; color: rgba(255,255,255,0.4); }

  /* === TABS === */
  .tabs {
    display: flex; background: rgba(0, 0, 0, 0.3); 
    padding: 4px; border-radius: 14px; margin-bottom: 20px; position: relative;
    border: 1px solid rgba(255,255,255,0.05);
  }
  .tab-btn {
    flex: 1; text-align: center; padding: 10px; font-size: 13px;
    font-weight: 600; color: #fff; border-radius: 10px; cursor: pointer;
    transition: all 0.3s ease; position: relative; z-index: 2; opacity: 0.6;
  }
  .tab-btn.active { color: #fff; opacity: 1; text-shadow: 0 0 10px rgba(255,255,255,0.3); }
  
  .tab-indicator {
    position: absolute; top: 4px; bottom: 4px; left: 4px; width: calc(50% - 4px);
    background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1);
    border-top: 1px solid rgba(255,255,255,0.2); border-radius: 10px;
    transition: transform 0.3s cubic-bezier(0.22, 1, 0.36, 1);
    z-index: 1; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }

  /* === CONTENT SECTIONS === */
  .view-section { display: none; animation: fadeIn 0.4s ease; }
  .view-section.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  /* === TABLE STYLES === */
  .basket-table-wrapper {
    background: var(--glass-bg);
    border: var(--glass-border);
    border-top: var(--glass-border-top);
    border-radius: var(--radius-l);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    box-shadow: var(--glass-shadow);
    overflow: hidden;
  }

  .grid-layout {
    display: grid;
    grid-template-columns: 20px 1fr 50px 36px 36px 36px;
    gap: 4px;
    align-items: center;
  }

  .t-header {
    padding: 12px; background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.05);
    font-size: 13px; font-weight: 400; color: var(--text-muted); font-variant-numeric: tabular-nums;
  }
  .th-cell { text-align: right; }
  .th-prod-span { grid-column: 1 / 3; text-align: left; } 

  .t-row { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
  .t-row:last-child { border-bottom: none; }

  .t-icon { font-size: 16px; display: flex; justify-content: center; opacity: 0.9; }
  .t-name-wrap {
    overflow-x: auto; white-space: nowrap; padding-right: 4px; font-size: 13px; font-weight: 400; 
    color: rgba(255,255,255,0.9); mask-image: linear-gradient(90deg, #000 85%, transparent 100%);
    -webkit-mask-image: linear-gradient(90deg, #000 85%, transparent 100%); scrollbar-width: none;
  }
  .t-name-wrap::-webkit-scrollbar { display: none; }
  .t-num { text-align: right; font-size: 13px; font-weight: 400; font-variant-numeric: tabular-nums; white-space: nowrap; }
  
  .col-w { color: var(--text-muted); }
  .col-p { color: #5ac8fa; }
  .col-f { color: #ffcc00; }
  .col-c { color: #30d158; }

  /* === MEAL PLAN STYLES === */
  .days-grid {
    display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom: 20px;
  }
  
  .day-pill {
    background: var(--glass-bg); border: var(--glass-border); border-top: var(--glass-border-top);
    width: 100%; height: 64px; border-radius: 14px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 2px; cursor: pointer; transition: all 0.2s;
  }
  .day-pill.active {
    background: #fff; border-color: #fff; transform: scale(1.02);
    box-shadow: 0 4px 16px rgba(255,255,255,0.15);
  }
  .day-name { 
    font-size: 9px; font-weight: 700; color: var(--text-muted); 
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  .day-pill.active .day-name { color: #000; opacity: 0.6; }
  .day-num { font-size: 18px; font-weight: 800; color: #fff; line-height: 1; }
  .day-pill.active .day-num { color: #000; }

  .meal-card {
    background: var(--glass-bg); border: var(--glass-border); border-top: var(--glass-border-top);
    border-radius: var(--radius-l); backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur); box-shadow: var(--glass-shadow);
    padding: 16px; margin-bottom: 12px; display: flex; gap: 14px;
  }
  .meal-time {
    font-size: 12px; font-weight: 700; color: var(--text-muted);
    writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg);
    text-align: center; border-left: 2px solid var(--acc-blue); padding-left: 6px;
  }
  .meal-content { flex: 1; }
  .meal-title { font-size: 16px; font-weight: 700; margin-bottom: 6px; }
  .meal-ingr { font-size: 13px; color: rgba(255,255,255,0.8); line-height: 1.4; }
  .meal-macros { margin-top: 8px; display: flex; gap: 10px; font-size: 11px; color: var(--text-muted); font-weight: 500; }
  .m-tag { padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.05); }

  .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); font-size: 14px; }

  /* === üî• FAB BUTTON (–ù–æ–≤—ã–π —Ä–∞—Ü–∏–æ–Ω) === */
  .fab-container {
    position: fixed; bottom: 20px; left: 0; right: 0;
    display: flex; justify-content: center; z-index: 100;
    padding: 0 20px;
  }
  .action-btn {
    background: var(--acc-blue); 
    color: #fff; border: none; 
    border-radius: 20px;
    padding: 16px 32px;
    font-size: 16px; font-weight: 600;
    box-shadow: 0 8px 24px rgba(10, 132, 255, 0.4);
    cursor: pointer; transition: transform 0.2s, opacity 0.2s;
    display: flex; align-items: center; gap: 10px;
    backdrop-filter: blur(10px);
  }
  .action-btn:active { transform: scale(0.96); opacity: 0.9; }
  .action-btn.loading { opacity: 0.7; pointer-events: none; background: #333; box-shadow: none; }

</style>
</head>
<body>

  <div class="fx-layer">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="noise"></div>
  </div>

  <div class="page">
    
    <div class="summary-grid">
      <div class="s-card">
        <div class="s-label" id="headLabelKcal">–ö–∞–ª–æ—Ä–∏–∏</div>
        <div class="s-val" id="totalKcal">0</div>
        <div class="s-unit">–∫–∫–∞–ª</div>
      </div>
      <div class="s-card">
        <div class="s-label">–ë–µ–ª–∫–∏</div>
        <div class="s-val" id="totalPro">0</div>
        <div class="s-unit">–≥</div>
      </div>
      <div class="s-card">
        <div class="s-label">–ñ–∏—Ä—ã</div>
        <div class="s-val" id="totalFat">0</div>
        <div class="s-unit">–≥</div>
      </div>
      <div class="s-card">
        <div class="s-label">–£–≥–ª–µ–≤–æ–¥—ã</div>
        <div class="s-val" id="totalCarb">0</div>
        <div class="s-unit">–≥</div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab-indicator" id="tabIndicator"></div>
      <div class="tab-btn active" onclick="switchTab('basket')">–ü—Ä–æ–¥—É–∫—Ç—ã –Ω–∞ –Ω–µ–¥–µ–ª—é</div>
      <div class="tab-btn" onclick="switchTab('schedule')">–ú–µ–Ω—é –Ω–∞ –¥–µ–Ω—å</div>
    </div>

    <div id="view-basket" class="view-section active">
      <div class="basket-table-wrapper">
        <div class="t-header grid-layout">
          <div class="th-prod-span">–ü—Ä–æ–¥—É–∫—Ç</div>
          <div class="th-cell">–í–µ—Å</div>
          <div class="th-cell">–ë</div>
          <div class="th-cell">–ñ</div>
          <div class="th-cell">–£</div>
        </div>
        <div id="tableBody"></div>
      </div>
    </div>

    <div id="view-schedule" class="view-section">
      <div class="days-grid" id="daysGrid"></div>
      <div id="mealsContainer"></div>
    </div>

  </div>

  <div class="fab-container">
    <button class="action-btn" id="btnReshuffle" onclick="requestReshuffle()">
      –ù–æ–≤—ã–π —Ä–∞—Ü–∏–æ–Ω
    </button>
  </div>

<script>
  // --- CONFIG ---
  // –£–ë–ï–î–ò–°–¨, –ß–¢–û –≠–¢–û –°–°–´–õ–ö–ê –ù–ê –¢–í–û–ô –ê–ö–¢–£–ê–õ–¨–ù–´–ô –î–ï–ü–õ–û–ô
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbzMPQo3ARvDdWxJcv6oRp82Ub1pVZhnex_2KYJlqKoEkgerC5duMb-dwZW3ICHytFIV/exec';
  const STORAGE_KEY = 'ultima_ration_v1';
  const tg = window.Telegram?.WebApp;

  // --- DEFAULT STATE ---
  const DEFAULT_STATE = {
    "totals": {"protein":0, "fat":0, "carbs":0, "kcal":0},
    "basket": [],
    "days": {}
  };

const CATEGORY_MAP = {
    // –û–≤–æ—â–∏ (—É —Ç–µ–±—è –∏—Ö –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∏–¥–æ–≤)
    '–û–≤–æ—â–∏': { label: '–û–≤–æ—â–∏', icon: 'ü•¶' },
    '–û–≤–æ—â–∏ 1': { label: '–û–≤–æ—â–∏', icon: 'ü•¶' },
    '–û–≤–æ—â–∏ 2': { label: '–û–≤–æ—â–∏', icon: 'ü•í' },
    '–û–≤–æ—â–∏ 3': { label: '–ó–µ–ª–µ–Ω—å', icon: 'ü•¨' },
    
    // –§—Ä—É–∫—Ç—ã –∏ –Ø–≥–æ–¥—ã
    '–§—Ä—É–∫—Ç—ã': { label: '–§—Ä—É–∫—Ç—ã', icon: 'üçé' },
    '–§—Ä—É–∫—Ç—ã 1': { label: '–§—Ä—É–∫—Ç—ã', icon: 'üçé' },
    '–§—Ä—É–∫—Ç—ã 2': { label: '–§—Ä—É–∫—Ç—ã', icon: 'üçê' },
    '–Ø–≥–æ–¥—ã': { label: '–Ø–≥–æ–¥—ã', icon: 'üçì' },
    
    // –ë–∞–∫–∞–ª–µ—è –∏ –ì–∞—Ä–Ω–∏—Ä—ã
    '–û—Ä–µ—Ö–∏': { label: '–û—Ä–µ—Ö–∏', icon: 'üå∞' },
    '–°–µ–º–µ–Ω–∞': { label: '–°–µ–º–µ–Ω–∞', icon: 'üåª' },
    '–ö—Ä—É–ø—ã –∏ –∑–ª–∞–∫–∏': { label: '–ó–ª–∞–∫–∏', icon: 'üåæ' },
    '–ë–æ–±–æ–≤—ã–µ': { label: '–ë–æ–±–æ–≤—ã–µ', icon: 'ü´ò' },
    '–ú–∞–∫–∞—Ä–æ–Ω—ã': { label: '–ü–∞—Å—Ç–∞', icon: 'üçù' },
    '–ö–æ—Ä–Ω–µ–ø–ª–æ–¥—ã': { label: '–ö–æ—Ä–Ω–µ–ø–ª–æ–¥—ã', icon: 'ü•î' },
    
    // –ë–µ–ª–∫–∏
    '–ú—è—Å–æ': { label: '–ú—è—Å–æ', icon: 'ü•©' },
    '–ü—Ç–∏—Ü–∞': { label: '–ü—Ç–∏—Ü–∞', icon: 'üçó' },
    '–†—ã–±–∞': { label: '–†—ã–±–∞', icon: 'üêü' },
    '–ú–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã': { label: '–ú–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã', icon: 'ü¶ê' },
    '–Ø–π—Ü–∞': { label: '–Ø–π—Ü–∞', icon: 'ü•ö' },
    
    // –ú–æ–ª–æ—á–∫–∞ –∏ –ñ–∏—Ä—ã
    '–¢–≤–µ—Ä–¥—ã–µ –º–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã': { label: '–¢–≤–æ—Ä–æ–≥ / –°—ã—Ä', icon: 'üßÄ' },
    '–ñ–∏–¥–∫–∏–µ –º–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã': { label: '–ú–æ–ª–æ—á–Ω–æ–µ', icon: 'ü•õ' },
    '–ü–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã': { label: '–ñ–∏—Ä—ã', icon: 'ü•ë' },
    '–ü–æ–ª–µ–∑–Ω—ã–µ': { label: '–ñ–∏—Ä—ã', icon: 'ü•ë' }, // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ

    // –î–µ—Ñ–æ–ª—Ç
    'default': { label: '–ü—Ä–æ—á–µ–µ', icon: 'üõí' }
  };
  
  let appState = loadState();
  let activeTab = 'basket';

  // --- INIT ---
  document.addEventListener('DOMContentLoaded', () => {
    try { tg?.ready(); tg?.expand(); tg?.setHeaderColor('#050505'); } catch(e) {}
    renderAll(appState);
    syncLoad();
  });

  // --- LOGIC ---
  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : DEFAULT_STATE;
    } catch(e) { return DEFAULT_STATE; }
  }

  function saveState() {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(appState)); } catch(e) {}
  }

  // üîÑ –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–•
  async function syncLoad() {
    if (!GAS_URL.includes('/exec')) return;
    const initData = tg?.initData;
    if (!initData) return;

    try {
      const response = await fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'get_ration', initData: initData })
      });
      const data = await response.json();
      
      if (data.ok && data.ration) {
        if (JSON.stringify(appState) !== JSON.stringify(data.ration)) {
          appState = data.ration;
          saveState();
          renderAll(appState);
        }
      }
    } catch (e) { console.warn('Sync failed', e); }
  }

  // üé≤ –ó–ê–ü–†–û–° –ù–ê –ü–ï–†–ï–ú–ï–®–ò–í–ê–ù–ò–ï (–ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø)
  async function requestReshuffle() {
    if (!GAS_URL.includes('/exec')) return alert('URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
    const initData = tg?.initData;
    if (!initData) return alert('–ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏–∑ Telegram');

    const btn = document.getElementById('btnReshuffle');
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
    try { tg.HapticFeedback.impactOccurred('medium'); } catch(e){}
    btn.classList.add('loading');
    btn.innerHTML = '‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º...';

    try {
      // 1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –ø–µ—Ä–µ–º–µ—à–∞—Ç—å
      const response = await fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'reshuffle', initData: initData })
      });
      
      const data = await response.json();

      if (data.ok) {
        // 2. –ï—Å–ª–∏ –æ–∫ - —Å—Ä–∞–∑—É –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        await syncLoad();
        try { tg.HapticFeedback.notificationOccurred('success'); } catch(e){}
      } else {
        alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
      }

    } catch (e) {
      alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message);
    } finally {
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      btn.classList.remove('loading');
      btn.innerHTML = 'üé≤ –ù–æ–≤—ã–π —Ä–∞—Ü–∏–æ–Ω';
    }
  }

  // --- RENDER FUNCTIONS ---
  function renderAll(data) {
    if (!data) return;
    renderHeader(data.totals || DEFAULT_STATE.totals, false); 
    renderTableBasket(data.basket || []);
    renderSchedule();
  }

  const formatNum = (n) => Math.round(n || 0).toLocaleString('ru-RU');

  function animateValue(id, newValue) {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = formatNum(newValue);
    el.classList.remove('val-anim');
    void el.offsetWidth; 
    el.classList.add('val-anim');
  }

  function renderHeader(t, isDaily) {
    if(!t) return;
    const label = document.getElementById('headLabelKcal');
    if(label) label.textContent = isDaily ? '–ö–∞–ª–æ—Ä–∏–∏ (–î–µ–Ω—å)' : '–ö–∞–ª–æ—Ä–∏–∏ (–í—Å–µ–≥–æ)';
    animateValue('totalKcal', t.kcal);
    animateValue('totalPro', t.protein);
    animateValue('totalFat', t.fat);
    animateValue('totalCarb', t.carbs);
  }

  function renderTableBasket(basket) {
    const container = document.getElementById('tableBody');
    container.innerHTML = '';
    
    if(!basket || basket.length === 0) {
       container.innerHTML = '<div style="padding:20px; text-align:center; color:rgba(255,255,255,0.4)">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞...</div>';
       return;
    }

    const grouped = {};
    basket.forEach(item => {
      if (!grouped[item.category]) grouped[item.category] = [];
      grouped[item.category].push(item);
    });

    Object.keys(grouped).forEach(catKey => {
      const meta = CATEGORY_MAP[catKey] || CATEGORY_MAP.default;
      const items = grouped[catKey];
      items.forEach(item => {
        const row = document.createElement('div');
        row.className = 't-row grid-layout';
        const displayName = item.name.split('+').join(' ‚Ä¢ ');
        row.innerHTML = `
          <div class="t-icon">${meta.icon}</div>
          <div class="t-name-wrap">${displayName}</div>
          <div class="t-num col-w">${formatNum(item.weight)}</div>
          <div class="t-num col-p">${formatNum(item.protein)}</div>
          <div class="t-num col-f">${formatNum(item.fat)}</div>
          <div class="t-num col-c">${formatNum(item.carbs)}</div>
        `;
        container.appendChild(row);
      });
    });
  }

window.switchTab = function(tabName) {
    try { tg.HapticFeedback.selectionChanged(); } catch(e){}
    activeTab = tabName;
    const indicator = document.getElementById('tabIndicator');
    const basketView = document.getElementById('view-basket');
    const schedView = document.getElementById('view-schedule');
    const btns = document.querySelectorAll('.tab-btn');
    
    btns.forEach(b => b.classList.remove('active'));

    if (tabName === 'basket') {
      // –í–ö–õ–ê–î–ö–ê –ö–û–†–ó–ò–ù–ê
      // –ë–µ—Ä–µ–º –æ–±—â–∏–µ –∏—Ç–æ–≥–∏ –∏–∑ weekly_totals, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
      if(appState.totals) renderHeader(appState.totals, false);
      
      indicator.style.transform = 'translateX(0%)';
      btns[0].classList.add('active');
      basketView.classList.add('active');
      schedView.classList.remove('active');
    } else {
      // –í–ö–õ–ê–î–ö–ê –ú–ï–ù–Æ
      // –ò—â–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ 1-–π –¥–µ–Ω—å –≤ –º–∞—Å—Å–∏–≤–µ
      const daysArr = Array.isArray(appState.days) ? appState.days : [];
      const day1 = daysArr.find(d => d.day_num === 1);
      
      // –ï—Å–ª–∏ –¥–µ–Ω—å –Ω–∞–π–¥–µ–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ –ö–ë–ñ–£ –≤ —à–∞–ø–∫–µ
      if (day1 && day1.totals) renderHeader(day1.totals, true);
      
      indicator.style.transform = 'translateX(100%)';
      btns[1].classList.add('active');
      basketView.classList.remove('active');
      schedView.classList.add('active');
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –¥–Ω–µ–π –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–π
      const pills = document.querySelectorAll('.day-pill');
      pills.forEach(p => p.classList.remove('active'));
      if(pills[0]) pills[0].classList.add('active');
      
      // –†–µ–Ω–¥–µ—Ä–∏–º –º–µ–Ω—é –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è
      renderMealsForDay(1);
    }
  }

  function renderSchedule() {
    const daysContainer = document.getElementById('daysGrid');
    daysContainer.innerHTML = '';
    for (let i = 1; i <= 7; i++) {
      const pill = document.createElement('div');
      pill.className = `day-pill ${i === 1 ? 'active' : ''}`; 
      pill.onclick = () => selectDay(pill, i);
      pill.innerHTML = `<span class="day-name">–î–ï–ù–¨</span><span class="day-num">${i}</span>`;
      daysContainer.appendChild(pill);
    }
    renderMealsForDay(1);
  }

  function selectDay(el, dayNum) {
      try { tg.HapticFeedback.selectionChanged(); } catch(e){}
      
      // –í–∏–∑—É–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–ª–µ—Ç–∫–∏
      document.querySelectorAll('.day-pill').forEach(p => p.classList.remove('active'));
      el.classList.add('active');

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —à–∞–ø–∫–∏ —Å –ö–ë–ñ–£ (–∏—â–µ–º –¥–µ–Ω—å –≤ –º–∞—Å—Å–∏–≤–µ)
      const daysArr = Array.isArray(appState.days) ? appState.days : [];
      const selectedDay = daysArr.find(d => d.day_num === dayNum);
      
      if (selectedDay && selectedDay.totals) {
          renderHeader(selectedDay.totals, true);
      }
      
      // –ê–Ω–∏–º–∞—Ü–∏—è —Å–º–µ–Ω—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞
      const cont = document.getElementById('mealsContainer');
      cont.style.opacity = '0';
      cont.style.transform = 'translateY(5px)';
      
      setTimeout(() => {
        renderMealsForDay(dayNum);
        cont.style.opacity = '1';
        cont.style.transform = 'translateY(0)';
      }, 200);
    }

 function renderMealsForDay(dayNum) {
    const container = document.getElementById('mealsContainer');
    container.innerHTML = '';
    
    // 1. –ò—â–µ–º –Ω—É–∂–Ω—ã–π –¥–µ–Ω—å –≤ –º–∞—Å—Å–∏–≤–µ days, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—à–µ–ª —Å –±—ç–∫–µ–Ω–¥–∞
    // JSON –∏–º–µ–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É: { days: [ {day_num: 1...}, {day_num: 2...} ] }
    const daysArr = Array.isArray(appState.days) ? appState.days : [];
    const dayData = daysArr.find(d => d.day_num === dayNum);

    // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ—Ç
    if (!dayData || !dayData.meals || dayData.meals.length === 0) {
      container.innerHTML = '<div class="empty-state">–ú–µ–Ω—é –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –µ—â–µ –Ω–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ</div>';
      return;
    }
    
    // 2. –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –ø—Ä–∏–µ–º–∞–º –ø–∏—â–∏ (meals) –≤–Ω—É—Ç—Ä–∏ –¥–Ω—è
    dayData.meals.forEach(meal => {
      const card = document.createElement('div');
      card.className = 'meal-card';

      // –°–æ–±–∏—Ä–∞–µ–º –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –≤ —Å–ø–∏—Å–æ–∫
      // –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ—Ç–æ–≤–æ–µ –ø–æ–ª–µ display_str, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ –≤ GAS
      let ingredientsHTML = '';
      if (meal.ingredients && Array.isArray(meal.ingredients)) {
        ingredientsHTML = meal.ingredients
          .map(ing => `‚Ä¢ ${ing.display_str}`) // "‚Ä¢ –¢–≤–æ—Ä–æ–≥ (198–≥)"
          .join('<br>');
      }

      // –í—Å—Ç–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∫–∞—Ä—Ç–æ—á–∫—É
      card.innerHTML = `
        <div class="meal-time">${meal.title || '–ü—Ä–∏–µ–º'}</div>
        <div class="meal-content">
          <div class="meal-title">${meal.dish_name}</div>
          <div class="meal-ingr">
            ${ingredientsHTML}
          </div>
          <div class="meal-macros">
            <span class="m-tag">–ë–µ–ª–∫–∏: ${meal.macros.protein}–≥</span>
            <span class="m-tag">–ö–∫–∞–ª: ${meal.macros.kcal}</span>
          </div>
        </div>
      `;
      container.appendChild(card);
    });
  }
</script>
</body>
</html>