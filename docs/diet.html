<!DOCTYPE html>
<html lang="ru">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<meta charset="UTF-8" />
<title>–ú–æ–π –†–∞—Ü–∏–æ–Ω</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  /* === BASE & RESET === */
  :root {
    --bg-core: #050505;
    --text-main: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.55);
    
    /* --- GLASS STYLE (Restored from Profile) --- */
    --glass-bg: rgba(0, 0, 0, 0.3);
    --glass-border: 1px solid rgba(255, 255, 255, 0.1);
    --glass-border-top: 1px solid rgba(255, 255, 255, 0.2); /* –ë–ª–∏–∫ —Å–≤–µ—Ä—Ö—É */
    --glass-shadow: 0 8px 24px rgba(0,0,0,0.2);
    --glass-blur: blur(20px);
    
    /* Accents */
    --acc-orange: #ff9f0a;
    --acc-green: #30d158;
    --acc-blue: #0a84ff;
    
    --radius-xl: 28px;
    --radius-l: 24px;
    --radius-m: 16px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  
  body {
    background-color: var(--bg-core);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', Roboto, sans-serif;
    color: var(--text-main);
    min-height: 100vh;
    padding-bottom: 40px;
  }

  /* –°–∫—Ä—ã—Ç–∏–µ —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
  ::-webkit-scrollbar { width: 0; height: 0; display: none; }
  * { -ms-overflow-style: none; scrollbar-width: none; }

  /* === BACKGROUND FX === */
  .fx-layer { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
  .orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.4; animation: float 20s infinite ease-in-out; }
  .orb-1 { width: 300px; height: 300px; background: #bf5af2; top: -10%; left: -10%; animation-delay: 0s; }
  .orb-2 { width: 250px; height: 250px; background: var(--acc-blue); bottom: 10%; right: -10%; animation-delay: -5s; }
  
  @keyframes float { 
    0%, 100% { transform: translate(0, 0) scale(1); } 
    50% { transform: translate(20px, -20px) scale(1.1); } 
  }

  .noise {
    position: fixed; inset: 0; z-index: -1; opacity: 0.05;
    background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  }

  /* === LAYOUT === */
  .page {
    max-width: 600px;
    margin: 0 auto;
    padding: 16px;
    position: relative;
    z-index: 1;
  }

  /* === HEADER: 4 CARDS GRID (WEEKLY TOTALS) === */
  .summary-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 24px;
  }

  .s-card {
    /* Glass Style Applied */
    background: var(--glass-bg);
    border: var(--glass-border);
    border-top: var(--glass-border-top);
    border-radius: 20px;
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    box-shadow: var(--glass-shadow);
    
    padding: 16px 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
  }

  .s-label {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 6px;
    letter-spacing: 0.3px;
  }

  .s-val {
    font-size: 28px;
    font-weight: 800;
    line-height: 1.1;
    color: #fff;
    font-variant-numeric: tabular-nums;
    margin-bottom: 2px;
  }

  .s-unit {
    font-size: 12px;
    font-weight: 500;
    color: rgba(255,255,255,0.4);
  }

  /* === TABS === */
  .tabs {
    display: flex; 
    background: rgba(0, 0, 0, 0.3); 
    padding: 4px; border-radius: 14px; margin-bottom: 20px; position: relative;
    border: 1px solid rgba(255,255,255,0.05);
  }
  .tab-btn {
    flex: 1; text-align: center; padding: 10px; font-size: 13px;
    font-weight: 600; color: #fff; border-radius: 10px; cursor: pointer;
    transition: all 0.3s ease; position: relative; z-index: 2;
    opacity: 0.6;
  }
  .tab-btn.active { color: #fff; opacity: 1; text-shadow: 0 0 10px rgba(255,255,255,0.3); }
  
  .tab-indicator {
    position: absolute; top: 4px; bottom: 4px; left: 4px; width: calc(50% - 4px);
    background: rgba(255,255,255,0.1); 
    border: 1px solid rgba(255,255,255,0.1);
    border-top: 1px solid rgba(255,255,255,0.2);
    border-radius: 10px;
    transition: transform 0.3s cubic-bezier(0.22, 1, 0.36, 1);
    z-index: 1; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }

  /* === CONTENT SECTIONS === */
  .view-section { display: none; animation: fadeIn 0.4s ease; }
  .view-section.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  /* === TABLE STYLES (STRICT GRID & ALIGNMENT + GLASS) === */
  .basket-table-wrapper {
    /* Glass Style Applied */
    background: var(--glass-bg);
    border: var(--glass-border);
    border-top: var(--glass-border-top);
    border-radius: var(--radius-l);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    box-shadow: var(--glass-shadow);
    overflow: hidden;
  }

  /* Shared Grid Layout */
  .grid-layout {
    display: grid;
    /* GRID DEFINITION:
       Icon: 20px
       Name: 1fr (flexible)
       Weight: 50px
       B, J, U: 36px each
    */
    grid-template-columns: 20px 1fr 50px 36px 36px 36px;
    gap: 4px;
    align-items: center;
  }

  /* Table Header */
  .t-header {
    padding: 12px;
    background: rgba(0,0,0,0.2);
    border-bottom: 1px solid rgba(255,255,255,0.05);
    
    font-size: 13px;
    font-weight: 400;
    color: var(--text-muted);
    font-variant-numeric: tabular-nums;
  }
  
  .th-cell { text-align: right; }
  .th-prod-span { grid-column: 1 / 3; text-align: left; } 

  /* Item Row */
  .t-row {
    padding: 12px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .t-row:last-child { border-bottom: none; }

  /* Columns */
  .t-icon { font-size: 16px; display: flex; justify-content: center; opacity: 0.9; }

  .t-name-wrap {
    overflow-x: auto;
    white-space: nowrap;
    padding-right: 4px;
    font-size: 13px;
    font-weight: 400; 
    color: rgba(255,255,255,0.9);
    mask-image: linear-gradient(90deg, #000 85%, transparent 100%);
    -webkit-mask-image: linear-gradient(90deg, #000 85%, transparent 100%);
    scrollbar-width: none;
  }
  .t-name-wrap::-webkit-scrollbar { display: none; }

  .t-num {
    text-align: right;
    font-size: 13px;
    font-weight: 400;
    font-variant-numeric: tabular-nums; 
    white-space: nowrap;
  }
  
  .col-w { color: var(--text-muted); }
  .col-p { color: #5ac8fa; }
  .col-f { color: #ffcc00; }
  .col-c { color: #30d158; }

  /* === MEAL PLAN STYLES (GLASS + GRID) === */
  .days-grid {
    display: grid;
    /* 7 equal columns */
    grid-template-columns: repeat(7, 1fr);
    gap: 6px;
    margin-bottom: 20px;
  }
  
  .day-pill {
    /* Glass Style Applied */
    background: var(--glass-bg);
    border: var(--glass-border);
    border-top: var(--glass-border-top);
    
    width: 100%;
    min-width: 0; 
    height: 64px; 
    border-radius: 14px;
    
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 2px;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .day-pill.active {
    background: #fff;
    border-color: #fff;
    transform: scale(1.02);
    box-shadow: 0 4px 16px rgba(255,255,255,0.15);
  }
  
  .day-name { 
    font-size: 9px;
    font-weight: 700; color: var(--text-muted); text-transform: uppercase; 
    letter-spacing: 0.5px;
  }
  .day-pill.active .day-name { color: #000; opacity: 0.6; }
  
  .day-num { 
    font-size: 18px;
    font-weight: 800; color: #fff; line-height: 1;
  }
  .day-pill.active .day-num { color: #000; }

  .meal-card {
    /* Glass Style Applied */
    background: var(--glass-bg);
    border: var(--glass-border);
    border-top: var(--glass-border-top);
    border-radius: var(--radius-l);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    box-shadow: var(--glass-shadow);
    
    padding: 16px;
    margin-bottom: 12px;
    display: flex; gap: 14px;
  }
  .meal-time {
    font-size: 12px; font-weight: 700; color: var(--text-muted);
    writing-mode: vertical-rl; text-orientation: mixed;
    transform: rotate(180deg);
    text-align: center;
    border-left: 2px solid var(--acc-blue);
    padding-left: 6px;
  }
  .meal-content { flex: 1; }
  .meal-title { font-size: 16px; font-weight: 700; margin-bottom: 6px; }
  .meal-ingr { font-size: 13px; color: rgba(255,255,255,0.8); line-height: 1.4; }
  .meal-macros { margin-top: 8px; display: flex; gap: 10px; font-size: 11px; color: var(--text-muted); font-weight: 500; }
  .m-tag { padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.05); }

  .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); font-size: 14px; }

</style>
</head>
<body>

  <!-- Background Effects -->
  <div class="fx-layer">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="noise"></div>
  </div>

  <div class="page">
    
    <!-- 1. WEEKLY SUMMARY (2x2 Grid) -->
    <div class="summary-grid">
      <!-- Card 1: Kcal -->
      <div class="s-card">
        <div class="s-label">–ö–∞–ª–æ—Ä–∏–∏</div>
        <div class="s-val" id="totalKcal">0</div>
        <div class="s-unit">–∫–∫–∞–ª</div>
      </div>
      <!-- Card 2: Protein -->
      <div class="s-card">
        <div class="s-label">–ë–µ–ª–∫–∏</div>
        <div class="s-val" id="totalPro">0</div>
        <div class="s-unit">–≥</div>
      </div>
      <!-- Card 3: Fat -->
      <div class="s-card">
        <div class="s-label">–ñ–∏—Ä—ã</div>
        <div class="s-val" id="totalFat">0</div>
        <div class="s-unit">–≥</div>
      </div>
      <!-- Card 4: Carbs -->
      <div class="s-card">
        <div class="s-label">–£–≥–ª–µ–≤–æ–¥—ã</div>
        <div class="s-val" id="totalCarb">0</div>
        <div class="s-unit">–≥</div>
      </div>
    </div>

    <!-- 2. Navigation Tabs -->
    <div class="tabs">
      <div class="tab-indicator" id="tabIndicator"></div>
      <div class="tab-btn active" onclick="switchTab('basket')">–ü—Ä–æ–¥—É–∫—Ç—ã</div>
      <div class="tab-btn" onclick="switchTab('schedule')">–ú–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é</div>
    </div>

    <!-- 3. VIEW: TABLE BASKET -->
    <div id="view-basket" class="view-section active">
      <div class="basket-table-wrapper">
        <div class="t-header grid-layout">
          <div class="th-prod-span">–ü—Ä–æ–¥—É–∫—Ç</div>
          <!-- Skip col 2 (name) covered by span -->
          <div class="th-cell">–í–µ—Å</div>
          <div class="th-cell">–ë</div>
          <div class="th-cell">–ñ</div>
          <div class="th-cell">–£</div>
        </div>
        <div id="tableBody">
          <!-- JS generated rows -->
        </div>
      </div>
    </div>

    <!-- 4. VIEW: WEEKLY SCHEDULE -->
    <div id="view-schedule" class="view-section">
      <!-- Changed from scroll to grid -->
      <div class="days-grid" id="daysGrid">
        <!-- JS renders days 1-7 -->
      </div>
      <div id="mealsContainer">
        <div class="empty-state">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –º–µ–Ω—é</div>
      </div>
    </div>

  </div>

<script>
  // --- CONFIG ---
  // –°—Å—ã–ª–∫–∞ –Ω–∞ –±—ç–∫–µ–Ω–¥ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbzQbW4Bqmwq_51k9Op_CLJa5IX9v_MYkgXde2y3fAqqHX5wsvbSN7Uw9OpXFPP6raU/exec';
  const STORAGE_KEY = 'ultima_ration_v1';
  
  const tg = window.Telegram?.WebApp;

  // --- MOCK DATA (Fallback) ---
  const MOCK_DATA = {"id": "196047220", "targets": {"kcal":2928.45, "protein":162.90, "fat":81.35, "carbs":386.19}, "totals": {"protein":1160, "fat":569, "carbs":2744, "kcal":20743}, "accuracy": {"protein":1.02, "fat":1.00, "carbs":1.02, "kcal":1.01}, "basket": [{"category":"Veg","name":"–ö–∞–±–∞—á–æ–∫, —Å—ã—Ä–æ–π+–¢–æ–ø–∏–Ω–∞–º–±—É—Ä –±–µ–ª—ã–π, —Å—ã—Ä–æ–π+–°–≤—ë–∫–ª–∞, —Å—ã—Ä–∞—è","weight":3801,"protein":61,"fat":9,"carbs":381}, {"category":"Nut","name":"–ë—Ä–∞–∑–∏–ª—å—Å–∫–∏–π –æ—Ä–µ—Ö —Å—É—à—ë–Ω—ã–π","weight":210,"protein":30,"fat":141,"carbs":25}, {"category":"Seed","name":"–°–µ–º–µ–Ω–∞ –ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–∏–∫–∞, —Å—É—à—ë–Ω—ã–µ","weight":105,"protein":22,"fat":54,"carbs":25}, {"category":"Fruit1","name":"–ê–Ω–∞–Ω–∞—Å, —Å—ã—Ä–æ–π","weight":824,"protein":4,"fat":1,"carbs":108}, {"category":"Fruit2","name":"–ì—Ä—É—à–∞, —Å—ã—Ä–∞—è","weight":710,"protein":3,"fat":1,"carbs":108}, {"category":"Berry","name":"–ö–ª—é–∫–≤–∞, —Å—ã—Ä–∞—è","weight":885,"protein":4,"fat":1,"carbs":108}, {"category":"Cereal","name":"–ü—à–µ–Ω–∏—á–Ω—ã–µ –æ—Ç—Ä—É–±–∏, —Å—ã—Ä—ã–µ","weight":710,"protein":109,"fat":31,"carbs":459}, {"category":"Legume","name":"–ß–µ—á–µ–≤–∏—Ü–∞ –∂—ë–ª—Ç–∞—è, —Å—ã—Ä–∞—è","weight":728,"protein":179,"fat":7,"carbs":459}, {"category":"Pasta","name":"–ü–µ–Ω–Ω–µ, –ø—à–µ–Ω–∏—á–Ω—ã–µ, —Å—ã—Ä—ã–µ","weight":612,"protein":78,"fat":9,"carbs":459}, {"category":"Root","name":"–ë–∞—Ç–∞—Ç –±–µ–ª—ã–π, —Å—ã—Ä–æ–π","weight":2293,"protein":34,"fat":2,"carbs":459}, {"category":"Meat","name":"–ì–æ–≤—è–¥–∏–Ω–∞, —à–µ–π–Ω–∞—è —á–∞—Å—Ç—å","weight":305,"protein":62,"fat":24,"carbs":0}, {"category":"Poultry","name":"–ö—É—Ä–∏—Ü–∞, –∫—Ä—ã–ª—å—è (–±–µ–∑ –∫–æ–∂–∏)","weight":1028,"protein":185,"fat":57,"carbs":0}, {"category":"Fish","name":"–£–≥–æ—Ä—å","weight":670,"protein":123,"fat":78,"carbs":0}, {"category":"Seafood","name":"–ö—Ä–µ–≤–µ—Ç–∫–∏, —Å–µ–≤–µ—Ä–Ω—ã–µ (—Å—ã—Ä—ã–µ, –Ω–µ–æ—á–∏—â–µ–Ω–Ω—ã–µ)","weight":220,"protein":31,"fat":1,"carbs":0}, {"category":"SolidDairy","name":"–¢–≤–æ—Ä–æ–≥ –æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω—ã–π","weight":746,"protein":92,"fat":2,"carbs":20}, {"category":"LiqDairy","name":"–ú–æ–ª–æ–∫–æ –∫–æ—Ä–æ–≤—å–µ, –æ–±–µ–∑–∂–∏—Ä–µ–Ω–Ω–æ–µ (0.5%)","weight":907,"protein":31,"fat":5,"carbs":44}, {"category":"Eggs","name":"–Ø–∏—á–Ω—ã–π –±–µ–ª–æ–∫, —Å—ã—Ä–æ–π","weight":849,"protein":92,"fat":2,"carbs":6}, {"category":"Fats","name":"–ê–≤–æ–∫–∞–¥–æ (California), —Å—ã—Ä–æ–µ","weight":991,"protein":20,"fat":146,"carbs":84}]};

  const CATEGORY_MAP = {
    'Veg': { label: '–û–≤–æ—â–∏', icon: 'ü•í' },
    'Nut': { label: '–û—Ä–µ—Ö–∏', icon: 'ü•ú' },
    'Seed': { label: '–°–µ–º–µ–Ω–∞', icon: 'üåª' },
    'Fruit1': { label: '–§—Ä—É–∫—Ç—ã', icon: 'üçç' },
    'Fruit2': { label: '–§—Ä—É–∫—Ç—ã', icon: 'üçê' },
    'Berry': { label: '–Ø–≥–æ–¥—ã', icon: 'ü´ê' },
    'Cereal': { label: '–ó–ª–∞–∫–∏', icon: 'üåæ' },
    'Legume': { label: '–ë–æ–±–æ–≤—ã–µ', icon: 'ü´ò' },
    'Pasta': { label: '–ü–∞—Å—Ç–∞', icon: 'üçù' },
    'Root': { label: '–ö–æ—Ä–Ω–µ–ø–ª–æ–¥—ã', icon: 'ü•î' },
    'Meat': { label: '–ú—è—Å–æ', icon: 'ü•©' },
    'Poultry': { label: '–ü—Ç–∏—Ü–∞', icon: 'üçó' },
    'Fish': { label: '–†—ã–±–∞', icon: 'üêü' },
    'Seafood': { label: '–ú–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã', icon: 'ü¶ê' },
    'SolidDairy': { label: '–¢–≤–æ—Ä–æ–≥ / –°—ã—Ä', icon: 'üßÄ' },
    'LiqDairy': { label: '–ú–æ–ª–æ—á–Ω–æ–µ', icon: 'ü•õ' },
    'Eggs': { label: '–Ø–π—Ü–∞', icon: 'ü•ö' },
    'Fats': { label: '–ñ–∏—Ä—ã', icon: 'ü•ë' },
    'default': { label: '–ü—Ä–æ—á–µ–µ', icon: 'üõí' }
  };
  
  // State initialization
  let appState = loadState();

  // --- INIT ---
  document.addEventListener('DOMContentLoaded', () => {
    try { 
      tg?.ready(); 
      tg?.expand(); 
      tg?.setHeaderColor('#050505'); 
    } catch(e) {}

    // 1. Render immediately from local cache (or mock)
    renderAll(appState);

    // 2. Background sync
    syncLoad();
  });

  // --- STATE MANAGEMENT ---
  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : MOCK_DATA;
    } catch(e) { 
      return MOCK_DATA; 
    }
  }

  function saveState() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
    } catch(e) { console.error('Save error', e); }
  }

  // --- SYNC LOGIC ---
  async function syncLoad() {
    if (!GAS_URL.includes('/exec')) return;
    
    // Get real user ID from Telegram if available
    const userId = tg?.initDataUnsafe?.user?.id ? String(tg.initDataUnsafe.user.id) : appState.id;

    console.log('üîÑ Syncing ration for user:', userId);

    try {
      const response = await fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'get_ration', // Assuming backend handles this action
          userId: userId
        })
      });
      
      const data = await response.json();
      
      if (data.ok && data.ration) {
        // Compare with local to avoid unnecessary redraws
        const localStr = JSON.stringify(appState);
        const serverStr = JSON.stringify(data.ration);

        if (localStr !== serverStr) {
          console.log('‚òÅÔ∏è Updates found, applying...');
          appState = data.ration;
          saveState();
          renderAll(appState);
          
          // Haptic feedback on update
          try { tg.HapticFeedback.notificationOccurred('success'); } catch(e){}
        } else {
          console.log('‚úÖ Local data is up to date');
        }
      }
    } catch (e) {
      console.warn('Sync failed, using offline data', e);
    }
  }

  // --- RENDERERS ---
  function renderAll(data) {
    if (!data) return;
    renderHeader(data.totals);
    renderTableBasket(data.basket);
    renderSchedule();
  }

  const formatNum = (n) => Math.round(n).toLocaleString('ru-RU');

  function renderHeader(t) {
    if(!t) return;
    document.getElementById('totalKcal').textContent = formatNum(t.kcal);
    document.getElementById('totalPro').textContent = formatNum(t.protein);
    document.getElementById('totalFat').textContent = formatNum(t.fat);
    document.getElementById('totalCarb').textContent = formatNum(t.carbs);
  }

  function renderTableBasket(basket) {
    const container = document.getElementById('tableBody');
    container.innerHTML = '';
    if(!basket) return;

    // Group items
    const grouped = {};
    basket.forEach(item => {
      if (!grouped[item.category]) grouped[item.category] = [];
      grouped[item.category].push(item);
    });

    Object.keys(grouped).forEach(catKey => {
      const meta = CATEGORY_MAP[catKey] || CATEGORY_MAP.default;
      const items = grouped[catKey];

      items.forEach(item => {
        const row = document.createElement('div');
        row.className = 't-row grid-layout';
        
        const displayName = item.name.split('+').join(' ‚Ä¢ ');
        
        row.innerHTML = `
          <div class="t-icon">${meta.icon}</div>
          <div class="t-name-wrap">${displayName}</div>
          <div class="t-num col-w">${formatNum(item.weight)}</div>
          <div class="t-num col-p">${formatNum(item.protein)}</div>
          <div class="t-num col-f">${formatNum(item.fat)}</div>
          <div class="t-num col-c">${formatNum(item.carbs)}</div>
        `;
        container.appendChild(row);
      });
    });
  }

  // --- TABS & SCHEDULE ---
  window.switchTab = function(tabName) {
    try { tg.HapticFeedback.selectionChanged(); } catch(e){}
    const indicator = document.getElementById('tabIndicator');
    const basketView = document.getElementById('view-basket');
    const schedView = document.getElementById('view-schedule');
    const btns = document.querySelectorAll('.tab-btn');
    btns.forEach(b => b.classList.remove('active'));

    if (tabName === 'basket') {
      indicator.style.transform = 'translateX(0%)';
      btns[0].classList.add('active');
      basketView.classList.add('active');
      schedView.classList.remove('active');
    } else {
      indicator.style.transform = 'translateX(100%)';
      btns[1].classList.add('active');
      basketView.classList.remove('active');
      schedView.classList.add('active');
    }
  }

  function renderSchedule() {
    const daysContainer = document.getElementById('daysGrid');
    daysContainer.innerHTML = '';
    
    // Render Days 1 to 7
    for (let i = 1; i <= 7; i++) {
      const pill = document.createElement('div');
      pill.className = `day-pill ${i === 1 ? 'active' : ''}`; 
      pill.onclick = () => selectDay(pill, i);
      pill.innerHTML = `
        <span class="day-name">–î–ï–ù–¨</span>
        <span class="day-num">${i}</span>
      `;
      daysContainer.appendChild(pill);
    }
    renderMealsForDay(1);
  }

  function selectDay(el, dayNum) {
    try { tg.HapticFeedback.selectionChanged(); } catch(e){}
    document.querySelectorAll('.day-pill').forEach(p => p.classList.remove('active'));
    el.classList.add('active');
    const cont = document.getElementById('mealsContainer');
    cont.style.opacity = '0';
    cont.style.transform = 'translateY(5px)';
    setTimeout(() => {
      renderMealsForDay(dayNum);
      cont.style.opacity = '1';
      cont.style.transform = 'translateY(0)';
    }, 200);
  }

  function renderMealsForDay(dayNum) {
    const container = document.getElementById('mealsContainer');
    container.innerHTML = '';
    
    // Using appState.basket to generate plausible meals
    const basket = appState.basket || [];
    
    // Simple logic to distribute items for demo purposes
    // In real app, you'd likely have a "menu" object in the JSON
    const meals = [
      { time: '–ó–∞–≤—Ç—Ä–∞–∫', type: 'Eggs', type2: 'Cereal', name: '–û–º–ª–µ—Ç —Å –æ—Ç—Ä—É–±—è–º–∏' },
      { time: '–°–Ω–µ–∫', type: 'Fruit1', type2: 'Nut', name: '–§—Ä—É–∫—Ç–æ–≤—ã–π —Å–∞–ª–∞—Ç' },
      { time: '–û–±–µ–¥', type: 'Meat', type2: 'Pasta', name: '–ì–æ–≤—è–¥–∏–Ω–∞ —Å –ø–∞—Å—Ç–æ–π' },
      { time: '–ü–æ–ª–¥–Ω–∏–∫', type: 'SolidDairy', type2: 'Berry', name: '–¢–≤–æ—Ä–æ–≥ —Å —è–≥–æ–¥–∞–º–∏' },
      { time: '–£–∂–∏–Ω', type: 'Fish', type2: 'Veg', name: '–£–≥–æ—Ä—å —Å –æ–≤–æ—â–∞–º–∏' },
    ];
    
    meals.forEach(m => {
      const card = document.createElement('div');
      card.className = 'meal-card';
      const ing1 = basket.find(b => b.category === m.type);
      const w1 = ing1 ? Math.round(ing1.weight / 7) : 100;
      const ing2 = basket.find(b => b.category === m.type2);
      const w2 = ing2 ? Math.round(ing2.weight / 7) : 50;
      card.innerHTML = `
        <div class="meal-time">${m.time}</div>
        <div class="meal-content">
          <div class="meal-title">${m.name}</div>
          <div class="meal-ingr">
            ‚Ä¢ ${ing1 ? ing1.name.split('+')[0] : '–û—Å–Ω–æ–≤–Ω–æ–µ'} (${w1}–≥)<br>
            ‚Ä¢ ${ing2 ? ing2.name.split('+')[0] : '–ì–∞—Ä–Ω–∏—Ä'} (${w2}–≥)
          </div>
          <div class="meal-macros">
            <span class="m-tag">–ë–µ–ª–∫–∏: ${Math.round((w1+w2)*0.15)}–≥</span>
            <span class="m-tag">–ö–∫–∞–ª: ${Math.round((w1+w2)*1.2)}</span>
          </div>
        </div>
      `;
      container.appendChild(card);
    });
  }
</script>
</body>
</html>