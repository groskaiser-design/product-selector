<!DOCTYPE html>
<html lang="ru">
<head>
<script src="version-control.js?t=1"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
<title>Ultima Scanner v2.20</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  /* === 1. CORE & RESET === */
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
  *::-webkit-scrollbar { display: none; width: 0; height: 0; background: transparent; }
  * { scrollbar-width: none; }
  
  :root {
    --bg-core: #050505;
    --text-main: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.55);
    --surface-glass: rgba(255, 255, 255, 0.07);
    --surface-border: rgba(255, 255, 255, 0.1);
    
    --acc-green: #30d158;
    --acc-blue: #0a84ff;
    --acc-yellow: #ffcc00;
    --acc-red: #ff453a;
    --acc-over: #00f2ea;
    --acc-over-glow: rgba(0, 242, 234, 0.6);
    
    --radius-xl: 28px;
    --radius-l: 22px;
    
    --safe-top: calc(12px + env(safe-area-inset-top));
    --safe-bottom: calc(12px + env(safe-area-inset-bottom));
    
    --header-height: 340px; 
  }

  /* === FIX FROM AI.HTML: BODY IS STATIC BACKGROUND === */
  html, body {
    background-color: var(--bg-core);
    margin: 0; padding: 0; width: 100%; height: 100vh;
    overflow: hidden; 
    color: var(--text-main);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Roboto', sans-serif;
    position: fixed; top: 0; left: 0; /* Dead fix */
    -webkit-font-smoothing: antialiased; 
  }

  /* FX BACKGROUND (Behind everything) */
  .fx-layer { 
    position: fixed; 
    top: 0; left: 0; width: 100%; 
    /* –í—ã—Å–æ—Ç–∞ –±—É–¥–µ—Ç –∑–∞–¥–∞–Ω–∞ –∂–µ—Å—Ç–∫–æ —á–µ—Ä–µ–∑ JS, —á—Ç–æ–±—ã –Ω–µ –ø—Ä—ã–≥–∞–ª–∞ */
    height: 100vh; 
    z-index: 0; 
    pointer-events: none; 
  }
  .orb { position: absolute; border-radius: 50%; will-change: transform; animation: float 30s infinite linear; }
  .orb-1 { width: 90vw; height: 90vw; opacity: 0.4; background: radial-gradient(circle, rgba(108, 92, 231, 0.8) 0%, transparent 70%); top: -20%; left: -20%; }
  .orb-2 { width: 400px; height: 400px; opacity: 0.5; background: radial-gradient(circle, rgba(10, 132, 255, 0.6) 0%, transparent 70%); bottom: -150px; right: -100px; animation: breathe 6s infinite ease-in-out; }
  .noise { position: fixed; inset: 0; opacity: 0.04; background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); pointer-events: none; }
  @keyframes float { 0% {transform:rotate(0deg)} 100% {transform:rotate(360deg)} }
  @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.4; } 50% { transform: scale(1.1); opacity: 0.6; } }

  /* === MAIN APP CONTAINER (The one that resizes) === */
  .app-layout {
    position: relative; 
    z-index: 1; 
    top: 0; left: 0; right: 0;
    height: 100%; /* Will be set by JS */
    width: 100%;
    overflow: hidden;
    display: flex; 
    flex-direction: column;
  }

  /* === HEADER (Absolute inside App Layout) === */
  .fixed-header-group {
    position: absolute; 
    top: 0; left: 0; right: 0;
    z-index: 50;
    background: linear-gradient(180deg, rgba(5,5,5,0.95) 0%, rgba(5,5,5,0.85) 70%, rgba(5,5,5,0) 100%);
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    padding-bottom: 0px; 
    overscroll-behavior: none;
  }

  /* === 2. INFINITE CALENDAR === */
  .calendar-block {
    padding-top: var(--safe-top);
    padding-bottom: 8px;
    user-select: none;
    overflow: hidden;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .calendar-header { display: flex; align-items: center; justify-content: space-between; padding: 0 16px 8px 16px; }
  .month-label { font-size: 11px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.9; }
  
  .calendar-swipe-area { width: 100%; height: 52px; overflow: hidden; position: relative; touch-action: pan-y; cursor: grab; }
  .calendar-track { display: flex; width: 300%; height: 100%; transform: translateX(-33.333333%); will-change: transform; }
  .calendar-week { flex: 1; display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; height: 100%; padding: 0 10px; }

  .day-cell { height: 52px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; background: transparent; transition: background 0.2s, transform 0.1s; position: relative; cursor: pointer; user-select: none; }
  .day-cell:active { transform: scale(0.92); }
  .dc-name { font-size: 9px; font-weight: 600; color: var(--text-muted); margin-bottom: 3px; text-transform: uppercase; }
  .dc-num { font-size: 17px; font-weight: 600; color: #fff; font-variant-numeric: tabular-nums; }
  .day-cell.selected { background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05)); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 4px 12px rgba(0,0,0,0.2); transform: scale(1); }
  .day-cell.selected .dc-name { color: #fff; opacity: 0.8; }
  .day-cell.selected .dc-num { color: #fff; font-weight: 700; }
  .day-cell.is-today::after { content: ''; position: absolute; bottom: 5px; width: 4px; height: 4px; border-radius: 50%; background: var(--acc-blue); box-shadow: 0 0 6px var(--acc-blue); }

  /* === 3. WIDGETS === */
  .carousel-wrap { padding: 0; }
  .carousel-track { display: flex; gap: 12px; padding: 30px 16px 40px 16px; overflow-x: auto; scroll-snap-type: x mandatory; cursor: grab; scrollbar-width: none; }
  .widget { flex: 0 0 calc(100% - 16px); scroll-snap-align: center; height: 160px; border-radius: var(--radius-xl); background: linear-gradient(165deg, rgba(255,255,255,0.09) 0%, rgba(255,255,255,0.02) 100%); border: 1px solid var(--surface-border); border-top: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); position: relative; overflow: hidden; padding: 16px 12px; transition: 0.3s ease; }
  .widget.is-overload { box-shadow: 0 10px 40px -5px rgba(0, 242, 234, 0.25); border-color: rgba(0, 242, 234, 0.3); }

  /* Macros */
  .macros-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; height: 100%; align-items: center; }
  .macro-item { display: flex; flex-direction: column; align-items: center; justify-content: center; }
  .donut-box { width: 100%; max-width: 74px; aspect-ratio: 1; position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; }
  .mini-donut { width: 100%; height: 100%; transform: rotate(-90deg); filter: drop-shadow(0 4px 8px rgba(0,0,0,0.25)); }
  .md-bg { fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 7; }
  .md-val { fill: none; stroke-width: 7; stroke-linecap: round; stroke-dasharray: 151; transition: stroke-dashoffset 1s ease; }
  .m-icon { position: absolute; font-size: 20px; }
  .m-data { display: flex; flex-direction: column; align-items: center; }
  .m-nums { font-size: 13px; font-weight: 800; color: #fff; font-variant-numeric: tabular-nums; }
  .m-nums span { color: rgba(255,255,255,0.45); font-size: 11px; margin-left: 1px; }
  .m-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; color: rgba(255,255,255,0.5); margin-top: 2px; }
  
  .stroke-kcal { stroke: url(#grad-kcal); }
  .stroke-prot { stroke: url(#grad-prot); }
  .stroke-fats { stroke: url(#grad-fats); }
  .stroke-carb { stroke: url(#grad-carb); }

  /* Water */
  .widget.water-widget { display: flex; flex-direction: column; padding: 16px 20px; justify-content: space-between; }
  .water-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
  .water-title { font-size: 11px; font-weight: 800; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-muted); opacity: 0.8; }
  .water-percent { font-size: 12px; font-weight: 700; color: var(--acc-blue); transition: color 0.3s; }
  .widget.is-overload .water-percent { color: var(--acc-over); text-shadow: 0 0 8px var(--acc-over-glow); }
  .water-cols { display: flex; justify-content: space-between; align-items: flex-end; height: 50px; gap: 6px; margin: 8px 0; }
  .water-tube { flex: 1; height: 100%; background: rgba(0,0,0,0.4); border-radius: 6px; border: 1px solid rgba(255,255,255,0.06); position: relative; overflow: hidden; }
  .water-fill { position: absolute; bottom: 0; left: 0; right: 0; height: var(--h, 0%); background: var(--acc-blue); transition: height 0.3s cubic-bezier(0.25, 1, 0.5, 1), background-color 0.3s, box-shadow 0.3s; box-shadow: 0 0 12px rgba(10, 132, 255, 0.5); }
  .water-fill::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: rgba(255,255,255,0.6); opacity: 0.8; }
  .widget.is-overload .water-fill { background: var(--acc-over); box-shadow: 0 0 15px var(--acc-over-glow); }
  .water-footer { display: flex; justify-content: space-between; align-items: flex-end; }
  .water-info { display: flex; flex-direction: column; gap: 2px; }
  .wf-row { display: flex; align-items: baseline; gap: 4px; }
  .wf-fact { font-size: 28px; font-weight: 800; color: #fff; line-height: 1; letter-spacing: -0.5px; }
  .wf-unit { font-size: 12px; font-weight: 600; color: var(--text-muted); }
  .wf-plan { font-size: 11px; font-weight: 500; color: var(--text-muted); opacity: 0.7; }
  .water-controls { display: flex; gap: 24px; }
  .water-btn { width: 54px; height: 44px; border-radius: 14px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); color: #fff; font-size: 22px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
  .water-btn:active { background: var(--acc-blue); transform: scale(0.92); }
  .widget.is-overload .water-btn:active { background: var(--acc-over); }
  .dots { display: flex; justify-content: center; gap: 6px; margin-top: 0px; pointer-events: none; transform: translateY(-20px); }
  .dot { width: 6px; height: 6px; border-radius: 10px; background: rgba(255,255,255,0.2); transition: 0.3s; }
  .dot.active { width: 20px; background: #fff; }

  /* === 4. SCROLL CONTAINER === */
  .scroll-container {
    flex: 1; 
    overflow-y: auto; 
    -webkit-overflow-scrolling: touch;
    padding-top: var(--header-height); 
    /* Dynamic padding will be handled by JS, but keep safe default */
    padding-bottom: 120px;
    mask-image: linear-gradient(to bottom, transparent 0px, black 20px, black 100%);
    -webkit-mask-image: linear-gradient(to bottom, transparent 0px, black 20px, black 100%);
  }

  .timeline { padding: 10px 16px 0 16px; display: flex; flex-direction: column; gap: 12px; }
  
  .meal-card { 
    background: var(--surface-glass); 
    border: 1px solid var(--surface-border); 
    border-radius: var(--radius-l); 
    padding: 14px; 
    backdrop-filter: blur(12px); 
    transition: background 0.2s; 
  }
  .meal-card:active { background: rgba(255,255,255,0.1); }
  
  /* Grid Columns */
  .col-headers, .prod-item { display: grid; grid-template-columns: minmax(0, 1fr) 34px 30px 22px 22px 22px; gap: 5px; align-items: center; }
  .col-headers { margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.08); }
  .mh-time, .ch-item, .pi-name, .pi-val, .pi-w, .pi-k, .pi-p, .pi-f, .pi-c { font-size: 13px; font-weight: 400; color: #fff; font-feature-settings: "tnum"; white-space: nowrap; }
  .mh-time { text-align: left; } 
  .pi-name { overflow: hidden; text-overflow: ellipsis; }
  .ch-item, .pi-val { text-align: right; }
  .prod-item { margin-bottom: 10px; min-height: 20px; }
  .prod-item:last-child { margin-bottom: 2px; }

  /* === 5. OMNI-BAR (CHANGED: ABSOLUTE IN CONTAINER) === */
  .omni-bar { 
    position: absolute; /* CRITICAL CHANGE: Not fixed! */
    bottom: 0; left: 0; right: 0; 
    background: rgba(10, 10, 10, 0.85); 
    backdrop-filter: blur(30px); 
    border-top: 1px solid var(--surface-border); 
    padding: 8px 12px var(--safe-bottom) 12px; 
    z-index: 100; 
    display: flex; align-items: flex-end; gap: 8px; 
  }
  .icon-btn { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; }
  .input-wrap { flex: 1; min-height: 42px; background: rgba(255,255,255,0.08); border-radius: 20px; padding: 4px 16px; display: flex; align-items: center; }
  textarea { width: 100%; background: transparent; border: none; color: #fff; font-size: 15px; resize: none; font-family: inherit; padding: 10px 0; margin: 0; }
  .action-btn { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
  .mode-cam { color: #fff; }
  .mode-send { background: var(--acc-blue); color: #fff; box-shadow: 0 0 12px rgba(10,132,255,0.4); }

  /* === 6. SHEET (Outside Container, Fixed to Window) === */
  .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(4px); }
  .sheet-overlay.visible { opacity: 1; pointer-events: auto; }
  .sheet { position: fixed; bottom: 0; left: 0; right: 0; background: #151517; border-radius: 24px 24px 0 0; padding: 24px 16px calc(30px + env(safe-area-inset-bottom)) 16px; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.1, 0.7, 0.1, 1); border-top: 1px solid rgba(255,255,255,0.15); }
  .sheet-overlay.visible .sheet { transform: translateY(0); }
  .sheet-item { background: rgba(255,255,255,0.06); border-radius: 16px; padding: 16px; display: flex; align-items: center; gap: 16px; cursor: pointer; margin-bottom: 8px; }
  .sheet-item:active { background: rgba(255,255,255,0.12); }
  .sheet-icon { font-size: 24px; }
  .sheet-lbl { font-size: 16px; font-weight: 600; color: #fff; }


  /* === PROCESSING OVERLAY === */
.processing-overlay {
  position: fixed; inset: 0; z-index: 1000;
  background: rgba(5, 5, 5, 0.6); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω */
  backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); /* –¢–æ—Ç —Å–∞–º—ã–π Blur */
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: 0.4s ease;
}
.processing-overlay.active { opacity: 1; pointer-events: auto; }

.proc-card {
  width: 90%; max-width: 320px;
  background: rgba(30, 30, 30, 0.6);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 24px; padding: 30px 20px;
  display: flex; flex-direction: column; align-items: center;
  box-shadow: 0 20px 50px rgba(0,0,0,0.5);
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –û—Ä–±–∞ (–ì–ª–∞–∑ AI) */
.proc-visual { position: relative; width: 60px; height: 60px; margin-bottom: 20px; }
.proc-orb {
  position: absolute; inset: 0; border-radius: 50%;
  background: radial-gradient(circle, #0a84ff 0%, transparent 70%);
  animation: pulse-ai 2s infinite;
}
.proc-ring {
  position: absolute; inset: -10px; border-radius: 50%;
  border: 2px solid rgba(10, 132, 255, 0.3);
  border-top-color: #0a84ff;
  animation: spin-ai 1.5s infinite linear;
}
@keyframes pulse-ai { 0% { opacity: 0.5; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.5; transform: scale(0.8); } }
@keyframes spin-ai { 100% { transform: rotate(360deg); } }

.proc-title { font-size: 17px; font-weight: 700; color: #fff; margin-bottom: 20px; letter-spacing: 0.5px; }

/* –°–ø–∏—Å–æ–∫ —à–∞–≥–æ–≤ */
.proc-steps { width: 100%; display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
.step { display: flex; align-items: center; gap: 10px; opacity: 0.4; transition: 0.3s; transform: translateX(-10px); }
.step.active { opacity: 1; transform: translateX(0); font-weight: 600; }
.step.done { opacity: 0.5; transform: translateX(0); color: var(--acc-green); }
.s-icon { font-size: 14px; width: 20px; text-align: center; }
.s-lbl { font-size: 13px; color: #fff; }

.proc-close { margin-top: 10px; font-size: 13px; color: rgba(255,255,255,0.4); text-decoration: underline; cursor: pointer; }

/* === DRAFT SHEET (–í–∞–ª–∏–¥–∞—Ü–∏—è) === */
.draft-overlay {
  position: fixed; inset: 0; z-index: 1100;
  background: rgba(0,0,0,0.5);
  display: flex; flex-direction: column; justify-content: flex-end;
  opacity: 0; pointer-events: none; transition: 0.3s;
}
.draft-overlay.visible { opacity: 1; pointer-events: auto; }

.draft-sheet {
  background: #1c1c1e;
  border-radius: 24px 24px 0 0;
  border-top: 1px solid rgba(255,255,255,0.15);
  padding: 24px 20px calc(20px + env(safe-area-inset-bottom)) 20px;
  transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.1, 0.8, 0.2, 1);
  max-height: 80vh; overflow-y: auto;
}
.draft-overlay.visible .draft-sheet { transform: translateY(0); }

.ds-header { margin-bottom: 20px; }
.ds-title { font-size: 20px; font-weight: 800; margin-bottom: 4px; }
.ds-subtitle { font-size: 13px; color: var(--text-muted); line-height: 1.4; }

/* –≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ */
.draft-item {
  display: flex; align-items: center; gap: 10px;
  background: rgba(255,255,255,0.06);
  padding: 12px; border-radius: 16px; margin-bottom: 10px;
}
.di-icon { font-size: 20px; }
.di-inputs { flex: 1; display: flex; flex-direction: column; gap: 6px; }
.di-name { background: transparent; border: none; color: #fff; font-size: 15px; font-weight: 600; width: 100%; }
.di-row { display: flex; align-items: center; gap: 8px; }
.di-weight { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--acc-blue); font-weight: 700; width: 60px; text-align: center; padding: 4px; font-size: 14px; }
.di-unit { font-size: 13px; color: var(--text-muted); }
.di-del { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; color: var(--acc-red); opacity: 0.7; }

.ds-actions { display: flex; gap: 12px; margin-top: 20px; }
.ds-btn { flex: 1; height: 48px; border-radius: 14px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; }
.ds-btn.sec { background: rgba(255,255,255,0.1); color: #fff; }
.ds-btn.prim { background: var(--acc-blue); color: #fff; box-shadow: 0 4px 12px rgba(10,132,255,0.3); }

  /* === ANIMATIONS === */
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-20px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
  
/* === MISSING CAMERA STYLES (–í–°–¢–ê–í–ò–¢–¨ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û) === */
  .cam-layer {
    position: absolute; inset: 0; z-index: 60; /* –ü–æ–≤–µ—Ä—Ö —Ö–∏–¥–µ—Ä–∞ (z-50) */
    background: #000;
    display: flex; flex-direction: column;
    opacity: 0; pointer-events: none; transition: opacity 0.3s;
  }
  .cam-layer.active { opacity: 1; pointer-events: auto; }

  .cam-viewport {
    position: relative; flex: 1; width: 100%; overflow: hidden;
    display: flex; align-items: center; justify-content: center;
  }
  video {
    position: absolute; width: 100%; height: 100%; object-fit: cover;
    z-index: 1; opacity: 0; transition: opacity 0.3s;
  }
  video.active { opacity: 1; }

  /* UI Canvas (–£—Ä–æ–≤–µ–Ω—å –∏ –ø—Ä–∏—Ü–µ–ª) */
  #uiCanvas {
    position: absolute; inset: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none;
  }

  /* Controls Overlay */
  .cam-controls {
    position: absolute; inset: 0; z-index: 20;
    display: flex; flex-direction: column; justify-content: space-between;
    padding: calc(16px + env(safe-area-inset-top)) 16px calc(80px + env(safe-area-inset-bottom)) 16px;
    pointer-events: none;
  }
  .cam-controls > * { pointer-events: auto; }

  /* Top Bar */
  .cam-top { display: flex; justify-content: space-between; align-items: center; height: 48px; }
  .btn-circle {
    width: 44px; height: 44px; border-radius: 50%;
    background: rgba(0,0,0,0.4); backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
    display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer;
  }
  .lvl-chip {
    background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px);
    padding: 6px 14px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 600;
  }
  .lvl-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--acc-red); box-shadow: 0 0 8px var(--acc-red); transition: 0.3s; }
  .lvl-dot.ok { background: var(--acc-green); box-shadow: 0 0 8px var(--acc-green); }

  /* Bottom Grid */
  .cam-grid { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; width: 100%; }
  
  .shutter-outer {
    width: 76px; height: 76px; border-radius: 50%;
    border: 4px solid rgba(255,255,255,0.8);
    display: flex; align-items: center; justify-content: center; transition: 0.2s;
  }
  .shutter-inner { width: 58px; height: 58px; border-radius: 50%; background: #fff; transition: 0.2s; }
  .shutter-outer:active .shutter-inner { transform: scale(0.9); }
  
  /* PREVIEW SCREEN */
  .preview-layer {
    position: absolute; inset: 0; z-index: 70; background: #000;
    display: none; flex-direction: column;
  }
  .preview-img { flex: 1; object-fit: contain; background: #111; margin-bottom: 10px; }
  .preview-ui { padding: 0 20px 100px 20px; display: flex; flex-direction: column; gap: 16px; }
  .preview-input {
    width: 100%; height: 60px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1);
    border-radius: 16px; padding: 12px; color: #fff; font-size: 15px; resize: none;
  }
  .p-btns { display: flex; gap: 12px; }
  .p-btn { flex: 1; padding: 14px; border-radius: 14px; border: none; font-weight: 600; font-size: 16px; background: rgba(255,255,255,0.1); color: #fff; text-align: center; }
  .p-btn.primary { background: var(--acc-blue); }

  /* TOAST */
  .toast {
    position: absolute; top: 100px; left: 50%; transform: translateX(-50%);
    background: rgba(0,0,0,0.8); padding: 8px 16px; border-radius: 20px;
    font-size: 13px; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 80;
  }
  .toast.visible { opacity: 1; }

</style>
</head>
<body>

<svg width="0" height="0" style="position:absolute">
  <defs>
    <linearGradient id="grad-kcal"><stop offset="0%" stop-color="#ff9f0a"/><stop offset="100%" stop-color="#ff453a"/></linearGradient>
    <linearGradient id="grad-prot"><stop offset="0%" stop-color="#48bfe3"/><stop offset="100%" stop-color="#5e60ce"/></linearGradient>
    <linearGradient id="grad-fats"><stop offset="0%" stop-color="#f1c40f"/><stop offset="100%" stop-color="#e67e22"/></linearGradient>
    <linearGradient id="grad-carb"><stop offset="0%" stop-color="#2ecc71"/><stop offset="100%" stop-color="#1abc9c"/></linearGradient>
  </defs>
</svg>

<div class="fx-layer" id="fxLayer">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="noise"></div>
</div>

<!-- APP LAYOUT CONTAINER (Resizes safely) -->
<div class="app-layout" id="appLayout">
  
  <div class="cam-layer" id="camLayer">
    <div class="cam-viewport">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="uiCanvas"></canvas>
      <div id="camToast" class="toast">Camera info</div>
      
      <div class="cam-controls">
        <div class="cam-top">
          <div class="btn-circle" id="btnCloseCam">‚úï</div>
          <div class="lvl-chip"><div class="lvl-dot" id="lvlDot"></div><span id="lvlText">LEVEL</span></div>
          <div class="btn-circle" id="btnTorch" style="opacity:0">‚ö°</div>
        </div>
        
        <div style="flex:1"></div> <div class="cam-grid">
          <div style="display:flex; justify-content:flex-start">
             </div>
          <div style="display:flex; justify-content:center">
            <div class="shutter-outer" id="btnShutter">
              <div class="shutter-inner"></div>
            </div>
          </div>
          <div style="display:flex; justify-content:flex-end">
            <div class="btn-circle" id="btnSwitchCam">‚Üª</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="preview-layer" id="previewLayer">
    <img id="finalImg" class="preview-img">
    <div class="preview-ui">
      <textarea id="commentInput" class="preview-input" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)..."></textarea>
      <div class="p-btns">
        <div class="p-btn" onclick="CameraApp.retake()">–ü–µ—Ä–µ—Å–Ω—è—Ç—å</div>
        <div class="p-btn primary" id="btnSendPhoto" onclick="CameraApp.send()">–ì–æ—Ç–æ–≤–æ</div>
      </div>
    </div>
  </div>

  <div id="permReq" class="processing-overlay">
    <div class="proc-card">
      <div style="font-size:40px; margin-bottom:16px">üìê</div>
      <div class="proc-title">–î–æ—Å—Ç—É–ø –∫ –¥–∞—Ç—á–∏–∫–∞–º</div>
      <div class="s-lbl" style="text-align:center; margin-bottom:20px; opacity:0.7">–ù—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –≥–∏—Ä–æ—Å–∫–æ–ø—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —É—Ä–æ–≤–Ω—è.</div>
      <div class="p-btn primary" onclick="CameraApp.requestSensors()" style="width:100%">–†–∞–∑—Ä–µ—à–∏—Ç—å</div>
    </div>
  </div>

  <div class="fixed-header-group">
    <!-- CALENDAR -->
    <div class="calendar-block">
      <div class="calendar-header"><div class="month-label" id="monthLabel">...</div></div>
      <div class="calendar-swipe-area" id="swipeArea">
        <div class="calendar-track" id="calTrack">
          <div class="calendar-week" id="weekPrev"></div>
          <div class="calendar-week" id="weekCurr"></div>
          <div class="calendar-week" id="weekNext"></div>
        </div>
      </div>
    </div>
    <!-- WIDGETS -->
    <div class="carousel-wrap">
      <div class="carousel-track" id="track">
        <div class="widget">
          <div class="macros-grid">
            <div class="macro-item">
              <div class="donut-box">
                <svg class="mini-donut" viewBox="0 0 60 60">
                  <circle class="md-bg" cx="30" cy="30" r="24"/>
                  <circle id="ring-k" class="md-val stroke-kcal" cx="30" cy="30" r="24" style="stroke-dashoffset: 151px"/>
                </svg>
                <div class="m-icon">üî•</div>
              </div>
              <div class="m-data">
                <div class="m-nums" id="val-k">0<span>/0</span></div>
                <div class="m-lbl">–ö–ö–ê–õ</div>
              </div>
            </div>

            <div class="macro-item">
              <div class="donut-box">
                <svg class="mini-donut" viewBox="0 0 60 60">
                  <circle class="md-bg" cx="30" cy="30" r="24"/>
                  <circle id="ring-p" class="md-val stroke-prot" cx="30" cy="30" r="24" style="stroke-dashoffset: 151px"/>
                </svg>
                <div class="m-icon">üêì</div>
              </div>
              <div class="m-data">
                <div class="m-nums" id="val-p">0<span>/0</span></div>
                <div class="m-lbl">–ë–ï–õ–ö–ò</div>
              </div>
            </div>

            <div class="macro-item">
              <div class="donut-box">
                <svg class="mini-donut" viewBox="0 0 60 60">
                  <circle class="md-bg" cx="30" cy="30" r="24"/>
                  <circle id="ring-f" class="md-val stroke-fats" cx="30" cy="30" r="24" style="stroke-dashoffset: 151px"/>
                </svg>
                <div class="m-icon">ü•ë</div>
              </div>
              <div class="m-data">
                <div class="m-nums" id="val-f">0<span>/0</span></div>
                <div class="m-lbl">–ñ–ò–†–´</div>
              </div>
            </div>

            <div class="macro-item">
              <div class="donut-box">
                <svg class="mini-donut" viewBox="0 0 60 60">
                  <circle class="md-bg" cx="30" cy="30" r="24"/>
                  <circle id="ring-c" class="md-val stroke-carb" cx="30" cy="30" r="24" style="stroke-dashoffset: 151px"/>
                </svg>
                <div class="m-icon">üåæ</div>
              </div>
              <div class="m-data">
                <div class="m-nums" id="val-c">0<span>/0</span></div>
                <div class="m-lbl">–£–ì–õ–ò</div>
              </div>
            </div>

          </div>
        </div>
        <div class="widget water-widget" id="waterCard">
          <div class="water-header">
            <div class="water-title">–í–æ–¥–Ω—ã–π –±–∞–ª–∞–Ω—Å</div>
            <div class="water-percent" id="lbl-pct">0%</div>
          </div>
          
          <div class="water-cols">
            <div class="water-tube"><div class="water-fill" id="c1" style="height: 0%"></div></div>
            <div class="water-tube"><div class="water-fill" id="c2" style="height: 0%"></div></div>
            <div class="water-tube"><div class="water-fill" id="c3" style="height: 0%"></div></div>
            <div class="water-tube"><div class="water-fill" id="c4" style="height: 0%"></div></div>
            <div class="water-tube"><div class="water-fill" id="c5" style="height: 0%"></div></div>
          </div>

          <div class="water-footer">
            <div class="water-info">
              <div class="wf-row">
                <div class="wf-fact" id="lbl-fact">0</div>
                <div class="wf-unit">–º–ª</div>
              </div>
              <div class="wf-plan">–¶–µ–ª—å: <span id="lbl-target">2500</span></div>
            </div>
            <div class="water-controls">
              <div class="water-btn" onclick="WidgetManager.add(-250)">‚àí</div>
              <div class="water-btn" onclick="WidgetManager.add(250)">+</div>
            </div>
          </div>
        </div>
      </div>
      <div class="dots"><div class="dot active"></div><div class="dot"></div></div>
    </div>
  </div>

  <!-- SCROLL CONTAINER -->
  <div class="scroll-container" id="scrollContainer">
    <div class="timeline" id="timelineFeed"></div>
  </div>
</div> <!-- End App Layout -->

<div class="omni-bar" id="omniBar">
    <div class="icon-btn">
       <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h7"></path></svg>
    </div>
    
    <div class="input-wrap">
      <textarea id="omniInput" rows="1" placeholder="–Ø–±–ª–æ–∫–æ 200–≥, –∫–æ—Ñ–µ..."></textarea>
    </div>
    
    <div class="action-btn" id="btnOmniAction">
      <svg id="icoCam" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
        <circle cx="12" cy="13" r="4"></circle>
      </svg>
      <svg id="icoSend" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="display:none">
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    </div>
  </div>
  
  <div class="processing-overlay" id="procOverlay">
    <div class="proc-card">
      <div class="proc-visual"><div class="proc-orb"></div><div class="proc-ring"></div></div>
      <div class="proc-title">–ê–Ω–∞–ª–∏–∑...</div>
      <div class="proc-steps" id="procSteps"></div>
      <div class="proc-close" onclick="CameraApp.cancel()">–û—Ç–º–µ–Ω–∞</div>
    </div>
  </div>

  <div class="draft-overlay" id="draftOverlay">
    <div class="draft-sheet">
      <div class="ds-header"><div class="ds-title">–ü—Ä–æ–≤–µ—Ä–∫–∞</div><div class="ds-subtitle">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Å–æ—Å—Ç–∞–≤</div></div>
      <div id="draftList"></div>
      <div class="ds-actions">
        <button class="ds-btn sec" onclick="DraftManager.close()">–û—Ç–º–µ–Ω–∞</button>
        <button class="ds-btn prim" id="btnConfirmDraft" onclick="DraftManager.confirm()">–í –¥–Ω–µ–≤–Ω–∏–∫</button>
      </div>
    </div>
  </div>
  
<script>
  /* ============================================================
 * ULTIMA FINAL SCRIPT (FIXED)
 * ============================================================ */

// 1. CONFIGURATION
const API_URL = "https://script.google.com/macros/s/AKfycbx0fUaaCH-JwnG5R_3TFgU5FSibsEuhuS0ZZZfyxPNVPQ1ZpCfUIaa5aE8vjgqitac/exec";

// 2. CORE SYSTEM & LAYOUT
const tg = window.Telegram?.WebApp;

function initSystem() {
  if (tg) {
    tg.ready();
    tg.expand();
    tg.setHeaderColor('#050505');
    if (tg.disableVerticalSwipes) tg.disableVerticalSwipes();
  }
  
  // Layout Fix for iOS Keyboard
  const app = document.getElementById('appLayout'); 
  const fx = document.getElementById('fxLayer');
  
  function setHeight() {
    const h = tg?.viewportHeight || window.innerHeight;
    app.style.height = h + 'px';
    if(fx) fx.style.height = window.innerHeight + 'px';
  }
  
  window.addEventListener('resize', setHeight);
  if(tg) tg.onEvent('viewportChanged', setHeight);
  setHeight();
}

function haptic(style) {
  if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred(style || 'light');
}

// 3. CALENDAR ENGINE (With Physics)
const Calendar = {
  weekStart: new Date(),
  selected: new Date(),
  
  init: () => {
    // Calculate Monday
    const d = new Date();
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
    Calendar.weekStart = new Date(d.setDate(diff));
    
    Calendar.render();
    Calendar.bindEvents();
  },

  render: () => {
    Calendar.renderWeek(document.getElementById('weekCurr'), Calendar.weekStart);
    
    // Prev Week
    const prev = new Date(Calendar.weekStart); prev.setDate(prev.getDate() - 7);
    Calendar.renderWeek(document.getElementById('weekPrev'), prev);
    
    // Next Week
    const next = new Date(Calendar.weekStart); next.setDate(next.getDate() + 7);
    Calendar.renderWeek(document.getElementById('weekNext'), next);
    
    // Month Label
    const mid = new Date(Calendar.weekStart); mid.setDate(mid.getDate() + 3);
    document.getElementById('monthLabel').innerText = mid.toLocaleString('ru', { month: 'long', year: 'numeric' }).toUpperCase();
  },

  renderWeek: (el, startDate) => {
    el.innerHTML = '';
    const days = ['–ü–ù','–í–¢','–°–†','–ß–¢','–ü–¢','–°–ë','–í–°'];
    const todayStr = new Date().toDateString();
    const selStr = Calendar.selected.toDateString();
    
    for(let i=0; i<7; i++) {
      const d = new Date(startDate);
      d.setDate(d.getDate() + i);
      const isToday = d.toDateString() === todayStr;
      const isSel = d.toDateString() === selStr;
      
      const div = document.createElement('div');
      div.className = `day-cell ${isSel ? 'selected' : ''} ${isToday ? 'is-today' : ''}`;
      div.innerHTML = `<div class="dc-name">${days[i]}</div><div class="dc-num">${d.getDate()}</div>`;
      
      div.onclick = () => {
        document.querySelectorAll('.day-cell').forEach(c => c.classList.remove('selected'));
        div.classList.add('selected');
        Calendar.selected = new Date(d);
        haptic('selection');
        // Logic to load data for specific date goes here
      };
      el.appendChild(div);
    }
  },

  bindEvents: () => {
    const area = document.getElementById('swipeArea');
    const track = document.getElementById('calTrack');
    let startX = 0, currentX = 0, isDragging = false;

    area.onpointerdown = (e) => {
      isDragging = true;
      startX = e.clientX;
      track.style.transition = 'none';
    };

    area.onpointermove = (e) => {
      if(!isDragging) return;
      currentX = e.clientX - startX;
      track.style.transform = `translateX(calc(-33.33% + ${currentX}px))`;
    };

    const endSwipe = () => {
      if(!isDragging) return;
      isDragging = false;
      track.style.transition = 'transform 0.3s ease';
      
      if(currentX > 60) { // Swipe Right
        track.style.transform = `translateX(0%)`;
        setTimeout(() => {
          Calendar.weekStart.setDate(Calendar.weekStart.getDate() - 7);
          Calendar.render();
          track.style.transition = 'none';
          track.style.transform = `translateX(-33.33%)`;
        }, 300);
      } else if (currentX < -60) { // Swipe Left
        track.style.transform = `translateX(-66.66%)`;
        setTimeout(() => {
          Calendar.weekStart.setDate(Calendar.weekStart.getDate() + 7);
          Calendar.render();
          track.style.transition = 'none';
          track.style.transform = `translateX(-33.33%)`;
        }, 300);
      } else {
        track.style.transform = `translateX(-33.33%)`;
      }
      currentX = 0;
    };

    area.onpointerup = endSwipe;
    area.onpointercancel = endSwipe;
    area.onpointerleave = endSwipe;
  }
};

// 4. WIDGETS ENGINE
const Widgets = {
  init: () => {
    const track = document.getElementById('track');
    const dots = document.querySelectorAll('.dot');
    
    track.addEventListener('scroll', () => {
      const idx = Math.round(track.scrollLeft / track.clientWidth);
      dots.forEach((d, i) => d.classList.toggle('active', i === idx));
    });
  },
  
  update: (stats) => {
    const updateRing = (id, val, max) => {
      const el = document.getElementById(id);
      const txt = document.getElementById('val-' + id.split('-')[1]);
      if(el && txt) {
        const pct = Math.min(val / max, 1);
        el.style.strokeDashoffset = 151 - (pct * 151);
        txt.innerHTML = `${Math.round(val)}<span>/${max}</span>`;
      }
    };
    
    const T = { k:2100, p:160, f:70, c:250, w:2500 };
    updateRing('ring-k', stats.k, T.k);
    updateRing('ring-p', stats.p, T.p);
    updateRing('ring-f', stats.f, T.f);
    updateRing('ring-c', stats.c, T.c);
    
    // Water
    if(document.getElementById('lbl-fact')) {
        document.getElementById('lbl-fact').innerText = stats.water;
        document.getElementById('lbl-pct').innerText = Math.round((stats.water/T.w)*100) + '%';
        
        for(let i=1; i<=5; i++) {
            const tube = document.getElementById('c'+i);
            const limit = i * 500;
            let h = 0;
            if (stats.water >= limit) h = 100;
            else if (stats.water > (limit - 500)) h = ((stats.water - (limit-500))/500)*100;
            tube.style.height = h + '%';
        }
    }
  },
  
  addWater: (amount) => {
    haptic('light');
    // Local update simulation
    alert('Water + ' + amount);
  }
};
window.WidgetManager = { add: Widgets.addWater };

// 5. CAMERA & AI APP
const App = {
  mode: 'feed',
  
  openCam: async () => {
    App.mode = 'camera';
    document.getElementById('camLayer').classList.add('active');
    document.getElementById('omniBar').style.display = 'none';
    if(tg?.BackButton) tg.BackButton.show();
    await Camera.start();
  },
  
  closeCam: () => {
    App.mode = 'feed';
    document.getElementById('camLayer').classList.remove('active');
    document.getElementById('previewLayer').style.display = 'none';
    document.getElementById('omniBar').style.display = 'flex';
    if(tg?.BackButton) tg.BackButton.hide();
    Camera.stop();
  }
};

const Camera = {
  stream: null, devices: [], idx: 0, blob: null,
  
  init: () => {
    document.getElementById('btnShutter').onclick = Camera.snap;
    document.getElementById('btnSwitchCam').onclick = Camera.switch;
    document.getElementById('btnCloseCam').onclick = App.closeCam;
    document.getElementById('btnTorch').onclick = Camera.torch;
    
    if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
        document.getElementById('permReq').classList.add('active');
    } else {
        window.addEventListener('deviceorientation', Camera.gyro);
    }
  },
  
  gyro: (e) => {
    const cvs = document.getElementById('uiCanvas');
    const ctx = cvs.getContext('2d');
    const w = cvs.width = window.innerWidth;
    const h = cvs.height = window.innerHeight;
    const cx = w/2, cy = h/2;
    
    ctx.clearRect(0,0,w,h);
    // Crosshair
    ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(cx-10,cy); ctx.lineTo(cx+10,cy); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(cx,cy-10); ctx.lineTo(cx,cy+10); ctx.stroke();
    
    const x = e.beta, y = e.gamma;
    if(x!=null) {
        const isOk = Math.abs(x)<10 && Math.abs(y)<10;
        const color = isOk ? '#30d158' : '#ff453a';
        
        const dot = document.getElementById('lvlDot');
        if(isOk) { dot.classList.add('ok'); document.getElementById('lvlText').innerText="OK"; }
        else { dot.classList.remove('ok'); document.getElementById('lvlText').innerText="LEVEL"; }
        
        const dx = Math.max(-30, Math.min(30, y||0)) * 3;
        const dy = Math.max(-30, Math.min(30, x||0)) * 3;
        
        ctx.beginPath(); ctx.arc(cx+dx, cy+dy, 10, 0, Math.PI*2);
        ctx.fillStyle = color; ctx.fill();
    }
  },
  
  reqPerms: async () => {
      try { await DeviceOrientationEvent.requestPermission(); window.addEventListener('deviceorientation', Camera.gyro); } catch(e){}
      document.getElementById('permReq').classList.remove('active');
  },
  
  start: async () => {
    try {
        if(Camera.stream) Camera.stop();
        const devs = await navigator.mediaDevices.enumerateDevices();
        Camera.devices = devs.filter(d => d.kind === 'videoinput');
        
        const constraints = {
            video: { 
                deviceId: Camera.devices[Camera.idx]?.deviceId,
                facingMode: 'environment',
                width: {ideal: 1280}, height: {ideal: 1920}
            }, audio: false
        };
        Camera.stream = await navigator.mediaDevices.getUserMedia(constraints);
        const vid = document.getElementById('video');
        vid.srcObject = Camera.stream;
        vid.classList.add('active');
        
        // Torch check
        const track = Camera.stream.getVideoTracks()[0];
        const caps = track.getCapabilities();
        if(caps.torch) document.getElementById('btnTorch').style.opacity = 1;
        
    } catch(e) { alert(e.message); }
  },
  
  stop: () => {
      if(Camera.stream) Camera.stream.getTracks().forEach(t=>t.stop());
      document.getElementById('video').classList.remove('active');
  },
  
  switch: () => {
      Camera.idx = (Camera.idx + 1) % Camera.devices.length;
      Camera.start();
  },
  
  torch: () => {
      const track = Camera.stream?.getVideoTracks()[0];
      if(track) {
          const on = document.getElementById('btnTorch').classList.toggle('active');
          track.applyConstraints({advanced:[{torch:on}]}).catch(()=>{});
      }
  },
  
  snap: async () => {
      haptic('heavy');
      const vid = document.getElementById('video');
      const cvs = document.createElement('canvas');
      let w = vid.videoWidth, h = vid.videoHeight;
      const MAX = 1024;
      if(w>h && w>MAX) { h*=MAX/w; w=MAX; } else if(h>w && h>MAX) { w*=MAX/h; h=MAX; }
      cvs.width=w; cvs.height=h;
      cvs.getContext('2d').drawImage(vid,0,0,w,h);
      
      Camera.blob = await new Promise(r=>cvs.toBlob(r,'image/jpeg',0.7));
      document.getElementById('finalImg').src = URL.createObjectURL(Camera.blob);
      document.getElementById('previewLayer').style.display = 'flex';
  },
  
  retake: () => {
      document.getElementById('previewLayer').style.display = 'none';
      Camera.blob = null;
  },
  
  send: async () => {
      const btn = document.getElementById('btnSendPhoto');
      if(btn.style.opacity === '0.5') return;
      btn.style.opacity = '0.5';
      
      document.getElementById('previewLayer').style.display = 'none';
      ProcessingUI.start('photo');
      
      try {
          const b64 = await API.blobToB64(Camera.blob);
          const txt = document.getElementById('commentInput').value;
          const res = await API.post('scan', { image: b64, userText: txt });
          
          ProcessingUI.stop();
          if(res.ok) DraftManager.open(res.data, res.scanId);
          else throw new Error(res.error);
      } catch(e) {
          ProcessingUI.stop();
          alert(e.message);
          document.getElementById('previewLayer').style.display = 'flex';
      } finally { btn.style.opacity = '1'; }
  }
};

// 6. API CLIENT (Fixed Object Syntax)
const API = {
    blobToB64: (blob) => {
        return new Promise(r => {
            const reader = new FileReader();
            reader.onloadend = () => r(reader.result);
            reader.readAsDataURL(blob);
        });
    },
    
    post: async (action, data) => {
        const body = { action, user: tg?.initDataUnsafe?.user || {id:0, first_name:'Test'}, ...data };
        const res = await fetch(API_URL, {
            method: 'POST',
            headers: {'Content-Type': 'text/plain;charset=utf-8'},
            body: JSON.stringify(body)
        });
        return await res.json();
    }
};

// 7. UI OVERLAYS
const ProcessingUI = {
    start: (mode) => {
        document.getElementById('procOverlay').classList.add('active');
        const box = document.getElementById('procSteps');
        if(mode==='text') box.innerHTML = `<div class="step active">AI –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞...</div>`;
        else box.innerHTML = `<div class="step active">1. Gatekeeper...</div><div class="step">2. Vision AI...</div>`;
    },
    stop: () => {
        document.getElementById('procOverlay').classList.remove('active');
    }
};

const DraftManager = {
    data: [], scanId: null,
    open: (data, id) => {
        if(!data?.items) { alert("–ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ"); return; }
        DraftManager.data = data.items;
        DraftManager.scanId = id;
        DraftManager.render();
        document.getElementById('draftOverlay').classList.add('visible');
    },
    render: () => {
        const el = document.getElementById('draftList');
        el.innerHTML = '';
        DraftManager.data.forEach((item, i) => {
            el.innerHTML += `
            <div class="draft-item">
               <div class="di-icon">üçΩÔ∏è</div>
               <div class="di-inputs">
                 <input class="di-name" value="${item.name}" onchange="DraftManager.upd(${i},'name',this.value)">
                 <div class="di-row"><input type="number" class="di-weight" value="${item.weight_g}" onchange="DraftManager.upd(${i},'weight_g',this.value)"><div class="di-unit">–≥</div></div>
               </div>
               <div class="di-del" onclick="DraftManager.del(${i})">‚úï</div>
            </div>`;
        });
    },
    upd: (i, k, v) => { DraftManager.data[i][k] = k==='weight_g'? Number(v):v; },
    del: (i) => { DraftManager.data.splice(i,1); DraftManager.render(); },
    close: () => { 
        document.getElementById('draftOverlay').classList.remove('visible'); 
        if(App.mode === 'camera') document.getElementById('previewLayer').style.display = 'flex';
    },
    confirm: async () => {
        const btn = document.getElementById('btnConfirmDraft');
        btn.innerText = '–°–æ—Ö—Ä–∞–Ω—è—é...';
        try {
            const res = await API.post('calculate', { data: {items: DraftManager.data}, scanId: DraftManager.scanId });
            if(res.ok) {
                await API.post('save_meal', { meal_data: { meal_type: 'Snack', items: res.data.items } });
                DraftManager.close();
                App.closeCam();
                Backend.loadAndRender(); 
                haptic('success');
            }
        } catch(e) { alert(e.message); } finally { btn.innerText = '–í –¥–Ω–µ–≤–Ω–∏–∫'; }
    }
};

// 8. OMNI BAR
const Omni = {
    init: () => {
        const inp = document.getElementById('omniInput');
        const btn = document.getElementById('btnOmniAction');
        const iCam = document.getElementById('icoCam');
        const iSend = document.getElementById('icoSend');
        
        inp.oninput = () => {
            const hasText = inp.value.trim().length > 0;
            inp.style.height = 'auto'; inp.style.height = Math.min(inp.scrollHeight, 80) + 'px';
            if(hasText) { btn.classList.add('mode-send'); iCam.style.display='none'; iSend.style.display='block'; }
            else { btn.classList.remove('mode-send'); iCam.style.display='block'; iSend.style.display='none'; }
        };
        
        btn.onclick = async () => {
            const txt = inp.value.trim();
            if(txt) {
                haptic('medium'); inp.value = '';
                ProcessingUI.start('text');
                try {
                    const res = await API.post('scan', { userText: txt });
                    ProcessingUI.stop();
                    if(res.ok) DraftManager.open(res.data, res.scanId);
                } catch(e) { ProcessingUI.stop(); alert(e.message); }
            } else {
                haptic('light'); App.openCam();
            }
        };
    }
};

// 9. BACKEND FEED
const Backend = {
    loadAndRender: async () => {
        // Mock Data for immediate UI response
        const mockLog = [
            { time: "09:00", items: [{name:"–û–≤—Å—è–Ω–∫–∞ (–ü—Ä–∏–º–µ—Ä)", weight:200, k:180, p:6, f:4, c:30}] }
        ];
        Backend.renderFeed(mockLog);
        Widgets.update({ k:180, p:6, f:4, c:30, water: 1250 });
    },
    
    renderFeed: (log) => {
        const el = document.getElementById('timelineFeed');
        el.innerHTML = '';
        log.forEach((meal, i) => {
            let html = `<div class="meal-card" style="animation: slideIn 0.3s ease ${i*0.1}s backwards">
              <div class="col-headers"><div class="mh-time">${meal.time}</div><div class="ch-item">–í–µ—Å</div><div class="ch-item">–ö</div><div class="ch-item">–ë</div><div class="ch-item">–ñ</div><div class="ch-item">–£</div></div>`;
            meal.items.forEach(it => {
                html += `<div class="prod-item"><div class="pi-name">${it.name}</div><div class="pi-val pi-w">${it.weight}</div><div class="pi-val">${it.k}</div><div class="pi-val">${it.p}</div><div class="pi-val">${it.f}</div><div class="pi-val">${it.c}</div></div>`;
            });
            html += `</div>`;
            el.innerHTML += html;
        });
    }
};

// === GLOBAL INITIALIZATION ===
document.addEventListener('DOMContentLoaded', () => {
    initSystem();
    Calendar.init(); 
    Widgets.init();
    Camera.init();
    Omni.init();
    Backend.loadAndRender();
    
    if(tg?.BackButton) tg.BackButton.onClick(() => {
        if(App.mode === 'camera') App.closeCam();
        else if(document.getElementById('draftOverlay').classList.contains('visible')) DraftManager.close();
    });
});
</script>

</body>
</html>
