<!DOCTYPE html>
<html lang="ru">
<head>
<script src="version-control.js?t=1"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
<title>Ultima FoodCam</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
 :root {
  --bg-core: #050505;
  --orb-purple: rgba(108, 92, 231, 0.8);
  --acc-blue: #0a84ff;
  --surface-glass: rgba(28, 28, 30, 0.65);
  --acc-green: #30d158;
  --acc-red: #ff453a;
  --acc-orange: #ff9f0a;
  --text-main: #ffffff;
  --text-muted: rgba(255, 255, 255, 0.55);
  --font-stack: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Roboto', sans-serif;
  --safe-bottom: calc(12px + env(safe-area-inset-bottom));
}

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

/* === 1. –ì–õ–ê–í–ù–´–ô –§–ò–ö–°: BODY –°–¢–û–ò–¢ –ù–ê–ú–ï–†–¢–í–û === */
html, body {
  background-color: #000000;
  margin: 0; padding: 0; 
  width: 100%; 
  height: 100%; 
  overflow: hidden; 
  position: fixed; 
  top: 0; left: 0;
  overscroll-behavior: none;
  touch-action: none; 
  font-family: var(--font-stack);
}

/* === 2. –§–û–ù (–û–¢–î–ï–õ–¨–ù–´–ô –°–õ–û–ô) === */
.fx-layer { 
  position: fixed; 
  top: 0; left: 0; 
  width: 100vw; 
  height: 100vh; 
  z-index: 0; 
  pointer-events: none; 
  background-color: var(--bg-core);
}

.orb { position: absolute; border-radius: 50%; will-change: transform; filter: blur(80px); }
.orb-1 { width: 100vw; height: 100vw; opacity: 0.8; background: radial-gradient(circle, var(--orb-purple) 0%, transparent 70%); top: -20%; left: -10%; animation: float 30s infinite linear; }
.orb-2 { width: 300px; height: 300px; opacity: 0.4; background: radial-gradient(circle, var(--acc-blue) 0%, transparent 70%); bottom: -50px; right: -50px; animation: breathe 8s infinite ease-in-out; }
.noise { position: fixed; inset: 0; opacity: 0.05; background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); pointer-events: none; }
@keyframes float { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.3; } 50% { transform: scale(1.2); opacity: 0.5; } }

/* === 3. –ò–ù–¢–ï–†–§–ï–ô–° === */
.app-layout {
  position: absolute; 
  z-index: 1; 
  top: 0; left: 0; right: 0;
  overflow: hidden;
  display: flex; 
  flex-direction: column;
}

/* === 4. –ù–û–í–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –°–õ–û–ï–í (SURGEON PACK) === */

/* –ì–†–£–ü–ü–ê "–ì–û–õ–û–í–ê" (–ö–∞–ª–µ–Ω–¥–∞—Ä—å + –í–∏–¥–∂–µ—Ç—ã) */
.fixed-header-group {
  position: absolute; 
  top: 0; left: 0; right: 0;
  z-index: 50; 
  background: transparent; /* –ü–†–û–ó–†–ê–ß–ù–û–°–¢–¨ */
  pointer-events: auto; 
  transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
}

.calendar-block {
  position: relative;
  padding-top: calc(12px + env(safe-area-inset-top));
  padding-bottom: 8px;
  background: transparent;
}

.carousel-wrap {
  position: relative;
  padding-top: 0;
  pointer-events: auto;
}

/* –ì–†–£–ü–ü–ê "–¢–ï–õ–û" (–õ–µ–Ω—Ç–∞ —Å–æ–±—ã—Ç–∏–π) */
.scroll-container {
  position: absolute; 
  top: 0; left: 0; width: 100%; height: 100%;
  z-index: 10; 
  overflow-y: auto; 
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  pointer-events: auto; 
  
  /* –ì–ï–û–ú–ï–¢–†–ò–Ø: */
  padding-top: 340px; /* –ú–µ—Å—Ç–æ –ø–æ–¥ –≤–∏–¥–∂–µ—Ç—ã */
  padding-bottom: 140px; /* –ú–µ—Å—Ç–æ –ø–æ–¥ OmniBar */
  
  transition: opacity 0.3s;
  
  /* üî• –ì–†–ê–î–ò–ï–ù–¢–ù–ê–Ø –ú–ê–°–ö–ê (–¢–£–ú–ê–ù) */
  -webkit-mask-image: linear-gradient(to bottom, transparent 0px, transparent 280px, black 340px, black 100%);
  mask-image: linear-gradient(to bottom, transparent 0px, transparent 280px, black 340px, black 100%);
}

.timeline-container {
  width: 100%;
  padding: 0 12px;
}

/* –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ –∫–∞–º–µ—Ä–µ */
.fixed-header-group.hidden,
.scroll-container.hidden {
  pointer-events: none;
}

/* === –ö–ê–õ–ï–ù–î–ê–†–¨ –°–¢–ò–õ–ò === */
.calendar-header { display: flex; align-items: center; justify-content: space-between; padding: 0 16px 8px 16px; }
.month-label { font-size: 11px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.9; }
.calendar-swipe-area { width: 100%; height: 52px; overflow: hidden; position: relative; touch-action: pan-y; cursor: grab; }
.calendar-track { display: flex; width: 300%; height: 100%; transform: translateX(-33.333333%); will-change: transform; }
.calendar-week { flex: 1; display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; height: 100%; padding: 0 10px; }
.day-cell { height: 52px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; background: transparent; transition: background 0.2s, transform 0.1s; position: relative; cursor: pointer; user-select: none; }
.day-cell:active { transform: scale(0.92); }
.dc-name { font-size: 9px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 3px; }
.dc-num { font-size: 17px; font-weight: 600; color: var(--text-main); font-variant-numeric: tabular-nums; font-feature-settings: "tnum"; }
.day-cell.selected { background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05)); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 4px 12px rgba(0,0,0,0.2); transform: scale(1); }
.day-cell.selected .dc-name { color: #fff; opacity: 0.8; }
.day-cell.selected .dc-num { color: #fff; font-weight: 700; }
.day-cell.is-today::after { content: ''; position: absolute; bottom: 5px; width: 4px; height: 4px; border-radius: 50%; background: #0a84ff; box-shadow: 0 0 6px #0a84ff; }

/* === –í–ò–î–ñ–ï–¢–´ –°–¢–ò–õ–ò === */
.carousel-track { display: flex; gap: 12px; padding: 30px 16px 40px 16px; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; cursor: grab; }
.carousel-track::-webkit-scrollbar { display: none; }
.widget { flex: 0 0 calc(100% - 16px); scroll-snap-align: center; height: 160px; border-radius: 28px; background: rgba(20, 20, 20, 0.75); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); position: relative; overflow: hidden; padding: 16px 12px; transition: 0.3s ease; }
.macros-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; height: 100%; align-items: center; }
.macro-item { display: flex; flex-direction: column; align-items: center; justify-content: center; }
.donut-box { width: 100%; max-width: 74px; aspect-ratio: 1; position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; }
.mini-donut { width: 100%; height: 100%; transform: rotate(-90deg); filter: drop-shadow(0 4px 8px rgba(0,0,0,0.25)); }
.md-bg { fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 7; }
.md-val { fill: none; stroke-width: 7; stroke-linecap: round; stroke-dasharray: 151; transition: stroke-dashoffset 1s ease; }
.m-icon { position: absolute; font-size: 20px; }
.m-data { display: flex; flex-direction: column; align-items: center; }
.m-nums { font-size: 13px; font-weight: 800; color: #fff; font-variant-numeric: tabular-nums; }
.m-nums span { color: rgba(255,255,255,0.45); font-size: 11px; margin-left: 1px; }
.m-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; color: rgba(255,255,255,0.5); margin-top: 2px; }
.stroke-kcal { stroke: url(#grad-kcal); } .stroke-prot { stroke: url(#grad-prot); } .stroke-fats { stroke: url(#grad-fats); } .stroke-carb { stroke: url(#grad-carb); }
.widget.water-widget { display: flex; flex-direction: column; padding: 16px 20px; justify-content: space-between; }
.water-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.water-title { font-size: 11px; font-weight: 800; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-muted); opacity: 0.8; }
.water-percent { font-size: 12px; font-weight: 700; color: var(--acc-blue); transition: color 0.3s; }
.widget.is-overload .water-percent { color: #00f2ea; text-shadow: 0 0 8px rgba(0, 242, 234, 0.6); }
.water-cols { display: flex; justify-content: space-between; align-items: flex-end; height: 50px; gap: 6px; margin: 8px 0; }
.water-tube { flex: 1; height: 100%; background: rgba(0,0,0,0.4); border-radius: 6px; border: 1px solid rgba(255,255,255,0.06); position: relative; overflow: hidden; }
.water-fill { position: absolute; bottom: 0; left: 0; right: 0; height: var(--h, 0%); background: var(--acc-blue); transition: height 0.3s cubic-bezier(0.25, 1, 0.5, 1), background-color 0.3s; box-shadow: 0 0 12px rgba(10, 132, 255, 0.5); }
.water-fill::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: rgba(255,255,255,0.6); opacity: 0.8; }
.widget.is-overload .water-fill { background: #00f2ea; box-shadow: 0 0 15px rgba(0, 242, 234, 0.6); }
.water-footer { display: flex; justify-content: space-between; align-items: flex-end; }
.water-info { display: flex; flex-direction: column; gap: 2px; }
.wf-row { display: flex; align-items: baseline; gap: 4px; }
.wf-fact { font-size: 28px; font-weight: 800; color: #fff; line-height: 1; letter-spacing: -0.5px; }
.wf-unit { font-size: 12px; font-weight: 600; color: var(--text-muted); }
.wf-plan { font-size: 11px; font-weight: 500; color: var(--text-muted); opacity: 0.7; }
.water-controls { display: flex; gap: 24px; }
.water-btn { width: 54px; height: 44px; border-radius: 14px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); color: #fff; font-size: 22px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
.water-btn:active { background: var(--acc-blue); transform: scale(0.92); }
.dots { display: flex; justify-content: center; gap: 6px; margin-top: 0px; pointer-events: none; transform: translateY(-20px); }
.dot { width: 6px; height: 6px; border-radius: 10px; background: rgba(255,255,255,0.2); transition: 0.3s; }
.dot.active { width: 20px; background: #fff; }

/* === –ö–ê–ú–ï–†–ê –ò OMNI BAR === */
.cam-viewport {
  position: absolute; 
  top: 0; left: 0; width: 100%; height: 100%;
  z-index: 0; 
  margin: 0; padding: 0; display: flex;
}
#video { width: 100%; height: 100%; object-fit: cover !important; position: absolute; inset: 0; }
.cam-loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 5; display: flex; align-items: center; justify-content: center; pointer-events: none; }
.spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
#uiCanvas { position: absolute; inset: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }

.omni-bar { 
  position: absolute; bottom: 0; left: 0; right: 0; 
  background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, transparent 100%); 
  padding: 10px 12px calc(10px + env(safe-area-inset-bottom)) 12px; 
  z-index: 100; display: flex; align-items: flex-end; gap: 10px; 
  transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}
.omni-bar.hidden { transform: translateY(100%); }
.omni-icon-btn { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; border-radius: 50%; transition: background 0.2s; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); }
.input-wrap { flex: 1; min-height: 44px; background: rgba(20, 20, 20, 0.5); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 22px; padding: 2px 16px; display: flex; align-items: center; transition: border-color 0.2s; }
.input-wrap:focus-within { border-color: rgba(255, 255, 255, 0.3); background: rgba(20, 20, 20, 0.7); }
.omni-input { width: 100%; background: transparent; border: none; color: #fff; font-size: 16px; resize: none; padding: 11px 0; margin: 0; max-height: 100px; font-family: inherit; line-height: 20px; }
.omni-input::placeholder { color: rgba(255,255,255,0.5); }
.cam-trigger-btn { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; transition: 0.2s; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); }
.cam-trigger-btn.mode-send { background-color: rgba(255, 255, 255, 0.1); box-shadow: none; }
.icon-hidden { display: none !important; }
.omni-btn-icon { width: 24px; height: 24px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }

/* === UI CONTROLS & OVERLAYS === */
.ui-layer { position: absolute; inset: 0; z-index: 20; display: flex; flex-direction: column; justify-content: space-between; padding: calc(16px + env(safe-area-inset-top)) 16px calc(32px + env(safe-area-inset-bottom)) 16px; pointer-events: none; transition: opacity 0.3s ease; }
.ui-layer.idle { opacity: 0; pointer-events: none; }
.top-bar { display: flex; justify-content: space-between; align-items: center; pointer-events: auto; height: 48px; }
.btn-close { width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.4); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); }
.status-chip { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 8px 16px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 600; color: #fff !important; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
.status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--acc-orange); box-shadow: 0 0 8px var(--acc-orange); transition: 0.3s; }
.status-dot.ok { background: var(--acc-green); box-shadow: 0 0 8px var(--acc-green); }
.spacer { width: 40px; }
.controls-grid { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; pointer-events: auto; width: 100%; margin-bottom: 10px; }
.grid-cell-left { display: flex; justify-content: flex-start; } .grid-cell-center { display: flex; justify-content: center; } .grid-cell-right { display: flex; justify-content: flex-end; }
.action-btn { width: 40px; height: 40px; border-radius: 50%; background: rgba(30,30,30,0.6); backdrop-filter: blur(12px); display: flex; align-items: center; justify-content: center; color: #fff; border: 1px solid rgba(255,255,255,0.15); cursor: pointer; transition: transform 0.15s, background 0.2s; }
.action-btn:active { transform: scale(0.92); background: rgba(60,60,60,0.8); }
.action-btn.hidden { opacity: 0; pointer-events: none; } .action-btn.disabled { opacity: 0.5; pointer-events: none; }
.shutter-outer { width: 80px; height: 80px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.8); display:flex; align-items:center; justify-content:center; transition: 0.3s; background: transparent; }
.shutter-inner { width: 62px; height: 62px; border-radius: 50%; background: #fff; transition: 0.3s; cursor: pointer; }
.shutter-outer.disabled { border-color: rgba(255, 69, 58, 0.5); }
.shutter-outer.disabled .shutter-inner { background: var(--acc-red); transform: scale(0.4); opacity: 0.8; }
.shutter-outer.active { border-color: var(--acc-green); transform: scale(1.05); }
.shutter-outer:active:not(.disabled) .shutter-inner { transform: scale(0.9); }
.cam-toast { position: absolute; top: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: #fff; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 500; pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 50; backdrop-filter: blur(4px); }
.cam-toast.visible { opacity: 1; }

/* === –ú–û–î–ê–õ–ö–ò (Perms, Preview, Processing) === */
.perm-overlay { position: absolute; inset: 0; z-index: 100; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 32px; gap: 24px; }
.perm-btn { background: var(--acc-blue); color: #fff; border: none; padding: 14px 28px; border-radius: 14px; font-size: 16px; font-weight: 600; cursor: pointer; }
.preview-overlay { position: absolute; inset: 0; z-index: 200; background: #000; display: none; flex-direction: column; height: 100%; overflow: hidden; }
.preview-img { flex: 1; width: 100%; object-fit: contain; background: #111; margin-bottom: 12px; min-height: 0; }
.comment-wrap { flex-shrink: 0; padding: 0 24px 16px 24px; width: 100%; }
.comment-label { display: block; color: rgba(255,255,255,0.6); font-size: 13px; margin-bottom: 8px; margin-left: 4px; }
.comment-input { width: 100%; height: 80px; background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 12px 16px; color: #fff; font-size: 16px; font-family: var(--font-stack); resize: none; outline: none; transition: 0.2s; }
.comment-input:focus { background: rgba(255,255,255,0.18); border-color: var(--acc-blue); }
.preview-controls { flex-shrink: 0; padding: 0 24px 34px 24px; display: flex; gap: 16px; background: #000; }
.btn { flex: 1; padding: 14px; border-radius: 14px; font-weight: 600; font-size: 16px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.1); color: #fff; cursor: pointer; text-align: center; }
.btn.primary { background: var(--acc-blue); border-color: transparent; }

.processing-overlay { position: fixed; inset: 0; z-index: 1000; background: rgba(5, 5, 5, 0.6); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.4s ease; }
.processing-overlay.active { opacity: 1; pointer-events: auto; }
.proc-card { width: 90%; max-width: 320px; background: rgba(30, 30, 30, 0.6); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 30px 20px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
.proc-visual { position: relative; width: 60px; height: 60px; margin-bottom: 20px; }
.proc-orb { position: absolute; inset: 0; border-radius: 50%; background: radial-gradient(circle, #0a84ff 0%, transparent 70%); animation: pulse-ai 2s infinite; }
.proc-ring { position: absolute; inset: -10px; border-radius: 50%; border: 2px solid rgba(10, 132, 255, 0.3); border-top-color: #0a84ff; animation: spin-ai 1.5s infinite linear; }
@keyframes pulse-ai { 0% { opacity: 0.5; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.5; transform: scale(0.8); } }
@keyframes spin-ai { 100% { transform: rotate(360deg); } }
.proc-title { font-size: 17px; font-weight: 700; color: #fff; margin-bottom: 20px; letter-spacing: 0.5px; }
.proc-steps { width: 100%; display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
.step { display: flex; align-items: center; gap: 10px; opacity: 0.4; transition: 0.3s; transform: translateX(-10px); }
.step.active { opacity: 1; transform: translateX(0); font-weight: 600; } .step.done { opacity: 0.5; transform: translateX(0); color: var(--acc-green); }
.s-icon { font-size: 14px; width: 20px; text-align: center; } .s-lbl { font-size: 13px; color: #fff; }
.proc-close { margin-top: 10px; font-size: 13px; color: rgba(255,255,255,0.4); text-decoration: underline; cursor: pointer; }

/* === DRAFT SHEET === */
.draft-overlay { position: fixed; inset: 0; z-index: 1100; background: rgba(0,0,0,0.5); display: flex; flex-direction: column; justify-content: flex-end; opacity: 0; pointer-events: none; transition: 0.3s; }
.draft-overlay.visible { opacity: 1; pointer-events: auto; }
.draft-sheet { background: #1c1c1e; border-radius: 24px 24px 0 0; border-top: 1px solid rgba(255,255,255,0.15); padding: 24px 20px calc(20px + env(safe-area-inset-bottom)) 20px; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.1, 0.8, 0.2, 1); max-height: 80vh; overflow-y: auto; margin: 0 12px calc(12px + env(safe-area-inset-bottom)) 12px !important; border-radius: 24px !important; border: 1px solid rgba(255, 255, 255, 0.1) !important; padding-bottom: 20px !important; }
.draft-overlay.visible .draft-sheet { transform: translateY(0); }
.ds-header { margin-bottom: 20px; }
.ds-title { font-size: 22px; font-weight: 800; margin-bottom: 8px; color: #fff; letter-spacing: 0.3px; }
.ds-subtitle { font-size: 13px; color: rgba(255,255,255,0.6); line-height: 1.5; }
.draft-item { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.06); padding: 12px; border-radius: 16px; margin-bottom: 10px; }
.di-icon { font-size: 20px; } .di-inputs { flex: 1; display: flex; flex-direction: column; gap: 6px; }
.di-name { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; padding: 8px 12px; margin-bottom: 4px; color: #fff; font-size: 16px; font-weight: 600; width: 100%; transition: border-color 0.2s, background 0.2s; }
.di-name:focus { background: rgba(255,255,255,0.1); border-color: #0a84ff; }
.di-row { display: flex; align-items: center; gap: 8px; }
.di-weight { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #0a84ff; font-weight: 700; width: 60px; text-align: center; padding: 6px; font-size: 15px; -moz-appearance: textfield; }
.di-weight::-webkit-inner-spin-button { -webkit-appearance: none; }
.di-unit { font-size: 13px; color: var(--text-muted); }
.di-del { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; color: var(--acc-red); opacity: 0.7; cursor: pointer; }
.ds-actions { display: flex; gap: 12px; margin-top: 20px; }
.ds-btn { flex: 1; height: 48px; border-radius: 14px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; }
.ds-btn.sec { background: rgba(255,255,255,0.1); color: #fff; } .ds-btn.prim { background: var(--acc-blue); color: #fff; box-shadow: 0 4px 12px rgba(10,132,255,0.3); }

/* === CARD STYLES === */
.meal-card { background: rgba(28, 28, 30, 0.65); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 22px; padding: 14px; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); margin-bottom: 12px; animation: slideIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
.col-headers, .prod-item { display: grid; grid-template-columns: minmax(0, 1fr) 34px 30px 22px 22px 22px; gap: 5px; align-items: center; }
.col-headers { margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.08); }
.mh-time { text-align: left; font-weight: 700; color: #fff; font-size: 13px; }
.ch-item, .pi-name, .pi-val { font-size: 13px; font-weight: 400; color: #fff; font-feature-settings: "tnum"; white-space: nowrap; }
.pi-name { overflow: hidden; text-overflow: ellipsis; text-align: left; }
.ch-item, .pi-val { text-align: right; }
.ch-item { opacity: 0.6; font-size: 11px; text-transform: uppercase; font-weight: 600; }
@keyframes slideIn { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
.gh-icon { width: 24px; height: 24px; display: block; background-color: currentColor; -webkit-mask-position: center; mask-position: center; -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat; -webkit-mask-size: contain; mask-size: contain; }
</style>
</head>
<body>
  <div class="fx-layer" id="fxLayer">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="noise"></div>
  </div>

  <div class="app-layout" id="appLayout">
    <div class="fixed-header-group" id="headerGroup">
      <div class="calendar-block" id="calendarBlock">
        <div class="calendar-header"><div class="month-label" id="monthLabel">...</div></div>
        <div class="calendar-swipe-area" id="swipeArea">
          <div class="calendar-track" id="calTrack">
            <div class="calendar-week" id="weekPrev"></div>
            <div class="calendar-week" id="weekCurr"></div>
            <div class="calendar-week" id="weekNext"></div>
          </div>
        </div>
      </div>
      <div class="carousel-wrap">
        <div class="carousel-track" id="widgetTrack">
          <div class="widget">
            <div class="macros-grid">
              <div class="macro-item"><div class="donut-box"><svg class="mini-donut" viewBox="0 0 60 60"><circle class="md-bg" cx="30" cy="30" r="24"/><circle class="md-val stroke-kcal" cx="30" cy="30" r="24" style="stroke-dashoffset: 45px"/></svg><div class="m-icon">üî•</div></div><div class="m-data"><div class="m-nums">1450<span>/2100</span></div><div class="m-lbl">–ö–ö–ê–õ</div></div></div>
              <div class="macro-item"><div class="donut-box"><svg class="mini-donut" viewBox="0 0 60 60"><circle class="md-bg" cx="30" cy="30" r="24"/><circle class="md-val stroke-prot" cx="30" cy="30" r="24" style="stroke-dashoffset: 100px"/></svg><div class="m-icon">üêì</div></div><div class="m-data"><div class="m-nums">110<span>/160</span></div><div class="m-lbl">–ë–ï–õ–ö–ò</div></div></div>
              <div class="macro-item"><div class="donut-box"><svg class="mini-donut" viewBox="0 0 60 60"><circle class="md-bg" cx="30" cy="30" r="24"/><circle class="md-val stroke-fats" cx="30" cy="30" r="24" style="stroke-dashoffset: 110px"/></svg><div class="m-icon">ü•ë</div></div><div class="m-data"><div class="m-nums">45<span>/70</span></div><div class="m-lbl">–ñ–ò–†–´</div></div></div>
              <div class="macro-item"><div class="donut-box"><svg class="mini-donut" viewBox="0 0 60 60"><circle class="md-bg" cx="30" cy="30" r="24"/><circle class="md-val stroke-carb" cx="30" cy="30" r="24" style="stroke-dashoffset: 60px"/></svg><div class="m-icon">üåæ</div></div><div class="m-data"><div class="m-nums">180<span>/250</span></div><div class="m-lbl">–£–ì–õ–ò</div></div></div>
            </div>
          </div>
          <div class="widget water-widget" id="waterCard">
            <div class="water-header"><div class="water-title">–í–æ–¥–Ω—ã–π –±–∞–ª–∞–Ω—Å</div><div class="water-percent" id="lbl-pct">0%</div></div>
            <div class="water-cols">
              <div class="water-tube"><div class="water-fill" id="c1"></div></div>
              <div class="water-tube"><div class="water-fill" id="c2"></div></div>
              <div class="water-tube"><div class="water-fill" id="c3"></div></div>
              <div class="water-tube"><div class="water-fill" id="c4"></div></div>
              <div class="water-tube"><div class="water-fill" id="c5"></div></div>
            </div>
            <div class="water-footer">
              <div class="water-info"><div class="wf-row"><div class="wf-fact" id="lbl-fact">0</div><div class="wf-unit">–º–ª</div></div><div class="wf-plan">–¶–µ–ª—å: 2500</div></div>
              <div class="water-controls">
                <div class="water-btn" onclick="updateWater(-250)">‚àí</div>
                <div class="water-btn" onclick="updateWater(250)">+</div>
              </div>
            </div>
          </div>
        </div>
        <div class="dots"><div class="dot active"></div><div class="dot"></div></div>
      </div>
    </div>

    <div class="scroll-container" id="feedScroll">
       <div class="timeline-container" id="mealTimeline"></div>
    </div>

    <div class="cam-viewport">
      <video id="video" autoplay playsinline muted></video>
      <div id="loader" class="cam-loader hidden"><div class="spinner"></div></div>
      <svg width="0" height="0" style="position:absolute">
        <defs>
          <linearGradient id="grad-kcal"><stop offset="0%" stop-color="#ff9f0a"/><stop offset="100%" stop-color="#ff453a"/></linearGradient>
          <linearGradient id="grad-prot"><stop offset="0%" stop-color="#48bfe3"/><stop offset="100%" stop-color="#5e60ce"/></linearGradient>
          <linearGradient id="grad-fats"><stop offset="0%" stop-color="#f1c40f"/><stop offset="100%" stop-color="#e67e22"/></linearGradient>
          <linearGradient id="grad-carb"><stop offset="0%" stop-color="#2ecc71"/><stop offset="100%" stop-color="#1abc9c"/></linearGradient>
        </defs>
      </svg>
      <canvas id="uiCanvas"></canvas>
      <div id="camToast" class="cam-toast">Toast</div>
      <div class="ui-layer idle" id="camUI">
        <div class="top-bar">
          <div class="btn-close" id="btnClose"><div class="gh-icon" style="-webkit-mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/cross2.svg'); mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/cross2.svg');"></div></div>
          <div class="status-chip" id="lvlChip"><div class="status-dot" id="lvlDot"></div><span id="lvlText">–£—Ä–æ–≤–µ–Ω—å</span></div>
          <div class="spacer"></div>
        </div>
        <div class="controls-grid">
          <div class="grid-cell-left"><div class="action-btn" id="btnTorch"><div class="gh-icon" style="-webkit-mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/flash1.svg'); mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/flash1.svg');"></div></div></div>
          <div class="grid-cell-center"><div class="shutter-outer disabled" id="shutterBtn"><div class="shutter-inner"></div></div></div>
          <div class="grid-cell-right"><div class="action-btn hidden" id="btnSwitch"><div class="gh-icon" style="-webkit-mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/rotate.svg'); mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/rotate.svg');"></div></div></div>
        </div>
      </div>
    </div>
    
    <div class="omni-bar" id="omniBar">
        <div class="omni-icon-btn"><div class="gh-icon" style="-webkit-mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/add.svg'); mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/add.svg');"></div></div>
        <div class="input-wrap"><textarea class="omni-input" rows="1" placeholder="–Ø–±–ª–æ–∫–æ 200–≥, –∫–æ—Ñ–µ..."></textarea></div>
        <div class="cam-trigger-btn" id="btnStartCam">
          <div id="icoCam" class="gh-icon omni-btn-icon" style="-webkit-mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/cam.svg'); mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/cam.svg');"></div>
          <div id="icoSend" class="gh-icon omni-btn-icon icon-hidden" style="-webkit-mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/plane.svg'); mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/plane.svg'); margin-left: 2px;"></div>
        </div>
    </div>
  </div> 

  <div id="permReq" class="perm-overlay hidden">
    <div style="font-size:48px; margin-bottom:10px">üìê</div>
    <h2 style="margin:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∞</h2>
    <p style="color:var(--text-muted)">–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –¥–∞—Ç—á–∏–∫–∞–º.</p>
    <button class="perm-btn" onclick="requestSensors()">–†–∞–∑—Ä–µ—à–∏—Ç—å</button>
  </div>
  <div id="previewScreen" class="preview-overlay">
    <img id="finalPhoto" class="preview-img">
    <div class="comment-wrap">
      <label class="comment-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
      <textarea id="commentInput" class="comment-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Ä–∏—Å 200, —Ç—Ä–µ—Å–∫–∞ 150"></textarea>
    </div>
    <div class="preview-controls">
      <button class="btn" onclick="retake()">–ü–µ—Ä–µ—Å–Ω—è—Ç—å</button>
      <button class="btn primary" id="btnSend" onclick="sendPhoto()">–ì–æ—Ç–æ–≤–æ</button>
    </div>
  </div>
  <div class="processing-overlay" id="procOverlay">
    <div class="proc-card">
      <div class="proc-visual"><div class="proc-orb"></div><div class="proc-ring"></div></div>
      <div class="proc-title">–î—É–º–∞—é</div>
      <div class="proc-steps" id="procSteps"></div>
      <div class="proc-close" onclick="cancelProcessing()">–û—Ç–º–µ–Ω–∞</div>
    </div>
  </div>
  <div class="draft-overlay" id="draftOverlay">
    <div class="draft-sheet">
      <div class="ds-header"><div class="ds-title">–ü—Ä–æ–≤–µ—Ä–∫–∞</div><div class="ds-subtitle">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ</div></div>
      <div class="ds-list" id="draftList"></div>
      <div class="ds-actions">
        <button class="ds-btn sec" onclick="closeDraft()">–û—Ç–º–µ–Ω–∞</button>
        <button class="ds-btn prim" id="btnConfirmDraft" onclick="confirmDraftToNutritionist()">–í –¥–Ω–µ–≤–Ω–∏–∫</button>
      </div>
    </div>
  </div>

<script>
(function initTMA(){try{const t=window.Telegram?.WebApp;if(!t)return;t.ready();t.expand();try{t.setHeaderColor('#050505');if(t.setBackgroundColor)t.setBackgroundColor('#050505')}catch(e){}try{if(t.BackButton){t.BackButton.show();t.BackButton.offClick();t.BackButton.onClick(function(){window.location.href='router.html'})}}catch(e){}try{if(t.disableVerticalSwipes)t.disableVerticalSwipes()}catch(e){}}catch(e){}})();
function isAdmin(){try{return 196047220===Number(window.Telegram?.WebApp?.initDataUnsafe?.user?.id)}catch(_){return!1}}
(function initStableLayout(){const a=document.getElementById('appLayout'),f=document.getElementById('fxLayer');let h=window.innerHeight,w=window.innerWidth;if(f)f.style.height=`${h}px`;function r(){const v=window.visualViewport?window.visualViewport.height:window.innerHeight,cw=window.innerWidth,ch=window.innerHeight;if(a){a.style.height=`${v}px`;window.scrollTo(0,0)}if(Math.abs(cw-w)>50){h=ch;w=cw;if(f)f.style.height=`${h}px`}}if(window.visualViewport){window.visualViewport.addEventListener('resize',r);window.visualViewport.addEventListener('scroll',r)}window.addEventListener('resize',r);document.querySelectorAll('input,textarea').forEach(e=>{e.addEventListener('focus',()=>setTimeout(r,100));e.addEventListener('blur',()=>setTimeout(r,100))});r()})();
const API_URL="https://script.google.com/macros/s/AKfycbx0fUaaCH-JwnG5R_3TFgU5FSibsEuhuS0ZZZfyxPNVPQ1ZpCfUIaa5aE8vjgqitac/exec";
const tg=window.Telegram?.WebApp;if(tg){tg.ready();tg.expand();tg.setHeaderColor('#000000');if(tg.disableVerticalSwipes)tg.disableVerticalSwipes()}
const API={blobToBase64:b=>new Promise(r=>{const a=new FileReader;a.onloadend=()=>r(a.result);a.readAsDataURL(b)}),send:async(a,p)=>{const b={action:a,user:tg?.initDataUnsafe?.user||{id:0,first_name:'Test'},initData:tg?.initData||'',...p},r=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(b)}),j=await r.json();if(!j.ok)throw new Error(j.error||'Error');return j}};
const state={stream:null,track:null,levelOK:!1,angleX:0,angleY:0,photoBlob:null,isCapturing:!1,isSwitching:!1,devices:[],currentDevIdx:0,torchOn:!1,sensorActive:!1,uiMode:'menu'};
const DOM={video:document.getElementById('video'),canvas:document.getElementById('uiCanvas'),ctx:document.getElementById('uiCanvas').getContext('2d'),shutter:document.getElementById('shutterBtn'),lvlDot:document.getElementById('lvlDot'),lvlText:document.getElementById('lvlText'),permReq:document.getElementById('permReq'),preview:document.getElementById('previewScreen'),finalImg:document.getElementById('finalPhoto'),btnSend:document.getElementById('btnSend'),commentInput:document.getElementById('commentInput'),btnTorch:document.getElementById('btnTorch'),btnSwitch:document.getElementById('btnSwitch'),toast:document.getElementById('camToast'),loader:document.getElementById('loader'),omniBar:document.getElementById('omniBar'),camUI:document.getElementById('camUI'),omniInput:document.querySelector('.omni-input'),icoCam:document.getElementById('icoCam'),icoSend:document.getElementById('icoSend'),btnStartCam:document.getElementById('btnStartCam'),btnClose:document.getElementById('btnClose')};

DOM.omniInput.addEventListener('input',()=>{const h=DOM.omniInput.value.trim().length>0;DOM.omniInput.style.height='auto';DOM.omniInput.style.height=Math.min(DOM.omniInput.scrollHeight,80)+'px';if(h){DOM.btnStartCam.classList.add('mode-send');DOM.icoCam.classList.add('icon-hidden');DOM.icoSend.classList.remove('icon-hidden')}else{DOM.btnStartCam.classList.remove('mode-send');DOM.icoCam.classList.remove('icon-hidden');DOM.icoSend.classList.add('icon-hidden')}});
DOM.btnStartCam.onclick=async()=>{DOM.omniInput.blur();const t=DOM.omniInput.value.trim();if(t.length>0){await sendTextOnly(t)}else{state.uiMode='camera';document.getElementById('headerGroup').style.transform='translateY(-100%)';document.getElementById('feedScroll').style.opacity='0';document.getElementById('feedScroll').classList.add('hidden');DOM.omniBar.classList.add('hidden');DOM.camUI.classList.remove('idle');DOM.camUI.style.pointerEvents='auto';if(tg?.HapticFeedback)tg.HapticFeedback.impactOccurred('light');await initCamera()}};
async function sendTextOnly(t){const b=DOM.btnStartCam;b.style.opacity='0.5';haptic('medium');try{startProcessingUI('text');const r=await API.send('scan',{image:null,userText:t});stopProcessingUI();DOM.omniInput.value='';if(r.ok)openDraftSheet(r.data,r.scanId);else throw new Error(r.error)}catch(e){stopProcessingUI();alert(e.message)}finally{b.style.opacity='1'}}
DOM.btnClose.onclick=()=>{DOM.omniInput.blur();if(DOM.commentInput)DOM.commentInput.blur();window.scrollTo(0,0);state.uiMode='menu';DOM.camUI.classList.add('idle');DOM.camUI.style.pointerEvents='none';DOM.omniBar.classList.remove('hidden');document.getElementById('headerGroup').style.transform='translateY(0)';document.getElementById('feedScroll').style.opacity='1';document.getElementById('feedScroll').classList.remove('hidden');stopStream();setTimeout(()=>{const a=document.getElementById('appLayout');if(a){a.style.height=window.innerHeight+'px';window.scrollTo(0,0)}},100)};

let toastTimer;function showToast(m){DOM.toast.textContent=m;DOM.toast.classList.add('visible');clearTimeout(toastTimer);toastTimer=setTimeout(()=>{DOM.toast.classList.remove('visible')},2000)}
function stopStream(){if(state.stream){state.stream.getTracks().forEach(t=>t.stop());state.stream=null}state.track=null;state.torchOn=!1;updateTorchUI();DOM.video.srcObject=null;DOM.video.classList.remove('active')}
async function startStream(id){if(state.stream)stopStream();const c={audio:!1,video:{deviceId:id?{exact:id}:undefined,facingMode:id?undefined:'environment',width:{ideal:1920},height:{ideal:2560}}};try{const s=await navigator.mediaDevices.getUserMedia(c);state.stream=s;state.track=s.getVideoTracks()[0];DOM.video.srcObject=s;DOM.video.classList.add('active');const set=state.track.getSettings();if(set.deviceId)localStorage.setItem('ultima_cam_id',set.deviceId);let l=state.track.label||"Cam";if(state.devices.length>1)showToast(l);const cap=state.track.getCapabilities();if(cap.focusMode?.includes('continuous'))try{await state.track.applyConstraints({advanced:[{focusMode:'continuous'}]})}catch(e){}}catch(e){if(id){localStorage.removeItem('ultima_cam_id');await startStream(null)}else alert(e.message)}}
DOM.btnSwitch.onclick=async()=>{if(state.devices.length<2||state.isSwitching)return;state.isSwitching=!0;haptic('medium');DOM.loader.classList.remove('hidden');DOM.btnSwitch.classList.add('disabled');DOM.btnTorch.classList.add('disabled');DOM.shutter.classList.add('disabled');if(state.stream)state.stream.getTracks().forEach(t=>t.stop());await new Promise(r=>setTimeout(r,500));let n=state.currentDevIdx+1;if(n>=state.devices.length)n=0;state.currentDevIdx=n;await startStream(state.devices[n].deviceId);DOM.loader.classList.add('hidden');DOM.btnSwitch.classList.remove('disabled');DOM.btnTorch.classList.remove('disabled');DOM.shutter.classList.remove('disabled');state.isSwitching=!1};
DOM.btnTorch.onclick=async()=>{if(!state.track)return;const c=state.track.getCapabilities();if(!c.torch){showToast("–ù–µ—Ç –≤—Å–ø—ã—à–∫–∏");return}const n=!state.torchOn;try{await state.track.applyConstraints({advanced:[{torch:n}]});state.torchOn=n;updateTorchUI();haptic('light')}catch(e){}};
function updateTorchUI(){DOM.btnTorch.style.backgroundColor=state.torchOn?'var(--acc-orange)':'';DOM.btnTorch.style.color=state.torchOn?'#000':'#fff'}
function checkSensorPerms(){if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function')DOM.permReq.classList.remove('hidden');else window.addEventListener('deviceorientation',handleOrientation)}
async function requestSensors(){try{if(await DeviceOrientationEvent.requestPermission()==='granted')window.addEventListener('deviceorientation',handleOrientation)}catch(e){}DOM.permReq.classList.add('hidden')}
function handleOrientation(e){let x=e.beta,y=e.gamma;if(x===null||y===null)return;state.sensorActive=!0;state.angleX=x;state.angleY=y}
function updateUI(){if(state.uiMode==='menu'||state.isCapturing)return;if(!state.sensorActive){DOM.lvlDot.classList.remove('ok');DOM.lvlText.textContent="–ö–∞–º–µ—Ä–∞";DOM.shutter.classList.add('active');return}if(state.levelOK){DOM.lvlDot.classList.add('ok');DOM.lvlText.textContent="–†–æ–≤–Ω–æ";DOM.shutter.classList.add('active')}else{DOM.lvlDot.classList.remove('ok');DOM.lvlText.textContent="–í—ã—Ä–æ–≤–Ω—è–π—Ç–µ";DOM.shutter.classList.remove('active')}}
function resizeCanvas(){const w=window.innerWidth,h=window.innerHeight;if(DOM.canvas.width!==w)DOM.canvas.width=w;if(DOM.canvas.height!==h)DOM.canvas.height=h}
async function initCamera(){try{const i=localStorage.getItem('ultima_cam_id');await startStream(i);await updateDeviceList();resizeCanvas();window.addEventListener('resize',resizeCanvas);requestAnimationFrame(drawLoop);checkSensorPerms()}catch(e){}}
async function updateDeviceList(){try{const d=await navigator.mediaDevices.enumerateDevices();state.devices=d.filter(v=>v.kind==='videoinput');DOM.btnSwitch.classList.toggle('hidden',state.devices.length<2)}catch(e){}}
function drawLoop(){const ctx=DOM.ctx,w=DOM.canvas.width,h=DOM.canvas.height;ctx.clearRect(0,0,w,h);if(state.uiMode==='menu'){requestAnimationFrame(drawLoop);return}const cx=w/2,cy=h/2,cr=1.586,cw=w*0.22,ch=cw*cr,cx0=cx+80,cy0=cy-ch/2,r=8;ctx.beginPath();ctx.moveTo(cx0+r,cy0);ctx.lineTo(cx0+cw-r,cy0);ctx.quadraticCurveTo(cx0+cw,cy0,cx0+cw,cy0+r);ctx.lineTo(cx0+cw,cy0+ch-r);ctx.quadraticCurveTo(cx0+cw,cy0+ch,cx0+cw-r,cy0+ch);ctx.lineTo(cx0+r,cy0+ch);ctx.quadraticCurveTo(cx0,cy0+ch,cx0,cy0+ch-r);ctx.lineTo(cx0,cy0+r);ctx.quadraticCurveTo(cx0,cy0,cx0+r,cy0);ctx.fillStyle='rgba(255,255,255,0.2)';ctx.fill();ctx.save();ctx.translate(cx0+cw/2,cy0+ch/2);ctx.rotate(-Math.PI/2);ctx.fillStyle='#ffffff';ctx.textAlign='center';ctx.textBaseline='middle';ctx.font='bold 12px sans-serif';ctx.fillText("CREDIT CARD",0,-10);ctx.font='10px sans-serif';ctx.fillText("(–æ–ø—Ü–∏—è)",0,10);ctx.restore();if(state.sensorActive){const rb=14,rt=18,mo=60,rx=state.angleY||0,ry=state.angleX||0,cl=v=>Math.max(-20,Math.min(20,v)),dx=(cl(rx)/20)*mo,dy=(cl(ry)/20)*mo,dist=Math.hypot(dx,dy),inS=(dist+rb)<=rt;if(state.levelOK!==inS&&!state.isCapturing){state.levelOK=inS;updateUI();if(inS)haptic('medium')}ctx.shadowBlur=4;ctx.shadowColor='rgba(0,0,0,0.5)';ctx.beginPath();ctx.arc(cx,cy,rt,0,Math.PI*2);const c=(state.levelOK||state.isCapturing)?'#30d158':'rgba(255,255,255,0.85)';ctx.strokeStyle=c;ctx.lineWidth=3;ctx.stroke();ctx.beginPath();ctx.arc(cx+dx,cy+dy,rb,0,Math.PI*2);ctx.fillStyle=c;ctx.fill();ctx.shadowBlur=0}else{ctx.strokeStyle='rgba(255,255,255,0.5)';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(cx-10,cy);ctx.lineTo(cx+10,cy);ctx.stroke();ctx.beginPath();ctx.moveTo(cx,cy-10);ctx.lineTo(cx,cy+10);ctx.stroke()}requestAnimationFrame(drawLoop)}

DOM.shutter.addEventListener('click',async()=>{if(state.isCapturing||state.isSwitching)return;if(state.sensorActive&&!state.levelOK){haptic('error');showToast("–í—ã—Ä–æ–≤–Ω—è–π—Ç–µ");return}try{state.isCapturing=!0;haptic('heavy');DOM.shutter.style.transform='scale(0.8)';DOM.shutter.style.opacity='0.5';await new Promise(r=>setTimeout(r,50));const v=DOM.video;if(v.readyState<2)throw new Error("Wait");const MAX=1024;let w=v.videoWidth,h=v.videoHeight;if(w>h){if(w>MAX){h*=MAX/w;w=MAX}}else{if(h>MAX){w*=MAX/h;h=MAX}}const c=document.createElement('canvas');c.width=w;c.height=h;c.getContext('2d').drawImage(v,0,0,w,h);const b=await new Promise(r=>c.toBlob(r,'image/jpeg',0.7));if(!b)throw new Error("Empty");showPreview(b)}catch(e){haptic('error');state.isCapturing=!1;updateUI()}finally{DOM.shutter.style.transform='';DOM.shutter.style.opacity='';state.isCapturing=!1}});
function showPreview(b){state.photoBlob=b;DOM.finalImg.src=URL.createObjectURL(b);DOM.preview.style.display='flex'}
function retake(){DOM.preview.style.display='none';if(DOM.finalImg.src)URL.revokeObjectURL(DOM.finalImg.src);DOM.finalImg.src='';state.photoBlob=null;DOM.commentInput.value=''}
async function sendPhoto(){const b=DOM.btnSend;if(b.disabled)return;DOM.preview.style.display='none';haptic('heavy');try{if(!state.photoBlob)throw new Error("No photo");startProcessingUI('photo');const d=await API.blobToBase64(state.photoBlob),t=DOM.commentInput.value,r=await API.send('scan',{image:d,userText:t});stopProcessingUI();if(r.ok)openDraftSheet(r.data,r.scanId);else throw new Error(r.error)}catch(e){stopProcessingUI();haptic('error');alert(e.message);DOM.preview.style.display='flex';b.disabled=!1}}
function haptic(s){if(!tg||!tg.HapticFeedback)return;['error','success','warning'].includes(s)?tg.HapticFeedback.notificationOccurred(s):tg.HapticFeedback.impactOccurred(s)}
let procInterval;function startProcessingUI(m){const c=document.getElementById('procSteps'),o=document.getElementById('procOverlay');if(m==='text')c.innerHTML=`<div class="step pending" id="step-1"><div class="s-icon">üõ°Ô∏è</div><div class="s-lbl">Check...</div></div><div class="step pending" id="step-2"><div class="s-icon">üß†</div><div class="s-lbl">Search...</div></div><div class="step pending" id="step-3"><div class="s-icon">üìù</div><div class="s-lbl">Synth...</div></div>`;else c.innerHTML=`<div class="step pending" id="step-1"><div class="s-icon">üõ°Ô∏è</div><div class="s-lbl">Check...</div></div><div class="step pending" id="step-2"><div class="s-icon">üïµÔ∏è</div><div class="s-lbl">Detect...</div></div><div class="step pending" id="step-3"><div class="s-icon">üìê</div><div class="s-lbl">Calc...</div></div><div class="step pending" id="step-4"><div class="s-icon">üç≥</div><div class="s-lbl">Analyze...</div></div><div class="step pending" id="step-5"><div class="s-icon">üìù</div><div class="s-lbl">Synth...</div></div>`;o.classList.add('active');let s=1,max=m==='text'?3:5;updateStep(1,'active');procInterval=setInterval(()=>{updateStep(s,'done');s++;if(s>max)s=max;updateStep(s,'active')},2000)}
function updateStep(n,s){const e=document.getElementById('step-'+n);if(e){e.classList.remove('pending','active','done');e.classList.add(s)}}
function stopProcessingUI(){clearInterval(procInterval);document.getElementById('procOverlay').classList.remove('active')}
function cancelProcessing(){stopProcessingUI();retake()}
let currentDraftItems=[],currentScanId=null;function openDraftSheet(d,id){currentScanId=id;if(!d||!d.items){alert("Empty");return}currentDraftItems=d.items;renderDraftList();document.getElementById('draftOverlay').classList.add('visible');haptic('success')}
function renderDraftList(){const c=document.getElementById('draftList');c.innerHTML='';if(currentDraftItems.length===0){c.innerHTML='Empty';return}currentDraftItems.forEach((i,x)=>{let ic="üçΩÔ∏è";const d=document.createElement('div');d.className='draft-item';d.innerHTML=`<div class="di-icon">${ic}</div><div class="di-inputs"><input type="text" class="di-name" value="${i.name}" onchange="updateDraftItem(${x},'name',this.value)"><div class="di-row"><input type="number" class="di-weight" value="${i.weight_g||''}" placeholder="0" onchange="updateDraftItem(${x},'weight_g',this.value)"><div class="di-unit">–≥</div></div></div><div class="di-del" onclick="removeDraftItem(${x})">‚úï</div>`;c.appendChild(d)})}
window.updateDraftItem=(i,f,v)=>{if(f==='weight_g')v=parseInt(v)||0;currentDraftItems[i][f]=v};window.removeDraftItem=i=>{currentDraftItems.splice(i,1);renderDraftList()};window.closeDraft=()=>{document.getElementById('draftOverlay').classList.remove('visible');retake()};
const STORAGE_KEY='ultima_diary_v1';window.confirmDraftToNutritionist=async()=>{const b=document.getElementById('btnConfirmDraft');b.textContent='Save...';b.disabled=!0;try{const c=currentDraftItems.map(i=>{const k=Math.round(i.weight_g*1.2);return{name:i.name,w:i.weight_g,k:k,p:Math.round(i.weight_g*0.15),f:Math.round(i.weight_g*0.02),c:Math.round(i.weight_g*0.10)}}),n=new Date(),e={id:Date.now(),time:n.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),items:c};saveToStorage(e);haptic('success');document.getElementById('draftOverlay').classList.remove('visible');addMealToTimeline(e);retake()}catch(e){alert(e.message)}finally{b.textContent='–í –¥–Ω–µ–≤–Ω–∏–∫';b.disabled=!1}};
function addMealToTimeline(e){const c=document.getElementById('mealTimeline');if(!c)return;let r='';e.items.forEach(i=>{r+=`<div class="prod-item"><div class="pi-name">${i.name}</div><div class="pi-val pi-w">${i.w}</div><div class="pi-val pi-k">${i.k}</div><div class="pi-val pi-p">${i.p}</div><div class="pi-val pi-f">${i.f}</div><div class="pi-val pi-c">${i.c}</div></div>`});const h=`<div class="meal-card" id="card-${e.id}"><div class="col-headers"><div class="mh-time">${e.time}</div><div class="ch-item">–í–µ—Å</div><div class="ch-item">–ö</div><div class="ch-item">–ë</div><div class="ch-item">–ñ</div><div class="ch-item">–£</div></div>${r}</div>`;c.insertAdjacentHTML('afterbegin',h)}
function saveToStorage(e){try{const r=localStorage.getItem(STORAGE_KEY),h=r?JSON.parse(r):[];h.push(e);localStorage.setItem(STORAGE_KEY,JSON.stringify(h))}catch(e){}}
function loadFromStorage(){try{const r=localStorage.getItem(STORAGE_KEY);if(!r)return;JSON.parse(r).forEach(m=>addMealToTimeline(m))}catch(e){}}loadFromStorage();
let cw=getStartOfWeek(new Date()),sd=new Date(),idr=!1,sx=0,ctr=0;const area=document.getElementById('swipeArea'),track=document.getElementById('calTrack'),pre=document.getElementById('weekPrev'),cur=document.getElementById('weekCurr'),nex=document.getElementById('weekNext');function getStartOfWeek(d){const x=new Date(d),y=x.getDay(),z=x.getDate()-y+(y===0?-6:1);return new Date(x.setDate(z))}function initCalendar(){renderAllWeeks();area.onpointerdown=hs;area.onpointermove=hm;area.onpointerup=he;area.onpointercancel=he;area.onpointerleave=he}function renderWeekData(c,s){c.innerHTML='';const w=['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'],t=new Date();for(let i=0;i<7;i++){const d=new Date(s);d.setDate(d.getDate()+i);const it=d.toDateString()===t.toDateString(),is=d.toDateString()===sd.toDateString(),e=document.createElement('div');e.className=`day-cell ${is?'selected':''} ${it?'is-today':''}`;e.innerHTML=`<div class="dc-name">${w[i]}</div><div class="dc-num">${d.getDate()}</div>`;e.onclick=()=>{if(Math.abs(ctr)>5)return;document.querySelectorAll('.day-cell').forEach(x=>x.classList.remove('selected'));e.classList.add('selected');sd=new Date(d);if(window.haptic)window.haptic('selection');renderAllWeeks()};c.appendChild(e)}}function renderAllWeeks(){renderWeekData(cur,cw);const p=new Date(cw);p.setDate(p.getDate()-7);renderWeekData(pre,p);const n=new Date(cw);n.setDate(n.getDate()+7);renderWeekData(nex,n);const m=new Date(cw);m.setDate(m.getDate()+3);document.getElementById('monthLabel').textContent=m.toLocaleString('ru',{month:'long',year:'numeric'})}function hs(e){if(e.button!==0)return;idr=!0;sx=e.clientX;ctr=0;track.style.transition='none';area.style.cursor='grabbing'}function hm(e){if(!idr)return;ctr=e.clientX-sx;track.style.transform=`translateX(calc(-33.333333% + ${ctr}px))`}function he(e){if(!idr)return;idr=!1;area.style.cursor='grab';track.style.transition='transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)';if(ctr>60){track.style.transform=`translateX(0%)`;setTimeout(()=>sh(-1),300)}else if(ctr<-60){track.style.transform=`translateX(-66.666666%)`;setTimeout(()=>sh(1),300)}else{track.style.transform=`translateX(-33.333333%)`}}function sh(d){cw.setDate(cw.getDate()+(d*7));track.style.transition='none';renderAllWeeks();track.style.transform=`translateX(-33.333333%)`}initCalendar();
let cMl=1250,tMl=2500;window.updateWater=d=>{if(window.haptic)window.haptic('light');cMl=Math.max(0,cMl+d);rW()};function rW(){document.getElementById('lbl-fact').innerText=cMl;document.getElementById('lbl-pct').innerText=Math.round((cMl/tMl)*100)+'%';const c=document.getElementById('waterCard');if(cMl>tMl)c.classList.add('is-overload');else c.classList.remove('is-overload');for(let i=1;i<=5;i++){const e=document.getElementById('c'+i),th=i*(tMl/5),p=(i-1)*(tMl/5);let v=0;if(cMl>=th)v=100;else if(cMl>p)v=((cMl-p)/(tMl/5))*100;e.style.setProperty('--h',Math.min(100,v)+'%')}}const wt=document.getElementById('widgetTrack'),ds=document.querySelectorAll('.dot');if(wt)wt.addEventListener('scroll',()=>{const i=Math.round(wt.scrollLeft/wt.clientWidth);ds.forEach((d,x)=>d.classList.toggle('active',x===i))});rW();
document.addEventListener('click',e=>{const a=document.activeElement,isI=a&&(a.tagName==='INPUT'||a.tagName==='TEXTAREA');if(isI&&e.target!==a)a.blur()});
</script>
</body>
</html>