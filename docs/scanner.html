<!DOCTYPE html>
<html lang="ru">
<head>
<script src="version-control.js?t=1"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
<title>Ultima AI Diary</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  /* =========================================
     1. CORE STYLES (FROM SCANNER.HTML)
     ========================================= */
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
  *::-webkit-scrollbar { display: none; width: 0; height: 0; background: transparent; }
  
  :root {
    --bg-core: #050505;
    --text-main: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.55);
    --surface-glass: rgba(255, 255, 255, 0.07);
    --surface-border: rgba(255, 255, 255, 0.1);
    
    --acc-green: #30d158;
    --acc-blue: #0a84ff;
    --acc-orange: #ff9f0a;
    --acc-red: #ff453a;
    --acc-over: #00f2ea;
    --acc-over-glow: rgba(0, 242, 234, 0.6);
    
    --radius-xl: 28px;
    --radius-l: 22px;
    
    --safe-top: calc(12px + env(safe-area-inset-top));
    --safe-bottom: calc(12px + env(safe-area-inset-bottom));
    --header-height: 340px; 
  }

  body {
    background-color: var(--bg-core);
    margin: 0; padding: 0; width: 100%; height: 100vh;
    overflow: hidden; 
    color: var(--text-main);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Roboto', sans-serif;
    position: fixed; inset: 0;
  }

  /* FX BACKGROUND */
  .fx-layer { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
  .orb { position: absolute; border-radius: 50%; will-change: transform; animation: float 30s infinite linear; }
  .orb-1 { width: 90vw; height: 90vw; opacity: 0.4; background: radial-gradient(circle, rgba(108, 92, 231, 0.8) 0%, transparent 70%); top: -20%; left: -20%; }
  .orb-2 { width: 400px; height: 400px; opacity: 0.5; background: radial-gradient(circle, rgba(10, 132, 255, 0.6) 0%, transparent 70%); bottom: -150px; right: -100px; animation: breathe 6s infinite ease-in-out; }
  .noise { position: fixed; inset: 0; opacity: 0.04; background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); }
  @keyframes float { 0% {transform:rotate(0deg)} 100% {transform:rotate(360deg)} }
  @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.4; } 50% { transform: scale(1.1); opacity: 0.6; } }

  /* =========================================
     2. DASHBOARD LAYER (Z-INDEX 1)
     ========================================= */
  .app-layout {
    position: absolute; inset: 0; z-index: 1;
    display: flex; flex-direction: column;
    transition: transform 0.4s cubic-bezier(0.1, 0.9, 0.2, 1), opacity 0.4s;
    background: transparent;
  }
  /* –≠—Ñ—Ñ–µ–∫—Ç "—É—Ö–æ–¥–∞ –Ω–∞ –∑–∞–¥–Ω–∏–π –ø–ª–∞–Ω" –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–∞–º–µ—Ä—ã */
  .app-layout.pushed { transform: scale(0.92); opacity: 0; pointer-events: none; }

  /* HEADER GROUP (Calendar + Widgets) */
  .fixed-header-group {
    position: relative; z-index: 10;
    background: linear-gradient(180deg, rgba(5,5,5,0.95) 0%, rgba(5,5,5,0.85) 70%, rgba(5,5,5,0) 100%);
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  }

  /* CALENDAR */
  .calendar-block { padding-top: var(--safe-top); padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
  .calendar-header { display: flex; justify-content: space-between; padding: 0 16px 8px 16px; }
  .month-label { font-size: 11px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; }
  .calendar-swipe-area { width: 100%; height: 52px; overflow: hidden; position: relative; touch-action: pan-y; }
  .calendar-track { display: flex; width: 300%; height: 100%; transform: translateX(-33.333333%); will-change: transform; }
  .calendar-week { flex: 1; display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; padding: 0 10px; }
  .day-cell { display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; transition: 0.2s; position: relative; }
  .day-cell.selected { background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05)); border: 1px solid rgba(255,255,255,0.2); }
  .dc-name { font-size: 9px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
  .dc-num { font-size: 17px; font-weight: 600; color: #fff; }
  .day-cell.selected .dc-num { font-weight: 700; }

  /* WIDGETS CAROUSEL */
  .carousel-track { display: flex; gap: 12px; padding: 20px 16px 30px 16px; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; }
  .widget { flex: 0 0 calc(100% - 16px); scroll-snap-align: center; height: 160px; border-radius: var(--radius-xl); background: var(--surface-glass); border: 1px solid var(--surface-border); backdrop-filter: blur(20px); position: relative; padding: 16px; overflow: hidden; }
  
  /* MACROS WIDGET */
  .macros-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; height: 100%; align-items: center; }
  .macro-item { display: flex; flex-direction: column; align-items: center; }
  .donut-box { width: 100%; max-width: 74px; aspect-ratio: 1; position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; }
  .mini-donut { width: 100%; height: 100%; transform: rotate(-90deg); }
  .md-bg { fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 7; }
  .md-val { fill: none; stroke-width: 7; stroke-linecap: round; stroke-dasharray: 151; transition: stroke-dashoffset 1s ease; }
  .m-icon { position: absolute; font-size: 20px; }
  .m-data { text-align: center; }
  .m-nums { font-size: 13px; font-weight: 800; color: #fff; }
  .m-nums span { color: rgba(255,255,255,0.45); font-size: 11px; }
  .m-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; color: rgba(255,255,255,0.5); }
  .stroke-kcal { stroke: #ff9f0a; } .stroke-prot { stroke: #0a84ff; } .stroke-fats { stroke: #ffcc00; } .stroke-carb { stroke: #30d158; }

  /* WATER WIDGET */
  .widget.water-widget { display: flex; flex-direction: column; justify-content: space-between; }
  .water-header { display: flex; justify-content: space-between; }
  .water-title { font-size: 11px; font-weight: 800; text-transform: uppercase; color: var(--text-muted); }
  .water-cols { display: flex; gap: 6px; height: 50px; align-items: flex-end; }
  .water-tube { flex: 1; height: 100%; background: rgba(0,0,0,0.4); border-radius: 6px; position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
  .water-fill { position: absolute; bottom: 0; left: 0; right: 0; background: var(--acc-blue); transition: height 0.3s; }
  .water-footer { display: flex; justify-content: space-between; align-items: flex-end; }
  .wf-fact { font-size: 28px; font-weight: 800; line-height: 1; }
  .water-controls { display: flex; gap: 12px; }
  .water-btn { width: 44px; height: 44px; background: rgba(255,255,255,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }

  /* TIMELINE */
  .scroll-container { flex: 1; overflow-y: auto; padding: 0 16px 120px 16px; -webkit-overflow-scrolling: touch; }
  .timeline { display: flex; flex-direction: column; gap: 12px; }
  .meal-card { background: var(--surface-glass); border: 1px solid var(--surface-border); border-radius: var(--radius-l); padding: 14px; animation: slideIn 0.4s ease; }
  .col-headers, .prod-item { display: grid; grid-template-columns: minmax(0, 1fr) 34px 30px 22px 22px 22px; gap: 5px; align-items: center; }
  .col-headers { margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.08); }
  .mh-time, .pi-name, .pi-val { font-size: 13px; color: #fff; font-feature-settings: "tnum"; }
  .pi-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .pi-val { text-align: right; }

  /* =========================================
     3. CAMERA LAYER (Z-INDEX 100)
     ========================================= */
  .camera-layer {
    position: fixed; inset: 0; z-index: 100;
    background: #000;
    transform: translateY(100%);
    transition: transform 0.4s cubic-bezier(0.1, 0.9, 0.2, 1);
    display: flex; flex-direction: column;
  }
  .camera-layer.active { transform: translateY(0); }

  .cam-viewport { position: relative; flex: 1; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #000; }
  video { position: absolute; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.3s; }
  video.active { opacity: 1; }
  #uiCanvas { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

  /* CAM UI OVERLAYS */
  .cam-ui-layer { position: absolute; inset: 0; z-index: 20; padding: calc(16px + env(safe-area-inset-top)) 16px 100px 16px; display: flex; flex-direction: column; justify-content: space-between; pointer-events: none; }
  .cam-ui-layer.active { pointer-events: auto; }
  
  .top-bar { display: flex; justify-content: space-between; align-items: center; }
  .btn-close { width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.4); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); }
  
  .controls-grid { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; width: 100%; }
  .shutter-outer { width: 80px; height: 80px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; cursor: pointer; pointer-events: auto; transition: 0.2s; }
  .shutter-inner { width: 62px; height: 62px; border-radius: 50%; background: #fff; transition: 0.2s; }
  .shutter-outer:active .shutter-inner { transform: scale(0.9); }
  .shutter-outer.disabled { border-color: var(--acc-red); opacity: 0.5; }

  /* =========================================
     4. OMNI BAR (Z-INDEX 50)
     ========================================= */
  .omni-bar { 
    position: fixed; bottom: 0; left: 0; right: 0; 
    background: rgba(10, 10, 10, 0.85); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
    border-top: 1px solid var(--surface-border); 
    padding: 8px 12px var(--safe-bottom) 12px; 
    z-index: 50; 
    display: flex; align-items: flex-end; gap: 10px; 
    transition: transform 0.3s;
  }
  .omni-bar.hidden { transform: translateY(100%); }

  .omni-icon-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; }
  .input-wrap { flex: 1; min-height: 42px; background: rgba(255,255,255,0.1); border-radius: 20px; padding: 2px 16px; display: flex; align-items: center; }
  .omni-input { width: 100%; background: transparent; border: none; color: #fff; font-size: 16px; resize: none; padding: 10px 0; margin: 0; max-height: 80px; font-family: inherit; }
  .omni-input::placeholder { color: rgba(255,255,255,0.4); }
  
  .cam-trigger-btn { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; transition: 0.2s; }
  .cam-trigger-btn.mode-send { background-color: var(--acc-blue); box-shadow: 0 0 15px rgba(10, 132, 255, 0.4); }
  .omni-btn-icon { width: 24px; height: 24px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
  .icon-hidden { display: none !important; }
  #icoSend { margin-right: 2px; margin-top: 2px; }

  /* =========================================
     5. OVERLAYS (Z-INDEX 1000+)
     ========================================= */
  .processing-overlay { position: fixed; inset: 0; z-index: 1000; background: rgba(5, 5, 5, 0.6); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.4s ease; }
  .processing-overlay.active { opacity: 1; pointer-events: auto; }
  .proc-card { width: 90%; max-width: 320px; background: rgba(30, 30, 30, 0.6); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 30px 20px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
  .proc-visual { position: relative; width: 60px; height: 60px; margin-bottom: 20px; }
  .proc-orb { position: absolute; inset: 0; border-radius: 50%; background: radial-gradient(circle, #0a84ff 0%, transparent 70%); animation: pulse-ai 2s infinite; }
  .proc-ring { position: absolute; inset: -10px; border-radius: 50%; border: 2px solid rgba(10, 132, 255, 0.3); border-top-color: #0a84ff; animation: spin-ai 1.5s infinite linear; }
  .proc-steps { width: 100%; display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
  .step { display: flex; align-items: center; gap: 10px; opacity: 0.4; transition: 0.3s; transform: translateX(-10px); }
  .step.active { opacity: 1; transform: translateX(0); font-weight: 600; }
  .step.done { opacity: 0.5; transform: translateX(0); color: var(--acc-green); }
  .s-icon { font-size: 14px; width: 20px; text-align: center; }
  .s-lbl { font-size: 13px; color: #fff; }
  .proc-close { margin-top: 10px; font-size: 13px; color: rgba(255,255,255,0.4); text-decoration: underline; cursor: pointer; }

  @keyframes pulse-ai { 0% { opacity: 0.5; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.5; transform: scale(0.8); } }
  @keyframes spin-ai { 100% { transform: rotate(360deg); } }
  @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

  .draft-overlay { position: fixed; inset: 0; z-index: 1100; background: rgba(0,0,0,0.5); display: flex; flex-direction: column; justify-content: flex-end; opacity: 0; pointer-events: none; transition: 0.3s; }
  .draft-overlay.visible { opacity: 1; pointer-events: auto; }
  .draft-sheet { background: #1c1c1e; border-radius: 24px 24px 0 0; border-top: 1px solid rgba(255,255,255,0.15); padding: 24px 20px calc(20px + env(safe-area-inset-bottom)) 20px; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.1, 0.8, 0.2, 1); max-height: 80vh; overflow-y: auto; }
  .draft-overlay.visible .draft-sheet { transform: translateY(0); }
  .draft-item { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.06); padding: 12px; border-radius: 16px; margin-bottom: 10px; }
  .di-icon { font-size: 20px; }
  .di-inputs { flex: 1; display: flex; flex-direction: column; gap: 6px; }
  .di-name { background: transparent; border: none; color: #fff; font-size: 15px; font-weight: 600; width: 100%; padding: 0; margin: 0; font-family: inherit; }
  .di-row { display: flex; align-items: center; gap: 8px; }
  .di-weight { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--acc-blue); font-weight: 700; width: 60px; text-align: center; padding: 6px; font-size: 15px; -moz-appearance: textfield; }
  .di-weight::-webkit-inner-spin-button { -webkit-appearance: none; }
  .di-unit { font-size: 13px; color: var(--text-muted); }
  .di-del { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; color: var(--acc-red); opacity: 0.7; cursor: pointer; }
  .ds-actions { display: flex; gap: 12px; margin-top: 20px; }
  .ds-btn { flex: 1; height: 48px; border-radius: 14px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; }
  .ds-btn.sec { background: rgba(255,255,255,0.1); color: #fff; }
  .ds-btn.prim { background: var(--acc-blue); color: #fff; box-shadow: 0 4px 12px rgba(10,132,255,0.3); }

  .hidden { display: none !important; }
</style>
</head>
<body>

  <div class="fx-layer">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="noise"></div>
  </div>

  <div class="app-layout" id="appLayout">
    <div class="fixed-header-group">
      <div class="calendar-block">
        <div class="calendar-header"><div class="month-label" id="monthLabel">...</div></div>
        <div class="calendar-swipe-area" id="swipeArea">
          <div class="calendar-track" id="calTrack">
            <div class="calendar-week" id="weekPrev"></div>
            <div class="calendar-week" id="weekCurr"></div>
            <div class="calendar-week" id="weekNext"></div>
          </div>
        </div>
      </div>
      <div class="carousel-track" id="track">
        <div class="widget">
           <div class="macros-grid">
            <div class="macro-item"><div class="donut-box"><svg class="mini-donut" viewBox="0 0 60 60"><circle class="md-bg" cx="30" cy="30" r="24"/><circle class="md-val stroke-kcal" cx="30" cy="30" r="24" style="stroke-dashoffset: 45px"/></svg><div class="m-icon">üî•</div></div><div class="m-data"><div class="m-nums" id="wid-kcal">1450</div><div class="m-lbl">–ö–ö–ê–õ</div></div></div>
            <div class="macro-item"><div class="donut-box"><svg class="mini-donut" viewBox="0 0 60 60"><circle class="md-bg" cx="30" cy="30" r="24"/><circle class="md-val stroke-prot" cx="30" cy="30" r="24" style="stroke-dashoffset: 100px"/></svg><div class="m-icon">üêì</div></div><div class="m-data"><div class="m-nums" id="wid-prot">110</div><div class="m-lbl">–ë–ï–õ–ö–ò</div></div></div>
            <div class="macro-item"><div class="donut-box"><svg class="mini-donut" viewBox="0 0 60 60"><circle class="md-bg" cx="30" cy="30" r="24"/><circle class="md-val stroke-fats" cx="30" cy="30" r="24" style="stroke-dashoffset: 110px"/></svg><div class="m-icon">ü•ë</div></div><div class="m-data"><div class="m-nums" id="wid-fat">45</div><div class="m-lbl">–ñ–ò–†–´</div></div></div>
            <div class="macro-item"><div class="donut-box"><svg class="mini-donut" viewBox="0 0 60 60"><circle class="md-bg" cx="30" cy="30" r="24"/><circle class="md-val stroke-carb" cx="30" cy="30" r="24" style="stroke-dashoffset: 60px"/></svg><div class="m-icon">üåæ</div></div><div class="m-data"><div class="m-nums" id="wid-carb">180</div><div class="m-lbl">–£–ì–õ–ò</div></div></div>
          </div>
        </div>
        <div class="widget water-widget" id="waterCard">
          <div class="water-header"><div class="water-title">–í–æ–¥–Ω—ã–π –±–∞–ª–∞–Ω—Å</div><div class="water-percent" id="lbl-pct">0%</div></div>
          <div class="water-cols"><div class="water-tube"><div class="water-fill" id="c1"></div></div><div class="water-tube"><div class="water-fill" id="c2"></div></div><div class="water-tube"><div class="water-fill" id="c3"></div></div><div class="water-tube"><div class="water-fill" id="c4"></div></div><div class="water-tube"><div class="water-fill" id="c5"></div></div></div>
          <div class="water-footer"><div class="water-info"><div class="wf-row"><div class="wf-fact" id="lbl-fact">0</div><div class="wf-unit">–º–ª</div></div><div class="wf-plan">–¶–µ–ª—å: 2500</div></div><div class="water-controls"><div class="water-btn" onclick="updateWater(-250)">‚àí</div><div class="water-btn" onclick="updateWater(250)">+</div></div></div>
        </div>
      </div>
    </div>

    <div class="scroll-container" id="scrollContainer">
      <div class="timeline" id="timeline">
        <div class="meal-card">
          <div class="col-headers"><div class="mh-time">09:00</div><div class="pi-val">–í–µ—Å</div><div class="pi-val">–ö</div><div class="pi-val">–ë</div><div class="pi-val">–ñ</div><div class="pi-val">–£</div></div>
          <div class="prod-item"><div class="pi-name">–û–≤—Å—è–Ω–∞—è –∫–∞—à–∞</div><div class="pi-val">250</div><div class="pi-val">220</div><div class="pi-val">8</div><div class="pi-val">6</div><div class="pi-val">32</div></div>
          <div class="prod-item"><div class="pi-name">–ö–æ—Ñ–µ —Å –º–æ–ª–æ–∫–æ–º</div><div class="pi-val">250</div><div class="pi-val">125</div><div class="pi-val">3</div><div class="pi-val">3</div><div class="pi-val">5</div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="camera-layer" id="cameraLayer">
    <div class="cam-viewport">
      <video id="video" autoplay playsinline muted></video>
      <div id="loader" class="cam-loader hidden"><div class="spinner"></div></div>
      <canvas id="uiCanvas"></canvas>
      
      <div class="cam-ui-layer active" id="camControls">
        <div class="top-bar">
          <div class="btn-close" id="btnCloseCam">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
          </div>
          <div style="background:rgba(0,0,0,0.4); border-radius:20px; padding:6px 12px; backdrop-filter:blur(10px); font-size:13px; font-weight:600; display:flex; gap:6px; align-items:center;">
             <div id="lvlDot" style="width:8px; height:8px; background:#ff9f0a; border-radius:50%; box-shadow:0 0 8px #ff9f0a"></div>
             <span id="lvlText">–£—Ä–æ–≤–µ–Ω—å</span>
          </div>
          <div style="width:40px"></div>
        </div>
        
        <div class="controls-grid">
           <div></div>
           <div class="shutter-outer disabled" id="shutterBtn"><div class="shutter-inner"></div></div>
           <div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="omni-bar" id="omniBar">
    <div class="omni-icon-btn">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
    </div>
    <div class="input-wrap">
      <textarea class="omni-input" id="omniInput" rows="1" placeholder="–Ø–±–ª–æ–∫–æ 200–≥, –∫–æ—Ñ–µ..."></textarea>
    </div>
    <div class="cam-trigger-btn" id="btnAction">
      <svg id="icoCam" class="omni-btn-icon" viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
      <svg id="icoSend" class="omni-btn-icon icon-hidden" viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
    </div>
  </div>

  <div class="processing-overlay" id="procOverlay">
    <div class="proc-card">
      <div class="proc-visual"><div class="proc-orb"></div><div class="proc-ring"></div></div>
      <div class="proc-title">–ê–Ω–∞–ª–∏–∑ —Å–Ω–∏–º–∫–∞</div>
      <div class="proc-steps" id="procSteps"></div>
      <div class="proc-close" onclick="cancelProcessing()">–û—Ç–º–µ–Ω–∞</div>
    </div>
  </div>

  <div class="draft-overlay" id="draftOverlay">
    <div class="draft-sheet">
      <div class="ds-header"><div class="ds-title">–ü—Ä–æ–≤–µ—Ä—å –¥–∞–Ω–Ω—ã–µ</div><div class="ds-subtitle">AI –æ–ø—Ä–µ–¥–µ–ª–∏–ª —Å–æ—Å—Ç–∞–≤. –ò—Å–ø—Ä–∞–≤—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.</div></div>
      <div class="ds-list" id="draftList"></div>
      <div class="ds-actions">
        <button class="ds-btn sec" onclick="closeDraft()">–û—Ç–º–µ–Ω–∞</button>
        <button class="ds-btn prim" id="btnConfirmDraft" onclick="confirmDraftToNutritionist()">–í –¥–Ω–µ–≤–Ω–∏–∫</button>
      </div>
    </div>
  </div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbx0fUaaCH-JwnG5R_3TFgU5FSibsEuhuS0ZZZfyxPNVPQ1ZpCfUIaa5aE8vjgqitac/exec"; 

  // === INIT ===
  const tg = window.Telegram?.WebApp;
  if(tg) { tg.ready(); tg.expand(); tg.setHeaderColor('#050505'); tg.disableVerticalSwipes(); }
  function haptic(style) { if(tg?.HapticFeedback) tg.HapticFeedback.impactOccurred(style); }

  // === API HELPER ===
  const API = {
    blobToBase64: (blob) => new Promise(r => { const rd = new FileReader(); rd.onloadend = () => r(rd.result); rd.readAsDataURL(blob); }),
    send: async (action, payload) => {
      const user = tg?.initDataUnsafe?.user || { id: 0 };
      const res = await fetch(API_URL, { method: "POST", headers: { "Content-Type": "text/plain" }, body: JSON.stringify({ action, user, ...payload }) });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error);
      return json;
    }
  };

  // === GLOBAL STATE ===
  const state = {
    stream: null, track: null, levelOK: false, angleX: 0, angleY: 0,
    photoBlob: null, isCapturing: false, sensorActive: false,
    cameraActive: false
  };

  const DOM = {
    app: document.getElementById('appLayout'),
    camLayer: document.getElementById('cameraLayer'),
    video: document.getElementById('video'),
    canvas: document.getElementById('uiCanvas'),
    ctx: document.getElementById('uiCanvas').getContext('2d'),
    shutter: document.getElementById('shutterBtn'),
    lvlDot: document.getElementById('lvlDot'),
    lvlText: document.getElementById('lvlText'),
    input: document.getElementById('omniInput'),
    btnAction: document.getElementById('btnAction'),
    icoCam: document.getElementById('icoCam'),
    icoSend: document.getElementById('icoSend'),
    omniBar: document.getElementById('omniBar')
  };

  // === 1. OMNI BAR LOGIC (ROUTER) ===
  DOM.input.addEventListener('input', () => {
    DOM.input.style.height = 'auto'; 
    DOM.input.style.height = Math.min(DOM.input.scrollHeight, 80) + 'px';
    const hasText = DOM.input.value.trim().length > 0;
    if(hasText) {
      DOM.btnAction.classList.add('mode-send');
      DOM.icoCam.classList.add('icon-hidden');
      DOM.icoSend.classList.remove('icon-hidden');
    } else {
      DOM.btnAction.classList.remove('mode-send');
      DOM.icoCam.classList.remove('icon-hidden');
      DOM.icoSend.classList.add('icon-hidden');
    }
  });

  DOM.btnAction.onclick = async () => {
    const text = DOM.input.value.trim();
    if(text.length > 0) {
      // TEXT MODE
      await processText(text);
    } else {
      // CAMERA MODE
      if (!state.cameraActive) openCamera();
      else capturePhoto(); 
    }
  };

  // === 2. CAMERA LOGIC (Slide Up) ===
  async function openCamera() {
    state.cameraActive = true;
    haptic('light');
    // Hide Omni Bar from Dashboard view
    DOM.omniBar.classList.add('hidden');
    DOM.camLayer.classList.add('active');
    DOM.app.classList.add('pushed'); // Visual depth effect
    
    await startStream();
    window.addEventListener('deviceorientation', handleOrientation);
    requestAnimationFrame(drawLoop);
  }

  function closeCamera() {
    state.cameraActive = false;
    DOM.camLayer.classList.remove('active');
    DOM.app.classList.remove('pushed');
    DOM.omniBar.classList.remove('hidden');
    stopStream();
    window.removeEventListener('deviceorientation', handleOrientation);
  }

  document.getElementById('btnCloseCam').onclick = closeCamera;

  async function startStream() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 2560 } } });
      state.stream = stream; 
      DOM.video.srcObject = stream; DOM.video.classList.add('active');
      resizeCanvas();
    } catch(e) { alert("Cam Error: " + e.message); }
  }

  function stopStream() {
    if(state.stream) state.stream.getTracks().forEach(t=>t.stop());
    DOM.video.srcObject = null; DOM.video.classList.remove('active');
  }

  // === 3. SENSORS & DRAWING ===
  function handleOrientation(e) {
    if (e.beta === null) return;
    state.sensorActive = true; state.angleX = e.beta; state.angleY = e.gamma;
  }
  function resizeCanvas() { DOM.canvas.width = window.innerWidth; DOM.canvas.height = window.innerHeight; }
  
  function drawLoop() {
    if(!state.cameraActive) return;
    const ctx = DOM.ctx; const w = DOM.canvas.width; const h = DOM.canvas.height;
    ctx.clearRect(0,0,w,h);
    
    // Level Logic
    const cx = w/2; const cy = h/2;
    if(state.sensorActive) {
       const rawX = state.angleY || 0; const rawY = state.angleX || 0;
       const dx = (Math.max(-20, Math.min(20, rawX))/20)*60;
       const dy = (Math.max(-20, Math.min(20, rawY))/20)*60;
       const isInside = Math.hypot(dx,dy) < 5; // Strict 5px tolerance
       
       if(state.levelOK !== isInside) { 
         state.levelOK = isInside; 
         if(isInside) { haptic('medium'); DOM.lvlDot.style.background='#30d158'; DOM.lvlText.innerText='–†–æ–≤–Ω–æ'; DOM.shutter.classList.remove('disabled'); }
         else { DOM.lvlDot.style.background='#ff9f0a'; DOM.lvlText.innerText='–í—ã—Ä–æ–≤–Ω—è–π—Ç–µ'; DOM.shutter.classList.add('disabled'); }
       }
       
       // Draw Bubble
       ctx.shadowBlur = 4; ctx.shadowColor = 'rgba(0,0,0,0.5)';
       ctx.beginPath(); ctx.arc(cx, cy, 18, 0, Math.PI*2);
       ctx.strokeStyle = isInside ? '#30d158' : 'rgba(255,255,255,0.5)'; ctx.lineWidth=3; ctx.stroke();
       ctx.beginPath(); ctx.arc(cx+dx, cy+dy, 14, 0, Math.PI*2);
       ctx.fillStyle = isInside ? '#30d158' : 'rgba(255,255,255,0.8)'; ctx.fill();
    }
    requestAnimationFrame(drawLoop);
  }

  // === 4. CAPTURE & PROCESS ===
  DOM.shutter.onclick = async () => {
    if(state.sensorActive && !state.levelOK) { haptic('error'); return; }
    haptic('heavy');
    
    // Capture Frame
    const cvs = document.createElement('canvas');
    cvs.width = DOM.video.videoWidth; cvs.height = DOM.video.videoHeight;
    cvs.getContext('2d').drawImage(DOM.video, 0, 0);
    
    // Immediate Feedback: Close Cam, Show Loading
    closeCamera();
    const blob = await new Promise(r => cvs.toBlob(r, 'image/jpeg', 0.7));
    processPhoto(blob);
  };

  async function processText(text) {
    DOM.btnAction.style.opacity = 0.5;
    haptic('medium');
    startProcessingUI('text');
    try {
      const res = await API.send('scan', { image: null, userText: text });
      stopProcessingUI();
      DOM.input.value = '';
      if(res.ok) openDraftSheet(res.data, res.scanId);
      else throw new Error(res.error);
    } catch(e) { stopProcessingUI(); alert(e.message); }
    finally { DOM.btnAction.style.opacity = 1; }
  }

  async function processPhoto(blob) {
    startProcessingUI('photo');
    try {
      const base64 = await API.blobToBase64(blob);
      const res = await API.send('scan', { image: base64 });
      stopProcessingUI();
      if(res.ok) openDraftSheet(res.data, res.scanId);
      else throw new Error(res.error);
    } catch(e) { stopProcessingUI(); alert(e.message); }
  }

  // === 5. UI FLOW (OVERLAYS) ===
  let procInt;
  function startProcessingUI(mode) {
    const steps = document.getElementById('procSteps');
    if(mode === 'text') {
       steps.innerHTML = `<div class="step active" id="s1">Gatekeeper</div><div class="step" id="s2">TextParser</div><div class="step" id="s3">Synthesizer</div>`;
    } else {
       steps.innerHTML = `<div class="step active" id="s1">Gatekeeper</div><div class="step" id="s2">Detective</div><div class="step" id="s3">Physicist</div><div class="step" id="s4">Synthesizer</div>`;
    }
    document.getElementById('procOverlay').classList.add('active');
    let i = 1;
    procInt = setInterval(() => {
       const curr = document.getElementById('s'+i);
       if(curr) { curr.classList.remove('active'); curr.classList.add('done'); }
       i++;
       const next = document.getElementById('s'+i);
       if(next) next.classList.add('active');
    }, 1500);
  }
  function stopProcessingUI() { clearInterval(procInt); document.getElementById('procOverlay').classList.remove('active'); }

  let currentDraft = []; let currentScanId = null;
  function openDraftSheet(data, scanId) {
    currentDraft = data.items || []; currentScanId = scanId;
    const list = document.getElementById('draftList');
    list.innerHTML = '';
    currentDraft.forEach((item, idx) => {
       list.innerHTML += `
         <div class="draft-item">
           <div class="di-inputs">
             <input class="di-name" value="${item.name}" onchange="currentDraft[${idx}].name=this.value">
             <div class="di-row"><input type="number" class="di-weight" value="${item.weight_g}" onchange="currentDraft[${idx}].weight_g=this.value"> –≥</div>
           </div>
         </div>`;
    });
    document.getElementById('draftOverlay').classList.add('visible');
  }
  
  function closeDraft() { document.getElementById('draftOverlay').classList.remove('visible'); }

  window.confirmDraftToNutritionist = async () => {
    document.getElementById('btnConfirmDraft').textContent = '–°–æ—Ö—Ä–∞–Ω—è—é...';
    try {
      const res = await API.send('calculate', { data: currentDraft, scanId: currentScanId });
      closeDraft();
      addMealToTimeline(res.data); // Render final card
      haptic('success');
    } catch(e) { alert(e.message); }
    finally { document.getElementById('btnConfirmDraft').textContent = '–í –¥–Ω–µ–≤–Ω–∏–∫'; }
  };

  // === 6. TIMELINE RENDERER (Final Step) ===
  function addMealToTimeline(data) {
    const tl = document.getElementById('timeline');
    const now = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    
    // Calculate total macros for this meal
    let tk=0, tp=0, tf=0, tc=0;
    let itemsHtml = '';
    
    data.items.forEach(i => {
       tk += i.macros.k; tp += i.macros.p; tf += i.macros.f; tc += i.macros.c;
       itemsHtml += `<div class="prod-item"><div class="pi-name">${i.name}</div><div class="pi-val">${i.weight_g}</div><div class="pi-val">${i.macros.k}</div><div class="pi-val">${i.macros.p}</div><div class="pi-val">${i.macros.f}</div><div class="pi-val">${i.macros.c}</div></div>`;
    });

    // Update Daily Widgets (Simple Add)
    document.getElementById('wid-kcal').innerText = parseInt(document.getElementById('wid-kcal').innerText) + tk;
    document.getElementById('wid-prot').innerText = parseInt(document.getElementById('wid-prot').innerText) + tp;
    document.getElementById('wid-fat').innerText = parseInt(document.getElementById('wid-fat').innerText) + tf;
    document.getElementById('wid-carb').innerText = parseInt(document.getElementById('wid-carb').innerText) + tc;

    const card = document.createElement('div');
    card.className = 'meal-card';
    card.innerHTML = `
      <div class="col-headers"><div class="mh-time">${now}</div><div class="pi-val">–í–µ—Å</div><div class="pi-val">–ö</div><div class="pi-val">–ë</div><div class="pi-val">–ñ</div><div class="pi-val">–£</div></div>
      ${itemsHtml}
    `;
    tl.prepend(card);
  }

  // === 7. CALENDAR & WATER LOGIC (FROM SCANNER) ===
  let currentMl = 1250; const targetMl = 2500; 
  function updateWater(delta) { haptic('light'); currentMl = Math.max(0, currentMl + delta); renderWater(); }
  function renderWater() {
    document.getElementById('lbl-fact').innerText = currentMl; document.getElementById('lbl-pct').innerText = Math.round((currentMl/targetMl)*100) + '%';
    const card = document.getElementById('waterCard'); if(currentMl > targetMl) card.classList.add('is-overload'); else card.classList.remove('is-overload');
    for(let i=1; i<=5; i++) { const el = document.getElementById('c'+i); const th = i*(targetMl/5); const prevTh = (i-1)*(targetMl/5); let pct = 0; if(currentMl >= th) pct=100; else if(currentMl > prevTh) pct = ((currentMl-prevTh)/(targetMl/5))*100; el.style.setProperty('--h', Math.min(100, pct)+'%'); }
  }

  (function initCal(){
     const days = ['–ü–ù','–í–¢','–°–†','–ß–¢','–ü–¢','–°–ë','–í–°'];
     const t = document.getElementById('weekCurr');
     const d = new Date(); d.setDate(d.getDate() - d.getDay() + 1); // Monday
     for(let i=0; i<7; i++) {
        t.innerHTML += `<div class="day-cell ${i===new Date().getDay()-1?'selected':''}"><div class="dc-name">${days[i]}</div><div class="dc-num">${d.getDate()}</div></div>`;
        d.setDate(d.getDate()+1);
     }
     document.getElementById('monthLabel').innerText = new Date().toLocaleString('ru', {month:'long'});
     renderWater();
  })();

</script>
</body>
</html>