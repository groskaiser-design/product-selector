<!DOCTYPE html>
<html lang="ru">
<head>
<script src="version-control.js?t=1"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
<title>Ultima FoodCam</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
 :root {
  --bg-core: #050505;
  --orb-purple: rgba(108, 92, 231, 0.8);
  --acc-blue: #0a84ff;
  --surface-glass: rgba(28, 28, 30, 0.65);
  --acc-green: #30d158;
  --acc-red: #ff453a;
  --acc-orange: #ff9f0a;
  --text-main: #ffffff;
  --text-muted: rgba(255, 255, 255, 0.55);
  --font-stack: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Roboto', sans-serif;
  --safe-bottom: calc(12px + env(safe-area-inset-bottom));
}

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

/* === 1. –ì–õ–ê–í–ù–´–ô –§–ò–ö–°: BODY –°–¢–û–ò–¢ –ù–ê–ú–ï–†–¢–í–û === */
html, body {
  background-color: #000000;
  margin: 0; padding: 0; 
  width: 100%; 
  height: 100%; /* iOS –ª—é–±–∏—Ç 100% –±–æ–ª—å—à–µ —á–µ–º 100vh —Ç—É—Ç */
  overflow: hidden; 
  position: fixed; /* –ì–≤–æ–∑–¥—å –ø—Ä–æ–≥—Ä–∞–º–º—ã –¥–ª—è iOS */
  top: 0; left: 0;
  overscroll-behavior: none;
  touch-action: none; 
  font-family: var(--font-stack);
}

/* === 2. –§–û–ù (–û–¢–î–ï–õ–¨–ù–´–ô –°–õ–û–ô, –ù–ï –°–ñ–ò–ú–ê–ï–¢–°–Ø) === */
.fx-layer { 
  position: fixed; 
  top: 0; left: 0; 
  width: 100vw; 
  height: 100vh; /* –§–æ–Ω –≤—Å–µ–≥–¥–∞ –ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω */
  z-index: 0; 
  pointer-events: none; 
  background-color: var(--bg-core);
}

.orb { position: absolute; border-radius: 50%; will-change: transform; filter: blur(80px); }

/* –í–µ—Ä—Ö–Ω—è—è —Å—Ñ–µ—Ä–∞ */
.orb-1 { 
  width: 100vw; height: 100vw; opacity: 0.8; 
  background: radial-gradient(circle, var(--orb-purple) 0%, transparent 70%); 
  top: -20%; left: -10%; animation: float 30s infinite linear; 
}

/* –ù–∏–∂–Ω—è—è —Å—Ñ–µ—Ä–∞ */
.orb-2 { 
  width: 300px; height: 300px; opacity: 0.4; 
  background: radial-gradient(circle, var(--acc-blue) 0%, transparent 70%); 
  bottom: -50px; right: -50px; animation: breathe 8s infinite ease-in-out; 
}

/* –®—É–º */
.noise { 
  position: fixed; inset: 0; opacity: 0.05; 
  background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); 
  pointer-events: none; 
}

@keyframes float { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.3; } 50% { transform: scale(1.2); opacity: 0.5; } }


/* === 3. –ò–ù–¢–ï–†–§–ï–ô–° (–ú–ï–ù–Ø–ï–¢ –†–ê–ó–ú–ï–† –ü–û–î –ö–õ–ê–í–£) === */
.app-layout {
  position: absolute; 
  z-index: 1; 
  top: 0; left: 0; right: 0;
  /* height –±—É–¥–µ—Ç –∑–∞–¥–∞–Ω —á–µ—Ä–µ–∑ JS (VisualViewport) */
  overflow: hidden;
  display: flex; 
  flex-direction: column;
}

/* === –ö–ê–õ–ï–ù–î–ê–†–¨ === */
/* –ú—ã –≤—ã–Ω–µ—Å–ª–∏ –µ–≥–æ –∏–∑ –ø–æ—Ç–æ–∫–∞ (absolute) —á—Ç–æ–±—ã –æ–Ω –ª–µ–∂–∞–ª –ø–æ–≤–µ—Ä—Ö –≤–∏–¥–µ–æ */
.calendar-block {
  flex: 0 0 auto;
  position: absolute; 
  top: 0; left: 0; right: 0;
  z-index: 50;
  background: transparent;
  padding-top: calc(12px + env(safe-area-inset-top));
  padding-bottom: 8px;
  user-select: none;
  transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
}
.calendar-header { display: flex; align-items: center; justify-content: space-between; padding: 0 16px 8px 16px; }
.month-label { font-size: 11px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.9; }
.calendar-swipe-area { width: 100%; height: 52px; overflow: hidden; position: relative; touch-action: pan-y; cursor: grab; }
.calendar-track { display: flex; width: 300%; height: 100%; transform: translateX(-33.333333%); will-change: transform; }
.calendar-week { flex: 1; display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; height: 100%; padding: 0 10px; }
.day-cell { height: 52px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; background: transparent; transition: background 0.2s, transform 0.1s; position: relative; cursor: pointer; user-select: none; }
.day-cell:active { transform: scale(0.92); }
.dc-name { font-size: 9px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 3px; }
.dc-num { font-size: 17px; font-weight: 600; color: var(--text-main); font-variant-numeric: tabular-nums; font-feature-settings: "tnum"; }
.day-cell.selected { background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05)); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 4px 12px rgba(0,0,0,0.2); transform: scale(1); }
.day-cell.selected .dc-name { color: #fff; opacity: 0.8; }
.day-cell.selected .dc-num { color: #fff; font-weight: 700; }
.day-cell.is-today::after { content: ''; position: absolute; bottom: 5px; width: 4px; height: 4px; border-radius: 50%; background: #0a84ff; box-shadow: 0 0 6px #0a84ff; }


/* === –ö–ê–ú–ï–†–ê === */
.cam-viewport {
  position: absolute; /* –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
  top: 0; left: 0; 
  width: 100%; height: 100%;
  z-index: 0; 
  margin: 0; padding: 0;
  display: flex;
}

#video {
  width: 100%; height: 100%;
  object-fit: cover !important; /* –ì–∞—Ä–∞–Ω—Ç–∏—è –æ—Ç —Å–ø–ª—é—â–∏–≤–∞–Ω–∏—è */
  position: absolute; inset: 0;
}

.cam-loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 5; display: flex; align-items: center; justify-content: center; pointer-events: none; }
.spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

#uiCanvas { position: absolute; inset: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }

/* === –í–ò–î–ñ–ï–¢–´ === */




.carousel-track { display: flex; gap: 12px; padding: 30px 16px 40px 16px; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; cursor: grab; }
.carousel-track::-webkit-scrollbar { display: none; }
.widget { flex: 0 0 calc(100% - 16px); scroll-snap-align: center; height: 160px; border-radius: 28px; background: rgba(20, 20, 20, 0.75); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); position: relative; overflow: hidden; padding: 16px 12px; transition: 0.3s ease; }

/* –ú–∞–∫—Ä–æ—Å—ã –∏ –≤–æ–¥–∞ */
.macros-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; height: 100%; align-items: center; }
.macro-item { display: flex; flex-direction: column; align-items: center; justify-content: center; }
.donut-box { width: 100%; max-width: 74px; aspect-ratio: 1; position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; }
.mini-donut { width: 100%; height: 100%; transform: rotate(-90deg); filter: drop-shadow(0 4px 8px rgba(0,0,0,0.25)); }
.md-bg { fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 7; }
.md-val { fill: none; stroke-width: 7; stroke-linecap: round; stroke-dasharray: 151; transition: stroke-dashoffset 1s ease; }
.m-icon { position: absolute; font-size: 20px; }
.m-data { display: flex; flex-direction: column; align-items: center; }
.m-nums { font-size: 13px; font-weight: 800; color: #fff; font-variant-numeric: tabular-nums; }
.m-nums span { color: rgba(255,255,255,0.45); font-size: 11px; margin-left: 1px; }
.m-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; color: rgba(255,255,255,0.5); margin-top: 2px; }
.stroke-kcal { stroke: url(#grad-kcal); } .stroke-prot { stroke: url(#grad-prot); } .stroke-fats { stroke: url(#grad-fats); } .stroke-carb { stroke: url(#grad-carb); }

.widget.water-widget { display: flex; flex-direction: column; padding: 16px 20px; justify-content: space-between; }
.water-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.water-title { font-size: 11px; font-weight: 800; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-muted); opacity: 0.8; }
.water-percent { font-size: 12px; font-weight: 700; color: var(--acc-blue); transition: color 0.3s; }
.widget.is-overload .water-percent { color: #00f2ea; text-shadow: 0 0 8px rgba(0, 242, 234, 0.6); }
.water-cols { display: flex; justify-content: space-between; align-items: flex-end; height: 50px; gap: 6px; margin: 8px 0; }
.water-tube { flex: 1; height: 100%; background: rgba(0,0,0,0.4); border-radius: 6px; border: 1px solid rgba(255,255,255,0.06); position: relative; overflow: hidden; }
.water-fill { position: absolute; bottom: 0; left: 0; right: 0; height: var(--h, 0%); background: var(--acc-blue); transition: height 0.3s cubic-bezier(0.25, 1, 0.5, 1), background-color 0.3s; box-shadow: 0 0 12px rgba(10, 132, 255, 0.5); }
.water-fill::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: rgba(255,255,255,0.6); opacity: 0.8; }
.widget.is-overload .water-fill { background: #00f2ea; box-shadow: 0 0 15px rgba(0, 242, 234, 0.6); }
.water-footer { display: flex; justify-content: space-between; align-items: flex-end; }
.water-info { display: flex; flex-direction: column; gap: 2px; }
.wf-row { display: flex; align-items: baseline; gap: 4px; }
.wf-fact { font-size: 28px; font-weight: 800; color: #fff; line-height: 1; letter-spacing: -0.5px; }
.wf-unit { font-size: 12px; font-weight: 600; color: var(--text-muted); }
.wf-plan { font-size: 11px; font-weight: 500; color: var(--text-muted); opacity: 0.7; }
.water-controls { display: flex; gap: 24px; }
.water-btn { width: 54px; height: 44px; border-radius: 14px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); color: #fff; font-size: 22px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
.water-btn:active { background: var(--acc-blue); transform: scale(0.92); }
.dots { display: flex; justify-content: center; gap: 6px; margin-top: 0px; pointer-events: none; transform: translateY(-20px); }
.dot { width: 6px; height: 6px; border-radius: 10px; background: rgba(255,255,255,0.2); transition: 0.3s; }
.dot.active { width: 20px; background: #fff; }

/* === UI –ö–ê–ú–ï–†–´ === */
.ui-layer { position: absolute; inset: 0; z-index: 20; display: flex; flex-direction: column; justify-content: space-between; padding: calc(16px + env(safe-area-inset-top)) 16px calc(32px + env(safe-area-inset-bottom)) 16px; pointer-events: none; transition: opacity 0.3s ease; }
.ui-layer.idle { opacity: 0; pointer-events: none; }
.top-bar { display: flex; justify-content: space-between; align-items: center; pointer-events: auto; height: 48px; }
.btn-close { width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.4); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); }
.status-chip { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 8px 16px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 600; color: #fff !important; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
.status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--acc-orange); box-shadow: 0 0 8px var(--acc-orange); transition: 0.3s; }
.status-dot.ok { background: var(--acc-green); box-shadow: 0 0 8px var(--acc-green); }
.spacer { width: 40px; }
.controls-grid { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; pointer-events: auto; width: 100%; margin-bottom: 10px; }
.grid-cell-left { display: flex; justify-content: flex-start; } .grid-cell-center { display: flex; justify-content: center; } .grid-cell-right { display: flex; justify-content: flex-end; }
.action-btn { width: 40px; height: 40px; border-radius: 50%; background: rgba(30,30,30,0.6); backdrop-filter: blur(12px); display: flex; align-items: center; justify-content: center; color: #fff; border: 1px solid rgba(255,255,255,0.15); cursor: pointer; transition: transform 0.15s, background 0.2s; }
.action-btn:active { transform: scale(0.92); background: rgba(60,60,60,0.8); }
.action-btn.hidden { opacity: 0; pointer-events: none; } .action-btn.disabled { opacity: 0.5; pointer-events: none; }
.shutter-outer { width: 80px; height: 80px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.8); display:flex; align-items:center; justify-content:center; transition: 0.3s; background: transparent; }
.shutter-inner { width: 62px; height: 62px; border-radius: 50%; background: #fff; transition: 0.3s; cursor: pointer; }
.shutter-outer.disabled { border-color: rgba(255, 69, 58, 0.5); }
.shutter-outer.disabled .shutter-inner { background: var(--acc-red); transform: scale(0.4); opacity: 0.8; }
.shutter-outer.active { border-color: var(--acc-green); transform: scale(1.05); }
.shutter-outer:active:not(.disabled) .shutter-inner { transform: scale(0.9); }
.cam-toast { position: absolute; top: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: #fff; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 500; pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 50; backdrop-filter: blur(4px); }
.cam-toast.visible { opacity: 1; }

/* === OMNI BAR (–í–ê–ñ–ù–û: ABSOLUTE –í–ù–£–¢–†–ò APP-LAYOUT) === */
.omni-bar { 
  position: absolute; 
  bottom: 0; left: 0; right: 0; 
  
  /* –õ–µ–≥–∫–∏–π –≥—Ä–∞–¥–∏–µ–Ω—Ç: –≤–Ω–∏–∑—É —á—É—Ç—å —Ç–µ–º–Ω–µ–µ, —Å–≤–µ—Ä—Ö—É –ø–æ–ª–Ω–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å */
  background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 60%, transparent 100%);
  
  border-top: none; 
  padding: 10px 12px calc(10px + env(safe-area-inset-bottom)) 12px; 
  z-index: 100; 
  display: flex; align-items: flex-end; gap: 10px; 
  transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
  
  /* –£–±–∏—Ä–∞–µ–º pointer-events –Ω–∞ —Å–∞–º–æ–π –ø–æ–ª–æ—Å–µ, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Å–∫—Ä–æ–ª–ª–∏—Ç—å —Å–∫–≤–æ–∑—å –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –º–µ—Å—Ç–∞ */
  pointer-events: none; 
}
/* –ù–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–ª–∏–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏ –∏ –∏–Ω–ø—É—Ç –≤–Ω—É—Ç—Ä–∏ –±–∞—Ä–∞ */
.omni-icon-btn, .input-wrap, .cam-trigger-btn {
  pointer-events: auto;
}

.omni-bar.hidden { transform: translateY(100%); }
.omni-icon-btn { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; border-radius: 50%; transition: background 0.2s; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); }
.omni-icon-btn:active { background: rgba(255,255,255,0.2); }
.input-wrap { flex: 1; min-height: 44px; background: rgba(20, 20, 20, 0.5); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 22px; padding: 2px 16px; display: flex; align-items: center; transition: border-color 0.2s; }
.input-wrap:focus-within { border-color: rgba(255, 255, 255, 0.3); background: rgba(20, 20, 20, 0.7); }
.omni-input { width: 100%; background: transparent; border: none; color: #fff; font-size: 16px; resize: none; padding: 11px 0; margin: 0; max-height: 100px; font-family: inherit; line-height: 20px; }
.omni-input::placeholder { color: rgba(255,255,255,0.5); }
.cam-trigger-btn { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; transition: 0.2s; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); }
.cam-trigger-btn:active { transform: scale(0.92); opacity: 0.8; }
.cam-trigger-btn.mode-send { background-color: rgba(255, 255, 255, 0.1); box-shadow: none; }
.icon-hidden { display: none !important; }
.omni-btn-icon { width: 24px; height: 24px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
#icoSend { margin-right: 2px; margin-top: 2px; }

/* === OVERLAYS === */
.perm-overlay { position: absolute; inset: 0; z-index: 100; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 32px; gap: 24px; }
.perm-btn { background: var(--acc-blue); color: #fff; border: none; padding: 14px 28px; border-radius: 14px; font-size: 16px; font-weight: 600; cursor: pointer; }
.preview-overlay { position: absolute; inset: 0; z-index: 200; background: #000; display: none; flex-direction: column; height: 100%; overflow: hidden; }
.preview-img { flex: 1; width: 100%; object-fit: contain; background: #111; margin-bottom: 12px; min-height: 0; }
.comment-wrap { flex-shrink: 0; padding: 0 24px 16px 24px; width: 100%; }
.comment-label { display: block; color: rgba(255,255,255,0.6); font-size: 13px; margin-bottom: 8px; margin-left: 4px; }
.comment-input { width: 100%; height: 80px; background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 12px 16px; color: #fff; font-size: 16px; font-family: var(--font-stack); resize: none; outline: none; transition: 0.2s; }
.comment-input:focus { background: rgba(255,255,255,0.18); border-color: var(--acc-blue); }
.preview-controls { flex-shrink: 0; padding: 0 24px 34px 24px; display: flex; gap: 16px; background: #000; }
.btn { flex: 1; padding: 14px; border-radius: 14px; font-weight: 600; font-size: 16px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.1); color: #fff; cursor: pointer; text-align: center; }
.btn.primary { background: var(--acc-blue); border-color: transparent; }
.hidden { display: none !important; }

/* PROCESSING & DRAFT */
.processing-overlay { position: fixed; inset: 0; z-index: 1000; background: rgba(5, 5, 5, 0.6); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.4s ease; }
.processing-overlay.active { opacity: 1; pointer-events: auto; }
.proc-card { width: 90%; max-width: 320px; background: rgba(30, 30, 30, 0.6); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 30px 20px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
.proc-visual { position: relative; width: 60px; height: 60px; margin-bottom: 20px; }
.proc-orb { position: absolute; inset: 0; border-radius: 50%; background: radial-gradient(circle, #0a84ff 0%, transparent 70%); animation: pulse-ai 2s infinite; }
.proc-ring { position: absolute; inset: -10px; border-radius: 50%; border: 2px solid rgba(10, 132, 255, 0.3); border-top-color: #0a84ff; animation: spin-ai 1.5s infinite linear; }
@keyframes pulse-ai { 0% { opacity: 0.5; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.5; transform: scale(0.8); } }
@keyframes spin-ai { 100% { transform: rotate(360deg); } }
.proc-title { font-size: 17px; font-weight: 700; color: #fff; margin-bottom: 20px; letter-spacing: 0.5px; }
.proc-steps { width: 100%; display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
.step { display: flex; align-items: center; gap: 10px; opacity: 0.4; transition: 0.3s; transform: translateX(-10px); }
.step.active { opacity: 1; transform: translateX(0); font-weight: 600; } .step.done { opacity: 0.5; transform: translateX(0); color: var(--acc-green); }
.s-icon { font-size: 14px; width: 20px; text-align: center; } .s-lbl { font-size: 13px; color: #fff; }
.proc-close { margin-top: 10px; font-size: 13px; color: rgba(255,255,255,0.4); text-decoration: underline; cursor: pointer; }
.draft-overlay { position: fixed; inset: 0; z-index: 1100; background: rgba(0,0,0,0.5); display: flex; flex-direction: column; justify-content: flex-end; opacity: 0; pointer-events: none; transition: 0.3s; }
.draft-overlay.visible { opacity: 1; pointer-events: auto; }
.draft-sheet { background: #1c1c1e; border-radius: 24px 24px 0 0; border-top: 1px solid rgba(255,255,255,0.15); padding: 24px 20px calc(20px + env(safe-area-inset-bottom)) 20px; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.1, 0.8, 0.2, 1); max-height: 80vh; overflow-y: auto; margin: 0 12px calc(12px + env(safe-area-inset-bottom)) 12px !important; border-radius: 24px !important; border: 1px solid rgba(255, 255, 255, 0.1) !important; padding-bottom: 20px !important; }
.draft-overlay.visible .draft-sheet { transform: translateY(0); }
.ds-header { margin-bottom: 20px; }
.ds-title { font-size: 22px; font-weight: 800; margin-bottom: 8px; color: #fff; letter-spacing: 0.3px; }
.ds-subtitle { font-size: 13px; color: rgba(255,255,255,0.6); line-height: 1.5; }
.draft-item { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.06); padding: 12px; border-radius: 16px; margin-bottom: 10px; }
.di-icon { font-size: 20px; } .di-inputs { flex: 1; display: flex; flex-direction: column; gap: 6px; }
.di-name { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; padding: 8px 12px; margin-bottom: 4px; color: #fff; font-size: 16px; font-weight: 600; width: 100%; transition: border-color 0.2s, background 0.2s; }
.di-name:focus { background: rgba(255,255,255,0.1); border-color: #0a84ff; }
.di-row { display: flex; align-items: center; gap: 8px; }
.di-weight { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #0a84ff; font-weight: 700; width: 60px; text-align: center; padding: 6px; font-size: 15px; -moz-appearance: textfield; }
.di-weight::-webkit-inner-spin-button { -webkit-appearance: none; }
.di-unit { font-size: 13px; color: var(--text-muted); }

.di-del { 
  width: 36px; 
  height: 36px; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  color: #fff; 
  opacity: 0.6; 
  cursor: pointer;
  transition: opacity 0.2s;
}
.di-del:active { opacity: 1; }

.ds-actions { display: flex; gap: 12px; margin-top: 20px; }
.ds-btn { flex: 1; height: 48px; border-radius: 14px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; }
.ds-btn.sec { background: rgba(255,255,255,0.1); color: #fff; } .ds-btn.prim { background: var(--acc-blue); color: #fff; box-shadow: 0 4px 12px rgba(10,132,255,0.3); }

/* === –ò–ö–û–ù–ö–ò –° GITHUB (CSS MASK) === */
.gh-icon {
  width: 24px; 
  height: 24px;
  display: block;
  background-color: currentColor; /* –¶–≤–µ—Ç –±–µ—Ä–µ—Ç—Å—è –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è */
  
  /* –ú–∞—Å–∫–∞ –≤—ã—Ä–µ–∑–∞–µ—Ç —Ñ–æ—Ä–º—É –∏–∫–æ–Ω–∫–∏ */
  -webkit-mask-position: center;
  mask-position: center;
  -webkit-mask-repeat: no-repeat;
  mask-repeat: no-repeat;
  -webkit-mask-size: contain;
  mask-size: contain;
}

/* === –ù–û–í–´–ô –î–ò–ó–ê–ô–ù –ö–ê–†–¢–û–ß–ï–ö (–¢–û–ß–ù–ê–Ø –ö–û–ü–ò–Ø SCANNER0) === */

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ª–µ–Ω—Ç—ã (—á—Ç–æ–±—ã —Å–∫—Ä–æ–ª–ª–∏–ª–æ—Å—å) */


/* –°–∞–º–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏ */
.meal-card { 
  background: rgba(28, 28, 30, 0.65); /* –¢–≤–æ–π surface-glass */
  border: 1px solid rgba(255, 255, 255, 0.1); 
  border-radius: 22px; /* radius-l –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞ */
  padding: 14px; 
  backdrop-filter: blur(12px); 
  -webkit-backdrop-filter: blur(12px);
  margin-bottom: 12px;
  animation: slideIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
}

/* –°–µ—Ç–∫–∞ –∫–æ–ª–æ–Ω–æ–∫: –ò–º—è | –í–µ—Å | –ö | –ë | –ñ | –£ */
/* –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –∏–∑ scanner0.html –Ω–∞ 100% */
.col-headers, .prod-item { 
  display: grid; 
  grid-template-columns: minmax(0, 1fr) 34px 30px 22px 22px 22px; 
  gap: 5px; 
  align-items: center; 
}

/* –ó–∞–≥–æ–ª–æ–≤–∫–∏ (–í—Ä–µ–º—è –∏ –±—É–∫–≤—ã –ö–ë–ñ–£) */
.col-headers { 
  margin-bottom: 8px; 
  padding-bottom: 6px; 
  border-bottom: 1px solid rgba(255,255,255,0.08); 
}

/* –í—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏ */
.mh-time { 
  text-align: left; 
  font-weight: 700; 
  color: #fff; 
  font-size: 13px;
}

/* –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Å—Ç–∏–ª–∏ —è—á–µ–µ–∫ */
.ch-item, .pi-name, .pi-val { 
  font-size: 13px; 
  font-weight: 400; 
  color: #fff; 
  font-feature-settings: "tnum"; /* –ú–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–µ —Ü–∏—Ñ—Ä—ã */
  white-space: nowrap; 
}

/* –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ (–æ–±—Ä–µ–∑–∞–µ–º –µ—Å–ª–∏ –¥–ª–∏–Ω–Ω–æ–µ) */
.pi-name { 
  overflow: hidden; 
  text-overflow: ellipsis; 
  text-align: left;
}

/* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ü–∏—Ñ—Ä –≤–ø—Ä–∞–≤–æ */
.ch-item, .pi-val { text-align: right; }

/* –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ (–í–µ—Å, –ö, –ë...) */
.ch-item { 
  opacity: 0.6; 
  font-size: 11px; 
  text-transform: uppercase; 
  font-weight: 600; 
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
@keyframes slideIn {
  from { opacity: 0; transform: translateY(20px) scale(0.98); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}


/* ...–Ω–æ –∫–æ–Ω—Ç–µ–Ω—Ç –≤–Ω—É—Ç—Ä–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º */
.carousel-wrap, .timeline-container {
  pointer-events: auto;
}

/* === –ï–î–ò–ù–´–ô –ü–†–ê–í–ò–õ–¨–ù–´–ô –ë–õ–û–ö (–°–∫—Ä–æ–ª–ª –ª–µ–Ω—Ç—ã –ø–æ–¥ –≤–∏–¥–∂–µ—Ç–∞–º–∏) === */

/* 1. –ì–õ–ê–í–ù–ê–Ø –û–ë–ï–†–¢–ö–ê (–ù–µ —Å–∫—Ä–æ–ª–ª–∏—Ç—Å—è, –ø—Ä–æ—Å—Ç–æ –¥–µ—Ä–∂–∏—Ç —Å–ª–æ–∏) */
.dashboard-layer {
  position: absolute; 
  top: 0; 
  left: 0; 
  width: 100%; 
  height: 100%; 
  z-index: 15;
  
  /* –°–∞–º–∞ –æ–±–µ—Ä—Ç–∫–∞ –ø—Ä–æ–∑—Ä–∞—á–Ω–∞ –¥–ª—è –∫–ª–∏–∫–æ–≤ (—á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∫–∞–º–µ—Ä–æ–π —Ç–∞–º, –≥–¥–µ –Ω–µ—Ç UI) */
  pointer-events: none; 
  overflow: hidden; /* –°–∫—Ä–æ–ª–ª–∞ —Ç—É—Ç –Ω–µ—Ç, –æ–Ω –≤–Ω—É—Ç—Ä–∏ timeline */
  
  transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s;
}

/* –°–∫—Ä—ã–≤–∞–µ–º –≤—Å—ë, –∫–æ–≥–¥–∞ –∞–∫—Ç–∏–≤–Ω–∞ –∫–∞–º–µ—Ä–∞ */
.dashboard-layer.hidden-mode { 
  transform: translateY(-30px); 
  opacity: 0; 
  pointer-events: none !important;
}


/* 2. –í–ò–î–ñ–ï–¢–´ (–ó–∞–∫—Ä–µ–ø–ª–µ–Ω—ã —Å–≤–µ—Ä—Ö—É, —Å—Ç–æ—è—Ç –Ω–∞ –º–µ—Å—Ç–µ) */
.carousel-wrap {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  z-index: 20; /* –õ–µ–∂–∞—Ç –ü–û–í–ï–†–• –ª–µ–Ω—Ç—ã */
  
  /* –û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É (–ø–æ–¥ –∫–∞–ª–µ–Ω–¥–∞—Ä—å) */
  padding-top: calc(85px + env(safe-area-inset-top)); 
  padding-bottom: 10px;
  
  /* –í–∫–ª—é—á–∞–µ–º –∫–ª–∏–∫–∏ –∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª —Å–∞–º–∏—Ö –≤–∏–¥–∂–µ—Ç–æ–≤ */
  pointer-events: auto; 
  
  /* –†–∞–∑–º—ã—Ç–∏–µ —Ñ–æ–Ω–∞, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –ª–µ–Ω—Ç—ã –Ω–µ —Å–ª–∏–≤–∞–ª—Å—è —Å –≤–∏–¥–∂–µ—Ç–∞–º–∏ */
  backdrop-filter: blur(8px); 
  -webkit-backdrop-filter: blur(8px);
  /* –õ–µ–≥–∫–æ–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ */
  background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0) 100%);
}



/* 3. –õ–ï–ù–¢–ê –°–û–ë–´–¢–ò–ô */
.timeline-container {
  /* ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –æ—Å—Ç–∞–≤—å –∫–∞–∫ –±—ã–ª–∏: position, inset, z-index –∏ —Ç.–¥.) ... */
  position: absolute;
  inset: 0;
  z-index: 10;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  pointer-events: auto;
  display: flex;
  flex-direction: column;
  padding: 0 16px;
  gap: 12px;
  
  /* –û—Ç—Å—Ç—É–ø—ã –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏ */
  padding-top: calc(340px + env(safe-area-inset-top)); 
  padding-bottom: calc(120px + env(safe-area-inset-bottom));
  
  /* === –î–í–û–ô–ù–ê–Ø –ú–ê–°–ö–ê (FADE TOP & BOTTOM) === */
  /* –õ–æ–≥–∏–∫–∞ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞:
     1. 0px -> 280px:   –ü—Ä–æ–∑—Ä–∞—á–Ω–æ (–ú–µ—Å—Ç–æ –ø–æ–¥ –≤–∏–¥–∂–µ—Ç—ã)
     2. 340px:          –í–∏–¥–Ω–æ –Ω–∞ 100% (–ù–∞—á–∞–ª–æ –ª–µ–Ω—Ç—ã)
     3. 100% - 120px:   –í–∏–¥–Ω–æ –Ω–∞ 100% (–õ–µ–Ω—Ç–∞ –∏–¥–µ—Ç –≤–Ω–∏–∑ –¥–æ OmniBar)
     4. 100%:           –ü—Ä–æ–∑—Ä–∞—á–Ω–æ (–ü–ª–∞–≤–Ω–æ –∏—Å—á–µ–∑–∞–µ—Ç –≤ —Å–∞–º–æ–º –Ω–∏–∑—É)
  */
  mask-image: linear-gradient(to bottom, 
      transparent 0px, 
      transparent 280px, 
      black 340px, 
      black calc(100% - 120px), 
      transparent 100%);
      
  -webkit-mask-image: linear-gradient(to bottom, 
      transparent 0px, 
      transparent 280px, 
      black 340px, 
      black calc(100% - 120px), 
      transparent 100%);
}


/* === FOCUS OVERLAY (–§–û–ö–£–° –†–ï–ñ–ò–ú) === */
.focus-overlay {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  z-index: 90; /* –ü–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç (—Å–ª–æ–∏ 10-50), –Ω–æ –ü–û–î –ø–æ–ª–µ–º –≤–≤–æ–¥–∞ (100) */
  background: rgba(0, 0, 0, 0.6); /* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ */
  backdrop-filter: blur(8px);      /* –†–∞–∑–º—ã—Ç–∏–µ */
  -webkit-backdrop-filter: blur(8px);
  opacity: 0;
  pointer-events: none; /* –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∫–ª–∏–∫–∏, –∫–æ–≥–¥–∞ —Å–∫—Ä—ã—Ç */
  transition: opacity 0.3s ease;
}

.focus-overlay.active {
  opacity: 1;
  pointer-events: auto; /* –ë–ª–æ–∫–∏—Ä—É–µ—Ç –∫–ª–∏–∫–∏ –Ω–∞ —Ñ–æ–Ω, –∫–æ–≥–¥–∞ –∞–∫—Ç–∏–≤–µ–Ω */
}

/* === –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–ö–†–´–¢–ò–ï –ü–û–õ–û–°–´ –ü–†–û–ö–†–£–¢–ö–ò === */

/* –î–ª—è Chrome, Safari –∏ Webview –≤ Telegram (iOS/Android) */
::-webkit-scrollbar {
  width: 0px;
  height: 0px;
  background: transparent; 
  display: none;
}

/* –î–ª—è Firefox –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ */
* {
  scrollbar-width: none; 
  -ms-overflow-style: none;
}

/* === STYLES FOR EDIT MODE (RESIZED PENCIL) === */
.mh-header-row {
  display: flex;
  align-items: center;
  gap: 8px; /* –£–º–µ–Ω—å—à–∏–ª –æ—Ç—Å—Ç—É–ø, —á—Ç–æ–±—ã –∫–∞—Ä–∞–Ω–¥–∞—à –±—ã–ª –±–ª–∏–∂–µ –∫ –≤—Ä–µ–º–µ–Ω–∏ */
}

/* –ö–∞—Ä–∞–Ω–¥–∞—à (–≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ) */
.edit-btn {
  width: 24px; height: 24px; /* –û–±–ª–∞—Å—Ç—å –∫–ª–∏–∫–∞ –æ—Å—Ç–∞–≤–ª—è–µ–º —É–¥–æ–±–Ω–æ–π */
  display: flex; align-items: center; justify-content: center;
  opacity: 0.5; /* –î–µ–ª–∞–µ–º –µ–≥–æ –µ–ª–µ –∑–∞–º–µ—Ç–Ω—ã–º (–ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ —Å—Ç–∞–Ω–µ—Ç —è—Ä—á–µ) */
  cursor: pointer;
  transition: opacity 0.2s, transform 0.2s;
}

/* –°–∞–º—É –∏–∫–æ–Ω–∫—É –¥–µ–ª–∞–µ–º –º–∞–ª–µ–Ω—å–∫–æ–π (–±—ã–ª–æ 24px -> —Å—Ç–∞–ª–æ 14px) */
.edit-btn .gh-icon {
  width: 14px; height: 14px; 
  background-color: #ffffff !important;
}

.edit-btn:active { 
  opacity: 1; 
  transform: scale(0.92); 
}

/* –ö–æ—Ä–∑–∏–Ω–∞ (–≤ —à—Ç–æ—Ä–∫–µ) - –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –±—ã–ª–æ, —Ç–∞–º —Ä–∞–∑–º–µ—Ä –æ–∫ */
.di-del.is-trash {
  background: rgba(255, 255, 255, 0.1); 
  border-radius: 10px;
  width: 36px; height: 36px;
  display: flex; align-items: center; justify-content: center;
  transition: background 0.2s;
}

.di-del.is-trash .gh-icon {
  background-color: #ffffff !important;
  width: 20px; height: 20px;
}

.di-del.is-trash:active {
  background: rgba(255, 255, 255, 0.25);
}


</style>
</head>
<body>
  <div class="fx-layer" id="fxLayer">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="noise"></div>
  </div>
  <div class="app-layout" id="appLayout">

  <div class="calendar-block" id="calendarBlock">
    <div class="calendar-header">
      <div class="month-label" id="monthLabel">...</div>
    </div>
    <div class="calendar-swipe-area" id="swipeArea">
      <div class="calendar-track" id="calTrack">
        <div class="calendar-week" id="weekPrev"></div>
        <div class="calendar-week" id="weekCurr"></div>
        <div class="calendar-week" id="weekNext"></div>
      </div>
    </div>
  </div>
   <div class="cam-viewport">
    <video id="video" autoplay playsinline muted></video>
    
    <div id="loader" class="cam-loader hidden">
      <div class="spinner"></div>
    </div>

    <svg width="0" height="0" style="position:absolute">
      <defs>
        <linearGradient id="grad-kcal"><stop offset="0%" stop-color="#ff9f0a"/><stop offset="100%" stop-color="#ff453a"/></linearGradient>
        <linearGradient id="grad-prot"><stop offset="0%" stop-color="#48bfe3"/><stop offset="100%" stop-color="#5e60ce"/></linearGradient>
        <linearGradient id="grad-fats"><stop offset="0%" stop-color="#f1c40f"/><stop offset="100%" stop-color="#e67e22"/></linearGradient>
        <linearGradient id="grad-carb"><stop offset="0%" stop-color="#2ecc71"/><stop offset="100%" stop-color="#1abc9c"/></linearGradient>
      </defs>
    </svg>

    <div class="dashboard-layer" id="dashboardLayer">
      <div class="carousel-wrap">
        <div class="carousel-track" id="widgetTrack">
          
          <div class="widget">
<div class="macros-grid">
              <div class="macro-item">
                <div class="donut-box">
                  <svg class="mini-donut" viewBox="0 0 60 60">
                    <circle class="md-bg" cx="30" cy="30" r="24"/>
                    <circle id="circle-kcal" class="md-val stroke-kcal" cx="30" cy="30" r="24" style="stroke-dashoffset: 151px"/>
                  </svg>
                  <div class="m-icon">üî•</div>
                </div>
                <div class="m-data">
                  <div class="m-nums" id="val-kcal">0<span>/2500</span></div>
                  <div class="m-lbl">–ö–ö–ê–õ</div>
                </div>
              </div>

              <div class="macro-item">
                <div class="donut-box">
                  <svg class="mini-donut" viewBox="0 0 60 60">
                    <circle class="md-bg" cx="30" cy="30" r="24"/>
                    <circle id="circle-prot" class="md-val stroke-prot" cx="30" cy="30" r="24" style="stroke-dashoffset: 151px"/>
                  </svg>
                  <div class="m-icon">üêì</div>
                </div>
                <div class="m-data">
                  <div class="m-nums" id="val-prot">0<span>/160</span></div>
                  <div class="m-lbl">–ë–ï–õ–ö–ò</div>
                </div>
              </div>

              <div class="macro-item">
                <div class="donut-box">
                  <svg class="mini-donut" viewBox="0 0 60 60">
                    <circle class="md-bg" cx="30" cy="30" r="24"/>
                    <circle id="circle-fats" class="md-val stroke-fats" cx="30" cy="30" r="24" style="stroke-dashoffset: 151px"/>
                  </svg>
                  <div class="m-icon">ü•ë</div>
                </div>
                <div class="m-data">
                  <div class="m-nums" id="val-fats">0<span>/80</span></div>
                  <div class="m-lbl">–ñ–ò–†–´</div>
                </div>
              </div>

              <div class="macro-item">
                <div class="donut-box">
                  <svg class="mini-donut" viewBox="0 0 60 60">
                    <circle class="md-bg" cx="30" cy="30" r="24"/>
                    <circle id="circle-carb" class="md-val stroke-carb" cx="30" cy="30" r="24" style="stroke-dashoffset: 151px"/>
                  </svg>
                  <div class="m-icon">üåæ</div>
                </div>
                <div class="m-data">
                  <div class="m-nums" id="val-carb">0<span>/300</span></div>
                  <div class="m-lbl">–£–ì–õ–ò</div>
                </div>
              </div>
            </div>
          </div>

          <div class="widget water-widget" id="waterCard">
            <div class="water-header"><div class="water-title">–í–æ–¥–Ω—ã–π –±–∞–ª–∞–Ω—Å</div><div class="water-percent" id="lbl-pct">0%</div></div>
            <div class="water-cols">
              <div class="water-tube"><div class="water-fill" id="c1"></div></div>
              <div class="water-tube"><div class="water-fill" id="c2"></div></div>
              <div class="water-tube"><div class="water-fill" id="c3"></div></div>
              <div class="water-tube"><div class="water-fill" id="c4"></div></div>
              <div class="water-tube"><div class="water-fill" id="c5"></div></div>
            </div>
            <div class="water-footer">
              <div class="water-info"><div class="wf-row"><div class="wf-fact" id="lbl-fact">0</div><div class="wf-unit">–º–ª</div></div><div class="wf-plan">–¶–µ–ª—å: 2500</div></div>
              <div class="water-controls">
                <div class="water-btn" onclick="updateWater(-250)">‚àí</div>
                <div class="water-btn" onclick="updateWater(250)">+</div>
              </div>
            </div>
          </div>

        </div>
        <div class="dots"><div class="dot active"></div><div class="dot"></div></div>
      </div>
      <div class="timeline-container" id="mealTimeline"></div>
    </div>
    <canvas id="uiCanvas"></canvas>
    <div id="camToast" class="cam-toast">Camera Name</div>

    <div class="ui-layer idle" id="camUI">
      <div class="top-bar">
        
        <div class="btn-close" id="btnClose">
         <div class="gh-icon" style="-webkit-mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/cross2.svg'); mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/cross2.svg');"></div>
        </div>

        <div class="status-chip" id="lvlChip">
          <div class="status-dot" id="lvlDot"></div>
          <span id="lvlText">–£—Ä–æ–≤–µ–Ω—å</span>
        </div>

        <div class="spacer"></div>
      </div>

      <div class="controls-grid">
        <div class="grid-cell-left">
            <div class="action-btn" id="btnTorch">
              <div class="gh-icon" style="-webkit-mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/flash1.svg'); mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/flash1.svg');"></div>
            </div>
        </div>

        <div class="grid-cell-center">
          <div class="shutter-outer disabled" id="shutterBtn">
            <div class="shutter-inner"></div>
          </div>
        </div>

        <div class="grid-cell-right">
          <div class="action-btn hidden" id="btnSwitch">
            <div class="gh-icon" style="-webkit-mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/rotate.svg'); mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/rotate.svg');"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="focus-overlay" id="focusOverlay"></div>
    <div class="omni-bar" id="omniBar">
        <div class="omni-icon-btn">
          <div class="gh-icon" style="-webkit-mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/add.svg'); mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/add.svg');"></div>
        </div>
      <div class="input-wrap">
        <textarea class="omni-input" rows="1" placeholder="–Ø–±–ª–æ–∫–æ 200–≥, –∫–æ—Ñ–µ..."></textarea>
      </div>
      <div class="cam-trigger-btn" id="btnStartCam">
  
      <div id="icoCam" class="gh-icon omni-btn-icon" 
          style="-webkit-mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/cam.svg'); mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/cam.svg');">
      </div>
      
      <div id="icoSend" class="gh-icon omni-btn-icon icon-hidden" 
          style="-webkit-mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/plane.svg'); mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/plane.svg'); margin-left: 2px;">
      </div>

    </div>

  </div>
</div>
  <div id="permReq" class="perm-overlay hidden">
    <div style="font-size:48px; margin-bottom:10px">üìê</div>
    <h2 style="margin:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∞</h2>
    <p style="color:var(--text-muted)">–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –¥–∞—Ç—á–∏–∫–∞–º –¥–ª—è —Ä–∞–±–æ—Ç—ã —É—Ä–æ–≤–Ω—è.</p>
    <button class="perm-btn" onclick="requestSensors()">–†–∞–∑—Ä–µ—à–∏—Ç—å</button>
  </div>

  <div id="previewScreen" class="preview-overlay">
    <img id="finalPhoto" class="preview-img">
    <div class="comment-wrap">
      <label class="comment-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <textarea id="commentInput" class="comment-input" placeholder="–ú–æ–∂–µ—Ç–µ —É–∫–∞–∑–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã, —ç—Ç–æ –ø–æ–≤—ã—Å–∏—Ç —Ç–æ—á–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏. –ù–∞–ø—Ä–∏–º–µ—Ä: —Ä–∏—Å 200, —Ç—Ä–µ—Å–∫–∞ 150"></textarea>
    </div>
    <div class="preview-controls">
      <button class="btn" onclick="retake()">–ü–µ—Ä–µ—Å–Ω—è—Ç—å</button>
      <button class="btn primary" id="btnSend" onclick="sendPhoto()">–ì–æ—Ç–æ–≤–æ</button>
    </div>
  </div>

<div class="processing-overlay" id="procOverlay">
    <div class="proc-card">
      <div class="proc-visual">
        <div class="proc-orb"></div>
        <div class="proc-ring"></div>
      </div>
      <div class="proc-title">–î—É–º–∞—é</div>
      
      <div class="proc-steps" id="procSteps">
        <div class="step pending" id="step-1"><div class="s-icon">üõ°Ô∏è</div><div class="s-lbl">Gatekeeper: –ü—Ä–æ–≤–µ—Ä—è—é...</div></div>
        <div class="step pending" id="step-2"><div class="s-icon">üì¶</div><div class="s-lbl">Librarian: –ò—â—É –≤ –±–∞–∑–µ...</div></div>
        <div class="step pending" id="step-3"><div class="s-icon">üïµÔ∏è</div><div class="s-lbl">Detective: –ò—â—É –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã...</div></div>
        <div class="step pending" id="step-4"><div class="s-icon">üìê</div><div class="s-lbl">Physicist: –û–ø—Ä–µ–¥–µ–ª—è—é –≤–µ—Å...</div></div>
        <div class="step pending" id="step-5"><div class="s-icon">üìù</div><div class="s-lbl">Synthesizer: –ì–æ—Ç–æ–≤–ª—é –æ—Ç–≤–µ—Ç...</div></div>
      </div>

      <div class="proc-close" onclick="cancelProcessing()">–û—Ç–º–µ–Ω–∞</div>
    </div>
  </div>

  <div class="draft-overlay" id="draftOverlay">
    <div class="draft-sheet">
      <div class="ds-header">
        <div class="ds-title">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ</div>
        <div class="ds-subtitle">–ï—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ, –≤–Ω–µ—Å–∏—Ç–µ –ø—Ä–∞–≤–∫–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é –≤ –¥–Ω–µ–≤–Ω–∏–∫</div>
      </div>
      
      <div class="ds-list" id="draftList"></div>

      <div class="ds-actions">
        <button class="ds-btn sec" onclick="closeDraft()">–û—Ç–º–µ–Ω–∞</button>
        <button class="ds-btn prim" id="btnConfirmDraft" onclick="confirmDraftToNutritionist()">–í –¥–Ω–µ–≤–Ω–∏–∫</button>
      </div>
    </div>
  </div>

<script>
/* ============================================================
 * BLOCK 0: TMA boot (FIXED & SAFE)
 * ============================================================ */
(function initTMA() {
  try {
    const tg = window.Telegram?.WebApp;
    if (!tg) return; // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –¢–µ–ª–µ–≥—Ä–∞–º, –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º, –Ω–µ –ª–æ–º–∞—è —Å–∞–π—Ç

    tg.ready();
    tg.expand();

    // 1. –ö—Ä–∞—Å–∏–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–æ–±–µ—Ä–Ω—É—Ç–æ –≤ –∑–∞—â–∏—Ç—É, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫—É)
    try {
      tg.setHeaderColor('#050505'); // –ß–µ—Ä–Ω—ã–π —Ü–≤–µ—Ç
      if (tg.setBackgroundColor) {
        tg.setBackgroundColor('#050505');
      }
    } catch (e) {
      console.log('Error setting color:', e);
    }

    // 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
    try {
      if (tg.BackButton) {
        tg.BackButton.show();
        // –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –Ω–µ —Ç—É–ø–∏–ª–∞
        tg.BackButton.offClick(); 
        // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ—Ö–æ–¥
        tg.BackButton.onClick(function() {
          window.location.href = 'router.html';
        });
      }
    } catch (e) {
      console.log('Error setting back button:', e);
    }

    // 3. –û—Ç–∫–ª—é—á–∞–µ–º —Å–≤–∞–π–ø—ã (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
    try {
      if (tg.disableVerticalSwipes) tg.disableVerticalSwipes();
    } catch (e) {}

  } catch (globalErr) {
    // –ï—Å–ª–∏ –≤–æ–æ–±—â–µ –≤—Å–µ —É–ø–∞–ª–æ –≤ TMA, –≤—ã–≤–æ–¥–∏–º –æ—à–∏–±–∫—É, –Ω–æ –ù–ï –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫—Ä–∏–ø—Ç
    console.error('Critical TMA Error:', globalErr);
  }
})();
  
/**
 * –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
 * @returns {boolean} true, –µ—Å–ª–∏ Telegram user.id —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
 */
function isAdmin() {
  try {
    const userId = Number(window.Telegram?.WebApp?.initDataUnsafe?.user?.id);
    return userId === 196047220;
  } catch (_) {
    return false;
  }
}

// === –ë–ï–ó–£–ü–†–ï–ß–ù–´–ô –†–ï–°–ê–ô–ó (VISUAL VIEWPORT + FIXED BACKGROUND) ===
// === –ë–ï–ó–£–ü–†–ï–ß–ù–´–ô –†–ï–°–ê–ô–ó (FIXED) ===
(function initStableLayout() {
  const app = document.getElementById('appLayout'); 
  const fxLayer = document.getElementById('fxLayer');
  
  // –ë–∞–∑–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã
  let fixedHeight = window.innerHeight;
  let lastWidth = window.innerWidth;

  if (fxLayer) fxLayer.style.height = `${fixedHeight}px`;
  
  function handleResize() {
    // 1. –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã—Å–æ—Ç—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø–æ–¥ Viewport (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø—É—Å—Ç–æ—Ç)
    const vh = window.visualViewport ? window.visualViewport.height : window.innerHeight;
    const currentW = window.innerWidth;
    const currentH = window.innerHeight;

    if (app) {
        app.style.height = `${vh}px`;
        
        // --- –ì–õ–ê–í–ù–´–ô –§–ò–ö–° –ü–†–´–ñ–ö–ê ---
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞
        const active = document.activeElement;
        const isInput = active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA');

        // –ï—Å–ª–∏ –º—ã –ù–ï –ø–∏—à–µ–º —Ç–µ–∫—Å—Ç ‚Äî –¥–µ—Ä–∂–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞–≤–µ—Ä—Ö—É.
        // –ï—Å–ª–∏ –ø–∏—à–µ–º ‚Äî –ù–ï —Ç—Ä–æ–≥–∞–µ–º —Å–∫—Ä–æ–ª–ª, –ø—É—Å—Ç—å –±—Ä–∞—É–∑–µ—Ä —Å–∞–º –ø–æ–¥—Å—Ç—Ä–æ–∏—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É.
        if (!isInput) {
             window.scrollTo(0, 0);
        }
    }

    // 2. –§–æ–Ω –º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å —à–∏—Ä–∏–Ω–∞ (–ø–æ–≤–æ—Ä–æ—Ç —ç–∫—Ä–∞–Ω–∞), 
    // —á—Ç–æ–±—ã –æ–Ω –Ω–µ –ø—Ä—ã–≥–∞–ª –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    if (Math.abs(currentW - lastWidth) > 50) { 
        fixedHeight = currentH; 
        lastWidth = currentW;
        if (fxLayer) fxLayer.style.height = `${fixedHeight}px`;
    }
  }

  // –°–ª—É—à–∞—Ç–µ–ª–∏
  if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', handleResize);
    window.visualViewport.addEventListener('scroll', handleResize);
  }
  window.addEventListener('resize', handleResize);

  // Telegram Specific
  const tg = window.Telegram?.WebApp;
  if(tg) {
    tg.onEvent('viewportChanged', handleResize);
  }

  // –ó–∞–ø—É—Å–∫
  handleResize();
})();

  // === CONFIG ===
  const API_URL = "https://script.google.com/macros/s/AKfycbx0fUaaCH-JwnG5R_3TFgU5FSibsEuhuS0ZZZfyxPNVPQ1ZpCfUIaa5aE8vjgqitac/exec"; // ‚ö†Ô∏è –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ô URL!

  // === TELEGRAM INIT ===
  const tg = window.Telegram?.WebApp;
  if(tg) {
    tg.ready(); tg.expand();
    tg.setHeaderColor('#000000');
    if(tg.disableVerticalSwipes) tg.disableVerticalSwipes();
  }

 
  // === API HELPER (CORS HACK FIX) ===
  const API = {
    // 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ü–û–õ–ù–´–ô Data URL
    blobToBase64: (blob) => {
      return new Promise((resolve, _) => {
        const reader = new FileReader();
        reader.onloadend = () => {
           // –ù–ï –û–ë–†–ï–ó–ê–ï–ú! –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å: "data:image/jpeg;base64,..."
           resolve(reader.result);
        };
        reader.readAsDataURL(blob);
      });
    },

    // 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞: text/plain
    send: async (action, payload) => {
      const user = tg?.initDataUnsafe?.user || { id: 0, first_name: 'BrowserTest' };
      const body = {
        action: action,
        user: user,
        initData: tg?.initData || '',
        ...payload
      };
      
      // üî• MAGIC FIX: –ò—Å–ø–æ–ª—å–∑—É–µ–º text/plain, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å CORS Preflight
      const response = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" }, 
        body: JSON.stringify(body)
      });

      const json = await response.json();
      if (!json.ok) throw new Error(json.error || 'Server Error');
      return json;
    }
  };

  // === STATE & DOM ===
  const state = {
    stream: null,
    track: null,
    levelOK: false,
    angleX: 0, angleY: 0,
    photoBlob: null,
    isCapturing: false,
    isSwitching: false,
    devices: [],      
    currentDevIdx: 0, 
    torchOn: false,
    sensorActive: false,
    uiMode: 'menu' 
  };

  const DOM = {
    video: document.getElementById('video'),
    canvas: document.getElementById('uiCanvas'),
    ctx: document.getElementById('uiCanvas').getContext('2d'),
    shutter: document.getElementById('shutterBtn'),
    lvlDot: document.getElementById('lvlDot'),
    lvlText: document.getElementById('lvlText'),
    permReq: document.getElementById('permReq'),
    preview: document.getElementById('previewScreen'),
    finalImg: document.getElementById('finalPhoto'),
    btnSend: document.getElementById('btnSend'),
    commentInput: document.getElementById('commentInput'),
    btnTorch: document.getElementById('btnTorch'),
    btnSwitch: document.getElementById('btnSwitch'),
    toast: document.getElementById('camToast'),
    loader: document.getElementById('loader'),
    
    omniBar: document.getElementById('omniBar'),
    camUI: document.getElementById('camUI'),

    omniInput: document.querySelector('.omni-input'), // –¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ
    icoCam: document.getElementById('icoCam'),
    icoSend: document.getElementById('icoSend'),

    btnStartCam: document.getElementById('btnStartCam'),
    btnClose: document.getElementById('btnClose')
  };

  // === LOGIC ===
  // === OMNI BAR LOGIC (TEXT vs CAMERA) ===
  // === –õ–û–ì–ò–ö–ê –§–û–ö–£–°–ê (–ë–õ–Æ–† –§–û–ù–ê) ===
  const overlay = document.getElementById('focusOverlay');

  // 1. –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ -> –í–∫–ª—é—á–∞–µ–º —Ñ–æ–∫—É—Å
  DOM.omniInput.addEventListener('focus', () => {
      overlay.classList.add('active');
  });

  // 2. –ü—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã -> –í—ã–∫–ª—é—á–∞–µ–º, –ù–û —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –æ—Ç–∫—Ä—ã—Ç –î—Ä–∞—Ñ—Ç
  DOM.omniInput.addEventListener('blur', () => {
      // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã —É—Å–ø–µ—Ç—å –ø–æ–Ω—è—Ç—å, –æ—Ç–∫—Ä—ã–ª—Å—è –ª–∏ –î—Ä–∞—Ñ—Ç
      setTimeout(() => {
          if (!document.getElementById('draftOverlay').classList.contains('visible') && 
              !DOM.btnStartCam.classList.contains('mode-send')) { // –ï—Å–ª–∏ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
              overlay.classList.remove('active');
          }
      }, 50);
  });

  // 1. –°–ª—É—à–∞–µ–º –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞
  DOM.omniInput.addEventListener('input', () => {
    const hasText = DOM.omniInput.value.trim().length > 0;
    
    // –ê–≤—Ç–æ-–≤—ã—Å–æ—Ç–∞ –ø–æ–ª—è (–∫–∞–∫ –≤ scanner.html)
    DOM.omniInput.style.height = 'auto'; 
    DOM.omniInput.style.height = Math.min(DOM.omniInput.scrollHeight, 80) + 'px';

    if (hasText) {
      // –†–µ–∂–∏–º –û–¢–ü–†–ê–í–ö–ò
      DOM.btnStartCam.classList.add('mode-send');
      DOM.icoCam.classList.add('icon-hidden');
      DOM.icoSend.classList.remove('icon-hidden');
    } else {
      // –†–µ–∂–∏–º –ö–ê–ú–ï–†–´
      DOM.btnStartCam.classList.remove('mode-send');
      DOM.icoCam.classList.remove('icon-hidden');
      DOM.icoSend.classList.add('icon-hidden');
    }
  });

  // 2. –£–º–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
    DOM.btnStartCam.onclick = async () => {
      DOM.omniInput.blur();
    const text = DOM.omniInput.value.trim();
    
    if (text.length > 0) {
      await sendTextOnly(text);
    } else {
      state.uiMode = 'camera';
      
      // –í–û–¢ –ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï:
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ID 'calendarBlock' –∏ —É–≤–æ–¥–∏–º –µ–≥–æ –≤–≤–µ—Ä—Ö
      const cal = document.getElementById('calendarBlock');
      if(cal) cal.style.transform = 'translateY(-150%)'; 
      
      // –°–∫—Ä—ã–≤–∞–µ–º –≤–∏–¥–∂–µ—Ç—ã —Ç–æ–∂–µ, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–∏
      const dash = document.getElementById('dashboardLayer');
      if(dash) dash.classList.add('hidden-mode');

      DOM.omniBar.classList.add('hidden');
      DOM.camUI.classList.remove('idle');
      DOM.camUI.style.pointerEvents = 'auto'; 
      if(tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
      await initCamera(); 
    }
  };

// 3. –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–∏—Å—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (–° –§–ò–ö–°–û–ú –ò–ö–û–ù–ö–ò)
  async function sendTextOnly(text) {
     const btn = DOM.btnStartCam;
     btn.style.opacity = '0.5';
     haptic('medium');
     document.getElementById('focusOverlay').classList.add('active');
     try {
       startProcessingUI('text');
       
       const result = await API.send('scan', { image: null, userText: text });
       
       stopProcessingUI();
       
       // === –ù–ê–ß–ê–õ–û –§–ò–ö–°–ê: –°–ë–†–û–° –ü–û–õ–Ø –ò –ò–ö–û–ù–ö–ò ===
       DOM.omniInput.value = ''; // –ß–∏—Å—Ç–∏–º —Ç–µ–∫—Å—Ç
       DOM.omniInput.style.height = 'auto'; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –ø–æ–ª—è
       
       // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–∫–æ–Ω–∫—É –∫–∞–º–µ—Ä—ã
       DOM.btnStartCam.classList.remove('mode-send'); 
       DOM.icoCam.classList.remove('icon-hidden');
       DOM.icoSend.classList.add('icon-hidden');
       // === –ö–û–ù–ï–¶ –§–ò–ö–°–ê ===
       
       if (result.ok) {
         openDraftSheet(result.data, result.scanId);
       } else {
         throw new Error(result.error);
       }
     } catch(e) {
       stopProcessingUI();
       alert("–û—à–∏–±–∫–∞: " + e.message);
     } finally {
       btn.style.opacity = '1';
     }
  }

 DOM.btnClose.onclick = () => {
    // 1. –£–±–∏—Ä–∞–µ–º —Ñ–æ–∫—É—Å —Å –∏–Ω–ø—É—Ç–æ–≤ (—Å–∫—Ä—ã–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É, –µ—Å–ª–∏ –±—ã–ª–∞)
    DOM.omniInput.blur();
    if(DOM.commentInput) DOM.commentInput.blur();

    // 2. –°–∫—Ä—ã–≤–∞–µ–º UI –∫–∞–º–µ—Ä—ã –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –º–µ–Ω—é
    state.uiMode = 'menu';
    DOM.camUI.classList.add('idle');
    DOM.camUI.style.pointerEvents = 'none';
    DOM.omniBar.classList.remove('hidden');
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å –∏ –≤–∏–¥–∂–µ—Ç—ã
    const cal = document.getElementById('calendarBlock');
    if(cal) cal.style.transform = 'translateY(0)';
    const dash = document.getElementById('dashboardLayer');
    if(dash) dash.classList.remove('hidden-mode');

    stopStream(); 

    // 3. –ú–Ø–ì–ö–ò–ô –°–ë–†–û–° (–ß–µ—Ä–µ–∑ 50–º—Å, —á—Ç–æ–±—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É—Å–ø–µ–ª –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å—Å—è)
    setTimeout(() => {
        window.scrollTo(0, 0);
        const app = document.getElementById('appLayout');
        if (app) app.style.height = window.innerHeight + 'px';
    }, 50);
  };

  let toastTimer;
  function showToast(msg) {
    DOM.toast.textContent = msg;
    DOM.toast.classList.add('visible');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => { DOM.toast.classList.remove('visible'); }, 2000);
  }

  function stopStream() {
    if (state.stream) { state.stream.getTracks().forEach(t => t.stop()); state.stream = null; }
    state.track = null; state.torchOn = false; 
    updateTorchUI();
    DOM.video.srcObject = null;
    DOM.video.classList.remove('active');
  }

  async function startStream(deviceId) {
    if (state.stream) stopStream();
    const constraints = { audio: false, video: { deviceId: deviceId ? { exact: deviceId } : undefined, facingMode: deviceId ? undefined : 'environment', width: { ideal: 1920 }, height: { ideal: 2560 } } };
    try {
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      state.stream = stream; state.track = stream.getVideoTracks()[0];
      DOM.video.srcObject = stream; DOM.video.classList.add('active');
      const settings = state.track.getSettings();
      if (settings.deviceId) localStorage.setItem('ultima_cam_id', settings.deviceId);
      
      let label = state.track.label || "–ö–∞–º–µ—Ä–∞";
      label = label.replace(/\(.*\)/, '').replace(/camera2/i, '').replace(/facing/i, '').trim();
      if(label.length < 2) label = "–ö–∞–º–µ—Ä–∞ " + (state.currentDevIdx + 1);
      if(state.devices.length > 1) showToast(label);

      const caps = state.track.getCapabilities();
      if (caps.focusMode?.includes('continuous')) { try { await state.track.applyConstraints({ advanced: [{ focusMode: 'continuous' }] }); } catch(e){} }
    } catch (e) {
      if (deviceId) { localStorage.removeItem('ultima_cam_id'); await startStream(null); } 
      else { alert("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: " + e.message); }
    }
  }

  DOM.btnSwitch.onclick = async () => {
    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∏
    if (state.devices.length < 2 || state.isSwitching) return;
    
    state.isSwitching = true; 
    haptic('medium');
    
    // 2. –ë–ª–æ–∫–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    DOM.loader.classList.remove('hidden');
    DOM.btnSwitch.classList.add('disabled'); 
    DOM.btnTorch.classList.add('disabled'); 
    DOM.shutter.classList.add('disabled');

    // 3. –ò–©–ï–ú –ò–ö–û–ù–ö–£ (–ü–†–ê–í–ò–õ–¨–ù–û)
    const icon = DOM.btnSwitch.querySelector('.gh-icon'); 
    if (icon) {
        icon.style.transition = 'transform 0.4s'; 
        icon.style.transform = 'rotate(180deg)';
    }

    // 4. –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º
    if (state.stream) state.stream.getTracks().forEach(t => t.stop());
    await new Promise(r => setTimeout(r, 500));
    
    let nextIdx = state.currentDevIdx + 1;
    if (nextIdx >= state.devices.length) nextIdx = 0;
    state.currentDevIdx = nextIdx;
    
    await startStream(state.devices[nextIdx].deviceId);
    
    // 5. –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º
    DOM.loader.classList.add('hidden');
    DOM.btnSwitch.classList.remove('disabled'); 
    DOM.btnTorch.classList.remove('disabled'); 
    DOM.shutter.classList.remove('disabled');
    
    state.isSwitching = false; 
    if (icon) setTimeout(() => icon.style.transform = '', 400);
  };


  DOM.btnTorch.onclick = async () => {
    if(!state.track) return;
    const caps = state.track.getCapabilities();
    if (!caps.torch) { showToast("–í—Å–ø—ã—à–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"); haptic('error'); return; }
    const newState = !state.torchOn;
    try { await state.track.applyConstraints({ advanced: [{ torch: newState }] }); state.torchOn = newState; updateTorchUI(); haptic('light'); } 
    catch(e) { showToast("–û—à–∏–±–∫–∞ –≤—Å–ø—ã—à–∫–∏"); }
  };

  function updateTorchUI() {
    if (state.torchOn) { DOM.btnTorch.style.backgroundColor = 'var(--acc-orange)'; DOM.btnTorch.style.color = '#000'; } 
    else { DOM.btnTorch.style.backgroundColor = ''; DOM.btnTorch.style.color = '#fff'; }
  }

  function checkSensorPerms() {
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') { DOM.permReq.classList.remove('hidden'); } 
    else { window.addEventListener('deviceorientation', handleOrientation); }
  }
  async function requestSensors() {
    try { const resp = await DeviceOrientationEvent.requestPermission(); if (resp === 'granted') { window.addEventListener('deviceorientation', handleOrientation); } } 
    catch (e) {} finally { DOM.permReq.classList.add('hidden'); }
  }
  function handleOrientation(e) {
    let x = e.beta; let y = e.gamma; 
    if (x === null || y === null) return;
    state.sensorActive = true; state.angleX = x; state.angleY = y;
  }
  function updateUI() {
    if (state.uiMode === 'menu') return;
    if (state.isCapturing || state.isSwitching) return;
    if (!state.sensorActive) { DOM.lvlDot.classList.remove('ok'); DOM.lvlText.textContent = "–ö–∞–º–µ—Ä–∞"; DOM.shutter.classList.remove('disabled'); DOM.shutter.classList.add('active'); return; }
    if (state.levelOK) { DOM.lvlDot.classList.add('ok'); DOM.lvlText.textContent = "–†–æ–≤–Ω–æ"; DOM.shutter.classList.remove('disabled'); DOM.shutter.classList.add('active'); } 
    else { DOM.lvlDot.classList.remove('ok'); DOM.lvlText.textContent = "–í—ã—Ä–æ–≤–Ω—è–π—Ç–µ"; DOM.shutter.classList.add('disabled'); DOM.shutter.classList.remove('active'); }
  }
  function resizeCanvas() { const w = window.innerWidth; const h = window.innerHeight; if (DOM.canvas.width !== w || DOM.canvas.height !== h) { DOM.canvas.width = w; DOM.canvas.height = h; } }

  async function initCamera() {
    try { const savedId = localStorage.getItem('ultima_cam_id'); await startStream(savedId); await updateDeviceList(); resizeCanvas(); window.addEventListener('resize', resizeCanvas); requestAnimationFrame(drawLoop); checkSensorPerms(); } 
    catch (e) { console.warn("Init Error:", e); }
  }
  async function updateDeviceList() {
    try {
      const allDevices = await navigator.mediaDevices.enumerateDevices();
      state.devices = allDevices.filter(d => d.kind === 'videoinput');
      if (state.devices.length > 1) { DOM.btnSwitch.classList.remove('hidden'); } else { DOM.btnSwitch.classList.add('hidden'); }
      if (state.track) {
        const currentId = state.track.getSettings().deviceId;
        state.currentDevIdx = state.devices.findIndex(d => d.deviceId === currentId);
        if(state.currentDevIdx === -1) state.currentDevIdx = 0;
      }
    } catch(e) {}
  }

  function drawLoop() {
    const ctx = DOM.ctx; const w = DOM.canvas.width; const h = DOM.canvas.height;
    ctx.clearRect(0, 0, w, h);
    if (state.uiMode === 'menu') { requestAnimationFrame(drawLoop); return; }
    
    const cx = w / 2; const cy = h / 2;
    const cardRatio = 1.586; const cardW = w * 0.22; const cardH = cardW * cardRatio;
    const cardX = cx + 80; const cardY = cy - cardH / 2; const r = 8; 
    ctx.beginPath(); ctx.moveTo(cardX + r, cardY); ctx.lineTo(cardX + cardW - r, cardY); ctx.quadraticCurveTo(cardX + cardW, cardY, cardX + cardW, cardY + r); ctx.lineTo(cardX + cardW, cardY + cardH - r); ctx.quadraticCurveTo(cardX + cardW, cardY + cardH, cardX + cardW - r, cardY + cardH); ctx.lineTo(cardX + r, cardY + cardH); ctx.quadraticCurveTo(cardX, cardY + cardH, cardX, cardY + cardH - r); ctx.lineTo(cardX, cardY + r); ctx.quadraticCurveTo(cardX, cardY, cardX + r, cardY);
    ctx.fillStyle = 'rgba(255, 255, 255, 0.2)'; ctx.fill(); 
    ctx.save(); ctx.translate(cardX + cardW / 2, cardY + cardH / 2); ctx.rotate(-Math.PI / 2); ctx.fillStyle = '#ffffff'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.font = 'bold 12px sans-serif'; ctx.fillText("CREDIT CARD", 0, -10); ctx.font = '10px sans-serif'; ctx.fillText("(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)", 0, 10); ctx.restore(); 

    if (state.sensorActive) {
        const rBubble = 14; const rTarget = 18; const maxOffset = 60; 
        const rawX = (isNaN(state.angleY) || state.angleY === null) ? 0 : state.angleY;
        const rawY = (isNaN(state.angleX) || state.angleX === null) ? 0 : state.angleX;
        const clamp = (val) => Math.max(-20, Math.min(20, val));
        const dx = (clamp(rawX) / 20) * maxOffset; const dy = (clamp(rawY) / 20) * maxOffset;
        const dist = Math.hypot(dx, dy);
        const isInside = (dist + rBubble) <= rTarget;
        if (state.levelOK !== isInside && !state.isCapturing && !state.isSwitching) { state.levelOK = isInside; updateUI(); if(isInside) haptic('medium'); }
        ctx.shadowBlur = 4; ctx.shadowColor = 'rgba(0,0,0,0.5)';
        ctx.beginPath(); ctx.arc(cx, cy, rTarget, 0, Math.PI * 2); 
        const color = (state.levelOK || state.isCapturing) ? '#30d158' : 'rgba(255,255,255,0.85)';
        ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.stroke();
        ctx.beginPath(); ctx.arc(cx + dx, cy + dy, rBubble, 0, Math.PI * 2); ctx.fillStyle = color; ctx.fill(); ctx.shadowBlur = 0;
    } else {
        ctx.strokeStyle = 'rgba(255,255,255,0.5)'; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(cx-10, cy); ctx.lineTo(cx+10, cy); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(cx, cy-10); ctx.lineTo(cx, cy+10); ctx.stroke();
    }
    requestAnimationFrame(drawLoop);
  }

DOM.shutter.addEventListener('click', async () => {
    if (state.isCapturing || state.isSwitching) return; 
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–≤–Ω—è
    if (state.sensorActive && !state.levelOK) { 
        haptic('error'); 
        showToast("–í—ã—Ä–æ–≤–Ω—è–π—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω"); 
        return; 
    }
    
    try {
        state.isCapturing = true; 
        haptic('heavy');
        DOM.shutter.style.transform = 'scale(0.8)'; 
        DOM.shutter.style.opacity = '0.5';
        
        await new Promise(r => setTimeout(r, 50));
        const vid = DOM.video;
        
        if (vid.readyState < 2 || vid.videoWidth === 0) throw new Error("–ö–∞–º–µ—Ä–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞");

        // === –í–ê–ñ–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–ñ–ê–¢–ò–ï –§–û–¢–û ===
        const MAX_SIDE = 1024; // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –¥–æ 1024px (—ç—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –ò–ò)
        let w = vid.videoWidth;
        let h = vid.videoHeight;
        
        // –°—á–∏—Ç–∞–µ–º –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
        if (w > h) {
          if (w > MAX_SIDE) { h *= MAX_SIDE / w; w = MAX_SIDE; }
        } else {
          if (h > MAX_SIDE) { w *= MAX_SIDE / h; h = MAX_SIDE; }
        }

        // –†–∏—Å—É–µ–º —É–º–µ–Ω—å—à–µ–Ω–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º —Ö–æ–ª—Å—Ç–µ
        const c = document.createElement('canvas'); 
        c.width = w; 
        c.height = h;
        const ctx = c.getContext('2d');
        ctx.drawImage(vid, 0, 0, w, h);
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ Base64 —Å –∫–∞—á–µ—Å—Ç–≤–æ–º 0.7 (—Å–∏–ª—å–Ω–æ —ç–∫–æ–Ω–æ–º–∏—Ç –º–µ—Å—Ç–æ)
        const blob = await new Promise(resolve => c.toBlob(resolve, 'image/jpeg', 0.7)); 
        // === –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ===

        if (!blob) throw new Error("–ü—É—Å—Ç–æ–π –∫–∞–¥—Ä");
        showPreview(blob);

    } catch(err) {
        console.error(err); 
        haptic('error'); 
        showToast("–û—à–∏–±–∫–∞: " + err.message);
        state.isCapturing = false; 
        updateUI();
    } finally {
        DOM.shutter.style.transform = ''; 
        DOM.shutter.style.opacity = ''; 
        state.isCapturing = false;
    }
  });

  function showPreview(blob) {
    if(!blob) return; state.photoBlob = blob;
    DOM.finalImg.src = URL.createObjectURL(blob); DOM.preview.style.display = 'flex';
  }
  function retake() {
    DOM.preview.style.display = 'none';
    if(DOM.finalImg.src) URL.revokeObjectURL(DOM.finalImg.src);
    DOM.finalImg.src = ''; state.photoBlob = null; DOM.commentInput.value = ''; 
  }

  // --- üî• –û–¢–ü–†–ê–í–ö–ê –ù–ê –ë–≠–ö (–ò–°–ü–†–ê–í–õ–ï–ù–û –î–õ–Ø CORS) ---
  async function sendPhoto() {
    const btn = DOM.btnSend;
    if (btn.disabled) return; 
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
    DOM.preview.style.display = 'none'; 
    haptic('heavy');

    try {
        if (!state.photoBlob) throw new Error("–ù–µ—Ç —Ñ–æ—Ç–æ");
        
        // 1. –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é "–î—É–º–∞—é..."
        startProcessingUI('photo');
        
        // 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        const base64 = await API.blobToBase64(state.photoBlob);
        const userText = DOM.commentInput.value;
        
        // 3. –†–µ–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ API (—ç—Ç–æ –∑–∞–π–º–µ—Ç 10-20 —Å–µ–∫)
        // –í —ç—Ç–æ –≤—Ä–µ–º—è –∫—Ä—É—Ç–∏—Ç—Å—è –∞–Ω–∏–º–∞—Ü–∏—è
        const result = await API.send('scan', { image: base64, userText: userText });
        
        // 4. –ï—Å–ª–∏ —É—Å–ø–µ—Ö - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Draft Sheet
        stopProcessingUI(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
        
        if (result.ok) {
           openDraftSheet(result.data, result.scanId);
        } else {
           throw new Error(result.error || "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
        }

    } catch (e) {
        stopProcessingUI();
        console.error(e);
        haptic('error');
        alert("–û—à–∏–±–∫–∞: " + e.message);
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º UI –∫–∞–º–µ—Ä—ã
        DOM.preview.style.display = 'flex'; 
        btn.disabled = false;
    }
  }

  function haptic(style) { 
    if (!tg || !tg.HapticFeedback) return;
    
    // –†–∞–∑–¥–µ–ª—è–µ–º —Ç–∏–ø—ã –≤–∏–±—Ä–∞—Ü–∏–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Telegram
    if (['error', 'success', 'warning'].includes(style)) {
      tg.HapticFeedback.notificationOccurred(style);
    } else {
      // light, medium, heavy, rigid, soft
      tg.HapticFeedback.impactOccurred(style);
    }
  }

  // === UI –õ–û–ì–ò–ö–ê: –ê–ù–ò–ú–ê–¶–ò–Ø –ü–†–û–¶–ï–°–°–ê (Smart Routing) ===
  let procInterval;
  
  function startProcessingUI(mode) {
    const container = document.getElementById('procSteps');
    const overlay = document.getElementById('procOverlay');
    
    // 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —à–∞–≥–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
    if (mode === 'text') {
        // --- TEXT ROUTE ---
        container.innerHTML = `
            <div class="step pending" id="step-1"><div class="s-icon">üõ°Ô∏è</div><div class="s-lbl">Gatekeeper: –ü—Ä–æ–≤–µ—Ä—è—é...</div></div>
            <div class="step pending" id="step-2"><div class="s-icon">üß†</div><div class="s-lbl">TextParser: –ò—â—É –≤ –±–∞–∑–µ...</div></div>
            <div class="step pending" id="step-3"><div class="s-icon">üìù</div><div class="s-lbl">Synthesizer: –ì–æ—Ç–æ–≤–ª—é –æ—Ç–≤–µ—Ç...</div></div>
        `;
    } else {
        // --- PHOTO ROUTE (Default Plate Flow) ---
        // –ú—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å "–¢–∞—Ä–µ–ª–∫–∏", —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ —Å–∞–º—ã–π –∫—Ä–∞—Å–∏–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π.
        // –ï—Å–ª–∏ —ç—Ç–æ –æ–∫–∞–∂–µ—Ç—Å—è –£–ø–∞–∫–æ–≤–∫–∞ (Librarian), —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—Ç–∏—Ç —Ä–∞–Ω—å—à–µ, –∏ –º—ã –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä–æ–µ–º –æ–∫–Ω–æ, —á—Ç–æ —Ç–æ–∂–µ –æ–∫.
        container.innerHTML = `
            <div class="step pending" id="step-1"><div class="s-icon">üõ°Ô∏è</div><div class="s-lbl">Gatekeeper: –ü—Ä–æ–≤–µ—Ä—è—é...</div></div>
            <div class="step pending" id="step-2"><div class="s-icon">üïµÔ∏è</div><div class="s-lbl">Detective: –ò—â—É –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã...</div></div>
            <div class="step pending" id="step-3"><div class="s-icon">üìê</div><div class="s-lbl">Physicist: –û–ø—Ä–µ–¥–µ–ª—è—é –≤–µ—Å...</div></div>
            <div class="step pending" id="step-4"><div class="s-icon">üç≥</div><div class="s-lbl">Technologist: –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...</div></div>
            <div class="step pending" id="step-5"><div class="s-icon">üìù</div><div class="s-lbl">Synthesizer: –ì–æ—Ç–æ–≤–ª—é –æ—Ç–≤–µ—Ç...</div></div>
        `;
    }

    overlay.classList.add('active');
    
    // 2. –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —à–∞–≥–æ–≤
    let step = 1;
    const maxSteps = mode === 'text' ? 3 : 5;
    
    updateStep(1, 'active');

    procInterval = setInterval(() => {
       updateStep(step, 'done');
       step++;
       if(step > maxSteps) step = maxSteps; 
       updateStep(step, 'active');
    }, 2000); // –ß—É—Ç—å –±—ã—Å—Ç—Ä–µ–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –¥–ª—è –¥–∏–Ω–∞–º–∏–∫–∏
  }

  function updateStep(num, status) {
    const el = document.getElementById('step-'+num);
    if(el) {
      el.classList.remove('pending', 'active', 'done');
      el.classList.add(status);
    }
  }

  function stopProcessingUI() {
    clearInterval(procInterval);
    document.getElementById('procOverlay').classList.remove('active');
  }

  function cancelProcessing() {
    stopProcessingUI();
    retake();
  }

  // === UI –õ–û–ì–ò–ö–ê: DRAFT SHEET (–í–ê–õ–ò–î–ê–¶–ò–Ø) ===
  let currentDraftItems = []; // –ó–¥–µ—Å—å —Ö—Ä–∞–Ω–∏–º —Ç–æ, —á—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —é–∑–µ—Ä
  let currentScanId = null;

  function openDraftSheet(data, scanId) {
    currentScanId = scanId;
    // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –∏–ª–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
    if (!data || !data.items) {
       alert("–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
       return;
    }
    
    currentDraftItems = data.items; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–∞–º—è—Ç—å
    renderDraftList();
    
    document.getElementById('draftOverlay').classList.add('visible');
    haptic('success');
    document.getElementById('focusOverlay').classList.add('active');
  }

  function renderDraftList() {
    const container = document.getElementById('draftList');
    container.innerHTML = '';
    
    if (currentDraftItems.length === 0) {
      container.innerHTML = '<div style="text-align:center; opacity:0.5; padding:20px">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>';
      return;
    }

    currentDraftItems.forEach((item, index) => {
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∫–æ–Ω–∫—É –ø–æ —Ç–∏–ø—É (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏–∫—É)
      let icon = "üçΩÔ∏è";
      if (item.cooking_method === 'Raw') icon = "üçé";
      if (item.fat_modifier === 'High Oil') icon = "üç≥";
      
      const div = document.createElement('div');
      div.className = 'draft-item';
      div.innerHTML = `
        <div class="di-icon">${icon}</div>
        <div class="di-inputs">
          <input type="text" class="di-name" value="${item.name}" onchange="updateDraftItem(${index}, 'name', this.value)">
          <div class="di-row">
            <input type="number" class="di-weight" value="${item.weight_g || ''}" placeholder="0" onchange="updateDraftItem(${index}, 'weight_g', this.value)">
            <div class="di-unit">–≥</div>
          </div>
        </div>
        <div class="di-del" onclick="removeDraftItem(${index})">
        <div class="gh-icon" style="-webkit-mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/trash.svg'); mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/trash.svg');"></div>
        </div>
      `;
      container.appendChild(div);
    });
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å—Ç–µ–π—Ç–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ
  window.updateDraftItem = (index, field, value) => {
    if (field === 'weight_g') value = parseInt(value) || 0;
    currentDraftItems[index][field] = value;
  };

  window.removeDraftItem = (index) => {
    currentDraftItems.splice(index, 1);
    renderDraftList();
  };

  window.closeDraft = () => {
    document.getElementById('draftOverlay').classList.remove('visible');
    document.getElementById('focusOverlay').classList.remove('active');
    retake(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–∞–º–µ—Ä—É
  };

  
// === 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –°–¢–ï–ô–¢ (–ú–û–ó–ì) ===
  const STORAGE_KEY = 'ultima_diary_v1';
  const STATS_CACHE_KEY = 'ultima_stats_cache_v1';
  
  // –ö—ç—à —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –¥–Ω—è–º: { "Sun Dec 14 2025": { norms:..., facts:... } }
  let StatsCache = {}; 
  // –¢–µ–∫—É—â–∞—è –≤—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è)
  let CurrentViewDate = new Date(); 

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∫—ç—à–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  function initStatsManager() {
    try {
      const raw = localStorage.getItem(STATS_CACHE_KEY);
      if (raw) StatsCache = JSON.parse(raw);
    } catch(e) {}
  }

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫—ç—à–∞
  function saveStatsCache() {
    localStorage.setItem(STATS_CACHE_KEY, JSON.stringify(StatsCache));
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–∞—Ç—ã (–∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –Ω—É–ª–µ–π)
  function getStatsForDate(dateObj) {
    const key = dateObj.toDateString(); 
    if (StatsCache[key]) return StatsCache[key];
    // –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ü–µ–ª–∏
    return {
       norms: { k: 2500, p: 160, f: 80, c: 300, w: 2500 },
       facts: { k: 0, p: 0, f: 0, c: 0, w: 0 }
    };
  }

  // –õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI (–û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–π UI)
  function updateLocalStats(dateObj, type, payload) {
     const dateKey = dateObj.toDateString();
     
     // –ï—Å–ª–∏ –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞–µ–º
     if (!StatsCache[dateKey]) StatsCache[dateKey] = getStatsForDate(dateObj);
     
     const current = StatsCache[dateKey];

     if (type === 'water') {
        current.facts.w = payload.amount;
     } else if (type === 'food') {
        current.facts.k += payload.k || 0;
        current.facts.p += payload.p || 0;
        current.facts.f += payload.f || 0;
        current.facts.c += payload.c || 0;
     }
     
     saveStatsCache();
     // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã —Å–º–æ—Ç—Ä–∏–º –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å
     if (dateKey === CurrentViewDate.toDateString()) {
        renderWidgets();
     }
  }

  
  // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º (–§–æ–Ω–æ–≤–∞—è)
  async function syncStatsFromServer(dateObj) {
    const dateKey = dateObj.toDateString();
    try {
      const res = await API.send('get_day_stats', { dateStr: dateObj.toISOString() });
      
      if (res.ok && res.data) {
         // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –¶–ò–§–†–´ (–í–∏–¥–∂–µ—Ç—ã)
         StatsCache[dateKey] = res.data;
         saveStatsCache();
         
         if (CurrentViewDate.toDateString() === dateKey) {
            renderWidgets();
            
            // 2. üî• –ù–û–í–û–ï: –ï—Å–ª–∏ –ø—Ä–∏—à–ª–∏ –ø—Ä–æ–¥—É–∫—Ç—ã ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –õ–ï–ù–¢–£
            // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ items –µ—Å—Ç—å –∏ –æ–Ω –Ω–µ –ø—É—Å—Ç–æ–π ‚Äî –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ª–µ–Ω—Ç—É –¥–∞–Ω–Ω—ã–º–∏ —Å–µ—Ä–≤–µ—Ä–∞
            if (res.data.items && res.data.items.length > 0) {
                renderServerItemsToTimeline(res.data.items);
            }
         }
      }
    } catch (e) {
      console.warn("Sync failed:", e);
    }
  }


  // === 2. –ï–î–ò–ù–´–ô –†–ï–ù–î–ï–† –í–ò–î–ñ–ï–¢–û–í ===
  // === 2. –ï–î–ò–ù–´–ô –†–ï–ù–î–ï–† –í–ò–î–ñ–ï–¢–û–í (–ò–°–ü–†–ê–í–õ–ï–ù–û –û–ö–†–£–ì–õ–ï–ù–ò–ï) ===
  function renderWidgets() {
    // –ë–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¢–ï–ö–£–©–ï–ô –í–´–ë–†–ê–ù–ù–û–ô –î–ê–¢–´
    const data = getStatsForDate(CurrentViewDate);
    const n = data.norms;
    const f = data.facts;

    // --- –û–±–Ω–æ–≤–ª—è–µ–º –ö–ë–ñ–£ ---
    updateDonutUI('kcal', f.k, n.k);
    updateDonutUI('prot', f.p, n.p);
    updateDonutUI('fats', f.f, n.f);
    updateDonutUI('carb', f.c, n.c);

    // --- –û–±–Ω–æ–≤–ª—è–µ–º –í–æ–¥—É ---
    currentMl = f.w; 
    
    const elFact = document.getElementById('lbl-fact');
    if(elFact) elFact.innerText = Math.round(f.w); // –û–∫—Ä—É–≥–ª—è–µ–º —Ñ–∞–∫—Ç
    
    const elPct = document.getElementById('lbl-pct');
    // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–µ–ª–µ–Ω–∏—è –Ω–∞ 0 –∏ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–∞
    const safeTarget = n.w > 0 ? n.w : 1;
    if(elPct) elPct.innerText = Math.round((f.w / safeTarget) * 100) + '%';
    
    const card = document.getElementById('waterCard');
    if (card) {
        if (f.w > n.w) card.classList.add('is-overload');
        else card.classList.remove('is-overload');
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–±–∏—Ä–∫–∏
    for(let i=1; i<=5; i++) { 
      const el = document.getElementById('c'+i); 
      if(el) {
          const step = n.w / 5;
          let pct = 0;
          if (f.w >= i * step) pct = 100;
          else if (f.w > (i-1) * step) pct = ((f.w - (i-1)*step) / step) * 100;
          el.style.setProperty('--h', Math.min(100, Math.max(0, pct)) + '%'); 
      }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–¥–ø–∏—Å—å —Ü–µ–ª–∏ (–û–ö–†–£–ì–õ–Ø–ï–ú)
    const planLabel = document.querySelector('.wf-plan');
    if(planLabel) planLabel.innerText = `–¶–µ–ª—å: ${Math.round(n.w)}`;
  }

  // –ü–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∫—Ä—É–≥–æ–≤—ã—Ö –¥–∏–∞–≥—Ä–∞–º–º (–ò–°–ü–†–ê–í–õ–ï–ù–û –û–ö–†–£–ì–õ–ï–ù–ò–ï)
  function updateDonutUI(idSuffix, val, max) {
     const elNum = document.getElementById('val-' + idSuffix);
     const elCircle = document.getElementById('circle-' + idSuffix);
     
     // –í–ê–ñ–ù–û: –î–æ–±–∞–≤–ª–µ–Ω–æ Math.round(max), —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –¥—Ä–æ–±–∏
     if(elNum) elNum.innerHTML = `${Math.round(val)}<span>/${Math.round(max)}</span>`;
     
     if(elCircle) {
        const C = 151; // –î–ª–∏–Ω–∞ –æ–∫—Ä—É–∂–Ω–æ—Å—Ç–∏
        const safeMax = max > 0 ? max : 1; 
        const percent = Math.min(1, Math.max(0, val / safeMax));
        const offset = C - (percent * C);
        elCircle.style.strokeDashoffset = offset;
     }
  }


  // === 3. –õ–û–ì–ò–ö–ê –î–ï–ô–°–¢–í–ò–ô ===

  // --- –í–û–î–ê ---
  let currentMl = 0;
  let waterSyncTimer = null;
  
  window.updateWater = function(delta) {
    haptic('light');
    const newVal = Math.max(0, currentMl + delta);
    
    // 1. –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º UI –∏ –ö—ç—à
    updateLocalStats(CurrentViewDate, 'water', { amount: newVal });
    
    // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π)
    if (waterSyncTimer) clearTimeout(waterSyncTimer);
    waterSyncTimer = setTimeout(() => {
       API.send('save_water', { 
         amount: newVal, 
         dateStr: CurrentViewDate.toISOString() // –í–∞–∂–Ω–æ: —à–ª–µ–º –¥–∞—Ç—É!
       }).catch(console.error);
    }, 2000);
  };

  // --- –°–û–•–†–ê–ù–ï–ù–ò–ï –ï–î–´ (Save Meal) ---
  window.confirmDraftToNutritionist = async () => {
    const btn = document.getElementById('btnConfirmDraft');
    const originalText = btn.textContent;
    btn.textContent = '–°—á–∏—Ç–∞—é...';
    btn.disabled = true;
    document.getElementById('focusOverlay').classList.add('active');

    try {
      // 1. –†–∞—Å—á–µ—Ç —á–µ—Ä–µ–∑ AI
      const resCalc = await API.send('calculate', { scanId: currentScanId, data: { items: currentDraftItems } });
      if (!resCalc.ok) throw new Error(resCalc.error);

     
      // 2. –°–±–æ—Ä–∫–∞ –æ–±—ä–µ–∫—Ç–∞ –µ–¥—ã —Å –£–ù–ò–ö–ê–õ–¨–ù–´–ú–ò ID
      const items = resCalc.data.items.map(i => ({
         id: Date.now() + '_' + Math.random().toString(36).substr(2, 9), // üî• –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID
         name: i.name, 
         w: i.weight_g,
         k: i.calories||i.macros?.k||0, p: i.protein||i.macros?.p||0, 
         f: i.fats||i.macros?.f||0, c: i.carbs||i.macros?.c||0
      }));
      
      const mealEntry = {
          id: Date.now(),
          date: new Date().toDateString(),
          time: new Date().toLocaleTimeString('ru-RU', {hour:'2-digit',minute:'2-digit'}),
          items: items
      };

      // 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ª–µ–Ω—Ç—É
      saveToStorage(mealEntry);
      
      // 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–æ–≤ (–°–ï–ì–û–î–ù–Ø–®–ù–ò–•)
      let sum = { k:0, p:0, f:0, c:0 };
      items.forEach(i => { sum.k+=i.k; sum.p+=i.p; sum.f+=i.f; sum.c+=i.c; });
      updateLocalStats(new Date(), 'food', sum); 
      
      // 5. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –ë–î
      API.send('save_meal', { meal_data: mealEntry }).catch(console.error);
      
      haptic('success');
      closeDraft();
      addMealToTimeline(mealEntry);

    } catch (e) {
      alert("–û—à–∏–±–∫–∞: " + e.message);
    } finally {
      btn.textContent = originalText;
      btn.disabled = false;
      document.getElementById('focusOverlay').classList.remove('active');
    }
  };


  // === 4. –õ–ï–ù–¢–ê –ò–°–¢–û–†–ò–ò (TIMELINE) ===
  function addMealToTimeline(mealEntry) {
    const container = document.getElementById('mealTimeline');
    if (!container) return;
    
    let rowsHTML = '';
    mealEntry.items.forEach(item => {
        rowsHTML += `
        <div class="prod-item">
            <div class="pi-name">${item.name}</div>
            <div class="pi-val pi-w">${item.w}</div>
            <div class="pi-val pi-k">${item.k}</div>
            <div class="pi-val pi-p">${item.p}</div>
            <div class="pi-val pi-f">${item.f}</div>
            <div class="pi-val pi-c">${item.c}</div>
        </div>`;
    });

    // üî• –î–û–ë–ê–í–õ–ï–ù –ö–ê–†–ê–ù–î–ê–® –í –ó–ê–ì–û–õ–û–í–û–ö
    // –ú—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º JSON –≤—Å–µ–≥–æ –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏ –≤ –∞—Ç—Ä–∏–±—É—Ç, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –µ–≥–æ –ø—Ä–∏ –∫–ª–∏–∫–µ
    const safeData = encodeURIComponent(JSON.stringify(mealEntry));
    
    const cardHTML = `
      <div class="meal-card" id="card-${mealEntry.id}">
        <div class="col-headers">
            <div class="mh-header-row">
               <div class="mh-time">${mealEntry.time}</div>
               <div class="edit-btn" onclick="openEditMeal('${safeData}')">
                 <div class="gh-icon" style="-webkit-mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/pencil.svg'); mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/pencil.svg');"></div>
               </div>
            </div>
            <div class="ch-item">–í–µ—Å</div>
            <div class="ch-item">–ö</div>
            <div class="ch-item">–ë</div>
            <div class="ch-item">–ñ</div>
            <div class="ch-item">–£</div>
        </div>
        ${rowsHTML}
      </div>`;
    container.insertAdjacentHTML('afterbegin', cardHTML);
  }

  function saveToStorage(mealEntry) {
      try {
          const raw = localStorage.getItem(STORAGE_KEY);
          const history = raw ? JSON.parse(raw) : [];
          history.push(mealEntry);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
      } catch(e) {}
  }

  function loadFromStorage(targetDate) {
      const container = document.getElementById('mealTimeline');
      if (!container) return;
      container.innerHTML = '';

      try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return;
          const history = JSON.parse(raw);
          const filterStr = (targetDate || new Date()).toDateString();
          const dailyMeals = history.filter(m => {
              const entryDate = m.date || new Date(m.id).toDateString();
              return entryDate === filterStr;
          });
          dailyMeals.forEach(meal => addMealToTimeline(meal));
      } catch(e) {}
  }


  // === –ü–†–ï–í–†–ê–©–ê–ï–ú –°–ü–ò–°–û–ö –° –°–ï–†–í–ï–†–ê –í –ö–ê–†–¢–û–ß–ö–ò –ò –°–û–•–†–ê–ù–Ø–ï–ú ===
  function renderServerItemsToTimeline(serverItems) {
      const container = document.getElementById('mealTimeline');
      if (!container) return;
      
      container.innerHTML = '';
      
      // 1. –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏
      const groups = {};
      serverItems.forEach(item => {
          const time = item.t || '00:00';
          if (!groups[time]) groups[time] = [];
          groups[time].push(item);
      });

      const sortedTimes = Object.keys(groups).sort();
      const mealsToSave = []; // –°—é–¥–∞ —Å–æ–±–µ—Ä–µ–º –≥–æ—Ç–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã –¥–ª—è –ø–∞–º—è—Ç–∏

      // 2. –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
      sortedTimes.forEach(time => {
          const itemsInGroup = groups[time];
          
          // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º —Ñ–æ—Ä–º–∞—Ç —Å–µ—Ä–≤–µ—Ä–∞ –≤ —Ñ–æ—Ä–º–∞—Ç —Ñ—Ä–æ–Ω—Ç–∞, –°–û–•–†–ê–ù–Ø–Ø ID
          const mappedItems = itemsInGroup.map(i => ({
              id: i.id || ('legacy_' + Math.random()), // –ï—Å–ª–∏ ID –Ω–µ—Ç (—Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏), —Å–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π
              name: i.n,
              w: i.w,
              k: i.m.k, p: i.m.p, f: i.m.f, c: i.m.c
          }));

          const syntheticMeal = {
              id: Date.now() + Math.random(), // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID
              date: CurrentViewDate.toDateString(), // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ –¥–∞—Ç–µ
              time: time,
              items: mappedItems
          };
          
          mealsToSave.push(syntheticMeal);
          addMealToTimeline(syntheticMeal);
      });

      // 3. üî• –í–ê–ñ–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ –≤ –ø–∞–º—è—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (localStorage)
      updateStorageWithServerData(mealsToSave);
  }

  // –ü–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏
  function updateStorageWithServerData(newMealsForDay) {
      try {
          const raw = localStorage.getItem(STORAGE_KEY);
          let history = raw ? JSON.parse(raw) : [];
          const targetDateStr = CurrentViewDate.toDateString();

          // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å (—á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å)
          history = history.filter(m => {
              const mDate = m.date || new Date(m.id).toDateString();
              return mDate !== targetDateStr;
          });

          // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤–µ–∂–∏–µ –∑–∞–ø–∏—Å–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
          history = history.concat(newMealsForDay);
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ
          localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
      } catch(e) { console.error("Save fail", e); }
  }

  // === 5. –ö–ê–õ–ï–ù–î–ê–†–¨ (–°–í–Ø–ó–ö–ê –í–°–ï–ì–û) ===
  let currentWeekStart = getStartOfWeek(new Date()); 
  let selectedDate = new Date(); 
  let isDragging = false, startX = 0, currentTranslate = 0;
  
  const area = document.getElementById('swipeArea'); 
  const track = document.getElementById('calTrack'); 
  const prevEl = document.getElementById('weekPrev'); 
  const currEl = document.getElementById('weekCurr'); 
  const nextEl = document.getElementById('weekNext');

  function getStartOfWeek(date) { 
    const d = new Date(date); 
    const day = d.getDay(); 
    const diff = d.getDate() - day + (day === 0 ? -6 : 1); 
    return new Date(d.setDate(diff)); 
  }

  function initCalendar() { 
    renderAllWeeks(); 
    area.onpointerdown = handleStart; 
    area.onpointermove = handleMove; 
    area.onpointerup = handleEnd; 
    area.onpointercancel = handleEnd; 
    area.onpointerleave = handleEnd; 
  }

  function renderWeekData(container, startDate) {
    container.innerHTML = ''; 
    const weekDays = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å']; 
    const today = new Date();
    
    for(let i=0; i<7; i++) {
      const d = new Date(startDate); 
      d.setDate(d.getDate() + i); 
      
      const isToday = d.toDateString() === today.toDateString(); 
      const isSelected = d.toDateString() === CurrentViewDate.toDateString();
      
      const el = document.createElement('div'); 
      el.className = `day-cell ${isSelected ? 'selected' : ''} ${isToday ? 'is-today' : ''}`; 
      el.innerHTML = `<div class="dc-name">${weekDays[i]}</div><div class="dc-num">${d.getDate()}</div>`;
      
      // === –ì–õ–ê–í–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–õ–ò–ö–ê –ü–û –î–ê–¢–ï ===
      el.onclick = () => { 
          if(Math.abs(currentTranslate) > 5) return; 
          
          // 1. –ú–µ–Ω—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –¥–∞—Ç—É
          CurrentViewDate = new Date(d); 
          selectedDate = new Date(d); // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
          
          // 2. –†–∏—Å—É–µ–º –≤–∏–¥–∂–µ—Ç—ã –∏–∑ –∫—ç—à–∞ (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ)
          renderWidgets();
          
          // 3. –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –ª–µ–Ω—Ç—É –µ–¥—ã
          loadFromStorage(CurrentViewDate);

          // 4. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ (–≤ —Ñ–æ–Ω–µ)
          syncStatsFromServer(CurrentViewDate);
          
          // –í–∏–∑—É–∞–ª
          document.querySelectorAll('.day-cell').forEach(c => c.classList.remove('selected')); 
          el.classList.add('selected'); 
          haptic('selection'); 
      }; 
      container.appendChild(el);
    }
  }

  function renderAllWeeks() { 
    renderWeekData(currEl, currentWeekStart); 
    const dPrev = new Date(currentWeekStart); dPrev.setDate(dPrev.getDate() - 7); 
    renderWeekData(prevEl, dPrev); 
    const dNext = new Date(currentWeekStart); dNext.setDate(dNext.getDate() + 7); 
    renderWeekData(nextEl, dNext); 
    
    const mid = new Date(currentWeekStart); mid.setDate(mid.getDate() + 3); 
    document.getElementById('monthLabel').textContent = mid.toLocaleString('ru', { month: 'long', year: 'numeric' }); 
  }

  function handleStart(e) { 
    if (e.button !== 0) return; isDragging = true; startX = e.clientX; currentTranslate = 0; 
    track.style.transition = 'none'; area.style.cursor = 'grabbing'; 
  }
  function handleMove(e) { 
    if (!isDragging) return; currentTranslate = e.clientX - startX; 
    track.style.transform = `translateX(calc(-33.333333% + ${currentTranslate}px))`; 
  }
  function handleEnd(e) { 
    if (!isDragging) return; isDragging = false; area.style.cursor = 'grab'; const threshold = 60; 
    track.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)'; 
    if (currentTranslate > threshold) { haptic('light'); track.style.transform = `translateX(0%)`; setTimeout(() => shiftWeeks(-1), 300); } 
    else if (currentTranslate < -threshold) { haptic('light'); track.style.transform = `translateX(-66.666666%)`; setTimeout(() => shiftWeeks(1), 300); } 
    else { track.style.transform = `translateX(-33.333333%)`; } 
  }
  function shiftWeeks(dir) { 
    currentWeekStart.setDate(currentWeekStart.getDate() + (dir * 7)); 
    track.style.transition = 'none'; renderAllWeeks(); track.style.transform = `translateX(-33.333333%)`; 
  }

  // === –ó–ê–ü–£–°–ö ===
  initStatsManager();  // 1. –ì—Ä—É–∑–∏–º –∫—ç—à
  renderWidgets();     // 2. –†–∏—Å—É–µ–º —á—Ç–æ –µ—Å—Ç—å
  initCalendar();      // 3. –†–∏—Å—É–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
  loadFromStorage(new Date()); // 4. –ì—Ä—É–∑–∏–º –ª–µ–Ω—Ç—É
  
  // 5. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
  syncStatsFromServer(new Date());

  // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
  document.addEventListener('click', (e) => {
    const active = document.activeElement;
    const isInput = active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA');
    if (isInput && e.target !== active) active.blur();
  });

// === –õ–û–ì–ò–ö–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ò –£–î–ê–õ–ï–ù–ò–Ø ===
  
  let editingMeal = null; // –¢–µ–∫—É—â–∏–π —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π –ø—Ä–∏–µ–º –ø–∏—â–∏

  // 1. –û—Ç–∫—Ä—ã—Ç–∏–µ —à—Ç–æ—Ä–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  window.openEditMeal = (encodedData) => {
      try {
          const meal = JSON.parse(decodeURIComponent(encodedData));
          editingMeal = meal;
          
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ —à—Ç–æ—Ä–∫—É Draft, –Ω–æ –º–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
          document.querySelector('.ds-title').innerText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ";
          document.querySelector('.ds-subtitle').innerText = `–ü—Ä–∏–µ–º –ø–∏—â–∏ –≤ ${meal.time}`;
          
          // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–í –¥–Ω–µ–≤–Ω–∏–∫", –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ "–ì–æ—Ç–æ–≤–æ"
          document.getElementById('btnConfirmDraft').classList.add('hidden');
          const cancelBtn = document.querySelector('.ds-btn.sec');
          cancelBtn.innerText = "–ì–æ—Ç–æ–≤–æ";
          cancelBtn.onclick = closeDraft; // –ü—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã—Ç—å

          renderEditList(meal.items);
          
          document.getElementById('draftOverlay').classList.add('visible');
          document.getElementById('focusOverlay').classList.add('active');
          haptic('selection');
      } catch(e) { console.error(e); }
  };

  // 2. –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ —Å –ö–û–†–ó–ò–ù–û–ô
  function renderEditList(items) {
      const container = document.getElementById('draftList');
      container.innerHTML = '';
      
      items.forEach(item => {
          const div = document.createElement('div');
          div.className = 'draft-item';
          // –ë–ª–æ–∫–∏—Ä—É–µ–º –∏–Ω–ø—É—Ç—ã (read-only), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —É–¥–∞–ª–µ–Ω–∏–µ
          div.innerHTML = `
            <div class="di-icon">üçΩÔ∏è</div>
            <div class="di-inputs">
              <div class="di-name" style="opacity:0.8">${item.name}</div>
              <div class="di-row">
                <span style="color:#fff; font-weight:700; margin-left:4px">${item.w} –≥</span>
              </div>
            </div>
            <div class="di-del is-trash" onclick="deleteItem('${item.id}')">
               <div class="gh-icon" style="-webkit-mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/trash.svg'); mask-image: url('https://cdn.jsdelivr.net/gh/groskaiser-design/icons@main/trash.svg');"></div>
            </div>
          `;
          container.appendChild(div);
      });
  }

  // 3. –£–î–ê–õ–ï–ù–ò–ï (–û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê)
  window.deleteItem = (itemId) => {
      if (!editingMeal) return;
      
      // –ê) –ù–∞—Ö–æ–¥–∏–º –ø—Ä–æ–¥—É–∫—Ç, —á—Ç–æ–±—ã –≤—ã—á–µ—Å—Ç—å –µ–≥–æ —Ü–∏—Ñ—Ä—ã
      const itemIndex = editingMeal.items.findIndex(i => i.id === itemId);
      if (itemIndex === -1) return;
      const item = editingMeal.items[itemIndex];

      haptic('warning');

      // –ë) –í—ã—á–∏—Ç–∞–µ–º –∏–∑ –≤–∏–¥–∂–µ—Ç–æ–≤ (–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ)
      // –í–Ω–∏–º–∞–Ω–∏–µ: –ø–µ—Ä–µ–¥–∞–µ–º –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è!
      updateLocalStats(CurrentViewDate, 'food', {
          k: -item.k, p: -item.p, f: -item.f, c: -item.c
      });

      // –í) –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞ –≤ –ø–∞–º—è—Ç–∏
      editingMeal.items.splice(itemIndex, 1);
      
      // –ì) –û–±–Ω–æ–≤–ª—è–µ–º UI —à—Ç–æ—Ä–∫–∏
      if (editingMeal.items.length === 0) {
          closeDraft(); // –ï—Å–ª–∏ –ø—É—Å—Ç–æ, –∑–∞–∫—Ä—ã–≤–∞–µ–º
      } else {
          renderEditList(editingMeal.items); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
      }

      // –î) –û–±–Ω–æ–≤–ª—è–µ–º localStorage –∏ –õ–µ–Ω—Ç—É
      // –ù–∞–º –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ —ç—Ç–æ—Ç –ø—Ä–∏–µ–º –ø–∏—â–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –∏ –æ–±–Ω–æ–≤–∏—Ç—å –µ–≥–æ
      updateStorageAfterDelete(editingMeal);

      // –ï) üî• –û–¢–ü–†–ê–í–õ–Ø–ï–ú –ó–ê–ü–†–û–° –ù–ê –ë–≠–ö–ï–ù–î
      API.send('delete_item', { 
          dateStr: CurrentViewDate.toISOString(),
          itemId: itemId
      }).catch(console.error);
  };

  function updateStorageAfterDelete(updatedMeal) {
      try {
          const raw = localStorage.getItem(STORAGE_KEY);
          let history = raw ? JSON.parse(raw) : [];
          
          // –ï—Å–ª–∏ –≤ –ø—Ä–∏–µ–º–µ –ø–∏—â–∏ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å –ø—Ä–æ–¥—É–∫—Ç–æ–≤ - —É–¥–∞–ª—è–µ–º –µ–≥–æ —Ü–µ–ª–∏–∫–æ–º
          if (updatedMeal.items.length === 0) {
              history = history.filter(m => {
                  // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –¥–∞—Ç–µ, —Ç–∞–∫ –∫–∞–∫ ID —É –Ω–∞—Å —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–µ –≤ –ª–µ–Ω—Ç–µ
                  const sameDay = (m.date || new Date(m.id).toDateString()) === updatedMeal.date;
                  const sameTime = m.time === updatedMeal.time;
                  return !(sameDay && sameTime);
              });
          } else {
              // –ò–Ω–∞—á–µ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–∞–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
              history = history.map(m => {
                  const sameDay = (m.date || new Date(m.id).toDateString()) === updatedMeal.date;
                  const sameTime = m.time === updatedMeal.time;
                  if (sameDay && sameTime) {
                      return updatedMeal; // –ó–∞–º–µ–Ω—è–µ–º –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π
                  }
                  return m;
              });
          }
          
          localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
          
          // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ª–µ–Ω—Ç—É —Ü–µ–ª–∏–∫–æ–º
          loadFromStorage(CurrentViewDate);
          
      } catch(e) { console.error(e); }
  }

</script>
</body>
</html>