<!DOCTYPE html>
<html lang="ru">
<head>
<script src="version-control.js?t=1"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
<title>Ultima Scanner v2.20</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  /* === 1. CORE & RESET === */
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
  *::-webkit-scrollbar { display: none; width: 0; height: 0; background: transparent; }
  * { scrollbar-width: none; }
  
  :root {
    --bg-core: #050505;
    --text-main: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.55);
    --surface-glass: rgba(255, 255, 255, 0.07);
    --surface-border: rgba(255, 255, 255, 0.1);
    
    --acc-green: #30d158;
    --acc-blue: #0a84ff;
    --acc-yellow: #ffcc00;
    --acc-red: #ff453a;
    --acc-over: #00f2ea;
    --acc-over-glow: rgba(0, 242, 234, 0.6);
    --acc-orange: #ff9f0a;
  
    --radius-xl: 28px;
    --radius-l: 22px;
    
    --safe-top: calc(12px + env(safe-area-inset-top));
    --safe-bottom: calc(12px + env(safe-area-inset-bottom));
    
    --header-height: 340px; 
    --font-stack: -apple-system, BlinkMacSystemFont, 'SF Pro Text', Roboto, sans-serif;
  }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

  /* === FIX FROM AI.HTML: BODY IS STATIC BACKGROUND === */
  html, body {
    background-color: var(--bg-core);
    margin: 0; padding: 0; width: 100%; height: 100vh;
    overflow: hidden; 
    color: var(--text-main);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Roboto', sans-serif;
    position: fixed; top: 0; left: 0; /* Dead fix */
    -webkit-font-smoothing: antialiased; 
    font-family: var(--font-stack);
    display: flex; flex-direction: column;
    overscroll-behavior-y: none;
  }

  /* FX BACKGROUND (Behind everything) */
  .fx-layer { 
    position: fixed; 
    top: 0; left: 0; width: 100%; 
    /* –í—ã—Å–æ—Ç–∞ –±—É–¥–µ—Ç –∑–∞–¥–∞–Ω–∞ –∂–µ—Å—Ç–∫–æ —á–µ—Ä–µ–∑ JS, —á—Ç–æ–±—ã –Ω–µ –ø—Ä—ã–≥–∞–ª–∞ */
    height: 100vh; 
    z-index: 0; 
    pointer-events: none; 
  }
  .orb { position: absolute; border-radius: 50%; will-change: transform; animation: float 30s infinite linear; }
  .orb-1 { width: 90vw; height: 90vw; opacity: 0.4; background: radial-gradient(circle, rgba(108, 92, 231, 0.8) 0%, transparent 70%); top: -20%; left: -20%; }
  .orb-2 { width: 400px; height: 400px; opacity: 0.5; background: radial-gradient(circle, rgba(10, 132, 255, 0.6) 0%, transparent 70%); bottom: -150px; right: -100px; animation: breathe 6s infinite ease-in-out; }
  .noise { position: fixed; inset: 0; opacity: 0.04; background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); pointer-events: none; }
  @keyframes float { 0% {transform:rotate(0deg)} 100% {transform:rotate(360deg)} }
  @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.4; } 50% { transform: scale(1.1); opacity: 0.6; } }

  /* === MAIN APP CONTAINER (The one that resizes) === */
  .app-layout {
    position: relative; 
    z-index: 1; 
    top: 0; left: 0; right: 0;
    height: 100%; /* Will be set by JS */
    width: 100%;
    overflow: hidden;
    display: flex; 
    flex-direction: column;
  }

  /* === HEADER (Absolute inside App Layout) === */
  .fixed-header-group {
    position: absolute; 
    top: 0; left: 0; right: 0;
    z-index: 50;
    background: linear-gradient(180deg, rgba(5,5,5,0.95) 0%, rgba(5,5,5,0.85) 70%, rgba(5,5,5,0) 100%);
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    padding-bottom: 0px; 
    overscroll-behavior: none;
  }

  /* === 2. INFINITE CALENDAR === */
  .calendar-block {
    padding-top: var(--safe-top);
    padding-bottom: 8px;
    user-select: none;
    overflow: hidden;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .calendar-header { display: flex; align-items: center; justify-content: space-between; padding: 0 16px 8px 16px; }
  .month-label { font-size: 11px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.9; }
  
  .calendar-swipe-area { width: 100%; height: 52px; overflow: hidden; position: relative; touch-action: pan-y; cursor: grab; }
  .calendar-track { display: flex; width: 300%; height: 100%; transform: translateX(-33.333333%); will-change: transform; }
  .calendar-week { flex: 1; display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; height: 100%; padding: 0 10px; }

  .day-cell { height: 52px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; background: transparent; transition: background 0.2s, transform 0.1s; position: relative; cursor: pointer; user-select: none; }
  .day-cell:active { transform: scale(0.92); }
  .dc-name { font-size: 9px; font-weight: 600; color: var(--text-muted); margin-bottom: 3px; text-transform: uppercase; }
  .dc-num { font-size: 17px; font-weight: 600; color: #fff; font-variant-numeric: tabular-nums; }
  .day-cell.selected { background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05)); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 4px 12px rgba(0,0,0,0.2); transform: scale(1); }
  .day-cell.selected .dc-name { color: #fff; opacity: 0.8; }
  .day-cell.selected .dc-num { color: #fff; font-weight: 700; }
  .day-cell.is-today::after { content: ''; position: absolute; bottom: 5px; width: 4px; height: 4px; border-radius: 50%; background: var(--acc-blue); box-shadow: 0 0 6px var(--acc-blue); }

  /* === 3. WIDGETS === */
  .carousel-wrap { padding: 0; }
  .carousel-track { display: flex; gap: 12px; padding: 30px 16px 40px 16px; overflow-x: auto; scroll-snap-type: x mandatory; cursor: grab; scrollbar-width: none; }
  .widget { flex: 0 0 calc(100% - 16px); scroll-snap-align: center; height: 160px; border-radius: var(--radius-xl); background: linear-gradient(165deg, rgba(255,255,255,0.09) 0%, rgba(255,255,255,0.02) 100%); border: 1px solid var(--surface-border); border-top: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); position: relative; overflow: hidden; padding: 16px 12px; transition: 0.3s ease; }
  .widget.is-overload { box-shadow: 0 10px 40px -5px rgba(0, 242, 234, 0.25); border-color: rgba(0, 242, 234, 0.3); }

  /* Macros */
  .macros-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; height: 100%; align-items: center; }
  .macro-item { display: flex; flex-direction: column; align-items: center; justify-content: center; }
  .donut-box { width: 100%; max-width: 74px; aspect-ratio: 1; position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; }
  .mini-donut { width: 100%; height: 100%; transform: rotate(-90deg); filter: drop-shadow(0 4px 8px rgba(0,0,0,0.25)); }
  .md-bg { fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 7; }
  .md-val { fill: none; stroke-width: 7; stroke-linecap: round; stroke-dasharray: 151; transition: stroke-dashoffset 1s ease; }
  .m-icon { position: absolute; font-size: 20px; }
  .m-data { display: flex; flex-direction: column; align-items: center; }
  .m-nums { font-size: 13px; font-weight: 800; color: #fff; font-variant-numeric: tabular-nums; }
  .m-nums span { color: rgba(255,255,255,0.45); font-size: 11px; margin-left: 1px; }
  .m-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; color: rgba(255,255,255,0.5); margin-top: 2px; }
  
  .stroke-kcal { stroke: url(#grad-kcal); }
  .stroke-prot { stroke: url(#grad-prot); }
  .stroke-fats { stroke: url(#grad-fats); }
  .stroke-carb { stroke: url(#grad-carb); }

  /* Water */
  .widget.water-widget { display: flex; flex-direction: column; padding: 16px 20px; justify-content: space-between; }
  .water-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
  .water-title { font-size: 11px; font-weight: 800; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-muted); opacity: 0.8; }
  .water-percent { font-size: 12px; font-weight: 700; color: var(--acc-blue); transition: color 0.3s; }
  .widget.is-overload .water-percent { color: var(--acc-over); text-shadow: 0 0 8px var(--acc-over-glow); }
  .water-cols { display: flex; justify-content: space-between; align-items: flex-end; height: 50px; gap: 6px; margin: 8px 0; }
  .water-tube { flex: 1; height: 100%; background: rgba(0,0,0,0.4); border-radius: 6px; border: 1px solid rgba(255,255,255,0.06); position: relative; overflow: hidden; }
  .water-fill { position: absolute; bottom: 0; left: 0; right: 0; height: var(--h, 0%); background: var(--acc-blue); transition: height 0.3s cubic-bezier(0.25, 1, 0.5, 1), background-color 0.3s, box-shadow 0.3s; box-shadow: 0 0 12px rgba(10, 132, 255, 0.5); }
  .water-fill::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: rgba(255,255,255,0.6); opacity: 0.8; }
  .widget.is-overload .water-fill { background: var(--acc-over); box-shadow: 0 0 15px var(--acc-over-glow); }
  .water-footer { display: flex; justify-content: space-between; align-items: flex-end; }
  .water-info { display: flex; flex-direction: column; gap: 2px; }
  .wf-row { display: flex; align-items: baseline; gap: 4px; }
  .wf-fact { font-size: 28px; font-weight: 800; color: #fff; line-height: 1; letter-spacing: -0.5px; }
  .wf-unit { font-size: 12px; font-weight: 600; color: var(--text-muted); }
  .wf-plan { font-size: 11px; font-weight: 500; color: var(--text-muted); opacity: 0.7; }
  .water-controls { display: flex; gap: 24px; }
  .water-btn { width: 54px; height: 44px; border-radius: 14px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); color: #fff; font-size: 22px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
  .water-btn:active { background: var(--acc-blue); transform: scale(0.92); }
  .widget.is-overload .water-btn:active { background: var(--acc-over); }
  .dots { display: flex; justify-content: center; gap: 6px; margin-top: 0px; pointer-events: none; transform: translateY(-20px); }
  .dot { width: 6px; height: 6px; border-radius: 10px; background: rgba(255,255,255,0.2); transition: 0.3s; }
  .dot.active { width: 20px; background: #fff; }

  /* === 4. SCROLL CONTAINER === */
  .scroll-container {
    flex: 1; 
    overflow-y: auto; 
    -webkit-overflow-scrolling: touch;
    padding-top: var(--header-height); 
    /* Dynamic padding will be handled by JS, but keep safe default */
    padding-bottom: 120px;
    mask-image: linear-gradient(to bottom, transparent 0px, black 20px, black 100%);
    -webkit-mask-image: linear-gradient(to bottom, transparent 0px, black 20px, black 100%);
  }

  .timeline { padding: 10px 16px 0 16px; display: flex; flex-direction: column; gap: 12px; }
  
  .meal-card { 
    background: var(--surface-glass); 
    border: 1px solid var(--surface-border); 
    border-radius: var(--radius-l); 
    padding: 14px; 
    backdrop-filter: blur(12px); 
    transition: background 0.2s; 
  }
  .meal-card:active { background: rgba(255,255,255,0.1); }
  
  /* Grid Columns */
  .col-headers, .prod-item { display: grid; grid-template-columns: minmax(0, 1fr) 34px 30px 22px 22px 22px; gap: 5px; align-items: center; }
  .col-headers { margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.08); }
  .mh-time, .ch-item, .pi-name, .pi-val, .pi-w, .pi-k, .pi-p, .pi-f, .pi-c { font-size: 13px; font-weight: 400; color: #fff; font-feature-settings: "tnum"; white-space: nowrap; }
  .mh-time { text-align: left; } 
  .pi-name { overflow: hidden; text-overflow: ellipsis; }
  .ch-item, .pi-val { text-align: right; }
  .prod-item { margin-bottom: 10px; min-height: 20px; }
  .prod-item:last-child { margin-bottom: 2px; }

  /* === 5. OMNI-BAR (CHANGED: ABSOLUTE IN CONTAINER) === */
  .omni-bar { 
    position: absolute; /* CRITICAL CHANGE: Not fixed! */
    bottom: 0; left: 0; right: 0; 
    background: rgba(10, 10, 10, 0.85); 
    backdrop-filter: blur(30px); 
    border-top: 1px solid var(--surface-border); 
    padding: 8px 12px var(--safe-bottom) 12px; 
    z-index: 100; 
    display: flex; align-items: flex-end; gap: 8px; 
  }
  .icon-btn { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; }
  .input-wrap { flex: 1; min-height: 42px; background: rgba(255,255,255,0.08); border-radius: 20px; padding: 4px 16px; display: flex; align-items: center; }
  textarea { width: 100%; background: transparent; border: none; color: #fff; font-size: 15px; resize: none; font-family: inherit; padding: 10px 0; margin: 0; }
  .action-btn { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
  .mode-cam { color: #fff; }
  .mode-send { background: var(--acc-blue); color: #fff; box-shadow: 0 0 12px rgba(10,132,255,0.4); }

  /* === 6. SHEET (Outside Container, Fixed to Window) === */
  .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(4px); }
  .sheet-overlay.visible { opacity: 1; pointer-events: auto; }
  .sheet { position: fixed; bottom: 0; left: 0; right: 0; background: #151517; border-radius: 24px 24px 0 0; padding: 24px 16px calc(30px + env(safe-area-inset-bottom)) 16px; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.1, 0.7, 0.1, 1); border-top: 1px solid rgba(255,255,255,0.15); }
  .sheet-overlay.visible .sheet { transform: translateY(0); }
  .sheet-item { background: rgba(255,255,255,0.06); border-radius: 16px; padding: 16px; display: flex; align-items: center; gap: 16px; cursor: pointer; margin-bottom: 8px; }
  .sheet-item:active { background: rgba(255,255,255,0.12); }
  .sheet-icon { font-size: 24px; }
  .sheet-lbl { font-size: 16px; font-weight: 600; color: #fff; }


  /* === PROCESSING OVERLAY === */
.processing-overlay {
  position: fixed; inset: 0; z-index: 1000;
  background: rgba(5, 5, 5, 0.6); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω */
  backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); /* –¢–æ—Ç —Å–∞–º—ã–π Blur */
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: 0.4s ease;
}
.processing-overlay.active { opacity: 1; pointer-events: auto; }

.proc-card {
  width: 90%; max-width: 320px;
  background: rgba(30, 30, 30, 0.6);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 24px; padding: 30px 20px;
  display: flex; flex-direction: column; align-items: center;
  box-shadow: 0 20px 50px rgba(0,0,0,0.5);
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –û—Ä–±–∞ (–ì–ª–∞–∑ AI) */
.proc-visual { position: relative; width: 60px; height: 60px; margin-bottom: 20px; }
.proc-orb {
  position: absolute; inset: 0; border-radius: 50%;
  background: radial-gradient(circle, #0a84ff 0%, transparent 70%);
  animation: pulse-ai 2s infinite;
}
.proc-ring {
  position: absolute; inset: -10px; border-radius: 50%;
  border: 2px solid rgba(10, 132, 255, 0.3);
  border-top-color: #0a84ff;
  animation: spin-ai 1.5s infinite linear;
}
@keyframes pulse-ai { 0% { opacity: 0.5; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.5; transform: scale(0.8); } }
@keyframes spin-ai { 100% { transform: rotate(360deg); } }

.proc-title { font-size: 17px; font-weight: 700; color: #fff; margin-bottom: 20px; letter-spacing: 0.5px; }

/* –°–ø–∏—Å–æ–∫ —à–∞–≥–æ–≤ */
.proc-steps { width: 100%; display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
.step { display: flex; align-items: center; gap: 10px; opacity: 0.4; transition: 0.3s; transform: translateX(-10px); }
.step.active { opacity: 1; transform: translateX(0); font-weight: 600; }
.step.done { opacity: 0.5; transform: translateX(0); color: var(--acc-green); }
.s-icon { font-size: 14px; width: 20px; text-align: center; }
.s-lbl { font-size: 13px; color: #fff; }

.proc-close { margin-top: 10px; font-size: 13px; color: rgba(255,255,255,0.4); text-decoration: underline; cursor: pointer; }

/* === DRAFT SHEET (–í–∞–ª–∏–¥–∞—Ü–∏—è) === */
.draft-overlay {
  position: fixed; inset: 0; z-index: 1100;
  background: rgba(0,0,0,0.5);
  display: flex; flex-direction: column; justify-content: flex-end;
  opacity: 0; pointer-events: none; transition: 0.3s;
}
.draft-overlay.visible { opacity: 1; pointer-events: auto; }

.draft-sheet {
  background: #1c1c1e;
  border-radius: 24px 24px 0 0;
  border-top: 1px solid rgba(255,255,255,0.15);
  padding: 24px 20px calc(20px + env(safe-area-inset-bottom)) 20px;
  transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.1, 0.8, 0.2, 1);
  max-height: 80vh; overflow-y: auto;
}
.draft-overlay.visible .draft-sheet { transform: translateY(0); }

.ds-header { margin-bottom: 20px; }
.ds-title { font-size: 20px; font-weight: 800; margin-bottom: 4px; }
.ds-subtitle { font-size: 13px; color: var(--text-muted); line-height: 1.4; }

/* –≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ */
.draft-item {
  display: flex; align-items: center; gap: 10px;
  background: rgba(255,255,255,0.06);
  padding: 12px; border-radius: 16px; margin-bottom: 10px;
}
.di-icon { font-size: 20px; }
.di-inputs { flex: 1; display: flex; flex-direction: column; gap: 6px; }
.di-name { background: transparent; border: none; color: #fff; font-size: 15px; font-weight: 600; width: 100%; }
.di-row { display: flex; align-items: center; gap: 8px; }
.di-weight { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--acc-blue); font-weight: 700; width: 60px; text-align: center; padding: 4px; font-size: 14px; }
.di-unit { font-size: 13px; color: var(--text-muted); }
.di-del { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; color: var(--acc-red); opacity: 0.7; }

.ds-actions { display: flex; gap: 12px; margin-top: 20px; }
.ds-btn { flex: 1; height: 48px; border-radius: 14px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; }
.ds-btn.sec { background: rgba(255,255,255,0.1); color: #fff; }
.ds-btn.prim { background: var(--acc-blue); color: #fff; box-shadow: 0 4px 12px rgba(10,132,255,0.3); }

  /* === ANIMATIONS === */
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-20px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
  
 /* === ICONS (SVG) === */
  .icon-svg {
    width: 24px; height: 24px;
    fill: currentColor;
    display: block;
  }

  /* === VIEWPORT === */
  .cam-viewport {
    position: relative;
    flex: 1;
    width: 100%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #000;
  }

  video {
    position: absolute;
    width: 100%; height: 100%;
    object-fit: cover; 
    z-index: 1;
    opacity: 0; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    transition: opacity 0.3s;
  }
  video.active { opacity: 1; }

  /* === PRELOADER (SPINNER) === */
  .cam-loader {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    z-index: 5;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
  }
  .spinner {
    width: 40px; height: 40px;
    border: 4px solid rgba(255,255,255,0.3);
    border-top: 4px solid #fff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  #uiCanvas {
    position: absolute; inset: 0;
    width: 100%; height: 100%;
    z-index: 10; pointer-events: none;
  }

  .ui-layer {
    position: absolute; inset: 0; z-index: 20;
    display: flex; flex-direction: column;
    justify-content: space-between;
    padding: calc(16px + env(safe-area-inset-top)) 16px calc(32px + env(safe-area-inset-bottom)) 16px;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }
  
  /* –°–∫—Ä—ã–≤–∞–µ–º —Å–ª–æ–π —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞–º–µ—Ä–æ–π, –∫–æ–≥–¥–∞ –∞–∫—Ç–∏–≤–Ω–æ –º–µ–Ω—é */
  .ui-layer.idle { opacity: 0; pointer-events: none; }

  /* === TOP BAR === */
  .top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center; 
    pointer-events: auto;
    height: 48px;
  }

  .btn-close {
    width: 40px; height: 40px;
    border-radius: 50%;
    background: rgba(0,0,0,0.4);
    backdrop-filter: blur(10px);
    display: flex; align-items: center; justify-content: center;
    color: #fff; cursor: pointer;
    border: 1px solid rgba(255,255,255,0.1);
  }

  .status-chip {
    background: rgba(0,0,0,0.4);
    border: 1px solid rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    padding: 8px 16px;
    border-radius: 20px;
    display: flex; align-items: center; gap: 8px;
    font-size: 13px; font-weight: 600;
  }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--acc-orange); box-shadow: 0 0 8px var(--acc-orange); transition: 0.3s; }
  .status-dot.ok { background: var(--acc-green); box-shadow: 0 0 8px var(--acc-green); }

  .spacer { width: 40px; }

  /* === BOTTOM GRID CONTROLS === */
  .controls-grid {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    pointer-events: auto;
    width: 100%;
    margin-bottom: 10px;
  }

  .grid-cell-left { display: flex; justify-content: flex-start; }
  .grid-cell-center { display: flex; justify-content: center; }
  .grid-cell-right { display: flex; justify-content: flex-end; }

  .action-btn {
    width: 56px; height: 56px;
    border-radius: 50%;
    background: rgba(30,30,30,0.6);
    backdrop-filter: blur(12px);
    display: flex; align-items: center; justify-content: center;
    color: #fff;
    border: 1px solid rgba(255,255,255,0.15);
    cursor: pointer;
    transition: transform 0.15s, background 0.2s;
  }
  .action-btn:active { transform: scale(0.92); background: rgba(60,60,60,0.8); }
  .action-btn.hidden { opacity: 0; pointer-events: none; }
  .action-btn.disabled { opacity: 0.5; pointer-events: none; }

  .shutter-outer {
    width: 80px; height: 80px;
    border-radius: 50%;
    border: 4px solid rgba(255,255,255,0.8);
    display:flex; align-items:center; justify-content:center;
    transition: 0.3s;
    background: transparent;
  }
  .shutter-inner {
    width: 62px; height: 62px;
    border-radius: 50%;
    background: #fff;
    transition: 0.3s;
    cursor: pointer;
  }
  .shutter-outer.disabled { border-color: rgba(255, 69, 58, 0.5); }
  .shutter-outer.disabled .shutter-inner { background: var(--acc-red); transform: scale(0.4); opacity: 0.8; }
  .shutter-outer.active { border-color: var(--acc-green); transform: scale(1.05); }
  .shutter-outer:active:not(.disabled) .shutter-inner { transform: scale(0.9); }

  /* === TOAST === */
  .cam-toast {
    position: absolute;
    top: 100px; left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    color: #fff;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s;
    z-index: 50;
    backdrop-filter: blur(4px);
  }
  .cam-toast.visible { opacity: 1; }

  /* === OMNI BAR (NEW MENU) === */
  .omni-bar { 
    position: absolute; 
    bottom: 0; left: 0; right: 0; 
    background: rgba(10, 10, 10, 0.85); 
    backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
    border-top: 1px solid rgba(255, 255, 255, 0.1); 
    padding: 8px 12px var(--safe-bottom) 12px; 
    z-index: 100; 
    display: flex; align-items: flex-end; gap: 10px; 
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
  }
  .omni-bar.hidden { transform: translateY(100%); }

  .omni-icon-btn { 
    width: 40px; height: 40px; 
    display: flex; align-items: center; justify-content: center; 
    color: #fff; cursor: pointer; 
  }
  .input-wrap { 
    flex: 1; min-height: 42px; 
    background: rgba(255,255,255,0.1); 
    border-radius: 20px; 
    padding: 2px 16px; 
    display: flex; align-items: center; 
  }
  .omni-input { 
    width: 100%; 
    background: transparent; border: none; 
    color: #fff; font-size: 16px; 
    resize: none; padding: 10px 0; margin: 0; 
    max-height: 80px; 
    font-family: inherit;
  }
  .omni-input::placeholder { color: rgba(255,255,255,0.4); }
  
/* –ò–∫–æ–Ω–∫–∞ –∫–∞–º–µ—Ä—ã —Å–ø—Ä–∞–≤–∞ –≤ –º–µ–Ω—é */
  .cam-trigger-btn { 
    width: 40px; height: 40px; 
    /* –î–û–ë–ê–í–¨ –≠–¢–£ –°–¢–†–û–ö–£: */
    border-radius: 50%;
    /* ------------------ */
    display: flex; align-items: center; justify-content: center; 
    color: #fff; cursor: pointer; 
    transition: 0.2s;
  }
  .cam-trigger-btn:active { transform: scale(0.9); opacity: 0.7; }

  /* ...existing styles... */
  
  /* –ò–ó–ú–ï–ù–ï–ù–ò–Ø –î–õ–Ø OMNI BAR */
  .cam-trigger-btn.mode-send { 
    background-color: var(--acc-blue); 
    box-shadow: 0 0 15px rgba(10, 132, 255, 0.4);
    border-color: transparent;
  }
  
  /* –°–∫—Ä—ã–≤–∞–µ–º –Ω–µ–Ω—É–∂–Ω—É—é –∏–∫–æ–Ω–∫—É */
  .icon-hidden { display: none !important; }
  
  /* –°—Ç–∏–ª–∏ –¥–ª—è SVG –∏–∫–æ–Ω–æ–∫ –≤–Ω—É—Ç—Ä–∏ –∫–Ω–æ–ø–∫–∏ */
.omni-btn-icon {
    width: 24px; height: 24px;
    stroke: currentColor;
    stroke-width: 2;
    fill: none;
    stroke-linecap: round; 
    stroke-linejoin: round;
  }
  /* üî• –î–û–ë–ê–í–¨ –≠–¢–û–¢ –ë–õ–û–ö –î–õ–Ø –í–´–†–ê–í–ù–ò–í–ê–ù–ò–Ø –°–ê–ú–û–õ–ï–¢–ò–ö–ê */
  #icoSend {
    /* –û–ø—Ç–∏—á–µ—Å–∫–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è: */
    margin-right: 2px; /* –°–¥–≤–∏–≥–∞–µ–º –≤–ª–µ–≤–æ */
    margin-top: 2px;   /* –°–¥–≤–∏–≥–∞–µ–º –≤–Ω–∏–∑ */
  }

  /* === PERMISSION & PREVIEW === */
  .perm-overlay {
    position: absolute; inset: 0; z-index: 100;
    background: rgba(0,0,0,0.9);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    text-align: center; padding: 32px; gap: 24px;
  }
  .perm-btn {
    background: var(--acc-blue); color: #fff;
    border: none; padding: 14px 28px;
    border-radius: 14px; font-size: 16px; font-weight: 600; cursor: pointer;
  }

  .preview-overlay {
    position: absolute; inset: 0; z-index: 200;
    background: #000; 
    display: none; 
    flex-direction: column;
    height: 100%; 
    overflow: hidden; 
  }
  .preview-img { 
    flex: 1; 
    width: 100%; 
    object-fit: contain; 
    background: #111; 
    margin-bottom: 12px;
    min-height: 0; 
  }
  .comment-wrap { 
    flex-shrink: 0;
    padding: 0 24px 16px 24px; 
    width: 100%; 
  }
  .comment-label { 
    display: block; 
    color: rgba(255,255,255,0.6); 
    font-size: 13px; 
    margin-bottom: 8px; 
    margin-left: 4px; 
  }
  .comment-input {
    width: 100%; height: 80px;
    background: rgba(255,255,255,0.12);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 16px; padding: 12px 16px;
    color: #fff; font-size: 16px; font-family: var(--font-stack);
    resize: none; outline: none; transition: 0.2s;
  }
  .comment-input:focus { background: rgba(255,255,255,0.18); border-color: var(--acc-blue); }
  .preview-controls { 
    flex-shrink: 0;
    padding: 0 24px 34px 24px; 
    display: flex; 
    gap: 16px; 
    background: #000; 
  }
  .btn {
    flex: 1; padding: 14px; border-radius: 14px;
    font-weight: 600; font-size: 16px;
    border: 1px solid rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.1);
    color: #fff; cursor: pointer; text-align: center;
  }
  .btn.primary { background: var(--acc-blue); border-color: transparent; }
  .hidden { display: none !important; }


/* === UI –û–ë–ù–û–í–õ–ï–ù–ò–ï: PROCESSING & DRAFT (–∏–∑ scanner.html) === */
  
  /* –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç–∞ –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è scanner.html */
  :root {
    --bg-core: #050505; /* –ë–æ–ª–µ–µ –≥–ª—É–±–æ–∫–∏–π —á–µ—Ä–Ω—ã–π */
    --surface-glass: rgba(255, 255, 255, 0.07);
    --surface-border: rgba(255, 255, 255, 0.1);
    --text-muted: rgba(255, 255, 255, 0.55);
  }

  /* --- PROCESSING OVERLAY --- */
  .processing-overlay {
    position: fixed; inset: 0; z-index: 1000;
    background: rgba(5, 5, 5, 0.6);
    backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none; transition: 0.4s ease;
  }
  .processing-overlay.active { opacity: 1; pointer-events: auto; }

  .proc-card {
    width: 90%; max-width: 320px;
    background: rgba(30, 30, 30, 0.6);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 24px; padding: 30px 20px;
    display: flex; flex-direction: column; align-items: center;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
  }

  .proc-visual { position: relative; width: 60px; height: 60px; margin-bottom: 20px; }
  .proc-orb {
    position: absolute; inset: 0; border-radius: 50%;
    background: radial-gradient(circle, #0a84ff 0%, transparent 70%);
    animation: pulse-ai 2s infinite;
  }
  .proc-ring {
    position: absolute; inset: -10px; border-radius: 50%;
    border: 2px solid rgba(10, 132, 255, 0.3);
    border-top-color: #0a84ff;
    animation: spin-ai 1.5s infinite linear;
  }
  @keyframes pulse-ai { 0% { opacity: 0.5; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.5; transform: scale(0.8); } }
  @keyframes spin-ai { 100% { transform: rotate(360deg); } }

  .proc-title { font-size: 17px; font-weight: 700; color: #fff; margin-bottom: 20px; letter-spacing: 0.5px; }

  .proc-steps { width: 100%; display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
  .step { display: flex; align-items: center; gap: 10px; opacity: 0.4; transition: 0.3s; transform: translateX(-10px); }
  .step.active { opacity: 1; transform: translateX(0); font-weight: 600; }
  .step.done { opacity: 0.5; transform: translateX(0); color: var(--acc-green); }
  .s-icon { font-size: 14px; width: 20px; text-align: center; }
  .s-lbl { font-size: 13px; color: #fff; }

  .proc-close { margin-top: 10px; font-size: 13px; color: rgba(255,255,255,0.4); text-decoration: underline; cursor: pointer; }

  /* --- DRAFT SHEET (VALIDATION) --- */
  .draft-overlay {
    position: fixed; inset: 0; z-index: 1100;
    background: rgba(0,0,0,0.5);
    display: flex; flex-direction: column; justify-content: flex-end;
    opacity: 0; pointer-events: none; transition: 0.3s;
  }
  .draft-overlay.visible { opacity: 1; pointer-events: auto; }

  .draft-sheet {
    background: #1c1c1e;
    border-radius: 24px 24px 0 0;
    border-top: 1px solid rgba(255,255,255,0.15);
    padding: 24px 20px calc(20px + env(safe-area-inset-bottom)) 20px;
    transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.1, 0.8, 0.2, 1);
    max-height: 80vh; overflow-y: auto;
  }
  .draft-overlay.visible .draft-sheet { transform: translateY(0); }

  .ds-header { margin-bottom: 20px; }
  .ds-title { font-size: 20px; font-weight: 800; margin-bottom: 4px; }
  .ds-subtitle { font-size: 13px; color: var(--text-muted); line-height: 1.4; }

  /* –≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ */
  .draft-item {
    display: flex; align-items: center; gap: 10px;
    background: rgba(255,255,255,0.06);
    padding: 12px; border-radius: 16px; margin-bottom: 10px;
  }
  .di-icon { font-size: 20px; }
  .di-inputs { flex: 1; display: flex; flex-direction: column; gap: 6px; }
  .di-name { background: transparent; border: none; color: #fff; font-size: 15px; font-weight: 600; width: 100%; padding: 0; margin: 0; font-family: inherit;}
  .di-row { display: flex; align-items: center; gap: 8px; }
  .di-weight { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--acc-blue); font-weight: 700; width: 60px; text-align: center; padding: 6px; font-size: 15px; -moz-appearance: textfield; }
  .di-weight::-webkit-inner-spin-button { -webkit-appearance: none; }
  .di-unit { font-size: 13px; color: var(--text-muted); }
  .di-del { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; color: var(--acc-red); opacity: 0.7; cursor: pointer; }

  .ds-actions { display: flex; gap: 12px; margin-top: 20px; }
  .ds-btn { flex: 1; height: 48px; border-radius: 14px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; }
  .ds-btn.sec { background: rgba(255,255,255,0.1); color: #fff; }
  .ds-btn.prim { background: var(--acc-blue); color: #fff; box-shadow: 0 4px 12px rgba(10,132,255,0.3); }


</style>
</head>
<body>

<svg width="0" height="0" style="position:absolute">
  <defs>
    <linearGradient id="grad-kcal"><stop offset="0%" stop-color="#ff9f0a"/><stop offset="100%" stop-color="#ff453a"/></linearGradient>
    <linearGradient id="grad-prot"><stop offset="0%" stop-color="#48bfe3"/><stop offset="100%" stop-color="#5e60ce"/></linearGradient>
    <linearGradient id="grad-fats"><stop offset="0%" stop-color="#f1c40f"/><stop offset="100%" stop-color="#e67e22"/></linearGradient>
    <linearGradient id="grad-carb"><stop offset="0%" stop-color="#2ecc71"/><stop offset="100%" stop-color="#1abc9c"/></linearGradient>
  </defs>
</svg>

<div class="fx-layer" id="fxLayer">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="noise"></div>
</div>

<!-- APP LAYOUT CONTAINER (Resizes safely) -->
<div class="app-layout" id="appLayout">
  
  <div class="fixed-header-group">
    <!-- CALENDAR -->
    <div class="calendar-block">
      <div class="calendar-header"><div class="month-label" id="monthLabel">...</div></div>
      <div class="calendar-swipe-area" id="swipeArea">
        <div class="calendar-track" id="calTrack">
          <div class="calendar-week" id="weekPrev"></div>
          <div class="calendar-week" id="weekCurr"></div>
          <div class="calendar-week" id="weekNext"></div>
        </div>
      </div>
    </div>
    <!-- WIDGETS -->
    <div class="carousel-wrap">
      <div class="carousel-track" id="track">
        <div class="widget">
          <div class="macros-grid">
            <div class="macro-item">
              <div class="donut-box">
                <svg class="mini-donut" viewBox="0 0 60 60">
                  <circle class="md-bg" cx="30" cy="30" r="24"/>
                  <circle id="ring-k" class="md-val stroke-kcal" cx="30" cy="30" r="24" style="stroke-dashoffset: 151px"/>
                </svg>
                <div class="m-icon">üî•</div>
              </div>
              <div class="m-data">
                <div class="m-nums" id="val-k">0<span>/0</span></div>
                <div class="m-lbl">–ö–ö–ê–õ</div>
              </div>
            </div>

            <div class="macro-item">
              <div class="donut-box">
                <svg class="mini-donut" viewBox="0 0 60 60">
                  <circle class="md-bg" cx="30" cy="30" r="24"/>
                  <circle id="ring-p" class="md-val stroke-prot" cx="30" cy="30" r="24" style="stroke-dashoffset: 151px"/>
                </svg>
                <div class="m-icon">üêì</div>
              </div>
              <div class="m-data">
                <div class="m-nums" id="val-p">0<span>/0</span></div>
                <div class="m-lbl">–ë–ï–õ–ö–ò</div>
              </div>
            </div>

            <div class="macro-item">
              <div class="donut-box">
                <svg class="mini-donut" viewBox="0 0 60 60">
                  <circle class="md-bg" cx="30" cy="30" r="24"/>
                  <circle id="ring-f" class="md-val stroke-fats" cx="30" cy="30" r="24" style="stroke-dashoffset: 151px"/>
                </svg>
                <div class="m-icon">ü•ë</div>
              </div>
              <div class="m-data">
                <div class="m-nums" id="val-f">0<span>/0</span></div>
                <div class="m-lbl">–ñ–ò–†–´</div>
              </div>
            </div>

            <div class="macro-item">
              <div class="donut-box">
                <svg class="mini-donut" viewBox="0 0 60 60">
                  <circle class="md-bg" cx="30" cy="30" r="24"/>
                  <circle id="ring-c" class="md-val stroke-carb" cx="30" cy="30" r="24" style="stroke-dashoffset: 151px"/>
                </svg>
                <div class="m-icon">üåæ</div>
              </div>
              <div class="m-data">
                <div class="m-nums" id="val-c">0<span>/0</span></div>
                <div class="m-lbl">–£–ì–õ–ò</div>
              </div>
            </div>

          </div>
        </div>
        <div class="widget water-widget" id="waterCard">
          <div class="water-header">
            <div class="water-title">–í–æ–¥–Ω—ã–π –±–∞–ª–∞–Ω—Å</div>
            <div class="water-percent" id="lbl-pct">0%</div>
          </div>
          
          <div class="water-cols">
            <div class="water-tube"><div class="water-fill" id="c1" style="height: 0%"></div></div>
            <div class="water-tube"><div class="water-fill" id="c2" style="height: 0%"></div></div>
            <div class="water-tube"><div class="water-fill" id="c3" style="height: 0%"></div></div>
            <div class="water-tube"><div class="water-fill" id="c4" style="height: 0%"></div></div>
            <div class="water-tube"><div class="water-fill" id="c5" style="height: 0%"></div></div>
          </div>

          <div class="water-footer">
            <div class="water-info">
              <div class="wf-row">
                <div class="wf-fact" id="lbl-fact">0</div>
                <div class="wf-unit">–º–ª</div>
              </div>
              <div class="wf-plan">–¶–µ–ª—å: <span id="lbl-target">2500</span></div>
            </div>
            <div class="water-controls">
              <div class="water-btn" onclick="WidgetManager.add(-250)">‚àí</div>
              <div class="water-btn" onclick="WidgetManager.add(250)">+</div>
            </div>
          </div>
        </div>
      </div>
      <div class="dots"><div class="dot active"></div><div class="dot"></div></div>
    </div>
  </div>

  <!-- SCROLL CONTAINER -->
  <div class="scroll-container" id="scrollContainer">
    <div class="timeline" id="timelineFeed"></div>
  </div>

 <div class="cam-viewport">
    <video id="video" autoplay playsinline muted></video>
    
    <div id="loader" class="cam-loader hidden">
      <div class="spinner"></div>
    </div>
    
    <canvas id="uiCanvas"></canvas>
    <div id="camToast" class="cam-toast">Camera Name</div>

    <div class="ui-layer idle" id="camUI">
      <div class="top-bar">
        <div class="btn-close" id="btnClose">
          <svg class="icon-svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </div>

        <div class="status-chip" id="lvlChip">
          <div class="status-dot" id="lvlDot"></div>
          <span id="lvlText">–£—Ä–æ–≤–µ–Ω—å</span>
        </div>

        <div class="spacer"></div>
      </div>

      <div class="controls-grid">
        <div class="grid-cell-left">
          <div class="action-btn" id="btnTorch">
            <svg class="icon-svg" viewBox="0 0 24 24"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg>
          </div>
        </div>

        <div class="grid-cell-center">
          <div class="shutter-outer disabled" id="shutterBtn">
            <div class="shutter-inner"></div>
          </div>
        </div>

        <div class="grid-cell-right">
          <div class="action-btn hidden" id="btnSwitch">
            <svg class="icon-svg" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
          </div>
        </div>
      </div>
    </div>
    
    <div class="omni-bar" id="omniBar">
      <div class="omni-icon-btn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
      </div>
      <div class="input-wrap">
        <textarea class="omni-input" rows="1" placeholder="–Ø–±–ª–æ–∫–æ 200–≥, –∫–æ—Ñ–µ..."></textarea>
      </div>
      <div class="cam-trigger-btn" id="btnStartCam">
        <svg id="icoCam" class="omni-btn-icon" viewBox="0 0 24 24">
          <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
          <circle cx="12" cy="13" r="4"></circle>
        </svg>
        
        <svg id="icoSend" class="omni-btn-icon icon-hidden" viewBox="0 0 24 24">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </div>
    </div>

  </div>

  <div id="permReq" class="perm-overlay hidden">
    <div style="font-size:48px; margin-bottom:10px">üìê</div>
    <h2 style="margin:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∞</h2>
    <p style="color:var(--text-muted)">–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –¥–∞—Ç—á–∏–∫–∞–º –¥–ª—è —Ä–∞–±–æ—Ç—ã —É—Ä–æ–≤–Ω—è.</p>
    <button class="perm-btn" onclick="requestSensors()">–†–∞–∑—Ä–µ—à–∏—Ç—å</button>
  </div>

  <div id="previewScreen" class="preview-overlay">
    <img id="finalPhoto" class="preview-img">
    <div class="comment-wrap">
      <label class="comment-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <textarea id="commentInput" class="comment-input" placeholder="–ú–æ–∂–µ—Ç–µ —É–∫–∞–∑–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã, —ç—Ç–æ –ø–æ–≤—ã—Å–∏—Ç —Ç–æ—á–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏. –ù–∞–ø—Ä–∏–º–µ—Ä: —Ä–∏—Å 200, —Ç—Ä–µ—Å–∫–∞ 150"></textarea>
    </div>
    <div class="preview-controls">
      <button class="btn" onclick="retake()">–ü–µ—Ä–µ—Å–Ω—è—Ç—å</button>
      <button class="btn primary" id="btnSend" onclick="sendPhoto()">–ì–æ—Ç–æ–≤–æ</button>
    </div>
  </div>

<div class="processing-overlay" id="procOverlay">
    <div class="proc-card">
      <div class="proc-visual">
        <div class="proc-orb"></div>
        <div class="proc-ring"></div>
      </div>
      <div class="proc-title">–ê–Ω–∞–ª–∏–∑ —Å–Ω–∏–º–∫–∞</div>
      
      <div class="proc-steps" id="procSteps">
        <div class="step pending" id="step-1"><div class="s-icon">üõ°Ô∏è</div><div class="s-lbl">Gatekeeper: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞...</div></div>
        <div class="step pending" id="step-2"><div class="s-icon">üì¶</div><div class="s-lbl">Librarian: –ü–æ–∏—Å–∫ —É–ø–∞–∫–æ–≤–æ–∫...</div></div>
        <div class="step pending" id="step-3"><div class="s-icon">üïµÔ∏è</div><div class="s-lbl">Detective: –ü–æ–∏—Å–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤...</div></div>
        <div class="step pending" id="step-4"><div class="s-icon">üìê</div><div class="s-lbl">Physicist: –†–∞—Å—á–µ—Ç –≤–µ—Å–∞...</div></div>
        <div class="step pending" id="step-5"><div class="s-icon">üìù</div><div class="s-lbl">Synthesizer: –°–±–æ—Ä–∫–∞ –æ—Ç—á–µ—Ç–∞...</div></div>
      </div>

      <div class="proc-close" onclick="cancelProcessing()">–û—Ç–º–µ–Ω–∞</div>
    </div>
  </div>

  <div class="draft-overlay" id="draftOverlay">
    <div class="draft-sheet">
      <div class="ds-header">
        <div class="ds-title">–ü—Ä–æ–≤–µ—Ä—å –¥–∞–Ω–Ω—ã–µ</div>
        <div class="ds-subtitle">AI –æ–ø—Ä–µ–¥–µ–ª–∏–ª —Å–æ—Å—Ç–∞–≤ –∏ –≤–µ—Å. –ò—Å–ø—Ä–∞–≤—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é –≤ –¥–Ω–µ–≤–Ω–∏–∫.</div>
      </div>
      
      <div class="ds-list" id="draftList"></div>

      <div class="ds-actions">
        <button class="ds-btn sec" onclick="closeDraft()">–û—Ç–º–µ–Ω–∞</button>
        <button class="ds-btn prim" id="btnConfirmDraft" onclick="confirmDraftToNutritionist()">–í –¥–Ω–µ–≤–Ω–∏–∫</button>
      </div>
    </div>
  </div>

</div> <!-- End App Layout -->

  
<script>
/* ============================================================
 * BLOCK 0: TMA boot (FIXED & SAFE)
 * ============================================================ */
(function initTMA() {
  try {
    const tg = window.Telegram?.WebApp;
    if (!tg) return; 
    tg.ready();
    tg.expand();
    try { tg.setHeaderColor('#050505'); if (tg.setBackgroundColor) tg.setBackgroundColor('#050505'); } catch (e) {}
    try { if (tg.BackButton) { tg.BackButton.show(); tg.BackButton.offClick(); tg.BackButton.onClick(function() { window.location.href = 'router.html'; }); } } catch (e) {}
    try { if (tg.disableVerticalSwipes) tg.disableVerticalSwipes(); } catch (e) {}
  } catch (globalErr) { console.error('Critical TMA Error:', globalErr); }
})();

// FIX FROM AI.HTML: STABLE LAYOUT ENGINE
(function initStableLayout() {
  const app = document.getElementById('appLayout'); 
  const omniBar = document.getElementById('omniBar');
  const scrollContainer = document.getElementById('scrollContainer');
  const fxLayer = document.getElementById('fxLayer');
  
  // 1. LOCK BACKGROUND HEIGHT ONCE
  // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç "–ø—Ä—ã–∂–∫–∏" —Ñ–æ–Ω–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
  if (fxLayer) {
    fxLayer.style.height = window.innerHeight + 'px';
  }

  function setHeight() {
    const tg = window.Telegram?.WebApp;
    const h = (tg && tg.viewportHeight) ? tg.viewportHeight : window.innerHeight;
    
    // Resize only the main app container, NOT the background
    app.style.height = `${h}px`;
    
    // Dynamic padding for scroll container so content isn't hidden behind omni bar
    if (omniBar && scrollContainer) {
        const barHeight = omniBar.offsetHeight;
        scrollContainer.style.paddingBottom = `${barHeight + 20}px`;
    }
  }

  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.onEvent('viewportChanged', ({ isStateStable }) => {
      setHeight();
    });
  }
  
  window.addEventListener('resize', setHeight);
  setHeight();
  
  const txt = document.getElementById('msgInput');
  if(txt) {
      txt.addEventListener('input', () => requestAnimationFrame(setHeight));
  }
})();
  
function isAdmin() { try { return window.Telegram?.WebApp?.initDataUnsafe?.user?.id === 196047220; } catch (_) { return false; } }
function haptic(type) { if (navigator.vibrate) navigator.vibrate(15); if(window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred(type || 'light'); }

  // === INFINITE CALENDAR ===
  let currentWeekStart = getStartOfWeek(new Date()); let selectedDate = new Date(); let isDragging = false; let startX = 0; let currentTranslate = 0;
  const area = document.getElementById('swipeArea'); const track = document.getElementById('calTrack'); const prevEl = document.getElementById('weekPrev'); const currEl = document.getElementById('weekCurr'); const nextEl = document.getElementById('weekNext');
  function getStartOfWeek(date) { const d = new Date(date); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1); return new Date(d.setDate(diff)); }
  function initCalendar() { renderAllWeeks(); area.onpointerdown = handleStart; area.onpointermove = handleMove; area.onpointerup = handleEnd; area.onpointercancel = handleEnd; area.onpointerleave = handleEnd; }
  function renderWeekData(container, startDate) {
    container.innerHTML = ''; const weekDays = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å']; const today = new Date();
    for(let i=0; i<7; i++) {
      const d = new Date(startDate); d.setDate(d.getDate() + i); const isToday = d.toDateString() === today.toDateString(); const isSelected = d.toDateString() === selectedDate.toDateString();
      const el = document.createElement('div'); el.className = `day-cell ${isSelected ? 'selected' : ''} ${isToday ? 'is-today' : ''}`; el.innerHTML = `<div class="dc-name">${weekDays[i]}</div><div class="dc-num">${d.getDate()}</div>`;
      el.onclick = (e) => { if(Math.abs(currentTranslate) > 5) return; document.querySelectorAll('.day-cell').forEach(c => c.classList.remove('selected')); el.classList.add('selected'); selectedDate = new Date(d); haptic('selection'); renderAllWeeks(); }; container.appendChild(el);
    }
  }
  function renderAllWeeks() { renderWeekData(currEl, currentWeekStart); const dPrev = new Date(currentWeekStart); dPrev.setDate(dPrev.getDate() - 7); renderWeekData(prevEl, dPrev); const dNext = new Date(currentWeekStart); dNext.setDate(dNext.getDate() + 7); renderWeekData(nextEl, dNext); const mid = new Date(currentWeekStart); mid.setDate(mid.getDate() + 3); document.getElementById('monthLabel').textContent = mid.toLocaleString('ru', { month: 'long', year: 'numeric' }); }
  function handleStart(e) { if (e.button !== 0) return; isDragging = true; startX = e.clientX; currentTranslate = 0; track.style.transition = 'none'; area.style.cursor = 'grabbing'; }
  function handleMove(e) { if (!isDragging) return; currentTranslate = e.clientX - startX; track.style.transform = `translateX(calc(-33.333333% + ${currentTranslate}px))`; }
  function handleEnd(e) { if (!isDragging) return; isDragging = false; area.style.cursor = 'grab'; const threshold = 60; track.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)'; if (currentTranslate > threshold) { haptic('light'); track.style.transform = `translateX(0%)`; setTimeout(() => shiftWeeks(-1), 300); } else if (currentTranslate < -threshold) { haptic('light'); track.style.transform = `translateX(-66.666666%)`; setTimeout(() => shiftWeeks(1), 300); } else { track.style.transform = `translateX(-33.333333%)`; } }
  function shiftWeeks(direction) { currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7)); track.style.transition = 'none'; renderAllWeeks(); track.style.transform = `translateX(-33.333333%)`; }

  // === CAROUSEL ===
  const carTrack = document.getElementById('track'); const dots = document.querySelectorAll('.dot'); let isDown = false; let startXC; let scrollLeft;
  carTrack.addEventListener('mousedown', (e) => { isDown=true; carTrack.style.cursor='grabbing'; startXC=e.pageX-carTrack.offsetLeft; scrollLeft=carTrack.scrollLeft; });
  carTrack.addEventListener('mouseleave', () => { isDown=false; carTrack.style.cursor='grab'; });
  carTrack.addEventListener('mouseup', () => { isDown=false; carTrack.style.cursor='grab'; });
  carTrack.addEventListener('mousemove', (e) => { if(!isDown) return; e.preventDefault(); const x=e.pageX-carTrack.offsetLeft; const walk=(x-startXC)*2; carTrack.scrollLeft=scrollLeft-walk; });
  carTrack.addEventListener('scroll', () => { const idx=Math.round(carTrack.scrollLeft/carTrack.clientWidth); dots.forEach((d,i)=>d.classList.toggle('active', i===idx)); });

    /* ============================================================
    * BLOCK: WIDGETS LOGIC (RINGS & WATER)
    * ============================================================ */

    const WidgetManager = {
      // –¶–µ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ—Ç–æ–º –±—É–¥–µ–º –±—Ä–∞—Ç—å –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è)
      targets: { k: 2100, p: 160, f: 70, c: 250, water: 2500 },
      
      // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ–¥—ã (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —É—á–µ—Ç–∞)
      currentWater: 0, 

      // 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –í–°–ï–• –≤–∏–¥–∂–µ—Ç–æ–≤ —Ä–∞–∑–æ–º
      render(stats) {
        // stats = { k: 1200, p: 90, f: 40, c: 110, water: 1500 }
        
        // –ê. –û–±–Ω–æ–≤–ª—è–µ–º –ö–æ–ª—å—Ü–∞ (–ú–∞–∫—Ä–æ—Å—ã)
        this.animateRing('k', stats.k, this.targets.k);
        this.animateRing('p', stats.p, this.targets.p);
        this.animateRing('f', stats.f, this.targets.f);
        this.animateRing('c', stats.c, this.targets.c);

        // –ë. –û–±–Ω–æ–≤–ª—è–µ–º –í–æ–¥—É
        this.currentWater = stats.water || 0;
        this.renderWaterUI();
      },

      // 2. –õ–æ–≥–∏–∫–∞ –∫–æ–ª—å—Ü–∞ (SVG Dashoffset)
      animateRing(type, val, target) {
        const elRing = document.getElementById(`ring-${type}`);
        const elText = document.getElementById(`val-${type}`);
        if (!elRing || !elText) return;

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–º–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ (–Ω–µ –±–æ–ª—å—à–µ 100%)
        const pct = Math.min(1, Math.max(0, val / target));
        
        // –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ SVG: 
        // –î–ª–∏–Ω–∞ –æ–∫—Ä—É–∂–Ω–æ—Å—Ç–∏ (2 * pi * r) –ø—Ä–∏ r=24 —Ä–∞–≤–Ω–∞ ~151px.
        // Offset 151 = –ø—É—Å—Ç–æ, Offset 0 = –ø–æ–ª–Ω–æ.
        const circumference = 151; 
        const offset = circumference - (pct * circumference);

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏
        elRing.style.strokeDashoffset = offset;
        elText.innerHTML = `${Math.round(val)}<span>/${target}</span>`;
      },

      // 3. –õ–æ–≥–∏–∫–∞ –í–æ–¥—ã (UI)
      renderWaterUI() {
        const val = this.currentWater;
        const target = this.targets.water;
        
        document.getElementById('lbl-fact').innerText = val;
        document.getElementById('lbl-target').innerText = target;
        
        const pctGlobal = Math.round((val / target) * 100);
        document.getElementById('lbl-pct').innerText = pctGlobal + '%';

        // –≠—Ñ—Ñ–µ–∫—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ (–µ—Å–ª–∏ –≤—ã–ø–∏–ª–∏ –±–æ–ª—å—à–µ –Ω–æ—Ä–º—ã)
        const card = document.getElementById('waterCard');
        if (val > target) card.classList.add('is-overload'); 
        else card.classList.remove('is-overload');

        // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ 5 —Å—Ç–∞–∫–∞–Ω–∞–º
        for (let i = 1; i <= 5; i++) {
          const el = document.getElementById('c' + i);
          const segmentSize = target / 5; // 500–º–ª –≤ –æ–¥–Ω–æ–º —Å—Ç–∞–∫–∞–Ω–µ
          const threshold = i * segmentSize;     // –í–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞–∫–∞–Ω–∞
          const prevThreshold = (i - 1) * segmentSize; // –ù–∏–∂–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞
          
          let fillPct = 0;
          if (val >= threshold) {
            fillPct = 100; // –°—Ç–∞–∫–∞–Ω –ø–æ–ª–æ–Ω
          } else if (val > prevThreshold) {
            // –°—Ç–∞–∫–∞–Ω –Ω–∞–ø–æ–ª–Ω–µ–Ω —á–∞—Å—Ç–∏—á–Ω–æ
            fillPct = ((val - prevThreshold) / segmentSize) * 100;
          }
          
          el.style.height = `${fillPct}%`;
        }
      },

      // 4. –î–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–î–æ–±–∞–≤–∏—Ç—å/–£–±–∞–≤–∏—Ç—å –≤–æ–¥—É)
      async add(amount) {
        haptic('light');
        
        // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (—Å—Ä–∞–∑—É –º–µ–Ω—è–µ–º UI)
        const oldVal = this.currentWater;
        this.currentWater = Math.max(0, this.currentWater + amount);
        this.renderWaterUI();

        // –¢—É—Ç –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±–∞–∑—É
        console.log(`Sending water update: ${this.currentWater}ml`);
        
        // TODO: –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, –∫–æ–≥–¥–∞ –ø–æ–¥–∫–ª—é—á–∏–º API
        /*
        try {
          await API.send('update_water', { amount: this.currentWater });
        } catch (e) {
          // –û—à–∏–±–∫–∞? –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º UI –Ω–∞–∑–∞–¥
          this.currentWater = oldVal;
          this.renderWaterUI();
          alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
        }
        */
      }
    };

  // === FORMAT LOCAL TIME ===
  function formatLocalTimes() {
    const timeElements = document.querySelectorAll('.mh-time'); const now = new Date();
    timeElements.forEach(el => { const h = parseInt(el.getAttribute('data-h')); const m = parseInt(el.getAttribute('data-m')); if (!isNaN(h) && !isNaN(m)) { const d = new Date(now); d.setHours(h, m, 0, 0); el.textContent = d.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' }); } });
  }
  
  initCalendar(); formatLocalTimes();


 /* ============================================================
 * BLOCK: DATA CORE (REAL DATA INTEGRATION)
 * ============================================================ */

const API_CONFIG = {
  // –¢–≤–æ–π URL GAS —Å–∫—Ä–∏–ø—Ç–∞
  URL: "https://script.google.com/macros/s/–¢–í–û–ô_ID_–°–ö–†–ò–ü–¢–ê/exec" 
};

// 1. API CLIENT
const Backend = {
  async getDayLog(dateObj = new Date()) {
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
    // –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π fetch. –ü–æ–∫–∞ –∏–º–∏—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞,
    // —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —Ä–µ–Ω–¥–µ—Ä–∞ –Ω–∞ "–±–æ–µ–≤–æ–π" —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –¥–∞–Ω–Ω—ã—Ö.
    
    // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏ —Å–µ—Ç–∏
    // await new Promise(r => setTimeout(r, 800)); 
    
    // –≠—Ç—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –Ω–∞–º –±—É–¥–µ—Ç –ø—Ä–∏—Å—ã–ª–∞—Ç—å GAS (—Ñ—É–Ω–∫—Ü–∏—è doGet)
    return [
      {
        time: "09:00",
        items: [
          { name: "–û–≤—Å—è–Ω–∞—è –∫–∞—à–∞ –Ω–∞ –º–æ–ª–æ–∫–µ", weight: 250, k: 220, p: 8, f: 6, c: 32 },
          { name: "–ú–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ", weight: 10, k: 75, p: 0, f: 8, c: 0 },
          { name: "–ö–æ—Ñ–µ —Å –º–æ–ª–æ–∫–æ–º", weight: 250, k: 125, p: 3, f: 3, c: 5 }
        ]
      },
      {
        time: "11:30",
        items: [
          { name: "–¢–≤–æ—Ä–æ–≥ 5%", weight: 150, k: 120, p: 24, f: 7, c: 3 },
          { name: "–Ø–±–ª–æ–∫–æ –∑–µ–ª–µ–Ω–æ–µ", weight: 120, k: 60, p: 0, f: 0, c: 14 }
        ]
      }
      // ... –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å —Å—é–¥–∞
    ];
  },

  async loadAndRender() {
    const container = document.getElementById('timelineFeed');
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    container.innerHTML = '<div style="padding:20px; text-align:center; color:#555">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>';
    
    try {
      const data = await this.getDayLog();
      renderDailyLog(data);
      updateDashboardStats(data); // –û–±–Ω–æ–≤–∏–º –∏ –∫—Ä—É–∂–æ—á–∫–∏ (—Å–ª–µ–¥. —ç—Ç–∞–ø)
    } catch (e) {
      container.innerHTML = `<div style="color:var(--acc-red); padding:20px">–û—à–∏–±–∫–∞: ${e.message}</div>`;
    }
  }
};

// 2. –ì–ï–ù–ï–†–ê–¢–û–† HTML (–°—Ç—Ä–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∏–ª–∏!)
function renderDailyLog(logData) {
  const container = document.getElementById('timelineFeed');
  container.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞

  if (!logData || logData.length === 0) {
    container.innerHTML = '<div style="text-align:center; padding:40px; opacity:0.4">–î–Ω–µ–≤–Ω–∏–∫ –ø—É—Å—Ç</div>';
    return;
  }

  // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –∫–∞–∂–¥–æ–º—É –ø—Ä–∏–µ–º—É –ø–∏—â–∏
  logData.forEach((meal, index) => {
    // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
    const card = document.createElement('div');
    card.className = 'meal-card';
    card.style.animation = `slideIn 0.4s ease ${index * 0.1}s backwards`; // –ö–∞—Å–∫–∞–¥–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    let itemsHtml = '';
    meal.items.forEach(prod => {
      itemsHtml += `
        <div class="prod-item">
          <div class="pi-name">${prod.name}</div>
          <div class="pi-val pi-w">${prod.weight}</div>
          <div class="pi-val pi-k">${prod.k}</div>
          <div class="pi-val pi-p">${prod.p}</div>
          <div class="pi-val pi-f">${prod.f}</div>
          <div class="pi-val pi-c">${prod.c}</div>
        </div>
      `;
    });

    // –°–æ–±–∏—Ä–∞–µ–º HTML –∫–∞—Ä—Ç–æ—á–∫–∏ (–®–∞–ø–∫–∞ + –¢–µ–ª–æ)
    card.innerHTML = `
      <div class="col-headers">
        <div class="mh-time">${meal.time}</div>
        <div class="ch-item">–í–µ—Å</div>
        <div class="ch-item">–ö</div>
        <div class="ch-item">–ë</div>
        <div class="ch-item">–ñ</div>
        <div class="ch-item">–£</div>
      </div>
      ${itemsHtml}
    `;

    container.appendChild(card);
  });
}

// –í–Ω—É—Ç—Ä–∏ Backend.loadAndRender –∏–ª–∏ –≥–¥–µ —É —Ç–µ–±—è updateDashboardStats
function updateDashboardStats(logData) {
  let total = { k:0, p:0, f:0, c:0, water: 0 }; // –î–æ–±–∞–≤–∏–ª–∏ water
  
  // –°—á–∏—Ç–∞–µ–º –µ–¥—É –∏–∑ –ª–µ–Ω—Ç—ã
  logData.forEach(meal => {
    meal.items.forEach(i => {
      total.k += i.k;
      total.p += i.p;
      total.f += i.f;
      total.c += i.c;
    });
  });

  // –í–æ–¥—É –ø–æ–∫–∞ –±–µ—Ä–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω—É—é (–ø–æ–∑–∂–µ –æ–Ω–∞ –ø—Ä–∏–¥–µ—Ç –∏–∑ API getDayLog)
  total.water = 1250; // <--- –í—Ä–µ–º–µ–Ω–Ω–æ, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å—Ç–∞–∫–∞–Ω–æ–≤

  // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
  WidgetManager.render(total);
}

// === –ó–ê–ü–£–°–ö ===
// –í—ã–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
document.addEventListener('DOMContentLoaded', () => {
  Backend.loadAndRender();
});

 // === CONFIG ===
  const API_URL = "https://script.google.com/macros/s/AKfycbx0fUaaCH-JwnG5R_3TFgU5FSibsEuhuS0ZZZfyxPNVPQ1ZpCfUIaa5aE8vjgqitac/exec"; // ‚ö†Ô∏è –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ô URL!

  // === TELEGRAM INIT ===
  const tg = window.Telegram?.WebApp;
  if(tg) {
    tg.ready(); tg.expand();
    tg.setHeaderColor('#000000');
    if(tg.disableVerticalSwipes) tg.disableVerticalSwipes();
  }

 
  // === API HELPER (CORS HACK FIX) ===
  const API = {
    // 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ü–û–õ–ù–´–ô Data URL
    blobToBase64: (blob) => {
      return new Promise((resolve, _) => {
        const reader = new FileReader();
        reader.onloadend = () => {
           // –ù–ï –û–ë–†–ï–ó–ê–ï–ú! –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å: "data:image/jpeg;base64,..."
           resolve(reader.result);
        };
        reader.readAsDataURL(blob);
      });
    },

    // 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞: text/plain
    send: async (action, payload) => {
      const user = tg?.initDataUnsafe?.user || { id: 0, first_name: 'BrowserTest' };
      const body = {
        action: action,
        user: user,
        initData: tg?.initData || '',
        ...payload
      };
      
      // üî• MAGIC FIX: –ò—Å–ø–æ–ª—å–∑—É–µ–º text/plain, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å CORS Preflight
      const response = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" }, 
        body: JSON.stringify(body)
      });

      const json = await response.json();
      if (!json.ok) throw new Error(json.error || 'Server Error');
      return json;
    }
  };

  // === STATE & DOM ===
  const state = {
    stream: null,
    track: null,
    levelOK: false,
    angleX: 0, angleY: 0,
    photoBlob: null,
    isCapturing: false,
    isSwitching: false,
    devices: [],      
    currentDevIdx: 0, 
    torchOn: false,
    sensorActive: false,
    uiMode: 'menu' 
  };

  const DOM = {
    video: document.getElementById('video'),
    canvas: document.getElementById('uiCanvas'),
    ctx: document.getElementById('uiCanvas').getContext('2d'),
    shutter: document.getElementById('shutterBtn'),
    lvlDot: document.getElementById('lvlDot'),
    lvlText: document.getElementById('lvlText'),
    permReq: document.getElementById('permReq'),
    preview: document.getElementById('previewScreen'),
    finalImg: document.getElementById('finalPhoto'),
    btnSend: document.getElementById('btnSend'),
    commentInput: document.getElementById('commentInput'),
    btnTorch: document.getElementById('btnTorch'),
    btnSwitch: document.getElementById('btnSwitch'),
    toast: document.getElementById('camToast'),
    loader: document.getElementById('loader'),
    
    omniBar: document.getElementById('omniBar'),
    camUI: document.getElementById('camUI'),

    omniInput: document.querySelector('.omni-input'), // –¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ
    icoCam: document.getElementById('icoCam'),
    icoSend: document.getElementById('icoSend'),

    btnStartCam: document.getElementById('btnStartCam'),
    btnClose: document.getElementById('btnClose')
  };

  // === LOGIC ===
// === OMNI BAR LOGIC (TEXT vs CAMERA) ===
  
  // 1. –°–ª—É—à–∞–µ–º –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞
  DOM.omniInput.addEventListener('input', () => {
    const hasText = DOM.omniInput.value.trim().length > 0;
    
    // –ê–≤—Ç–æ-–≤—ã—Å–æ—Ç–∞ –ø–æ–ª—è (–∫–∞–∫ –≤ scanner.html)
    DOM.omniInput.style.height = 'auto'; 
    DOM.omniInput.style.height = Math.min(DOM.omniInput.scrollHeight, 80) + 'px';

    if (hasText) {
      // –†–µ–∂–∏–º –û–¢–ü–†–ê–í–ö–ò
      DOM.btnStartCam.classList.add('mode-send');
      DOM.icoCam.classList.add('icon-hidden');
      DOM.icoSend.classList.remove('icon-hidden');
    } else {
      // –†–µ–∂–∏–º –ö–ê–ú–ï–†–´
      DOM.btnStartCam.classList.remove('mode-send');
      DOM.icoCam.classList.remove('icon-hidden');
      DOM.icoSend.classList.add('icon-hidden');
    }
  });

  // 2. –£–º–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
  DOM.btnStartCam.onclick = async () => {
    const text = DOM.omniInput.value.trim();
    
    if (text.length > 0) {
      // --- –õ–û–ì–ò–ö–ê –û–¢–ü–†–ê–í–ö–ò –¢–ï–ö–°–¢–ê (TextParser) ---
      await sendTextOnly(text);
    } else {
      // --- –õ–û–ì–ò–ö–ê –ó–ê–ü–£–°–ö–ê –ö–ê–ú–ï–†–´ (–°—Ç–∞—Ä–∞—è) ---
      state.uiMode = 'camera';
      DOM.omniBar.classList.add('hidden');
      DOM.camUI.classList.remove('idle');
      DOM.camUI.style.pointerEvents = 'auto'; 
      if(tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
      await initCamera(); 
    }
  };

  // 3. –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–∏—Å—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
  // –î–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞ (–∏–∑ Omni Bar) —Ç–æ–∂–µ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏–∫—É
  async function sendTextOnly(text) {
     const btn = DOM.btnStartCam;
     btn.style.opacity = '0.5';
     haptic('medium');
     
     try {
       startProcessingUI('text');
       
       const result = await API.send('scan', { image: null, userText: text });
       
       stopProcessingUI();
       DOM.omniInput.value = ''; // –ß–∏—Å—Ç–∏–º –ø–æ–ª–µ
       
       if (result.ok) {
         openDraftSheet(result.data, result.scanId);
       } else {
         throw new Error(result.error);
       }
     } catch(e) {
       stopProcessingUI();
       alert("–û—à–∏–±–∫–∞: " + e.message);
     } finally {
       btn.style.opacity = '1';
     }
  }

  DOM.btnClose.onclick = () => {
    state.uiMode = 'menu';
    DOM.camUI.classList.add('idle');
    DOM.camUI.style.pointerEvents = 'none';
    DOM.omniBar.classList.remove('hidden');
    stopStream(); 
  };

  let toastTimer;
  function showToast(msg) {
    DOM.toast.textContent = msg;
    DOM.toast.classList.add('visible');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => { DOM.toast.classList.remove('visible'); }, 2000);
  }

  function stopStream() {
    if (state.stream) { state.stream.getTracks().forEach(t => t.stop()); state.stream = null; }
    state.track = null; state.torchOn = false; 
    updateTorchUI();
    DOM.video.srcObject = null;
    DOM.video.classList.remove('active');
  }

  async function startStream(deviceId) {
    if (state.stream) stopStream();
    const constraints = { audio: false, video: { deviceId: deviceId ? { exact: deviceId } : undefined, facingMode: deviceId ? undefined : 'environment', width: { ideal: 1920 }, height: { ideal: 2560 } } };
    try {
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      state.stream = stream; state.track = stream.getVideoTracks()[0];
      DOM.video.srcObject = stream; DOM.video.classList.add('active');
      const settings = state.track.getSettings();
      if (settings.deviceId) localStorage.setItem('ultima_cam_id', settings.deviceId);
      
      let label = state.track.label || "–ö–∞–º–µ—Ä–∞";
      label = label.replace(/\(.*\)/, '').replace(/camera2/i, '').replace(/facing/i, '').trim();
      if(label.length < 2) label = "–ö–∞–º–µ—Ä–∞ " + (state.currentDevIdx + 1);
      if(state.devices.length > 1) showToast(label);

      const caps = state.track.getCapabilities();
      if (caps.focusMode?.includes('continuous')) { try { await state.track.applyConstraints({ advanced: [{ focusMode: 'continuous' }] }); } catch(e){} }
    } catch (e) {
      if (deviceId) { localStorage.removeItem('ultima_cam_id'); await startStream(null); } 
      else { alert("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: " + e.message); }
    }
  }

  DOM.btnSwitch.onclick = async () => {
    if (state.devices.length < 2 || state.isSwitching) return;
    state.isSwitching = true; haptic('medium');
    DOM.loader.classList.remove('hidden');
    DOM.btnSwitch.classList.add('disabled'); DOM.btnTorch.classList.add('disabled'); DOM.shutter.classList.add('disabled');
    const svg = DOM.btnSwitch.querySelector('svg'); svg.style.transition = 'transform 0.4s'; svg.style.transform = 'rotate(180deg)';
    if (state.stream) state.stream.getTracks().forEach(t => t.stop());
    await new Promise(r => setTimeout(r, 500));
    let nextIdx = state.currentDevIdx + 1;
    if (nextIdx >= state.devices.length) nextIdx = 0;
    state.currentDevIdx = nextIdx;
    await startStream(state.devices[nextIdx].deviceId);
    DOM.loader.classList.add('hidden');
    DOM.btnSwitch.classList.remove('disabled'); DOM.btnTorch.classList.remove('disabled'); DOM.shutter.classList.remove('disabled');
    state.isSwitching = false; setTimeout(() => svg.style.transform = '', 400);
  };

  DOM.btnTorch.onclick = async () => {
    if(!state.track) return;
    const caps = state.track.getCapabilities();
    if (!caps.torch) { showToast("–í—Å–ø—ã—à–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"); haptic('error'); return; }
    const newState = !state.torchOn;
    try { await state.track.applyConstraints({ advanced: [{ torch: newState }] }); state.torchOn = newState; updateTorchUI(); haptic('light'); } 
    catch(e) { showToast("–û—à–∏–±–∫–∞ –≤—Å–ø—ã—à–∫–∏"); }
  };

  function updateTorchUI() {
    if (state.torchOn) { DOM.btnTorch.style.backgroundColor = 'var(--acc-orange)'; DOM.btnTorch.style.color = '#000'; } 
    else { DOM.btnTorch.style.backgroundColor = ''; DOM.btnTorch.style.color = '#fff'; }
  }

  function checkSensorPerms() {
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') { DOM.permReq.classList.remove('hidden'); } 
    else { window.addEventListener('deviceorientation', handleOrientation); }
  }
  async function requestSensors() {
    try { const resp = await DeviceOrientationEvent.requestPermission(); if (resp === 'granted') { window.addEventListener('deviceorientation', handleOrientation); } } 
    catch (e) {} finally { DOM.permReq.classList.add('hidden'); }
  }
  function handleOrientation(e) {
    let x = e.beta; let y = e.gamma; 
    if (x === null || y === null) return;
    state.sensorActive = true; state.angleX = x; state.angleY = y;
  }
  function updateUI() {
    if (state.uiMode === 'menu') return;
    if (state.isCapturing || state.isSwitching) return;
    if (!state.sensorActive) { DOM.lvlDot.classList.remove('ok'); DOM.lvlText.textContent = "–ö–∞–º–µ—Ä–∞"; DOM.shutter.classList.remove('disabled'); DOM.shutter.classList.add('active'); return; }
    if (state.levelOK) { DOM.lvlDot.classList.add('ok'); DOM.lvlText.textContent = "–†–æ–≤–Ω–æ"; DOM.shutter.classList.remove('disabled'); DOM.shutter.classList.add('active'); } 
    else { DOM.lvlDot.classList.remove('ok'); DOM.lvlText.textContent = "–í—ã—Ä–æ–≤–Ω—è–π—Ç–µ"; DOM.shutter.classList.add('disabled'); DOM.shutter.classList.remove('active'); }
  }
  function resizeCanvas() { const w = window.innerWidth; const h = window.innerHeight; if (DOM.canvas.width !== w || DOM.canvas.height !== h) { DOM.canvas.width = w; DOM.canvas.height = h; } }

  async function initCamera() {
    try { const savedId = localStorage.getItem('ultima_cam_id'); await startStream(savedId); await updateDeviceList(); resizeCanvas(); window.addEventListener('resize', resizeCanvas); requestAnimationFrame(drawLoop); checkSensorPerms(); } 
    catch (e) { console.warn("Init Error:", e); }
  }
  async function updateDeviceList() {
    try {
      const allDevices = await navigator.mediaDevices.enumerateDevices();
      state.devices = allDevices.filter(d => d.kind === 'videoinput');
      if (state.devices.length > 1) { DOM.btnSwitch.classList.remove('hidden'); } else { DOM.btnSwitch.classList.add('hidden'); }
      if (state.track) {
        const currentId = state.track.getSettings().deviceId;
        state.currentDevIdx = state.devices.findIndex(d => d.deviceId === currentId);
        if(state.currentDevIdx === -1) state.currentDevIdx = 0;
      }
    } catch(e) {}
  }

  function drawLoop() {
    const ctx = DOM.ctx; const w = DOM.canvas.width; const h = DOM.canvas.height;
    ctx.clearRect(0, 0, w, h);
    if (state.uiMode === 'menu') { requestAnimationFrame(drawLoop); return; }
    
    const cx = w / 2; const cy = h / 2;
    const cardRatio = 1.586; const cardW = w * 0.22; const cardH = cardW * cardRatio;
    const cardX = cx + 80; const cardY = cy - cardH / 2; const r = 8; 
    ctx.beginPath(); ctx.moveTo(cardX + r, cardY); ctx.lineTo(cardX + cardW - r, cardY); ctx.quadraticCurveTo(cardX + cardW, cardY, cardX + cardW, cardY + r); ctx.lineTo(cardX + cardW, cardY + cardH - r); ctx.quadraticCurveTo(cardX + cardW, cardY + cardH, cardX + cardW - r, cardY + cardH); ctx.lineTo(cardX + r, cardY + cardH); ctx.quadraticCurveTo(cardX, cardY + cardH, cardX, cardY + cardH - r); ctx.lineTo(cardX, cardY + r); ctx.quadraticCurveTo(cardX, cardY, cardX + r, cardY);
    ctx.fillStyle = 'rgba(255, 255, 255, 0.2)'; ctx.fill(); 
    ctx.save(); ctx.translate(cardX + cardW / 2, cardY + cardH / 2); ctx.rotate(-Math.PI / 2); ctx.fillStyle = '#ffffff'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.font = 'bold 12px sans-serif'; ctx.fillText("CREDIT CARD", 0, -10); ctx.font = '10px sans-serif'; ctx.fillText("(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)", 0, 10); ctx.restore(); 

    if (state.sensorActive) {
        const rBubble = 14; const rTarget = 18; const maxOffset = 60; 
        const rawX = (isNaN(state.angleY) || state.angleY === null) ? 0 : state.angleY;
        const rawY = (isNaN(state.angleX) || state.angleX === null) ? 0 : state.angleX;
        const clamp = (val) => Math.max(-20, Math.min(20, val));
        const dx = (clamp(rawX) / 20) * maxOffset; const dy = (clamp(rawY) / 20) * maxOffset;
        const dist = Math.hypot(dx, dy);
        const isInside = (dist + rBubble) <= rTarget;
        if (state.levelOK !== isInside && !state.isCapturing && !state.isSwitching) { state.levelOK = isInside; updateUI(); if(isInside) haptic('medium'); }
        ctx.shadowBlur = 4; ctx.shadowColor = 'rgba(0,0,0,0.5)';
        ctx.beginPath(); ctx.arc(cx, cy, rTarget, 0, Math.PI * 2); 
        const color = (state.levelOK || state.isCapturing) ? '#30d158' : 'rgba(255,255,255,0.85)';
        ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.stroke();
        ctx.beginPath(); ctx.arc(cx + dx, cy + dy, rBubble, 0, Math.PI * 2); ctx.fillStyle = color; ctx.fill(); ctx.shadowBlur = 0;
    } else {
        ctx.strokeStyle = 'rgba(255,255,255,0.5)'; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(cx-10, cy); ctx.lineTo(cx+10, cy); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(cx, cy-10); ctx.lineTo(cx, cy+10); ctx.stroke();
    }
    requestAnimationFrame(drawLoop);
  }

DOM.shutter.addEventListener('click', async () => {
    if (state.isCapturing || state.isSwitching) return; 
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–≤–Ω—è
    if (state.sensorActive && !state.levelOK) { 
        haptic('error'); 
        showToast("–í—ã—Ä–æ–≤–Ω—è–π—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω"); 
        return; 
    }
    
    try {
        state.isCapturing = true; 
        haptic('heavy');
        DOM.shutter.style.transform = 'scale(0.8)'; 
        DOM.shutter.style.opacity = '0.5';
        
        await new Promise(r => setTimeout(r, 50));
        const vid = DOM.video;
        
        if (vid.readyState < 2 || vid.videoWidth === 0) throw new Error("–ö–∞–º–µ—Ä–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞");

        // === –í–ê–ñ–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–ñ–ê–¢–ò–ï –§–û–¢–û ===
        const MAX_SIDE = 1024; // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –¥–æ 1024px (—ç—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –ò–ò)
        let w = vid.videoWidth;
        let h = vid.videoHeight;
        
        // –°—á–∏—Ç–∞–µ–º –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
        if (w > h) {
          if (w > MAX_SIDE) { h *= MAX_SIDE / w; w = MAX_SIDE; }
        } else {
          if (h > MAX_SIDE) { w *= MAX_SIDE / h; h = MAX_SIDE; }
        }

        // –†–∏—Å—É–µ–º —É–º–µ–Ω—å—à–µ–Ω–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º —Ö–æ–ª—Å—Ç–µ
        const c = document.createElement('canvas'); 
        c.width = w; 
        c.height = h;
        const ctx = c.getContext('2d');
        ctx.drawImage(vid, 0, 0, w, h);
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ Base64 —Å –∫–∞—á–µ—Å—Ç–≤–æ–º 0.7 (—Å–∏–ª—å–Ω–æ —ç–∫–æ–Ω–æ–º–∏—Ç –º–µ—Å—Ç–æ)
        const blob = await new Promise(resolve => c.toBlob(resolve, 'image/jpeg', 0.7)); 
        // === –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ===

        if (!blob) throw new Error("–ü—É—Å—Ç–æ–π –∫–∞–¥—Ä");
        showPreview(blob);

    } catch(err) {
        console.error(err); 
        haptic('error'); 
        showToast("–û—à–∏–±–∫–∞: " + err.message);
        state.isCapturing = false; 
        updateUI();
    } finally {
        DOM.shutter.style.transform = ''; 
        DOM.shutter.style.opacity = ''; 
        state.isCapturing = false;
    }
  });

  function showPreview(blob) {
    if(!blob) return; state.photoBlob = blob;
    DOM.finalImg.src = URL.createObjectURL(blob); DOM.preview.style.display = 'flex';
  }
  function retake() {
    DOM.preview.style.display = 'none';
    if(DOM.finalImg.src) URL.revokeObjectURL(DOM.finalImg.src);
    DOM.finalImg.src = ''; state.photoBlob = null; DOM.commentInput.value = ''; 
  }

  // --- üî• –û–¢–ü–†–ê–í–ö–ê –ù–ê –ë–≠–ö (–ò–°–ü–†–ê–í–õ–ï–ù–û –î–õ–Ø CORS) ---
  async function sendPhoto() {
    const btn = DOM.btnSend;
    if (btn.disabled) return; 
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
    DOM.preview.style.display = 'none'; 
    haptic('heavy');

    try {
        if (!state.photoBlob) throw new Error("–ù–µ—Ç —Ñ–æ—Ç–æ");
        
        // 1. –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é "–î—É–º–∞—é..."
        startProcessingUI('photo');
        
        // 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        const base64 = await API.blobToBase64(state.photoBlob);
        const userText = DOM.commentInput.value;
        
        // 3. –†–µ–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ API (—ç—Ç–æ –∑–∞–π–º–µ—Ç 10-20 —Å–µ–∫)
        // –í —ç—Ç–æ –≤—Ä–µ–º—è –∫—Ä—É—Ç–∏—Ç—Å—è –∞–Ω–∏–º–∞—Ü–∏—è
        const result = await API.send('scan', { image: base64, userText: userText });
        
        // 4. –ï—Å–ª–∏ —É—Å–ø–µ—Ö - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Draft Sheet
        stopProcessingUI(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
        
        if (result.ok) {
           openDraftSheet(result.data, result.scanId);
        } else {
           throw new Error(result.error || "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
        }

    } catch (e) {
        stopProcessingUI();
        console.error(e);
        haptic('error');
        alert("–û—à–∏–±–∫–∞: " + e.message);
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º UI –∫–∞–º–µ—Ä—ã
        DOM.preview.style.display = 'flex'; 
        btn.disabled = false;
    }
  }

  function haptic(style) { 
    if (!tg || !tg.HapticFeedback) return;
    
    // –†–∞–∑–¥–µ–ª—è–µ–º —Ç–∏–ø—ã –≤–∏–±—Ä–∞—Ü–∏–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Telegram
    if (['error', 'success', 'warning'].includes(style)) {
      tg.HapticFeedback.notificationOccurred(style);
    } else {
      // light, medium, heavy, rigid, soft
      tg.HapticFeedback.impactOccurred(style);
    }
  }

  // === UI –õ–û–ì–ò–ö–ê: –ê–ù–ò–ú–ê–¶–ò–Ø –ü–†–û–¶–ï–°–°–ê (Smart Routing) ===
  let procInterval;
  
  function startProcessingUI(mode) {
    const container = document.getElementById('procSteps');
    const overlay = document.getElementById('procOverlay');
    
    // 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —à–∞–≥–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
    if (mode === 'text') {
        // --- TEXT ROUTE ---
        container.innerHTML = `
            <div class="step pending" id="step-1"><div class="s-icon">üõ°Ô∏è</div><div class="s-lbl">Gatekeeper: –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞...</div></div>
            <div class="step pending" id="step-2"><div class="s-icon">üß†</div><div class="s-lbl">TextParser: –ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ USDA...</div></div>
            <div class="step pending" id="step-3"><div class="s-icon">üìù</div><div class="s-lbl">Synthesizer: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...</div></div>
        `;
    } else {
        // --- PHOTO ROUTE (Default Plate Flow) ---
        // –ú—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å "–¢–∞—Ä–µ–ª–∫–∏", —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ —Å–∞–º—ã–π –∫—Ä–∞—Å–∏–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π.
        // –ï—Å–ª–∏ —ç—Ç–æ –æ–∫–∞–∂–µ—Ç—Å—è –£–ø–∞–∫–æ–≤–∫–∞ (Librarian), —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—Ç–∏—Ç —Ä–∞–Ω—å—à–µ, –∏ –º—ã –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä–æ–µ–º –æ–∫–Ω–æ, —á—Ç–æ —Ç–æ–∂–µ –æ–∫.
        container.innerHTML = `
            <div class="step pending" id="step-1"><div class="s-icon">üõ°Ô∏è</div><div class="s-lbl">Gatekeeper: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞...</div></div>
            <div class="step pending" id="step-2"><div class="s-icon">üïµÔ∏è</div><div class="s-lbl">Detective: –ü–æ–∏—Å–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤...</div></div>
            <div class="step pending" id="step-3"><div class="s-icon">üìê</div><div class="s-lbl">Physicist: –†–∞—Å—á–µ—Ç –≤–µ—Å–∞ (3D)...</div></div>
            <div class="step pending" id="step-4"><div class="s-icon">üç≥</div><div class="s-lbl">Technologist: –ê–Ω–∞–ª–∏–∑ –∂–∏—Ä–Ω–æ—Å—Ç–∏...</div></div>
            <div class="step pending" id="step-5"><div class="s-icon">üìù</div><div class="s-lbl">Synthesizer: –°–±–æ—Ä–∫–∞ –æ—Ç—á–µ—Ç–∞...</div></div>
        `;
    }

    overlay.classList.add('active');
    
    // 2. –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —à–∞–≥–æ–≤
    let step = 1;
    const maxSteps = mode === 'text' ? 3 : 5;
    
    updateStep(1, 'active');

    procInterval = setInterval(() => {
       updateStep(step, 'done');
       step++;
       if(step > maxSteps) step = maxSteps; 
       updateStep(step, 'active');
    }, 2000); // –ß—É—Ç—å –±—ã—Å—Ç—Ä–µ–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –¥–ª—è –¥–∏–Ω–∞–º–∏–∫–∏
  }

  function updateStep(num, status) {
    const el = document.getElementById('step-'+num);
    if(el) {
      el.classList.remove('pending', 'active', 'done');
      el.classList.add(status);
    }
  }

  function stopProcessingUI() {
    clearInterval(procInterval);
    document.getElementById('procOverlay').classList.remove('active');
  }

  function cancelProcessing() {
    stopProcessingUI();
    retake();
  }

  // === UI –õ–û–ì–ò–ö–ê: DRAFT SHEET (–í–ê–õ–ò–î–ê–¶–ò–Ø) ===
  let currentDraftItems = []; // –ó–¥–µ—Å—å —Ö—Ä–∞–Ω–∏–º —Ç–æ, —á—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —é–∑–µ—Ä
  let currentScanId = null;

  function openDraftSheet(data, scanId) {
    currentScanId = scanId;
    // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –∏–ª–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
    if (!data || !data.items) {
       alert("–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
       return;
    }
    
    currentDraftItems = data.items; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–∞–º—è—Ç—å
    renderDraftList();
    
    document.getElementById('draftOverlay').classList.add('visible');
    haptic('success');
  }

  function renderDraftList() {
    const container = document.getElementById('draftList');
    container.innerHTML = '';
    
    if (currentDraftItems.length === 0) {
      container.innerHTML = '<div style="text-align:center; opacity:0.5; padding:20px">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>';
      return;
    }

    currentDraftItems.forEach((item, index) => {
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∫–æ–Ω–∫—É –ø–æ —Ç–∏–ø—É (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏–∫—É)
      let icon = "üçΩÔ∏è";
      if (item.cooking_method === 'Raw') icon = "üçé";
      if (item.fat_modifier === 'High Oil') icon = "üç≥";
      
      const div = document.createElement('div');
      div.className = 'draft-item';
      div.innerHTML = `
        <div class="di-icon">${icon}</div>
        <div class="di-inputs">
          <input type="text" class="di-name" value="${item.name}" onchange="updateDraftItem(${index}, 'name', this.value)">
          <div class="di-row">
            <input type="number" class="di-weight" value="${item.weight_g || ''}" placeholder="0" onchange="updateDraftItem(${index}, 'weight_g', this.value)">
            <div class="di-unit">–≥</div>
          </div>
        </div>
        <div class="di-del" onclick="removeDraftItem(${index})">‚úï</div>
      `;
      container.appendChild(div);
    });
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å—Ç–µ–π—Ç–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ
  window.updateDraftItem = (index, field, value) => {
    if (field === 'weight_g') value = parseInt(value) || 0;
    currentDraftItems[index][field] = value;
  };

  window.removeDraftItem = (index) => {
    currentDraftItems.splice(index, 1);
    renderDraftList();
  };

  window.closeDraft = () => {
    document.getElementById('draftOverlay').classList.remove('visible');
    retake(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–∞–º–µ—Ä—É
  };

  // === –§–ò–ù–ê–õ: –û–¢–ü–†–ê–í–ö–ê –ù–£–¢–†–ò–¶–ò–û–õ–û–ì–£ ===
  window.confirmDraftToNutritionist = async () => {
    const btn = document.getElementById('btnConfirmDraft');
    btn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
    btn.disabled = true;
    
    try {
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º action: 'calculate' –Ω–∞ –±—ç–∫—ç–Ω–¥
      // –ë—ç–∫—ç–Ω–¥ –∑–∞–ø—É—Å—Ç–∏—Ç Nutritionist –±–æ—Ç–∞ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –ö–ë–ñ–£ –ø–æ —ç—Ç–∏–º –≤–µ—Å–∞–º
      const result = await API.send('calculate', { 
        data: currentDraftItems, 
        scanId: currentScanId 
      });
      
      // –î–∞–ª–µ–µ –º—ã –¥–æ–ª–∂–Ω—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç—Ç–æ –≤ –¥–Ω–µ–≤–Ω–∏–∫ (action: save_meal)
      // –ò–ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –∏—Ç–æ–≥. –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –∞–ª–µ—Ä—Ç –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ.
      
      haptic('success');
      document.getElementById('draftOverlay').classList.remove('visible');
      
      // –¢—É—Ç –≤ –±—É–¥—É—â–µ–º –±—É–¥–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é –∏–ª–∏ –∞–Ω–∏–º–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –ª–µ–Ω—Ç—É
      alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –¥–Ω–µ–≤–Ω–∏–∫! \n" + JSON.stringify(result.data?.total_nutrition || {}));
      
      retake(); // –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å

    } catch (e) {
      alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + e.message);
    } finally {
      btn.textContent = '–í –¥–Ω–µ–≤–Ω–∏–∫';
      btn.disabled = false;
    }
  };


</script>
</body>
</html>
