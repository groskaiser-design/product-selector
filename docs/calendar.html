<!DOCTYPE html>
<html lang="ru">
<head>
<script src="version-control.js?t=1"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Ultima Coach Infinite</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  /* === CORE STYLES === */
  :root {
    --bg-core: #050505; 
    --bg-panel: #1C1C1E; 
    --bg-elevated: #2C2C2E;
    --text-main: #ffffff;
    --text-muted: #8E8E93;
    
    --line-color: rgba(255, 255, 255, 0.08);
    --time-col-width: 55px;
    --day-col-width: 65px; 
    
    --acc-blue: #0a84ff;
    --acc-red: #ff453a;
    --acc-green: #30d158;
    --acc-purple: #5e60ce;
    --acc-orange: #ff9f0a;
    --acc-current: #3c9cfd;
    
    --grid-h: 60px;
    --safe-top: env(safe-area-inset-top);
    --safe-bottom: env(safe-area-inset-bottom);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
  *::-webkit-scrollbar { display: none; }

  body {
    background-color: var(--bg-core);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', Roboto, sans-serif;
    color: var(--text-main);
    height: 100%; width: 100%;
    overflow: hidden; position: fixed; inset: 0; user-select: none;
    -webkit-user-select: none;
  }

  /* === FX LAYER === */
  .fx-layer { position: absolute; inset: 0; z-index: 0; pointer-events: none; }
  .orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.5; will-change: transform; }
  .orb-1 { width: 300px; height: 300px; background: var(--acc-purple); top: -50px; left: -100px; animation: float 20s infinite ease-in-out; }
  .orb-2 { width: 250px; height: 250px; background: var(--acc-blue); bottom: -50px; right: -50px; animation: float 15s infinite ease-in-out reverse; }
  .noise { position: fixed; inset: 0; opacity: 0.04; background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); }
  @keyframes float { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(30px, 50px); } }

  /* === LAYOUT === */
  .app-container { display: flex; flex-direction: column; height: 100%; width: 100%; position: relative; z-index: 1; }

  /* === TOP HEADER === */
  .top-area {
    position: relative;
    background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--line-color); padding-top: calc(10px + var(--safe-top)); padding-bottom: 4px;
    z-index: 60; flex-shrink: 0;
  }
  .header-row { display: flex; justify-content: space-between; align-items: center; padding: 0 16px; margin-bottom: 10px; }
  .month-label { font-family: 'SF Pro Display', sans-serif; font-size: 15px; font-weight: 700; color: #fff; text-transform: uppercase; letter-spacing: 1px; }
  .week-controls { display: flex; gap: 16px; align-items: center; }
  .icon-btn { width: 32px; height: 32px; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s opacity; }
  .icon-btn:active { opacity: 0.6; }
  /* Стиль для иконок из GitHub */
  .icon-btn img {
      width: 24px;
      height: 24px;
      display: block;
      pointer-events: none; /* Чтобы клик проходил сквозь картинку на кнопку */
  }

  /* === MATRIX === */
  .matrix-viewport {
    flex: 1; overflow: auto; position: relative; -webkit-overflow-scrolling: touch; overscroll-behavior: none;
    display: flex; flex-direction: column; z-index: 10;
  }
  .matrix-header-row {
    display: flex; position: sticky; top: 0; z-index: 40; width: max-content; background: rgba(0, 0, 0, 0.25);
    backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-bottom: 1px solid var(--line-color);
  }
  .corner-cell { width: var(--time-col-width); flex-shrink: 0; position: sticky; left: 0; z-index: 50; background: inherit; border-right: 1px solid var(--line-color); }
  .days-header-track { display: flex; flex: 1; }
  .day-col-header {
    width: var(--day-col-width); flex-shrink: 0; text-align: center; height: 58px; 
    padding: 8px 0 0 0;
    font-size: 11px; color: var(--text-muted); border-right: 1px solid var(--line-color);
    display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
    gap: 2px; position: relative; cursor: pointer;
  }
  .dch-day { font-weight: 600; text-transform: uppercase; line-height: 1; }
  .dch-num { font-size: 16px; font-weight: 500; color: #fff; line-height: 1; }
  
  .day-col-header.today { background: rgba(10, 132, 255, 0.15); border-bottom: 2px solid var(--acc-blue); }
  .day-col-header.today .dch-day { color: var(--acc-blue); }
  .day-col-header.today .dch-num { color: #fff; font-weight: 700; }

/* UPDATED STATS BAR */
  .dch-stats { 
    width: 44px; height: 4px; 
    background: rgba(255,255,255,0.15); /* Чуть ярче фон (серый) */
    border-radius: 2px; margin-top: 5px; 
    overflow: hidden; display: none; /* Скрыт по умолчанию, JS покажет */
    justify-content: flex-start; /* Чтобы полоска росла слева */
  }
  .day-col-header.today .dch-stats { background: rgba(255,255,255,0.25); }
  
  .dch-stats-fill { 
      height: 100%; 
      background: var(--acc-current); 
      width: 0%; 
      transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), background 0.3s ease; 
      border-radius: 2px;
  }
  .dch-stats.has-data .dch-stats-fill { min-width: 6px; }
  
  .matrix-body { display: flex; width: max-content; position: relative; }
  .time-column {
    width: var(--time-col-width); flex-shrink: 0; position: sticky; left: 0; z-index: 30;
    background: rgba(0, 0, 0, 0.25); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
    border-right: 1px solid var(--line-color); padding-bottom: 20px;
  }
  .time-label { height: var(--grid-h); position: relative; cursor: pointer; } 
  .time-label span { position: absolute; top: -7px; right: 6px; font-size: 11px; font-weight: 500; color: var(--text-muted); font-variant-numeric: tabular-nums; }
  
  .time-line-badge {
    position: absolute; right: 4px; background: var(--acc-current); color: #fff; font-size: 11px; font-weight: 700;
    padding: 2px 6px; border-radius: 4px; z-index: 31; transform: translateY(-50%); pointer-events: none;
    font-variant-numeric: tabular-nums; text-align: center; min-width: 40px; display: none;
  }
  .grid-columns-container { display: flex; flex: 1; position: relative; }
  
  .day-column {
    width: var(--day-col-width); flex-shrink: 0; border-right: 1px solid var(--line-color); position: relative;
    background-image: linear-gradient(to bottom, var(--line-color) 1px, transparent 1px); background-size: 100% var(--grid-h);
    padding-bottom: 20px; cursor: pointer;
    touch-action: pan-y; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none;
  }
  .day-column.today { background-color: rgba(10, 132, 255, 0.02); }
  
  .touch-feedback {
    position: absolute; width: 100%; background: rgba(60, 156, 253, 0.25); border-radius: 4px; pointer-events: none; z-index: 20;
    animation: pulse-create 0.6s infinite ease-in-out; border: 1px solid var(--acc-current);
    display: flex; align-items: center; justify-content: center;
  }
  .touch-feedback::after { content: '+'; font-size: 24px; font-weight: 300; color: #fff; opacity: 0.9; }
  @keyframes pulse-create { 0% { opacity: 0.3; transform: scale(0.98); } 50% { opacity: 0.7; transform: scale(1.0); } 100% { opacity: 0.3; transform: scale(0.98); } }
  
  .blocked-slot { position: absolute; left: 0; right: 0; height: var(--grid-h); background: repeating-linear-gradient(45deg, rgba(255,255,255,0.03), rgba(255,255,255,0.03) 10px, rgba(255,255,255,0.06) 10px, rgba(255,255,255,0.06) 20px); pointer-events: none; z-index: 1; }
  .blocked-range-part { position: absolute; left: 0; right: 0; background-color: var(--bg-core); background-image: repeating-linear-gradient(45deg, rgba(60, 156, 253, 0.1), rgba(60, 156, 253, 0.1) 10px, rgba(60, 156, 253, 0.2) 10px, rgba(60, 156, 253, 0.2) 20px); border-top: 1px solid rgba(60, 156, 253, 0.4); border-bottom: 1px solid rgba(60, 156, 253, 0.4); z-index: 2; pointer-events: none; }
  .day-off-overlay { position: absolute; inset: 0; background-color: var(--bg-core); background-image: repeating-linear-gradient(45deg, rgba(60, 156, 253, 0.1), rgba(60, 156, 253, 0.1) 10px, rgba(60, 156, 253, 0.2) 10px, rgba(60, 156, 253, 0.2) 20px); z-index: 8; pointer-events: none; }
  
  .global-time-line { position: absolute; left: 0; width: 100%; height: 1px; background: var(--acc-current); z-index: 10; pointer-events: none; display: none; }
  .global-time-line::before { content: ''; position: absolute; left: -4px; top: -3px; width: 7px; height: 7px; background: var(--acc-current); border-radius: 50%; }
  
/* === EVENT CARD (FIX: ИКОНКИ В ОДНОМ СТИЛЕ) === */
  .event-card { 
    position: absolute; 
    left: 0; 
    border-radius: 6px; 
    padding: 2px 4px; 
    overflow: hidden; 
    border-left: 3px solid; 
    cursor: pointer; 
    z-index: 5; 
    box-shadow: none; 
    border: 1px solid rgba(255,255,255,0.05); 
    transition: transform 0.1s, width 0.2s, left 0.2s, opacity 0.3s; 
    
    /* Прозрачность для незавершенных */
    opacity: 0.5; 
  }
  
  .event-card:active { transform: scale(0.96); }
  
  /* Тексты */
  .ev-title { 
    font-size: 10px; 
    font-weight: 700; 
    color: #fff; 
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
    line-height: 1.1; 
    text-shadow: 0 1px 2px rgba(0,0,0,0.8); 
  }
  .ev-time { 
    font-size: 8.5px; 
    color: rgba(255,255,255,0.85); 
    margin-top: 1px; 
    font-weight: 500; 
    text-shadow: 0 1px 2px rgba(0,0,0,0.8); 
  }

  /* --- ИКОНКИ (ТЕПЕРЬ ОБЕ SVG) --- */
  
  /* Общие стили для иконок в карточке */
  .card-icon {
      position: absolute;
      bottom: 2px;
      width: 11px;  /* Единый размер */
      height: 11px; /* Единый размер */
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.6));
  }

  /* 1. Иконка повтора (Сдвигаем левее, чтобы не мешала галочке) */
  .ev-recurring-icon { 
      right: 16px; /* Отступ слева от галочки */
      opacity: 0.8; 
  }

  /* 2. Иконка статуса (Галочка) */
  .ev-status-icon {
      right: 3px;   /* В самом углу */
      color: #fff;
      opacity: 1;
  }

  /* СТИЛЬ ЗАВЕРШЕННОЙ (Яркость) */
  .event-card.status-completed {
      opacity: 1 !important;        
      box-shadow: 0 2px 8px rgba(0,0,0,0.4); 
      z-index: 6; 
  }
  
  /* УБИРАЕМ СТАРУЮ ТЕКСТОВУЮ ГАЛОЧКУ */
  .event-card.status-completed::after { content: none; }

  /* Мини-режим */
  .event-card.mini { display: flex; align-items: center; justify-content: center; padding: 0; }
  .event-card.mini .ev-title, .event-card.mini .ev-time, .event-card.mini .ev-recurring-icon { display: none; }
  
  /* В мини-режиме галочка по центру и чуть крупнее */
  .event-card.mini .ev-status-icon { 
      position: static; 
      width: 14px; height: 14px; 
  }
  

  /* === НОВАЯ КНОПКА ЗАВЕРШЕНИЯ В ШТОРКЕ === */
/* === КНОПКА ЗАВЕРШЕНИЯ (ПРАВКА 3: Красивый зеленый) === */
  .btn-status-toggle {
    width: 85%;
    margin: 24px auto 8px auto; 
    padding: 14px;
    
    /* Красивый градиент (Emerald/Green) вместо плоского цвета */
    background: linear-gradient(135deg, #2ecc71, #27ae60);
    
    color: #fff;
    font-weight: 700;
    font-size: 16px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: 0.2s;
    box-shadow: 0 6px 15px -3px rgba(46, 204, 113, 0.4); /* Тень в цвет кнопки */
  }
  .btn-status-toggle:active { transform: scale(0.98); opacity: 0.9; }
  
  /* Режим отмены */
  .btn-status-toggle.undo-mode {
      background: rgba(255,255,255,0.08); /* Чуть темнее */
      color: var(--text-muted);
      box-shadow: none;
      font-weight: 500;
  }

  /* === OVERLAYS === */
  .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(4px); }
  .sheet-overlay.active { opacity: 1; pointer-events: auto; }
  
  /* === ОБНОВЛЕННАЯ ШТОРКА (STEKLO) === */
  .sheet { 
    position: fixed; bottom: 0; left: 0; right: 0; 
    
    /* Эффект стекла */
    background: rgba(28, 28, 30, 0.6); 
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.08); 
    border-bottom: none;
    border-radius: 24px 24px 0 0; 
    box-shadow: 0 -4px 24px -1px rgba(0, 0, 0, 0.2);
    
    padding: 0 16px calc(24px + var(--safe-bottom)) 16px; 
    transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); 
    z-index: 101; 
    max-height: 90vh; overflow-y: auto; 
  }
  .sheet.open { transform: translateY(0); }

  .sheet-header { 
    display: flex; justify-content: space-between; align-items: center; 
    margin: 0 -16px 20px -16px; 
    position: sticky; top: 0; 
    z-index: 10; 
    padding: 24px 16px 16px 16px; 
    
    /* Эффект стекла для заголовка */
    background: rgba(28, 28, 30, 0.6); 
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 24px 24px 0 0;
  }

  /* ACTION SHEET (CONFIRMATION) */
  .action-sheet-container {
    position: fixed; bottom: 0; left: 0; right: 0; z-index: 150;
    padding: 16px; padding-bottom: calc(16px + var(--safe-bottom));
    transform: translateY(110%); transition: transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  .action-sheet-container.open { transform: translateY(0); }
  
/* === ОБНОВЛЕННОЕ МЕНЮ ДЕЙСТВИЙ (STEKLO) === */
  .as-group { 
    /* Эффект стекла */
    background: rgba(28, 28, 30, 0.6); 
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.08); 
    border-radius: 24px; 
    box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.2);
    
    overflow: hidden; margin-bottom: 8px; 
  }

  .as-cancel { 
    /* Эффект стекла */
    background: rgba(28, 28, 30, 0.6); 
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.08); 
    border-radius: 24px; 
    box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.2);
    
    color: var(--acc-blue); font-weight: 600; 
  }
  
  .as-button { width: 100%; padding: 16px; background: transparent; border: none; border-bottom: 1px solid rgba(255,255,255,0.1); color: var(--acc-blue); font-size: 17px; font-weight: 400; cursor: pointer; }
  .as-button:last-child { border-bottom: none; }
  .as-button:active { background: rgba(255,255,255,0.1); }
  .as-button.danger { color: var(--acc-red); }
  .as-button.bold { font-weight: 600; }
  .as-title { padding: 12px 16px; font-size: 13px; color: var(--text-muted); text-align: center; font-weight: 500; border-bottom: 1px solid rgba(255,255,255,0.1); }
  
  /* FORM STYLES */
  .sheet-header { display: flex; justify-content: space-between; align-items: center; margin: 0 -16px 20px -16px; position: sticky; top: 0; background: var(--bg-panel); z-index: 10; padding: 24px 16px 10px 16px; border-radius: 20px 20px 0 0; }

  /* УНИФИЦИРОВАННЫЙ ЗАГОЛОВОК ШТОРКИ */
.sh-title { 
  font-size: 17px;       /* Было 18px, делаем стандарт iOS */
  font-weight: 600;      /* Жирность чуть мягче (было 700) */
  color: #fff; 
  line-height: 1.2;
  letter-spacing: -0.4px; /* Плотнее буквы */
}
  
  .sh-close { color: var(--acc-blue); font-size: 16px; font-weight: 500; cursor: pointer; }
  
  .form-group { margin-bottom: 16px; }
  .form-label { font-size: 12px; color: #8E8E93; margin-bottom: 6px; margin-left: 2px; text-transform: uppercase; }
  
  .input-box { width: 100%; background: rgba(118, 118, 128, 0.24); border: none; border-radius: 10px; padding: 12px; color: #fff; font-size: 16px; appearance: none; -webkit-appearance: none; }
  .input-box[type="date"] { color: #fff; }
  
  .input-row { display: flex; gap: 12px; }
/* === ЗАМЕНИ ВЕСЬ ЭТОТ БЛОК === */
.btn-primary {
  width: 85%; /* Было 100%. Делаем уже. */
  margin: 12px auto 0 auto; /* Центрируем кнопку */
  padding: 14px;
  
  /* Синий фон и белый текст */
  background: var(--acc-blue);
  color: #fff;
  
  font-weight: 600;
  font-size: 16px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
  
  .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
  .btn-danger { background: rgba(255, 69, 58, 0.15); color: var(--acc-red); }
  
  /* SWITCH */
  .switch { position: relative; display: inline-block; width: 50px; height: 30px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #3a3a3c; transition: .4s; border-radius: 30px; }
  .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: var(--acc-blue); }
  input:checked + .slider:before { transform: translateX(20px); }

  .pattern-info-box { background: rgba(10, 132, 255, 0.1); border: 1px solid rgba(10, 132, 255, 0.3); border-radius: 8px; padding: 10px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
  .pib-icon { color: var(--acc-blue); }
  .pib-text { font-size: 13px; color: #fff; flex: 1; line-height: 1.3; }

  /* FIXED LAYOUT SHEET for Clients */
  .sheet.fixed-layout { display: flex; flex-direction: column; height: 85vh; padding: 0; overflow: hidden; }
  .sheet.fixed-layout .sheet-header { margin: 0; padding: 20px 16px 10px 16px; flex-shrink: 0; position: relative; top: auto; }
  .sheet-fixed-section { padding: 0 16px; flex-shrink: 0; }
  .sheet-scroll-area { flex: 1; overflow-y: auto; padding: 10px 16px; -webkit-overflow-scrolling: touch; }
  .sheet-fixed-footer { padding: 16px 16px calc(16px + var(--safe-bottom)) 16px; border-top: 1px solid rgba(255,255,255,0.05); background: var(--bg-panel); flex-shrink: 0; z-index: 10; }

  /* CLIENTS */
  .client-list-item { display: flex; align-items: center; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; margin-bottom: 8px; cursor: pointer; }
  .color-dot { width: 16px; height: 16px; border-radius: 50%; margin-right: 12px; border: 2px solid rgba(255,255,255,0.1); }
  .client-name { flex: 1; font-weight: 500; }
  .color-grid { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 16px; padding: 10px 0; }
  .color-option { width: 44px; height: 44px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
  .color-option.selected { border-color: #fff; transform: scale(1.1); }
  
  /* RANGES LIST */
  .ranges-list { max-height: 200px; overflow-y: auto; margin-top: 10px; }
  .range-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 8px; }
  .range-text { font-size: 14px; color: #fff; }
  .range-sub { font-size: 12px; color: #8E8E93; margin-top: 2px; }
  .range-actions { display: flex; gap: 12px; }
  .range-icon { color: var(--text-muted); cursor: pointer; }
  .range-icon.edit { color: var(--acc-blue); }
  .range-icon.del { color: var(--acc-red); }

  /* SCHED ROWS */
  .sched-row { display: flex; align-items: center; margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 12px; }
  .sched-day { width: 40px; font-weight: 600; font-size: 14px; color: #fff; }
  .sched-slots { flex: 1; display: flex; flex-wrap: wrap; gap: 6px; }
  .sched-chip { padding: 6px 10px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
  .sched-add { background: rgba(255,255,255,0.1); color: #fff; width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; }

  /* TOAST */
 /* === ОБНОВЛЕННОЕ УВЕДОМЛЕНИЕ (STEKLO) === */
  .toast-notification {
    position: fixed; top: calc(20px + var(--safe-top)); left: 16px; right: 16px;
    
    /* Эффект стекла */
    background: rgba(28, 28, 30, 0.6); 
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.08); 
    border-radius: 24px; 
    box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.2);
    
    color: #fff; padding: 16px;
    z-index: 9999; 
    font-size: 14px; font-weight: 500; text-align: center;
    transform: translateY(-150%); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    pointer-events: none; opacity: 0;
  }
  .toast-notification.show { transform: translateY(0); opacity: 1; }
  .toast-notification span { color: var(--acc-red); font-weight: 700; display: block; margin-bottom: 4px; font-size: 12px; text-transform: uppercase; }
  .toast-notification.success span { color: var(--acc-green); }

  /* === PATTERN EDITOR (REDESIGN: LAUNCHPAD STYLE) === */
  .pattern-editor-overlay {
    position: fixed; inset: 0; background: var(--bg-core); z-index: 200;
    display: flex; flex-direction: column;
    transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
  }
  .pattern-editor-overlay.open { transform: translateY(0); }

  /* Header */
  .pe-header {
    background: rgba(28, 28, 30, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(255,255,255,0.1);
    padding-top: calc(10px + var(--safe-top)); padding-bottom: 12px;
    flex-shrink: 0; display: flex; align-items: center; justify-content: space-between;
    padding-left: 16px; padding-right: 16px; z-index: 202;
  }

  /* ЗАГОЛОВОК ГРАФИКА (Pattern Editor) */
.pe-title { 
  font-size: 17px;       /* Приводим к единому 17px */
  font-weight: 600; 
  color: #fff; 
  text-align: center; 
  flex: 1; 
  letter-spacing: -0.4px;
}
  
  .pe-btn { font-size: 15px; font-weight: 500; cursor: pointer; padding: 8px; }
  .pe-close { color: var(--acc-red); }
  .pe-save { color: var(--acc-blue); font-weight: 600; }

  /* Matrix Container */
  .pe-viewport {
    flex: 1; overflow: auto; position: relative;
    background: var(--bg-core);
    display: flex; flex-direction: column;
  }

  /* Grid Layout */
  .pe-grid {
    display: grid;
    /* 1 колонка времени (50px) + 7 колонок дней */
    grid-template-columns: 50px repeat(7, 1fr);
    /* Шапка + 24 часа */
    grid-template-rows: 40px repeat(24, 44px);
    gap: 4px;
    padding: 10px;
    padding-bottom: 40px;
  }

  /* Sticky Headers */
  .pe-col-header {
    position: sticky; top: 0; z-index: 201;
    background: var(--bg-core);
    color: var(--text-muted); font-size: 12px; font-weight: 600;
    display: flex; align-items: center; justify-content: center;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    text-transform: uppercase;
  }
  .pe-time-label {
    position: sticky; left: 0; z-index: 200;
    background: var(--bg-core);
    color: var(--text-muted); font-size: 11px; font-weight: 500;
    display: flex; align-items: center; justify-content: flex-end;
    padding-right: 8px;
    border-right: 1px solid rgba(255,255,255,0.1);
  }
  /* Corner (Top-Left) */
  .pe-corner {
    position: sticky; top: 0; left: 0; z-index: 202;
    background: var(--bg-core);
    border-bottom: 1px solid rgba(255,255,255,0.1);
    border-right: 1px solid rgba(255,255,255,0.1);
  }

  /* Interactive Cells (Buttons) */
  .pe-cell {
    background: rgba(255, 255, 255, 0.06); /* Inactive State: Dark Grey */
    border-radius: 6px;
    border: 1px solid rgba(255, 255, 255, 0.05);
    transition: all 0.15s ease;
    cursor: pointer;
  }
  
  /* ACTIVE STATE: The "Working" hour */
  .pe-cell.active {
    background: var(--acc-blue);
    border-color: var(--acc-blue);
    box-shadow: 0 0 12px rgba(10, 132, 255, 0.4); /* Glow Effect */
  }

  /* STRIPED BACKGROUND */
  .stripe-bg {
      background-image: linear-gradient(
          45deg,
          rgba(255, 255, 255, 0.03) 25%,
          transparent 25%,
          transparent 50%,
          rgba(255, 255, 255, 0.03) 50%,
          rgba(255, 255, 255, 0.03) 75%,
          transparent 75%,
          transparent
      );
      background-size: 28.28px 28.28px;
      background-repeat: repeat;
  }

  /* NOISE TEXTURE */
  .pattern-editor-overlay::before {
    content: "";
    position: absolute;
    inset: 0;
    opacity: 0.04;
    background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
  }

  .pattern-editor-overlay > * {
    position: relative;
    z-index: 2;
  }

  /* DAY DASHBOARD STYLES */
  .day-stats-container {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
    margin-bottom: 24px;
    /* === ВОТ ЭТО ДОБАВЛЯЕМ === */
    margin-top: 16px;
  }
  .stat-card {
    background: rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 12px 8px;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.05);
  }
  .stat-value {
    font-size: 18px;
    font-weight: 700;
    color: #fff;
    margin-bottom: 2px;
    font-variant-numeric: tabular-nums;
  }
  .stat-label {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .day-events-header {
    font-size: 13px;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 10px;
    padding-left: 4px;
    font-weight: 600;
  }
  
  .day-events-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding-bottom: 20px;
  }
  
/* === ИСПРАВЛЕНИЕ СПИСКА (FIXED) === */
  .de-item {
    display: flex;
    align-items: center;
    background: rgba(255, 255, 255, 0.03);
    padding: 12px 14px;
    border-radius: 12px;
    border-left: 3px solid transparent;
    /* 1. Добавляем жесткий отступ между временем и именем */
    gap: 16px; 
  }

  .de-time {
    /* 2. Единый стиль шрифта */
    font-size: 16px;
    font-weight: 500; 
    color: #fff;
    
    /* 3. Фиксируем ширину, чтобы цифры стояли ровно в столбик */
    min-width: 105px; 
    font-variant-numeric: tabular-nums;
    white-space: nowrap;
    text-align: left; /* Выравнивание времени влево */
  }
  
  .de-name {
    /* 2. Единый стиль шрифта (такой же как у времени) */
    font-size: 16px;
    font-weight: 500;
    color: #fff;
    
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .de-empty {
    text-align: center;
    color: var(--text-muted);
    padding: 20px;
    font-size: 14px;
    background: rgba(255,255,255,0.02);
    border-radius: 12px;
    border: 1px dashed rgba(255,255,255,0.1);
  }

  /* MINI CARD MODE */
  .event-card.mini {
      display: flex; align-items: center; justify-content: center; padding: 0;
  }
  .event-card.mini .ev-title, .event-card.mini .ev-time { display: none; }
  .event-card.mini .ev-recurring-icon { position: static; width: 14px; height: 14px; opacity: 0.9; color: rgba(255,255,255,0.8); }

/* Hint Footer in Pattern Editor */
  .pe-footer-hint {
    padding: 12px 16px calc(12px + var(--safe-bottom)) 16px;
    background: var(--bg-panel);
    border-top: 1px solid rgba(255,255,255,0.1);
    text-align: center;
    color: var(--text-muted);
    font-size: 13px;
    line-height: 1.4;
    z-index: 202;
  }
  .pe-footer-hint span {
    color: var(--acc-blue); font-weight: 500;
  }
  
  /* Arrows in headers */
  .pe-col-header .arrow {
      font-size: 10px; 
      opacity: 0.4; 
      margin-left: 2px; 
      transform: translateY(-1px); 
      display: inline-block;
  }

  /* Вставь это просто в конец <style> или найди, если уже есть inline */
#sheetDateSubtitle {
  font-size: 13px !important;
  color: var(--acc-blue) !important; 
  font-weight: 500 !important; 
  margin-top: 2px;
  letter-spacing: 0;
}

/* === АНАЛИТИКА (STRICT MODE) === */
  
  /* Переключатель периодов */
  .period-switch {
    display: flex; background: rgba(118, 118, 128, 0.24); 
    border-radius: 9px; padding: 2px; margin-bottom: 20px;
  }
  .p-btn {
    flex: 1; text-align: center; padding: 6px 0; font-size: 13px; font-weight: 500; 
    color: #fff; border-radius: 7px; transition: 0.2s;
  }
  .p-btn.active { background: #636366; color: #fff; box-shadow: 0 3px 8px rgba(0,0,0,0.2); font-weight: 600; }
  
  /* Поля дат (скрыты по умолчанию) */
  .custom-dates-row {
    display: flex; gap: 10px; margin-bottom: 20px; display: none;
    animation: fadeIn 0.3s ease;
  }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

  /* Главный виджет (Пончик) */
  .analytics-overview {
    display: flex; align-items: center; justify-content: space-between;
    background: linear-gradient(165deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.03) 100%);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 20px; padding: 20px; margin-bottom: 24px;
    box-shadow: 0 12px 32px rgba(0,0,0,0.3);
  }
  
  .ao-info { display: flex; flex-direction: column; gap: 4px; }
  .ao-label { font-size: 13px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .ao-val { font-size: 32px; font-weight: 800; color: #fff; line-height: 1; }
  .ao-sub { font-size: 13px; color: var(--text-muted); font-weight: 500; margin-top: 4px; }
  
  .ao-chart { width: 80px; height: 80px; position: relative; display: flex; align-items: center; justify-content: center; }
  .donut-svg { width: 100%; height: 100%; transform: rotate(-90deg); }
  .d-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 8; }
  
  .d-val { 
      fill: none; 
      stroke: var(--acc-blue); /* Строгий синий цвет */
      stroke-width: 8; stroke-linecap: round; 
      stroke-dasharray: 220; 
      stroke-dashoffset: 220; 
      transition: stroke-dashoffset 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  .d-icon { position: absolute; font-size: 24px; }

  /* Список клиентов */
  .stats-list-header { font-size: 17px; font-weight: 600; margin-bottom: 12px; color: #fff; letter-spacing: -0.4px; }
  
  .client-stat-card {
    background: rgba(255, 255, 255, 0.05); 
    border-radius: 12px; padding: 12px 16px; margin-bottom: 8px;
    border: 1px solid rgba(255,255,255,0.05);
    border-left: 4px solid transparent; /* Цвет задаст JS */
  }
  .csc-row-top { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 15px; font-weight: 500; }
  .csc-name { color: #fff; }
  .csc-nums { color: var(--text-muted); font-variant-numeric: tabular-nums; font-size: 13px; }
  .csc-nums span { color: #fff; font-weight: 600; font-size: 15px; }

  .progress-track { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
  
  /* Полоска всегда синяя */
  .progress-fill { 
      height: 100%; width: 0%; 
      transition: width 1s ease 0.2s; 
      border-radius: 3px; 
      background: var(--acc-blue) !important; 
  }
  
  .empty-state { text-align: center; color: var(--text-muted); padding: 30px; font-size: 14px; }
  
  
</style>
</head>
<body oncontextmenu="return false;">

<div class="fx-layer"><div class="orb orb-1"></div><div class="orb orb-2"></div><div class="noise"></div></div>

<div class="toast-notification" id="toast">
  <span id="toastTitle">Обратите внимание</span>
  <div id="toastMessage">Обычно вы не работаете в это время</div>
</div>

<div class="app-container">
  <div class="top-area">
    <div class="header-row">
      <div class="month-label" id="headerMonth">НОЯБРЬ 2025</div>
      <div class="week-controls">
        
        <div class="icon-btn" id="analyticsBtn" onclick="openAnalytics()">
          <img src="https://raw.githubusercontent.com/groskaiser-design/icons/main/analytics.svg" alt="Analytics">
        </div>

        <div class="icon-btn" id="settingsBtn" onclick="openSettings()">
          <img src="https://raw.githubusercontent.com/groskaiser-design/icons/main/settings.svg" alt="Settings">
        </div>

      </div>
    </div>
  </div>

  <div class="matrix-viewport" id="matrixViewport">
    <div class="matrix-header-row">
      <div class="corner-cell"></div>
      <div class="days-header-track" id="daysHeaderTrack"></div>
    </div>
    <div class="matrix-body">
      <div class="time-column" id="timeColumn"><div class="time-line-badge" id="timeLineBadge">00:00</div></div>
      <div class="grid-columns-container" id="gridColumns"><div class="global-time-line" id="globalTimeLine"></div></div>
    </div>
  </div>
</div>



<div class="sheet-overlay" id="overlay" onclick="closeAllSheets()"></div>

<div class="sheet-overlay" id="actionSheetOverlay" style="z-index:140" onclick="closeActionSheet()"></div>
<div class="action-sheet-container" id="actionSheet">
  <div class="as-group">
    <div class="as-title" id="asTitle">Изменение повторяющегося события</div>
    <button class="as-button" id="asBtnOne">Только эта тренировка</button>
    <button class="as-button bold" id="asBtnSeries">Вся серия</button>
  </div>
  <button class="as-button as-cancel" onclick="closeActionSheet()">Отмена</button>
</div>

<div class="pattern-editor-overlay" id="patternEditor">
  <div class="pe-header">
    <div class="pe-btn pe-close" onclick="closePatternEditor()">Отмена</div>
    <div class="pe-title">График работы</div>
    <div class="pe-btn pe-save" onclick="savePattern()">Готово</div>
  </div>
  
  <div class="pe-viewport">
    <div id="peGrid" class="pe-grid">
      </div>
  </div>

  <div class="pe-footer-hint">
    Нажмите на <span>День недели</span> или <span>Время</span>,<br>чтобы заполнить весь ряд целиком.
  </div>
</div>
  

<div class="sheet" id="sessionSheet">
  <div class="sheet-header" style="align-items: flex-start;">
    <div>
      <div class="sh-title" id="sheetTitle">Тренировка</div>
      <div id="sheetDateSubtitle" style="font-size: 13px; color: var(--acc-blue); font-weight: 500; margin-top: 2px;">
        </div>
    </div>
    <div class="sh-close" onclick="closeAllSheets()">Отмена</div>
  </div>
  
  <input type="hidden" id="inpDate">

  <div id="patternInfoBox" class="pattern-info-box" style="display:none">
    <div class="pib-icon">
       <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
    </div>
    <div class="pib-text">Эта тренировка — часть регулярного расписания.</div>
  </div>

  <div class="form-group">
    <div class="form-label">Клиент</div>
    <select class="input-box" id="inpClient"></select>
  </div>

  <div class="input-row">
    <div class="form-group" style="flex:1">
      <div class="form-label">Начало</div>
      <input type="time" class="input-box" id="inpStart" onchange="autoSetEndTime()">
    </div>
    <div class="form-group" style="flex:1">
      <div class="form-label">Конец</div>
      <input type="time" class="input-box" id="inpEnd">
    </div>
  </div>

  <div class="form-group"><div class="form-label">Заметка</div><input type="text" class="input-box" id="inpNote" placeholder="Тип тренировки..."></div>
  
  <div class="form-group" id="recurringOptionContainer" style="display: flex; align-items: center; gap: 12px; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; margin-bottom: 0px;">
    <div style="flex: 1; font-size: 16px;">Повторять еженедельно</div>
    <label class="switch">
      <input type="checkbox" id="inpRecurring" onchange="toggleSeriesInput()">
      <span class="slider"></span>
    </label>
  </div>
  
  <div id="seriesCountContainer" style="display: none; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 0 0 10px 10px; margin-top: 1px; margin-bottom: 16px;">
    <div class="form-label">Количество тренировок</div>
    <div class="input-row">
       <input type="number" class="input-box" id="inpSeriesCount" value="4" min="2" max="100" placeholder="Например: 4">
    </div>
    <div style="font-size: 11px; color: #8E8E93; margin-top: 6px;">
       Будет создана серия на указанное количество недель вперед.
    </div>
  </div>

<button class="btn-status-toggle" id="btnStatusToggle" onclick="toggleSessionStatus()" style="display:none">
     <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
     Завершить тренировку
  </button>
  
  <button class="btn-primary" onclick="trySaveSession()">Сохранить</button>
  <button class="btn-primary btn-danger" id="btnDelete" style="display:none" onclick="tryDeleteSession()">Удалить</button>
</div>

<div class="sheet" id="settingsSheet">
  <div class="sheet-header">
    <div class="sh-title">Настройки</div>
    <div class="sh-close" onclick="closeAllSheets()">Готово</div>
  </div>

  <div class="form-group">
    <div class="form-label" style="margin-left: 0;">Задать график работы</div>
    <button class="btn-primary" onclick="openPatternEditor()">Перейти</button>
  </div>

  <div class="form-group" style="margin-top: 24px;">
    <div class="form-label" style="margin-left: 0;">Добавить отсутствие</div>
    <button class="btn-primary btn-secondary" onclick="openRangesSheet()">Например отпуск</button>
  </div>

  <div class="form-group" style="margin-top: 24px;">
    <div class="form-label" style="margin-left: 0;">Ограничить изменения</div>
    
   <select class="input-box" id="settingCancelWindow" onchange="saveCoachSettings()" style="width: 85%; margin: 0 auto; display: block; text-align: center; text-align-last: center;">
      <option value="0">В любое время</option>
      <option value="1">За 1 час</option>
      <option value="2">За 2 часа</option>
      <option value="6">За 6 часов</option>
      <option value="12">За 12 часов</option>
      <option value="24" selected>За 24 часа (Стандарт)</option>
      <option value="48">За 48 часов</option>
    </select>
    
<div style="font-size: 12px; color: #8E8E93; margin-top: 8px; line-height: 1.35;">
      Клиент не сможет перенести запись, если до начала осталось меньше времени.
    </div>
  </div>
</div> <div class="sheet" id="analyticsSheet">
  <div class="sheet-header">
    <div class="sh-title">Аналитика</div>
    <div class="sh-close" onclick="closeAllSheets()">Закрыть</div>
  </div>
  
  <div class="period-switch">
    <div class="p-btn active" onclick="setAnalyticsPeriod('week', this)">Неделя</div>
    <div class="p-btn" onclick="setAnalyticsPeriod('month', this)">Месяц</div>
    <div class="p-btn" onclick="setAnalyticsPeriod('custom', this)">Период</div>
  </div>

  <div class="custom-dates-row" id="anCustomDates">
    <input type="date" class="input-box" id="anStart" onchange="refreshAnalytics()">
    <input type="date" class="input-box" id="anEnd" onchange="refreshAnalytics()">
  </div>

  <div class="analytics-overview">
    <div class="ao-info">
      <div class="ao-label">Эффективность</div>
      <div class="ao-val" id="anPercent">0%</div>
      <div class="ao-sub" id="anTotalStats">0 из 0 выполнено</div>
    </div>
    <div class="ao-chart">
      <svg class="donut-svg" viewBox="0 0 80 80">
        <circle class="d-bg" cx="40" cy="40" r="35"/>
        <circle class="d-val" id="anDonutCircle" cx="40" cy="40" r="35"/>
      </svg>
      <div class="d-icon"></div>
    </div>
  </div>

  <div class="stats-list-header">Детализация по клиентам</div>
  <div id="analyticsList" style="padding-bottom: 20px;"></div>
</div>
  

<div class="sheet" id="rangesSheet">
  <div class="sheet-header"><div class="sh-title">Отпуск / Периоды</div><div class="sh-close" onclick="closeAllSheets()">Закрыть</div></div>
  <div class="input-row"><input type="date" class="input-box" id="rangeStartDate"><input type="time" class="input-box" id="rangeStartTime" value="00:00"></div>
  <div class="input-row" style="margin-top:8px"><input type="date" class="input-box" id="rangeEndDate"><input type="time" class="input-box" id="rangeEndTime" value="23:59"></div>
  <button class="btn-primary" id="rangeSubmitBtn" onclick="addRange()" style="margin-top:12px">Добавить период</button>
  <div class="ranges-list" id="rangesList"></div>
</div>



<div class="sheet fixed-layout" id="dayOptionsSheet" style="height: 70vh;">
  <div class="sheet-header">
    <div class="sh-title" id="doDateHeader">Дата</div>
    <div class="sh-close" onclick="closeAllSheets()">Закрыть</div>
  </div>
  
  <div class="sheet-scroll-area" style="padding-top: 0;">
    
    <div class="day-stats-container">
      <div class="stat-card">
        <div class="stat-value" id="doWorkHours">0ч</div>
        <div class="stat-label">Рабочий план</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="doBusyHours">0ч</div>
        <div class="stat-label">Занято</div>
      </div>
      <div class="stat-card" id="statLoadCard">
        <div class="stat-value" id="doLoadPercent">0%</div>
        <div class="stat-label">Загрузка</div>
      </div>
    </div>

    <div class="day-events-header">Расписание</div>
    <div id="doEventsList" class="day-events-list">
      </div>
  </div>

  <div class="sheet-fixed-footer">
    <button id="btnDayToggle" class="btn-primary" onclick="handleDayToggle()">
      Сделать выходным
    </button>
  </div>
</div>

<script src="calendar.js"></script>

</body>
</html>
