<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
<title>Ultima Profile</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  /* 0. SCROLLBAR HIDE */
  ::-webkit-scrollbar { width: 0 !important; height: 0 !important; display: none !important; background: transparent !important; }
  * { -ms-overflow-style: none !important; scrollbar-width: none !important; }

  /* 1. VARS */
  :root {
    --bg-core: #050505;
    --text-main: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.55);
    --acc-blue: #0a84ff;
    --acc-red: #ff453a;
    --acc-green: #30d158;
    --radius-l: 24px;
    --pad: 16px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

  body {
    background-color: var(--bg-core);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', Roboto, sans-serif;
    color: var(--text-main);
    min-height: 100vh;
    overflow-x: hidden;
    padding-bottom: 120px;
  }

  body.lock-scroll { overflow: hidden !important; height: 100vh; touch-action: none; }

  /* 2. FX LAYER */
  .fx-layer { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
  .orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.4; }
  .orb-1 { top: -10%; left: -20%; width: 300px; height: 300px; background: #5e60ce; animation: breathe 10s infinite; }
  .orb-2 { bottom: 10%; right: -10%; width: 250px; height: 250px; background: var(--acc-blue); animation: breathe 12s infinite reverse; }
  .noise { position: fixed; inset: 0; opacity: 0.05; background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); }
  @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.3; } 50% { transform: scale(1.1); opacity: 0.5; } }

  /* 3. LAYOUT */
  .app-shell { max-width: 480px; margin: 0 auto; padding: var(--pad); padding-top: calc(20px + env(safe-area-inset-top)); }

  /* 4. HERO */
  .profile-hero { display: flex; align-items: center; gap: 20px; margin-bottom: 32px; padding: 0 4px; }
  .avatar-ring { width: 88px; height: 88px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; position: relative; }
  .avatar-img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; background: #222; }
  .avatar-glow { position: absolute; inset: 0; border-radius: 50%; background: radial-gradient(circle, var(--acc-blue), transparent 70%); opacity: 0.3; filter: blur(20px); z-index: -1; }
  .profile-meta { display: flex; flex-direction: column; gap: 8px; min-width: 0; }
  .user-name { font-size: 26px; font-weight: 800; margin: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .user-id-badge { display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 20px; font-size: 13px; color: var(--text-muted); cursor: pointer; }
  .copy-icon { opacity: 0.6; width: 14px; height: 14px; }

  /* 5. SECTIONS */
  .section-head { display: flex; justify-content: space-between; margin-bottom: 14px; padding: 0 4px; }
  .section-title { font-size: 20px; font-weight: 700; }
  .section-action { font-size: 14px; color: var(--acc-blue); font-weight: 500; cursor: pointer; padding: 4px; }
  
  .mentors-grid { display: flex; flex-direction: column; gap: 10px; margin-bottom: 32px; }
  .mentor-card { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(20px); border-radius: 20px; display: flex; align-items: center; justify-content: space-between; padding: 14px 18px; }
  .m-info { display: flex; align-items: center; gap: 14px; }
  .m-av { width: 44px; height: 44px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; border: 1px solid rgba(255,255,255,0.15); }
  .m-details { display: flex; flex-direction: column; }
  .m-status { font-size: 10px; color: var(--acc-green); text-transform: uppercase; font-weight: 700; opacity: 0.9; margin-bottom: 2px; }
  .m-name { font-weight: 700; font-size: 16px; }
  .m-id { font-size: 12px; color: var(--text-muted); font-family: monospace; }
  .m-del { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(255,69,58,0.1); color: var(--acc-red); }

  .rituals-list { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(20px); border-radius: var(--radius-l); overflow: hidden; margin-bottom: 32px; display: flex; flex-direction: column; }
  .ritual-item { display: flex; justify-content: space-between; padding: 18px 20px; position: relative; align-items: center; }
  .ritual-item::after { content: ''; position: absolute; bottom: 0; left: 20px; right: 0; height: 1px; background: rgba(255,255,255,0.1); }
  .ritual-item:last-child::after { display: none; }
  .r-left { display: flex; flex-direction: column; gap: 4px; }
  .r-time { font-size: 28px; font-weight: 300; line-height: 1; }
  .r-title { font-size: 13px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
  .r-days { font-size: 11px; color: var(--acc-blue); margin-top: 2px; }
  
  .switch { position: relative; width: 51px; height: 31px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; inset: 0; background: rgba(255,255,255,0.15); border-radius: 34px; transition: .4s; }
  .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background: var(--acc-blue); }
  input:checked + .slider:before { transform: translateX(20px); }

  .empty-state { text-align: center; padding: 30px; color: var(--text-muted); border: 1px dashed rgba(255,255,255,0.1); border-radius: var(--radius-l); }

  /* ============================================================
   * 6. MODALS (FLEX FIX FOR KEYBOARD)
   * ============================================================ */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100;
    backdrop-filter: blur(6px); opacity: 0; pointer-events: none; transition: 0.3s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: auto; }

  .bottom-sheet {
    position: fixed; left: 0; right: 0; bottom: 0;
    background: rgba(20, 20, 20, 0.95);
    backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
    border-top: 1px solid rgba(255,255,255,0.2);
    box-shadow: 0 -10px 60px rgba(0,0,0,0.7);
    border-radius: 28px 28px 0 0;
    z-index: 101;
    
    /* FLEX LAYOUT LOGIC */
    display: flex;
    flex-direction: column;
    max-height: 90vh; /* Максимум 90% высоты экрана */
    height: auto;
    
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    
    /* Важно: переносим padding внутрь блоков, чтобы работала высота */
    padding: 24px;
    padding-bottom: 0; /* Padding снизу будет у футера */
  }
  
  .modal-overlay.open .bottom-sheet { transform: translateY(0); }

  /* ЗАГОЛОВОК (Фиксированный) */
  .bs-header { 
    flex: 0 0 auto;
    display: flex; justify-content: space-between; align-items: center; 
    margin-bottom: 20px; 
  }
  .bs-title { font-size: 18px; font-weight: 700; }
  .bs-close { font-size: 14px; font-weight: 600; color: var(--acc-blue); background: none; border: none; padding: 8px; }

  /* ТЕЛО (Скроллируемое и Сжимаемое) */
  .bs-body {
    flex: 1 1 auto;       /* Растягиваться и сжиматься */
    overflow-y: auto;     /* Скролл если не влезает */
    min-height: 0;        /* Разрешает сжатие меньше контента */
    margin-bottom: 10px;  /* Отступ до кнопок */
    padding: 4px;         /* Для теней инпутов */
    
    /* Скрываем скроллбар */
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  .bs-body::-webkit-scrollbar { display: none; }

  /* ФУТЕР (Всегда виден над клавиатурой) */
  .bs-footer {
    flex: 0 0 auto; /* Не сжиматься */
    padding-bottom: calc(20px + env(safe-area-inset-bottom)); /* Отступ под iPhone полоску */
    background: transparent;
  }

  .input-group { margin-bottom: 20px; }
  .input-label { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; font-weight: 700; padding-left: 4px; }
  .ultima-input { width: 100%; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 16px; color: #fff; font-size: 17px; }
  .ultima-input:focus { border-color: var(--acc-blue); background: rgba(0,0,0,0.4); }

  .time-picker-row { display: flex; justify-content: center; margin-bottom: 24px; }
  .huge-time-input { background: transparent; border: none; color: #fff; font-size: 56px; font-weight: 200; text-align: center; width: 100%; font-family: -apple-system, sans-serif; }
  input[type="time"]::-webkit-calendar-picker-indicator { display: none; }

  .day-selector { display: flex; justify-content: space-between; margin-bottom: 24px; }
  .day-btn { width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-muted); font-size: 13px; font-weight: 600; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
  .day-btn.active { background: #fff; color: #000; transform: scale(1.05); }

  .action-btn { width: 100%; padding: 16px; border-radius: 16px; background: var(--acc-blue); color: #fff; font-size: 17px; font-weight: 700; border: none; cursor: pointer; text-align: center; }
  .action-btn:active { transform: scale(0.98); opacity: 0.9; }
  .action-btn.delete { background: rgba(255,69,58,0.15); color: var(--acc-red); margin-top: 12px; border: 1px solid rgba(255,69,58,0.3); }

</style>
</head>
<body>

<div class="fx-layer">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="noise"></div>
</div>

<div class="app-shell">
  <div class="profile-hero">
    <div class="avatar-wrapper">
      <div class="avatar-ring">
        <img src="https://i.pravatar.cc/300?img=11" class="avatar-img" id="userAvatar">
      </div>
      <div class="avatar-glow"></div>
    </div>
    <div class="profile-meta">
      <h1 class="user-name" id="userName">Александр</h1>
      <div class="user-id-badge" onclick="copyId()">
        ID: <span id="userIdDisplay">1849</span>
        <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
      </div>
    </div>
  </div>

  <div class="section-head">
    <div class="section-title">Тренеры</div>
    <div class="section-action" onclick="openTrainerModal()">+ Добавить</div>
  </div>
  <div id="trainersList" class="mentors-grid"></div>

  <div class="section-head">
    <div class="section-title">Ритуалы и Напоминания</div>
    <div class="section-action" onclick="openAlarmModal()">+ Создать</div>
  </div>
  <div id="alarmsList" class="rituals-list"></div>
</div>

<div id="modalTrainer" class="modal-overlay">
  <div class="bottom-sheet">
    <div class="bs-header">
      <div class="bs-title" id="trainerModalTitle">Новый наставник</div>
      <button class="bs-close" onclick="closeModal('modalTrainer')">Закрыть</button>
    </div>
    
    <div class="bs-body">
      <input type="hidden" id="editTrainerUid">

      <div class="input-group">
        <label class="input-label">Имя тренера (Обязательно)</label>
        <input type="text" id="trainerInputName" class="ultima-input" placeholder="Например: Алина" autocomplete="off">
      </div>

      <div class="input-group">
        <label class="input-label">ID тренера (Только цифры)</label>
        <input type="tel" id="trainerInputId" class="ultima-input" 
               placeholder="Например: 123456789" 
               inputmode="numeric" 
               pattern="[0-9]*" 
               oninput="this.value = this.value.replace(/[^0-9]/g, '')"
               autocomplete="off">
      </div>
    </div>

    <div class="bs-footer">
      <button class="action-btn" id="btnSaveTrainer" onclick="saveTrainer()">Подключить</button>
      <button class="action-btn delete" id="btnDeleteTrainer" onclick="deleteTrainerFromModal()" style="display:none">Удалить</button>
    </div>
  </div>
</div>

<div id="modalAlarm" class="modal-overlay">
  <div class="bottom-sheet">
    <div class="bs-header">
      <div class="bs-title">Настройка ритуала</div>
      <button class="bs-close" onclick="closeModal('modalAlarm')">Закрыть</button>
    </div>
    
    <div class="bs-body">
      <input type="hidden" id="editAlarmId">

      <div class="time-picker-row">
        <input type="time" id="alarmTime" class="huge-time-input" value="09:00">
      </div>

      <div class="input-group">
        <label class="input-label">Название</label>
        <input type="text" id="alarmTitle" class="ultima-input" placeholder="Например: Взвешивание">
      </div>

      <div class="input-group">
        <label class="input-label">Повторять</label>
        <div class="day-selector" id="daySelector">
          <div class="day-btn" data-day="Пн">Пн</div>
          <div class="day-btn" data-day="Вт">Вт</div>
          <div class="day-btn" data-day="Ср">Ср</div>
          <div class="day-btn" data-day="Чт">Чт</div>
          <div class="day-btn" data-day="Пт">Пт</div>
          <div class="day-btn active" data-day="Сб">Сб</div>
          <div class="day-btn" data-day="Вс">Вс</div>
        </div>
      </div>
    </div>

    <div class="bs-footer">
      <button class="action-btn" onclick="saveAlarmFromModal()">Сохранить</button>
      <button class="action-btn delete" id="btnDeleteAlarm" onclick="deleteAlarmFromModal()" style="display:none">Удалить</button>
    </div>
  </div>
</div>

<script>
// --- CONFIG ---
const GAS_URL = 'https://script.google.com/macros/s/AKfycbzQbW4Bqmwq_51k9Op_CLJa5IX9v_MYkgXde2y3fAqqHX5wsvbSN7Uw9OpXFPP6raU/exec'; 
const STORAGE_KEY = 'ultima_profile_v1';
const PHOTO_CACHE_KEY = 'ultima_photos_v1';
const PHOTO_TTL = 24 * 60 * 60 * 1000; 

let appState = loadState();
const tg = window.Telegram?.WebApp;

// --- INIT ---
(function initTMA() {
  if (!tg) return;
  tg.ready(); tg.expand();
  try { tg.setHeaderColor('#050505'); if (tg.setBackgroundColor) tg.setBackgroundColor('#050505'); } catch (e) {}
  try { if (tg.disableVerticalSwipes) tg.disableVerticalSwipes(); } catch (e) {}
  
  if (tg.BackButton) {
    tg.BackButton.show();
    tg.BackButton.onClick(() => {
        if(document.referrer && document.referrer.includes(window.location.host)) history.back();
        else window.location.href = 'router.html';
    });
  }
})();

document.addEventListener('DOMContentLoaded', () => {
  if(tg && tg.initDataUnsafe?.user) {
      const u = tg.initDataUnsafe.user;
      if (u.first_name) document.getElementById('userName').textContent = escapeHtml(u.first_name);
      appState.userId = String(u.id); 
      document.getElementById('userIdDisplay').textContent = appState.userId;
      if(u.photo_url) document.getElementById('userAvatar').src = u.photo_url;
  }
  appState.timezoneOffset = new Date().getTimezoneOffset();
  renderTrainers(); renderAlarms(); initDaySelector(); syncLoad();
  
  // FIX: Force scroll to view on focus for old iOS
  document.querySelectorAll('input').forEach(inp => {
    inp.addEventListener('focus', () => {
      setTimeout(() => {
        const activeModal = document.querySelector('.modal-overlay.open .bs-footer');
        if(activeModal) activeModal.scrollIntoView({behavior:'smooth', block:'end'});
      }, 400);
    });
  });
});

// --- SYNC ---
async function syncLoad() {
  if (!GAS_URL.includes('/exec')) return;
  try {
    const r = await fetch(GAS_URL, {
      method: 'POST', body: JSON.stringify({ action: 'sync_profile', type: 'load', userId: appState.userId, rowIndex: appState.rowIndex, timezoneOffset: appState.timezoneOffset })
    });
    const d = await r.json();
    if (d.ok) {
      if (d.rowIndex) appState.rowIndex = d.rowIndex;
      const localS = JSON.stringify({t: appState.trainers, a: appState.alarms});
      const serverS = JSON.stringify({t: d.trainers, a: d.alarms});
      
      const serverEmpty = (!d.trainers?.length && !d.alarms?.length);
      const localHasData = (appState.trainers.length || appState.alarms.length);

      if (serverEmpty && localHasData) { syncSave(); } 
      else if (localS !== serverS) {
        appState.trainers = d.trainers || [];
        appState.alarms = d.alarms || [];
        saveState(); renderTrainers(); renderAlarms();
      } else { saveState(); }
    }
  } catch (e) { console.error(e); }
}

function syncSave() {
  saveState();
  if (!GAS_URL.includes('/exec')) return;
  fetch(GAS_URL, {
    method: 'POST', body: JSON.stringify({ action: 'sync_profile', type: 'save', userId: appState.userId, rowIndex: appState.rowIndex, trainers: appState.trainers, alarms: appState.alarms, timezoneOffset: appState.timezoneOffset })
  }).then(r=>r.json()).then(d=>{ if(d.ok && d.rowIndex){ appState.rowIndex = d.rowIndex; saveState(); } });
}

// --- PHOTO CACHE ---
async function fetchTrainerPhoto(tid, elId) {
  if (!tid) return;
  const cacheKey = `photo_${tid}`;
  let cached = null;
  try { cached = JSON.parse(localStorage.getItem(PHOTO_CACHE_KEY))[cacheKey]; } catch(e){}
  
  const img = document.getElementById(elId);
  if (cached && cached.data) {
    if(img) { img.style.backgroundImage = `url('${cached.data}')`; img.innerHTML = ''; }
    if (Date.now() - cached.time < PHOTO_TTL) return;
  }
  
  if (GAS_URL.includes('/exec')) {
    fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'get_trainer_photo', trainer_id: tid }) })
      .then(r=>r.json()).then(d => {
        if(d.ok && d.photo) {
           if(img) { img.style.backgroundImage = `url('${d.photo}')`; img.innerHTML = ''; }
           const all = JSON.parse(localStorage.getItem(PHOTO_CACHE_KEY) || '{}');
           all[cacheKey] = { data: d.photo, time: Date.now() };
           localStorage.setItem(PHOTO_CACHE_KEY, JSON.stringify(all));
        }
      });
  }
}

// --- RENDER ---
function renderTrainers() {
  const l = document.getElementById('trainersList'); l.innerHTML = '';
  if (!appState.trainers.length) { l.innerHTML = '<div class="empty-state">Нет подключенных тренеров</div>'; return; }
  appState.trainers.forEach((t, i) => {
    const uid = `t_img_${i}`;
    const d = document.createElement('div'); d.className = 'mentor-card';
    d.innerHTML = `
      <div class="m-info">
        <div class="m-av" id="${uid}" style="background-size:cover;background-position:center">${t.name[0]?.toUpperCase()||'?'}</div>
        <div class="m-details"><div class="m-status">Получает статистику</div><div class="m-name">${escapeHtml(t.name)}</div><div class="m-id">${escapeHtml(t.id||'')}</div></div>
      </div>
      <div class="m-del" onclick="event.stopPropagation(); removeTrainer('${t.uid}')"><svg width="18" height="18" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></div>`;
    d.onclick = () => openTrainerModal(t.uid);
    l.appendChild(d);
    if(t.id) fetchTrainerPhoto(t.id, uid);
  });
}

function renderAlarms() {
  const l = document.getElementById('alarmsList'); l.innerHTML = '';
  appState.alarms.sort((a,b)=>a.time.localeCompare(b.time)).forEach(a => {
    const d = document.createElement('div'); d.className = 'ritual-item';
    d.innerHTML = `
      <div class="r-left" onclick="openAlarmModal(${a.id})">
        <div class="r-time" style="opacity:${a.active?1:0.4}">${a.time}</div>
        <div class="r-title">${escapeHtml(a.title)}</div>
        <div class="r-days">${a.days.length===7?'Каждый день':a.days.join(', ')}</div>
      </div>
      <label class="switch"><input type="checkbox" ${a.active?'checked':''} onchange="toggleAlarm(${a.id}, this.checked)"><span class="slider"></span></label>`;
    l.appendChild(d);
  });
}

// --- ACTIONS ---
function saveTrainer() {
  const n = document.getElementById('trainerInputName').value.trim();
  const id = document.getElementById('trainerInputId').value.trim();
  const uid = document.getElementById('editTrainerUid').value;
  if(!n) return safeShowPopup('Ошибка', 'Введите имя');
  if(id && !/^\d+$/.test(id)) return safeShowPopup('Ошибка', 'ID только цифры');
  
  if(uid) { const i=appState.trainers.findIndex(x=>x.uid==uid); if(i>-1) appState.trainers[i]={...appState.trainers[i], name:n, id:id}; }
  else { if(appState.trainers.length>=10) return safeShowPopup('Лимит', 'Максимум 10'); appState.trainers.push({uid:Date.now(), name:n, id:id}); }
  
  syncSave(); renderTrainers(); closeModal('modalTrainer'); haptic('success');
}

function removeTrainer(uid) {
  safeShowConfirm('Удалить тренера?', ok => {
    if(ok) {
      appState.trainers = appState.trainers.filter(x=>x.uid!=uid);
      syncSave(); renderTrainers(); haptic('success'); closeModal('modalTrainer');
    }
  });
}
function deleteTrainerFromModal() { removeTrainer(document.getElementById('editTrainerUid').value); }

function toggleAlarm(id, s) { const i=appState.alarms.findIndex(x=>x.id==id); if(i>-1){appState.alarms[i].active=s; syncSave(); renderAlarms(); haptic('light');} }

function saveAlarmFromModal() {
  const id = document.getElementById('editAlarmId').value;
  const time = document.getElementById('alarmTime').value;
  const title = document.getElementById('alarmTitle').value.trim() || 'Ритуал';
  const days = Array.from(document.querySelectorAll('.day-btn.active')).map(b=>b.dataset.day);
  if(!days.length) days.push('Пн');
  
  if(id) { const i=appState.alarms.findIndex(x=>x.id==id); if(i>-1) appState.alarms[i]={...appState.alarms[i], time, title, days}; }
  else { appState.alarms.push({id:Date.now(), time, title, days, active:true}); }
  syncSave(); renderAlarms(); closeModal('modalAlarm'); haptic('success');
}
function deleteAlarmFromModal() {
  const id = document.getElementById('editAlarmId').value;
  if(id) { appState.alarms = appState.alarms.filter(x=>x.id!=id); syncSave(); renderAlarms(); closeModal('modalAlarm'); haptic('success'); }
}

// --- UI UTILS ---
function openTrainerModal(uid) {
  const m = document.getElementById('modalTrainer');
  if(uid) {
    const t = appState.trainers.find(x=>x.uid==uid);
    document.getElementById('trainerModalTitle').textContent = 'Редактирование';
    document.getElementById('btnSaveTrainer').textContent = 'Сохранить';
    document.getElementById('editTrainerUid').value = t.uid;
    document.getElementById('trainerInputName').value = t.name;
    document.getElementById('trainerInputId').value = t.id||'';
    document.getElementById('btnDeleteTrainer').style.display = 'block';
  } else {
    document.getElementById('trainerModalTitle').textContent = 'Новый наставник';
    document.getElementById('btnSaveTrainer').textContent = 'Подключить';
    document.getElementById('editTrainerUid').value = '';
    document.getElementById('trainerInputName').value = '';
    document.getElementById('trainerInputId').value = '';
    document.getElementById('btnDeleteTrainer').style.display = 'none';
  }
  m.classList.add('open'); document.body.classList.add('lock-scroll');
}

function openAlarmModal(id) {
  const m = document.getElementById('modalAlarm');
  document.getElementById('editAlarmId').value = id || '';
  if(id) {
    const a = appState.alarms.find(x=>x.id==id);
    document.getElementById('alarmTime').value = a.time;
    document.getElementById('alarmTitle').value = a.title;
    document.querySelectorAll('.day-btn').forEach(b => b.classList.toggle('active', a.days.includes(b.dataset.day)));
    document.getElementById('btnDeleteAlarm').style.display = 'block';
  } else {
    document.getElementById('alarmTime').value = '08:00';
    document.getElementById('alarmTitle').value = '';
    document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('btnDeleteAlarm').style.display = 'none';
  }
  m.classList.add('open'); document.body.classList.add('lock-scroll');
}

function closeModal(id) { document.getElementById(id).classList.remove('open'); document.body.classList.remove('lock-scroll'); }

function initDaySelector() { document.querySelectorAll('.day-btn').forEach(b => b.onclick = () => { b.classList.toggle('active'); haptic('light'); }); }

function copyId() {
  const t = document.getElementById('userIdDisplay').innerText;
  navigator.clipboard.writeText(t).then(()=>safeShowPopup('Успешно','Copied')).catch(()=>safeShowPopup('ID', t));
  haptic('success');
}

function escapeHtml(t) { return t?t.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):t; }
function haptic(s) { if(tg?.HapticFeedback) tg.HapticFeedback.impactOccurred(s); }
function safeShowPopup(t,m) { tg?.showPopup ? tg.showPopup({title:t,message:m}) : alert(`${t}: ${m}`); }
function safeShowConfirm(m,cb) { tg?.showConfirm ? tg.showConfirm(m,cb) : cb(confirm(m)); }
function loadState() { try{return JSON.parse(localStorage.getItem(STORAGE_KEY))||{userId:'1849',trainers:[],alarms:[]};}catch{return {userId:'1849',trainers:[],alarms:[]};} }
function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appState)); }

</script>
</body>
</html>
