<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Ultima Profile</title>

<!-- Подключение Telegram WebApp SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  /* ============================================================
   * 0. SCROLLBAR HIDE (FORCE)
   * Принудительное скрытие полос прокрутки на всех устройствах
   * ============================================================ */
  
  /* Chrome, Safari, Edge, Opera, iOS */
  ::-webkit-scrollbar {
    width: 0 !important;
    height: 0 !important;
    display: none !important;
    background: transparent !important;
  }
  
  *::-webkit-scrollbar {
    width: 0 !important;
    height: 0 !important;
    display: none !important;
    background: transparent !important;
  }

  /* Firefox, IE, Edge (Legacy) */
  * {
    -ms-overflow-style: none !important;  /* IE и старый Edge */
    scrollbar-width: none !important;  /* Firefox */
  }

  /* ============================================================
   * 1. GLOBAL VARIABLES & RESET
   * ============================================================ */
  :root {
    /* --- Colors --- */
    --bg-core: #050505;
    --text-main: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.55);
    
    /* --- Accents --- */
    --acc-orange: #ff9f0a;
    --acc-green: #30d158;
    --acc-blue: #0a84ff;
    --acc-red: #ff453a;
    --acc-purple: #5e60ce;
    
    /* --- Metrics --- */
    --radius-xl: 28px;
    --radius-l: 24px;
    --radius-m: 16px;
    --pad: 16px;
  }

  * { 
    margin: 0; padding: 0; box-sizing: border-box; 
    -webkit-tap-highlight-color: transparent; outline: none; 
  }

  body {
    background-color: var(--bg-core);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', Roboto, sans-serif;
    color: var(--text-main);
    min-height: 100vh;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    padding-bottom: 120px; /* Отступ под шторки/FAB */
  }

  /* === FIX: Блокировка скролла фона при открытой шторке === */
  body.lock-scroll {
    overflow: hidden !important;
    height: 100vh;
    touch-action: none; /* Запрещает жесты на фоне */
  }

  /* ============================================================
   * 2. BACKGROUND FX (Orbs & Noise)
   * ============================================================ */
  .fx-layer { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
  .orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.4; }
  .orb-1 { top: -10%; left: -20%; width: 300px; height: 300px; background: var(--acc-purple); animation: breathe 10s infinite ease-in-out; }
  .orb-2 { bottom: 10%; right: -10%; width: 250px; height: 250px; background: var(--acc-blue); animation: breathe 12s infinite ease-in-out reverse; }
  .noise { position: fixed; inset: 0; opacity: 0.05; background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); }
  @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.3; } 50% { transform: scale(1.1); opacity: 0.5; } }

  /* ============================================================
   * 3. LAYOUT
   * ============================================================ */
  .app-shell { 
    max-width: 480px; margin: 0 auto; 
    padding: var(--pad); 
    padding-top: calc(20px + env(safe-area-inset-top)); /* Чуть больше отступ сверху, так как нет заголовка */
  }

  /* ============================================================
   * 4. PROFILE HERO (Compact Row Layout)
   * ============================================================ */
  .profile-hero { 
    display: flex; 
    flex-direction: row; /* Горизонтальное расположение */
    align-items: center; 
    justify-content: flex-start;
    gap: 20px; 
    margin-bottom: 32px; 
    position: relative; 
    padding: 0 4px;
  }
  
  .avatar-wrapper { position: relative; flex-shrink: 0; }
  
  .avatar-ring {
    width: 88px; height: 88px; /* Чуть компактнее (было 110) */
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
    border: 1px solid rgba(255,255,255,0.2);
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  }
  .avatar-img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; background: #222; }
  
  .avatar-glow { 
    position: absolute; inset: 0; border-radius: 50%; 
    background: radial-gradient(circle, var(--acc-blue) 0%, transparent 70%); 
    opacity: 0.3; z-index: -1; filter: blur(20px); animation: pulse-glow 4s infinite; 
  }
  @keyframes pulse-glow { 0%, 100% { opacity: 0.2; transform: scale(0.9); } 50% { opacity: 0.5; transform: scale(1.1); } }

  .profile-meta {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
    min-width: 0; /* Для корректного сокращения текста */
  }

  .user-name { 
    font-size: 26px; 
    font-weight: 800; 
    letter-spacing: -0.5px; 
    line-height: 1.1; 
    margin: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 100%;
  }
  
  .user-id-badge {
    display: inline-flex; align-items: center; gap: 6px;
    background: rgba(255,255,255,0.06); 
    border: 1px solid rgba(255,255,255,0.1);
    padding: 6px 12px; border-radius: 20px;
    font-size: 13px; font-family: 'SF Mono', 'Roboto Mono', monospace; 
    color: var(--text-muted);
    cursor: pointer; transition: 0.2s;
  }
  .user-id-badge:active { background: rgba(255,255,255,0.15); transform: scale(0.98); }
  .copy-icon { opacity: 0.6; width: 14px; height: 14px; }

  /* ============================================================
   * 5. SECTIONS & CARDS
   * ============================================================ */
  .section-head { 
    display: flex; align-items: center; justify-content: space-between; 
    margin-bottom: 14px; padding: 0 4px; 
  }
  .section-title { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; }
  .section-action { 
    font-size: 14px; color: var(--acc-blue); font-weight: 500; 
    cursor: pointer; padding: 4px; 
  }
  .section-action:active { opacity: 0.6; }

  /* --- Mentor Cards (Glass) --- */
  .mentors-grid { display: flex; flex-direction: column; gap: 10px; margin-bottom: 32px; }
  
  .mentor-card {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    border-radius: 20px;
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 18px; transition: 0.2s; cursor: pointer;
  }
  .mentor-card:active { transform: scale(0.98); background: rgba(255,255,255,0.05); }
  
  .m-info { display: flex; align-items: center; gap: 14px; }
  .m-av { 
    width: 44px; height: 44px; background: linear-gradient(135deg, #444, #222); 
    border-radius: 50%; display: flex; align-items: center; justify-content: center; 
    font-weight: 700; font-size: 18px; color: #fff; 
    border: 1px solid rgba(255,255,255,0.15); text-transform: uppercase; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
  }
  .m-details { display: flex; flex-direction: column; gap: 2px; }
  .m-name { font-weight: 700; font-size: 16px; color: #fff; letter-spacing: -0.3px; }
  .m-id { font-size: 12px; color: var(--text-muted); font-family: monospace; opacity: 0.8; }
  
  .m-del { 
    width: 36px; height: 36px; border-radius: 50%; 
    display: flex; align-items: center; justify-content: center; 
    color: var(--acc-red); background: rgba(255, 69, 58, 0.1); 
    transition: 0.2s; border: 1px solid transparent; 
  }
  .m-del:active { background: var(--acc-red); color: #fff; border-color: rgba(255,255,255,0.3); }

  .empty-state { 
    text-align: center; padding: 30px; color: var(--text-muted); font-size: 14px; 
    border: 1px dashed rgba(255,255,255,0.1); border-radius: var(--radius-l); 
    background: rgba(255,255,255,0.02); 
  }

  /* --- Rituals List (Glass Panel) --- */
  .rituals-list { 
    display: flex; flex-direction: column; 
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    border-radius: var(--radius-l); 
    overflow: hidden; margin-bottom: 32px; 
  }
  
  .ritual-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 18px 20px; background: transparent;
    position: relative; transition: background 0.2s;
  }
  .ritual-item:active { background: rgba(255,255,255,0.05); }
  .ritual-item::after { 
    content: ''; position: absolute; bottom: 0; left: 20px; right: 0; 
    height: 1px; background: rgba(255,255,255,0.1); 
  }
  .ritual-item:last-child::after { display: none; }

  .r-left { display: flex; flex-direction: column; gap: 4px; }
  .r-time { 
    font-size: 28px; font-weight: 300; letter-spacing: -0.5px; 
    line-height: 1; font-variant-numeric: tabular-nums; 
    text-shadow: 0 2px 10px rgba(0,0,0,0.2); 
  }
  .r-title { 
    font-size: 13px; font-weight: 600; color: var(--text-muted); 
    text-transform: uppercase; letter-spacing: 0.5px; 
    display: flex; align-items: center; gap: 6px; 
  }
  .r-days { font-size: 11px; color: var(--acc-blue); margin-top: 2px; font-weight: 500; }

  /* --- iOS Toggle Switch --- */
  .switch { position: relative; display: inline-block; width: 51px; height: 31px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { 
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; 
    background-color: rgba(255,255,255,0.15); transition: .4s; 
    border-radius: 34px; backdrop-filter: blur(4px); 
  }
  .slider:before { 
    position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; 
    background-color: white; transition: .4s; border-radius: 50%; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.3); 
  }
  input:checked + .slider { background-color: var(--acc-blue); }
  input:checked + .slider:before { transform: translateX(20px); }

  /* ============================================================
   * 6. MODALS & FORMS (Bottom Sheet)
   * ============================================================ */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100;
    backdrop-filter: blur(6px); opacity: 0; pointer-events: none; transition: 0.3s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: auto; }

  .bottom-sheet {
    position: fixed; left: 0; right: 0; bottom: 0;
    background: rgba(20, 20, 20, 0.85); /* Полупрозрачный черный */
    backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
    border-top: 1px solid rgba(255,255,255,0.2);
    box-shadow: 0 -10px 60px rgba(0,0,0,0.7);
    border-radius: 28px 28px 0 0;
    padding: 24px; padding-bottom: calc(24px + env(safe-area-inset-bottom));
    transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    z-index: 101; 
    
    /* === FIX: KEYBOARD RESIZE FIXES === */
    max-height: 85vh; /* Ограничиваем высоту, чтобы не занимать весь экран */
    overflow-y: auto; /* Разрешаем скролл внутри шторки, если клавиатура съела место */
    overscroll-behavior: contain; /* Чтобы скролл не передавался body */
    display: flex;
    flex-direction: column;
  }
  .modal-overlay.open .bottom-sheet { transform: translateY(0); }

  .bs-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-shrink: 0; }
  .bs-title { font-size: 18px; font-weight: 700; letter-spacing: -0.5px; }
  .bs-close { 
    font-size: 14px; font-weight: 600; color: var(--acc-blue); 
    background: none; border: none; padding: 8px; cursor: pointer; 
  }

  .input-group { margin-bottom: 20px; }
  .input-label { 
    display: block; font-size: 12px; color: var(--text-muted); 
    margin-bottom: 8px; text-transform: uppercase; font-weight: 700; 
    letter-spacing: 0.5px; padding-left: 4px; 
  }
  
  .ultima-input {
    width: 100%; background: rgba(0,0,0,0.2); 
    border: 1px solid rgba(255,255,255,0.1); border-radius: 16px;
    padding: 16px; color: #fff; font-size: 17px; transition: 0.2s;
  }
  .ultima-input:focus { border-color: var(--acc-blue); background: rgba(0,0,0,0.4); }
  
  .time-picker-row { display: flex; justify-content: center; margin-bottom: 24px; }
  .huge-time-input {
    background: transparent; border: none; color: #fff;
    font-size: 56px; font-weight: 200; text-align: center;
    width: 100%; font-family: -apple-system, sans-serif;
    text-shadow: 0 0 20px rgba(255,255,255,0.1);
  }
  
  /* Скрытие системной иконки часов */
  input[type="time"]::-webkit-calendar-picker-indicator { display: none; -webkit-appearance: none; }
  
  .day-selector { display: flex; justify-content: space-between; margin-bottom: 24px; }
  .day-btn {
    width: 40px; height: 40px; border-radius: 50%;
    background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
    color: var(--text-muted); font-size: 13px; font-weight: 600;
    display: flex; align-items: center; justify-content: center;
    transition: 0.2s;
  }
  .day-btn.active { 
    background: #ffffff; color: #000; border-color: #ffffff; 
    box-shadow: 0 0 16px rgba(255, 255, 255, 0.4); transform: scale(1.05); 
  }

  .action-btn {
    width: 100%; padding: 16px; border-radius: 16px;
    background: var(--acc-blue); color: #fff; font-size: 17px; font-weight: 700;
    border: none; cursor: pointer; transition: 0.2s; text-align: center;
    box-shadow: 0 4px 20px rgba(10, 132, 255, 0.4);
    flex-shrink: 0; /* Чтобы кнопки не сжимались при скролле */
  }
  .action-btn:active { transform: scale(0.98); opacity: 0.9; }
  .action-btn.delete { 
    background: rgba(255, 69, 58, 0.15); color: var(--acc-red); 
    margin-top: 12px; box-shadow: none; border: 1px solid rgba(255, 69, 58, 0.3); 
  }

</style>
</head>
<body>

<div class="fx-layer">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="noise"></div>
</div>

<div class="app-shell">
  
  <!-- Hero (Compact Row Layout) -->
  <div class="profile-hero">
    <div class="avatar-wrapper">
      <div class="avatar-ring">
        <img src="https://i.pravatar.cc/300?img=11" class="avatar-img" id="userAvatar">
      </div>
      <div class="avatar-glow"></div>
    </div>
    <div class="profile-meta">
      <h1 class="user-name" id="userName">Александр</h1>
      <div class="user-id-badge" onclick="copyId()">
        ID: <span id="userIdDisplay">1849</span>
        <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
      </div>
    </div>
  </div>

  <!-- Mentors Section -->
  <div class="section-head">
    <div class="section-title">Тренеры</div>
    <div class="section-action" onclick="openTrainerModal()">+ Добавить</div>
  </div>
  <div id="trainersList" class="mentors-grid">
    <!-- JS Injected -->
  </div>

  <!-- Rituals Section -->
  <div class="section-head">
    <div class="section-title">Ритуалы и Напоминания</div>
    <div class="section-action" onclick="openAlarmModal()">+ Создать</div>
  </div>
  <div id="alarmsList" class="rituals-list">
    <!-- JS Injected -->
  </div>

</div>

<!-- === MODAL: ADD/EDIT TRAINER === -->
<div id="modalTrainer" class="modal-overlay">
  <div class="bottom-sheet">
    <div class="bs-header">
      <div class="bs-title" id="trainerModalTitle">Новый наставник</div>
      <button class="bs-close" onclick="closeModal('modalTrainer')">Закрыть</button>
    </div>
    
    <input type="hidden" id="editTrainerUid">

    <div class="input-group">
      <label class="input-label">Имя тренера (Обязательно)</label>
      <input type="text" id="trainerInputName" class="ultima-input" placeholder="Например: Алина" autocomplete="off">
    </div>

    <div class="input-group">
      <label class="input-label">ID тренера (Только цифры)</label>
      <input type="tel" id="trainerInputId" class="ultima-input" 
             placeholder="Например: 123456789" 
             inputmode="numeric" 
             pattern="[0-9]*" 
             oninput="this.value = this.value.replace(/[^0-9]/g, '')"
             autocomplete="off">
    </div>
    
    <button class="action-btn" id="btnSaveTrainer" onclick="saveTrainer()">Подключить</button>
    <button class="action-btn delete" id="btnDeleteTrainer" onclick="deleteTrainerFromModal()" style="display:none">Удалить</button>
  </div>
</div>

<!-- === MODAL: ALARM EDITOR === -->
<div id="modalAlarm" class="modal-overlay">
  <div class="bottom-sheet">
    <div class="bs-header">
      <div class="bs-title">Настройка ритуала</div>
      <button class="bs-close" onclick="closeModal('modalAlarm')">Закрыть</button>
    </div>
    
    <input type="hidden" id="editAlarmId">

    <div class="time-picker-row">
      <input type="time" id="alarmTime" class="huge-time-input" value="09:00">
    </div>

    <div class="input-group">
      <label class="input-label">Название</label>
      <input type="text" id="alarmTitle" class="ultima-input" placeholder="Например: Взвешивание">
    </div>

    <div class="input-group">
      <label class="input-label">Повторять</label>
      <div class="day-selector" id="daySelector">
        <div class="day-btn" data-day="Пн">Пн</div>
        <div class="day-btn" data-day="Вт">Вт</div>
        <div class="day-btn" data-day="Ср">Ср</div>
        <div class="day-btn" data-day="Чт">Чт</div>
        <div class="day-btn" data-day="Пт">Пт</div>
        <div class="day-btn active" data-day="Сб">Сб</div>
        <div class="day-btn" data-day="Вс">Вс</div>
      </div>
    </div>

    <button class="action-btn" onclick="saveAlarmFromModal()">Сохранить</button>
    <button class="action-btn delete" id="btnDeleteAlarm" onclick="deleteAlarmFromModal()" style="display:none">Удалить</button>
  </div>
</div>

<script>
/* ============================================================
 * BLOCK 0: SYSTEM INIT (TMA & BOOT)
 * ============================================================ */
(function initTMA() {
  try {
    const tg = window.Telegram?.WebApp;
    if (!tg) return;

    tg.ready();
    tg.expand();

    try {
      tg.setHeaderColor('#050505');
      if (tg.setBackgroundColor) tg.setBackgroundColor('#050505');
    } catch (e) {}

    try {
      if (tg.BackButton) {
        tg.BackButton.show();
        tg.BackButton.offClick(); 
        tg.BackButton.onClick(function() {
          haptic('light');
          window.location.href = 'router.html';
        });
      }
    } catch (e) {}

    try {
      if (tg.disableVerticalSwipes) tg.disableVerticalSwipes();
    } catch (e) {}

  } catch (globalErr) {
    console.error('Critical TMA Error:', globalErr);
  }
})();

function isAdmin() {
  try {
    const userId = Number(window.Telegram?.WebApp?.initDataUnsafe?.user?.id);
    return userId === 196047220;
  } catch (_) { return false; }
}

/* ============================================================
 * BLOCK 1: STATE & CONFIG
 * ============================================================ */
const tg = window.Telegram?.WebApp;
const STORAGE_KEY = 'ultima_profile_v1';

const DEFAULT_STATE = {
  userId: '1849', // Fallback ID только из цифр
  trainers: [],
  alarms: [
    { id: 1, time: '09:00', title: 'Взвешивание', days: ['Сб'], active: true },
    { id: 2, time: '09:00', title: 'Завтрак', days: ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'], active: true },
    { id: 3, time: '12:00', title: 'Обед', days: ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'], active: true },
    { id: 4, time: '18:00', title: 'Ужин', days: ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'], active: true },
    { id: 5, time: '20:00', title: 'Тренировка', days: ['Пн','Ср','Пт'], active: false }
  ]
};

let appState = loadState();

document.addEventListener('DOMContentLoaded', () => {
  if(tg && tg.initDataUnsafe?.user) {
      const u = tg.initDataUnsafe.user;
      if (u.first_name) document.getElementById('userName').textContent = escapeHtml(u.first_name);
      
      // ИСПОЛЬЗУЕМ СТРОГО ID (ЦИФРЫ)
      const numericId = u.id || appState.userId;
      document.getElementById('userIdDisplay').textContent = numericId;
      
      if(u.photo_url) document.getElementById('userAvatar').src = u.photo_url;
  }
  
  renderTrainers();
  renderAlarms();
  initDaySelector();
});

/* ============================================================
 * BLOCK 2: RENDER LOGIC
 * ============================================================ */

function renderTrainers() {
  const list = document.getElementById('trainersList');
  list.innerHTML = '';

  if (appState.trainers.length === 0) {
    list.innerHTML = '<div class="empty-state">Нет подключенных тренеров</div>';
    return;
  }

  appState.trainers.forEach(t => {
    const safeName = escapeHtml(t.name);
    const safeId = escapeHtml(t.id);
    const initial = safeName ? safeName.charAt(0).toUpperCase() : '?';
    
    const div = document.createElement('div');
    div.className = 'mentor-card';
    div.onclick = () => openTrainerModal(t.uid); 
    
    div.innerHTML = `
      <div class="m-info">
        <div class="m-av">${initial}</div>
        <div class="m-details">
          <div class="m-name">${safeName}</div>
          ${safeId ? `<div class="m-id">${safeId}</div>` : ''}
        </div>
      </div>
      <div class="m-del" onclick="event.stopPropagation(); removeTrainer('${t.uid}')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        </svg>
      </div>
    `;
    list.appendChild(div);
  });
}

function renderAlarms() {
  const list = document.getElementById('alarmsList');
  list.innerHTML = '';
  
  const sorted = [...appState.alarms].sort((a,b) => a.time.localeCompare(b.time));

  sorted.forEach(alarm => {
    const safeTitle = escapeHtml(alarm.title);
    const safeTime = escapeHtml(alarm.time);

    const div = document.createElement('div');
    div.className = 'ritual-item';
    
    const dayStr = alarm.days.length === 7 ? 'Каждый день' : alarm.days.join(', ');
    
    div.innerHTML = `
      <div class="r-left" onclick="openAlarmModal(${alarm.id})">
        <div class="r-time" style="opacity: ${alarm.active ? 1 : 0.4}">${safeTime}</div>
        <div class="r-title">${safeTitle}</div>
        <div class="r-days">${dayStr}</div>
      </div>
      <div class="r-right">
        <label class="switch">
          <input type="checkbox" ${alarm.active ? 'checked' : ''} onchange="toggleAlarm(${alarm.id}, this.checked)">
          <span class="slider"></span>
        </label>
      </div>
    `;
    list.appendChild(div);
  });
}

/* ============================================================
 * BLOCK 3: ACTIONS & HANDLERS
 * ============================================================ */

/* --- Trainers --- */
function saveTrainer() {
  haptic('light');
  const inputName = document.getElementById('trainerInputName');
  const inputId = document.getElementById('trainerInputId');
  const editUid = document.getElementById('editTrainerUid').value;
  
  const nameVal = inputName.value.trim();
  const idVal = inputId.value.trim();

  if (!nameVal) {
    safeShowPopup('Ошибка', 'Пожалуйста, введите имя тренера');
    return;
  }

  if (idVal && !/^\d+$/.test(idVal)) {
    safeShowPopup('Ошибка', 'ID должен содержать только цифры');
    return;
  }

  if (editUid) {
    const idx = appState.trainers.findIndex(t => Number(t.uid) === Number(editUid));
    if (idx !== -1) {
        appState.trainers[idx] = { ...appState.trainers[idx], name: nameVal, id: idVal };
    }
  } else {
    if (appState.trainers.length >= 10) {
      safeShowPopup('Лимит', 'Максимум 10 тренеров');
      return;
    }
    appState.trainers.push({
      uid: Date.now(), 
      name: nameVal,   
      id: idVal        
    });
  }
  
  inputName.value = '';
  inputId.value = '';
  document.getElementById('editTrainerUid').value = '';
  saveState();
  renderTrainers();
  closeModal('modalTrainer');
  haptic('success');
}

function removeTrainer(uid, onSuccess) {
  haptic('light');
  safeShowConfirm("Удалить тренера?", (ok) => {
    if(ok) {
      appState.trainers = appState.trainers.filter(t => Number(t.uid) !== Number(uid));
      saveState();
      renderTrainers();
      haptic('success');
      if (onSuccess) onSuccess();
    }
  });
}

function deleteTrainerFromModal() {
    const uid = document.getElementById('editTrainerUid').value;
    if (uid) {
        removeTrainer(uid, () => closeModal('modalTrainer'));
    }
}

/* --- Alarms --- */
function toggleAlarm(id, status) {
  haptic('light');
  const idx = appState.alarms.findIndex(a => a.id === id);
  if(idx > -1) {
    appState.alarms[idx].active = status;
    saveState();
    renderAlarms(); 
  }
}

function saveAlarmFromModal() {
  haptic('light');
  const idStr = document.getElementById('editAlarmId').value;
  const time = document.getElementById('alarmTime').value;
  const rawTitle = document.getElementById('alarmTitle').value;
  
  const title = rawTitle.trim() || 'Ритуал';
  
  const days = [];
  document.querySelectorAll('.day-btn.active').forEach(b => days.push(b.dataset.day));
  if(days.length === 0) days.push('Пн'); 

  if (idStr) {
    const idx = appState.alarms.findIndex(a => a.id == idStr);
    if(idx > -1) {
      appState.alarms[idx] = { ...appState.alarms[idx], time, title, days };
    }
  } else {
    appState.alarms.push({ id: Date.now(), time, title, days, active: true });
  }

  saveState();
  renderAlarms();
  closeModal('modalAlarm');
  haptic('success');
}

function deleteAlarmFromModal() {
  haptic('light');
  const idStr = document.getElementById('editAlarmId').value;
  if(idStr) {
      appState.alarms = appState.alarms.filter(a => a.id != idStr);
      saveState();
      renderAlarms();
      closeModal('modalAlarm');
      haptic('success');
  }
}

/* --- Modals Control --- */
function openAlarmModal(id = null) {
  haptic('light');
  const isEdit = id !== null;
  const modal = document.getElementById('modalAlarm');
  const delBtn = document.getElementById('btnDeleteAlarm');
  
  document.getElementById('editAlarmId').value = isEdit ? id : '';
  
  if (isEdit) {
    const alarm = appState.alarms.find(a => a.id === id);
    document.getElementById('alarmTime').value = alarm.time;
    document.getElementById('alarmTitle').value = alarm.title;
    document.querySelectorAll('.day-btn').forEach(btn => {
      const d = btn.dataset.day;
      if(alarm.days.includes(d)) btn.classList.add('active');
      else btn.classList.remove('active');
    });
    delBtn.style.display = 'block';
  } else {
    document.getElementById('alarmTime').value = '08:00';
    document.getElementById('alarmTitle').value = '';
    document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
    delBtn.style.display = 'none';
  }

  modal.classList.add('open');
  document.body.classList.add('lock-scroll'); 
}

function openTrainerModal(uid = null) {
  haptic('light');
  const modal = document.getElementById('modalTrainer');
  const title = document.getElementById('trainerModalTitle');
  const btnSave = document.getElementById('btnSaveTrainer');
  const btnDel = document.getElementById('btnDeleteTrainer');
  const inpName = document.getElementById('trainerInputName');
  const inpId = document.getElementById('trainerInputId');
  const inpUid = document.getElementById('editTrainerUid');

  if (uid) {
    const t = appState.trainers.find(x => Number(x.uid) === Number(uid));
    if (!t) return; 

    title.textContent = 'Редактирование';
    btnSave.textContent = 'Сохранить';
    inpUid.value = t.uid;
    inpName.value = t.name;
    inpId.value = t.id || '';
    btnDel.style.display = 'block';
  } else {
    title.textContent = 'Новый наставник';
    btnSave.textContent = 'Подключить';
    inpUid.value = '';
    inpName.value = '';
    inpId.value = '';
    btnDel.style.display = 'none';
  }
  
  modal.classList.add('open');
  document.body.classList.add('lock-scroll'); 
}

function closeModal(id) {
  haptic('light');
  document.getElementById(id).classList.remove('open');
  document.body.classList.remove('lock-scroll'); 
}

function initDaySelector() {
  document.querySelectorAll('.day-btn').forEach(btn => {
    btn.onclick = () => {
      btn.classList.toggle('active');
      haptic('light');
    }
  });
}

/* ============================================================
 * BLOCK 4: HELPERS & UTILS
 * ============================================================ */

function escapeHtml(text) {
  if (!text) return text;
  return text.toString()
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function copyId() {
  haptic('light');
  const text = document.getElementById('userIdDisplay').innerText.replace('ID: ', '');
  navigator.clipboard.writeText(text).then(() => {
     safeShowPopup('Успешно', 'ID скопирован');
     haptic('success');
  }).catch(() => {
     safeShowPopup('Инфо', 'ID: ' + text);
  });
}

function haptic(style) {
  if (!tg || !tg.HapticFeedback) return;
  const impacts = ['light', 'medium', 'heavy', 'rigid', 'soft'];
  const notifications = ['error', 'success', 'warning'];
  try {
    if (impacts.includes(style)) {
      tg.HapticFeedback.impactOccurred(style);
    } else if (notifications.includes(style)) {
      tg.HapticFeedback.notificationOccurred(style);
    }
  } catch(e) {}
}

function safeShowPopup(title, message) {
  if (tg && tg.showPopup && tg.isVersionAtLeast && tg.isVersionAtLeast('6.2')) {
       tg.showPopup({ title: title, message: message });
  } else {
       alert(`${title}: ${message}`);
  }
}

function safeShowConfirm(message, callback) {
  if (tg && tg.showConfirm && tg.isVersionAtLeast && tg.isVersionAtLeast('6.2')) {
       tg.showConfirm(message, callback);
  } else {
       const res = confirm(message);
       if (callback) callback(res);
  }
}

function loadState() {
  try {
    const s = localStorage.getItem(STORAGE_KEY);
    return s ? JSON.parse(s) : DEFAULT_STATE;
  } catch(e) { return DEFAULT_STATE; }
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
}

async function syncWithCloud() {
  haptic('light'); 
  console.log("Sending to cloud:", appState);
  setTimeout(() => {
      haptic('success');
  }, 1000);
}

</script>
</body>
</html>
