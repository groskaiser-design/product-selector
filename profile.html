<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Ultima Profile</title>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Telegram WebApp SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  /* ============================================================
   * 0. SCROLLBAR HIDE (FORCE)
   * –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –ø–æ–ª–æ—Å –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
   * ============================================================ */
  
  /* Chrome, Safari, Edge, Opera, iOS */
  ::-webkit-scrollbar {
    width: 0 !important;
    height: 0 !important;
    display: none !important;
    background: transparent !important;
  }
  
  *::-webkit-scrollbar {
    width: 0 !important;
    height: 0 !important;
    display: none !important;
    background: transparent !important;
  }

  /* Firefox, IE, Edge (Legacy) */
  * {
    -ms-overflow-style: none !important;  /* IE –∏ —Å—Ç–∞—Ä—ã–π Edge */
    scrollbar-width: none !important;  /* Firefox */
  }

  /* ============================================================
   * 1. GLOBAL VARIABLES & RESET
   * ============================================================ */
  :root {
    /* --- Colors --- */
    --bg-core: #050505;
    --text-main: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.55);
    
    /* --- Accents --- */
    --acc-orange: #ff9f0a;
    --acc-green: #30d158;
    --acc-blue: #0a84ff;
    --acc-red: #ff453a;
    --acc-purple: #5e60ce;
    
    /* --- Metrics --- */
    --radius-xl: 28px;
    --radius-l: 24px;
    --radius-m: 16px;
    --pad: 16px;
  }

  * { 
    margin: 0; padding: 0; box-sizing: border-box; 
    -webkit-tap-highlight-color: transparent; outline: none; 
  }

  body {
    background-color: var(--bg-core);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', Roboto, sans-serif;
    color: var(--text-main);
    min-height: 100vh;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    padding-bottom: 120px; /* –û—Ç—Å—Ç—É–ø –ø–æ–¥ —à—Ç–æ—Ä–∫–∏/FAB */
  }

  /* === FIX: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–∫—Ä–æ–ª–ª–∞ —Ñ–æ–Ω–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–π —à—Ç–æ—Ä–∫–µ === */
  body.lock-scroll {
    overflow: hidden !important;
    height: 100vh;
    touch-action: none; /* –ó–∞–ø—Ä–µ—â–∞–µ—Ç –∂–µ—Å—Ç—ã –Ω–∞ —Ñ–æ–Ω–µ */
  }

  /* ============================================================
   * 2. BACKGROUND FX (Orbs & Noise)
   * ============================================================ */
  .fx-layer { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
  .orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.4; }
  .orb-1 { top: -10%; left: -20%; width: 300px; height: 300px; background: var(--acc-purple); animation: breathe 10s infinite ease-in-out; }
  .orb-2 { bottom: 10%; right: -10%; width: 250px; height: 250px; background: var(--acc-blue); animation: breathe 12s infinite ease-in-out reverse; }
  .noise { position: fixed; inset: 0; opacity: 0.05; background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); }
  @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.3; } 50% { transform: scale(1.1); opacity: 0.5; } }

  /* ============================================================
   * 3. LAYOUT
   * ============================================================ */
  .app-shell { 
    max-width: 480px; margin: 0 auto; 
    padding: var(--pad); 
    padding-top: calc(20px + env(safe-area-inset-top)); /* –ß—É—Ç—å –±–æ–ª—å—à–µ –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É, —Ç–∞–∫ –∫–∞–∫ –Ω–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
  }

  /* ============================================================
   * 4. PROFILE HERO (Compact Row Layout)
   * ============================================================ */
  .profile-hero { 
    display: flex; 
    flex-direction: row; /* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ */
    align-items: center; 
    justify-content: flex-start;
    gap: 20px; 
    margin-bottom: 32px; 
    position: relative; 
    padding: 0 4px;
  }
  
  .avatar-wrapper { position: relative; flex-shrink: 0; }
  
  .avatar-ring {
    width: 88px; height: 88px; /* –ß—É—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ (–±—ã–ª–æ 110) */
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
    border: 1px solid rgba(255,255,255,0.2);
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  }
  .avatar-img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; background: #222; }
  
  .avatar-glow { 
    position: absolute; inset: 0; border-radius: 50%; 
    background: radial-gradient(circle, var(--acc-blue) 0%, transparent 70%); 
    opacity: 0.3; z-index: -1; filter: blur(20px); animation: pulse-glow 4s infinite; 
  }
  @keyframes pulse-glow { 0%, 100% { opacity: 0.2; transform: scale(0.9); } 50% { opacity: 0.5; transform: scale(1.1); } }

  .profile-meta {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
    min-width: 0; /* –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ */
  }

  .user-name { 
    font-size: 26px; 
    font-weight: 800; 
    letter-spacing: -0.5px; 
    line-height: 1.1; 
    margin: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 100%;
  }
  
  .user-id-badge {
    display: inline-flex; align-items: center; gap: 6px;
    background: rgba(255,255,255,0.06); 
    border: 1px solid rgba(255,255,255,0.1);
    padding: 6px 12px; border-radius: 20px;
    font-size: 13px; font-family: 'SF Mono', 'Roboto Mono', monospace; 
    color: var(--text-muted);
    cursor: pointer; transition: 0.2s;
  }
  .user-id-badge:active { background: rgba(255,255,255,0.15); transform: scale(0.98); }
  .copy-icon { opacity: 0.6; width: 14px; height: 14px; }

  /* ============================================================
   * 5. SECTIONS & CARDS
   * ============================================================ */
  .section-head { 
    display: flex; align-items: center; justify-content: space-between; 
    margin-bottom: 14px; padding: 0 4px; 
  }
  .section-title { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; }
  .section-action { 
    font-size: 14px; color: var(--acc-blue); font-weight: 500; 
    cursor: pointer; padding: 4px; 
  }
  .section-action:active { opacity: 0.6; }

  /* --- Mentor Cards (Glass) --- */
  .mentors-grid { display: flex; flex-direction: column; gap: 10px; margin-bottom: 32px; }
  
  .mentor-card {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    border-radius: 20px;
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 18px; transition: 0.2s; cursor: pointer;
  }
  .mentor-card:active { transform: scale(0.98); background: rgba(255,255,255,0.05); }
  
  .m-info { display: flex; align-items: center; gap: 14px; }
  .m-av { 
    width: 44px; height: 44px; background: linear-gradient(135deg, #444, #222); 
    border-radius: 50%; display: flex; align-items: center; justify-content: center; 
    font-weight: 700; font-size: 18px; color: #fff; 
    border: 1px solid rgba(255,255,255,0.15); text-transform: uppercase; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
  }
  .m-details { display: flex; flex-direction: column; gap: 2px; }
  .m-name { font-weight: 700; font-size: 16px; color: #fff; letter-spacing: -0.3px; }
  .m-id { font-size: 12px; color: var(--text-muted); font-family: monospace; opacity: 0.8; }
  
  .m-del { 
    width: 36px; height: 36px; border-radius: 50%; 
    display: flex; align-items: center; justify-content: center; 
    color: var(--acc-red); background: rgba(255, 69, 58, 0.1); 
    transition: 0.2s; border: 1px solid transparent; 
  }
  .m-del:active { background: var(--acc-red); color: #fff; border-color: rgba(255,255,255,0.3); }

  .empty-state { 
    text-align: center; padding: 30px; color: var(--text-muted); font-size: 14px; 
    border: 1px dashed rgba(255,255,255,0.1); border-radius: var(--radius-l); 
    background: rgba(255,255,255,0.02); 
  }

  /* --- Rituals List (Glass Panel) --- */
  .rituals-list { 
    display: flex; flex-direction: column; 
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    border-radius: var(--radius-l); 
    overflow: hidden; margin-bottom: 32px; 
  }
  
  .ritual-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 18px 20px; background: transparent;
    position: relative; transition: background 0.2s;
  }
  .ritual-item:active { background: rgba(255,255,255,0.05); }
  .ritual-item::after { 
    content: ''; position: absolute; bottom: 0; left: 20px; right: 0; 
    height: 1px; background: rgba(255,255,255,0.1); 
  }
  .ritual-item:last-child::after { display: none; }

  .r-left { display: flex; flex-direction: column; gap: 4px; }
  .r-time { 
    font-size: 28px; font-weight: 300; letter-spacing: -0.5px; 
    line-height: 1; font-variant-numeric: tabular-nums; 
    text-shadow: 0 2px 10px rgba(0,0,0,0.2); 
  }
  .r-title { 
    font-size: 13px; font-weight: 600; color: var(--text-muted); 
    text-transform: uppercase; letter-spacing: 0.5px; 
    display: flex; align-items: center; gap: 6px; 
  }
  .r-days { font-size: 11px; color: var(--acc-blue); margin-top: 2px; font-weight: 500; }

  /* --- iOS Toggle Switch --- */
  .switch { position: relative; display: inline-block; width: 51px; height: 31px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { 
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; 
    background-color: rgba(255,255,255,0.15); transition: .4s; 
    border-radius: 34px; backdrop-filter: blur(4px); 
  }
  .slider:before { 
    position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; 
    background-color: white; transition: .4s; border-radius: 50%; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.3); 
  }
  input:checked + .slider { background-color: var(--acc-blue); }
  input:checked + .slider:before { transform: translateX(20px); }

  /* ============================================================
   * 6. MODALS & FORMS (Bottom Sheet)
   * ============================================================ */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100;
    backdrop-filter: blur(6px); opacity: 0; pointer-events: none; transition: 0.3s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: auto; }

.bottom-sheet {
    position: fixed;
    /* 1. –ñ–ï–°–¢–ö–ê–Ø –ü–†–ò–í–Ø–ó–ö–ê –ö –ö–†–ê–Ø–ú */
    left: 16px !important;
    right: 16px !important;
    bottom: 24px !important; /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É */
    width: auto !important;  /* –®–∏—Ä–∏–Ω–∞ —Å–∞–º–∞ –ø–æ–¥—Å—Ç—Ä–æ–∏—Ç—Å—è –ø–æ–¥ left –∏ right */
    
    /* 2. –û–ì–†–ê–ù–ò–ß–ò–¢–ï–õ–¨ (—á—Ç–æ–±—ã –Ω–∞ –ü–ö –Ω–µ –±—ã–ª–æ –≥–∏–≥–∞–Ω—Ç—Å–∫–∏–º) */
    max-width: 448px; 
    margin: 0 auto; /* –¶–µ–Ω—Ç—Ä –Ω–∞ –ü–ö */

    /* 3. –í–ò–ó–£–ê–õ */
    background: rgba(20, 20, 20, 0.9);
    backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
    border-top: 1px solid rgba(255,255,255,0.2);
    border-radius: 24px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    
    padding: 24px; 
    
    /* 4. –ê–ù–ò–ú–ê–¶–ò–Ø (—Å–∫—Ä—ã–≤–∞–µ–º –≤–Ω–∏–∑) */
    transform: translateY(150%); 
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    z-index: 101; 
    
    /* –°–∫—Ä–æ–ª–ª –≤–Ω—É—Ç—Ä–∏ */
    max-height: 80vh;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }

  /* 5. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –í–æ–∑–≤—Ä–∞—â–∞–µ–º —à—Ç–æ—Ä–∫—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ */
  .modal-overlay.open .bottom-sheet { 
    transform: translateY(0) !important; 
  }
    
    /* === FIX: KEYBOARD RESIZE FIXES === */
    max-height: 85vh; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É, —á—Ç–æ–±—ã –Ω–µ –∑–∞–Ω–∏–º–∞—Ç—å –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
    overflow-y: auto; /* –†–∞–∑—Ä–µ—à–∞–µ–º —Å–∫—Ä–æ–ª–ª –≤–Ω—É—Ç—Ä–∏ —à—Ç–æ—Ä–∫–∏, –µ—Å–ª–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å—ä–µ–ª–∞ –º–µ—Å—Ç–æ */
    overscroll-behavior: contain; /* –ß—Ç–æ–±—ã —Å–∫—Ä–æ–ª–ª –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è body */
    display: flex;
    flex-direction: column;
  }
  .modal-overlay.open .bottom-sheet { transform: translateY(0); }

  .bs-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-shrink: 0; }
  .bs-title { font-size: 18px; font-weight: 700; letter-spacing: -0.5px; }
  .bs-close { 
    font-size: 14px; font-weight: 600; color: var(--acc-blue); 
    background: none; border: none; padding: 8px; cursor: pointer; 
  }

  .input-group { margin-bottom: 20px; }
  .input-label { 
    display: block; font-size: 12px; color: var(--text-muted); 
    margin-bottom: 8px; text-transform: uppercase; font-weight: 700; 
    letter-spacing: 0.5px; padding-left: 4px; 
  }
  
  .ultima-input {
    width: 100%; background: rgba(0,0,0,0.2); 
    border: 1px solid rgba(255,255,255,0.1); border-radius: 16px;
    padding: 16px; color: #fff; font-size: 17px; transition: 0.2s;
  }
  .ultima-input:focus { border-color: var(--acc-blue); background: rgba(0,0,0,0.4); }
  
  .time-picker-row { display: flex; justify-content: center; margin-bottom: 24px; }
  .huge-time-input {
    background: transparent; border: none; color: #fff;
    font-size: 56px; font-weight: 200; text-align: center;
    width: 100%; font-family: -apple-system, sans-serif;
    text-shadow: 0 0 20px rgba(255,255,255,0.1);
  }
  
  /* –°–∫—Ä—ã—Ç–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–∫–æ–Ω–∫–∏ —á–∞—Å–æ–≤ */
  input[type="time"]::-webkit-calendar-picker-indicator { display: none; -webkit-appearance: none; }
  
  .day-selector { display: flex; justify-content: space-between; margin-bottom: 24px; }
  .day-btn {
    width: 40px; height: 40px; border-radius: 50%;
    background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
    color: var(--text-muted); font-size: 13px; font-weight: 600;
    display: flex; align-items: center; justify-content: center;
    transition: 0.2s;
  }
  .day-btn.active { 
    background: #ffffff; color: #000; border-color: #ffffff; 
    box-shadow: 0 0 16px rgba(255, 255, 255, 0.4); transform: scale(1.05); 
  }

  .action-btn {
    width: 100%; padding: 16px; border-radius: 16px;
    background: var(--acc-blue); color: #fff; font-size: 17px; font-weight: 700;
    border: none; cursor: pointer; transition: 0.2s; text-align: center;
    box-shadow: 0 4px 20px rgba(10, 132, 255, 0.4);
    flex-shrink: 0; /* –ß—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ –Ω–µ —Å–∂–∏–º–∞–ª–∏—Å—å –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ */
  }
  .action-btn:active { transform: scale(0.98); opacity: 0.9; }
  .action-btn.delete { 
    background: rgba(255, 69, 58, 0.15); color: var(--acc-red); 
    margin-top: 12px; box-shadow: none; border: 1px solid rgba(255, 69, 58, 0.3); 
  }

  .m-status {
  font-size: 10px; 
  color: var(--acc-green); /* –ó–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç */
  text-transform: uppercase; 
  font-weight: 700; 
  letter-spacing: 0.5px; 
  margin-bottom: 2px;
  opacity: 0.9;
}
  
</style>
</head>
<body>

<div class="fx-layer">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="noise"></div>
</div>

<div class="app-shell">
  
  <!-- Hero (Compact Row Layout) -->
  <div class="profile-hero">
    <div class="avatar-wrapper">
      <div class="avatar-ring">
        <img src="https://i.pravatar.cc/300?img=11" class="avatar-img" id="userAvatar">
      </div>
      <div class="avatar-glow"></div>
    </div>
    <div class="profile-meta">
      <h1 class="user-name" id="userName">–ê–ª–µ–∫—Å–∞–Ω–¥—Ä</h1>
      <div class="user-id-badge" onclick="copyId()">
        ID: <span id="userIdDisplay">1849</span>
        <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
      </div>
    </div>
  </div>

  <!-- Mentors Section -->
  <div class="section-head">
    <div class="section-title">–¢—Ä–µ–Ω–µ—Ä—ã</div>
    <div class="section-action" onclick="openTrainerModal()">+ –î–æ–±–∞–≤–∏—Ç—å</div>
  </div>
  <div id="trainersList" class="mentors-grid">
    <!-- JS Injected -->
  </div>

  <!-- Rituals Section -->
  <div class="section-head">
    <div class="section-title">–†–∏—Ç—É–∞–ª—ã –∏ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</div>
    <div class="section-action" onclick="openAlarmModal()">+ –°–æ–∑–¥–∞—Ç—å</div>
  </div>
  <div id="alarmsList" class="rituals-list">
    <!-- JS Injected -->
  </div>

</div>

<!-- === MODAL: ADD/EDIT TRAINER === -->
<div id="modalTrainer" class="modal-overlay">
  <div class="bottom-sheet">
    <div class="bs-header">
      <div class="bs-title" id="trainerModalTitle">–ù–æ–≤—ã–π –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫</div>
      <button class="bs-close" onclick="closeModal('modalTrainer')">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    
    <input type="hidden" id="editTrainerUid">

    <div class="input-group">
      <label class="input-label">–ò–º—è —Ç—Ä–µ–Ω–µ—Ä–∞ (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <input type="text" id="trainerInputName" class="ultima-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–ª–∏–Ω–∞" autocomplete="off">
    </div>

    <div class="input-group">
      <label class="input-label">ID —Ç—Ä–µ–Ω–µ—Ä–∞ (–¢–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)</label>
      <input type="tel" id="trainerInputId" class="ultima-input" 
             placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 123456789" 
             inputmode="numeric" 
             pattern="[0-9]*" 
             oninput="this.value = this.value.replace(/[^0-9]/g, '')"
             autocomplete="off">
    </div>
    
    <button class="action-btn" id="btnSaveTrainer" onclick="saveTrainer()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
    <button class="action-btn delete" id="btnDeleteTrainer" onclick="deleteTrainerFromModal()" style="display:none">–£–¥–∞–ª–∏—Ç—å</button>
  </div>
</div>

<!-- === MODAL: ALARM EDITOR === -->
<div id="modalAlarm" class="modal-overlay">
  <div class="bottom-sheet">
    <div class="bs-header">
      <div class="bs-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∏—Ç—É–∞–ª–∞</div>
      <button class="bs-close" onclick="closeModal('modalAlarm')">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    
    <input type="hidden" id="editAlarmId">

    <div class="time-picker-row">
      <input type="time" id="alarmTime" class="huge-time-input" value="09:00">
    </div>

    <div class="input-group">
      <label class="input-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input type="text" id="alarmTitle" class="ultima-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–∑–≤–µ—à–∏–≤–∞–Ω–∏–µ">
    </div>

    <div class="input-group">
      <label class="input-label">–ü–æ–≤—Ç–æ—Ä—è—Ç—å</label>
      <div class="day-selector" id="daySelector">
        <div class="day-btn" data-day="–ü–Ω">–ü–Ω</div>
        <div class="day-btn" data-day="–í—Ç">–í—Ç</div>
        <div class="day-btn" data-day="–°—Ä">–°—Ä</div>
        <div class="day-btn" data-day="–ß—Ç">–ß—Ç</div>
        <div class="day-btn" data-day="–ü—Ç">–ü—Ç</div>
        <div class="day-btn active" data-day="–°–±">–°–±</div>
        <div class="day-btn" data-day="–í—Å">–í—Å</div>
      </div>
    </div>

    <button class="action-btn" onclick="saveAlarmFromModal()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="action-btn delete" id="btnDeleteAlarm" onclick="deleteAlarmFromModal()" style="display:none">–£–¥–∞–ª–∏—Ç—å</button>
  </div>
</div>

<script>
/* ============================================================
 * BLOCK 0: TMA boot (FIXED & SAFE)
 * ============================================================ */
(function initTMA() {
  try {
    const tg = window.Telegram?.WebApp;
    if (!tg) return; // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –¢–µ–ª–µ–≥—Ä–∞–º, –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º, –Ω–µ –ª–æ–º–∞—è —Å–∞–π—Ç

    tg.ready();
    tg.expand();

    // 1. –ö—Ä–∞—Å–∏–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–æ–±–µ—Ä–Ω—É—Ç–æ –≤ –∑–∞—â–∏—Ç—É, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫—É)
    try {
      tg.setHeaderColor('#050505'); // –ß–µ—Ä–Ω—ã–π —Ü–≤–µ—Ç
      if (tg.setBackgroundColor) {
        tg.setBackgroundColor('#050505');
      }
    } catch (e) {
      console.log('Error setting color:', e);
    }

    // 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
    try {
      if (tg.BackButton) {
        tg.BackButton.show();
        // –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –Ω–µ —Ç—É–ø–∏–ª–∞
        tg.BackButton.offClick(); 
        // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ—Ö–æ–¥
        tg.BackButton.onClick(function() {
          window.location.href = 'router.html';
        });
      }
    } catch (e) {
      console.log('Error setting back button:', e);
    }

    // 3. –û—Ç–∫–ª—é—á–∞–µ–º —Å–≤–∞–π–ø—ã (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
    try {
      if (tg.disableVerticalSwipes) tg.disableVerticalSwipes();
    } catch (e) {}

  } catch (globalErr) {
    // –ï—Å–ª–∏ –≤–æ–æ–±—â–µ –≤—Å–µ —É–ø–∞–ª–æ –≤ TMA, –≤—ã–≤–æ–¥–∏–º –æ—à–∏–±–∫—É, –Ω–æ –ù–ï –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫—Ä–∏–ø—Ç
    console.error('Critical TMA Error:', globalErr);
  }
})();
  
/**
 * –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
 * @returns {boolean} true, –µ—Å–ª–∏ Telegram user.id —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
 */
function isAdmin() {
  try {
    const userId = Number(window.Telegram?.WebApp?.initDataUnsafe?.user?.id);
    return userId === 196047220;
  } catch (_) {
    return false;
  }
}

/* ============================================================
 * BLOCK 1: STATE & CONFIG
 * ============================================================ */
// ‚ö†Ô∏è –í–ê–® URL
const GAS_URL = 'https://script.google.com/macros/s/AKfycbzQbW4Bqmwq_51k9Op_CLJa5IX9v_MYkgXde2y3fAqqHX5wsvbSN7Uw9OpXFPP6raU/exec'; 

const tg = window.Telegram?.WebApp;
const STORAGE_KEY = 'ultima_profile_v1';
const PHOTO_CACHE_KEY = 'ultima_photos_v1'; // –ö–ª—é—á –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ç–æ
const PHOTO_TTL = 24 * 60 * 60 * 1000; // –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫—ç—à–∞ —Ñ–æ—Ç–æ (24 —á–∞—Å–∞)

const DEFAULT_STATE = {
  userId: '1849', 
  rowIndex: null, 
  timezoneOffset: null, 
  trainers: [],
  alarms: [
    { id: 1, time: '09:00', title: '–í–∑–≤–µ—à–∏–≤–∞–Ω–∏–µ', days: ['–°–±'], active: true },
    { id: 2, time: '09:00', title: '–ó–∞–≤—Ç—Ä–∞–∫', days: ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'], active: true },
    { id: 3, time: '12:00', title: '–û–±–µ–¥', days: ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'], active: true },
    { id: 4, time: '18:00', title: '–£–∂–∏–Ω', days: ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'], active: true },
    { id: 5, time: '20:00', title: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞', days: ['–ü–Ω','–°—Ä','–ü—Ç'], active: false }
  ]
};

let appState = loadState();

document.addEventListener('DOMContentLoaded', () => {
  // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  if(tg && tg.initDataUnsafe?.user) {
      const u = tg.initDataUnsafe.user;
      if (u.first_name) document.getElementById('userName').textContent = escapeHtml(u.first_name);
      
      appState.userId = String(u.id); 
      document.getElementById('userIdDisplay').textContent = appState.userId;
      
      if(u.photo_url) document.getElementById('userAvatar').src = u.photo_url;
  }
  
  // –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å
  appState.timezoneOffset = new Date().getTimezoneOffset();

  // 2. –†–µ–Ω–¥–µ—Ä
  renderTrainers();
  renderAlarms();
  initDaySelector();
  
  // 3. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
  syncLoad(); 
});

/* ============================================================
 * BLOCK 2: SYNC LOGIC (Cloud + Local)
 * ============================================================ */

async function syncLoad() {
  if (!GAS_URL.includes('/exec')) { console.warn('GAS_URL not set'); return; }
  console.log('üîÑ Sync: Checking cloud...');
  
  try {
    const response = await fetch(GAS_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'sync_profile',
        type: 'load',
        userId: appState.userId,
        rowIndex: appState.rowIndex,
        timezoneOffset: appState.timezoneOffset
      })
    });
    
    const data = await response.json();
    
    if (data.ok) {
      if (data.rowIndex) appState.rowIndex = data.rowIndex;

      const serverIsEmpty = (!data.trainers || data.trainers.length === 0) &&
                            (!data.alarms || data.alarms.length === 0);
      const localHasData = (appState.trainers.length > 0 || appState.alarms.length > 0);

      if (serverIsEmpty && localHasData) {
        console.log('‚ú® First Run: Sending defaults...');
        syncSave(); 
        return; 
      }

      const localStr = JSON.stringify({t: appState.trainers, a: appState.alarms});
      const serverStr = JSON.stringify({t: data.trainers, a: data.alarms});

      if (localStr !== serverStr) {
        console.log('‚òÅÔ∏è Updating UI from cloud...');
        appState.trainers = data.trainers || [];
        appState.alarms = data.alarms || [];
        
        saveState();    
        renderTrainers(); 
        renderAlarms();   
        haptic('success');
      } else {
        saveState(); 
      }
    }
  } catch (e) { console.error('Sync Load Error:', e); }
}

async function syncSave() {
  saveState(); 
  if (!GAS_URL.includes('/exec')) return;
  console.log('üíæ Saving to cloud...');

  try {
    fetch(GAS_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'sync_profile',
        type: 'save',
        userId: appState.userId,
        rowIndex: appState.rowIndex,
        trainers: appState.trainers,
        alarms: appState.alarms,
        timezoneOffset: appState.timezoneOffset
      })
    }).then(r => r.json()).then(data => {
      if (data.ok && data.rowIndex) {
        appState.rowIndex = data.rowIndex;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
      }
    });
  } catch (e) { console.warn('Save failed', e); }
}

// üî• –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –§–û–¢–û –° –ö–≠–®–ï–ú
async function fetchTrainerPhoto(trainerId, imgElementId) {
  if (!trainerId) return;

  // 1. –ü—Ä–æ–±—É–µ–º –¥–æ—Å—Ç–∞—Ç—å –∏–∑ –∫—ç—à–∞
  const cacheKey = `photo_${trainerId}`;
  let cached = null;
  try {
    const raw = localStorage.getItem(PHOTO_CACHE_KEY);
    const allPhotos = raw ? JSON.parse(raw) : {};
    cached = allPhotos[cacheKey];
  } catch (e) {}

  const img = document.getElementById(imgElementId);
  const now = Date.now();
  let needsUpdate = true;

  // 2. –ï—Å–ª–∏ –µ—Å—Ç—å –≤ –∫—ç—à–µ ‚Äî —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
  if (cached && cached.data) {
    if (img) {
       img.style.backgroundImage = `url('${cached.data}')`;
       img.innerHTML = '';
    }
    // –ï—Å–ª–∏ –∫—ç—à —Å–≤–µ–∂–∏–π (–º–µ–Ω—å—à–µ 24—á) ‚Äî –æ–±–Ω–æ–≤–ª—è—Ç—å –Ω–µ –Ω—É–∂–Ω–æ
    if (cached.time && (now - cached.time < PHOTO_TTL)) {
      needsUpdate = false;
    }
  }

  // 3. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–Ω–µ—Ç –≤ –∫—ç—à–µ –∏–ª–∏ –æ–Ω –ø—Ä–æ—Ç—É—Ö) ‚Äî –∏–¥–µ–º –≤ —Å–µ—Ç—å
  if (needsUpdate && GAS_URL.includes('/exec')) {
    try {
      const res = await fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'get_trainer_photo', trainer_id: trainerId })
      });
      const data = await res.json();
      
      if (data.ok && data.photo) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ (–¥–∞–∂–µ –µ—Å–ª–∏ —É–∂–µ –ø–æ–∫–∞–∑–∞–ª–∏ —Å—Ç–∞—Ä—É—é)
        if (img) {
            img.style.backgroundImage = `url('${data.photo}')`;
            img.innerHTML = '';
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
        try {
          const raw = localStorage.getItem(PHOTO_CACHE_KEY);
          const allPhotos = raw ? JSON.parse(raw) : {};
          allPhotos[cacheKey] = { data: data.photo, time: now };
          localStorage.setItem(PHOTO_CACHE_KEY, JSON.stringify(allPhotos));
        } catch(e) { console.warn('Cache full?', e); }
      }
    } catch(e) { console.error('Photo fetch error', e); }
  }
}

/* ============================================================
 * BLOCK 3: RENDER LOGIC
 * ============================================================ */

function renderTrainers() {
  const list = document.getElementById('trainersList');
  list.innerHTML = '';

  if (appState.trainers.length === 0) {
    list.innerHTML = '<div class="empty-state">–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–µ—Ä–æ–≤</div>';
    return;
  }

  appState.trainers.forEach((t, index) => {
    const safeName = escapeHtml(t.name);
    const safeId = escapeHtml(t.id);
    const initial = safeName ? safeName.charAt(0).toUpperCase() : '?';
    const uniqueImgId = `trainer_img_${index}`; 
    
    const div = document.createElement('div');
    div.className = 'mentor-card';
    div.onclick = () => openTrainerModal(t.uid); 
    
div.innerHTML = `
      <div class="m-info">
        <div class="m-av" id="${uniqueImgId}" style="background-size: cover; background-position: center;">${initial}</div>
        <div class="m-details">
          <div class="m-status">–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</div>
          
          <div class="m-name" onclick="openTrainerModal('${t.uid}')">${safeName}</div>
          ${safeId ? `<div class="m-id">${safeId}</div>` : ''}
        </div>
      </div>
      <div class="m-del" onclick="event.stopPropagation(); removeTrainer('${t.uid}')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        </svg>
      </div>
    `;
    list.appendChild(div);

    if (t.id) fetchTrainerPhoto(t.id, uniqueImgId);
  });
}

function renderAlarms() {
  const list = document.getElementById('alarmsList');
  list.innerHTML = '';
  
  const sorted = [...appState.alarms].sort((a,b) => a.time.localeCompare(b.time));

  sorted.forEach(alarm => {
    const safeTitle = escapeHtml(alarm.title);
    const safeTime = escapeHtml(alarm.time);
    const dayStr = alarm.days.length === 7 ? '–ö–∞–∂–¥—ã–π –¥–µ–Ω—å' : alarm.days.join(', ');
    
    const div = document.createElement('div');
    div.className = 'ritual-item';
    div.innerHTML = `
      <div class="r-left" onclick="openAlarmModal(${alarm.id})">
        <div class="r-time" style="opacity: ${alarm.active ? 1 : 0.4}">${safeTime}</div>
        <div class="r-title">${safeTitle}</div>
        <div class="r-days">${dayStr}</div>
      </div>
      <div class="r-right">
        <label class="switch">
          <input type="checkbox" ${alarm.active ? 'checked' : ''} onchange="toggleAlarm(${alarm.id}, this.checked)">
          <span class="slider"></span>
        </label>
      </div>
    `;
    list.appendChild(div);
  });
}

/* ============================================================
 * BLOCK 4: ACTIONS & HANDLERS
 * ============================================================ */

/* --- Trainers --- */
function saveTrainer() {
  haptic('light');
  const inputName = document.getElementById('trainerInputName');
  const inputId = document.getElementById('trainerInputId');
  const editUid = document.getElementById('editTrainerUid').value;
  
  const nameVal = inputName.value.trim();
  const idVal = inputId.value.trim();

  if (!nameVal) { safeShowPopup('–û—à–∏–±–∫–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è —Ç—Ä–µ–Ω–µ—Ä–∞'); return; }
  if (idVal && !/^\d+$/.test(idVal)) { safeShowPopup('–û—à–∏–±–∫–∞', 'ID –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã'); return; }

  if (editUid) {
    const idx = appState.trainers.findIndex(t => Number(t.uid) === Number(editUid));
    if (idx !== -1) appState.trainers[idx] = { ...appState.trainers[idx], name: nameVal, id: idVal };
  } else {
    if (appState.trainers.length >= 10) { safeShowPopup('–õ–∏–º–∏—Ç', '–ú–∞–∫—Å–∏–º—É–º 10 —Ç—Ä–µ–Ω–µ—Ä–æ–≤'); return; }
    appState.trainers.push({ uid: Date.now(), name: nameVal, id: idVal });
  }
  
  inputName.value = ''; inputId.value = ''; document.getElementById('editTrainerUid').value = '';
  syncSave(); renderTrainers(); closeModal('modalTrainer'); haptic('success');
}

function removeTrainer(uid, onSuccess) {
  haptic('light');
  safeShowConfirm("–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–µ—Ä–∞?", (ok) => {
    if(ok) {
      // –ß–∏—Å—Ç–∏–º –∫—ç—à —Ñ–æ—Ç–æ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ –ø–æ–ª–µ–∑–Ω–æ)
      const trainer = appState.trainers.find(t => Number(t.uid) === Number(uid));
      if (trainer && trainer.id) {
         try {
           const raw = localStorage.getItem(PHOTO_CACHE_KEY);
           if (raw) {
             const all = JSON.parse(raw);
             delete all[`photo_${trainer.id}`];
             localStorage.setItem(PHOTO_CACHE_KEY, JSON.stringify(all));
           }
         } catch(e) {}
      }

      appState.trainers = appState.trainers.filter(t => Number(t.uid) !== Number(uid));
      syncSave(); renderTrainers(); haptic('success');
      if (onSuccess) onSuccess();
    }
  });
}

function deleteTrainerFromModal() {
    const uid = document.getElementById('editTrainerUid').value;
    if (uid) removeTrainer(uid, () => closeModal('modalTrainer'));
}

/* --- Alarms --- */
function toggleAlarm(id, status) {
  haptic('light');
  const idx = appState.alarms.findIndex(a => a.id === id);
  if(idx > -1) { appState.alarms[idx].active = status; syncSave(); renderAlarms(); }
}

function saveAlarmFromModal() {
  haptic('light');
  const idStr = document.getElementById('editAlarmId').value;
  const time = document.getElementById('alarmTime').value;
  const rawTitle = document.getElementById('alarmTitle').value;
  const title = rawTitle.trim() || '–†–∏—Ç—É–∞–ª';
  
  const days = [];
  document.querySelectorAll('.day-btn.active').forEach(b => days.push(b.dataset.day));
  if(days.length === 0) days.push('–ü–Ω'); 

  if (idStr) {
    const idx = appState.alarms.findIndex(a => a.id == idStr);
    if(idx > -1) appState.alarms[idx] = { ...appState.alarms[idx], time, title, days };
  } else {
    appState.alarms.push({ id: Date.now(), time, title, days, active: true });
  }

  syncSave(); renderAlarms(); closeModal('modalAlarm'); haptic('success');
}

function deleteAlarmFromModal() {
  haptic('light');
  const idStr = document.getElementById('editAlarmId').value;
  if(idStr) {
      appState.alarms = appState.alarms.filter(a => a.id != idStr);
      syncSave(); renderAlarms(); closeModal('modalAlarm'); haptic('success');
  }
}

/* ============================================================
 * BLOCK 5: UI HELPERS
 * ============================================================ */

function openAlarmModal(id = null) {
  haptic('light');
  const isEdit = id !== null;
  const modal = document.getElementById('modalAlarm');
  const delBtn = document.getElementById('btnDeleteAlarm');
  
  document.getElementById('editAlarmId').value = isEdit ? id : '';
  
  if (isEdit) {
    const alarm = appState.alarms.find(a => a.id === id);
    document.getElementById('alarmTime').value = alarm.time;
    document.getElementById('alarmTitle').value = alarm.title;
    document.querySelectorAll('.day-btn').forEach(btn => {
      const d = btn.dataset.day;
      if(alarm.days.includes(d)) btn.classList.add('active');
      else btn.classList.remove('active');
    });
    delBtn.style.display = 'block';
  } else {
    document.getElementById('alarmTime').value = '08:00';
    document.getElementById('alarmTitle').value = '';
    document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
    delBtn.style.display = 'none';
  }

  modal.classList.add('open');
  document.body.classList.add('lock-scroll'); 
}

function openTrainerModal(uid = null) {
  haptic('light');
  const modal = document.getElementById('modalTrainer');
  const title = document.getElementById('trainerModalTitle');
  const btnSave = document.getElementById('btnSaveTrainer');
  const btnDel = document.getElementById('btnDeleteTrainer');
  const inpName = document.getElementById('trainerInputName');
  const inpId = document.getElementById('trainerInputId');
  const inpUid = document.getElementById('editTrainerUid');

  if (uid) {
    const t = appState.trainers.find(x => Number(x.uid) === Number(uid));
    if (!t) return; 

    title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
    btnSave.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    inpUid.value = t.uid;
    inpName.value = t.name;
    inpId.value = t.id || '';
    btnDel.style.display = 'block';
  } else {
    title.textContent = '–ù–æ–≤—ã–π –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫';
    btnSave.textContent = '–ü–æ–¥–∫–ª—é—á–∏—Ç—å';
    inpUid.value = '';
    inpName.value = '';
    inpId.value = '';
    btnDel.style.display = 'none';
  }
  
  modal.classList.add('open');
  document.body.classList.add('lock-scroll'); 
}

function closeModal(id) {
  haptic('light');
  document.getElementById(id).classList.remove('open');
  document.body.classList.remove('lock-scroll'); 
}

function initDaySelector() {
  document.querySelectorAll('.day-btn').forEach(btn => {
    btn.onclick = () => {
      btn.classList.toggle('active');
      haptic('light');
    }
  });
}

/* ============================================================
 * BLOCK 6: SYSTEM UTILS
 * ============================================================ */

function escapeHtml(text) {
  if (!text) return text;
  return text.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}

function copyId() {
  haptic('light');
  const text = document.getElementById('userIdDisplay').innerText.replace('ID: ', '');
  navigator.clipboard.writeText(text).then(() => {
     safeShowPopup('–£—Å–ø–µ—à–Ω–æ', 'ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
     haptic('success');
  }).catch(() => {
     safeShowPopup('–ò–Ω—Ñ–æ', 'ID: ' + text);
  });
}

function haptic(style) {
  if (!tg || !tg.HapticFeedback) return;
  const impacts = ['light', 'medium', 'heavy', 'rigid', 'soft'];
  const notifications = ['error', 'success', 'warning'];
  try {
    if (impacts.includes(style)) {
      tg.HapticFeedback.impactOccurred(style);
    } else if (notifications.includes(style)) {
      tg.HapticFeedback.notificationOccurred(style);
    }
  } catch(e) {}
}

function safeShowPopup(title, message) {
  if (tg && tg.showPopup && tg.isVersionAtLeast && tg.isVersionAtLeast('6.2')) {
       tg.showPopup({ title: title, message: message });
  } else {
       alert(`${title}: ${message}`);
  }
}

function safeShowConfirm(message, callback) {
  if (tg && tg.showConfirm && tg.isVersionAtLeast && tg.isVersionAtLeast('6.2')) {
       tg.showConfirm(message, callback);
  } else {
       const res = confirm(message);
       if (callback) callback(res);
  }
}

function loadState() {
  try {
    const s = localStorage.getItem(STORAGE_KEY);
    return s ? JSON.parse(s) : DEFAULT_STATE;
  } catch(e) { return DEFAULT_STATE; }
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
}
</script>
  
</body>
</html>
