// ==========================================
// ‚öôÔ∏è –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
// ==========================================

// 1. –¢–æ–∫–µ–Ω –±–æ—Ç–∞
const BOT_TOKEN = PropertiesService.getScriptProperties().getProperty('TELEGRAM_BOT_TOKEN');

if (!BOT_TOKEN) {
  throw new Error('–û–®–ò–ë–ö–ê: –ù–µ –Ω–∞–π–¥–µ–Ω TELEGRAM_BOT_TOKEN –≤ —Å–≤–æ–π—Å—Ç–≤–∞—Ö —Å–∫—Ä–∏–ø—Ç–∞!');
}

// 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¢–∞–±–ª–∏—Ü—ã
// ‚ö†Ô∏è –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–® ID
const SPREADSHEET_ID = '1Nlnqi9vWc9UGigFzfDWmj32o-X-AweUPu_CTCGRUYQE'; 
const SHEET_NAME = 'Users';           

// 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Mini App
// ‚ö†Ô∏è –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–®–£ –°–°–´–õ–ö–£
const TMA_URL = 'https://t.me/llmacros_bot/productapp';      
const TIMEZONE = "GMT+3";             

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ (A=1, B=2, –∏ —Ç.–¥.)
const COL_ID = 2;        // B - UserID
const COL_TRAINERS = 6;  // F - JSON Trainers
const COL_ALARMS = 7;    // G - JSON Alarms
const COL_UPDATED = 8;   // H - Last Update Timestamp

// ==========================================
// üöÄ –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø (DO POST)
// ==========================================
function doPost(e) {
  const output = ContentService.createTextOutput(JSON.stringify({ ok: true }));
  if (!e || !e.postData) return output.setMimeType(ContentService.MimeType.JSON);
  
  try {
    const data = JSON.parse(e.postData.contents);
    
    // --- –°–¶–ï–ù–ê–†–ò–ô 1: Mini App ---
    if (data.action === 'get_trainer_photo') {
      return ContentService.createTextOutput(JSON.stringify({
        ok: true, photo: getTelegramPhoto(data.trainer_id) 
      })).setMimeType(ContentService.MimeType.JSON);
    }

    if (data.action === 'sync_profile') {
      return ContentService.createTextOutput(JSON.stringify(handleProfileSync(data)))
        .setMimeType(ContentService.MimeType.JSON);
    }

    // --- –°–¶–ï–ù–ê–†–ò–ô 2: Telegram Bot ---
    if (data.update_id) {
      if (isUpdateProcessed(data)) return output; 
      if (data.message && data.message.text) {
        processMessage(data.message);
      }
    }

  } catch (error) {
    console.error('CRITICAL ERROR:', error);
    if (e.postData.contents.includes('"action"')) {
       return ContentService.createTextOutput(JSON.stringify({ ok: false, error: error.toString() }))
         .setMimeType(ContentService.MimeType.JSON);
    }
  }
  return output;
}

// ==========================================
// üîÑ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ü–†–û–§–ò–õ–Ø
// ==========================================
function handleProfileSync(data) {
  const lock = LockService.getScriptLock();
  try { lock.waitLock(3000); } catch (e) { return { ok: false, error: 'BUSY' }; }

  try {
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
    const userId = String(data.userId);
    let rowIndex = data.rowIndex; 
    let rowFound = false;

    // 1. –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –∏–Ω–¥–µ–∫—Å—É
    if (rowIndex && rowIndex > 1 && rowIndex <= sheet.getLastRow()) {
      const checkId = String(sheet.getRange(rowIndex, COL_ID).getValue());
      if (checkId === userId) rowFound = true;
    }

    // 2. –ü–æ–ª–Ω—ã–π –ø–æ–∏—Å–∫
    if (!rowFound) {
      const finder = sheet.getRange(1, COL_ID, sheet.getLastRow(), 1).createTextFinder(userId);
      const match = finder.matchEntireCell(true).findNext();
      if (match) {
        rowIndex = match.getRow();
        rowFound = true;
      }
    }

    // 3. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ
    if (!rowFound) {
      const timestamp = new Date();
      sheet.appendRow([
        Utilities.formatDate(timestamp, TIMEZONE, "dd.MM.yyyy HH:mm:ss"), 
        userId, '', 'New User', 'app_sync', '[]', '[]', timestamp
      ]);
      rowIndex = sheet.getLastRow();
    }

    // SAVE
    if (data.type === 'save') {
      const now = new Date();
      sheet.getRange(rowIndex, COL_TRAINERS).setValue(JSON.stringify(data.trainers || []));
      sheet.getRange(rowIndex, COL_ALARMS).setValue(JSON.stringify(data.alarms || []));
      sheet.getRange(rowIndex, COL_UPDATED).setValue(now);
      return { ok: true, rowIndex: rowIndex, updated: now.getTime() };
    } 
    
    // LOAD
    else {
      const dbTrainers = sheet.getRange(rowIndex, COL_TRAINERS).getValue();
      const dbAlarms = sheet.getRange(rowIndex, COL_ALARMS).getValue();
      let trainers = [], alarms = [];
      try { if(dbTrainers) trainers = JSON.parse(dbTrainers); } catch(e) {}
      try { if(dbAlarms) alarms = JSON.parse(dbAlarms); } catch(e) {}

      return { ok: true, rowIndex: rowIndex, trainers: trainers, alarms: alarms };
    }

  } catch (e) {
    return { ok: false, error: e.toString() };
  } finally {
    lock.releaseLock();
  }
}

// ==========================================
// üì∏ –ü–û–õ–£–ß–ï–ù–ò–ï –§–û–¢–û
// ==========================================
function getTelegramPhoto(userId) {
  try {
    const urlPhotos = `https://api.telegram.org/bot${BOT_TOKEN}/getUserProfilePhotos?user_id=${userId}&limit=1`;
    const respPhotos = UrlFetchApp.fetch(urlPhotos, {muteHttpExceptions: true});
    const jsonPhotos = JSON.parse(respPhotos.getContentText());

    if (!jsonPhotos.ok || jsonPhotos.result.total_count === 0) return null; 
    const fileId = jsonPhotos.result.photos[0][jsonPhotos.result.photos[0].length - 1].file_id;

    const urlFile = `https://api.telegram.org/bot${BOT_TOKEN}/getFile?file_id=${fileId}`;
    const respFile = UrlFetchApp.fetch(urlFile, {muteHttpExceptions: true});
    const filePath = JSON.parse(respFile.getContentText()).result.file_path;
    
    const imageBlob = UrlFetchApp.fetch(`https://api.telegram.org/file/bot${BOT_TOKEN}/${filePath}`).getBlob();
    return `data:${imageBlob.getContentType()};base64,${Utilities.base64Encode(imageBlob.getBytes())}`;

  } catch (e) {
    return null;
  }
}

// ==========================================
// üõ° –ó–ê–©–ò–¢–ê –û–¢ –î–£–ë–õ–ï–ô
// ==========================================
function isUpdateProcessed(update) {
  const updateId = String(update.update_id);
  const cache = CacheService.getScriptCache();
  if (cache.get(updateId)) return true;
  cache.put(updateId, 'processed', 600);
  return false;
}

// ==========================================
// üß† –û–ë–†–ê–ë–û–¢–ö–ê /START
// ==========================================
function processMessage(msg) {
  if (msg.text && msg.text.startsWith('/start')) {
    const payloadParts = msg.text.trim().split(/\s+/);
    const payload = payloadParts.length > 1 ? payloadParts[1] : 'organic';
    
    checkAndSaveUser(msg, payload);
    try { sendWelcomeMessage(msg.chat.id, payload); } catch (e) { console.error(e); }
  }
}

// ==========================================
// üìù –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –Æ–ó–ï–†–ê
// ==========================================
function checkAndSaveUser(msg, payload) {
  const lock = LockService.getScriptLock();
  try { lock.waitLock(10000); } catch (e) { return 'TIMEOUT'; }

  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = ss.getSheetByName(SHEET_NAME);
    if (!sheet) {
      sheet = ss.insertSheet(SHEET_NAME);
      sheet.appendRow(['Date/Time', 'UserID', 'Username', 'Name', 'Payload', 'Trainers JSON', 'Alarms JSON', 'Last Updated']);
    }

    const userId = String(msg.from.id);
    const match = sheet.getRange("B:B").createTextFinder(userId).matchEntireCell(true).findNext();

    if (match) {
      if (payload !== 'organic') {
        // –û–±–Ω–æ–≤–ª—è–µ–º payload –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è
        const cell = sheet.getRange(match.getRow(), 5);
        if (String(cell.getValue()) !== String(payload)) cell.setValue(payload);
      }
      return 'EXISTING'; 
    } 

    sheet.appendRow([
      Utilities.formatDate(new Date(), TIMEZONE, "dd.MM.yyyy HH:mm:ss"),
      userId,
      msg.from.username ? `@${msg.from.username}` : '',
      `${msg.from.first_name} ${msg.from.last_name || ''}`.trim(),
      payload, '[]', '[]', new Date()
    ]);
    SpreadsheetApp.flush();
    return 'CREATED';

  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ —Ç–∞–±–ª–∏—Ü—ã:', e);
    return 'ERROR';
  } finally {
    lock.releaseLock();
  }
}

// ==========================================
// üì§ –û–¢–ü–†–ê–í–ö–ê –ü–†–ò–í–ï–¢–°–¢–í–ò–Ø
// ==========================================
function sendWelcomeMessage(chatId, payload) {
  const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
  let welcomeText = "–ü—Ä–∏–≤–µ—Ç! üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å."; 
  
  try {
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName('readme'); 
    if (sheet) {
      const cellValue = sheet.getRange('F1').getDisplayValue(); 
      if (cellValue && cellValue.trim() !== "") welcomeText = cellValue;
    }
  } catch (e) {}

  let finalAppUrl = TMA_URL;
  if (payload && payload !== 'organic') {
    finalAppUrl += (finalAppUrl.includes('?') ? '&' : '?') + `startapp=${payload}`;
  }

  const payloadData = {
    chat_id: chatId,
    text: welcomeText,
    reply_markup: { inline_keyboard: [[{ text: "üöÄ –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", url: finalAppUrl }]] }
  };

  try {
    // –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å HTML
    payloadData.parse_mode = 'HTML';
    const resp = UrlFetchApp.fetch(url, {
      method: 'post', contentType: 'application/json', 
      payload: JSON.stringify(payloadData), muteHttpExceptions: true
    });
    if (!JSON.parse(resp.getContentText()).ok) throw new Error("HTML Error");
  } catch (e) {
    // –ü–ª–∞–Ω –ë: –¢–µ–∫—Å—Ç –±–µ–∑ HTML
    delete payloadData.parse_mode;
    UrlFetchApp.fetch(url, {
      method: 'post', contentType: 'application/json', 
      payload: JSON.stringify(payloadData), muteHttpExceptions: true
    });
  }
}

// ==========================================
// ‚ö°Ô∏è –°–ò–°–¢–ï–ú–ê –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ô (High Load / Batching)
// ==========================================
function startRemindersLoop() {
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(t => { if (t.getHandlerFunction() === 'checkReminders') ScriptApp.deleteTrigger(t); });
  ScriptApp.newTrigger('checkReminders').timeBased().everyMinutes(1).create();
  console.log('‚úÖ –°–∏—Å—Ç–µ–º–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞!');
}

function checkReminders() {
  let sheet;
  try { sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME); } 
  catch (e) { console.error('–û—à–∏–±–∫–∞ –ë–î:', e); return; }

  const data = sheet.getDataRange().getValues();
  const now = new Date();
  const currentHm = Utilities.formatDate(now, TIMEZONE, "HH:mm");
  const currentDay = getDayString(now);

  let requestsBucket = []; 

  // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ —é–∑–µ—Ä–∞–º (–ø—Ä–æ–ø—É—Å–∫–∞—è –∑–∞–≥–æ–ª–æ–≤–æ–∫)
  for (let i = 1; i < data.length; i++) {
    const userId = String(data[i][1]); // Col B
    const alarmsJson = data[i][6];     // Col G

    if (!alarmsJson || alarmsJson.length < 5) continue;
    
    let alarms = [];
    try { alarms = JSON.parse(alarmsJson); } catch (e) { continue; }

    alarms.forEach(alarm => {
      if (alarm.active && 
          String(alarm.time) === String(currentHm) && 
          alarm.days.includes(currentDay)) {
         
         // üöÄ –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ—Ä–∑–∏–Ω—É –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
         requestsBucket.push({
           url: `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`,
           method: 'post',
           contentType: 'application/json',
           payload: JSON.stringify({
             chat_id: userId,
             text: `<b>üîî –í—ã –ø—Ä–æ—Å–∏–ª–∏ –Ω–∞–ø–æ–º–Ω–∏—Ç—å</b>\n\n${alarm.title} ‚Äî ${alarm.time}\n\n<i>–ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –∑–∞–ø–æ–ª–Ω—è—Ç—å Macros!</i>`,
             parse_mode: 'HTML'
           }),
           muteHttpExceptions: true 
         });
      }
    });
  }

  // –û–¢–ü–†–ê–í–ö–ê –ü–ê–ß–ö–ê–ú–ò
  if (requestsBucket.length > 0) {
    console.log(`üì§ –†–∞—Å—Å—ã–ª–∫–∞ ${requestsBucket.length} —Å–æ–æ–±—â–µ–Ω–∏–π...`);
    const BATCH_SIZE = 50;
    
    for (let i = 0; i < requestsBucket.length; i += BATCH_SIZE) {
      const batch = requestsBucket.slice(i, i + BATCH_SIZE);
      try {
        UrlFetchApp.fetchAll(batch); // ‚ö°Ô∏è –ú–æ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ 50 —à—Ç
        console.log(`‚úÖ –ü–∞—á–∫–∞ ${i}-${i + batch.length} —É—à–ª–∞.`);
      } catch (e) { console.error(`üî• –°–±–æ–π –ø–∞—á–∫–∏ ${i}:`, e); }
      Utilities.sleep(1100); // –õ–∏–º–∏—Ç –¢–µ–ª–µ–≥—Ä–∞–º–∞
    }
  }
}

// –•–µ–ª–ø–µ—Ä: –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏
function getDayString(date) {
  const map = { '1': '–ü–Ω', '2': '–í—Ç', '3': '–°—Ä', '4': '–ß—Ç', '5': '–ü—Ç', '6': '–°–±', '7': '–í—Å' };
  return map[Utilities.formatDate(date, TIMEZONE, "u")];
}

// ==========================================
// üîß –£–¢–ò–õ–ò–¢–´ –ù–ê–°–¢–†–û–ô–ö–ò (–ó–ê–ü–£–°–ö–ê–¢–¨ –í–†–£–ß–ù–£–Æ)
// ==========================================
function INITIAL_SETUP() {
  // üëá –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–® URL –í–ï–ë-–ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
  const webAppUrl = 'https://script.google.com/macros/s/AKfycbzQbW4Bqmwq_51k9Op_CLJa5IX9v_MYkgXde2y3fAqqHX5wsvbSN7Uw9OpXFPP6raU/exec'; 
  
  if (webAppUrl.includes('–í–ê–®_')) { console.error('‚ùå –í—Å—Ç–∞–≤—å—Ç–µ URL!'); return; }
  if (!BOT_TOKEN) throw new Error('–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞!');

  // 1. –í–µ–±—Ö—É–∫
  UrlFetchApp.fetch(`https://api.telegram.org/bot${BOT_TOKEN}/deleteWebhook?drop_pending_updates=true`);
  console.log('Webhook Set:', UrlFetchApp.fetch(`https://api.telegram.org/bot${BOT_TOKEN}/setWebhook?url=${webAppUrl}`).getContentText());

  // 2. –ö–Ω–æ–ø–∫–∞
  UrlFetchApp.fetch(`https://api.telegram.org/bot${BOT_TOKEN}/setChatMenuButton`, { 
    method: 'post', contentType: 'application/json', 
    payload: JSON.stringify({ menu_button: { type: "web_app", text: "–ó–∞–ø—É—Å—Ç–∏—Ç—å", web_app: { url: TMA_URL } } }) 
  });
  console.log('‚úÖ –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é –æ–±–Ω–æ–≤–ª–µ–Ω–∞');

  // 3. –¢—Ä–∏–≥–≥–µ—Ä
  startRemindersLoop();
}

function debugTelegramStatus() {
  const t = PropertiesService.getScriptProperties().getProperty('TELEGRAM_BOT_TOKEN');
  try {
    console.log("ü§ñ Bot:", JSON.parse(UrlFetchApp.fetch(`https://api.telegram.org/bot${t}/getMe`).getContentText()).result.username);
    const h = JSON.parse(UrlFetchApp.fetch(`https://api.telegram.org/bot${t}/getWebhookInfo`).getContentText()).result;
    console.log("üîó Webhook:", h.url, "| Pending:", h.pending_update_count, "| Last Error:", h.last_error_message || 'None');
  } catch (e) { console.error(e); }
}

function DEBUG_CHECK_TIME() {
  const s = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
  const hm = Utilities.formatDate(new Date(), TIMEZONE, "HH:mm");
  const d = getDayString(new Date());
  console.log(`üïí Server Time: ${hm} (${d})`);
  
  const data = s.getDataRange().getValues();
  for (let i = 1; i < Math.min(data.length, 6); i++) {
    const r = data[i];
    if(!r[6] || r[6] == '[]') continue;
    try {
      JSON.parse(r[6]).forEach(a => {
        console.log(`User ${r[1]}: ${a.title} @ ${a.time} (${a.days}) -> Match? ${a.time==hm && a.days.includes(d)}`);
      });
    } catch(e) {}
  }
}
