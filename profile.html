<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Ultima Profile</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  /* 0. RESET & SCROLLBAR HIDE */
  ::-webkit-scrollbar { width: 0 !important; height: 0 !important; display: none !important; background: transparent !important; }
  * { -ms-overflow-style: none !important; scrollbar-width: none !important; }

  :root {
    --bg-core: #050505;
    --text-main: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.55);
    --acc-blue: #0a84ff;
    --acc-red: #ff453a;
    --acc-green: #30d158;
    --radius-l: 24px;
    --pad: 16px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

  body {
    background-color: var(--bg-core);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', Roboto, sans-serif;
    color: var(--text-main);
    min-height: 100vh;
    overflow-x: hidden;
    padding-bottom: 120px;
  }
  
  body.lock-scroll { overflow: hidden !important; height: 100%; position: fixed; width: 100%; }

  /* FX BACKGROUND */
  .fx-layer { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
  .orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.4; }
  .orb-1 { top: -10%; left: -20%; width: 300px; height: 300px; background: #5e60ce; animation: breathe 10s infinite; }
  .orb-2 { bottom: 10%; right: -10%; width: 250px; height: 250px; background: var(--acc-blue); animation: breathe 12s infinite reverse; }
  .noise { position: fixed; inset: 0; opacity: 0.05; background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); }
  @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.3; } 50% { transform: scale(1.1); opacity: 0.5; } }

  /* APP SHELL */
  .app-shell { max-width: 480px; margin: 0 auto; padding: var(--pad); padding-top: calc(20px + env(safe-area-inset-top)); }

  /* HERO */
  .profile-hero { display: flex; align-items: center; gap: 20px; margin-bottom: 32px; padding: 0 4px; }
  .avatar-ring { width: 88px; height: 88px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; position: relative; }
  .avatar-img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; background: #222; }
  .avatar-glow { position: absolute; inset: 0; border-radius: 50%; background: radial-gradient(circle, var(--acc-blue), transparent 70%); opacity: 0.3; filter: blur(20px); z-index: -1; }
  .profile-meta { display: flex; flex-direction: column; gap: 8px; min-width: 0; }
  .user-name { font-size: 26px; font-weight: 800; margin: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .user-id-badge { display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 20px; font-size: 13px; color: var(--text-muted); cursor: pointer; }
  
  /* SECTIONS */
  .section-head { display: flex; justify-content: space-between; margin-bottom: 14px; padding: 0 4px; }
  .section-title { font-size: 20px; font-weight: 700; }
  .section-action { font-size: 14px; color: var(--acc-blue); font-weight: 500; cursor: pointer; padding: 4px; }
  
  .mentors-grid { display: flex; flex-direction: column; gap: 10px; margin-bottom: 32px; }
  .mentor-card { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(20px); border-radius: 20px; display: flex; align-items: center; justify-content: space-between; padding: 14px 18px; }
  .m-info { display: flex; align-items: center; gap: 14px; }
  .m-av { width: 44px; height: 44px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; border: 1px solid rgba(255,255,255,0.15); }
  .m-details { display: flex; flex-direction: column; }
  .m-status { font-size: 10px; color: var(--acc-green); text-transform: uppercase; font-weight: 700; opacity: 0.9; margin-bottom: 2px; }
  .m-name { font-weight: 700; font-size: 16px; }
  .m-id { font-size: 12px; color: var(--text-muted); font-family: monospace; }
  .m-del { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(255,69,58,0.1); color: var(--acc-red); }

  .rituals-list { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(20px); border-radius: var(--radius-l); overflow: hidden; margin-bottom: 32px; display: flex; flex-direction: column; }
  .ritual-item { display: flex; justify-content: space-between; padding: 18px 20px; position: relative; align-items: center; }
  .ritual-item::after { content: ''; position: absolute; bottom: 0; left: 20px; right: 0; height: 1px; background: rgba(255,255,255,0.1); }
  .ritual-item:last-child::after { display: none; }
  .r-left { display: flex; flex-direction: column; gap: 4px; }
  .r-time { font-size: 28px; font-weight: 300; line-height: 1; }
  .r-title { font-size: 13px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
  .r-days { font-size: 11px; color: var(--acc-blue); margin-top: 2px; }
  
  .switch { position: relative; width: 51px; height: 31px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; inset: 0; background: rgba(255,255,255,0.15); border-radius: 34px; transition: .4s; }
  .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background: var(--acc-blue); }
  input:checked + .slider:before { transform: translateX(20px); }

  .empty-state { text-align: center; padding: 30px; color: var(--text-muted); border: 1px dashed rgba(255,255,255,0.1); border-radius: var(--radius-l); }

  /* ============================================================
   * 6. MODALS - "NEAT & FLOATING" EDITION
   * ============================================================ */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 999;
    backdrop-filter: blur(6px); opacity: 0; pointer-events: none; transition: 0.3s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: auto; }

  .bottom-sheet {
    position: fixed; 
    
    /* === ЦЕНТРИРОВАНИЕ И ОГРАНИЧЕНИЕ ШИРИНЫ === */
    left: 0; 
    right: 0; 
    margin: 0 auto; /* Центрируем, если экран широкий */
    bottom: 0; /* Прижимаем к низу */
    
    width: 100%;
    max-width: 480px; /* Ограничиваем, чтобы не было шире приложения */

    /* === СТИЛЬ "ОСТРОВОК" (Опционально: убрал прилипание к краям) === */
    /* Если хотите, чтобы она совсем "плавала", раскомментируйте 3 строки ниже и уберите width: 100% выше */
    /* width: calc(100% - 16px); */
    /* bottom: 10px; */
    /* border-radius: 28px; */

    /* Фон и скругления */
    background: #121212; 
    border-top: 1px solid rgba(255,255,255,0.2);
    /* Если прижата к низу - скругляем только верх */
    border-radius: 28px 28px 0 0; 
    
    z-index: 1000;
    
    /* Высота для старых телефонов */
    height: 85vh; 
    max-height: 85vh;
    
    display: flex;
    flex-direction: column;
    
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    
    /* Тень по бокам, чтобы видно было границы на широком экране */
    box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
  }
  
  .modal-overlay.open .bottom-sheet { transform: translateY(0); }

  .bs-header { 
    flex: 0 0 auto;
    display: flex; justify-content: space-between; align-items: center; 
    padding: 24px 24px 10px 24px;
    background: inherit;
    z-index: 2;
    border-radius: 28px 28px 0 0;
  }
  .bs-title { font-size: 18px; font-weight: 700; }
  .bs-close { font-size: 14px; font-weight: 600; color: var(--acc-blue); background: none; border: none; padding: 8px; }

  /* SCROLL AREA + PADDING FIX */
  .bs-scroll-area {
    flex: 1;
    overflow-y: auto;
    padding: 0 24px;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 400px; /* Гигантский отступ для скролла над клавиатурой */
  }

  /* INPUTS & BTNS */
  .input-group { margin-bottom: 24px; }
  .input-label { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; font-weight: 700; padding-left: 4px; }
  .ultima-input { 
    width: 100%; background: rgba(255,255,255,0.08); 
    border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; 
    padding: 16px; color: #fff; font-size: 16px; /* 16px anti-zoom iOS */
  }
  .ultima-input:focus { border-color: var(--acc-blue); background: rgba(0,0,0,0.4); }

  .time-picker-row { display: flex; justify-content: center; margin-bottom: 24px; margin-top: 10px; }
  .huge-time-input { background: transparent; border: none; color: #fff; font-size: 56px; font-weight: 200; text-align: center; width: 100%; font-family: -apple-system, sans-serif; }
  
  .day-selector { display: flex; justify-content: space-between; margin-bottom: 30px; }
  .day-btn { width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-muted); font-size: 13px; font-weight: 600; display: flex; align-items: center; justify-content: center; }
  .day-btn.active { background: #fff; color: #000; transform: scale(1.05); }

  .btn-container { margin-top: 20px; display: flex; flex-direction: column; gap: 12px; }

  .action-btn { width: 100%; padding: 16px; border-radius: 16px; background: var(--acc-blue); color: #fff; font-size: 17px; font-weight: 700; border: none; cursor: pointer; text-align: center; }
  .action-btn:active { transform: scale(0.98); opacity: 0.9; }
  .action-btn.delete { background: rgba(255,69,58,0.15); color: var(--acc-red); border: 1px solid rgba(255,69,58,0.3); }

</style>
</head>
<body>

<div class="fx-layer">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="noise"></div>
</div>

<div class="app-shell">
  <div class="profile-hero">
    <div class="avatar-wrapper">
      <div class="avatar-ring">
        <img src="https://i.pravatar.cc/300?img=11" class="avatar-img" id="userAvatar">
      </div>
      <div class="avatar-glow"></div>
    </div>
    <div class="profile-meta">
      <h1 class="user-name" id="userName">Александр</h1>
      <div class="user-id-badge" onclick="copyId()">
        ID: <span id="userIdDisplay">1849</span>
        <svg style="width:14px;height:14px;opacity:0.6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
      </div>
    </div>
  </div>

  <div class="section-head">
    <div class="section-title">Тренеры</div>
    <div class="section-action" onclick="openTrainerModal()">+ Добавить</div>
  </div>
  <div id="trainersList" class="mentors-grid"></div>

  <div class="section-head">
    <div class="section-title">Ритуалы и Напоминания</div>
    <div class="section-action" onclick="openAlarmModal()">+ Создать</div>
  </div>
  <div id="alarmsList" class="rituals-list"></div>
</div>

<div id="modalTrainer" class="modal-overlay">
  <div class="bottom-sheet">
    <div class="bs-header">
      <div class="bs-title" id="trainerModalTitle">Новый наставник</div>
      <button class="bs-close" onclick="closeModal('modalTrainer')">Закрыть</button>
    </div>
    
    <div class="bs-scroll-area">
      <input type="hidden" id="editTrainerUid">
      <div class="input-group">
        <label class="input-label">Имя тренера (Обязательно)</label>
        <input type="text" id="trainerInputName" class="ultima-input" placeholder="Например: Алина" autocomplete="off">
      </div>
      <div class="input-group">
        <label class="input-label">ID тренера (Только цифры)</label>
        <input type="tel" id="trainerInputId" class="ultima-input" placeholder="Например: 123456789" inputmode="numeric" pattern="[0-9]*" oninput="this.value = this.value.replace(/[^0-9]/g, '')" autocomplete="off">
      </div>
      <div class="btn-container">
        <button class="action-btn" id="btnSaveTrainer" onclick="saveTrainer()">Подключить</button>
        <button class="action-btn delete" id="btnDeleteTrainer" onclick="deleteTrainerFromModal()" style="display:none">Удалить</button>
      </div>
    </div>
  </div>
</div>

<div id="modalAlarm" class="modal-overlay">
  <div class="bottom-sheet">
    <div class="bs-header">
      <div class="bs-title">Настройка ритуала</div>
      <button class="bs-close" onclick="closeModal('modalAlarm')">Закрыть</button>
    </div>
    
    <div class="bs-scroll-area">
      <input type="hidden" id="editAlarmId">
      <div class="time-picker-row">
        <input type="time" id="alarmTime" class="huge-time-input" value="09:00">
      </div>
      <div class="input-group">
        <label class="input-label">Название</label>
        <input type="text" id="alarmTitle" class="ultima-input" placeholder="Например: Взвешивание">
      </div>
      <div class="input-group">
        <label class="input-label">Повторять</label>
        <div class="day-selector" id="daySelector">
          <div class="day-btn" data-day="Пн">Пн</div>
          <div class="day-btn" data-day="Вт">Вт</div>
          <div class="day-btn" data-day="Ср">Ср</div>
          <div class="day-btn" data-day="Чт">Чт</div>
          <div class="day-btn" data-day="Пт">Пт</div>
          <div class="day-btn active" data-day="Сб">Сб</div>
          <div class="day-btn" data-day="Вс">Вс</div>
        </div>
      </div>
      <div class="btn-container">
        <button class="action-btn" onclick="saveAlarmFromModal()">Сохранить</button>
        <button class="action-btn delete" id="btnDeleteAlarm" onclick="deleteAlarmFromModal()" style="display:none">Удалить</button>
      </div>
    </div>
  </div>
</div>

<script>
// --- CONFIG ---
const GAS_URL = 'https://script.google.com/macros/s/AKfycbzQbW4Bqmwq_51k9Op_CLJa5IX9v_MYkgXde2y3fAqqHX5wsvbSN7Uw9OpXFPP6raU/exec'; 
const STORAGE_KEY = 'ultima_profile_v1';
const PHOTO_CACHE_KEY = 'ultima_photos_v1';
const PHOTO_TTL = 24 * 60 * 60 * 1000; 

let appState = loadState();
const tg = window.Telegram?.WebApp;

// --- INIT ---
(function initTMA() {
  if (!tg) return;
  tg.ready(); tg.expand();
  try { tg.setHeaderColor('#050505'); if (tg.setBackgroundColor) tg.setBackgroundColor('#050505'); } catch (e) {}
  try { if (tg.disableVerticalSwipes) tg.disableVerticalSwipes(); } catch (e) {}
  
  if (tg.BackButton) {
    tg.BackButton.show();
    tg.BackButton.onClick(() => {
        if(document.referrer && document.referrer.includes(window.location.host)) history.back();
        else window.location.href = 'router.html';
    });
  }
})();

document.addEventListener('DOMContentLoaded', () => {
  if(tg && tg.initDataUnsafe?.user) {
      const u = tg.initDataUnsafe.user;
      if (u.first_name) document.getElementById('userName').textContent = escapeHtml(u.first_name);
      appState.userId = String(u.id); 
      document.getElementById('userIdDisplay').textContent = appState.userId;
      if(u.photo_url) document.getElementById('userAvatar').src = u.photo_url;
  }
  appState.timezoneOffset = new Date().getTimezoneOffset();
  renderTrainers(); renderAlarms(); initDaySelector(); syncLoad();
  
  const inputs = document.querySelectorAll('input');
  inputs.forEach(inp => {
    inp.addEventListener('focus', function() {
       setTimeout(() => { this.scrollIntoView({behavior: 'smooth', block: 'center'}); }, 300);
    });
  });
});

// --- SYNC ---
async function syncLoad() {
  if (!GAS_URL.includes('/exec')) return;
  try {
    const r = await fetch(GAS_URL, {
      method: 'POST', body: JSON.stringify({ action: 'sync_profile', type: 'load', userId: appState.userId, rowIndex: appState.rowIndex, timezoneOffset: appState.timezoneOffset })
    });
    const d = await r.json();
    if (d.ok) {
      if (d.rowIndex) appState.rowIndex = d.rowIndex;
      const localS = JSON.stringify({t: appState.trainers, a: appState.alarms});
      const serverS = JSON.stringify({t: d.trainers, a: d.alarms});
      
      const serverEmpty = (!d.trainers?.length && !d.alarms?.length);
      const localHasData = (appState.trainers.length || appState.alarms.length);

      if (serverEmpty && localHasData) { syncSave(); } 
      else if (localS !== serverS) {
        appState.trainers = d.trainers || [];
        appState.alarms = d.alarms || [];
        saveState(); renderTrainers(); renderAlarms();
      } else { saveState(); }
    }
  } catch (e) { console.error(e); }
}

function syncSave() {
  saveState();
  if (!GAS_URL.includes('/exec')) return;
  fetch(GAS_URL, {
    method: 'POST', body: JSON.stringify({ action: 'sync_profile', type: 'save', userId: appState.userId, rowIndex: appState.rowIndex, trainers: appState.trainers, alarms: appState.alarms, timezoneOffset: appState.timezoneOffset })
  }).then(r=>r.json()).then(d=>{ if(d.ok && d.rowIndex){ appState.rowIndex = d.rowIndex; saveState(); } });
}

// --- PHOTO CACHE ---
async function fetchTrainerPhoto(tid, elId) {
  if (!tid) return;
  const cacheKey = `photo_${tid}`;
  let cached = null;
  try { cached = JSON.parse(localStorage.getItem(PHOTO_CACHE_KEY))[cacheKey]; } catch(e){}
  
  const img = document.getElementById(elId);
  if (cached && cached.data) {
    if(img) { img.style.backgroundImage = `url('${cached.data}')`; img.innerHTML = ''; }
    if (Date.now() - cached.time < PHOTO_TTL) return;
  }
  
  if (GAS_URL.includes('/exec')) {
    fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'get_trainer_photo', trainer_id: tid }) })
      .then(r=>r.json()).then(d => {
        if(d.ok && d.photo) {
           if(img) { img.style.backgroundImage = `url('${d.photo}')`; img.innerHTML = ''; }
           const all = JSON.parse(localStorage.getItem(PHOTO_CACHE_KEY) || '{}');
           all[cacheKey] = { data: d.photo, time: Date.now() };
           localStorage.setItem(PHOTO_CACHE_KEY, JSON.stringify(all));
        }
      });
  }
}

// --- RENDER ---
function renderTrainers() {
  const l = document.getElementById('trainersList'); l.innerHTML = '';
  if (!appState.trainers.length) { l.innerHTML = '<div class="empty-state">Нет подключенных тренеров</div>'; return; }
  appState.trainers.forEach((t, i) => {
    const uid = `t_img_${i}`;
    const d = document.createElement('div'); d.className = 'mentor-card';
    d.innerHTML = `
      <div class="m-info">
        <div class="m-av" id="${uid}" style="background-size:cover;background-position:center">${t.name[0]?.toUpperCase()||'?'}</div>
        <div class="m-details"><div class="m-status">Получает статистику</div><div class="m-name">${escapeHtml(t.name)}</div><div class="m-
