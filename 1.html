<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>FoodCam — камера</title>
  <meta name="theme-color" content="#0a7cff" />
  <style>
    :root{ --bg:#ffffff; --text:#111827; --muted:#6b7280; --ring:#e5e7eb; --primary:#2563eb; --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0;background:var(--bg);color:var(--text); font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; -webkit-font-smoothing:antialiased;-webkit-tap-highlight-color:transparent; }
    .container{max-width:760px;margin:0 auto;padding:16px}
    .hidden{display:none!important}
    .row{display:flex;gap:10px;flex-wrap:wrap}

    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:14px;border:1px solid var(--ring);background:#fff;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border-color:transparent}
    .btn[disabled]{opacity:.45;cursor:not-allowed}

    /* CAMERA AREA */
    .cam-wrap{position:relative;border:1px solid var(--ring);border-radius:16px;overflow:hidden;background:#000;aspect-ratio:3/4;contain:layout paint;}
    .cam-video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:block;opacity:0;transition:opacity .2s ease;transform:translateZ(0);backface-visibility:hidden}
    .cam-photo{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;display:block;background:#000}

    .cam-overlay{position:absolute;inset:0;pointer-events:none}
    .grid{position:absolute;inset:0;opacity:.15;background:
      linear-gradient(#fff 1px, transparent 1px) 0 calc(33.333% - .5px)/100% 33.333% repeat-y,
      linear-gradient(#fff 1px, transparent 1px) 0 calc(66.666% - .5px)/100% 33.333% repeat-y,
      linear-gradient(90deg,#fff 1px,transparent 1px) calc(33.333% - .5px) 0/33.333% 100% repeat-x,
      linear-gradient(90deg,#fff 1px,transparent 1px) calc(66.666% - .5px) 0/33.333% 100% repeat-x}

    .topbar{position:absolute;left:0;right:0;top:64px;display:flex;justify-content:center;gap:10px;z-index:9;pointer-events:none}
    .chip{pointer-events:auto;display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.25);background:rgba(0,0,0,.55);color:#fff}

    /* bottom controls inside camera */
    .controls{position:absolute;left:0;right:0;bottom:0;padding:12px;display:flex;gap:10px;align-items:center;justify-content:center;background:linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,0));color:#fff}
    .shutter{width:72px;height:72px;border-radius:999px;border:4px solid rgba(255,255,255,.9);background:#fff;cursor:pointer;box-shadow:0 2px 12px rgba(0,0,0,.4)}
    .shutter[disabled]{opacity:.45;cursor:not-allowed;border-color:rgba(255,255,255,.5)}

    .meta{color:var(--muted);font-size:12px;margin-top:8px}
    .field{display:flex;flex-direction:column;gap:6px;margin-top:10px}
    .textarea{width:100%;min-height:68px;resize:vertical;padding:10px 12px;border:1px solid var(--ring);border-radius:12px;font:inherit;line-height:1.35}
    .helper{color:var(--muted);font-size:12px}
    .error{background:#fef2f2;color:#b91c1c;border:1px solid #fecaca;border-radius:12px;padding:12px;margin:12px 0}

    .card-area{
      position:absolute; right:12px; top:50%; transform:translateY(-50%);
      width:115px; height:183px;
      border-radius:14px;
      border:2px solid rgba(255,255,255,.95);
      background:
        repeating-linear-gradient(45deg,
          rgba(255,255,255,.18) 0 10px,
          rgba(255,255,255,0) 10px 20px);
      box-shadow:0 0 0 1px rgba(0,0,0,.15) inset;
      pointer-events:none;
    }

    .indicators{position:absolute;left:0;right:0;bottom:96px;display:flex;gap:10px;justify-content:center;z-index:9;pointer-events:none}
    .ind{pointer-events:auto;display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.2);color:#fff;backdrop-filter:blur(2px)}
    .ind .bulb{width:12px;height:12px;border-radius:50%;background:var(--warn);box-shadow:0 0 0 2px rgba(0,0,0,.25) inset}
    .ind.ok .bulb{background:var(--ok)}
    .ind .label{font-size:12px;opacity:.95}
  </style>
</head>
<body>
  <main class="container">
    <div id="err" class="error hidden"></div>

    <section id="sec-main">
      <!-- Камера (фото) и галерея -->
      <input id="file-cam" type="file" accept="image/*" capture="environment" class="hidden" />
      <input id="file-gallery" type="file" accept="image/*" class="hidden" />

      <div class="cam-wrap" id="camWrap" aria-label="Камера и/или снимок">
        <!-- Видеопоток больше не используется, держим для совместимости (скрыт) -->
        <video id="video" class="cam-video hidden" playsinline muted></video>
        <img id="photo" class="cam-photo hidden" alt="Снимок" />

        <div id="overlay" class="cam-overlay">
          <div class="grid"></div>
          <div class="topbar">
            <div id="chipInfo" class="chip" role="status" aria-live="polite">Нажмите на кнопку, чтобы сделать фото</div>
          </div>

          <!-- статическая подсказка зоны карты (визуальный ориентир) -->
          <div id="cardArea" class="card-area" aria-label="Область для карты (портрет)"></div>

          <!-- индикаторы остаются, но логика «ровно/карта» отключена -->
          <div class="indicators">
            <div id="indLevel" class="ind"><span class="bulb"></span><span class="label">Ровно</span></div>
            <div id="indCard" class="ind"><span class="bulb"></span><span class="label">Карта</span></div>
          </div>
        </div>

        <div id="controls" class="controls">
          <button id="btnShot" class="shutter" aria-label="Сделать снимок"></button>
        </div>
      </div>

      <div id="meta" class="meta"></div>

      <div class="field">
        <label for="comment" class="helper">Комментарий (необязательно, но он повысит точность)</label>
        <textarea id="comment" class="textarea" maxlength="200" placeholder="Треска 150 гр и рис 200 гр"></textarea>
        <div id="commentWarn" class="helper hidden"></div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnRetake" class="btn" disabled>Переснять</button>
        <button id="btnGallery" class="btn">Галерея</button>
        <button id="btnSend" class="btn primary" disabled>Отправить</button>
      </div>
    </section>
  </main>

  <script>
  // ===================== CONFIG / STATE =====================
  const CONFIG = {
    maxSide: 4096, jpegQ: 0.95, webpQ: 0.95
  };

  let _lastBlob = null, _view='camera', _taking=false;

  // ===================== DOM =====================
  const $ = id => document.getElementById(id);
  const err=$('err');
  const video=$('video'), photo=$('photo'), overlay=$('overlay'), controls=$('controls');
  const btnShot=$('btnShot'), chipInfo=$('chipInfo');
  const fileCam=$('file-cam'), fileGallery=$('file-gallery');
  const indLevel=$('indLevel'), indCard=$('indCard');
  const meta=$('meta');
  const btnRetake=$('btnRetake'), btnGallery=$('btnGallery'), btnSend=$('btnSend');
  const commentEl=$('comment'), commentWarn=$('commentWarn');

  // ===================== UTILS =====================
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  function setError(msg,hint){ if(!msg){ err.classList.add('hidden'); err.innerHTML=''; return; } const extra = hint?`<div class="meta" style="white-space:pre-line;margin-top:6px">${hint}</div>`:''; err.innerHTML = msg + extra; err.classList.remove('hidden'); }
  function haptic(){ try{ window.Telegram?.WebApp?.HapticFeedback?.impactOccurred?.('light'); }catch{} }
  function sanitizeComment(input){
    let s = String(input||'').slice(0, 200);
    s = s.replace(/<[^>]*>/g, '').replace(/[\u0000-\u001F\u007F-\u009F]/g, '');
    s = s.replace(/(javascript:|data:|vbscript:|<script|<\/script|on\w+\s*=)/gi, '');
    s = s.replace(/[^\p{L}\p{N}\p{M}\s\.,!?:;"'()\-\u2013\u2014\[\]{}#@+/&%]/gu, '');
    s = s.replace(/\s+/g, ' ').trim();
    return s;
  }
  function hasText(){ return sanitizeComment(commentEl.value).length > 0; }
  function showCommentWarning(show, text){ commentWarn.textContent = text || ''; commentWarn.classList.toggle('hidden', !show); }
  function updateButtons(){
    btnRetake.disabled = (_view === 'camera') || _taking;
    btnSend.disabled = !(_lastBlob || hasText()) || _taking;
    // Всегда разрешаем съёмку: фотокамера вызывается нативно
    btnShot.disabled = _taking;
  }
  function syncIndicators(){
    // Индикация «ровно/карта» больше не вычисляется из видео — ставим нейтральное состояние
    indLevel.classList.toggle('ok', false);
    indCard.classList.toggle('ok', false);
    indLevel.setAttribute('aria-label', 'Ровно: недоступно в режиме фото');
    indCard.setAttribute('aria-label', 'Карта: недоступно в режиме фото');
  }

  function showCameraUI(){
    _view='camera';
    // Превью скрыто, ждём снимок от нативной камеры
    video.classList.add('hidden');
    overlay.classList.remove('hidden');
    controls.classList.remove('hidden');
    photo.classList.add('hidden');
    meta.textContent='';
    chipInfo.textContent='Нажмите на кнопку, чтобы сделать фото';
    updateButtons(); syncIndicators();
  }
  function showPhotoUI(){
    _view='photo';
    video.classList.add('hidden'); overlay.classList.add('hidden'); controls.classList.add('hidden');
    photo.classList.remove('hidden');
    updateButtons();
  }

  // ===================== AUTOSTART =====================
  window.addEventListener('DOMContentLoaded', () => {
    adaptPerf();
    startCameraFlow();
    try { window.Telegram?.WebApp?.ready?.(); } catch {}
  });

  function adaptPerf(){ /* оставлено для совместимости и будущих оптимизаций */ }

  // ===================== PHOTO-ONLY FLOW =====================
  btnShot.addEventListener('click', onShutter);
  btnRetake.addEventListener('click', ()=>{ if(btnRetake.disabled) return; startCameraFlow(true); });
  btnGallery.addEventListener('click', ()=>fileGallery?.click());
  fileGallery.addEventListener('change', onFilePicked);
  fileCam.addEventListener('change', onFilePicked);
  commentEl.addEventListener('input', ()=>{
    const raw=commentEl.value, safe=sanitizeComment(raw);
    showCommentWarning(raw!==safe, raw!==safe ? 'Некоторые символы удалены для безопасности.' : '');
    updateButtons();
  });

  async function startCameraFlow(userInitiated=false){
    _lastBlob=null; _taking=false;
    updateButtons(); setError('');
    showCameraUI();

    // Автозапуск камеры без жеста часто блокируется браузером.
    // Поэтому открываем её только по действию пользователя (кнопка) или при пересъёмке.
    if (userInitiated) {
      await sleep(50);
      try{ fileCam?.click(); }catch{}
    }
  }

  // ---------- SHUTTER ----------
  async function onShutter(){
    if(_taking) return;
    _taking=true; updateButtons(); haptic();
    try{
      // Открываем нативную камеру / файловый диалог
      fileCam?.click();
    } finally {
      // Разблокируем после того, как системный UI вернёт управление
      setTimeout(()=>{ _taking=false; updateButtons(); }, 300);
    }
  }

  // ---------- ГАЛЕРЕЯ / КАМЕРА РЕЗУЛЬТАТ ----------
  async function onFilePicked(ev){
    const file=ev.target?.files?.[0];
    if(!file) return;
    if(!file.type.startsWith('image/')){ setError('Нужен файл изображения.'); return; }
    _lastBlob=file;

    // Покажем превью
    const url=URL.createObjectURL(file);
    photo.onload=()=>{ meta.textContent = `${photo.naturalWidth}×${photo.naturalHeight} • ${file.type||'image'}`; };
    photo.src=url;

    showPhotoUI(); updateButtons(); ev.target.value='';
  }

  // SEND (пока заглушка)
  async function onSend(){
    const safeText=sanitizeComment(commentEl.value);
    if(!_lastBlob && !safeText){ setError('Пусто. Добавьте фото или комментарий.'); return; }
    console.log('DEBUG: отправка отключена.', { hasImage: !!_lastBlob, comment: safeText });
    setError('Отправка пока отключена. Подключим бэкенд/бота позже.');
  }
  btnSend.addEventListener('click', onSend);

  // TEARDOWN (на будущее)
  window.addEventListener('beforeunload', ()=>{ /* ничего не останавливаем: видеопоток не используется */ });

  </script>
</body>
</html>
