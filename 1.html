<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>FoodCam ‚Äî —Å–∏—Å—Ç–µ–º–Ω–∞—è –∫–∞–º–µ—Ä–∞ –∏ –≥–∞–ª–µ—Ä–µ—è (–±–µ–∑ React)</title>
    <meta name="theme-color" content="#0a7cff" />

    <!-- –ß–∏—Å—Ç—ã–π HTML/JS/CSS –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ WebView/Telegram -->
    <style>
      :root{
        --bg:#ffffff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --primary-contrast:#ffffff;
        --ring:#e5e7eb; --card:#f9fafb; --danger:#ef4444; --success:#16a34a;
      }
      *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);
        -webkit-font-smoothing:antialiased;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
      .container{max-width:720px;margin:0 auto;padding:24px}
      h1{font-size:22px;margin:0 0 6px}
      p.muted{margin:0 0 16px;color:var(--muted);font-size:14px}
      .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
      .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;
        padding:12px 16px;border-radius:16px;border:1px solid transparent;background:#fff;color:#111827;
        box-shadow:0 1px 2px rgba(0,0,0,.05);font-weight:600;cursor:pointer;transition:.15s transform}
      .btn:active{transform:scale(.98)}
      .btn-primary{background:var(--primary);color:var(--primary-contrast)}
      .btn-outline{background:#fff;border-color:var(--ring)}
      .btn-ghost{background:transparent;border-color:var(--ring)}
      .hidden{display:none !important}
      .card{border:1px solid var(--ring);border-radius:16px;background:#fff}
      .pad{padding:16px}
      .info{background:var(--card);color:var(--muted);border-radius:16px;padding:12px}
      .error{background:#fef2f2;color:#b91c1c;border:1px solid #fecaca;border-radius:12px;padding:12px;margin:12px 0}
      .success{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0;border-radius:12px;padding:12px;display:flex;gap:12px;align-items:center}
      .meta{color:var(--muted);font-size:12px;margin-top:6px}
      .preview-img{max-height:360px;width:100%;object-fit:contain;display:block;border-radius:16px}
      textarea{width:100%;min-height:112px;padding:12px;border-radius:16px;border:1px solid var(--ring);resize:none;font-size:14px}
      .right{display:flex;justify-content:flex-end}
      .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
      .progress{height:12px;background:#f3f4f6;border-radius:999px;overflow:hidden}
      .bar{height:100%;background:var(--primary);width:0%}
      footer{margin-top:24px;text-align:center;color:var(--muted);font-size:12px}
      .icon{width:20px;height:20px;display:inline-block;vertical-align:middle}
      .sr-only{position:absolute;left:-10000px}
    </style>
  </head>
  <body>
    <main class="container">
      <header>
        <h1>–°–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∫–∞–º–µ—Ä–æ–π –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏</h1>
        <p class="muted">–ò—Å–ø–æ–ª—å–∑—É–µ–º <b>—Ç–æ–ª—å–∫–æ —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–∞–º–µ—Ä—É</b> (rear), –±–µ–∑ –∂–∏–≤–æ–≥–æ –ø—Ä–µ–≤—å—é. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ‚Äî –ø–æ –∂–µ–ª–∞–Ω–∏—é.</p>
      </header>

      <div id="error" class="error hidden"></div>

      <!-- IDLE -->
      <section id="sec-idle">
        <div class="row">
          <button id="btn-system" class="btn btn-primary" aria-label="–û—Ç–∫—Ä—ã—Ç—å —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–∞–º–µ—Ä—É (rear)">
            <span class="icon" aria-hidden="true">üì∑</span> –°–∏—Å—Ç–µ–º–Ω–∞—è –∫–∞–º–µ—Ä–∞
          </button>
          <button id="btn-gallery" class="btn btn-outline" aria-label="–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏">
            <span class="icon" aria-hidden="true">üñºÔ∏è</span> –ì–∞–ª–µ—Ä–µ—è
          </button>
        </div>

        <div class="info" style="margin-top:12px">
          <span class="icon" aria-hidden="true">üí°</span>
          <span>–ö–Ω–æ–ø–∫–∞ ¬´–°–∏—Å—Ç–µ–º–Ω–∞—è –∫–∞–º–µ—Ä–∞¬ª –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –∫–∞–º–µ—Ä—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–∏–∞–ª–æ–≥. –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞.</span>
        </div>

        <!-- Hidden inputs -->
        <input id="file-gallery" type="file" accept="image/*" class="hidden" />
        <input id="file-system" type="file" accept="image/*" capture="environment" class="hidden" />
      </section>

      <!-- PREPARING -->
      <section id="sec-preparing" class="hidden">
        <div class="card pad" style="text-align:center">
          <div style="font-weight:600;margin-bottom:6px">–ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ—Ç–æ‚Ä¶</div>
          <div class="muted">–°–∂–∏–º–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é</div>
        </div>
      </section>

      <!-- PREVIEW -->
      <section id="sec-preview" class="hidden">
        <div class="card">
          <img id="img-preview" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ" class="preview-img" />
        </div>
        <div id="meta" class="meta"></div>

        <div style="margin-top:12px">
          <label for="comment" style="font-weight:600;font-size:14px;display:block;margin-bottom:6px">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <textarea id="comment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Ç—Ä–µ—Å–∫–∞ 200 –≥ –∏ —Ä–∏—Å 150 –≥"></textarea>
          <div class="right"><span id="counter" class="meta">0/800</span></div>
        </div>

        <div class="grid2" style="margin-top:12px">
          <button id="btn-replace" class="btn btn-outline">–ó–∞–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
          <button id="btn-send" class="btn btn-primary" disabled><span class="icon" aria-hidden="true">‚úÖ</span> –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>

        <div class="info" style="margin-top:12px">
          –§–æ—Ç–æ –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω. EXIF-–¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª—è—é—Ç—Å—è –ø—Ä–∏ —Å–∂–∞—Ç–∏–∏.
        </div>
      </section>

      <!-- SENDING -->
      <section id="sec-sending" class="hidden">
        <div class="card pad">
          <div style="font-weight:600;margin-bottom:6px">–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É‚Ä¶</div>
          <div class="progress"><div id="bar" class="bar"></div></div>
          <div class="meta" style="margin-top:6px">–≠—Ç–æ –∏–º–∏—Ç–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞.</div>
          <div style="margin-top:12px"><button id="btn-cancel" class="btn btn-ghost">–û—Ç–º–µ–Ω–∞</button></div>
        </div>
      </section>

      <!-- SUCCESS -->
      <section id="sec-success" class="hidden">
        <div class="success">
          <span class="icon" aria-hidden="true">‚úÖ</span>
          <div>
            <div style="font-weight:600">–§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (–∑–∞–≥–ª—É—à–∫–∞)</div>
            <div class="meta">–í —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ –º—ã –Ω–∏—á–µ–≥–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º, –Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, –∫–∞–∫ –≤—ã–≥–ª—è–¥–µ–ª –±—ã –ø–æ—Ç–æ–∫.</div>
          </div>
        </div>
        <div class="grid2" style="margin-top:12px">
          <button id="btn-download" class="btn btn-outline">–°–∫–∞—á–∞—Ç—å payload.json</button>
          <button id="btn-new" class="btn btn-primary">–°–¥–µ–ª–∞—Ç—å –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ</button>
        </div>
      </section>

      <footer>–ú—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—ã —Ñ–æ—Ç–æ –±–µ–∑ –≤–∞—à–µ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è. –≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚Äî –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ç–æ—Ç–∏–ø.</footer>
    </main>

    <script>
      // ---- –ú–∏–Ω–∏-—Ö–µ–ª–ø–µ—Ä—ã/—Å–æ—Å—Ç–æ—è–Ω–∏–µ -----------------------------------------
      const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
      try { tg && tg.expand && tg.expand(); tg && tg.ready && tg.ready(); } catch(e){}

      const $ = (id) => document.getElementById(id);
      const secIdle = $('sec-idle'), secPrep = $('sec-preparing'), secPrev = $('sec-preview'),
            secSend = $('sec-sending'), secOk = $('sec-success'), errBox = $('error');

      const btnSystem = $('btn-system'), btnGallery = $('btn-gallery'),
            inSystem = $('file-system'), inGallery = $('file-gallery');

      const imgPrev = $('img-preview'), metaBox = $('meta'), ta = $('comment'),
            counter = $('counter'), btnReplace = $('btn-replace'), btnSend = $('btn-send'),
            btnCancel = $('btn-cancel'), bar = $('bar'), btnDownload = $('btn-download'), btnNew = $('btn-new');

      let phase = 'idle';           // idle | preparing | preview | sending | success
      let entryMethod = null;       // 'system' | 'gallery'
      let previewURL = null;        // ObjectURL
      let previewBlob = null;       // Blob
      let previewMeta = null;       // {width,height,type,size}
      const CHAR_LIMIT = 800;

      function setPhase(next){
        phase = next;
        secIdle.classList.toggle('hidden', next!=='idle');
        secPrep.classList.toggle('hidden', next!=='preparing');
        secPrev.classList.toggle('hidden', next!=='preview');
        secSend.classList.toggle('hidden', next!=='sending');
        secOk.classList.toggle('hidden', next!=='success');
      }
      function setError(msg){
        if(!msg){ errBox.classList.add('hidden'); errBox.textContent=''; return; }
        errBox.textContent = msg;
        errBox.classList.remove('hidden');
      }
      function haptic(type){ try { tg && tg.HapticFeedback && tg.HapticFeedback.impactOccurred(type || 'light'); } catch(e){} }
      function log(ev, payload){ try { console.log('[telemetry]', ev, payload||{}); } catch(e){} }

      // toBlob polyfill (—Å—Ç–∞—Ä—ã–µ WebKit)
      if(!HTMLCanvasElement.prototype.toBlob){
        HTMLCanvasElement.prototype.toBlob = function(callback, type, quality){
          const dataURL = this.toDataURL(type, quality).split(',')[1];
          const bin = atob(dataURL); const len = bin.length; const arr = new Uint8Array(len);
          for(let i=0;i<len;i++) arr[i] = bin.charCodeAt(i);
          callback(new Blob([arr], {type: type || 'image/png'}));
        }
      }

      // ---- –°–∏—Å—Ç–µ–º–Ω–∞—è –∫–∞–º–µ—Ä–∞ / –≥–∞–ª–µ—Ä–µ—è --------------------------------------
      btnSystem.addEventListener('click', () => { setError(null); entryMethod='system'; inSystem.click(); });
      btnGallery.addEventListener('click', () => { setError(null); entryMethod='gallery'; inGallery.click(); });

      inSystem.addEventListener('change', (e)=> handlePickedFile(e.target.files && e.target.files[0]));
      inGallery.addEventListener('change', (e)=> handlePickedFile(e.target.files && e.target.files[0]));

      btnReplace.addEventListener('click', () => {
        if(entryMethod==='system') inSystem.click(); else inGallery.click();
      });

      ta.addEventListener('input', () => {
        if(ta.value.length > CHAR_LIMIT) ta.value = ta.value.slice(0, CHAR_LIMIT);
        counter.textContent = ta.value.length + '/' + CHAR_LIMIT;
      });

      btnSend.addEventListener('click', startStubUpload);
      btnCancel.addEventListener('click', () => { setPhase('preview'); bar.style.width='0%'; });
      btnDownload.addEventListener('click', downloadPayload);
      btnNew.addEventListener('click', resetAll);

      window.addEventListener('beforeunload', () => { if(previewURL){ try{ URL.revokeObjectURL(previewURL); }catch(e){} } });

      // ---- Pipeline ---------------------------------------------------------
      async function handlePickedFile(file){
        if(!file) return;
        setError(null);
        setPhase('preparing');

        try{
          const loaded = await loadBitmap(file);

          const maxSide = 2000;
          const srcW = loaded.width, srcH = loaded.height;
          const scale = Math.min(1, maxSide / Math.max(srcW, srcH));
          const cw = Math.max(1, Math.round(srcW * scale));
          const ch = Math.max(1, Math.round(srcH * scale));

          const canvas = document.createElement('canvas');
          canvas.width = cw; canvas.height = ch;
          const ctx = canvas.getContext('2d');

          if(loaded.bitmap){
            ctx.drawImage(loaded.bitmap, 0, 0, cw, ch);
            try{ loaded.bitmap.close && loaded.bitmap.close(); }catch(e){}
          }else{
            ctx.drawImage(loaded.img, 0, 0, cw, ch);
            try{ URL.revokeObjectURL(loaded.url); }catch(e){}
          }

          const out = await compressFromCanvas(canvas);

          // cleanup previous
          if(previewURL){ try{ URL.revokeObjectURL(previewURL); }catch(e){} }

          previewURL = out.url;
          previewBlob = out.blob;
          previewMeta = { width: out.width, height: out.height, type: out.blob.type, size: out.blob.size };

          imgPrev.src = previewURL;
          metaBox.textContent = `${previewMeta.width}√ó${previewMeta.height} ‚Ä¢ ${Math.round(previewMeta.size/1024)} KB ‚Ä¢ ${previewMeta.type}`;
          btnSend.disabled = !previewBlob;

          setPhase('preview');
          log(entryMethod==='system' ? 'shot_taken_system' : 'image_selected_gallery', previewMeta);
        }catch(err){
          console.error(err);
          setError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (JPEG/PNG/HEIC/WEBP).');
          setPhase('idle');
        }
      }

      async function loadBitmap(file){
        // createImageBitmap —Å –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–µ–π (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è); –∏–Ω–∞—á–µ <img>
        if('createImageBitmap' in window){
          try{
            const bitmap = await createImageBitmap(file, { imageOrientation:'from-image' });
            return { bitmap, width: bitmap.width, height: bitmap.height };
          }catch(e1){
            try{
              const bitmap = await createImageBitmap(file);
              return { bitmap, width: bitmap.width, height: bitmap.height };
            }catch(e2){}
          }
        }
        const url = URL.createObjectURL(file);
        const img = await new Promise((resolve, reject)=>{
          const el = new Image();
          el.onload = ()=> resolve(el);
          el.onerror = (er)=> reject(er);
          el.src = url;
        });
        return { img, url, width: img.naturalWidth || img.width, height: img.naturalHeight || img.height };
      }

      async function compressFromCanvas(canvas){
        // downscale –µ—â—ë —Ä–∞–∑, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        const maxSide = 2000;
        const w = canvas.width, h = canvas.height;
        const scale = Math.min(1, maxSide / Math.max(w,h));
        let work = canvas;
        if(scale < 1){
          const cw = Math.max(1, Math.round(w * scale)), ch = Math.max(1, Math.round(h * scale));
          const tmp = document.createElement('canvas'); tmp.width=cw; tmp.height=ch;
          tmp.getContext('2d').drawImage(canvas, 0, 0, cw, ch);
          work = tmp;
        }
        let blob = await new Promise(res=> work.toBlob(res, 'image/webp', .85));
        if(!blob || blob.type !== 'image/webp'){
          blob = await new Promise(res=> work.toBlob(res, 'image/jpeg', .85));
        }
        const url = URL.createObjectURL(blob);
        return { blob, url, width: work.width, height: work.height };
      }

      // ---- Upload stub ------------------------------------------------------
      function startStubUpload(){
        setPhase('sending');
        bar.style.width='0%';
        haptic('light');
        log('send_clicked',{ hasPhoto: !!previewBlob, commentLen: (ta.value||'').length });
        const started = Date.now();
        const timer = setInterval(()=>{
          const cur = parseFloat(bar.style.width) || 0;
          const next = Math.min(100, cur + Math.random()*18 + 4);
          bar.style.width = next + '%';
          if(next >= 100){
            clearInterval(timer);
            haptic('light');
            setPhase('success');
            log('upload_success', { ms: Date.now()-started });
          }
        }, 180);
      }

      function downloadPayload(){
        const rid = (crypto && crypto.randomUUID) ? crypto.randomUUID() : ('rid-' + Date.now() + '-' + Math.random().toString(16).slice(2));
        const payload = {
          ok: true,
          request_id: rid,
          comment: ta.value || '',
          image: previewMeta,
          image_object_url: previewURL, // —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
          ts: new Date().toISOString()
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type:'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'payload_stub.json';
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }

      function resetAll(){
        setError(null);
        try{ if(previewURL) URL.revokeObjectURL(previewURL); }catch(e){}
        previewURL = null; previewBlob = null; previewMeta = null;
        ta.value = ''; counter.textContent = '0/800'; bar.style.width='0%';
        btnSend.disabled = true; entryMethod = null;
        setPhase('idle');
      }

      // ---- –°—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ---------------------------------------------
      setPhase('idle');
      counter.textContent = '0/800';
    </script>
  </body>
</html>
