<!doctype html>
<html lang="ru">
  <head>
    <!-- ===================== BLOCK: head / meta ===================== -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>FoodCam ‚Äî –æ–¥–Ω–∞ –∫–∞–º–µ—Ä–∞ —Å —É—Ä–æ–≤–Ω–µ–º (live)</title>
    <meta name="theme-color" content="#0a7cff" />
    <style>
      /* ===================== BLOCK: styles ===================== */
      :root{
        --bg:#ffffff; --text:#111827; --muted:#6b7280; --ring:#e5e7eb; --primary:#2563eb;
        --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0;background:var(--bg);color:var(--text);
        font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
        -webkit-font-smoothing:antialiased;-webkit-tap-highlight-color:transparent;
      }
      .container{max-width:720px;margin:0 auto;padding:16px}
      h1{font-size:22px;margin:0 0 6px}
      .muted{color:var(--muted);font-size:14px;margin:0 0 16px}
      .hidden{display:none!important}

      /* Buttons */
      .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;
           border-radius:14px;border:1px solid var(--ring);background:#fff;font-weight:600;cursor:pointer}
      .btn.primary{background:var(--primary);color:#fff;border-color:transparent}
      .btn.ghost{background:transparent}
      .btn:active{transform:scale(.98)}
      .row{display:flex;gap:10px;flex-wrap:wrap}

      /* ===================== BLOCK: camera (frame) ===================== */
      .cam-wrap{
        position:relative;border:1px solid var(--ring);border-radius:16px;overflow:hidden;background:#000;
        aspect-ratio:3/4; /* –º–æ–±–∏–ª—å–Ω—ã–π –ø–æ—Ä—Ç—Ä–µ—Ç */
      }
      .cam-video{width:100%;height:100%;object-fit:cover;display:block}
      .cam-overlay{
        position:absolute;inset:0;pointer-events:none;
      }
      /* –†–∞–º–∫–∞/—Å–µ—Ç–∫–∞ 3√ó3 */
      .grid{
        position:absolute;inset:0;opacity:.25;mix-blend-mode:screen;
        background:
          linear-gradient(#fff 1px, transparent 1px) 0 calc(33.333% - .5px)/100% 33.333% repeat-y,
          linear-gradient(#fff 1px, transparent 1px) 0 calc(66.666% - .5px)/100% 33.333% repeat-y,
          linear-gradient(90deg, #fff 1px, transparent 1px) calc(33.333% - .5px) 0/33.333% 100% repeat-x,
          linear-gradient(90deg, #fff 1px, transparent 1px) calc(66.666% - .5px) 0/33.333% 100% repeat-x;
      }
      /* ===================== BLOCK: level (overlay) ===================== */
      .level{
        position:absolute;left:12px;top:12px;width:120px;height:120px;border-radius:16px;
        background:rgba(17,24,39,.35);backdrop-filter:blur(3px);border:1px solid rgba(255,255,255,.25);
        display:grid;place-items:center;pointer-events:none;color:#fff;
      }
      .level-ring{
        position:relative;width:84px;height:84px;border-radius:999px;border:2px solid rgba(255,255,255,.45);
        box-shadow:inset 0 0 0 2px rgba(255,255,255,.15);
      }
      .level-bubble{
        position:absolute;left:50%;top:50%;width:22px;height:22px;border-radius:999px;
        transform:translate(-50%,-50%);background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.35);
        transition:transform 80ms linear;
      }
      .level-text{margin-top:8px;text-align:center;font-size:12px;color:#e5e7eb}
      .level-dot{display:inline-block;width:8px;height:8px;border-radius:999px;background:#d1d5db;margin-right:6px}
      .level-dot.ok{background:var(--ok)} .level-dot.warn{background:var(--warn)} .level-dot.bad{background:#d1d5db}
      .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Consolas,monospace}

      /* ===================== BLOCK: camera-controls ===================== */
      .controls{
        position:absolute;left:0;right:0;bottom:0;padding:10px;display:flex;gap:10px;align-items:center;justify-content:space-between;
        background:linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,0));
        color:#fff
      }
      .ctrl-left,.ctrl-right{display:flex;gap:8px;align-items:center}
      .shutter{
        width:68px;height:68px;border-radius:999px;border:4px solid rgba(255,255,255,.9);background:#fff;cursor:pointer;
        box-shadow:0 2px 12px rgba(0,0,0,.4)
      }
      .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2)}
      .range{appearance:none;width:140px;height:4px;border-radius:99px;background:rgba(255,255,255,.25);outline:none}
      .range::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:#fff;border:2px solid rgba(0,0,0,.15)}
      .badge{font-size:12px;color:#cbd5e1}

      /* ===================== BLOCK: preview ===================== */
      .card{border:1px solid var(--ring);border-radius:16px;background:#fff}
      .pad{padding:14px}
      .preview-img{width:100%;max-height:70vh;object-fit:contain;border-radius:12px}
      .meta{color:var(--muted);font-size:12px;margin-top:6px}
      .error{background:#fef2f2;color:#b91c1c;border:1px solid #fecaca;border-radius:12px;padding:12px;margin:12px 0}
    </style>
  </head>
  <body>
    <main class="container">
      <header>
        <h1>–û–¥–Ω–∞ –∫–∞–º–µ—Ä–∞ —Å —É—Ä–æ–≤–Ω–µ–º (live)</h1>
        <p class="muted">–ù–∞–∂–º–∏—Ç–µ ¬´–û—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É¬ª, –¥–µ—Ä–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω <b>–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏</b>, –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–π—Ç–µ—Å—å –ø–æ —É—Ä–æ–≤–Ω—é. –ü–æ—Ç–æ–º —Å–¥–µ–ª–∞–π—Ç–µ —Å–Ω–∏–º–æ–∫.</p>
      </header>

      <div id="err" class="error hidden"></div>

      <!-- ===================== BLOCK: camera ===================== -->
      <section id="sec-camera">
        <div class="row" style="margin-bottom:10px">
          <button id="btnOpen" class="btn primary">–û—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É</button>
          <button id="btnStop" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
          <span id="permHint" class="badge">iOS: —Ä–∞–∑—Ä–µ—à–∏—Ç–µ ¬´–û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é –∏ –¥–≤–∏–∂–µ–Ω–∏–µ¬ª</span>
        </div>

        <div class="cam-wrap" id="camWrap" aria-label="–ñ–∏–≤–æ–µ –ø—Ä–µ–≤—å—é –∫–∞–º–µ—Ä—ã">
          <video id="video" class="cam-video" playsinline muted></video>

          <!-- ===================== BLOCK: level (overlay) ===================== -->
          <div class="cam-overlay">
            <div class="grid"></div>

            <aside class="level" id="levelBox" aria-label="–£—Ä–æ–≤–µ–Ω—å –Ω–∞–∫–ª–æ–Ω–∞">
              <div class="level-ring">
                <div id="bubble" class="level-bubble"></div>
              </div>
              <div class="level-text">
                <span id="dot" class="level-dot bad"></span>
                <span class="mono" id="tiltTxt">‚Äî.‚Äì¬∞</span>
              </div>
            </aside>
          </div>

          <!-- ===================== BLOCK: camera-controls ===================== -->
          <div class="controls">
            <div class="ctrl-left">
              <button id="btnTorch" class="chip hidden">üî¶ –§–æ–Ω–∞—Ä—å</button>
              <div id="zoomWrap" class="chip hidden">
                üîç
                <input id="zoom" class="range" type="range" min="1" max="1" step="0.01" value="1" />
              </div>
            </div>
            <button id="btnShot" class="shutter" aria-label="–°–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫"></button>
            <div class="ctrl-right">
              <span id="hint" class="badge">–ù–∞–≤–µ–¥–∏—Ç–µ —Å–≤–µ—Ä—Ö—É</span>
            </div>
          </div>
        </div>
      </section>

      <!-- ===================== BLOCK: preview ===================== -->
      <section id="sec-preview" class="hidden" style="margin-top:12px">
        <div class="card pad">
          <img id="photo" class="preview-img" alt="–°–Ω–∏–º–æ–∫" />
          <div id="meta" class="meta"></div>
          <div class="row" style="margin-top:10px">
            <button id="btnRetake" class="btn">–ü–µ—Ä–µ—Å–Ω—è—Ç—å</button>
            <button id="btnSave" class="btn primary">–°–∫–∞—á–∞—Ç—å —Å–Ω–∏–º–æ–∫</button>
          </div>
        </div>
      </section>
    </main>

    <script>
      // ===================== BLOCK: config/state =====================
      const CONFIG = {
        idealFacing: { facingMode: { ideal: "environment" } },
        maxSide: 2000,                 // —Ä–µ—Å–∞–π–∑ –ø–æ –±–æ–ª—å—à–µ–π —Å—Ç–æ—Ä–æ–Ω–µ
        levelThreshold: 5,             // ¬∞ –∑–µ–ª—ë–Ω–∞—è –∑–æ–Ω–∞
        stableMs: 0,                   // –∞–≤—Ç–æ—Å–ø—É—Å–∫ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º (0 = –≤—ã–∫–ª)
      };

      const S = {
        stream: null,
        track: null,
        zoomCap: null,
        torchCap: false,
        levelOn: false,
        lastTilt: 999,
        stableStart: 0,
      };

      // ===================== BLOCK: dom refs =====================
      const $ = (id) => document.getElementById(id);
      const err = $('err');
      const video = $('video');
      const btnOpen = $('btnOpen');
      const btnStop = $('btnStop');
      const btnTorch = $('btnTorch');
      const zoomWrap = $('zoomWrap');
      const zoom = $('zoom');
      const btnShot = $('btnShot');
      const hint = $('hint');
      const permHint = $('permHint');

      const bubble = $('bubble');
      const tiltTxt = $('tiltTxt');
      const dot = $('dot');

      const secCam = $('sec-camera');
      const secPrev = $('sec-preview');
      const photo = $('photo');
      const meta = $('meta');
      const btnRetake = $('btnRetake');
      const btnSave = $('btnSave');

      // ===================== BLOCK: utils =====================
      function setError(msg){
        if(!msg){ err.classList.add('hidden'); err.textContent=''; return; }
        err.textContent = msg; err.classList.remove('hidden');
      }
      function clamp(v, a, b){ return Math.min(b, Math.max(a, v)); }
      function haptic(){ try{ window.Telegram?.WebApp?.HapticFeedback?.impactOccurred?.("light"); }catch(e){} }

      function showPreview(dataUrl, w, h){
        photo.src = dataUrl;
        meta.textContent = `${w}√ó${h}`;
        secCam.classList.add('hidden');
        secPrev.classList.remove('hidden');
      }

      function backToCamera(){
        secPrev.classList.add('hidden');
        secCam.classList.remove('hidden');
      }

      // ===================== BLOCK: camera open/close =====================
      async function openCamera(){
        setError('');
        try{
          // 1) –ü—Ä–∞–≤–∞ –Ω–∞ –¥–∞—Ç—á–∏–∫–∏ (iOS —Ç—Ä–µ–±—É–µ—Ç —è–≤–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∏–∑ –∂–µ—Å—Ç–∞)
          await enableLevelSensors();

          // 2) –û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞–º–µ—Ä—É –ø–æ facingMode
          const s = await navigator.mediaDevices.getUserMedia({ video: CONFIG.idealFacing, audio: false });
          await bindStream(s);

          // 3) –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Ä–µ–∞–ª—å–Ω—É—é –∑–∞–¥–Ω—é—é –ø–æ label –∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è
          const rearId = await findRearDeviceId();
          if(rearId){
            // –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π track –Ω–µ rear ‚Äî –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º —Å—Ç—Ä–∏–º
            if (!/back|rear|environment/i.test(S.track?.label || '')) {
              try{
                const s2 = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: rearId } }, audio:false });
                await bindStream(s2);
              }catch(e){}
            }
          }
        }catch(e){
          console.error(e);
          setError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏ HTTPS.');
        }
      }

      async function bindStream(stream){
        // –û—Å—Ç–∞–Ω–æ–≤–∏–º –ø—Ä–æ—à–ª—ã–π
        stopCamera();

        S.stream = stream;
        S.track = stream.getVideoTracks()[0];

        // –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
        const caps = S.track.getCapabilities?.() || {};
        // Torch
        S.torchCap = !!caps.torch;
        btnTorch.classList.toggle('hidden', !S.torchCap);
        // Zoom
        if (typeof caps.zoom === 'number' || (caps.zoom && (caps.zoom.min||caps.zoom.max))) {
          S.zoomCap = {
            min: caps.zoom.min ?? 1,
            max: caps.zoom.max ?? Math.max(1, caps.zoom),
            step: caps.zoom.step ?? 0.01
          };
          zoom.min = S.zoomCap.min; zoom.max = S.zoomCap.max; zoom.step = S.zoomCap.step; zoom.value = caps.zoom.min ?? 1;
          zoomWrap.classList.remove('hidden');
        } else {
          S.zoomCap = null;
          zoomWrap.classList.add('hidden');
        }

        video.srcObject = stream;
        await video.play();
      }

      function stopCamera(){
        try{
          video.pause();
          if (S.track) { try{ S.track.stop(); }catch(e){} }
          if (S.stream) {
            S.stream.getTracks().forEach(t=>{ try{ t.stop(); }catch(e){} });
          }
        }catch(e){}
        S.stream = null; S.track = null;
      }

      async function findRearDeviceId(){
        try{
          const list = await navigator.mediaDevices.enumerateDevices();
          const videoInputs = list.filter(d=>d.kind==='videoinput');
          const rear = videoInputs.find(d=>/back|rear|environment/i.test(d.label));
          return rear?.deviceId || null;
        }catch(e){ return null; }
      }

      // ===================== BLOCK: camera actions (torch/zoom/shot) =====================
      async function toggleTorch(){
        if(!S.track || !S.torchCap) return;
        try{
          const cur = S._torchOn = !S._torchOn;
          await S.track.applyConstraints({ advanced: [{ torch: cur }] });
          btnTorch.textContent = cur ? 'üî¶ –§–æ–Ω–∞—Ä—å (–≤–∫–ª.)' : 'üî¶ –§–æ–Ω–∞—Ä—å';
        }catch(e){
          btnTorch.classList.add('hidden');
        }
      }

      async function applyZoom(val){
        if(!S.track || !S.zoomCap) return;
        try{
          await S.track.applyConstraints({ advanced: [{ zoom: parseFloat(val) }] });
        }catch(e){}
      }

      async function takeShot(){
        if(!video.videoWidth || !video.videoHeight) return;
        haptic();

        // –†–∏—Å—É–µ–º –∫–∞–¥—Ä –Ω–∞ canvas, —Ä–µ—Å–∞–π–∑ –¥–æ maxSide
        const srcW = video.videoWidth, srcH = video.videoHeight;
        const scale = Math.min(1, CONFIG.maxSide / Math.max(srcW, srcH));
        const w = Math.max(1, Math.round(srcW * scale));
        const h = Math.max(1, Math.round(srcH * scale));

        const c = document.createElement('canvas');
        c.width = w; c.height = h;
        const ctx = c.getContext('2d');
        ctx.drawImage(video, 0, 0, w, h);

        // webp ‚Üí jpeg fallback
        let dataUrl = c.toDataURL('image/webp', 0.85);
        if (!/^data:image\/webp/.test(dataUrl)) {
          dataUrl = c.toDataURL('image/jpeg', 0.85);
        }
        showPreview(dataUrl, w, h);
      }

      // ===================== BLOCK: level sensors =====================
      async function enableLevelSensors(){
        // –£–∂–µ –≤–∫–ª—é—á–∞–ª–∏
        if (S.levelOn) return;
        let granted = false;

        try{
          // iOS 13+ –ø–µ—Ä–º–∏—à–µ–Ω
          if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            const p = await DeviceOrientationEvent.requestPermission();
            if (p === 'granted') {
              window.addEventListener('deviceorientation', onOrientation, true);
              granted = true;
            }
          }
          // Android/–¥—Ä—É–≥–∏–µ
          if (!granted && 'ondeviceorientation' in window) {
            window.addEventListener('deviceorientation', onOrientation, true);
            granted = true;
          }
          // Fallback —á–µ—Ä–µ–∑ devicemotion (–º–µ–Ω–µ–µ —Ç–æ—á–Ω–æ)
          if (!granted) {
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
              const p2 = await DeviceMotionEvent.requestPermission();
              if (p2 === 'granted') {
                window.addEventListener('devicemotion', onMotion, true);
                granted = true;
              }
            } else if ('ondevicemotion' in window) {
              window.addEventListener('devicemotion', onMotion, true);
              granted = true;
            }
          }
        }catch(e){}

        S.levelOn = granted;
        permHint.classList.toggle('hidden', granted);
      }

      function onOrientation(e){
        const pitch = e.beta ?? 0;  // -180..180 (–≤–ø–µ—Ä—ë–¥/–Ω–∞–∑–∞–¥)
        const roll  = e.gamma ?? 0; // -90..90  (–≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ)
        const tilt  = Math.sqrt(pitch*pitch + roll*roll);
        paintLevel(pitch, roll, tilt);
      }
      function onMotion(e){
        const a = e.accelerationIncludingGravity || {};
        const x = a.x||0, y=a.y||0, z=a.z||0;
        const g = Math.hypot(x,y,z)||9.81;
        const tilt = Math.acos(Math.min(1, Math.abs(z)/g))*180/Math.PI;
        // –ì—Ä—É–±–∞—è –æ—Ü–µ–Ω–∫–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
        const pitch = (Math.atan2(-x, Math.sqrt(y*y+z*z))*180/Math.PI)||0;
        const roll  = (Math.atan2(y, z)*180/Math.PI)||0;
        paintLevel(pitch, roll, tilt);
      }

      function paintLevel(pitch, roll, tilt){
        // –°–º–µ—â–µ–Ω–∏–µ –ø—É–∑—ã—Ä—å–∫–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –∫–æ–ª—å—Ü–∞ (—Ä–∞–¥–∏—É—Å ~ 30px)
        const R = 30;
        const nx = clamp(roll/30, -1, 1);
        const ny = clamp(pitch/30, -1, 1);
        bubble.style.transform = `translate(calc(-50% + ${nx*R}px), calc(-50% + ${-ny*R}px))`;

        tiltTxt.textContent = `${tilt.toFixed(1)}¬∞`;

        dot.classList.remove('ok','warn','bad');
        if (tilt <= CONFIG.levelThreshold) { dot.classList.add('ok'); hint.textContent = '–†–æ–≤–Ω–æ'; }
        else if (tilt <= CONFIG.levelThreshold*2) { dot.classList.add('warn'); hint.textContent = '–í—ã—Ä–∞–≤–Ω–∏–≤–∞–π—Ç–µ‚Ä¶'; }
        else { dot.classList.add('bad'); hint.textContent = '–ù–∞–≤–µ–¥–∏—Ç–µ —Å–≤–µ—Ä—Ö—É'; }

        // –ê–≤—Ç–æ—Å–ø—É—Å–∫ (–µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω)
        const t = performance.now();
        if (CONFIG.stableMs > 0) {
          if (tilt <= CONFIG.levelThreshold) {
            if (S.stableStart === 0) S.stableStart = t;
            if (t - S.stableStart >= CONFIG.stableMs) {
              S.stableStart = 0;
              takeShot();
            }
          } else {
            S.stableStart = 0;
          }
        }
      }

      // ===================== BLOCK: wiring =====================
      btnOpen.addEventListener('click', openCamera);
      btnStop.addEventListener('click', () => { stopCamera(); });
      btnTorch.addEventListener('click', toggleTorch);
      zoom.addEventListener('input', (e)=> applyZoom(e.target.value));
      btnShot.addEventListener('click', takeShot);

      btnRetake.addEventListener('click', () => { backToCamera(); });
      btnSave.addEventListener('click', () => {
        // –°–∫–∞—á–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ <img src=dataURL>
        const url = photo.src;
        const a = document.createElement('a');
        a.href = url; a.download = 'photo.jpg';
        document.body.appendChild(a); a.click(); a.remove();
      });

      window.addEventListener('pagehide', stopCamera);
      window.addEventListener('beforeunload', stopCamera);

      // ===================== NOTE =====================
      // –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ HTTPS –∏–ª–∏ localhost. –í Telegram WebView –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã.
      // –ï—Å–ª–∏ –∫–∞–º–µ—Ä–∞ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –∫–∞–º–µ—Ä—É/–¥–≤–∏–∂–µ–Ω–∏–µ-–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é (iOS: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ > Safari/Telegram > Motion & Orientation).
    </script>
  </body>
</html>
