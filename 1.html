<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>FoodCam ‚Äî –∏—Ç–æ–≥–æ–≤—ã–π –ø—Ä–æ—Ç–æ—Ç–∏–ø (—Å–∏—Å—Ç–µ–º–Ω–∞—è –∫–∞–º–µ—Ä–∞ + –≥–∞–ª–µ—Ä–µ—è)</title>
    <meta name="theme-color" content="#0a7cff" />
    <style>
      :root{
        --bg:#ffffff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --ring:#e5e7eb;
        --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444;
      }
      *{box-sizing:border-box} html,body{height:100%}
      body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;-webkit-font-smoothing:antialiased}
      .container{max-width:720px;margin:0 auto;padding:20px}
      h1{font-size:22px;margin:0 0 6px}
      .muted{color:var(--muted);font-size:14px;margin:0 0 16px}
      .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
      .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:16px;border:1px solid transparent;background:#fff;color:#111827;font-weight:600;cursor:pointer;box-shadow:0 1px 2px rgba(0,0,0,.05);transition:.15s transform}
      .btn:active{transform:scale(.98)}
      .btn.primary{background:var(--primary);color:#fff}
      .btn.outline{background:#fff;border-color:var(--ring)}
      .btn.ghost{background:transparent;border-color:var(--ring)}
      .hidden{display:none !important}
      .card{border:1px solid var(--ring);border-radius:16px;background:#fff}
      .pad{padding:16px}
      .info{background:#f9fafb;color:var(--muted);border-radius:16px;padding:12px}
      .error{background:#fef2f2;color:#b91c1c;border:1px solid #fecaca;border-radius:12px;padding:12px;margin:12px 0}
      .success{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0;border-radius:12px;padding:12px;display:flex;gap:12px;align-items:center}
      .meta{color:var(--muted);font-size:12px;margin-top:6px}
      .preview-img{max-height:360px;width:100%;object-fit:contain;display:block;border-radius:16px}
      textarea{width:100%;min-height:112px;padding:12px;border-radius:16px;border:1px solid var(--ring);resize:none;font-size:14px}
      .right{display:flex;justify-content:flex-end}
      .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
      .progress{height:12px;background:#f3f4f6;border-radius:999px;overflow:hidden}
      .bar{height:100%;background:var(--primary);width:0%}
      footer{margin-top:24px;text-align:center;color:var(--muted);font-size:12px}
      .icon{width:20px;height:20px;display:inline-block;vertical-align:middle}
      .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
      /* –ú–∏–Ω–∏-—É—Ä–æ–≤–Ω–µ–º–µ—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) */
      .level-pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--ring);background:#fff;font-size:12px;color:var(--muted)}
      .dot{width:10px;height:10px;border-radius:999px;background:#d1d5db}
      .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)}
    </style>
  </head>
  <body>
    <main class="container">
      <header>
        <h1>–°–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∫–∞–º–µ—Ä–æ–π –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏</h1>
        <p class="muted">–ò—Å–ø–æ–ª—å–∑—É–µ–º <b>—Ç–æ–ª—å–∫–æ —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–∞–º–µ—Ä—É</b> (rear), –±–µ–∑ –∂–∏–≤–æ–≥–æ –ø—Ä–µ–≤—å—é. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ‚Äî –ø–æ –∂–µ–ª–∞–Ω–∏—é.</p>
      </header>

      <div id="error" class="error hidden"></div>

      <!-- IDLE -->
      <section id="sec-idle">
        <div class="row">
          <button id="btn-system" class="btn primary" aria-label="–û—Ç–∫—Ä—ã—Ç—å —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–∞–º–µ—Ä—É (rear)">
            <span class="icon" aria-hidden="true">üì∑</span> –°–∏—Å—Ç–µ–º–Ω–∞—è –∫–∞–º–µ—Ä–∞
          </button>
          <button id="btn-gallery" class="btn outline" aria-label="–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏">
            <span class="icon" aria-hidden="true">üñºÔ∏è</span> –ì–∞–ª–µ—Ä–µ—è
          </button>
        </div>

        <div class="info" style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <span><span class="icon" aria-hidden="true">üí°</span> –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ ¬´–°–∏—Å—Ç–µ–º–Ω–∞—è –∫–∞–º–µ—Ä–∞¬ª –æ—Ç–∫—Ä–æ–µ—Ç –≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞.</span>
          <span class="level-pill">
            <span id="dot" class="dot" aria-hidden="true"></span>
            <span id="lvlText">–£—Ä–æ–≤–Ω–µ–º–µ—Ä –≤—ã–∫–ª.</span>
            <button id="btn-level" class="btn ghost" style="padding:6px 8px;font-size:12px">–í–∫–ª—é—á–∏—Ç—å</button>
          </span>
        </div>

        <!-- Hidden inputs -->
        <input id="file-gallery" type="file" accept="image/*" class="hidden" />
        <input id="file-system" type="file" accept="image/*" capture="environment" class="hidden" />
      </section>

      <!-- PREPARING -->
      <section id="sec-preparing" class="hidden">
        <div class="card pad" style="text-align:center">
          <div style="font-weight:600;margin-bottom:6px">–ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ—Ç–æ‚Ä¶</div>
          <div class="muted">–°–∂–∏–º–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é</div>
        </div>
      </section>

      <!-- PREVIEW -->
      <section id="sec-preview" class="hidden">
        <div class="card">
          <img id="img-preview" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ" class="preview-img" />
        </div>
        <div id="meta" class="meta"></div>

        <div style="margin-top:12px">
          <label for="comment" style="font-weight:600;font-size:14px;display:block;margin-bottom:6px">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <textarea id="comment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Ç—Ä–µ—Å–∫–∞ 200 –≥ –∏ —Ä–∏—Å 150 –≥"></textarea>
          <div class="right"><span id="counter" class="meta">0/800</span></div>
        </div>

        <div class="grid2" style="margin-top:12px">
          <button id="btn-replace" class="btn outline">–ó–∞–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
          <button id="btn-send" class="btn primary" disabled><span class="icon" aria-hidden="true">‚úÖ</span> –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>

        <div class="info" style="margin-top:12px">
          –§–æ—Ç–æ –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω. EXIF-–¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª—è—é—Ç—Å—è –ø—Ä–∏ —Å–∂–∞—Ç–∏–∏.
        </div>
      </section>

      <!-- SENDING -->
      <section id="sec-sending" class="hidden">
        <div class="card pad">
          <div style="font-weight:600;margin-bottom:6px">–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É‚Ä¶</div>
          <div class="progress"><div id="bar" class="bar"></div></div>
          <div class="meta" style="margin-top:6px">–≠—Ç–æ –∏–º–∏—Ç–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞.</div>
          <div style="margin-top:12px"><button id="btn-cancel" class="btn ghost">–û—Ç–º–µ–Ω–∞</button></div>
        </div>
      </section>

      <!-- SUCCESS -->
      <section id="sec-success" class="hidden">
        <div class="success">
          <span class="icon" aria-hidden="true">‚úÖ</span>
          <div>
            <div style="font-weight:600">–§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (–∑–∞–≥–ª—É—à–∫–∞)</div>
            <div class="meta">–ù–∏—á–µ–≥–æ –Ω–µ —É—Ö–æ–¥–∏—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä ‚Äî —ç—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø–æ—Ç–æ–∫–∞.</div>
          </div>
        </div>
        <div class="grid2" style="margin-top:12px">
          <button id="btn-download" class="btn outline">–°–∫–∞—á–∞—Ç—å payload.json</button>
          <button id="btn-new" class="btn primary">–°–¥–µ–ª–∞—Ç—å –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ</button>
        </div>
      </section>

      <footer>–ú—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—ã —Ñ–æ—Ç–æ –±–µ–∑ –≤–∞—à–µ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è. –≠—Ç–æ <b>–∏—Ç–æ–≥–æ–≤—ã–π –æ–¥–Ω–æ—Ñ–∞–π–ª–æ–≤—ã–π</b> –ø—Ä–æ—Ç–æ—Ç–∏–ø.</footer>
    </main>

    <script>
      // ====== –¢–µ–ª–µ–≥—Ä–∞–º-–≤–µ–±–≤—å—é (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) ======
      const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
      try { tg?.expand?.(); tg?.ready?.(); } catch(e){}

      // ====== DOM ======
      const $ = (id) => document.getElementById(id);
      const secIdle = $('sec-idle'), secPrep = $('sec-preparing'), secPrev = $('sec-preview'),
            secSend = $('sec-sending'), secOk = $('sec-success'), errBox = $('error');

      const btnSystem = $('btn-system'), btnGallery = $('btn-gallery'),
            inSystem = $('file-system'), inGallery = $('file-gallery');

      const imgPrev = $('img-preview'), metaBox = $('meta'), ta = $('comment'),
            counter = $('counter'), btnReplace = $('btn-replace'), btnSend = $('btn-send'),
            btnCancel = $('btn-cancel'), bar = $('bar'), btnDownload = $('btn-download'), btnNew = $('btn-new');

      // –£—Ä–æ–≤–Ω–µ–º–µ—Ä
      const btnLevel = $('btn-level'), dot = $('dot'), lvlText = $('lvlText');

      // ====== State ======
      let phase = 'idle';           // idle | preparing | preview | sending | success
      let entryMethod = null;       // 'system' | 'gallery'
      let previewURL = null;        // ObjectURL
      let previewBlob = null;       // Blob
      let previewMeta = null;       // {width,height,type,size}
      const CHAR_LIMIT = 800;

      function setPhase(next){
        phase = next;
        secIdle.classList.toggle('hidden', next!=='idle');
        secPrep.classList.toggle('hidden', next!=='preparing');
        secPrev.classList.toggle('hidden', next!=='preview');
        secSend.classList.toggle('hidden', next!=='sending');
        secOk.classList.toggle('hidden', next!=='success');
      }
      function setError(msg){
        if(!msg){ errBox.classList.add('hidden'); errBox.textContent=''; return; }
        errBox.textContent = msg;
        errBox.classList.remove('hidden');
      }
      function haptic(type){ try { tg?.HapticFeedback?.impactOccurred?.(type || 'light'); } catch(e){} }
      function log(ev, payload){ try { console.log('[telemetry]', ev, payload||{}); } catch(e){} }

      // toBlob polyfill (—Å—Ç–∞—Ä—ã–µ WebKit)
      if(!HTMLCanvasElement.prototype.toBlob){
        HTMLCanvasElement.prototype.toBlob = function(cb, type, quality){
          const dataURL = this.toDataURL(type, quality).split(',')[1];
          const bin = atob(dataURL); const len = bin.length; const arr = new Uint8Array(len);
          for(let i=0;i<len;i++) arr[i] = bin.charCodeAt(i);
          cb(new Blob([arr], {type: type || 'image/png'}));
        }
      }

      // ====== Entry buttons ======
      btnSystem.addEventListener('click', () => { setError(null); entryMethod='system'; inSystem.click(); });
      btnGallery.addEventListener('click', () => { setError(null); entryMethod='gallery'; inGallery.click(); });

      inSystem.addEventListener('change', (e)=> handlePickedFile(e.target.files && e.target.files[0]));
      inGallery.addEventListener('change', (e)=> handlePickedFile(e.target.files && e.target.files[0]));

      btnReplace.addEventListener('click', () => {
        if(entryMethod==='system') inSystem.click(); else inGallery.click();
      });

      ta.addEventListener('input', () => {
        if(ta.value.length > CHAR_LIMIT) ta.value = ta.value.slice(0, CHAR_LIMIT);
        counter.textContent = ta.value.length + '/' + CHAR_LIMIT;
      });

      btnSend.addEventListener('click', startStubUpload);
      btnCancel?.addEventListener('click', () => { setPhase('preview'); bar.style.width='0%'; });
      btnDownload?.addEventListener('click', downloadPayload);
      btnNew?.addEventListener('click', resetAll);

      window.addEventListener('beforeunload', () => { if(previewURL){ try{ URL.revokeObjectURL(previewURL); }catch(e){} } });

      // ====== Pipeline ======
      async function handlePickedFile(file){
        if(!file) return;
        setError(null);
        setPhase('preparing');

        try{
          const loaded = await loadBitmap(file);

          const maxSide = 2000;
          const srcW = loaded.width, srcH = loaded.height;
          const scale = Math.min(1, maxSide / Math.max(srcW, srcH));
          const cw = Math.max(1, Math.round(srcW * scale));
          const ch = Math.max(1, Math.round(srcH * scale));

          const canvas = document.createElement('canvas');
          canvas.width = cw; canvas.height = ch;
          const ctx = canvas.getContext('2d');

          if(loaded.bitmap){
            ctx.drawImage(loaded.bitmap, 0, 0, cw, ch);
            try{ loaded.bitmap.close && loaded.bitmap.close(); }catch(e){}
          }else{
            ctx.drawImage(loaded.img, 0, 0, cw, ch);
            try{ URL.revokeObjectURL(loaded.url); }catch(e){}
          }

          const out = await compressFromCanvas(canvas);

          if(previewURL){ try{ URL.revokeObjectURL(previewURL); }catch(e){} }
          previewURL = out.url;
          previewBlob = out.blob;
          previewMeta = { width: out.width, height: out.height, type: out.blob.type, size: out.blob.size };

          imgPrev.src = previewURL;
          metaBox.textContent = `${previewMeta.width}√ó${previewMeta.height} ‚Ä¢ ${Math.round(previewMeta.size/1024)} KB ‚Ä¢ ${previewMeta.type}`;
          btnSend.disabled = !previewBlob;

          setPhase('preview');
          log(entryMethod==='system' ? 'shot_taken_system' : 'image_selected_gallery', previewMeta);
        }catch(err){
          console.error(err);
          setError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (JPEG/PNG/HEIC/WEBP).');
          setPhase('idle');
        }
      }

      async function loadBitmap(file){
        if('createImageBitmap' in window){
          try{
            const bitmap = await createImageBitmap(file, { imageOrientation:'from-image' });
            return { bitmap, width: bitmap.width, height: bitmap.height };
          }catch(e1){
            try{
              const bitmap = await createImageBitmap(file);
              return { bitmap, width: bitmap.width, height: bitmap.height };
            }catch(e2){}
          }
        }
        const url = URL.createObjectURL(file);
        const img = await new Promise((resolve, reject)=>{
          const el = new Image();
          el.onload = ()=> resolve(el);
          el.onerror = (er)=> reject(er);
          el.src = url;
        });
        return { img, url, width: img.naturalWidth || img.width, height: img.naturalHeight || img.height };
      }

      async function compressFromCanvas(canvas){
        const maxSide = 2000;
        const w = canvas.width, h = canvas.height;
        const scale = Math.min(1, maxSide / Math.max(w,h));
        let work = canvas;
        if(scale < 1){
          const cw = Math.max(1, Math.round(w * scale)), ch = Math.max(1, Math.round(h * scale));
          const tmp = document.createElement('canvas'); tmp.width=cw; tmp.height=ch;
          tmp.getContext('2d').drawImage(canvas, 0, 0, cw, ch);
          work = tmp;
        }
        let blob = await new Promise(res=> work.toBlob(res, 'image/webp', .85));
        if(!blob || blob.type !== 'image/webp'){
          blob = await new Promise(res=> work.toBlob(res, 'image/jpeg', .85));
        }
        const url = URL.createObjectURL(blob);
        return { blob, url, width: work.width, height: work.height };
      }

      // ====== Upload stub ======
      function startStubUpload(){
        setPhase('sending'); bar.style.width='0%'; haptic('light');
        log('send_clicked',{ hasPhoto: !!previewBlob, commentLen: (ta.value||'').length });
        const started = Date.now();
        const timer = setInterval(()=>{
          const cur = parseFloat(bar.style.width) || 0;
          const next = Math.min(100, cur + Math.random()*18 + 4);
          bar.style.width = next + '%';
          if(next >= 100){
            clearInterval(timer);
            haptic('light');
            setPhase('success');
            log('upload_success', { ms: Date.now()-started });
          }
        }, 180);
      }

      function downloadPayload(){
        const rid = (crypto && crypto.randomUUID) ? crypto.randomUUID() : ('rid-' + Date.now() + '-' + Math.random().toString(16).slice(2));
        const payload = {
          ok: true,
          request_id: rid,
          comment: ta.value || '',
          image: previewMeta,
          image_object_url: previewURL, // —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
          ts: new Date().toISOString()
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type:'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'payload_stub.json';
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }

      function resetAll(){
        setError(null);
        try{ if(previewURL) URL.revokeObjectURL(previewURL); }catch(e){}
        previewURL = null; previewBlob = null; previewMeta = null;
        ta.value = ''; counter.textContent = '0/800'; bar.style.width='0%';
        btnSend.disabled = true; entryMethod = null;
        setPhase('idle');
      }

      // ====== –ú–∏–Ω–∏-—É—Ä–æ–≤–Ω–µ–º–µ—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ======
      let sensorsOn = false, lastUpdate = 0;
      btnLevel.addEventListener('click', toggleLevel);

      async function toggleLevel(){
        if(sensorsOn){ stopLevel(); return; }
        const ok = await startLevel();
        if(!ok){ alert('–î–∞—Ç—á–∏–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –∏–ª–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã –±—Ä–∞—É–∑–µ—Ä–æ–º/WebView.'); }
      }
      function stopLevel(){
        window.removeEventListener('deviceorientation', onOrientation, true);
        window.removeEventListener('devicemotion', onMotion, true);
        sensorsOn = false;
        dot.className = 'dot';
        lvlText.textContent = '–£—Ä–æ–≤–Ω–µ–º–µ—Ä –≤—ã–∫–ª.';
        btnLevel.textContent = '–í–∫–ª—é—á–∏—Ç—å';
      }
      async function startLevel(){
        try{
          // iOS-permission
          if (typeof DeviceOrientationEvent !== "undefined" && typeof DeviceOrientationEvent.requestPermission === "function") {
            const p = await DeviceOrientationEvent.requestPermission();
            if (p === "granted") {
              window.addEventListener('deviceorientation', onOrientation, true);
              sensorsOn = true; lvlText.textContent = '–£—Ä–æ–≤–Ω–µ–º–µ—Ä –≤–∫–ª.'; btnLevel.textContent = '–í—ã–∫–ª—é—á–∏—Ç—å'; return true;
            }
          }
          if ("ondeviceorientation" in window) {
            window.addEventListener('deviceorientation', onOrientation, true);
            sensorsOn = true; lvlText.textContent = '–£—Ä–æ–≤–Ω–µ–º–µ—Ä –≤–∫–ª.'; btnLevel.textContent = '–í—ã–∫–ª—é—á–∏—Ç—å'; return true;
          }
          if (typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function") {
            const p2 = await DeviceMotionEvent.requestPermission();
            if (p2 === "granted") {
              window.addEventListener('devicemotion', onMotion, true);
              sensorsOn = true; lvlText.textContent = '–£—Ä–æ–≤–Ω–µ–º–µ—Ä –≤–∫–ª.'; btnLevel.textContent = '–í—ã–∫–ª—é—á–∏—Ç—å'; return true;
            }
          }
          if ("ondevicemotion" in window) {
            window.addEventListener('devicemotion', onMotion, true);
            sensorsOn = true; lvlText.textContent = '–£—Ä–æ–≤–Ω–µ–º–µ—Ä –≤–∫–ª.'; btnLevel.textContent = '–í—ã–∫–ª—é—á–∏—Ç—å'; return true;
          }
          return false;
        } catch(e){ return false; }
      }
      function onOrientation(e){
        const pitch = (e.beta  ?? 0); // -180..180
        const roll  = (e.gamma ?? 0); // -90..90
        const tilt  = Math.sqrt(pitch*pitch + roll*roll);
        paintDot(tilt);
      }
      function onMotion(evt){
        const a = evt.accelerationIncludingGravity || {};
        const x = a.x || 0, y = a.y || 0, z = a.z || 0;
        const g = Math.hypot(x,y,z) || 9.81;
        const tilt = Math.acos(Math.min(1, Math.abs(z)/g)) * 180/Math.PI; // 0¬∞ ‚Äî –ø–ª–æ—Å–∫–æ
        paintDot(tilt);
      }
      function paintDot(tilt){
        const now = performance.now();
        if(now - lastUpdate < 100) return; // ~10fps –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
        lastUpdate = now;
        if(tilt <= 5){ dot.className='dot ok'; lvlText.textContent='–†–æ–≤–Ω–æ'; haptic('light'); }
        else if(tilt <= 10){ dot.className='dot warn'; lvlText.textContent=tilt.toFixed(0)+'¬∞'; }
        else { dot.className='dot'; lvlText.textContent=tilt.toFixed(0)+'¬∞'; }
      }

      // ====== Init ======
      setPhase('idle');
      counter.textContent = '0/800';
    </script>
  </body>
</html>
