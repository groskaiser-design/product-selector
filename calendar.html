<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Ultima Coach Infinite</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
Â  /* === CORE STYLES === */
Â  :root {
Â  Â  --bg-core: #050505;Â 
Â  Â  --bg-panel: #1C1C1E;Â 
Â  Â  --bg-elevated: #2C2C2E;
Â  Â  --text-main: #ffffff;
Â  Â  --text-muted: #8E8E93;
Â  Â Â 
Â  Â  --line-color: rgba(255, 255, 255, 0.08);
Â  Â  --time-col-width: 55px;
Â  Â  --day-col-width: 65px;Â 
Â  Â Â 
Â  Â  --acc-blue: #0a84ff;
Â  Â  --acc-red: #ff453a;
Â  Â  --acc-green: #30d158;
Â  Â  --acc-purple: #5e60ce;
Â  Â  --acc-orange: #ff9f0a;
Â  Â  --acc-current: #3c9cfd;
Â  Â Â 
Â  Â  --grid-h: 60px;
Â  Â  --safe-top: env(safe-area-inset-top);
Â  Â  --safe-bottom: env(safe-area-inset-bottom);
Â  }

Â  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
Â  *::-webkit-scrollbar { display: none; }

Â  body {
Â  Â  background-color: var(--bg-core);
Â  Â  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', Roboto, sans-serif;
Â  Â  color: var(--text-main);
Â  Â  height: 100%; width: 100%;
Â  Â  overflow: hidden; position: fixed; inset: 0; user-select: none;
Â  Â  -webkit-user-select: none;
Â  }

Â  /* === FX LAYER === */
Â  .fx-layer { position: absolute; inset: 0; z-index: 0; pointer-events: none; }
Â  .orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.5; will-change: transform; }
Â  .orb-1 { width: 300px; height: 300px; background: var(--acc-purple); top: -50px; left: -100px; animation: float 20s infinite ease-in-out; }
Â  .orb-2 { width: 250px; height: 250px; background: var(--acc-blue); bottom: -50px; right: -50px; animation: float 15s infinite ease-in-out reverse; }
Â  .noise { position: fixed; inset: 0; opacity: 0.04; background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); }
Â  @keyframes float { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(30px, 50px); } }

Â  /* === LAYOUT === */
Â  .app-container { display: flex; flex-direction: column; height: 100%; width: 100%; position: relative; z-index: 1; }

Â  /* === TOP HEADER === */
Â  .top-area {
Â  Â  position: relative;
Â  Â  background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
Â  Â  border-bottom: 1px solid var(--line-color); padding-top: calc(10px + var(--safe-top)); padding-bottom: 4px;
Â  Â  z-index: 60; flex-shrink: 0;
Â  }
Â  .header-row { display: flex; justify-content: space-between; align-items: center; padding: 0 16px; margin-bottom: 10px; }
Â  .month-label { font-family: 'SF Pro Display', sans-serif; font-size: 15px; font-weight: 700; color: #fff; text-transform: uppercase; letter-spacing: 1px; }
Â  .week-controls { display: flex; gap: 16px; align-items: center; }
Â  .icon-btn { width: 32px; height: 32px; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s opacity; }
Â  .icon-btn:active { opacity: 0.6; }

Â  /* === MATRIX === */
Â  .matrix-viewport {
Â  Â  flex: 1; overflow: auto; position: relative; -webkit-overflow-scrolling: touch; overscroll-behavior: none;
Â  Â  display: flex; flex-direction: column; z-index: 10;
Â  }
Â  .matrix-header-row {
Â  Â  display: flex; position: sticky; top: 0; z-index: 40; width: max-content; background: rgba(0, 0, 0, 0.25);
Â  Â  backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-bottom: 1px solid var(--line-color);
Â  }
Â  .corner-cell { width: var(--time-col-width); flex-shrink: 0; position: sticky; left: 0; z-index: 50; background: inherit; border-right: 1px solid var(--line-color); }
Â  .days-header-track { display: flex; flex: 1; }
Â  .day-col-header {
Â  Â  width: var(--day-col-width); flex-shrink: 0; text-align: center; height: 58px;Â 
Â  Â  padding: 8px 0 0 0;
Â  Â  font-size: 11px; color: var(--text-muted); border-right: 1px solid var(--line-color);
Â  Â  display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
Â  Â  gap: 2px; position: relative; cursor: pointer;
Â  }
Â  .dch-day { font-weight: 600; text-transform: uppercase; line-height: 1; }
Â  .dch-num { font-size: 16px; font-weight: 500; color: #fff; line-height: 1; }
Â Â 
Â  .day-col-header.today { background: rgba(10, 132, 255, 0.15); border-bottom: 2px solid var(--acc-blue); }
Â  .day-col-header.today .dch-day { color: var(--acc-blue); }
Â  .day-col-header.today .dch-num { color: #fff; font-weight: 700; }

Â  /* UPDATED STATS BAR */
Â  .dch-stats {Â 
Â  Â  width: 44px; height: 4px; /* Wider and taller */
Â  Â  background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 4px;Â 
Â  Â  overflow: hidden; display: flex;Â 
Â  }
Â  /* Better contrast for Today's stats background */
Â  .day-col-header.today .dch-stats { background: rgba(255,255,255,0.2); }
Â Â 
Â  .dch-stats-fill { height: 100%; background: var(--acc-current); width: 0%; transition: width 0.3s ease, background 0.3s ease; }
Â  /* Min width to ensure visibility even for 1 hour */
Â  .dch-stats.has-data .dch-stats-fill { min-width: 6px; }
Â Â 
Â  .matrix-body { display: flex; width: max-content; position: relative; }
Â  .time-column {
Â  Â  width: var(--time-col-width); flex-shrink: 0; position: sticky; left: 0; z-index: 30;
Â  Â  background: rgba(0, 0, 0, 0.25); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
Â  Â  border-right: 1px solid var(--line-color); padding-bottom: 20px;
Â  }
Â  .time-label { height: var(--grid-h); position: relative; cursor: pointer; }Â 
Â  .time-label span { position: absolute; top: -7px; right: 6px; font-size: 11px; font-weight: 500; color: var(--text-muted); font-variant-numeric: tabular-nums; }
Â Â 
Â  .time-line-badge {
Â  Â  position: absolute; right: 4px; background: var(--acc-current); color: #fff; font-size: 11px; font-weight: 700;
Â  Â  padding: 2px 6px; border-radius: 4px; z-index: 31; transform: translateY(-50%); pointer-events: none;
Â  Â  font-variant-numeric: tabular-nums; text-align: center; min-width: 40px; display: none;
Â  }
Â  .grid-columns-container { display: flex; flex: 1; position: relative; }
Â Â 
Â  .day-column {
Â  Â  width: var(--day-col-width); flex-shrink: 0; border-right: 1px solid var(--line-color); position: relative;
Â  Â  background-image: linear-gradient(to bottom, var(--line-color) 1px, transparent 1px); background-size: 100% var(--grid-h);
Â  Â  padding-bottom: 20px; cursor: pointer;
Â  Â  touch-action: pan-y; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none;
Â  }
Â  .day-column.today { background-color: rgba(10, 132, 255, 0.02); }
Â Â 
Â  .touch-feedback {
Â  Â  position: absolute; width: 100%; background: rgba(60, 156, 253, 0.25); border-radius: 4px; pointer-events: none; z-index: 20;
Â  Â  animation: pulse-create 0.6s infinite ease-in-out; border: 1px solid var(--acc-current);
Â  Â  display: flex; align-items: center; justify-content: center;
Â  }
Â  .touch-feedback::after { content: '+'; font-size: 24px; font-weight: 300; color: #fff; opacity: 0.9; }
Â  @keyframes pulse-create { 0% { opacity: 0.3; transform: scale(0.98); } 50% { opacity: 0.7; transform: scale(1.0); } 100% { opacity: 0.3; transform: scale(0.98); } }
Â Â 
Â  .blocked-slot { position: absolute; left: 0; right: 0; height: var(--grid-h); background: repeating-linear-gradient(45deg, rgba(255,255,255,0.03), rgba(255,255,255,0.03) 10px, rgba(255,255,255,0.06) 10px, rgba(255,255,255,0.06) 20px); pointer-events: none; z-index: 1; }
Â  .blocked-range-part { position: absolute; left: 0; right: 0; background-color: var(--bg-core); background-image: repeating-linear-gradient(45deg, rgba(60, 156, 253, 0.1), rgba(60, 156, 253, 0.1) 10px, rgba(60, 156, 253, 0.2) 10px, rgba(60, 156, 253, 0.2) 20px); border-top: 1px solid rgba(60, 156, 253, 0.4); border-bottom: 1px solid rgba(60, 156, 253, 0.4); z-index: 2; pointer-events: none; }
Â  .day-off-overlay { position: absolute; inset: 0; background-color: var(--bg-core); background-image: repeating-linear-gradient(45deg, rgba(60, 156, 253, 0.1), rgba(60, 156, 253, 0.1) 10px, rgba(60, 156, 253, 0.2) 10px, rgba(60, 156, 253, 0.2) 20px); z-index: 8; pointer-events: none; }
Â Â 
Â  .global-time-line { position: absolute; left: 0; width: 100%; height: 1px; background: var(--acc-current); z-index: 10; pointer-events: none; display: none; }
Â  .global-time-line::before { content: ''; position: absolute; left: -4px; top: -3px; width: 7px; height: 7px; background: var(--acc-current); border-radius: 50%; }
Â Â 
Â  /* EVENT CARD UPDATED FOR BRIGHTNESS */
Â  .event-card {Â 
Â  Â  position: absolute; left: 2px; right: 2px; border-radius: 6px; padding: 3px 5px; overflow: hidden;Â 
Â  Â  border-left: 3px solid;Â 
Â  Â  /* removed default background, handled inline */
Â  Â  cursor: pointer; z-index: 5; box-shadow: 0 2px 8px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); transition: transform 0.1s;Â 
Â  }
Â  .event-card:active { transform: scale(0.96); }
Â  .event-card.ghost { opacity: 1; /* Make it fully opaque */ }
Â  .event-card.client-view-busy { background: repeating-linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.05) 5px, rgba(255,255,255,0.02) 5px, rgba(255,255,255,0.02) 10px); border: 1px solid rgba(255,255,255,0.05); border-left: none; color: transparent; pointer-events: none; opacity: 0.6; }
Â Â 
Â  /* TEXT SHADOW FOR BETTER CONTRAST ON BRIGHT BG */
Â  .ev-title { font-size: 11px; font-weight: 700; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; text-shadow: 0 1px 3px rgba(0,0,0,0.7); }
Â  .ev-time { font-size: 9px; color: rgba(255,255,255,0.95); margin-top: 1px; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.7); }
Â  .ev-recurring-icon { position: absolute; right: 4px; bottom: 4px; opacity: 0.8; width: 8px; height: 8px; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5)); }

Â  /* === OVERLAYS === */
Â  .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(4px); }
Â  .sheet-overlay.active { opacity: 1; pointer-events: auto; }
Â Â 
Â  .sheet {Â 
Â  Â  position: fixed; bottom: 0; left: 0; right: 0;Â 
Â  Â  background: var(--bg-panel);Â 
Â  Â  border-radius: 20px 20px 0 0;Â 
Â  Â  padding: 0 16px calc(24px + var(--safe-bottom)) 16px;Â 
Â  Â  transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);Â 
Â  Â  z-index: 101; border-top: 1px solid rgba(255,255,255,0.1);Â 
Â  Â  max-height: 90vh; overflow-y: auto;Â 
Â  }
Â  .sheet.open { transform: translateY(0); }

Â  /* ACTION SHEET (CONFIRMATION) */
Â  .action-sheet-container {
Â  Â  position: fixed; bottom: 0; left: 0; right: 0; z-index: 150;
Â  Â  padding: 16px; padding-bottom: calc(16px + var(--safe-bottom));
Â  Â  transform: translateY(110%); transition: transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
Â  }
Â  .action-sheet-container.open { transform: translateY(0); }
Â  .as-group { background: rgba(30, 30, 32, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 14px; overflow: hidden; margin-bottom: 8px; }
Â  .as-button { width: 100%; padding: 16px; background: transparent; border: none; border-bottom: 1px solid rgba(255,255,255,0.1); color: var(--acc-blue); font-size: 17px; font-weight: 400; cursor: pointer; }
Â  .as-button:last-child { border-bottom: none; }
Â  .as-button:active { background: rgba(255,255,255,0.1); }
Â  .as-button.danger { color: var(--acc-red); }
Â  .as-button.bold { font-weight: 600; }
Â  .as-title { padding: 12px 16px; font-size: 13px; color: var(--text-muted); text-align: center; font-weight: 500; border-bottom: 1px solid rgba(255,255,255,0.1); }
Â  .as-cancel { background: var(--bg-elevated); border-radius: 14px; color: var(--acc-blue); font-weight: 600; }

Â  /* FORM STYLES */
Â  .sheet-header { display: flex; justify-content: space-between; align-items: center; margin: 0 -16px 20px -16px; position: sticky; top: 0; background: var(--bg-panel); z-index: 10; padding: 24px 16px 10px 16px; border-radius: 20px 20px 0 0; }
Â  .sh-title { font-size: 18px; font-weight: 700; color: #fff; }
Â  .sh-close { color: var(--acc-blue); font-size: 16px; font-weight: 500; cursor: pointer; }
Â Â 
Â  .form-group { margin-bottom: 16px; }
Â  .form-label { font-size: 12px; color: #8E8E93; margin-bottom: 6px; margin-left: 2px; text-transform: uppercase; }
Â Â 
Â  /* UPDATED INPUT BOX - forcing white color */
Â  .input-box { width: 100%; background: rgba(118, 118, 128, 0.24); border: none; border-radius: 10px; padding: 12px; color: #fff; font-size: 16px; appearance: none; -webkit-appearance: none; }
Â  .input-box[type="date"] { color: #fff; }
Â Â 
Â  .input-row { display: flex; gap: 12px; }
Â  .btn-primary { width: 100%; padding: 14px; background: #fff; color: #000; font-weight: 600; font-size: 16px; border-radius: 12px; border: none; margin-top: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
Â  .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
Â  .btn-danger { background: rgba(255, 69, 58, 0.15); color: var(--acc-red); }
Â Â 
Â  /* SWITCH */
Â  .switch { position: relative; display: inline-block; width: 50px; height: 30px; }
Â  .switch input { opacity: 0; width: 0; height: 0; }
Â  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #3a3a3c; transition: .4s; border-radius: 30px; }
Â  .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
Â  input:checked + .slider { background-color: var(--acc-green); }
Â  input:checked + .slider:before { transform: translateX(20px); }

Â  .pattern-info-box { background: rgba(10, 132, 255, 0.1); border: 1px solid rgba(10, 132, 255, 0.3); border-radius: 8px; padding: 10px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
Â  .pib-icon { color: var(--acc-blue); }
Â  .pib-text { font-size: 13px; color: #fff; flex: 1; line-height: 1.3; }

Â  /* FIXED LAYOUT SHEET for Clients */
Â  .sheet.fixed-layout { display: flex; flex-direction: column; height: 85vh; padding: 0; overflow: hidden; }
Â  .sheet.fixed-layout .sheet-header { margin: 0; padding: 20px 16px 10px 16px; flex-shrink: 0; position: relative; top: auto; }
Â  .sheet-fixed-section { padding: 0 16px; flex-shrink: 0; }
Â  .sheet-scroll-area { flex: 1; overflow-y: auto; padding: 10px 16px; -webkit-overflow-scrolling: touch; }
Â  .sheet-fixed-footer { padding: 16px 16px calc(16px + var(--safe-bottom)) 16px; border-top: 1px solid rgba(255,255,255,0.05); background: var(--bg-panel); flex-shrink: 0; z-index: 10; }

Â  /* CLIENTS */
Â  .client-list-item { display: flex; align-items: center; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; margin-bottom: 8px; cursor: pointer; }
Â  .color-dot { width: 16px; height: 16px; border-radius: 50%; margin-right: 12px; border: 2px solid rgba(255,255,255,0.1); }
Â  .client-name { flex: 1; font-weight: 500; }
Â  .color-grid { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 16px; padding: 10px 0; }
Â  .color-option { width: 44px; height: 44px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
Â  .color-option.selected { border-color: #fff; transform: scale(1.1); }
Â Â 
Â  /* RANGES LIST */
Â  .ranges-list { max-height: 200px; overflow-y: auto; margin-top: 10px; }
Â  .range-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 8px; }
Â  .range-text { font-size: 14px; color: #fff; }
Â  .range-sub { font-size: 12px; color: #8E8E93; margin-top: 2px; }
Â  .range-actions { display: flex; gap: 12px; }
Â  .range-icon { color: var(--text-muted); cursor: pointer; }
Â  .range-icon.edit { color: var(--acc-blue); }
Â  .range-icon.del { color: var(--acc-red); }

Â  /* SCHED ROWS */
Â  .sched-row { display: flex; align-items: center; margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 12px; }
Â  .sched-day { width: 40px; font-weight: 600; font-size: 14px; color: #fff; }
Â  .sched-slots { flex: 1; display: flex; flex-wrap: wrap; gap: 6px; }
Â  .sched-chip { padding: 6px 10px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
Â  .sched-add { background: rgba(255,255,255,0.1); color: #fff; width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; }

Â  /* TOAST */
Â  .toast-notification {
Â  Â  position: fixed; top: calc(20px + var(--safe-top)); left: 16px; right: 16px;
Â  Â  background: rgba(28, 28, 30, 0.9); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
Â  Â  border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 16px;
Â  Â  border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
Â  Â  z-index: 9999;Â 
Â  Â  font-size: 14px; font-weight: 500; text-align: center;
Â  Â  transform: translateY(-150%); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
Â  Â  pointer-events: none; opacity: 0;
Â  }
Â  .toast-notification.show { transform: translateY(0); opacity: 1; }
Â  .toast-notification span { color: var(--acc-red); font-weight: 700; display: block; margin-bottom: 4px; font-size: 12px; text-transform: uppercase; }
Â  .toast-notification.success span { color: var(--acc-green); }

Â  /* PATTERN EDITOR */
Â  .pattern-editor-overlay { position: fixed; inset: 0; background: var(--bg-core); z-index: 102; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
Â  .pattern-editor-overlay.open { transform: translateY(0); }
Â  .pe-header { background: rgba(10, 132, 255, 0.1); border-bottom: 1px solid var(--acc-blue); padding-top: calc(10px + var(--safe-top)); padding-bottom: 10px; flex-shrink: 0; }
Â  Â  /* Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€Ğ° ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ° */
Â  Â  .pe-title {Â 
Â  Â  Â  font-size: 15px;Â  Â  Â  Â  Â  /* Ğ¡Ğ´ĞµĞ»Ğ°Ğ»Ğ¸ Ğ¿Ğ¾Ğ¼ĞµĞ½ÑŒÑˆĞµ (Ğ±Ñ‹Ğ»Ğ¾ 16px) */
Â  Â  Â  font-weight: 600;Â  Â  Â  Â  Â /* Ğ§ÑƒÑ‚ÑŒ Ñ‚Ğ¾Ğ½ÑŒÑˆĞµ */
Â  Â  Â  color: #fff;Â 
Â  Â  Â  display: flex;Â 
Â  Â  Â  align-items: center;Â 
Â  Â  Â  justify-content: center;Â  /* Ğ¦ĞµĞ½Ñ‚Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº */
Â  Â  Â  flex: 1;Â  Â  Â  Â  Â  Â  Â  Â  Â  /* Ğ Ğ°ÑÑ‚ÑĞ³Ğ¸Ğ²Ğ°ĞµĞ¼, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ñ†ĞµĞ½Ñ‚Ñ€Ğ¾Ğ²ĞºĞ° ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ»Ğ° Ğ²ĞµÑ€Ğ½Ğ¾ */
Â  Â  Â Â 
Â  Â  Â  /* Ğ£Ğ”ĞĞ›Ğ•ĞĞ« Ğ¡Ğ¢Ğ ĞĞšĞ˜: */
Â  Â  Â  /* text-transform: uppercase; (Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°Ğ»Ğ° Ğ·Ğ° ĞºĞ°Ğ¿Ñ) */
Â  Â  Â  /* letter-spacing: 1px; (Ñ€Ğ°Ğ·Ñ€ÑĞ´ĞºĞ° Ğ±ÑƒĞºĞ², Ğ´Ğ»Ñ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾Ğ³Ğ¾ Ñ‚ĞµĞºÑÑ‚Ğ° Ğ½Ğµ Ğ½ÑƒĞ¶Ğ½Ğ°) */
Â  Â  }
Â Â 
Â  .pe-badge { background: var(--acc-blue); padding: 2px 6px; border-radius: 4px; font-size: 10px; }
Â  .pattern-editor-overlay .matrix-body, .pattern-editor-overlay .matrix-header-row { width: 100%; }
Â  .pattern-editor-overlay .day-col-header, .pattern-editor-overlay .day-column { width: auto; flex: 1; }
Â  .pattern-editor-overlay .blocked-slot { background: repeating-linear-gradient(45deg, rgba(10,132,255,0.15), rgba(10,132,255,0.15) 10px, rgba(10,132,255,0.25) 10px, rgba(10,132,255,0.25) 20px); pointer-events: auto; cursor: pointer; border-top: 1px solid rgba(10,132,255,0.3); border-bottom: 1px solid rgba(10,132,255,0.3); }

</style>
</head>
<body oncontextmenu="return false;">

<div class="fx-layer"><div class="orb orb-1"></div><div class="orb orb-2"></div><div class="noise"></div></div>

<div class="toast-notification" id="toast">
Â  <span id="toastTitle">ĞĞ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚Ğµ Ğ²Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ</span>
Â  <div id="toastMessage">ĞĞ±Ñ‹Ñ‡Ğ½Ğ¾ Ğ²Ñ‹ Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚Ğµ Ğ² ÑÑ‚Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ</div>
</div>

<div class="app-container">
Â  <div class="top-area">
Â  Â  <div class="header-row">
Â  Â  Â  <div class="month-label" id="headerMonth">ĞĞĞ¯Ğ‘Ğ Ğ¬ 2025</div>
Â  Â  Â  <div class="week-controls">
Â  Â  Â  Â  <div class="icon-btn" id="settingsBtn" onclick="openSettings()">
Â  Â  Â  Â  Â  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div class="matrix-viewport" id="matrixViewport">
Â  Â  <div class="matrix-header-row">
Â  Â  Â  <div class="corner-cell"></div>
Â  Â  Â  <div class="days-header-track" id="daysHeaderTrack"></div>
Â  Â  </div>
Â  Â  <div class="matrix-body">
Â  Â  Â  <div class="time-column" id="timeColumn"><div class="time-line-badge" id="timeLineBadge">00:00</div></div>
Â  Â  Â  <div class="grid-columns-container" id="gridColumns"><div class="global-time-line" id="globalTimeLine"></div></div>
Â  Â  </div>
Â  </div>
</div>

<div class="sheet-overlay" id="overlay" onclick="closeAllSheets()"></div>

<div class="sheet-overlay" id="actionSheetOverlay" style="z-index:140" onclick="closeActionSheet()"></div>
<div class="action-sheet-container" id="actionSheet">
Â  <div class="as-group">
Â  Â  <div class="as-title" id="asTitle">Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ÑÑÑ‰ĞµĞ³Ğ¾ÑÑ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ</div>
Â  Â  <button class="as-button" id="asBtnOne">Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ ÑÑ‚Ğ° Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°</button>
Â  Â  <button class="as-button bold" id="asBtnSeries">Ğ’ÑÑ ÑĞµÑ€Ğ¸Ñ</button>
Â  </div>
Â  <button class="as-button as-cancel" onclick="closeActionSheet()">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
</div>

<div class="pattern-editor-overlay" id="patternEditor">
<div class="header-row pe-header">
Â  <div class="icon-btn" onclick="closePatternEditor()" style="color: var(--acc-red); width:auto; font-size:14px; padding-left: 16px;">ĞÑ‚Ğ¼ĞµĞ½Ğ°</div>
Â Â 
Â  <div class="pe-title">Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹</div>
Â Â 
Â  <div class="icon-btn" onclick="savePattern()" style="color: var(--acc-blue); font-weight:600; width:auto; font-size:14px;">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</div>
</div>
Â  <div class="matrix-viewport">
Â  Â  <div class="matrix-header-row"><div class="corner-cell"></div><div class="days-header-track" id="peHeaderTrack"></div></div>
Â  Â  <div class="matrix-body"><div class="time-column" id="peTimeColumn"></div><div class="grid-columns-container" id="peGridColumns"></div></div>
Â  </div>
</div>

<div class="sheet" id="sessionSheet">
Â  <div class="sheet-header"><div class="sh-title" id="sheetTitle">Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°</div><div class="sh-close" onclick="closeAllSheets()">ĞÑ‚Ğ¼ĞµĞ½Ğ°</div></div>
Â Â 
Â  <div id="patternInfoBox" class="pattern-info-box" style="display:none">
Â  Â  <div class="pib-icon">
Â  Â  Â  Â <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
Â  Â  </div>
Â  Â  <div class="pib-text">Ğ­Ñ‚Ğ° Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° â€” Ñ‡Ğ°ÑÑ‚ÑŒ Ñ€ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğ³Ğ¾ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ.</div>
Â  </div>

Â  <div class="form-group">
Â  Â  <div class="form-label">ĞšĞ»Ğ¸ĞµĞ½Ñ‚</div>
Â  Â  <select class="input-box" id="inpClient" onchange="onClientSelectChange()">
Â  Â  Â  </select>
Â  Â  <input type="text" class="input-box" id="inpNewClient" placeholder="Ğ˜Ğ¼Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°" style="display:none; margin-top:8px;">
Â  </div>
Â  <div class="form-group">
Â  Â  <div class="form-label" style="display:flex; justify-content:space-between;">Ğ”Ğ°Ñ‚Ğ° <span id="dateDisplay" style="color:#fff; font-weight:500;"></span></div>
Â  Â  <input type="date" class="input-box" id="inpDate" onchange="updateDateDisplay()">
Â  </div>
Â  <div class="input-row">
Â  Â  <div class="form-group" style="flex:1"><div class="form-label">ĞĞ°Ñ‡Ğ°Ğ»Ğ¾</div><input type="time" class="input-box" id="inpStart"></div>
Â  Â  <div class="form-group" style="flex:1"><div class="form-label">ĞšĞ¾Ğ½ĞµÑ†</div><input type="time" class="input-box" id="inpEnd"></div>
Â  </div>
Â  <div class="form-group"><div class="form-label">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ°</div><input type="text" class="input-box" id="inpNote" placeholder="Ğ¢Ğ¸Ğ¿ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸..."></div>
Â Â 
Â  <div class="form-group" id="recurringOptionContainer" style="display: flex; align-items: center; gap: 12px; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; margin-bottom: 16px;">
Â  Â  <div style="flex: 1; font-size: 16px;">ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€ÑÑ‚ÑŒ ĞµĞ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¾</div>
Â  Â  <label class="switch">
Â  Â  Â  <input type="checkbox" id="inpRecurring">
Â  Â  Â  <span class="slider"></span>
Â  Â  </label>
Â  </div>

Â  <button class="btn-primary" onclick="trySaveSession()">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
Â  <button class="btn-primary btn-danger" id="btnDelete" style="display:none" onclick="tryDeleteSession()">Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ</button>
</div>

<div class="sheet" id="settingsSheet">
Â  <div class="sheet-header"><div class="sh-title">ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸</div><div class="sh-close" onclick="closeAllSheets()">Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾</div></div>
Â  <div class="form-group"><div class="form-label">Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹</div><button class="btn-primary" onclick="openPatternEditor()">Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ° (7 Ğ´Ğ½ĞµĞ¹)</button></div>
Â  <div class="form-group"><div class="form-label">ĞÑĞ¾Ğ±Ñ‹Ğµ Ğ´Ğ°Ñ‚Ñ‹</div><button class="btn-primary btn-secondary" onclick="openRangesSheet()">ĞÑ‚Ğ¿ÑƒÑĞº / ĞŸĞµÑ€Ğ¸Ğ¾Ğ´Ñ‹</button></div>
Â  <div class="form-group"><div class="form-label">Ğ‘Ğ°Ğ·Ğ°</div><button class="btn-primary btn-secondary" onclick="openClientsSheet()">ĞšĞ»Ğ¸ĞµĞ½Ñ‚Ñ‹</button></div>
Â  <div class="form-group"><div class="form-label">ĞŸÑ€ĞµĞ´Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€</div><button class="btn-primary btn-secondary" id="btnToggleClientMode" onclick="toggleClientMode()">Ğ“Ğ»Ğ°Ğ·Ğ°Ğ¼Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°: Ğ’Ğ«ĞšĞ›</button></div>
</div>

<div class="sheet" id="rangesSheet">
Â  <div class="sheet-header"><div class="sh-title">ĞÑ‚Ğ¿ÑƒÑĞº / ĞŸĞµÑ€Ğ¸Ğ¾Ğ´Ñ‹</div><div class="sh-close" onclick="closeAllSheets()">Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ</div></div>
Â  <div class="input-row"><input type="date" class="input-box" id="rangeStartDate"><input type="time" class="input-box" id="rangeStartTime" value="00:00"></div>
Â  <div class="input-row" style="margin-top:8px"><input type="date" class="input-box" id="rangeEndDate"><input type="time" class="input-box" id="rangeEndTime" value="23:59"></div>
Â  <button class="btn-primary" id="rangeSubmitBtn" onclick="addRange()" style="margin-top:12px">Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´</button>
Â  <div class="ranges-list" id="rangesList"></div>
</div>

<div class="sheet" id="clientsSheet">
Â  <div class="sheet-header"><div class="sh-title">ĞšĞ»Ğ¸ĞµĞ½Ñ‚Ñ‹</div><div class="sh-close" onclick="closeAllSheets()">Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ</div></div>
Â  <div class="form-group"><button class="btn-primary" onclick="openClientEdit()">+ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°</button></div>
Â  <div id="clientsListContainer" style="margin-top:20px;"></div>
</div>

<div class="sheet fixed-layout" id="clientEditSheet">
Â  <div class="sheet-header"><div class="sh-title" id="ceTitle">ĞĞ¾Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ¸ĞµĞ½Ñ‚</div><div class="sh-close" onclick="openClientsSheet()">ĞĞ°Ğ·Ğ°Ğ´</div></div>
Â Â 
Â  <div class="sheet-fixed-section">
Â  Â  <div class="form-group"><div class="form-label">Ğ˜Ğ¼Ñ</div><input type="text" class="input-box" id="ceName" placeholder="Ğ˜Ğ²Ğ°Ğ½ Ğ˜."></div>
Â  </div>
Â Â 
Â  <div class="sheet-scroll-area">
Â  Â  <div class="form-group"><div class="form-label">Ğ¦Ğ²ĞµÑ‚</div>
Â  Â  Â  <div class="color-grid" id="ceColorGrid"></div>
Â  Â  Â  <input type="hidden" id="ceColor">
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  <div class="form-label">Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº Ğ¿Ğ¾ÑĞµÑ‰ĞµĞ½Ğ¸Ğ¹ (ĞŸĞ°Ñ‚Ñ‚ĞµÑ€Ğ½)</div>
Â  Â  Â  <div id="ceScheduleContainer" style="background: rgba(255,255,255,0.03); padding:10px; border-radius:8px;"></div>
Â  Â  </div>
Â  </div>

Â  <div class="sheet-fixed-footer">
Â  Â  <button class="btn-primary" onclick="saveClient()">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°</button>
Â  </div>
</div>

<div class="sheet" id="timeSlotSheet" style="z-index: 105; padding-bottom: calc(60px + var(--safe-bottom));">
Â  <div class="sheet-header"><div class="sh-title">Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ²Ñ€ĞµĞ¼Ñ</div><div class="sh-close" onclick="closeTimeSlotSheet()">ĞÑ‚Ğ¼ĞµĞ½Ğ°</div></div>
Â  <div class="input-row">
Â  Â  <input type="time" class="input-box" id="tsStart" value="16:00">
Â  Â  <input type="time" class="input-box" id="tsEnd" value="17:00">
Â  </div>
Â  <button class="btn-primary" onclick="confirmTimeSlot()">Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>
</div>

<div class="sheet" id="dayOptionsSheet">
Â  <div class="sheet-header"><div class="sh-title" id="dayOptionsTitle">ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ´Ğ½Ñ</div><div class="sh-close" onclick="closeAllSheets()">Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ</div></div>
Â  <button class="btn-primary btn-danger" onclick="toggleDayOff()">Ğ¡Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼</button>
Â  <button class="btn-primary btn-secondary" onclick="clearDayOff()" style="margin-top:12px;">Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ</button>
</div>

<script>
Â  // 1. CONFIG
Â  const APP_VERSION = 'v6.0-FINAL-INTEGRATED';
Â  // ğŸ‘‡ Ğ’Ğ¡Ğ¢ĞĞ’Ğ¬ Ğ¡Ğ®Ğ”Ğ Ğ¡Ğ’ĞĞ® Ğ¡Ğ¡Ğ«Ğ›ĞšĞ£ Ğ˜Ğ— DEPLOY (exec) ğŸ‘‡
Â  const API_URL = 'https://script.google.com/macros/s/AKfycbwHf-09WXEQsiNA0QZt9K_bVd3v95Fw0cHdvQM10axuRdNYyUKzZfMKPIgJxQbno4B97w/exec';Â 

Â  const GRID_H = 60;
Â  let startOffset = -30, endOffset = 60;
Â  let currentStart = getStartOfWeek(new Date());
Â  currentStart.setDate(currentStart.getDate() + startOffset);
Â Â 
Â  let updateInterval, selectedDayForOptions = null, longPressTimer = null;
Â  let isScrolling = false, activeTouchEl = null, isClientMode = false, simulatedClientId = 1;

Â  // DATA STORAGE
Â  const KEY_PATTERN = 'uc_pattern', KEY_EXCEPTIONS = 'uc_exceptions', KEY_RANGES = 'uc_ranges', KEY_CLIENTS = 'uc_clients', KEY_SESSIONS = 'uc_sessions';
Â  let availabilityPattern = {0:[],1:[],2:[],3:[],4:[],5:[],6:[]};
Â  let dateExceptions = {};Â 
Â  let specialRanges = [];Â 
Â  let clients = [];Â 
Â  let sessions = [];Â 
Â Â 
Â  const colorPalette = ['#B0BEC5', '#90A4AE', '#78909C', '#607D8B', '#455A64', '#BCAAA4', '#8D6E63', '#5D4037', '#FF5252', '#FF1744', '#D50000', '#B71C1C', '#FF4081', '#F50057', '#C51162', '#880E4F', '#E040FB', '#D500F9', '#AA00FF', '#4A148C', '#7C4DFF', '#651FFF', '#6200EA', '#311B92', '#448AFF', '#2979FF', '#2962FF', '#0D47A1', '#40C4FF', '#00B0FF', '#0091EA', '#01579B', '#18FFFF', '#00E5FF', '#00B8D4', '#006064', '#69F0AE', '#00E676', '#00C853', '#1B5E20', '#B2FF59', '#76FF03', '#64DD17', '#FFFF00', '#FFEA00', '#FFD600', '#FFD740', '#FFC400', '#FFAB00', '#FF6D00'];

Â  let editingId = null, editingClient = null, editingDayIdx = null;
Â  let tempSessionData = null, editingLinkedPattern = null, editingRangeIndex = null;

Â  /* ==========================================
Â  Â  Â  Â 2. DATA MANAGER (SERVER SYNC)
Â  Â  Â ========================================== */
Â  const DataManager = {
Â  Â  getUserId() { return window.Telegram?.WebApp?.initDataUnsafe?.user?.id || 'guest'; },

Â  Â  // DUAL-SAVE: Save to local storage AND to server
Â  Â  saveLocally(key, data) { localStorage.setItem(key, JSON.stringify(data)); },
Â  Â Â 
Â  Â  // Load local data for instant render
Â  Â  loadLocal() {
Â  Â  Â  Â try {
Â  Â  Â  Â  const p = localStorage.getItem(KEY_PATTERN); if(p) availabilityPattern = JSON.parse(p); else { availabilityPattern[0]=[0,1,2,3,4,5,6,7]; availabilityPattern[6]=Array.from({length:24},(_,i)=>i); }
Â  Â  Â  Â  const e = localStorage.getItem(KEY_EXCEPTIONS); if(e) dateExceptions = JSON.parse(e);
Â  Â  Â  Â  const r = localStorage.getItem(KEY_RANGES); if(r) specialRanges = JSON.parse(r);
Â  Â  Â  Â  const c = localStorage.getItem(KEY_CLIENTS); if(c) clients = JSON.parse(c); else clients = [];
Â  Â  Â  Â  const s = localStorage.getItem(KEY_SESSIONS); if(s) sessions = JSON.parse(s); else sessions = [];
Â  Â  Â  } catch(err) { console.error("Local Load Error", err); }
Â  Â  },

Â  Â  async fetchFromServer(action, payload = {}) {
Â  Â  Â  const tg = window.Telegram?.WebApp;
Â  Â  Â  const bodyData = { action: action, init_data: tg?.initData || '', ...payload };
Â  Â  Â  console.log(`[API] Sending ${action}...`);
Â  Â  Â  try {
Â  Â  Â  Â  const resp = await fetch(API_URL, {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
Â  Â  Â  Â  Â  body: JSON.stringify(bodyData)
Â  Â  Â  Â  });
Â  Â  Â  Â  const text = await resp.text();
Â  Â  Â  Â  let json = null;
Â  Â  Â  Â  try { json = JSON.parse(text); } catch(e) { throw new Error('Server returned invalid JSON'); }
Â  Â  Â  Â  if (!json.ok) throw new Error(json.error || 'Unknown Server Error');
Â  Â  Â  Â  console.log(`[API] Success ${action}`);
Â  Â  Â  Â  return json.data;
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error('[API] Error:', e);
Â  Â  Â  Â  throw e;
Â  Â  Â  }
Â  Â  }
Â  };

Â  /* ==========================================
Â  Â  Â  Â 3. INIT
Â  Â  Â ========================================== */
Â  async function init() {
Â  Â  const tg = window.Telegram?.WebApp;
Â  Â  if(tg) { tg.ready(); tg.expand(); try{tg.setHeaderColor('#050505');tg.setBackgroundColor('#050505');}catch(_){} }

Â  Â  // 1. Load Local & Render Immediately
Â  Â  DataManager.loadLocal();
Â  Â  renderTimeColumn(); renderDayRange(startOffset, endOffset);
Â  Â  scrollToToday(); startClock();
Â  Â  reRenderBlocks();
Â  Â Â 
Â  Â  document.getElementById('matrixViewport').addEventListener('scroll', ()=>{ isScrolling=true; cancelLongPress(); onScroll(); handleInfiniteScroll(); }, {passive: true});

Â  Â  // 2. Fetch from Server Background
Â  Â  const d = new Date();
Â  Â  const monthStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;Â 

Â  Â  try {
Â  Â  Â  const fresh = await DataManager.fetchFromServer('init_load', { month_str: monthStr });
Â  Â  Â  applyDataToState(fresh, monthStr);
Â  Â  Â  saveAllDataLocally(); // Sync local with server
Â  Â  Â  showToast("Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹", true);
Â  Â  } catch (e) {
Â  Â  Â  showToast("Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ° Ğ² Ğ¾Ñ„Ñ„Ğ»Ğ°Ğ¹Ğ½ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ", false);
Â  Â  }
Â  }

Â  function applyDataToState(data, monthStr) {
Â  Â  if (!data) return;
Â  Â  if (data.settings) {
Â  Â  Â  if (data.settings.pattern) availabilityPattern = data.settings.pattern;
Â  Â  Â  if (data.settings.exceptions) dateExceptions = data.settings.exceptions;
Â  Â  Â  if (data.settings.ranges) specialRanges = data.settings.ranges;
Â  Â  }
Â  Â  if (data.clients) clients = data.clients;
Â  Â  if (data.calendar) {
Â  Â  Â  // Merge strategy: remove old month data, add fresh
Â  Â  Â  sessions = sessions.filter(s => !s.dateStr.startsWith(monthStr));
Â  Â  Â  Object.keys(data.calendar).forEach(dayKey => {
Â  Â  Â  Â  data.calendar[dayKey].forEach(evt => {
Â  Â  Â  Â  Â  const clientObj = clients.find(c => String(c.id) === String(evt.c)) || { name: '?', color: '#555' };
Â  Â  Â  Â  Â  sessions.push({
Â  Â  Â  Â  Â  Â  id: evt.i, clientId: evt.c, client: clientObj.name,Â 
Â  Â  Â  Â  Â  Â  dateStr: `${monthStr}-${dayKey.padStart(2, '0')}`,
Â  Â  Â  Â  Â  Â  start: evt.s, end: evt.e, status: evt.st, note: evt.n, type: 'client',
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  }
Â  Â  reRenderBlocks();
Â  Â  updateAllDayStats();
Â  }

Â  function saveAllDataLocally() {
Â  Â  DataManager.saveLocally(KEY_PATTERN, availabilityPattern);
Â  Â  DataManager.saveLocally(KEY_EXCEPTIONS, dateExceptions);
Â  Â  DataManager.saveLocally(KEY_RANGES, specialRanges);
Â  Â  DataManager.saveLocally(KEY_CLIENTS, clients);
Â  Â  DataManager.saveLocally(KEY_SESSIONS, sessions);
Â  Â  updateAllDayStats();
Â  }

Â  /* ==========================================
Â  Â  Â  Â 4. ACTIONS & SAVING
Â  Â  Â ========================================== */
Â  async function trySaveSession() {
Â  Â  let clientName = document.getElementById('inpClient').value;
Â  Â  if (clientName === '_new_') clientName = document.getElementById('inpNewClient').value.trim() || 'Ğ“Ğ¾ÑÑ‚ÑŒ';
Â  Â Â 
Â  Â  const dateStr = document.getElementById('inpDate').value;
Â  Â  const start = document.getElementById('inpStart').value;
Â  Â  const end = document.getElementById('inpEnd').value;
Â  Â  const note = document.getElementById('inpNote').value;
Â  Â  const isRecurring = document.getElementById('inpRecurring').checked;

Â  Â  if (isClientMode) {Â 
Â  Â  Â  Â  const val = validateAppointment(dateStr, start, end, editingId);Â 
Â  Â  Â  Â  if(!val.valid) { showToast(val.msg, true); return; }Â 
Â  Â  }

Â  Â  // CREATE CLIENT ON FLY IF NEEDED
Â  Â  let clientObj = clients.find(c => c.name === clientName);
Â  Â  if (!clientObj) {
Â  Â  Â  Â  clientObj = { id: Date.now(), name: clientName, color: colorPalette[Math.floor(Math.random()*colorPalette.length)], schedule: {} };
Â  Â  Â  Â  clients.push(clientObj);
Â  Â  Â  Â  DataManager.fetchFromServer('save_client', { client: clientObj });
Â  Â  }

Â  Â  const newData = {Â 
Â  Â  Â  Â  client: clientName, clientId: clientObj.id,
Â  Â  Â  Â  dateStr, start, end, note, status: 'planned', type: 'client'
Â  Â  };

Â  Â  // CONFLICT CHECK FOR SERIES
Â  Â  if (editingLinkedPattern) {
Â  Â  Â  Â  const newD = new Date(dateStr);
Â  Â  Â  Â  let newDayIdx = newD.getDay() - 1; if(newDayIdx === -1) newDayIdx = 6;
Â  Â  Â  Â  const isTimeChanged = (start !== editingLinkedPattern.s || end !== editingLinkedPattern.e);
Â  Â  Â  Â  const isDayChanged = (newDayIdx !== editingLinkedPattern.dayIdx);
Â  Â  Â  Â  if (isTimeChanged || isDayChanged) {
Â  Â  Â  Â  Â  Â  tempSessionData = newData;Â 
Â  Â  Â  Â  Â  Â  openActionSheet('save');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // MAKE RECURRING
Â  Â  if (!editingLinkedPattern && isRecurring) {
Â  Â  Â  Â  const newD = new Date(dateStr);
Â  Â  Â  Â  let newDayIdx = newD.getDay() - 1; if(newDayIdx === -1) newDayIdx = 6;
Â  Â  Â  Â  updateClientPattern(clientName, null, { dateStr, start, end });
Â  Â  Â  Â  const cSave = clients.find(c => c.name === clientName);
Â  Â  Â  Â  if(cSave) DataManager.fetchFromServer('save_client', { client: cSave });
Â  Â  Â  Â  newData.linkedPatternSlot = { dayIdx: newDayIdx, s: start, e: end };
Â  Â  Â  Â  showToast("Ğ¡ĞµÑ€Ğ¸Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°", true);
Â  Â  }
Â  Â Â 
Â  Â  commitSave(newData, false);
Â  }

Â  function commitSave(data, updateSeries) {
Â  Â  if (updateSeries && editingLinkedPattern) {
Â  Â  Â  Â  updateClientPattern(data.client, editingLinkedPattern, data);
Â  Â  Â  Â  const cSave = clients.find(c => c.name === data.client);
Â  Â  Â  Â  if(cSave) DataManager.fetchFromServer('save_client', { client: cSave });
Â  Â  Â  Â  showToast("Ğ¡ĞµÑ€Ğ¸Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°", true);
Â  Â  }

Â  Â  // OPTIMISTIC LOCAL UPDATE
Â  Â  let finalId = editingId;
Â  Â  if(editingId && !String(editingId).startsWith('ghost')) {
Â  Â  Â  Â  const idx = sessions.findIndex(s => s.id == editingId);
Â  Â  Â  Â  if (idx !== -1) {Â 
Â  Â  Â  Â  Â  Â sessions[idx] = { ...sessions[idx], ...data, linkedPatternSlot: updateSeries ? null : sessions[idx].linkedPatternSlot };
Â  Â  Â  Â  } else { sessions.push({ id: editingId, ...data }); }
Â  Â  } else {
Â  Â  Â  Â  finalId = Date.now();
Â  Â  Â  Â  sessions.push({ id: finalId, ...data });
Â  Â  }

Â  Â  // SYNC
Â  Â  saveAllDataLocally();
Â  Â  closeAllSheets(); reRenderBlocks();Â 

Â  Â  // SERVER SAVE
Â  Â  const sessionToSend = { ...data, id: finalId };
Â  Â  DataManager.fetchFromServer('save_session', { date: data.dateStr, session: sessionToSend }).then(res => {
Â  Â  Â  Â  if(res.saved_id) {
Â  Â  Â  Â  Â  Â const s = sessions.find(sess => sess.id == finalId);
Â  Â  Â  Â  Â  Â if(s) { s.id = res.saved_id; saveAllDataLocally(); } // Update ID confirmed by server
Â  Â  Â  Â  }
Â  Â  });
Â  }

Â  function tryDeleteSession() {
Â  Â  if (editingLinkedPattern) openActionSheet('delete');
Â  Â  else commitDelete(false);
Â  }

Â  function commitDelete(deleteSeries) {
Â  Â  if (deleteSeries && editingLinkedPattern) {
Â  Â  Â  Â  Â const s = sessions.find(x => x.id == editingId) || { client: document.getElementById('inpClient').value };
Â  Â  Â  Â  Â updateClientPattern(s.client, editingLinkedPattern, null);
Â  Â  Â  Â  Â const cSave = clients.find(c => c.name === s.client);
Â  Â  Â  Â  Â if(cSave) DataManager.fetchFromServer('save_client', { client: cSave });
Â  Â  Â  Â  Â if(editingId && !String(editingId).startsWith('ghost')) sessions = sessions.filter(x => x.id != editingId);
Â  Â  Â  Â  Â showToast("Ğ¡ĞµÑ€Ğ¸Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ°", false);
Â  Â  } else {
Â  Â  Â  Â  if (!deleteSeries && editingLinkedPattern) {
Â  Â  Â  Â  Â  Â  Â // Create Cancelled Session to hide ghost
Â  Â  Â  Â  Â  Â  Â let clientName = document.getElementById('inpClient').value;
Â  Â  Â  Â  Â  Â  Â if (clientName === '_new_') clientName = document.getElementById('inpNewClient').value;
Â  Â  Â  Â  Â  Â  Â const dateStr = document.getElementById('inpDate').value;
Â  Â  Â  Â  Â  Â  Â const cancelledS = { id: Date.now(), client: clientName, dateStr: dateStr, start: editingLinkedPattern.s, end: editingLinkedPattern.e, status: 'cancelled', type: 'client' };
Â  Â  Â  Â  Â  Â  Â sessions.push(cancelledS);
Â  Â  Â  Â  Â  Â  Â DataManager.fetchFromServer('save_session', { date: dateStr, session: cancelledS });
Â  Â  Â  Â  } else if(editingId && !String(editingId).startsWith('ghost')) {
Â  Â  Â  Â  Â  Â  const s = sessions.find(x => x.id == editingId);
Â  Â  Â  Â  Â  Â  sessions = sessions.filter(x => x.id != editingId);
Â  Â  Â  Â  Â  Â  if(s) DataManager.fetchFromServer('save_session', { date: s.dateStr, session: { id: s.id }, is_delete: true });
Â  Â  Â  Â  }
Â  Â  Â  Â  showToast("Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾", false);
Â  Â  }
Â  Â Â 
Â  Â  saveAllDataLocally();
Â  Â  closeAllSheets(); reRenderBlocks();
Â  }

Â  async function saveClient() {
Â  Â  const name = document.getElementById('ceName').value;Â 
Â  Â  if(!name) return alert('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ');Â 
Â  Â  editingClient.name = name;
Â  Â  const idx = clients.findIndex(c => c.id === editingClient.id);
Â  Â  if(idx !== -1) clients[idx] = editingClient; else clients.push(editingClient);
Â  Â  saveAllDataLocally();
Â  Â  closeAllSheets(); reRenderBlocks();Â 
Â  Â  try {
Â  Â  Â  Â  await DataManager.fetchFromServer('save_client', { client: editingClient });
Â  Â  Â  Â  showToast("ĞšĞ»Ğ¸ĞµĞ½Ñ‚ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½", true);
Â  Â  } catch(e) { showToast("ĞÑˆĞ¸Ğ±ĞºĞ°", false); }
Â  }

Â  async function syncSettings() {
Â  Â  const full = { pattern: availabilityPattern, exceptions: dateExceptions, ranges: specialRanges };
Â  Â  saveAllDataLocally();
Â  Â  try { await DataManager.fetchFromServer('save_settings', { settings: full }); } catch (e) { showToast("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº", false); }
Â  }

Â  function savePattern() { document.getElementById('patternEditor').classList.remove('open'); reRenderBlocks(); updateAllDayStats(); syncSettings(); showToast("Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½", true); }
Â  function toggleDayOff() { if (selectedDayForOptions) { dateExceptions[selectedDayForOptions] = 'off'; reRenderBlocks(); closeAllSheets(); syncSettings(); } }
Â  function clearDayOff() { if (selectedDayForOptions) { delete dateExceptions[selectedDayForOptions]; reRenderBlocks(); closeAllSheets(); syncSettings(); } }
Â Â 
Â  function addRange() {
Â  Â  const dS = document.getElementById('rangeStartDate').value; const tS = document.getElementById('rangeStartTime').value;
Â  Â  const dE = document.getElementById('rangeEndDate').value; const tE = document.getElementById('rangeEndTime').value;
Â  Â  if (!dS || !tS || !dE || !tE) return alert('Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ²ÑĞµ Ğ¿Ğ¾Ğ»Ñ');
Â  Â  const start = `${dS}T${tS}`, end = `${dE}T${tE}`;
Â  Â  if (start >= end) return alert('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ°Ñ‚');
Â  Â  const nr = { start, end };
Â  Â  if (editingRangeIndex !== null) specialRanges[editingRangeIndex] = nr; else specialRanges.push(nr);
Â  Â  resetRangeForm(); renderRangesList(); reRenderBlocks(); syncSettings();
Â  }
Â  function deleteRange(i) { specialRanges.splice(i, 1); if (editingRangeIndex === i) resetRangeForm(); renderRangesList(); reRenderBlocks(); syncSettings(); }

Â  /* --- VISUAL HELPERS & UI --- */
Â  function getLocalDateStr(date) { const y = date.getFullYear(); const m = String(date.getMonth() + 1).padStart(2, '0'); const d = String(date.getDate()).padStart(2, '0'); return `${y}-${m}-${d}`; }
Â  function getDateStr(offset) { const d=new Date(); d.setDate(d.getDate()+offset); return getLocalDateStr(d); }
Â  function getStartOfWeek(date) { const d=new Date(date); const day=d.getDay(); const diff=d.getDate()-day+(day===0?-6:1); d.setDate(diff); d.setHours(0,0,0,0); return d; }
Â  function hexToRgba(hex, alpha) { const r = parseInt(hex.slice(1, 3), 16); const g = parseInt(hex.slice(3, 5), 16); const b = parseInt(hex.slice(5, 7), 16); return `rgba(${r}, ${g}, ${b}, ${alpha})`; }
Â  function getContrastYIQ(hexcolor){ hexcolor = hexcolor.replace("#", ""); var r = parseInt(hexcolor.substr(0,2),16); var g = parseInt(hexcolor.substr(2,2),16); var b = parseInt(hexcolor.substr(4,2),16); var yiq = ((r*299)+(g*587)+(b*114))/1000; return (yiq >= 128) ? 'black' : 'white'; }

Â  function renderTimeColumn() { const col=document.getElementById('timeColumn'), badge=document.getElementById('timeLineBadge'); col.innerHTML=''; col.appendChild(badge); for(let i=0; i<24; i++) { const el=document.createElement('div'); el.className='time-label'; if (i > 0) el.innerHTML=`<span>${String(i).padStart(2,'0')}:00</span>`; col.appendChild(el); } }
Â  function renderDayRange(from, to) {
Â  Â  const track=document.getElementById('daysHeaderTrack'), grid=document.getElementById('gridColumns');
Â  Â  const weekDays=['ĞŸĞ','Ğ’Ğ¢','Ğ¡Ğ ','Ğ§Ğ¢','ĞŸĞ¢','Ğ¡Ğ‘','Ğ’Ğ¡']; const base=new Date(); base.setHours(0,0,0,0);
Â  Â  const todayStr = getLocalDateStr(new Date());
Â  Â  for(let i=from; i<=to; i++) {
Â  Â  Â  const d=new Date(base); d.setDate(d.getDate()+i); const dateStr=getLocalDateStr(d);
Â  Â  Â  let dayIdx=d.getDay()-1; if(dayIdx===-1) dayIdx=6;
Â  Â  Â  const isToday = dateStr === todayStr;
Â  Â  Â  const h=document.createElement('div'); h.className=`day-col-header ${isToday ? 'today' : ''}`; h.id=`header-${dateStr}`; h.setAttribute('data-date', dateStr);
Â  Â  Â  h.innerHTML=`<div class="dch-day">${weekDays[dayIdx]}</div><div class="dch-num">${d.getDate()}</div><div class="dch-stats" id="stat-${dateStr}"><div class="dch-stats-fill"></div></div>`;
Â  Â  Â  h.onclick=()=>openDayOptions(dateStr, `${weekDays[dayIdx]} ${d.getDate()}`); track.appendChild(h);
Â  Â  Â  const c=document.createElement('div'); c.className=`day-column ${isToday ? 'today' : ''}`; c.setAttribute('data-date', dateStr); c.setAttribute('data-day-idx', dayIdx);
Â  Â  Â  renderEventsForColumn(c, dateStr, dayIdx); attachLongPressHandler(c, d); grid.appendChild(c); updateDayStats(dateStr);
Â  Â  }
Â  }
Â  function reRenderBlocks() {
Â  Â  document.querySelectorAll('#gridColumns .day-column').forEach(col => {
Â  Â  Â  col.querySelectorAll('.blocked-slot, .day-off-overlay, .blocked-range-part').forEach(e=>e.remove());
Â  Â  Â  const dateStr=col.getAttribute('data-date'), dayIdx=parseInt(col.getAttribute('data-day-idx'));
Â  Â  Â  (availabilityPattern[dayIdx]||[]).forEach(h=>{ const b=document.createElement('div'); b.className='blocked-slot'; b.style.top=`${h*GRID_H}px`; col.appendChild(b); });
Â  Â  Â  if(dateExceptions[dateStr]==='off') { const o=document.createElement('div'); o.className='day-off-overlay'; col.appendChild(o); } else {
Â  Â  Â  Â  const cS=new Date(dateStr+'T00:00:00').getTime(), cE=new Date(dateStr+'T23:59:59').getTime();
Â  Â  Â  Â  specialRanges.forEach(r=>{
Â  Â  Â  Â  Â  const rS=new Date(r.start).getTime(), rE=new Date(r.end).getTime(); const oS=Math.max(cS,rS), oE=Math.min(cE,rE);
Â  Â  Â  Â  Â  if(oS<oE) {
Â  Â  Â  Â  Â  Â  if(oS<=cS && oE>=cE-60000) { if(!col.querySelector('.day-off-overlay')) { const o=document.createElement('div'); o.className='day-off-overlay'; col.appendChild(o); } }
Â  Â  Â  Â  Â  Â  else { const top=(oS-cS)/3600000*GRID_H, h=(oE-oS)/3600000*GRID_H; const p=document.createElement('div'); p.className='blocked-range-part'; p.style.top=`${top}px`; p.style.height=`${h}px`; col.appendChild(p); }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â  renderEventsForColumn(col, dateStr, dayIdx); updateDayStats(dateStr);
Â  Â  });
Â  }
Â  function updateAllDayStats() { document.querySelectorAll('.day-col-header').forEach(h => { updateDayStats(h.getAttribute('data-date')); }); }
Â  function updateDayStats(dateStr) {
Â  Â  const track = document.getElementById(`stat-${dateStr}`); if (!track) return;
Â  Â  const dayDate = new Date(dateStr); let dayIdx = dayDate.getDay() - 1; if (dayIdx === -1) dayIdx = 6;
Â  Â  let blockedIntervals = []; const pat = availabilityPattern[dayIdx] || [];
Â  Â  pat.forEach(h => { blockedIntervals.push([h * 60, (h + 1) * 60]); });
Â  Â  specialRanges.forEach(r => { const rS = new Date(r.start).getTime(); const rE = new Date(r.end).getTime(); const dayStart = new Date(dateStr + 'T00:00:00').getTime(); const dayEnd = new Date(dateStr + 'T23:59:59').getTime(); const s = Math.max(dayStart, rS), e = Math.min(dayEnd, rE); if (s < e) { blockedIntervals.push([Math.floor((s - dayStart) / 60000), Math.floor((e - dayStart) / 60000)]); } });
Â  Â  let totalBlocked = 0; blockedIntervals.forEach(iv => totalBlocked += (iv[1] - iv[0])); // Simple calc, assuming no overlap for simplicity or fixed by previous sort
Â  Â  let totalWorkingMinutes = 1440 - totalBlocked;
Â  Â  if (dateExceptions[dateStr] === 'off') { track.style.display = 'none'; return; }
Â  Â  let busyIntervals = [];
Â  Â  sessions.filter(s => s.dateStr === dateStr && s.status !== 'cancelled').forEach(s => { const [h1, m1] = s.start.split(':').map(Number); const [h2, m2] = s.end.split(':').map(Number); busyIntervals.push([h1 * 60 + m1, h2 * 60 + m2]); });
Â  Â  clients.forEach(client => { const daySched = client.schedule?.[dayIdx]; if (daySched) { daySched.forEach(slot => { const existsOrCancelled = sessions.some(s => s.client === client.name && s.dateStr === dateStr && s.start === slot.s); if (!existsOrCancelled) { const [h1, m1] = slot.s.split(':').map(Number); const [h2, m2] = slot.e.split(':').map(Number); busyIntervals.push([h1 * 60 + m1, h2 * 60 + m2]); } }); } });
Â  Â  busyIntervals.sort((a, b) => a[0] - b[0]); let mergedBusy = [];
Â  Â  if (busyIntervals.length > 0) { let curr = busyIntervals[0]; for (let i = 1; i < busyIntervals.length; i++) { if (busyIntervals[i][0] < curr[1]) { curr[1] = Math.max(curr[1], busyIntervals[i][1]); } else { mergedBusy.push(curr); curr = busyIntervals[i]; } } mergedBusy.push(curr); }
Â  Â  let totalBusyMinutes = 0; mergedBusy.forEach(iv => totalBusyMinutes += (iv[1] - iv[0]));
Â  Â  if (totalBusyMinutes === 0) { track.style.display = 'none'; track.classList.remove('has-data'); return; }
Â  Â  track.style.display = 'flex'; track.classList.add('has-data');
Â  Â  let percent = totalWorkingMinutes > 0 ? (totalBusyMinutes / totalWorkingMinutes) * 100 : 100;
Â  Â  const fill = track.querySelector('.dch-stats-fill');
Â  Â  fill.style.width = `${Math.min(100, percent)}%`;
Â  Â  fill.style.background = (totalBusyMinutes > totalWorkingMinutes) ? 'var(--acc-red)' : 'var(--acc-current)';
Â  }
Â  function renderEventsForColumn(col, dateStr, dayIdx) {
Â  Â  col.querySelectorAll('.event-card').forEach(e=>e.remove());
Â  Â  sessions.filter(s=>s.dateStr===dateStr && s.status !== 'cancelled').forEach(s => { if (isClientMode) { const cli = clients.find(c => c.name === s.client); const sClientId = cli ? cli.id : -1; if (sClientId === simulatedClientId) { col.appendChild(createEventEl(s)); } else { col.appendChild(createBusyEl(s)); } } else { col.appendChild(createEventEl(s)); } });
Â  Â  clients.forEach(client => { const daySched = client.schedule?.[dayIdx]; if(daySched) { daySched.forEach(slot => { const existsOrCancelled = sessions.some(s => s.client === client.name && s.dateStr === dateStr && s.start === slot.s); if(!existsOrCancelled) { const ghost = { id: `ghost-${client.id}-${dateStr}-${slot.s}`, client: client.name, dateStr: dateStr, start: slot.s, end: slot.e, type: 'client', status: 'ghost', clientId: client.id, linkedPatternSlot: { dayIdx, s: slot.s, e: slot.e } }; if (isClientMode) { if (client.id === simulatedClientId) { col.appendChild(createEventEl(ghost)); } } else { col.appendChild(createEventEl(ghost)); } } }); } });
Â  }
Â  function createBusyEl(s) { const [h,m]=s.start.split(':').map(Number); const [hE,mE]=s.end.split(':').map(Number); const top=(h*60+m)/60*GRID_H, height=(hE*60+mE-(h*60+m))/60*GRID_H; const div=document.createElement('div'); div.className=`event-card client-view-busy`; div.style.top=`${top}px`; div.style.height=`${Math.max(height,20)}px`; return div; }
Â  function createEventEl(s) { const [h,m]=s.start.split(':').map(Number); const [hE,mE]=s.end.split(':').map(Number); const top=(h*60+m)/60*GRID_H, height=(hE*60+mE-(h*60+m))/60*GRID_H; const div=document.createElement('div'); div.className=`event-card ${s.status||''}`; div.style.top=`${top}px`; div.style.height=`${Math.max(height,20)}px`; const cli = clients.find(c => c.name === s.client); const color = cli ? cli.color : '#0a84ff'; div.style.borderLeftColor = color; div.style.backgroundColor = hexToRgba(color, 0.85); if(s.status === 'ghost') { div.style.borderWidth = '1px'; div.style.borderLeftWidth = '3px'; } if(s.linkedPatternSlot) { div.innerHTML=`<div class="ev-title">${s.client}</div><div class="ev-time">${s.start} - ${s.end}</div><svg class="ev-recurring-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>`; } else { div.innerHTML=`<div class="ev-title">${s.client}</div><div class="ev-time">${s.start} - ${s.end}</div>`; } div.onclick=(e)=>{ e.stopPropagation(); if(s.status === 'ghost') confirmGhost(s); else openEdit(s); }; return div; }
Â  function confirmGhost(ghost) { const realSession = { id: Date.now(), client: ghost.client, dateStr: ghost.dateStr, start: ghost.start, end: ghost.end, note: '', status: 'planned', type: 'client', linkedPatternSlot: ghost.linkedPatternSlot }; if (isClientMode) { const val = validateAppointment(realSession.dateStr, realSession.start, realSession.end); if(!val.valid) { showToast(val.msg, true); return; } } openEdit(realSession); }
Â  function attachLongPressHandler(element, dateObj) { let startY = 0; let feedbackTimer = null; let actionTimer = null; let feedbackEl = null; const cleanup = () => { clearTimeout(feedbackTimer); clearTimeout(actionTimer); if(feedbackEl) { feedbackEl.remove(); feedbackEl = null; } }; const startHandler = (e) => { if(e.target.closest('.event-card')) return; isScrolling = false; startY = (e.touches ? e.touches[0].clientY : e.clientY); feedbackTimer = setTimeout(() => { if(isScrolling) return; const rect = element.getBoundingClientRect(); const offsetY = startY - rect.top; const hour = Math.floor(offsetY / GRID_H); if(navigator.vibrate) navigator.vibrate(10); feedbackEl = document.createElement('div'); feedbackEl.className = 'touch-feedback'; feedbackEl.style.top = (hour * GRID_H) + 'px'; feedbackEl.style.height = GRID_H + 'px'; element.appendChild(feedbackEl); }, 150); actionTimer = setTimeout(() => { if(!isScrolling) { if(window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('medium'); else if (navigator.vibrate) navigator.vibrate(50); const rect = element.getBoundingClientRect(); const offsetY = startY - rect.top; const hour = Math.floor(offsetY / GRID_H); cleanup(); const setD = new Date(dateObj); setD.setHours(hour, 0); openAddSession(setD); } }, 600); }; const moveHandler = (e) => { const currentY = (e.touches ? e.touches[0].clientY : e.clientY); if (Math.abs(currentY - startY) > 10) { isScrolling = true; cleanup(); } }; element.addEventListener('touchstart', startHandler, {passive: true}); element.addEventListener('touchmove', moveHandler, {passive: true}); element.addEventListener('touchend', cleanup); element.addEventListener('mousedown', startHandler); element.addEventListener('mousemove', moveHandler); element.addEventListener('mouseup', cleanup); }
Â  function cancelLongPress() { if(longPressTimer) clearTimeout(longPressTimer); if(activeTouchEl) { activeTouchEl.remove(); activeTouchEl = null; } }
Â  function handleInfiniteScroll() { const vp=document.getElementById('matrixViewport'); const sl=vp.scrollLeft, sw=vp.scrollWidth, cw=vp.clientWidth; if(sw-(sl+cw)<300) { const old=endOffset; endOffset+=14; renderDayRange(old+1, endOffset); reRenderBlocks(); } if(sl<300) { const old=startOffset; startOffset-=14; prependDays(startOffset, old-1); vp.scrollLeft+=(14*65); reRenderBlocks(); } }
Â  function prependDays(from, to) { const track=document.getElementById('daysHeaderTrack'), grid=document.getElementById('gridColumns'); const weekDays=['ĞŸĞ','Ğ’Ğ¢','Ğ¡Ğ ','Ğ§Ğ¢','ĞŸĞ¢','Ğ¡Ğ‘','Ğ’Ğ¡']; const base=new Date(); base.setHours(0,0,0,0); const todayStr = getLocalDateStr(new Date()); const fragH=document.createDocumentFragment(), fragC=document.createDocumentFragment(); for(let i=from; i<=to; i++) { const d=new Date(base); d.setDate(d.getDate()+i); const dateStr=getLocalDateStr(d); let dayIdx=d.getDay()-1; if(dayIdx===-1) dayIdx=6; const isToday = dateStr === todayStr; const h=document.createElement('div'); h.className=`day-col-header ${isToday ? 'today' : ''}`; h.id=`header-${dateStr}`; h.setAttribute('data-date', dateStr); h.innerHTML=`<div class="dch-day">${weekDays[dayIdx]}</div><div class="dch-num">${d.getDate()}</div><div class="dch-stats" id="stat-${dateStr}"><div class="dch-stats-fill"></div></div>`; h.onclick=()=>openDayOptions(dateStr, `${weekDays[dayIdx]} ${d.getDate()}`); fragH.appendChild(h); const c=document.createElement('div'); c.className=`day-column ${isToday ? 'today' : ''}`; c.setAttribute('data-date', dateStr); c.setAttribute('data-day-idx', dayIdx); renderEventsForColumn(c, dateStr, dayIdx); attachLongPressHandler(c, d); fragC.appendChild(c); updateDayStats(dateStr); } track.insertBefore(fragH, track.firstChild); grid.insertBefore(fragC, grid.querySelector('.day-column')); }
Â  function openAddSession(d) { editingId=null; editingLinkedPattern=null; populateClientSelect(); document.getElementById('sheetTitle').textContent='ĞĞ¾Ğ²Ğ°Ñ'; document.getElementById('btnDelete').style.display='none'; document.getElementById('patternInfoBox').style.display='none'; document.getElementById('recurringOptionContainer').style.display = 'flex'; document.getElementById('inpRecurring').checked = false; document.getElementById('inpDate').value=getLocalDateStr(d); updateDateDisplay(); const h=d.getHours(); document.getElementById('inpStart').value=`${String(h).padStart(2,'0')}:00`; document.getElementById('inpEnd').value=`${String(h+1).padStart(2,'0')}:00`; openSheet('sessionSheet'); }
Â  function openEdit(s) { editingId=s.id; editingLinkedPattern = s.linkedPatternSlot || null; populateClientSelect(); const isNew = !sessions.some(sess => sess.id === s.id); document.getElementById('sheetTitle').textContent = isNew ? 'ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ' : 'Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ'; if (!isNew || editingLinkedPattern) { document.getElementById('btnDelete').style.display = 'block'; } else { document.getElementById('btnDelete').style.display = 'none'; } const pBox = document.getElementById('patternInfoBox'); const rOption = document.getElementById('recurringOptionContainer'); if (editingLinkedPattern) { pBox.style.display = 'flex'; pBox.querySelector('.pib-text').textContent = "Ğ§Ğ°ÑÑ‚ÑŒ Ñ€ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğ³Ğ¾ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ."; rOption.style.display = 'none'; } else { pBox.style.display = 'none'; rOption.style.display = 'flex'; document.getElementById('inpRecurring').checked = false; } document.getElementById('inpClient').value=s.client; const isKnownClient = clients.some(c => c.name === s.client); if (!isKnownClient && s.client) { document.getElementById('inpClient').value = '_new_'; const inpNew = document.getElementById('inpNewClient'); inpNew.style.display = 'block'; inpNew.value = s.client; } else { document.getElementById('inpNewClient').style.display = 'none'; } document.getElementById('inpDate').value=s.dateStr; document.getElementById('inpStart').value=s.start; document.getElementById('inpEnd').value=s.end; document.getElementById('inpNote').value=s.note||''; updateDateDisplay(); openSheet('sessionSheet'); }
Â  function updateDateDisplay() { const val = document.getElementById('inpDate').value; const disp = document.getElementById('dateDisplay'); if (!val) { disp.textContent = ''; return; } const d = new Date(val); const options = { weekday: 'long', month: 'long', day: 'numeric' }; disp.textContent = d.toLocaleDateString('ru-RU', options); }
Â  function openActionSheet(type) { const sheet = document.getElementById('actionSheet'); const overlay = document.getElementById('actionSheetOverlay'); const title = document.getElementById('asTitle'); const btnOne = document.getElementById('asBtnOne'); const btnSeries = document.getElementById('asBtnSeries'); overlay.classList.add('active'); sheet.classList.add('open'); if (type === 'save') { title.textContent = "Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ÑÑÑ‰ĞµĞ³Ğ¾ÑÑ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ"; btnOne.textContent = "Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ ÑÑ‚Ğ° Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°"; btnOne.className = "as-button"; btnOne.onclick = () => { closeActionSheet(); commitSave(tempSessionData, false); }; btnSeries.textContent = "Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ²ÑÑ ÑĞµÑ€Ğ¸Ñ"; btnSeries.className = "as-button bold"; btnSeries.onclick = () => { closeActionSheet(); commitSave(tempSessionData, true); }; } else if (type === 'delete') { title.textContent = "Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ"; btnOne.textContent = "Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ ÑÑ‚Ñƒ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºÑƒ"; btnOne.className = "as-button danger"; btnOne.onclick = () => { closeActionSheet(); commitDelete(false); }; btnSeries.textContent = "Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¸Ğ· Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ"; btnSeries.className = "as-button danger bold"; btnSeries.onclick = () => { closeActionSheet(); commitDelete(true); }; } }
Â  function closeActionSheet() { document.getElementById('actionSheet').classList.remove('open'); document.getElementById('actionSheetOverlay').classList.remove('active'); }
Â  function updateClientPattern(clientName, oldSlot, newData) { const client = clients.find(c => c.name === clientName); if (!client) return; if (oldSlot && client.schedule && client.schedule[oldSlot.dayIdx]) { const arr = client.schedule[oldSlot.dayIdx]; const idx = arr.findIndex(sl => sl.s === oldSlot.s && sl.e === oldSlot.e); if (idx !== -1) arr.splice(idx, 1); } if (newData) { const newD = new Date(newData.dateStr); let newDayIdx = newD.getDay() - 1; if(newDayIdx === -1) newDayIdx = 6; if (!client.schedule[newDayIdx]) client.schedule[newDayIdx] = []; client.schedule[newDayIdx].push({ s: newData.start, e: newData.end }); } }
Â  function scrollToToday() { const today = getLocalDateStr(new Date()); const el = document.getElementById('header-' + today); const vp = document.getElementById('matrixViewport'); if(el && vp) { const vpW = vp.clientWidth; const elLeft = el.offsetLeft; const elW = el.offsetWidth; vp.scrollLeft = elLeft - (vpW / 2) + (elW / 2); vp.scrollTop = 12 * GRID_H - (vp.clientHeight / 2); } }
Â  function onScroll() { const vp=document.getElementById('matrixViewport'), headers=document.querySelectorAll('.day-col-header'); for(let h of headers) if(h.offsetLeft>=vp.scrollLeft) { const d=new Date(h.getAttribute('data-date')); document.getElementById('headerMonth').textContent=`${d.toLocaleString('ru',{month:'long'}).toUpperCase()} ${d.getFullYear()}`; break; } }
Â  function openClientsSheet() { closeAllSheets(); renderClientsList(); openSheet('clientsSheet'); }
Â  function renderClientsList() { const cont = document.getElementById('clientsListContainer'); cont.innerHTML = ''; clients.forEach(c => { const el = document.createElement('div'); el.className='client-list-item'; el.innerHTML = `<div class="color-dot" style="background:${c.color}"></div><div class="client-name">${c.name}</div>`; el.onclick = () => openClientEdit(c); cont.appendChild(el); }); }
Â  function openClientEdit(client = null) { closeAllSheets(); editingClient = client ? JSON.parse(JSON.stringify(client)) : { id: Date.now(), name: '', color: colorPalette[0], schedule: {} }; document.getElementById('ceTitle').textContent = client ? 'Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ' : 'ĞĞ¾Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ¸ĞµĞ½Ñ‚'; document.getElementById('ceName').value = editingClient.name; document.getElementById('ceColor').value = editingClient.color; renderColorGrid(); renderClientSchedule(); openSheet('clientEditSheet'); }
Â  function renderColorGrid() { const grid = document.getElementById('ceColorGrid'); grid.innerHTML = ''; colorPalette.forEach(c => { const d = document.createElement('div'); d.className = `color-option ${editingClient.color === c ? 'selected' : ''}`; d.style.backgroundColor = c; d.onclick = () => { editingClient.color = c; renderColorGrid(); }; grid.appendChild(d); }); }
Â  function renderClientSchedule() { const cont = document.getElementById('ceScheduleContainer'); cont.innerHTML = ''; const days = ['ĞŸĞ½', 'Ğ’Ñ‚', 'Ğ¡Ñ€', 'Ğ§Ñ‚', 'ĞŸÑ‚', 'Ğ¡Ğ±', 'Ğ’Ñ']; days.forEach((dName, idx) => { const row = document.createElement('div'); row.className = 'sched-row'; const slots = editingClient.schedule[idx] || []; let slotsHtml = slots.map((s, sIdx) => `<div class="sched-chip" style="background:${editingClient.color}; color:${getContrastYIQ(editingClient.color)}" onclick="removeClientSlot(${idx}, ${sIdx})">${s.s}-${s.e} Ã—</div>`).join(''); row.innerHTML = `<div class="sched-day">${dName}</div><div class="sched-slots">${slotsHtml}<div class="sched-add" onclick="addClientSlot(${idx})">+</div></div>`; cont.appendChild(row); }); }
Â  function addClientSlot(dayIdx) { editingDayIdx = dayIdx; openSheet('timeSlotSheet'); }
Â  function removeClientSlot(dayIdx, slotIdx) { editingClient.schedule[dayIdx].splice(slotIdx, 1); renderClientSchedule(); }
Â  function closeTimeSlotSheet() { document.getElementById('timeSlotSheet').classList.remove('open'); }
Â  function confirmTimeSlot() { const s = document.getElementById('tsStart').value; const e = document.getElementById('tsEnd').value; if(!editingClient.schedule[editingDayIdx]) editingClient.schedule[editingDayIdx] = []; checkScheduleConflict(editingDayIdx, s, e); editingClient.schedule[editingDayIdx].push({s, e}); closeTimeSlotSheet(); renderClientSchedule(); }
Â  function checkScheduleConflict(dayIdx, start, end) { const blockedHours = availabilityPattern[dayIdx] || []; if(blockedHours.length === 0) return; const [h1, m1] = start.split(':').map(Number); const [h2, m2] = end.split(':').map(Number); const startMins = h1 * 60 + m1; const endMins = h2 * 60 + m2; let hasConflict = false; for(let h of blockedHours) { const bStart = h * 60; const bEnd = (h + 1) * 60; if (Math.max(startMins, bStart) < Math.min(endMins, bEnd)) { hasConflict = true; break; } } if(hasConflict) { showToast("ĞĞ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚Ğµ Ğ²Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ: Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ Ğ²Ñ‹ Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚Ğµ Ğ² ÑÑ‚Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ"); } }
Â  function validateAppointment(dateStr, start, end, excludeId = null) { const [h1, m1] = start.split(':').map(Number); const [h2, m2] = end.split(':').map(Number); const startMins = h1 * 60 + m1; const endMins = h2 * 60 + m2; const dayIdx = new Date(dateStr).getDay()-1 === -1 ? 6 : new Date(dateStr).getDay()-1; const blockedHours = availabilityPattern[dayIdx] || []; for(let h of blockedHours) { const bStart = h * 60; const bEnd = (h + 1) * 60; if (Math.max(startMins, bStart) < Math.min(endMins, bEnd)) return { valid: false, msg: "Ğ­Ñ‚Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ (Ğ½ĞµÑ€Ğ°Ğ±Ğ¾Ñ‡ĞµĞµ)" }; } for (let s of sessions) { if (s.dateStr !== dateStr) continue; if (excludeId && s.id === excludeId) continue; const [sH1, sM1] = s.start.split(':').map(Number); const [sH2, sM2] = s.end.split(':').map(Number); const sStart = sH1 * 60 + sM1; const sEnd = sH2 * 60 + sM2; if (Math.max(startMins, sStart) < Math.min(endMins, sEnd)) return { valid: false, msg: "Ğ­Ñ‚Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ ÑƒĞ¶Ğµ Ğ·Ğ°Ğ½ÑÑ‚Ğ¾" }; } return { valid: true }; }
Â  function showToast(msg, isSuccess = false) { const t = document.getElementById('toast'); t.className = 'toast-notification ' + (isSuccess ? 'success' : ''); document.getElementById('toastTitle').textContent = isSuccess ? "Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾" : "ĞĞ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚Ğµ Ğ²Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ"; document.getElementById('toastMessage').textContent = msg; t.classList.add('show'); setTimeout(() => { t.classList.remove('show'); }, 3500); }
Â  function populateClientSelect() { const sel = document.getElementById('inpClient'); sel.innerHTML = ''; clients.forEach(c => { const opt = document.createElement('option'); opt.value = c.name; opt.textContent = c.name; sel.appendChild(opt); }); const optNew = document.createElement('option'); optNew.value = '_new_'; optNew.textContent = '+ ĞĞ¾Ğ²Ñ‹Ğ¹ / Ğ“Ğ¾ÑÑ‚ÑŒ'; optNew.style.fontWeight = 'bold'; optNew.style.color = 'var(--acc-green)'; sel.appendChild(optNew); }
Â  function onClientSelectChange() { const sel = document.getElementById('inpClient'); const inpNew = document.getElementById('inpNewClient'); if (sel.value === '_new_') { inpNew.style.display = 'block'; inpNew.focus(); } else { inpNew.style.display = 'none'; } }
Â  function openDayOptions(d,t){selectedDayForOptions=d;document.getElementById('dayOptionsTitle').textContent=t;openSheet('dayOptionsSheet');}
Â  function openSettings(){openSheet('settingsSheet');}
Â  function openSheet(id){document.getElementById('overlay').classList.add('active');document.getElementById(id).classList.add('open');}
Â  function closeAllSheets(){document.getElementById('overlay').classList.remove('active');document.querySelectorAll('.sheet').forEach(s=>s.classList.remove('open'));}
Â  function toggleClientMode() { isClientMode = !isClientMode; const btn = document.getElementById('btnToggleClientMode'); btn.textContent = isClientMode ? "Ğ“Ğ»Ğ°Ğ·Ğ°Ğ¼Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°: Ğ’ĞšĞ›" : "Ğ“Ğ»Ğ°Ğ·Ğ°Ğ¼Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°: Ğ’Ğ«ĞšĞ›"; btn.style.background = isClientMode ? 'var(--acc-green)' : 'rgba(255,255,255,0.1)'; btn.style.color = isClientMode ? '#000' : '#fff'; reRenderBlocks(); closeAllSheets(); showToast(isClientMode ? "Ğ ĞµĞ¶Ğ¸Ğ¼ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° Ğ²ĞºĞ»ÑÑ‡ĞµĞ½" : "Ğ ĞµĞ¶Ğ¸Ğ¼ Ñ‚Ñ€ĞµĞ½ĞµÑ€Ğ° Ğ²ĞºĞ»ÑÑ‡ĞµĞ½"); }
Â  function openRangesSheet(){closeAllSheets();resetRangeForm();renderRangesList();openSheet('rangesSheet');}
Â  function resetRangeForm(){editingRangeIndex=null;document.getElementById('rangeStartDate').value='';document.getElementById('rangeStartTime').value='00:00';document.getElementById('rangeEndDate').value='';document.getElementById('rangeEndTime').value='23:59';document.getElementById('rangeSubmitBtn').textContent='Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´';}
Â  function addRange(){ const dS=document.getElementById('rangeStartDate').value, tS=document.getElementById('rangeStartTime').value; const dE=document.getElementById('rangeEndDate').value, tE=document.getElementById('rangeEndTime').value; if(!dS||!tS||!dE||!tE)return alert('Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ²ÑĞµ Ğ¿Ğ¾Ğ»Ñ'); const start=`${dS}T${tS}`, end=`${dE}T${tE}`; if(start>=end)return alert('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ°Ñ‚'); const nr={start,end}; if(editingRangeIndex!==null)specialRanges[editingRangeIndex]=nr; else specialRanges.push(nr); resetRangeForm(); renderRangesList(); reRenderBlocks(); syncSettings(); }
Â  function editRange(i){const r=specialRanges[i]; editingRangeIndex=i; const [d1,t1]=r.start.split('T'), [d2,t2]=r.end.split('T'); document.getElementById('rangeStartDate').value=d1; document.getElementById('rangeStartTime').value=t1.substring(0,5); document.getElementById('rangeEndDate').value=d2; document.getElementById('rangeEndTime').value=t2.substring(0,5); document.getElementById('rangeSubmitBtn').textContent='Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ';}
Â  function deleteRange(i){specialRanges.splice(i,1); if(editingRangeIndex===i) resetRangeForm(); renderRangesList(); reRenderBlocks(); syncSettings(); }
Â  function openPatternEditor(){closeAllSheets();document.getElementById('patternEditor').classList.add('open');renderPatternEditor();}
Â  function closePatternEditor(){document.getElementById('patternEditor').classList.remove('open');}Â 
Â  function renderPatternEditor(){ const t=document.getElementById('peTimeColumn'); t.innerHTML=''; for(let i=0;i<24;i++){const e=document.createElement('div');e.className='time-label'; if(i > 0) e.innerHTML=`<span>${String(i).padStart(2,'0')}:00</span>`;e.onclick=()=>toggleRowPattern(i);t.appendChild(e);} const h=document.getElementById('peHeaderTrack'); h.innerHTML=''; const w=['ĞŸĞ','Ğ’Ğ¢','Ğ¡Ğ ','Ğ§Ğ¢','ĞŸĞ¢','Ğ¡Ğ‘','Ğ’Ğ¡']; for(let i=0;i<7;i++){const e=document.createElement('div');e.className='day-col-header';e.innerHTML=`<div class="dch-day" style="margin-top:16px">${w[i]}</div>`;e.onclick=()=>toggleColPattern(i);h.appendChild(e);} const g=document.getElementById('peGridColumns'); g.innerHTML=''; for(let i=0;i<7;i++){const c=document.createElement('div');c.className='day-column';c.onclick=(e)=>{if(e.target!==c)return;toggleSinglePattern(i,Math.floor(e.offsetY/GRID_H));};renderPCol(c,i);g.appendChild(c);} }
Â  function renderPCol(c,d){c.innerHTML='';(availabilityPattern[d]||[]).forEach(x=>{const b=document.createElement('div');b.className='blocked-slot';b.style.top=`${x*GRID_H}px`;b.onclick=(e)=>{e.stopPropagation();toggleSinglePattern(d,x);};c.appendChild(b);});}
Â  function toggleSinglePattern(d,h){const a=availabilityPattern[d],i=a.indexOf(h);if(i===-1)a.push(h);else a.splice(i,1);renderPCol(document.getElementById('peGridColumns').children[d],d);}
Â  function toggleRowPattern(h){let all=true;for(let d=0;d<7;d++)if(!availabilityPattern[d].includes(h)){all=false;break;} for(let d=0;d<7;d++){const a=availabilityPattern[d],i=a.indexOf(h);if(all&&i!==-1)a.splice(i,1);if(!all&&i===-1)a.push(h);} const g=document.getElementById('peGridColumns');for(let d=0;d<7;d++)renderPCol(g.children[d],d);}
Â  function toggleColPattern(d){const a=availabilityPattern[d];if(a.length===24)availabilityPattern[d]=[];else availabilityPattern[d]=Array.from({length:24},(_,i)=>i);renderPCol(document.getElementById('peGridColumns').children[d],d);}
Â  function startClock(){updateClock();if(updateInterval)clearInterval(updateInterval);updateInterval=setInterval(updateClock,60000);}
Â  function updateClock(){const n=new Date(),l=document.getElementById('globalTimeLine'),b=document.getElementById('timeLineBadge'),px=(n.getHours()*60+n.getMinutes())/60*GRID_H;l.style.top=`${px}px`;l.style.display='block';b.textContent=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;b.style.display='block';b.style.top=`${px}px`;}

Â  document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
