<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Ultima Coach Infinite</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  /* === CORE STYLES === */
  :root {
    --bg-core: #050505; 
    --bg-panel: #1C1C1E; 
    --bg-elevated: #2C2C2E;
    --text-main: #ffffff;
    --text-muted: #8E8E93;
    
    --line-color: rgba(255, 255, 255, 0.08);
    --time-col-width: 55px;
    --day-col-width: 65px; 
    
    --acc-blue: #0a84ff;
    --acc-red: #ff453a;
    --acc-green: #30d158;
    --acc-purple: #5e60ce;
    --acc-orange: #ff9f0a;
    --acc-current: #3c9cfd;
    
    --grid-h: 60px;
    --safe-top: env(safe-area-inset-top);
    --safe-bottom: env(safe-area-inset-bottom);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
  *::-webkit-scrollbar { display: none; }

  body {
    background-color: var(--bg-core);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', Roboto, sans-serif;
    color: var(--text-main);
    height: 100%; width: 100%;
    overflow: hidden; position: fixed; inset: 0; user-select: none;
    -webkit-user-select: none;
  }

  /* === FX LAYER === */
  .fx-layer { position: absolute; inset: 0; z-index: 0; pointer-events: none; }
  .orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.5; will-change: transform; }
  .orb-1 { width: 300px; height: 300px; background: var(--acc-purple); top: -50px; left: -100px; animation: float 20s infinite ease-in-out; }
  .orb-2 { width: 250px; height: 250px; background: var(--acc-blue); bottom: -50px; right: -50px; animation: float 15s infinite ease-in-out reverse; }
  .noise { position: fixed; inset: 0; opacity: 0.04; background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); }
  @keyframes float { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(30px, 50px); } }

  /* === LAYOUT === */
  .app-container { display: flex; flex-direction: column; height: 100%; width: 100%; position: relative; z-index: 1; }

  /* === TOP HEADER === */
  .top-area {
    position: relative;
    background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--line-color); padding-top: calc(10px + var(--safe-top)); padding-bottom: 4px;
    z-index: 60; flex-shrink: 0;
  }
  .header-row { display: flex; justify-content: space-between; align-items: center; padding: 0 16px; margin-bottom: 10px; }
  .month-label { font-family: 'SF Pro Display', sans-serif; font-size: 15px; font-weight: 700; color: #fff; text-transform: uppercase; letter-spacing: 1px; }
  .week-controls { display: flex; gap: 16px; align-items: center; }
  .icon-btn { width: 32px; height: 32px; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s opacity; }
  .icon-btn:active { opacity: 0.6; }

  /* === MATRIX === */
  .matrix-viewport {
    flex: 1; overflow: auto; position: relative; -webkit-overflow-scrolling: touch; overscroll-behavior: none;
    display: flex; flex-direction: column; z-index: 10;
  }
  .matrix-header-row {
    display: flex; position: sticky; top: 0; z-index: 40; width: max-content; background: rgba(0, 0, 0, 0.25);
    backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-bottom: 1px solid var(--line-color);
  }
  .corner-cell { width: var(--time-col-width); flex-shrink: 0; position: sticky; left: 0; z-index: 50; background: inherit; border-right: 1px solid var(--line-color); }
  .days-header-track { display: flex; flex: 1; }
  .day-col-header {
    width: var(--day-col-width); flex-shrink: 0; text-align: center; height: 58px; 
    padding: 8px 0 0 0;
    font-size: 11px; color: var(--text-muted); border-right: 1px solid var(--line-color);
    display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
    gap: 2px; position: relative; cursor: pointer;
  }
  .dch-day { font-weight: 600; text-transform: uppercase; line-height: 1; }
  .dch-num { font-size: 16px; font-weight: 500; color: #fff; line-height: 1; }
  
  .day-col-header.today { background: rgba(10, 132, 255, 0.15); border-bottom: 2px solid var(--acc-blue); }
  .day-col-header.today .dch-day { color: var(--acc-blue); }
  .day-col-header.today .dch-num { color: #fff; font-weight: 700; }

  /* UPDATED STATS BAR */
  .dch-stats { 
    width: 44px; height: 4px; 
    background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 4px; 
    overflow: hidden; display: flex; 
  }
  .day-col-header.today .dch-stats { background: rgba(255,255,255,0.2); }
  .dch-stats-fill { height: 100%; background: var(--acc-current); width: 0%; transition: width 0.3s ease, background 0.3s ease; }
  .dch-stats.has-data .dch-stats-fill { min-width: 6px; }
  
  .matrix-body { display: flex; width: max-content; position: relative; }
  .time-column {
    width: var(--time-col-width); flex-shrink: 0; position: sticky; left: 0; z-index: 30;
    background: rgba(0, 0, 0, 0.25); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
    border-right: 1px solid var(--line-color); padding-bottom: 20px;
  }
  .time-label { height: var(--grid-h); position: relative; cursor: pointer; } 
  .time-label span { position: absolute; top: -7px; right: 6px; font-size: 11px; font-weight: 500; color: var(--text-muted); font-variant-numeric: tabular-nums; }
  
  .time-line-badge {
    position: absolute; right: 4px; background: var(--acc-current); color: #fff; font-size: 11px; font-weight: 700;
    padding: 2px 6px; border-radius: 4px; z-index: 31; transform: translateY(-50%); pointer-events: none;
    font-variant-numeric: tabular-nums; text-align: center; min-width: 40px; display: none;
  }
  .grid-columns-container { display: flex; flex: 1; position: relative; }
  
  .day-column {
    width: var(--day-col-width); flex-shrink: 0; border-right: 1px solid var(--line-color); position: relative;
    background-image: linear-gradient(to bottom, var(--line-color) 1px, transparent 1px); background-size: 100% var(--grid-h);
    padding-bottom: 20px; cursor: pointer;
    touch-action: pan-y; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none;
  }
  .day-column.today { background-color: rgba(10, 132, 255, 0.02); }
  
  .touch-feedback {
    position: absolute; width: 100%; background: rgba(60, 156, 253, 0.25); border-radius: 4px; pointer-events: none; z-index: 20;
    animation: pulse-create 0.6s infinite ease-in-out; border: 1px solid var(--acc-current);
    display: flex; align-items: center; justify-content: center;
  }
  .touch-feedback::after { content: '+'; font-size: 24px; font-weight: 300; color: #fff; opacity: 0.9; }
  @keyframes pulse-create { 0% { opacity: 0.3; transform: scale(0.98); } 50% { opacity: 0.7; transform: scale(1.0); } 100% { opacity: 0.3; transform: scale(0.98); } }
  
  .blocked-slot { position: absolute; left: 0; right: 0; height: var(--grid-h); background: repeating-linear-gradient(45deg, rgba(255,255,255,0.03), rgba(255,255,255,0.03) 10px, rgba(255,255,255,0.06) 10px, rgba(255,255,255,0.06) 20px); pointer-events: none; z-index: 1; }
  .blocked-range-part { position: absolute; left: 0; right: 0; background-color: var(--bg-core); background-image: repeating-linear-gradient(45deg, rgba(60, 156, 253, 0.1), rgba(60, 156, 253, 0.1) 10px, rgba(60, 156, 253, 0.2) 10px, rgba(60, 156, 253, 0.2) 20px); border-top: 1px solid rgba(60, 156, 253, 0.4); border-bottom: 1px solid rgba(60, 156, 253, 0.4); z-index: 2; pointer-events: none; }
  .day-off-overlay { position: absolute; inset: 0; background-color: var(--bg-core); background-image: repeating-linear-gradient(45deg, rgba(60, 156, 253, 0.1), rgba(60, 156, 253, 0.1) 10px, rgba(60, 156, 253, 0.2) 10px, rgba(60, 156, 253, 0.2) 20px); z-index: 8; pointer-events: none; }
  
  .global-time-line { position: absolute; left: 0; width: 100%; height: 1px; background: var(--acc-current); z-index: 10; pointer-events: none; display: none; }
  .global-time-line::before { content: ''; position: absolute; left: -4px; top: -3px; width: 7px; height: 7px; background: var(--acc-current); border-radius: 50%; }
  
  /* === EVENT CARD (UPDATED FOR OVERLAP) === */
  .event-card { 
    position: absolute; 
    left: 0; /* Dynamic left in JS */
    border-radius: 6px; 
    padding: 3px 5px; 
    overflow: hidden; 
    border-left: 3px solid; 
    cursor: pointer; 
    z-index: 5; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.3); 
    border: 1px solid rgba(255,255,255,0.1); 
    /* Animations for smooth sorting */
    transition: transform 0.1s, width 0.2s, left 0.2s; 
  }
  .event-card:active { transform: scale(0.96); }
  .event-card.ghost { opacity: 1; }
  .event-card.client-view-busy { background: repeating-linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.05) 5px, rgba(255,255,255,0.02) 5px, rgba(255,255,255,0.02) 10px); border: 1px solid rgba(255,255,255,0.05); border-left: none; color: transparent; pointer-events: none; opacity: 0.6; }
  
  .ev-title { font-size: 11px; font-weight: 700; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; text-shadow: 0 1px 3px rgba(0,0,0,0.7); }
  .ev-time { font-size: 9px; color: rgba(255,255,255,0.95); margin-top: 1px; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.7); }
  .ev-recurring-icon { position: absolute; right: 4px; bottom: 4px; opacity: 0.8; width: 8px; height: 8px; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5)); }

  /* === OVERLAYS === */
  .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(4px); }
  .sheet-overlay.active { opacity: 1; pointer-events: auto; }
  
  .sheet { 
    position: fixed; bottom: 0; left: 0; right: 0; 
    background: var(--bg-panel); 
    border-radius: 20px 20px 0 0; 
    padding: 0 16px calc(24px + var(--safe-bottom)) 16px; 
    transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); 
    z-index: 101; border-top: 1px solid rgba(255,255,255,0.1); 
    max-height: 90vh; overflow-y: auto; 
  }
  .sheet.open { transform: translateY(0); }

  /* ACTION SHEET (CONFIRMATION) */
  .action-sheet-container {
    position: fixed; bottom: 0; left: 0; right: 0; z-index: 150;
    padding: 16px; padding-bottom: calc(16px + var(--safe-bottom));
    transform: translateY(110%); transition: transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  .action-sheet-container.open { transform: translateY(0); }
  .as-group { background: rgba(30, 30, 32, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 14px; overflow: hidden; margin-bottom: 8px; }
  .as-button { width: 100%; padding: 16px; background: transparent; border: none; border-bottom: 1px solid rgba(255,255,255,0.1); color: var(--acc-blue); font-size: 17px; font-weight: 400; cursor: pointer; }
  .as-button:last-child { border-bottom: none; }
  .as-button:active { background: rgba(255,255,255,0.1); }
  .as-button.danger { color: var(--acc-red); }
  .as-button.bold { font-weight: 600; }
  .as-title { padding: 12px 16px; font-size: 13px; color: var(--text-muted); text-align: center; font-weight: 500; border-bottom: 1px solid rgba(255,255,255,0.1); }
  .as-cancel { background: var(--bg-elevated); border-radius: 14px; color: var(--acc-blue); font-weight: 600; }

  /* FORM STYLES */
  .sheet-header { display: flex; justify-content: space-between; align-items: center; margin: 0 -16px 20px -16px; position: sticky; top: 0; background: var(--bg-panel); z-index: 10; padding: 24px 16px 10px 16px; border-radius: 20px 20px 0 0; }
  .sh-title { font-size: 18px; font-weight: 700; color: #fff; }
  .sh-close { color: var(--acc-blue); font-size: 16px; font-weight: 500; cursor: pointer; }
  
  .form-group { margin-bottom: 16px; }
  .form-label { font-size: 12px; color: #8E8E93; margin-bottom: 6px; margin-left: 2px; text-transform: uppercase; }
  
  .input-box { width: 100%; background: rgba(118, 118, 128, 0.24); border: none; border-radius: 10px; padding: 12px; color: #fff; font-size: 16px; appearance: none; -webkit-appearance: none; }
  .input-box[type="date"] { color: #fff; }
  
  .input-row { display: flex; gap: 12px; }
  .btn-primary { width: 100%; padding: 14px; background: #fff; color: #000; font-weight: 600; font-size: 16px; border-radius: 12px; border: none; margin-top: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
  .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
  .btn-danger { background: rgba(255, 69, 58, 0.15); color: var(--acc-red); }
  
  /* SWITCH */
  .switch { position: relative; display: inline-block; width: 50px; height: 30px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #3a3a3c; transition: .4s; border-radius: 30px; }
  .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: var(--acc-green); }
  input:checked + .slider:before { transform: translateX(20px); }

  .pattern-info-box { background: rgba(10, 132, 255, 0.1); border: 1px solid rgba(10, 132, 255, 0.3); border-radius: 8px; padding: 10px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
  .pib-icon { color: var(--acc-blue); }
  .pib-text { font-size: 13px; color: #fff; flex: 1; line-height: 1.3; }

  /* FIXED LAYOUT SHEET for Clients */
  .sheet.fixed-layout { display: flex; flex-direction: column; height: 85vh; padding: 0; overflow: hidden; }
  .sheet.fixed-layout .sheet-header { margin: 0; padding: 20px 16px 10px 16px; flex-shrink: 0; position: relative; top: auto; }
  .sheet-fixed-section { padding: 0 16px; flex-shrink: 0; }
  .sheet-scroll-area { flex: 1; overflow-y: auto; padding: 10px 16px; -webkit-overflow-scrolling: touch; }
  .sheet-fixed-footer { padding: 16px 16px calc(16px + var(--safe-bottom)) 16px; border-top: 1px solid rgba(255,255,255,0.05); background: var(--bg-panel); flex-shrink: 0; z-index: 10; }

  /* CLIENTS */
  .client-list-item { display: flex; align-items: center; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; margin-bottom: 8px; cursor: pointer; }
  .color-dot { width: 16px; height: 16px; border-radius: 50%; margin-right: 12px; border: 2px solid rgba(255,255,255,0.1); }
  .client-name { flex: 1; font-weight: 500; }
  .color-grid { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 16px; padding: 10px 0; }
  .color-option { width: 44px; height: 44px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
  .color-option.selected { border-color: #fff; transform: scale(1.1); }
  
  /* RANGES LIST */
  .ranges-list { max-height: 200px; overflow-y: auto; margin-top: 10px; }
  .range-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 8px; }
  .range-text { font-size: 14px; color: #fff; }
  .range-sub { font-size: 12px; color: #8E8E93; margin-top: 2px; }
  .range-actions { display: flex; gap: 12px; }
  .range-icon { color: var(--text-muted); cursor: pointer; }
  .range-icon.edit { color: var(--acc-blue); }
  .range-icon.del { color: var(--acc-red); }

  /* SCHED ROWS */
  .sched-row { display: flex; align-items: center; margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 12px; }
  .sched-day { width: 40px; font-weight: 600; font-size: 14px; color: #fff; }
  .sched-slots { flex: 1; display: flex; flex-wrap: wrap; gap: 6px; }
  .sched-chip { padding: 6px 10px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
  .sched-add { background: rgba(255,255,255,0.1); color: #fff; width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; }

  /* TOAST */
  .toast-notification {
    position: fixed; top: calc(20px + var(--safe-top)); left: 16px; right: 16px;
    background: rgba(28, 28, 30, 0.9); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 16px;
    border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    z-index: 9999; 
    font-size: 14px; font-weight: 500; text-align: center;
    transform: translateY(-150%); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    pointer-events: none; opacity: 0;
  }
  .toast-notification.show { transform: translateY(0); opacity: 1; }
  .toast-notification span { color: var(--acc-red); font-weight: 700; display: block; margin-bottom: 4px; font-size: 12px; text-transform: uppercase; }
  .toast-notification.success span { color: var(--acc-green); }

  /* PATTERN EDITOR */
  .pattern-editor-overlay { position: fixed; inset: 0; background: var(--bg-core); z-index: 102; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
  .pattern-editor-overlay.open { transform: translateY(0); }
  .pe-header { background: rgba(10, 132, 255, 0.1); border-bottom: 1px solid var(--acc-blue); padding-top: calc(10px + var(--safe-top)); padding-bottom: 10px; flex-shrink: 0; }
  
  .pe-title { 
      font-size: 15px; 
      font-weight: 600; 
      color: #fff; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      flex: 1; 
  }
  
  .pe-badge { background: var(--acc-blue); padding: 2px 6px; border-radius: 4px; font-size: 10px; }
  .pattern-editor-overlay .matrix-body, .pattern-editor-overlay .matrix-header-row { width: 100%; }
  .pattern-editor-overlay .day-col-header, .pattern-editor-overlay .day-column { width: auto; flex: 1; }

  .pattern-editor-overlay .blocked-slot { 
      pointer-events: auto; 
      cursor: pointer; 
      border-top: 1px solid rgba(255,255,255,0.08); 
      border-bottom: 1px solid rgba(255,255,255,0.08); 
  }

  /* STRIPED BACKGROUND */
  .stripe-bg {
      background-image: linear-gradient(
          45deg,
          rgba(255, 255, 255, 0.03) 25%,
          transparent 25%,
          transparent 50%,
          rgba(255, 255, 255, 0.03) 50%,
          rgba(255, 255, 255, 0.03) 75%,
          transparent 75%,
          transparent
      );
      background-size: 28.28px 28.28px;
      background-repeat: repeat;
  }

  /* NOISE TEXTURE */
  .pattern-editor-overlay::before {
    content: "";
    position: absolute;
    inset: 0;
    opacity: 0.04;
    background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
  }

  .pattern-editor-overlay > * {
    position: relative;
    z-index: 2;
  }
</style>
</head>
<body oncontextmenu="return false;">

<div class="fx-layer"><div class="orb orb-1"></div><div class="orb orb-2"></div><div class="noise"></div></div>

<div class="toast-notification" id="toast">
  <span id="toastTitle">Обратите внимание</span>
  <div id="toastMessage">Обычно вы не работаете в это время</div>
</div>

<div class="app-container">
  <div class="top-area">
    <div class="header-row">
      <div class="month-label" id="headerMonth">НОЯБРЬ 2025</div>
      <div class="week-controls">
        <div class="icon-btn" id="settingsBtn" onclick="openSettings()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </div>
      </div>
    </div>
  </div>

  <div class="matrix-viewport" id="matrixViewport">
    <div class="matrix-header-row">
      <div class="corner-cell"></div>
      <div class="days-header-track" id="daysHeaderTrack"></div>
    </div>
    <div class="matrix-body">
      <div class="time-column" id="timeColumn"><div class="time-line-badge" id="timeLineBadge">00:00</div></div>
      <div class="grid-columns-container" id="gridColumns"><div class="global-time-line" id="globalTimeLine"></div></div>
    </div>
  </div>
</div>

<div class="sheet-overlay" id="overlay" onclick="closeAllSheets()"></div>

<div class="sheet-overlay" id="actionSheetOverlay" style="z-index:140" onclick="closeActionSheet()"></div>
<div class="action-sheet-container" id="actionSheet">
  <div class="as-group">
    <div class="as-title" id="asTitle">Изменение повторяющегося события</div>
    <button class="as-button" id="asBtnOne">Только эта тренировка</button>
    <button class="as-button bold" id="asBtnSeries">Вся серия</button>
  </div>
  <button class="as-button as-cancel" onclick="closeActionSheet()">Отмена</button>
</div>

<div class="pattern-editor-overlay" id="patternEditor">
<div class="header-row pe-header">
  <div class="icon-btn" onclick="closePatternEditor()" style="color: var(--acc-red); width:auto; font-size:14px; padding-left: 16px;">Отмена</div>
  <div class="pe-title">График работы</div>
  <div class="icon-btn" onclick="savePattern()" style="color: var(--acc-blue); font-weight:600; width:auto; font-size:14px;">Сохранить</div>
</div>
  <div class="matrix-viewport">
    <div class="matrix-header-row"><div class="corner-cell"></div><div class="days-header-track" id="peHeaderTrack"></div></div>
    <div class="matrix-body"><div class="time-column" id="peTimeColumn"></div><div class="grid-columns-container" id="peGridColumns"></div></div>
  </div>
</div>

<div class="sheet" id="sessionSheet">
  <div class="sheet-header"><div class="sh-title" id="sheetTitle">Тренировка</div><div class="sh-close" onclick="closeAllSheets()">Отмена</div></div>
  
  <div id="patternInfoBox" class="pattern-info-box" style="display:none">
    <div class="pib-icon">
       <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
    </div>
    <div class="pib-text">Эта тренировка — часть регулярного расписания.</div>
  </div>

  <div class="form-group">
    <div class="form-label">Клиент</div>
    <select class="input-box" id="inpClient"></select>
  </div>
  <div class="form-group">
    <div class="form-label" style="display:flex; justify-content:space-between;">Дата <span id="dateDisplay" style="color:#fff; font-weight:500;"></span></div>
    <input type="date" class="input-box" id="inpDate" onchange="updateDateDisplay()">
  </div>
  <div class="input-row">
    <div class="form-group" style="flex:1"><div class="form-label">Начало</div><input type="time" class="input-box" id="inpStart"></div>
    <div class="form-group" style="flex:1"><div class="form-label">Конец</div><input type="time" class="input-box" id="inpEnd"></div>
  </div>
  <div class="form-group"><div class="form-label">Заметка</div><input type="text" class="input-box" id="inpNote" placeholder="Тип тренировки..."></div>
  
  <div class="form-group" id="recurringOptionContainer" style="display: flex; align-items: center; gap: 12px; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; margin-bottom: 0px;">
    <div style="flex: 1; font-size: 16px;">Повторять еженедельно</div>
    <label class="switch">
      <input type="checkbox" id="inpRecurring" onchange="toggleSeriesInput()">
      <span class="slider"></span>
    </label>
  </div>
  
  <div id="seriesCountContainer" style="display: none; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 0 0 10px 10px; margin-top: 1px; margin-bottom: 16px;">
    <div class="form-label">Количество тренировок</div>
    <div class="input-row">
       <input type="number" class="input-box" id="inpSeriesCount" value="4" min="2" max="100" placeholder="Например: 4">
    </div>
    <div style="font-size: 11px; color: #8E8E93; margin-top: 6px;">
       Будет создана серия на указанное количество недель вперед.
    </div>
  </div>

  <button class="btn-primary" onclick="trySaveSession()">Сохранить</button>
  <button class="btn-primary btn-danger" id="btnDelete" style="display:none" onclick="tryDeleteSession()">Удалить</button>
</div>

<div class="sheet" id="settingsSheet">
  <div class="sheet-header"><div class="sh-title">Настройки</div><div class="sh-close" onclick="closeAllSheets()">Готово</div></div>
  <div class="form-group"><div class="form-label">График работы</div><button class="btn-primary" onclick="openPatternEditor()">Задать шаблон на 7 дней / 24 часа</button></div>
  <div class="form-group"><div class="form-label">Добавить отсутствие</div><button class="btn-primary btn-secondary" onclick="openRangesSheet()">Например отпуск</button></div>
  <div class="form-group"><div class="form-label">База клиентов</div><button class="btn-primary btn-secondary" onclick="openClientsSheet()">Просмотр клиентов</button></div>
</div>

<div class="sheet" id="rangesSheet">
  <div class="sheet-header"><div class="sh-title">Отпуск / Периоды</div><div class="sh-close" onclick="closeAllSheets()">Закрыть</div></div>
  <div class="input-row"><input type="date" class="input-box" id="rangeStartDate"><input type="time" class="input-box" id="rangeStartTime" value="00:00"></div>
  <div class="input-row" style="margin-top:8px"><input type="date" class="input-box" id="rangeEndDate"><input type="time" class="input-box" id="rangeEndTime" value="23:59"></div>
  <button class="btn-primary" id="rangeSubmitBtn" onclick="addRange()" style="margin-top:12px">Добавить период</button>
  <div class="ranges-list" id="rangesList"></div>
</div>

<div class="sheet" id="clientsSheet">
  <div class="sheet-header"><div class="sh-title">Клиенты</div><div class="sh-close" onclick="closeAllSheets()">Закрыть</div></div>
  <div id="clientsListContainer" style="margin-top:20px;"></div>
</div>

<div class="sheet" id="dayOptionsSheet">
  <div class="sheet-header"><div class="sh-title" id="dayOptionsTitle">Настройки дня</div><div class="sh-close" onclick="closeAllSheets()">Закрыть</div></div>
  <button class="btn-primary btn-danger" onclick="toggleDayOff()">Сделать выходным</button>
  <button class="btn-primary btn-secondary" onclick="clearDayOff()" style="margin-top:12px;">Сбросить</button>
</div>

<script>
  // ==============================================
  // 1. CONFIG & STATE
  // ==============================================
  const APP_VERSION = 'v9.0-BATCH-CALENDAR';
  const API_URL = 'https://script.google.com/macros/s/AKfycbxomZgF1bVeUXO0SSVReVQK-quKR85G8PG8yfr1T3R2vD1p4_W_pFdqHKNGBMaiwEffOw/exec'; 

  const GRID_H = 60;
  
  // Viewport Settings
  let startOffset = -30, endOffset = 60;
  let currentStart = getStartOfWeek(new Date());
  
  // Data Store
  const KEY_CLIENTS = 'uc_clients_v9';
  const KEY_SESSIONS = 'uc_sessions_v9';
  const KEY_SETTINGS = 'uc_settings_v9';

  let clients = [];       // Read-only from DB
  let sessions = [];      // Read/Write (Source of Truth)
  
  // Local Settings (visual only)
  let dateExceptions = {}; 
  let availabilityPattern = {0:[],1:[],2:[],3:[],4:[],5:[],6:[]}; // График работы тренера
  let specialRanges = []; // Ranges like vacation
  
  // Temp state
  let editingId = null; 
  let tempSessionData = null; // For confirming batch edits
  let updateInterval;
  let isScrolling = false;
  let selectedDayForOptions = null;

  // ==============================================
  // 2. DATA LAYER (Sync Logic)
  // ==============================================
  const DataManager = {
    getUserId() { return window.Telegram?.WebApp?.initDataUnsafe?.user?.id || 'guest'; },

    // --- LOCAL STORAGE ---
    saveLocally() {
      try {
        localStorage.setItem(KEY_CLIENTS, JSON.stringify(clients));
        localStorage.setItem(KEY_SESSIONS, JSON.stringify(sessions));
        localStorage.setItem(KEY_SETTINGS, JSON.stringify({ pattern: availabilityPattern, exceptions: dateExceptions, ranges: specialRanges }));
      } catch(e) { console.error("Local Save Error", e); }
    },

    loadLocal() {
      try {
        const c = localStorage.getItem(KEY_CLIENTS); if(c) clients = JSON.parse(c);
        const s = localStorage.getItem(KEY_SESSIONS); if(s) sessions = JSON.parse(s);
        const set = localStorage.getItem(KEY_SETTINGS);
        if(set) {
            const parsed = JSON.parse(set);
            if(parsed.pattern) availabilityPattern = parsed.pattern;
            if(parsed.exceptions) dateExceptions = parsed.exceptions;
            if(parsed.ranges) specialRanges = parsed.ranges;
        } else {
            // Default working hours: 09:00 - 21:00 (indexes 9 to 20)
            for(let i=0; i<7; i++) availabilityPattern[i] = Array.from({length:12}, (_,k)=>k+9); 
        }
      } catch(e) { console.error("Local Load Error", e); }
    },

    // --- NETWORK ---
    async fetchFromServer(action, payload = {}) {
      const tg = window.Telegram?.WebApp;
      const bodyData = { 
          action: action, 
          init_data: tg?.initData || '', 
          ...payload 
      };
      
      try {
        const resp = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
          body: JSON.stringify(bodyData)
        });
        const json = await resp.json();
        if (!json.ok) throw new Error(json.error || 'Server Error');
        return json.data;
      } catch (e) {
        console.error(`[API ${action}] Failed:`, e);
        throw e;
      }
    },

    // --- SYNC OPERATIONS ---
    
    // 1. Full Load (Init)
    async syncLoad() {
        const d = new Date();
        const m1 = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        // Load Current + Next Month
        const nextM = new Date(d); nextM.setMonth(d.getMonth() + 1);
        const m2 = `${nextM.getFullYear()}-${String(nextM.getMonth()+1).padStart(2,'0')}`;

        console.log(`[Sync] Loading ${m1}, ${m2}...`);

        const [data1, data2] = await Promise.all([
            this.fetchFromServer('init_load', { month_str: m1 }),
            this.fetchFromServer('init_load', { month_str: m2 })
        ]);

        this.mergeServerData(data1, m1);
        this.mergeServerData(data2, m2);
        this.saveLocally();
        return true;
    },

    mergeServerData(data, monthStr) {
        if(!data) return;
        
        // 1. Clients (Read Only source)
        if(data.clients && Array.isArray(data.clients)) {
            clients = data.clients;
        }

        // 2. Settings
        if(data.settings) {
            if(data.settings.pattern) availabilityPattern = data.settings.pattern;
            // TODO: Add exceptions/ranges sync if needed on backend
        }

        // 3. Calendar
        // Strategy: Clear sessions for this month from memory, replace with server data
        if(data.calendar) {
            // Remove old local sessions for this month to avoid duplicates
            sessions = sessions.filter(s => !s.dateStr.startsWith(monthStr));
            
            // Parse server format: { "1": [...], "5": [...] }
            Object.keys(data.calendar).forEach(dayKey => {
                const dayEvents = data.calendar[dayKey];
                dayEvents.forEach(evt => {
                    // Try to find client name from ID
                    const clientObj = clients.find(c => String(c.id) === String(evt.c));
                    
                    sessions.push({
                        id: evt.i,
                        clientId: evt.c,
                        client: clientObj ? clientObj.name : 'Unknown', // Fallback
                        dateStr: `${monthStr}-${dayKey.padStart(2, '0')}`,
                        start: evt.s,
                        end: evt.e,
                        status: evt.st || 'planned',
                        note: evt.n || '',
                        seriesId: evt.sid || null // Series ID if exists
                    });
                });
            });
        }
    },

    // 2. Batch Save (The main writer)
    async syncBatch(datesTouched) {
        // Prepare payload: Group sessions by date
        const uniqueDates = [...new Set(datesTouched)];
        const changes = uniqueDates.map(dateStr => {
            // Get all sessions for this date from memory
            const daySessions = sessions.filter(s => s.dateStr === dateStr && s.status !== 'deleted');
            
            // Map to minified format for DB
            const dayData = daySessions.map(s => ({
                i: s.id,
                c: s.clientId,
                s: s.start,
                e: s.end,
                st: s.status,
                n: s.note,
                sid: s.seriesId // Persist series link
            }));

            return { date: dateStr, day_data: dayData };
        });

        if(changes.length === 0) return;

        console.log(`[Sync] Pushing batch updates for ${changes.length} days`);
        await this.fetchFromServer('batch_sync', { changes });
    }
  };

  // ==============================================
  // 3. INITIALIZATION
  // ==============================================
  async function init() {
    const tg = window.Telegram?.WebApp;
    if(tg) { tg.ready(); tg.expand(); try{tg.setHeaderColor('#050505');tg.setBackgroundColor('#050505');}catch(_){} }

    // 1. Immediate Local Render
    DataManager.loadLocal();
    
    // Setup UI
    renderTimeColumn(); 
    renderDayRange(startOffset, endOffset);
    scrollToToday(); 
    startClock();
    reRenderBlocks();
    
    // Scroll Listener
    document.getElementById('matrixViewport').addEventListener('scroll', ()=>{ 
        isScrolling=true; 
        cancelLongPress(); 
        onScroll(); 
        handleInfiniteScroll(); 
    }, {passive: true});

    // 2. Background Sync
    try {
        await DataManager.syncLoad();
        reRenderBlocks(); // Re-render with fresh data
        updateAllDayStats();
        showToast("Синхронизировано", true);
    } catch (e) {
        showToast("Оффлайн режим", false);
    }
  }

  // ==============================================
  // 4. BUSINESS LOGIC (CRUD)
  // ==============================================
  
  // --- GENERATE UNIQUE ID ---
  function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 5); }

  // --- OPEN ADD/EDIT FORM ---
  function toggleSeriesInput() {
    const isChecked = document.getElementById('inpRecurring').checked;
    const container = document.getElementById('seriesCountContainer');
    container.style.display = isChecked ? 'block' : 'none';
    const toggleBlock = document.getElementById('recurringOptionContainer');
    toggleBlock.style.borderRadius = isChecked ? '10px 10px 0 0' : '10px';
  }

  function openAddSession(dateObj) { 
      editingId = null; 
      populateClientSelect(); 
      document.getElementById('sheetTitle').textContent='Новая запись'; 
      document.getElementById('btnDelete').style.display='none'; 
      
      // Series Toggle Reset
      const recContainer = document.getElementById('recurringOptionContainer');
      const countContainer = document.getElementById('seriesCountContainer');
      recContainer.style.display = 'flex';
      recContainer.style.borderRadius = '10px'; 
      document.getElementById('inpRecurring').checked = false; 
      document.getElementById('inpSeriesCount').value = 4;
      countContainer.style.display = 'none';

      // Set Date/Time
      document.getElementById('inpDate').value = getLocalDateStr(dateObj); 
      updateDateDisplay(); 
      const h = dateObj.getHours(); 
      document.getElementById('inpStart').value = `${String(h).padStart(2,'0')}:00`; 
      document.getElementById('inpEnd').value = `${String(h+1).padStart(2,'0')}:00`; 
      
      openSheet('sessionSheet'); 
  }

  function openEdit(s) { 
      editingId = s.id; 
      populateClientSelect(); 
      document.getElementById('sheetTitle').textContent = 'Редактировать'; 
      document.getElementById('btnDelete').style.display = 'block'; 

      // Check if it's a series
      const isSeries = !!s.seriesId;
      document.getElementById('recurringOptionContainer').style.display = 'none'; 
      document.getElementById('seriesCountContainer').style.display = 'none';
      
      if(isSeries) {
         document.getElementById('patternInfoBox').style.display = 'flex';
         document.getElementById('patternInfoBox').querySelector('.pib-text').textContent = "Это часть серии тренировок";
      } else {
         document.getElementById('patternInfoBox').style.display = 'none';
      }

      // Fill Form
      document.getElementById('inpClient').value = s.client; 
      document.getElementById('inpDate').value = s.dateStr; 
      document.getElementById('inpStart').value = s.start; 
      document.getElementById('inpEnd').value = s.end; 
      document.getElementById('inpNote').value = s.note||''; 
      
      updateDateDisplay(); 
      openSheet('sessionSheet'); 
  }

  // --- SAVE LOGIC ---
 // --- SAVE LOGIC ---
  async function trySaveSession() {
      // 1. Считываем данные из формы
      const clientName = document.getElementById('inpClient').value;
      const dateStr = document.getElementById('inpDate').value;
      const start = document.getElementById('inpStart').value;
      const end = document.getElementById('inpEnd').value;
      const note = document.getElementById('inpNote').value;
      
      // Логика для Серий (чтение чекбокса и количества)
      const createSeries = document.getElementById('inpRecurring').checked; 
      let seriesCount = 4; // Значение по умолчанию
      
      if (createSeries) {
          const val = parseInt(document.getElementById('inpSeriesCount').value);
          // Валидация количества (защита от зависания)
          if (!val || val < 2) { showToast("Минимум 2 тренировки", false); return; }
          if (val > 100) { showToast("Максимум 100 за раз", false); return; }
          seriesCount = val;
      }

      // 2. Находим объект клиента (нужен ID для проверки групповых)
      const clientObj = clients.find(c => c.name === clientName);
      if (!clientObj) { showToast("Ошибка: Выберите клиента из списка", false); return; }

      // 3. Валидация (передаем ID клиента для разрешения Групповых тренировок)
      const val = validateAppointment(dateStr, start, end, editingId, clientObj.id); 
      
      if(!val.valid) { 
          showToast(val.msg, false); // Ошибка (тот же клиент)
          return; 
      }
      if(val.warning) {
          showToast(val.warning, false); // Предупреждение (групповая)
      }

      // 4. Подготовка данных
      const baseData = {
          client: clientName,
          clientId: clientObj.id,
          start, end, note,
          status: 'planned'
      };

      // Сценарий A: Редактирование существующей записи
      const currentSession = editingId ? sessions.find(s => s.id === editingId) : null;
      if (currentSession && currentSession.seriesId) {
          // Если это часть серии — спрашиваем пользователя (Action Sheet)
          tempSessionData = { ...baseData, dateStr, id: editingId, seriesId: currentSession.seriesId };
          openActionSheet('save'); 
          return;
      }

      // Сценарий B: Создание НОВОЙ серии
      if (!editingId && createSeries) {
          createBatchSeries(baseData, dateStr, seriesCount); // Передаем выбранное количество
          return;
      }

      // Сценарий C: Обычное сохранение (одиночная запись)
      saveSingleSession({ ...baseData, dateStr, id: editingId || generateId(), seriesId: null });
  }

  // --- VALIDATION (UPDATED FOR GROUP TRAINING) ---
  function validateAppointment(dateStr, start, end, excludeSessionId, checkClientId) { 
      const [h1, m1] = start.split(':').map(Number); 
      const [h2, m2] = end.split(':').map(Number); 
      const startMins = h1 * 60 + m1; 
      const endMins = h2 * 60 + m2; 

      // Безопасное приведение ID к строке для сравнения
      const targetIdStr = String(checkClientId);
      let hasConflict = false;
      let conflictName = '';

      for (let s of sessions) { 
          if (s.dateStr !== dateStr) continue; 
          if (s.status === 'cancelled') continue;
          
          // Пропускаем саму себя при редактировании
          if (excludeSessionId && String(s.id) === String(excludeSessionId)) continue; 

          const [sH1, sM1] = s.start.split(':').map(Number); 
          const [sH2, sM2] = s.end.split(':').map(Number); 
          const sStart = sH1 * 60 + sM1; 
          const sEnd = sH2 * 60 + sM2; 

          // Проверка пересечения времени
          if (Math.max(startMins, sStart) < Math.min(endMins, sEnd)) {
              
              // Если это ТОТ ЖЕ клиент - запрещаем
              if (s.clientId && String(s.clientId) === targetIdStr) {
                   return { 
                      valid: false, 
                      msg: `Этот клиент (${s.client}) уже записан на это время!` 
                   }; 
              }

              // Если клиент ДРУГОЙ - это групповая. Запоминаем для предупреждения.
              hasConflict = true;
              conflictName = s.client;
          }
      } 
      
      // Разрешаем сохранение, но с предупреждением
      if (hasConflict) {
          return { valid: true, warning: `Групповая: также записан ${conflictName}` };
      }

      return { valid: true }; 
  }

  function saveSingleSession(data) {
      if(editingId) {
          const idx = sessions.findIndex(s => s.id === editingId);
          if(idx !== -1) sessions[idx] = data;
      } else {
          sessions.push(data);
      }
      afterSaveAction([data.dateStr]);
  }

  function createBatchSeries(baseData, startDateStr, count) {
      const seriesId = generateId(); 
      const datesToSync = [];
      const newSessions = [];

      let currentDate = new Date(startDateStr);
      for(let i=0; i < count; i++) {
          const dStr = getLocalDateStr(currentDate);
          const sess = {
              ...baseData,
              id: generateId(),
              dateStr: dStr,
              seriesId: seriesId
          };
          newSessions.push(sess);
          datesToSync.push(dStr);
          currentDate.setDate(currentDate.getDate() + 7);
      }

      sessions.push(...newSessions);
      showToast(`Создана серия (${newSessions.length})`, true);
      afterSaveAction(datesToSync);
  }

  function updateSeriesBatch(mode, originalSessionData) {
      const datesToSync = [];
      const targetSeriesId = originalSessionData.seriesId;

      if(mode === 'single') {
          const newData = { ...originalSessionData, seriesId: null }; 
          const idx = sessions.findIndex(s => s.id === originalSessionData.id);
          if(idx!==-1) sessions[idx] = newData;
          datesToSync.push(newData.dateStr);
      } 
      else if(mode === 'series') {
          const cutOffDate = originalSessionData.dateStr;
          sessions.forEach((s, i) => {
              if(s.seriesId === targetSeriesId && s.dateStr >= cutOffDate) {
                  sessions[i] = {
                      ...sessions[i],
                      start: originalSessionData.start,
                      end: originalSessionData.end,
                      note: originalSessionData.note,
                      client: originalSessionData.client,
                      clientId: originalSessionData.clientId
                  };
                  datesToSync.push(s.dateStr);
              }
          });
      }
      afterSaveAction(datesToSync);
  }

  function tryDeleteSession() {
      const s = sessions.find(x => x.id === editingId);
      if(!s) return;
      if(s.seriesId) {
          openActionSheet('delete'); 
      } else {
          commitDelete('single', s);
      }
  }

  function commitDelete(mode, sessionObj) {
      const datesToSync = [];
      if(mode === 'single') {
          sessions = sessions.filter(x => x.id !== sessionObj.id);
          datesToSync.push(sessionObj.dateStr);
      } 
      else if (mode === 'series') {
           const cutOffDate = sessionObj.dateStr;
           const targetSeriesId = sessionObj.seriesId;
           sessions.forEach(s => {
               if(s.seriesId === targetSeriesId && s.dateStr >= cutOffDate) {
                   datesToSync.push(s.dateStr);
               }
           });
           sessions = sessions.filter(s => !(s.seriesId === targetSeriesId && s.dateStr >= cutOffDate));
      }
      afterSaveAction(datesToSync);
  }

  function afterSaveAction(datesToSync) {
      DataManager.saveLocally();
      reRenderBlocks();
      updateAllDayStats();
      closeAllSheets();
      
      DataManager.syncBatch(datesToSync)
        .then(() => console.log("Batch Sync OK"))
        .catch(e => showToast("Ошибка сохранения в облако", false));
  }


  // ==============================================
  // 5. VIEW / UI HELPERS
  // ==============================================
  
  function getLocalDateStr(date) { const y = date.getFullYear(); const m = String(date.getMonth() + 1).padStart(2, '0'); const d = String(date.getDate()).padStart(2, '0'); return `${y}-${m}-${d}`; }
  function getDateStr(offset) { const d=new Date(); d.setDate(d.getDate()+offset); return getLocalDateStr(d); }
  function getStartOfWeek(date) { const d=new Date(date); const day=d.getDay(); const diff=d.getDate()-day+(day===0?-6:1); d.setDate(diff); d.setHours(0,0,0,0); return d; }
  function hexToRgba(hex, alpha) { 
      if(!hex) return 'rgba(100,100,100,0.5)';
      let r=0,g=0,b=0;
      if(hex.length===4){r="0x"+hex[1]+hex[1];g="0x"+hex[2]+hex[2];b="0x"+hex[3]+hex[3];}
      else if(hex.length===7){r="0x"+hex[1]+hex[2];g="0x"+hex[3]+hex[4];b="0x"+hex[5]+hex[6];}
      return `rgba(${+r}, ${+g}, ${+b}, ${alpha})`; 
  }

  // --- UI RENDERING ---
  function renderTimeColumn() { const col=document.getElementById('timeColumn'), badge=document.getElementById('timeLineBadge'); col.innerHTML=''; col.appendChild(badge); for(let i=0; i<24; i++) { const el=document.createElement('div'); el.className='time-label'; if (i > 0) el.innerHTML=`<span>${String(i).padStart(2,'0')}:00</span>`; col.appendChild(el); } }
  
  function renderDayRange(from, to) {
    const track=document.getElementById('daysHeaderTrack'), grid=document.getElementById('gridColumns');
    const weekDays=['ПН','ВТ','СР','ЧТ','ПТ','СБ','ВС']; const base=new Date(); base.setHours(0,0,0,0);
    const todayStr = getLocalDateStr(new Date());
    for(let i=from; i<=to; i++) {
      const d=new Date(base); d.setDate(d.getDate()+i); const dateStr=getLocalDateStr(d);
      let dayIdx=d.getDay()-1; if(dayIdx===-1) dayIdx=6;
      const isToday = dateStr === todayStr;
      
      const h=document.createElement('div'); h.className=`day-col-header ${isToday ? 'today' : ''}`; h.id=`header-${dateStr}`; h.setAttribute('data-date', dateStr);
      h.innerHTML=`<div class="dch-day">${weekDays[dayIdx]}</div><div class="dch-num">${d.getDate()}</div><div class="dch-stats" id="stat-${dateStr}"><div class="dch-stats-fill"></div></div>`;
      h.onclick=()=>openDayOptions(dateStr, `${weekDays[dayIdx]} ${d.getDate()}`); 
      track.appendChild(h);
      
      const c=document.createElement('div'); c.className=`day-column ${isToday ? 'today' : ''}`; c.setAttribute('data-date', dateStr); c.setAttribute('data-day-idx', dayIdx);
      renderEventsForColumn(c, dateStr, dayIdx); 
      attachLongPressHandler(c, d); 
      grid.appendChild(c); 
      updateDayStats(dateStr);
    }
  }

  function reRenderBlocks() {
      document.querySelectorAll('#gridColumns .day-column').forEach(col => {
        col.querySelectorAll('.blocked-slot, .day-off-overlay, .blocked-range-part, .event-card').forEach(e => e.remove());
        
        const dateStr = col.getAttribute('data-date');
        const dayIdx = parseInt(col.getAttribute('data-day-idx'));
        const colLeft = Math.round(col.offsetLeft); 

        // 1. Draw Pattern (Working Hours)
        (availabilityPattern[dayIdx] || []).forEach(h => {
          const b = document.createElement('div');
          b.className = 'blocked-slot stripe-bg';
          const top = h * GRID_H;
          b.style.top = `${top}px`;
          b.style.backgroundPosition = `-${colLeft}px -${top}px`;
          col.appendChild(b);
        });
        
        // 2. Draw Ranges (Vacation)
        if (specialRanges && specialRanges.length > 0) {
            const cS = new Date(dateStr + 'T00:00:00').getTime();
            const cE = new Date(dateStr + 'T23:59:59').getTime();
            
            specialRanges.forEach(r => {
                const rS = new Date(r.start).getTime();
                const rE = new Date(r.end).getTime();
                const oS = Math.max(cS, rS);
                const oE = Math.min(cE, rE);
                
                if (oS < oE) {
                    // Full day overlay
                    if (oS <= cS && oE >= cE - 60000) {
                        if (!col.querySelector('.day-off-overlay')) {
                            const o = document.createElement('div');
                            o.className = 'day-off-overlay stripe-bg';
                            o.style.backgroundPosition = `-${colLeft}px 0px`; 
                            col.appendChild(o);
                        }
                    } else {
                        // Partial overlay
                        const top = (oS - cS) / 3600000 * GRID_H;
                        const h = (oE - oS) / 3600000 * GRID_H;
                        const p = document.createElement('div');
                        p.className = 'blocked-range-part stripe-bg';
                        p.style.top = `${top}px`;
                        p.style.height = `${h}px`;
                        p.style.backgroundPosition = `-${colLeft}px -${top}px`;
                        col.appendChild(p);
                    }
                }
            });
        }

        // 3. Draw Day Off Exception
        if (dateExceptions[dateStr] === 'off') {
          if (!col.querySelector('.day-off-overlay')) {
              const o = document.createElement('div');
              o.className = 'day-off-overlay stripe-bg';
              o.style.backgroundPosition = `-${colLeft}px 0px`;
              col.appendChild(o);
          }
        }

        // 4. Draw Events
        renderEventsForColumn(col, dateStr, dayIdx);
        updateDayStats(dateStr);
      });
  }
  
  function updateAllDayStats() { document.querySelectorAll('.day-col-header').forEach(h => { updateDayStats(h.getAttribute('data-date')); }); }
  function updateDayStats(dateStr) {
    const track = document.getElementById(`stat-${dateStr}`); if (!track) return;
    const hasEvents = sessions.some(s => s.dateStr === dateStr);
    const isOff = dateExceptions[dateStr] === 'off';

    if (isOff || !hasEvents) { 
        track.style.display = 'none'; 
    } else {
        track.style.display = 'flex';
        track.querySelector('.dch-stats-fill').style.width = '100%';
        track.querySelector('.dch-stats-fill').style.background = 'var(--acc-current)';
    }
  }

  // === УМНАЯ ОТРИСОВКА (С РАЗДЕЛЕНИЕМ КОЛОНОК) ===
  function renderEventsForColumn(col, dateStr, dayIdx) {
      // 1. Берем события только этого дня
      const dayEvents = sessions.filter(s => s.dateStr === dateStr);

      // 2. Превращаем время в минуты для расчетов
      const items = dayEvents.map(s => {
          const [h, m] = s.start.split(':').map(Number);
          const [hE, mE] = s.end.split(':').map(Number);
          return {
              data: s,
              start: h * 60 + m,
              end: hE * 60 + mE,
              colIndex: 0 // По умолчанию нулевая колонка
          };
      });

      // 3. Сортируем: сначала ранние, если время совпадает — сначала длинные
      items.sort((a, b) => {
          if (a.start !== b.start) return a.start - b.start;
          return (b.end - b.start) - (a.end - a.start);
      });

      // 4. Алгоритм "Укладки" в колонки (Visual Columns)
      const columns = [];
      items.forEach(item => {
          let placed = false;
          // Пытаемся положить в существующую колонку
          for (let i = 0; i < columns.length; i++) {
              const colItems = columns[i];
              const lastInCol = colItems[colItems.length - 1];
              
              // Если текущее событие начинается ПОСЛЕ того, как закончилось последнее в этой колонке
              if (item.start >= lastInCol.end) {
                  colItems.push(item);
                  item.colIndex = i;
                  placed = true;
                  break;
              }
          }
          // Если не влезло никуда — создаем новую колонку
          if (!placed) {
              columns.push([item]);
              item.colIndex = columns.length - 1;
          }
      });

      // 5. Отрисовка с расчетом ширины
      items.forEach(item => {
          // Ищем максимальный индекс колонки среди ВСЕХ соседей, с которыми мы пересекаемся
          // Это нужно, чтобы если в 10:00 занято 2 человека, они оба стали узкими (50%)
          let maxColIndex = 0;
          
          items.forEach(other => {
               // Проверка пересечения времени
               if (Math.max(item.start, other.start) < Math.min(item.end, other.end)) {
                   if (other.colIndex > maxColIndex) maxColIndex = other.colIndex;
               }
          });
          
          // Количество колонок в этой группе пересечений
          const totalCols = maxColIndex + 1;

          // Вычисляем CSS
          const widthPercent = 100 / totalCols;
          const leftPercent = item.colIndex * widthPercent;

          const el = createEventEl(item.data);
          
          // Применяем стили разделения
          el.style.width = `calc(${widthPercent}% - 4px)`;
          el.style.left = `calc(${leftPercent}% + 2px)`;
          
          // Добавляем Z-index, чтобы колонка справа была чуть выше (для красоты теней)
          el.style.zIndex = 10 + item.colIndex;

          col.appendChild(el);
      });
  }

  function createEventEl(s) { 
      const [h,m] = s.start.split(':').map(Number); 
      const [hE,mE] = s.end.split(':').map(Number); 
      const top = (h*60+m)/60*GRID_H;
      const height = (hE*60+mE-(h*60+m))/60*GRID_H; 
      
      const div = document.createElement('div'); 
      div.className = `event-card`; 
      div.style.top = `${top}px`; 
      div.style.height = `${Math.max(height,20)}px`; 
      
      const cli = clients.find(c => (s.clientId && String(c.id) === String(s.clientId)) || c.name === s.client); 
      const color = cli ? cli.color : '#0a84ff'; 
      
      div.style.borderLeftColor = color; 
      div.style.backgroundColor = hexToRgba(color, 0.85); 
      
      let html = `<div class="ev-title">${s.client}</div><div class="ev-time">${s.start} - ${s.end}</div>`;
      if(s.seriesId) html += `<svg class="ev-recurring-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>`;
      
      div.innerHTML = html;
      div.onclick = (e)=>{ e.stopPropagation(); openEdit(s); }; 
      return div; 
  }

  // --- INTERACTION ---
  function attachLongPressHandler(element, dateObj) { let startY=0, timer=null; const start=(e)=>{if(e.target.closest('.event-card'))return; isScrolling=false; startY=(e.touches?e.touches[0].clientY:e.clientY); timer=setTimeout(()=>{ if(!isScrolling){ navigator.vibrate?.(50); const rect=element.getBoundingClientRect(); const hour=Math.floor((startY-rect.top)/GRID_H); dateObj.setHours(hour,0); openAddSession(dateObj); } },500); }; const move=()=>{isScrolling=true; clearTimeout(timer);}; const end=()=>{clearTimeout(timer);}; element.addEventListener('touchstart',start,{passive:true}); element.addEventListener('touchmove',move,{passive:true}); element.addEventListener('touchend',end); element.addEventListener('mousedown',start); element.addEventListener('mousemove',move); element.addEventListener('mouseup',end); }
  function cancelLongPress() { /* Handled in closure */ }
  
  function handleInfiniteScroll() { const vp=document.getElementById('matrixViewport'); const sl=vp.scrollLeft, sw=vp.scrollWidth, cw=vp.clientWidth; if(sw-(sl+cw)<300) { const old=endOffset; endOffset+=14; renderDayRange(old+1, endOffset); reRenderBlocks(); } if(sl<300) { const old=startOffset; startOffset-=14; prependDays(startOffset, old-1); vp.scrollLeft+=(14*65); reRenderBlocks(); } }
  function prependDays(from, to) { const track=document.getElementById('daysHeaderTrack'), grid=document.getElementById('gridColumns'); const weekDays=['ПН','ВТ','СР','ЧТ','ПТ','СБ','ВС']; const base=new Date(); base.setHours(0,0,0,0); const todayStr = getLocalDateStr(new Date()); const fragH=document.createDocumentFragment(), fragC=document.createDocumentFragment(); for(let i=from; i<=to; i++) { const d=new Date(base); d.setDate(d.getDate()+i); const dateStr=getLocalDateStr(d); let dayIdx=d.getDay()-1; if(dayIdx===-1) dayIdx=6; const isToday = dateStr === todayStr; const h=document.createElement('div'); h.className=`day-col-header ${isToday ? 'today' : ''}`; h.id=`header-${dateStr}`; h.setAttribute('data-date', dateStr); h.innerHTML=`<div class="dch-day">${weekDays[dayIdx]}</div><div class="dch-num">${d.getDate()}</div><div class="dch-stats" id="stat-${dateStr}"><div class="dch-stats-fill"></div></div>`; h.onclick=()=>openDayOptions(dateStr, `${weekDays[dayIdx]} ${d.getDate()}`); fragH.appendChild(h); const c=document.createElement('div'); c.className=`day-column ${isToday ? 'today' : ''}`; c.setAttribute('data-date', dateStr); c.setAttribute('data-day-idx', dayIdx); renderEventsForColumn(c, dateStr, dayIdx); attachLongPressHandler(c, d); fragC.appendChild(c); updateDayStats(dateStr); } track.insertBefore(fragH, track.firstChild); grid.insertBefore(fragC, grid.querySelector('.day-column')); }

  // --- VALIDATION (UPDATED FOR GROUP TRAINING) ---
  function validateAppointment(dateStr, start, end, excludeSessionId, checkClientId) { 
      const [h1, m1] = start.split(':').map(Number); 
      const [h2, m2] = end.split(':').map(Number); 
      const startMins = h1 * 60 + m1; 
      const endMins = h2 * 60 + m2; 

      // Безопасное приведение ID к строке для сравнения
      const targetIdStr = String(checkClientId);
      let hasConflict = false;
      let conflictName = '';

      for (let s of sessions) { 
          if (s.dateStr !== dateStr) continue; 
          if (s.status === 'cancelled') continue; // Игнорируем отмененные
          
          // Пропускаем саму себя при редактировании
          if (excludeSessionId && String(s.id) === String(excludeSessionId)) continue; 

          const [sH1, sM1] = s.start.split(':').map(Number); 
          const [sH2, sM2] = s.end.split(':').map(Number); 
          const sStart = sH1 * 60 + sM1; 
          const sEnd = sH2 * 60 + sM2; 

          // Проверка пересечения времени
          if (Math.max(startMins, sStart) < Math.min(endMins, sEnd)) {
              
              // ГЛАВНОЕ ИЗМЕНЕНИЕ:
              // Если это ТОТ ЖЕ клиент - запрещаем
              if (s.clientId && String(s.clientId) === targetIdStr) {
                   return { 
                      valid: false, 
                      msg: `Этот клиент (${s.client}) уже записан на это время!` 
                   }; 
              }

              // Если клиент ДРУГОЙ - это групповая. Запоминаем для предупреждения.
              hasConflict = true;
              conflictName = s.client;
          }
      } 
      
      // Если было пересечение с другим человеком, возвращаем Warning, но valid = true
      if (hasConflict) {
          return { valid: true, warning: `Групповая: также записан ${conflictName}` };
      }

      return { valid: true }; 
  }

  // --- SHEETS & UI GLUE ---
  function updateDateDisplay() { 
      const val = document.getElementById('inpDate').value; 
      const disp = document.getElementById('dateDisplay'); 
      if (!val) { disp.textContent = ''; return; } 
      const [y, m, d] = val.split('-').map(Number); 
      const dateObj = new Date(y, m - 1, d);
      disp.textContent = dateObj.toLocaleDateString('ru-RU', { weekday: 'long', month: 'long', day: 'numeric' }); 
  }

  function populateClientSelect() { 
      const sel = document.getElementById('inpClient'); 
      sel.innerHTML = ''; 
      if(clients.length === 0) {
           const opt = document.createElement('option'); opt.text = "Нет клиентов"; sel.appendChild(opt); return;
      }
      clients.forEach(c => { const opt = document.createElement('option'); opt.value = c.name; opt.textContent = c.name; sel.appendChild(opt); }); 
  }

  function openActionSheet(type) { 
      const sheet = document.getElementById('actionSheet'); 
      const overlay = document.getElementById('actionSheetOverlay'); 
      const title = document.getElementById('asTitle'); 
      const btnOne = document.getElementById('asBtnOne'); 
      const btnSeries = document.getElementById('asBtnSeries'); 
      
      overlay.classList.add('active'); 
      sheet.classList.add('open'); 

      if (type === 'save') { 
          title.textContent = "Изменение серии"; 
          btnOne.textContent = "Только эту"; 
          btnOne.onclick = () => { closeActionSheet(); updateSeriesBatch('single', tempSessionData); }; 
          
          btnSeries.textContent = "Эту и будущие"; 
          btnSeries.onclick = () => { closeActionSheet(); updateSeriesBatch('series', tempSessionData); }; 
      } 
      else if (type === 'delete') { 
          title.textContent = "Удаление"; 
          btnOne.textContent = "Только эту"; 
          btnOne.className = "as-button danger";
          btnOne.onclick = () => { closeActionSheet(); commitDelete('single', sessions.find(s=>s.id===editingId)); }; 
          
          btnSeries.textContent = "Эту и будущие"; 
          btnSeries.className = "as-button danger bold";
          btnSeries.onclick = () => { closeActionSheet(); commitDelete('series', sessions.find(s=>s.id===editingId)); }; 
      } 
  }
  function closeActionSheet() { document.getElementById('actionSheet').classList.remove('open'); document.getElementById('actionSheetOverlay').classList.remove('active'); }

  function openSettings(){openSheet('settingsSheet');}
  
  function openRangesSheet(){ 
      closeAllSheets(); 
      resetRangeForm(); 
      renderRangesList(); 
      openSheet('rangesSheet'); 
  }
  
  // Settings: Ranges Logic (Re-implemented for v9.0)
  function addRange() {
      const dS = document.getElementById('rangeStartDate').value; const tS = document.getElementById('rangeStartTime').value;
      const dE = document.getElementById('rangeEndDate').value; const tE = document.getElementById('rangeEndTime').value;
      if (!dS || !tS || !dE || !tE) return alert('Заполните все поля');
      const start = `${dS}T${tS}`, end = `${dE}T${tE}`;
      if (start >= end) return alert('Ошибка дат');
      
      specialRanges.push({ start, end });
      resetRangeForm(); renderRangesList(); reRenderBlocks(); 
      DataManager.saveLocally(); 
      DataManager.fetchFromServer('save_settings', { settings: { ranges: specialRanges } }); // Sync to server
  }
  
  function deleteRange(i) { 
      specialRanges.splice(i, 1); 
      renderRangesList(); reRenderBlocks(); 
      DataManager.saveLocally();
      DataManager.fetchFromServer('save_settings', { settings: { ranges: specialRanges } });
  }

  function resetRangeForm() {
      document.getElementById('rangeStartDate').value = '';
      document.getElementById('rangeStartTime').value = '00:00';
      document.getElementById('rangeEndDate').value = '';
      document.getElementById('rangeEndTime').value = '23:59';
  }

  function renderRangesList() {
      const l = document.getElementById('rangesList');
      l.innerHTML = '';
      if (!specialRanges.length) {
        l.innerHTML = '<div style="color:#8E8E93;font-size:13px;text-align:center;margin-top:20px;">Нет периодов</div>';
        return;
      }
      specialRanges.forEach((r, i) => {
        const el = document.createElement('div');
        el.className = 'range-item';
        const f = (iso) => {
          const d = new Date(iso);
          return `${d.getDate()}.${String(d.getMonth() + 1).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
        };
        el.innerHTML = `
          <div><div class="range-text">${f(r.start)} — ${f(r.end)}</div></div>
          <div class="range-actions"><div class="range-icon del" onclick="deleteRange(${i})"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></div></div>`;
        l.appendChild(el);
      });
  }

  function openClientsSheet(){ 
      closeAllSheets(); 
      const cont = document.getElementById('clientsListContainer'); cont.innerHTML = ''; 
      clients.forEach(c => { 
          const el = document.createElement('div'); el.className='client-list-item'; 
          el.innerHTML = `<div class="color-dot" style="background:${c.color}"></div><div class="client-name">${c.name}</div>`; 
          cont.appendChild(el); 
      }); 
      openSheet('clientsSheet'); 
  }
  
  function scrollToToday() { const today = getLocalDateStr(new Date()); const el = document.getElementById('header-' + today); const vp = document.getElementById('matrixViewport'); if(el && vp) { const vpW = vp.clientWidth; const elLeft = el.offsetLeft; const elW = el.offsetWidth; vp.scrollLeft = elLeft - (vpW / 2) + (elW / 2); vp.scrollTop = 9 * GRID_H; } }
  function onScroll() { const vp=document.getElementById('matrixViewport'), headers=document.querySelectorAll('.day-col-header'); for(let h of headers) if(h.offsetLeft>=vp.scrollLeft) { const d=new Date(h.getAttribute('data-date')); document.getElementById('headerMonth').textContent=`${d.toLocaleString('ru',{month:'long'}).toUpperCase()} ${d.getFullYear()}`; break; } }
  
  function showToast(msg, isSuccess = false) { const t = document.getElementById('toast'); t.className = 'toast-notification ' + (isSuccess ? 'success' : ''); document.getElementById('toastTitle').textContent = isSuccess ? "Успешно" : "Инфо"; document.getElementById('toastMessage').textContent = msg; t.classList.add('show'); setTimeout(() => { t.classList.remove('show'); }, 3000); }
  
  function openDayOptions(d,t){selectedDayForOptions=d;document.getElementById('dayOptionsTitle').textContent=t;openSheet('dayOptionsSheet');}
  function toggleDayOff() { 
      if (selectedDayForOptions) { 
          dateExceptions[selectedDayForOptions] = 'off'; 
          reRenderBlocks(); closeAllSheets(); 
          DataManager.saveLocally();
          DataManager.fetchFromServer('save_settings', { settings: { exceptions: dateExceptions } });
      } 
  }
  function clearDayOff() { 
      if (selectedDayForOptions) { 
          delete dateExceptions[selectedDayForOptions]; 
          reRenderBlocks(); closeAllSheets(); 
          DataManager.saveLocally();
          DataManager.fetchFromServer('save_settings', { settings: { exceptions: dateExceptions } });
      } 
  }

  function openSheet(id){document.getElementById('overlay').classList.add('active');document.getElementById(id).classList.add('open');}
  function closeAllSheets(){document.getElementById('overlay').classList.remove('active');document.querySelectorAll('.sheet').forEach(s=>s.classList.remove('open'));}
  
  // PATTERN EDITOR
  function openPatternEditor(){closeAllSheets();document.getElementById('patternEditor').classList.add('open');renderPatternEditor();}
  function closePatternEditor(){document.getElementById('patternEditor').classList.remove('open');} 
  function savePattern() { 
      document.getElementById('patternEditor').classList.remove('open'); 
      reRenderBlocks(); 
      DataManager.saveLocally(); 
      DataManager.fetchFromServer('save_settings', { settings: { pattern: availabilityPattern } }); 
  }
  
  function renderPatternEditor(){ const t=document.getElementById('peTimeColumn'); t.innerHTML=''; for(let i=0;i<24;i++){const e=document.createElement('div');e.className='time-label'; if(i > 0) e.innerHTML=`<span>${String(i).padStart(2,'0')}:00</span>`;e.onclick=()=>toggleRowPattern(i);t.appendChild(e);} const h=document.getElementById('peHeaderTrack'); h.innerHTML=''; const w=['ПН','ВТ','СР','ЧТ','ПТ','СБ','ВС']; for(let i=0;i<7;i++){const e=document.createElement('div');e.className='day-col-header';e.innerHTML=`<div class="dch-day" style="margin-top:16px">${w[i]}</div>`;e.onclick=()=>toggleColPattern(i);h.appendChild(e);} const g=document.getElementById('peGridColumns'); g.innerHTML=''; for(let i=0;i<7;i++){const c=document.createElement('div');c.className='day-column';c.onclick=(e)=>{if(e.target!==c)return;toggleSinglePattern(i,Math.floor(e.offsetY/GRID_H));};renderPCol(c,i);g.appendChild(c);} }
  function renderPCol(c, d) { c.innerHTML = ''; const colLeft = Math.round(c.offsetLeft); (availabilityPattern[d] || []).forEach(x => { const b = document.createElement('div'); b.className = 'blocked-slot stripe-bg'; const top = x * GRID_H; b.style.top = `${top}px`; b.style.backgroundPosition = `-${colLeft}px -${top}px`; b.onclick = (e) => { e.stopPropagation(); toggleSinglePattern(d, x); }; c.appendChild(b); }); }
  function toggleSinglePattern(d,h){const a=availabilityPattern[d],i=a.indexOf(h);if(i===-1)a.push(h);else a.splice(i,1);renderPCol(document.getElementById('peGridColumns').children[d],d);}
  function toggleRowPattern(h){let all=true;for(let d=0;d<7;d++)if(!availabilityPattern[d].includes(h)){all=false;break;} for(let d=0;d<7;d++){const a=availabilityPattern[d],i=a.indexOf(h);if(all&&i!==-1)a.splice(i,1);if(!all&&i===-1)a.push(h);} const g=document.getElementById('peGridColumns');for(let d=0;d<7;d++)renderPCol(g.children[d],d);}
  function toggleColPattern(d){const a=availabilityPattern[d];if(a.length===24)availabilityPattern[d]=[];else availabilityPattern[d]=Array.from({length:24},(_,i)=>i);renderPCol(document.getElementById('peGridColumns').children[d],d);}
  
  function startClock(){updateClock();if(updateInterval)clearInterval(updateInterval);updateInterval=setInterval(updateClock,60000);}
  function updateClock(){const n=new Date(),l=document.getElementById('globalTimeLine'),b=document.getElementById('timeLineBadge'),px=(n.getHours()*60+n.getMinutes())/60*GRID_H;l.style.top=`${px}px`;l.style.display='block';b.textContent=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;b.style.display='block';b.style.top=`${px}px`;}

  document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
