<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Ultima Coach Infinite</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  /* === CORE STYLES === */
  :root {
    --bg-core: #050505; 
    --bg-panel: #1C1C1E;
    --text-main: #ffffff;
    --text-muted: #8E8E93;
    
    --line-color: rgba(255, 255, 255, 0.08);
    --time-col-width: 50px;
    --day-col-width: 65px; 
    
    --acc-blue: #0a84ff;
    --acc-red: #ff453a;
    --acc-green: #30d158;
    --acc-purple: #5e60ce;
    
    --grid-h: 60px;
    --safe-top: env(safe-area-inset-top);
    --safe-bottom: env(safe-area-inset-bottom);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
  *::-webkit-scrollbar { display: none; }

  body {
    background-color: var(--bg-core);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', Roboto, sans-serif;
    color: var(--text-main);
    height: 100%; width: 100%;
    overflow: hidden;
    position: fixed; inset: 0;
    user-select: none;
  }

  /* === FX LAYER === */
  .fx-layer { position: absolute; inset: 0; z-index: 0; pointer-events: none; }
  .orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.5; will-change: transform; }
  .orb-1 { width: 300px; height: 300px; background: var(--acc-purple); top: -50px; left: -100px; animation: float 20s infinite ease-in-out; }
  .orb-2 { width: 250px; height: 250px; background: var(--acc-blue); bottom: -50px; right: -50px; animation: float 15s infinite ease-in-out reverse; }
  .noise { position: fixed; inset: 0; opacity: 0.04; background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); }
  @keyframes float { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(30px, 50px); } }

  /* === MAIN LAYOUT === */
  .app-container {
    display: flex; flex-direction: column;
    height: 100%; width: 100%;
    position: relative; z-index: 1;
  }

  /* Header */
  .top-area {
    background: rgba(0, 0, 0, 0.3); 
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--line-color);
    padding-top: calc(10px + var(--safe-top));
    padding-bottom: 4px;
    z-index: 30; flex-shrink: 0;
  }
  .header-row { display: flex; justify-content: space-between; align-items: center; padding: 0 16px; margin-bottom: 10px; }
  .month-label { font-family: 'SF Pro Display', sans-serif; font-size: 15px; font-weight: 700; color: #fff; text-transform: uppercase; letter-spacing: 1px; }
  .week-controls { display: flex; gap: 16px; align-items: center; }
  .icon-btn { width: 24px; height: 24px; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center;}

  /* Matrix Scroll View */
  .matrix-viewport {
    flex: 1; overflow: auto; position: relative;
    -webkit-overflow-scrolling: touch; overscroll-behavior: none;
    display: flex; flex-direction: column;
  }

  .matrix-header-row {
    display: flex; position: sticky; top: 0; z-index: 20;
    width: max-content; background: rgba(0, 0, 0, 0.25);
    backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
    border-bottom: 1px solid var(--line-color);
  }

  .corner-cell {
    width: var(--time-col-width); flex-shrink: 0; position: sticky; left: 0; z-index: 25;
    background: inherit; border-right: 1px solid var(--line-color);
  }

  .days-header-track { display: flex; flex: 1; }

  .day-col-header {
    width: var(--day-col-width); flex-shrink: 0; text-align: center; height: 52px; padding: 8px 0 0 0;
    font-size: 11px; color: var(--text-muted); border-right: 1px solid var(--line-color);
    display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
    gap: 4px; position: relative; cursor: pointer;
  }
  .dch-day { font-weight: 600; text-transform: uppercase; line-height: 1; }
  .dch-num { font-size: 16px; font-weight: 500; color: #fff; line-height: 1; }
  .day-col-header.today .dch-day { color: var(--acc-blue); }
  .day-col-header.today::after { content: ''; width: 4px; height: 4px; border-radius: 50%; background: var(--acc-blue); margin-top: 4px; box-shadow: 0 0 6px var(--acc-blue); }

  .matrix-body { display: flex; width: max-content; position: relative; }

  .time-column {
    width: var(--time-col-width); flex-shrink: 0; position: sticky; left: 0; z-index: 18;
    background: rgba(0, 0, 0, 0.25); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
    border-right: 1px solid var(--line-color); padding-bottom: 20px;
  }
  .time-label { height: var(--grid-h); position: relative; cursor: pointer; } 
  .time-label span {
    position: absolute; top: -7px; right: 6px; font-size: 11px; font-weight: 500; color: var(--text-muted); font-variant-numeric: tabular-nums;
  }
  .time-label:first-child span { top: 2px; }

  .grid-columns-container { display: flex; flex: 1; position: relative; }
  .day-column {
    width: var(--day-col-width); flex-shrink: 0; border-right: 1px solid var(--line-color); position: relative;
    background-image: linear-gradient(to bottom, var(--line-color) 1px, transparent 1px); background-size: 100% var(--grid-h);
    padding-bottom: 20px; cursor: pointer;
  }

  /* Standard Blocked Slot (Pattern) - Blue/Gray */
  .blocked-slot {
    position: absolute; left: 0; right: 0; height: var(--grid-h);
    background: repeating-linear-gradient(45deg, rgba(255,255,255,0.03), rgba(255,255,255,0.03) 10px, rgba(255,255,255,0.06) 10px, rgba(255,255,255,0.06) 20px);
    pointer-events: none; z-index: 1;
  }
  
  /* Exception Range Block (Partial Day) - Red/Warm */
  .blocked-range-part {
    position: absolute; left: 0; right: 0;
    background: repeating-linear-gradient(45deg, rgba(255, 69, 58, 0.1), rgba(255, 69, 58, 0.1) 10px, rgba(255, 69, 58, 0.2) 10px, rgba(255, 69, 58, 0.2) 20px);
    border-top: 1px solid rgba(255, 69, 58, 0.4);
    border-bottom: 1px solid rgba(255, 69, 58, 0.4);
    z-index: 2; pointer-events: none;
    display: flex; justify-content: center; align-items: center;
  }
  .blocked-range-part::after {
    content: 'НЕ РАБОТАЮ';
    font-size: 10px; font-weight: 700; color: rgba(255, 69, 58, 0.7);
    transform: rotate(-45deg); letter-spacing: 1px;
  }
  
  /* Full Day Off Overlay */
  .day-off-overlay {
    position: absolute; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: grayscale(100%); z-index: 8;
    display: flex; align-items: center; justify-content: center; writing-mode: vertical-rl; text-orientation: mixed;
    color: rgba(255,255,255,0.3); font-weight: 800; font-size: 24px; letter-spacing: 4px; pointer-events: none;
  }

  .global-time-line {
    position: absolute; left: 0; width: 100%; height: 1px; background: var(--acc-red); z-index: 10; pointer-events: none;
    box-shadow: 0 0 6px rgba(255, 69, 58, 0.6); display: none;
  }
  .global-time-line::before { content: ''; position: absolute; left: -3px; top: -3px; width: 7px; height: 7px; background: var(--acc-red); border-radius: 50%; }

  .event-card {
    position: absolute; left: 2px; right: 2px; border-radius: 4px; padding: 3px 5px; overflow: hidden; border-left: 2px solid;
    background: rgba(28, 28, 30, 0.9); cursor: pointer; z-index: 5; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }
  .ev-title { font-size: 10px; font-weight: 700; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
  .ev-time { font-size: 9px; color: rgba(255,255,255,0.8); margin-top: 1px; }
  .event-card.personal { border-left-color: #BF5AF2; background: rgba(191, 90, 242, 0.25); }
  .event-card.client { border-left-color: var(--acc-blue); background: rgba(10, 132, 255, 0.25); }

  /* === PATTERN EDITOR OVERLAY & FULL WIDTH LOGIC === */
  .pattern-editor-overlay {
    position: fixed; inset: 0; background: var(--bg-core); z-index: 100;
    display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
  }
  .pattern-editor-overlay.open { transform: translateY(0); }
  
  .pe-header {
    background: rgba(10, 132, 255, 0.1); border-bottom: 1px solid var(--acc-blue);
    padding-top: calc(10px + var(--safe-top)); padding-bottom: 10px; flex-shrink: 0;
  }
  .pe-title { font-size: 16px; font-weight: 700; color: #fff; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 8px;}
  .pe-badge { background: var(--acc-blue); padding: 2px 6px; border-radius: 4px; font-size: 10px; }
  
  .pattern-editor-overlay .matrix-body, 
  .pattern-editor-overlay .matrix-header-row { width: 100%; }
  
  .pattern-editor-overlay .day-col-header, 
  .pattern-editor-overlay .day-column { width: auto; flex: 1; }

  .pattern-editor-overlay .blocked-slot {
    background: repeating-linear-gradient(45deg, rgba(10,132,255,0.15), rgba(10,132,255,0.15) 10px, rgba(10,132,255,0.25) 10px, rgba(10,132,255,0.25) 20px);
    pointer-events: auto; cursor: pointer;
    border-top: 1px solid rgba(10,132,255,0.3); border-bottom: 1px solid rgba(10,132,255,0.3);
  }
  .pattern-editor-overlay .day-col-header:hover { background: rgba(255,255,255,0.1); }
  .pattern-editor-overlay .time-label:hover { background: rgba(255,255,255,0.1); }

  /* Sheets & Forms */
  .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 50; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(4px); }
  .sheet-overlay.active { opacity: 1; pointer-events: auto; }
  .sheet {
    position: fixed; bottom: 0; left: 0; right: 0; background: rgba(28, 28, 30, 0.95); backdrop-filter: blur(30px);
    border-radius: 20px 20px 0 0; padding: 24px 16px calc(24px + var(--safe-bottom)) 16px;
    transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); z-index: 51; border-top: 1px solid rgba(255,255,255,0.1);
  }
  .sheet.open { transform: translateY(0); }
  .sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .sh-title { font-size: 18px; font-weight: 700; color: #fff; }
  .sh-close { color: var(--acc-blue); font-size: 16px; font-weight: 500; cursor: pointer; }
  .form-group { margin-bottom: 16px; }
  .form-label { font-size: 12px; color: #8E8E93; margin-bottom: 6px; margin-left: 2px; text-transform: uppercase; }
  .input-box { width: 100%; background: rgba(118, 118, 128, 0.24); border: none; border-radius: 10px; padding: 12px; color: #fff; font-size: 16px; appearance: none; }
  .input-row { display: flex; gap: 12px; }
  .btn-primary { width: 100%; padding: 14px; background: #fff; color: #000; font-weight: 600; font-size: 16px; border-radius: 12px; border: none; margin-top: 12px; cursor: pointer; }
  .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
  .btn-danger { background: rgba(255, 69, 58, 0.15); color: var(--acc-red); }

  /* Ranges List Style */
  .ranges-list { max-height: 200px; overflow-y: auto; margin-top: 10px; }
  .range-item {
    display: flex; justify-content: space-between; align-items: center;
    background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 8px;
  }
  .range-text { font-size: 14px; color: #fff; }
  .range-sub { font-size: 12px; color: #8E8E93; margin-top: 2px; }
  .range-del { color: var(--acc-red); padding: 4px; }

</style>
</head>
<body>

<div class="fx-layer">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="noise"></div>
</div>

<div class="app-container">
  <!-- Header -->
  <div class="top-area">
    <div class="header-row">
      <div class="month-label" id="headerMonth">НОЯБРЬ 2025</div>
      <div class="week-controls">
        <div class="icon-btn" id="settingsBtn" onclick="openSettings()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </div>
      </div>
    </div>
  </div>

  <!-- Infinite Matrix Viewport -->
  <div class="matrix-viewport" id="matrixViewport">
    <div class="matrix-header-row">
      <div class="corner-cell"></div>
      <div class="days-header-track" id="daysHeaderTrack"></div>
    </div>
    <div class="matrix-body">
      <div class="time-column" id="timeColumn"></div>
      <div class="grid-columns-container" id="gridColumns">
        <div class="global-time-line" id="globalTimeLine"></div>
      </div>
    </div>
  </div>
</div>

<!-- PATTERN EDITOR OVERLAY -->
<div class="pattern-editor-overlay" id="patternEditor">
  <div class="header-row pe-header">
    <div class="pe-title"><span class="pe-badge">ШАБЛОН</span>График работы</div>
    <div class="icon-btn" onclick="savePattern()" style="color: var(--acc-blue); font-weight:600; width:auto; font-size:14px;">Сохранить</div>
  </div>
  <div class="matrix-viewport">
    <div class="matrix-header-row">
      <div class="corner-cell"></div>
      <div class="days-header-track" id="peHeaderTrack"></div>
    </div>
    <div class="matrix-body">
      <div class="time-column" id="peTimeColumn"></div>
      <div class="grid-columns-container" id="peGridColumns"></div>
    </div>
  </div>
  <div style="padding: 16px; background: rgba(0,0,0,0.5); font-size: 13px; color: #8E8E93;">
    Нажмите на <b>день недели</b>, чтобы зачеркнуть весь день.<br>
    Нажмите на <b>время (слева)</b>, чтобы зачеркнуть этот час во всей неделе.
  </div>
</div>

<!-- Overlays -->
<div class="sheet-overlay" id="overlay" onclick="closeAllSheets()"></div>

<!-- Session Form -->
<div class="sheet" id="sessionSheet">
  <div class="sheet-header">
    <div class="sh-title" id="sheetTitle">Тренировка</div>
    <div class="sh-close" onclick="closeAllSheets()">Отмена</div>
  </div>
  <div class="form-group">
    <div class="form-label">Клиент</div>
    <select class="input-box" id="inpClient">
      <option value="Алиса В.">Алиса В.</option>
      <option value="Марк Д.">Марк Д.</option>
      <option value="Елена К.">Елена К.</option>
      <option value="Гость">Гость</option>
    </select>
  </div>
  <div class="form-group">
    <div class="form-label">Дата</div>
    <input type="date" class="input-box" id="inpDate">
  </div>
  <div class="input-row">
    <div class="form-group" style="flex:1">
      <div class="form-label">Начало</div>
      <input type="time" class="input-box" id="inpStart">
    </div>
    <div class="form-group" style="flex:1">
      <div class="form-label">Конец</div>
      <input type="time" class="input-box" id="inpEnd">
    </div>
  </div>
  <div class="form-group">
    <div class="form-label">Заметка</div>
    <input type="text" class="input-box" id="inpNote" placeholder="Тип тренировки...">
  </div>
  <button class="btn-primary" onclick="saveSession()">Сохранить</button>
  <button class="btn-primary btn-danger" id="btnDelete" style="display:none" onclick="deleteSession()">Удалить</button>
</div>

<!-- Day Options Sheet (Single day) -->
<div class="sheet" id="dayOptionsSheet">
  <div class="sheet-header">
    <div class="sh-title" id="dayOptionsTitle">Настройки дня</div>
    <div class="sh-close" onclick="closeAllSheets()">Закрыть</div>
  </div>
  <div class="form-group">
    <div class="form-label">Статус дня</div>
    <button class="btn-primary btn-danger" onclick="toggleDayOff()">Сделать выходным</button>
    <button class="btn-primary btn-secondary" onclick="clearDayOff()" style="margin-top:12px;">Сбросить (Рабочий)</button>
  </div>
</div>

<!-- Special Ranges Sheet (With TIME) -->
<div class="sheet" id="rangesSheet">
  <div class="sheet-header">
    <div class="sh-title">Отпуск / Периоды</div>
    <div class="sh-close" onclick="closeAllSheets()">Закрыть</div>
  </div>
  
  <div class="form-group">
    <div class="form-label">Начало (Дата и Время)</div>
    <div class="input-row">
        <input type="date" class="input-box" id="rangeStartDate" style="flex:1.5">
        <input type="time" class="input-box" id="rangeStartTime" value="00:00" style="flex:1">
    </div>
  </div>
  
  <div class="form-group">
    <div class="form-label">Конец (Дата и Время)</div>
    <div class="input-row">
        <input type="date" class="input-box" id="rangeEndDate" style="flex:1.5">
        <input type="time" class="input-box" id="rangeEndTime" value="23:59" style="flex:1">
    </div>
  </div>
  
  <button class="btn-primary" onclick="addRange()">Добавить период</button>

  <div class="form-group" style="margin-top: 20px;">
    <div class="form-label">Активные периоды</div>
    <div class="ranges-list" id="rangesList"></div>
  </div>
</div>

<!-- Settings Sheet -->
<div class="sheet" id="settingsSheet">
  <div class="sheet-header">
    <div class="sh-title">Настройки</div>
    <div class="sh-close" onclick="closeAllSheets()">Готово</div>
  </div>
  <div class="form-group">
    <div class="form-label">График работы</div>
    <button class="btn-primary" onclick="openPatternEditor()">Редактор шаблона (7 дней)</button>
    <div style="color:#8E8E93; font-size:13px; margin-top:8px;">Настройте стандартные рабочие дни.</div>
  </div>
  <div class="form-group">
    <div class="form-label">Особые даты</div>
    <button class="btn-primary btn-secondary" onclick="openRangesSheet()">Отпуск / Периоды</button>
    <div style="color:#8E8E93; font-size:13px; margin-top:8px;">Форс-мажоры, отпуск, частичная занятость.</div>
  </div>
</div>

<script>
  const GRID_H = 60; 
  const DAYS_BACK = 14;
  const DAYS_FORWARD = 60;
  
  let startDate = new Date();
  startDate.setDate(startDate.getDate() - DAYS_BACK);

  let updateInterval;
  let selectedDayForOptions = null;
  
  // Storage Keys
  const STORAGE_KEY_PATTERN = 'ultima_coach_pattern';
  const STORAGE_KEY_EXCEPTIONS = 'ultima_coach_exceptions';
  const STORAGE_KEY_RANGES = 'ultima_coach_ranges';

  let availabilityPattern = { 0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: [] };
  let dateExceptions = {};
  // New Range Structure: { start: 'ISO_STRING', end: 'ISO_STRING' }
  let specialRanges = []; 
  
  let sessions = [
    { id: 1, dateStr: getDateStr(0), client: 'Алиса В.', start: '09:00', end: '10:00', note: 'Кардио', status: 'done', type: 'client' },
    { id: 2, dateStr: getDateStr(0), client: 'Марк Д.', start: '10:30', end: '12:00', note: 'Силовая', status: 'planned', type: 'personal' }
  ];
  let editingId = null;

  function getDateStr(offset) {
    const d = new Date(); d.setDate(d.getDate() + offset);
    return d.toISOString().split('T')[0];
  }

  function init() {
    loadScheduleData();
    renderTimeColumn();
    renderTimeline();
    
    if (!localStorage.getItem(STORAGE_KEY_PATTERN)) {
      availabilityPattern[0] = [0,1,2,3,4,5,6,7];
      availabilityPattern[6] = Array.from({length:24},(_,i)=>i);
    }
    
    reRenderBlocks();
    scrollToToday();
    startClock();
    document.getElementById('matrixViewport').addEventListener('scroll', onScroll);
    
    const tg = window.Telegram?.WebApp;
    if(tg) { tg.ready(); tg.expand(); try { tg.setHeaderColor('#050505'); tg.setBackgroundColor('#050505'); } catch(e){} }
  }

  // === PERSISTENCE ===
  function loadScheduleData() {
    try {
      const p = localStorage.getItem(STORAGE_KEY_PATTERN);
      if (p) availabilityPattern = JSON.parse(p);
      const e = localStorage.getItem(STORAGE_KEY_EXCEPTIONS);
      if (e) dateExceptions = JSON.parse(e);
      const r = localStorage.getItem(STORAGE_KEY_RANGES);
      if (r) specialRanges = JSON.parse(r);
    } catch (err) { console.error(err); }
  }

  function saveScheduleData() {
    try {
      localStorage.setItem(STORAGE_KEY_PATTERN, JSON.stringify(availabilityPattern));
      localStorage.setItem(STORAGE_KEY_EXCEPTIONS, JSON.stringify(dateExceptions));
      localStorage.setItem(STORAGE_KEY_RANGES, JSON.stringify(specialRanges));
    } catch (err) { console.error(err); }
  }

  // === RENDERERS ===
  function renderTimeColumn() {
    const col = document.getElementById('timeColumn');
    col.innerHTML = '';
    for(let i=0; i<24; i++) {
      const el = document.createElement('div');
      el.className = 'time-label';
      el.innerHTML = `<span>${String(i).padStart(2,'0')}:00</span>`;
      col.appendChild(el);
    }
  }

  function renderTimeline() {
    const headerTrack = document.getElementById('daysHeaderTrack');
    const gridContainer = document.getElementById('gridColumns');
    const globalLine = document.getElementById('globalTimeLine');

    gridContainer.innerHTML = ''; gridContainer.appendChild(globalLine);
    headerTrack.innerHTML = '';

    const weekDays = ['ПН','ВТ','СР','ЧТ','ПТ','СБ','ВС'];
    const todayStr = new Date().toISOString().split('T')[0];
    const totalDays = DAYS_BACK + DAYS_FORWARD;

    for (let i = 0; i < totalDays; i++) {
      const d = new Date(startDate);
      d.setDate(d.getDate() + i);
      const dateStr = d.toISOString().split('T')[0];
      const isToday = (dateStr === todayStr);
      let dayIdx = d.getDay() - 1; if(dayIdx === -1) dayIdx = 6;

      const hCell = document.createElement('div');
      hCell.className = `day-col-header ${isToday ? 'today' : ''}`;
      hCell.id = `header-${dateStr}`;
      hCell.setAttribute('data-date', dateStr);
      hCell.innerHTML = `<div class="dch-day">${weekDays[dayIdx]}</div><div class="dch-num">${d.getDate()}</div>`;
      hCell.onclick = () => openDayOptions(dateStr, `${weekDays[dayIdx]} ${d.getDate()}`);
      headerTrack.appendChild(hCell);

      const col = document.createElement('div');
      col.className = 'day-column';
      col.setAttribute('data-date', dateStr);
      col.setAttribute('data-day-idx', dayIdx);
      
      renderEventsForColumn(col, dateStr);

      col.onclick = (e) => {
        if (e.target !== col) return;
        const h = Math.floor(e.offsetY / GRID_H);
        const setD = new Date(d); setD.setHours(h, 0);
        openAddSession(setD);
      };
      gridContainer.appendChild(col);
    }
    reRenderBlocks();
  }

  function reRenderBlocks() {
    const cols = document.querySelectorAll('#gridColumns .day-column');
    cols.forEach(col => {
      col.querySelectorAll('.blocked-slot, .day-off-overlay, .blocked-range-part').forEach(e => e.remove());
      const dateStr = col.getAttribute('data-date');
      const dayIdx = parseInt(col.getAttribute('data-day-idx'));
      
      // 1. Standard Pattern
      const blockedHours = availabilityPattern[dayIdx] || [];
      blockedHours.forEach(h => {
        const blk = document.createElement('div');
        blk.className = 'blocked-slot';
        blk.style.top = `${h * GRID_H}px`;
        col.appendChild(blk);
      });

      // 2. Single Day Exception (Legacy)
      if (dateExceptions[dateStr] === 'off') {
        const overlay = document.createElement('div');
        overlay.className = 'day-off-overlay';
        overlay.innerHTML = 'ВЫХОДНОЙ';
        col.appendChild(overlay);
        return; // Full block, stop processing ranges
      }

      // 3. Time Ranges Logic
      // Check every range to see if it overlaps with THIS day
      // This day goes from dateStrT00:00 to dateStrT23:59
      const colStart = new Date(dateStr + 'T00:00:00').getTime();
      const colEnd = new Date(dateStr + 'T23:59:59').getTime();

      specialRanges.forEach(range => {
        const rStart = new Date(range.start).getTime();
        const rEnd = new Date(range.end).getTime();

        // Check overlapping
        const overlapStart = Math.max(colStart, rStart);
        const overlapEnd = Math.min(colEnd, rEnd);

        if (overlapStart < overlapEnd) {
            // There is an overlap!
            
            // Check if it covers full day (approx check within a minute)
            if (overlapStart <= colStart && overlapEnd >= colEnd - 60000) {
                // Full Day Overlay
                if (!col.querySelector('.day-off-overlay')) {
                    const overlay = document.createElement('div');
                    overlay.className = 'day-off-overlay';
                    overlay.innerHTML = 'ВЫХОДНОЙ';
                    col.appendChild(overlay);
                }
            } else {
                // Partial Block
                // Convert back to pixels relative to day start
                const diffMs = overlapStart - colStart;
                const durationMs = overlapEnd - overlapStart;
                
                const topPx = (diffMs / (1000 * 60 * 60)) * GRID_H;
                const heightPx = (durationMs / (1000 * 60 * 60)) * GRID_H;
                
                const part = document.createElement('div');
                part.className = 'blocked-range-part';
                part.style.top = `${topPx}px`;
                part.style.height = `${heightPx}px`;
                col.appendChild(part);
            }
        }
      });
    });
  }

  function renderEventsForColumn(col, dateStr) {
     col.querySelectorAll('.event-card').forEach(e => e.remove());
     const dayEvents = sessions.filter(s => s.dateStr === dateStr);
     dayEvents.forEach(ev => { col.appendChild(createEventEl(ev)); });
  }

  function createEventEl(ev) {
    const div = document.createElement('div');
    const [h, m] = ev.start.split(':').map(Number);
    const [hE, mE] = ev.end.split(':').map(Number);
    const top = (h*60 + m) / 60 * GRID_H;
    const height = (hE*60 + mE - (h*60+m)) / 60 * GRID_H;
    div.className = `event-card ${ev.type} ${ev.status}`;
    div.style.top = `${top}px`;
    div.style.height = `${Math.max(height, 20)}px`;
    div.innerHTML = `<div class="ev-title">${ev.client}</div><div class="ev-time">${ev.start} - ${ev.end}</div>`;
    div.onclick = (e) => { e.stopPropagation(); openEdit(ev); };
    return div;
  }

  // === RANGES LOGIC ===
  function openRangesSheet() {
      closeAllSheets();
      renderRangesList();
      openSheet('rangesSheet');
  }

  function addRange() {
      const dS = document.getElementById('rangeStartDate').value;
      const tS = document.getElementById('rangeStartTime').value;
      const dE = document.getElementById('rangeEndDate').value;
      const tE = document.getElementById('rangeEndTime').value;
      
      if (!dS || !tS || !dE || !tE) return alert('Заполните все поля');
      
      // Create ISO strings
      const startISO = `${dS}T${tS}`;
      const endISO = `${dE}T${tE}`;
      
      if (startISO >= endISO) return alert('Начало должно быть раньше конца');
      
      specialRanges.push({ start: startISO, end: endISO });
      saveScheduleData();
      
      // Reset
      document.getElementById('rangeStartDate').value = '';
      document.getElementById('rangeEndDate').value = '';
      
      renderRangesList();
      reRenderBlocks();
  }

  function deleteRange(idx) {
      specialRanges.splice(idx, 1);
      saveScheduleData();
      renderRangesList();
      reRenderBlocks();
  }

  function renderRangesList() {
      const list = document.getElementById('rangesList');
      list.innerHTML = '';
      if (specialRanges.length === 0) {
          list.innerHTML = '<div style="color:#8E8E93; font-size:13px; text-align:center;">Нет активных периодов</div>';
          return;
      }
      
      specialRanges.forEach((r, idx) => {
          const item = document.createElement('div');
          item.className = 'range-item';
          const format = (iso) => {
              const d = new Date(iso);
              return `${d.getDate()}.${d.getMonth()+1} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
          };
          item.innerHTML = `
            <div>
                <div class="range-text">${format(r.start)} — ${format(r.end)}</div>
                <div class="range-sub">Недоступно</div>
            </div>
            <div class="range-del" onclick="deleteRange(${idx})">
               <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            </div>
          `;
          list.appendChild(item);
      });
  }

  // === EDITOR LOGIC ===
  function openPatternEditor() { closeAllSheets(); document.getElementById('patternEditor').classList.add('open'); renderPatternEditor(); }
  function savePattern() { document.getElementById('patternEditor').classList.remove('open'); saveScheduleData(); reRenderBlocks(); }
  function renderPatternEditor() {
    const weekDays = ['ПН','ВТ','СР','ЧТ','ПТ','СБ','ВС'];
    const timeCol = document.getElementById('peTimeColumn'); timeCol.innerHTML = '';
    for(let i=0; i<24; i++) {
      const el = document.createElement('div'); el.className = 'time-label';
      el.innerHTML = `<span>${String(i).padStart(2,'0')}:00</span>`;
      el.onclick = () => toggleRowPattern(i); timeCol.appendChild(el);
    }
    const headerTrack = document.getElementById('peHeaderTrack'); headerTrack.innerHTML = '';
    for(let i=0; i<7; i++) {
      const hCell = document.createElement('div'); hCell.className = 'day-col-header';
      hCell.innerHTML = `<div class="dch-day" style="margin-top:16px;">${weekDays[i]}</div>`;
      hCell.onclick = () => toggleColPattern(i); headerTrack.appendChild(hCell);
    }
    const gridCont = document.getElementById('peGridColumns'); gridCont.innerHTML = '';
    for(let i=0; i<7; i++) {
      const col = document.createElement('div'); col.className = 'day-column';
      col.onclick = (e) => { if(e.target !== col) return; toggleSinglePattern(i, Math.floor(e.offsetY / GRID_H)); };
      renderPatternBlocksForCol(col, i); gridCont.appendChild(col);
    }
  }
  function renderPatternBlocksForCol(col, dayIdx) {
    col.innerHTML = ''; const blocked = availabilityPattern[dayIdx] || [];
    blocked.forEach(h => {
      const blk = document.createElement('div'); blk.className = 'blocked-slot'; blk.style.top = `${h * GRID_H}px`;
      blk.onclick = (e) => { e.stopPropagation(); toggleSinglePattern(dayIdx, h); }; col.appendChild(blk);
    });
  }
  function toggleSinglePattern(dayIdx, hour) {
    const arr = availabilityPattern[dayIdx]; const idx = arr.indexOf(hour);
    if(idx === -1) arr.push(hour); else arr.splice(idx, 1);
    renderPatternBlocksForCol(document.getElementById('peGridColumns').children[dayIdx], dayIdx);
  }
  function toggleRowPattern(hour) {
    let allBlocked = true; for(let d=0; d<7; d++) { if(!availabilityPattern[d].includes(hour)) { allBlocked = false; break; } }
    for(let d=0; d<7; d++) {
      const arr = availabilityPattern[d]; const idx = arr.indexOf(hour);
      if(allBlocked && idx !== -1) arr.splice(idx, 1); if(!allBlocked && idx === -1) arr.push(hour);
    }
    const grid = document.getElementById('peGridColumns'); for(let d=0; d<7; d++) renderPatternBlocksForCol(grid.children[d], d);
  }
  function toggleColPattern(dayIdx) {
    const arr = availabilityPattern[dayIdx]; if(arr.length === 24) availabilityPattern[dayIdx] = []; else availabilityPattern[dayIdx] = Array.from({length:24},(_,i)=>i);
    renderPatternBlocksForCol(document.getElementById('peGridColumns').children[dayIdx], dayIdx);
  }

  // === SCROLL & UTIL ===
  function scrollToToday() {
    const todayStr = new Date().toISOString().split('T')[0]; const headerEl = document.getElementById(`header-${todayStr}`);
    if (headerEl) { document.getElementById('matrixViewport').scrollLeft = headerEl.offsetLeft - 70; document.getElementById('matrixViewport').scrollTop = 8 * GRID_H; }
  }
  function onScroll() {
    const viewport = document.getElementById('matrixViewport'); const headers = document.querySelectorAll('#daysHeaderTrack .day-col-header');
    for (let h of headers) { if (h.offsetLeft >= viewport.scrollLeft) { 
      const d = new Date(h.getAttribute('data-date')); document.getElementById('headerMonth').textContent = `${d.toLocaleString('ru', { month: 'long' }).toUpperCase()} ${d.getFullYear()}`; break; 
    }}
  }

  // Forms
  function openAddSession(d) {
    editingId = null; document.getElementById('sheetTitle').textContent = 'Новая тренировка'; document.getElementById('btnDelete').style.display = 'none';
    document.getElementById('inpDate').value = d.toISOString().split('T')[0];
    const h = d.getHours();
    document.getElementById('inpStart').value = `${String(h).padStart(2,'0')}:00`; document.getElementById('inpEnd').value = `${String(h+1).padStart(2,'0')}:00`;
    document.getElementById('inpNote').value = ''; openSheet('sessionSheet');
  }
  function openEdit(s) {
    editingId = s.id; document.getElementById('sheetTitle').textContent = 'Редактировать'; document.getElementById('btnDelete').style.display = 'block';
    document.getElementById('inpClient').value = s.client; document.getElementById('inpDate').value = s.dateStr;
    document.getElementById('inpStart').value = s.start; document.getElementById('inpEnd').value = s.end; document.getElementById('inpNote').value = s.note || ''; openSheet('sessionSheet');
  }
  function saveSession() {
    const client = document.getElementById('inpClient').value; const dateStr = document.getElementById('inpDate').value;
    const start = document.getElementById('inpStart').value; const end = document.getElementById('inpEnd').value; const note = document.getElementById('inpNote').value;
    if(editingId) {
      const idx = sessions.findIndex(s => s.id === editingId); if(idx !== -1) sessions[idx] = { ...sessions[idx], client, dateStr, start, end, note };
    } else { sessions.push({ id: Date.now(), client, dateStr, start, end, note, status: 'planned', type: client === 'Гость' ? 'personal' : 'client' }); }
    closeAllSheets(); const col = document.querySelector(`.day-column[data-date="${dateStr}"]`); if(col) renderEventsForColumn(col, dateStr);
  }
  function deleteSession() {
    if(editingId) {
       const s = sessions.find(s => s.id === editingId); sessions = sessions.filter(x => x.id !== editingId);
       if(s) { const col = document.querySelector(`.day-column[data-date="${s.dateStr}"]`); if(col) renderEventsForColumn(col, s.dateStr); }
       closeAllSheets();
    }
  }
  function openDayOptions(dateStr, title) { selectedDayForOptions = dateStr; document.getElementById('dayOptionsTitle').textContent = title; openSheet('dayOptionsSheet'); }
  function toggleDayOff() { if(selectedDayForOptions) { dateExceptions[selectedDayForOptions] = 'off'; saveScheduleData(); reRenderBlocks(); closeAllSheets(); } }
  function clearDayOff() { if(selectedDayForOptions) { delete dateExceptions[selectedDayForOptions]; saveScheduleData(); reRenderBlocks(); closeAllSheets(); } }
  function openSettings() { openSheet('settingsSheet'); }
  function openSheet(id) { document.getElementById('overlay').classList.add('active'); document.getElementById(id).classList.add('open'); }
  function closeAllSheets() { document.getElementById('overlay').classList.remove('active'); document.querySelectorAll('.sheet').forEach(s => s.classList.remove('open')); }
  function startClock() { updateClock(); if(updateInterval) clearInterval(updateInterval); updateInterval = setInterval(updateClock, 60000); }
  function updateClock() { document.getElementById('globalTimeLine').style.top = `${(new Date().getHours()*60 + new Date().getMinutes())/60*GRID_H}px`; document.getElementById('globalTimeLine').style.display = 'block'; }

  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
