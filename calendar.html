<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Ultima Coach Infinite</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  /* === CORE STYLES === */
  :root {
    --bg-core: #050505; 
    --bg-panel: #1C1C1E; 
    --text-main: #ffffff;
    --text-muted: #8E8E93;
    
    --line-color: rgba(255, 255, 255, 0.08);
    --time-col-width: 55px;
    --day-col-width: 65px; 
    
    --acc-blue: #0a84ff;
    --acc-red: #ff453a;
    --acc-green: #30d158;
    --acc-purple: #5e60ce;
    --acc-current: #3c9cfd;
    
    --grid-h: 60px;
    --safe-top: env(safe-area-inset-top);
    --safe-bottom: env(safe-area-inset-bottom);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
  *::-webkit-scrollbar { display: none; }

  body {
    background-color: var(--bg-core);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', Roboto, sans-serif;
    color: var(--text-main);
    height: 100%; width: 100%;
    overflow: hidden; position: fixed; inset: 0; user-select: none;
  }

  /* === FX LAYER === */
  .fx-layer { position: absolute; inset: 0; z-index: 0; pointer-events: none; }
  .orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.5; will-change: transform; }
  .orb-1 { width: 300px; height: 300px; background: var(--acc-purple); top: -50px; left: -100px; animation: float 20s infinite ease-in-out; }
  .orb-2 { width: 250px; height: 250px; background: var(--acc-blue); bottom: -50px; right: -50px; animation: float 15s infinite ease-in-out reverse; }
  .noise { position: fixed; inset: 0; opacity: 0.04; background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); }
  @keyframes float { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(30px, 50px); } }

  /* === LAYOUT === */
  .app-container { display: flex; flex-direction: column; height: 100%; width: 100%; position: relative; z-index: 1; }

  /* === TOP HEADER === */
  .top-area {
    position: relative;
    background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--line-color); padding-top: calc(10px + var(--safe-top)); padding-bottom: 4px;
    z-index: 60; flex-shrink: 0;
  }
  .header-row { display: flex; justify-content: space-between; align-items: center; padding: 0 16px; margin-bottom: 10px; }
  .month-label { font-family: 'SF Pro Display', sans-serif; font-size: 15px; font-weight: 700; color: #fff; text-transform: uppercase; letter-spacing: 1px; }
  .week-controls { display: flex; gap: 16px; align-items: center; }
  .icon-btn { width: 32px; height: 32px; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; }

  /* === MATRIX === */
  .matrix-viewport {
    flex: 1; overflow: auto; position: relative; -webkit-overflow-scrolling: touch; overscroll-behavior: none;
    display: flex; flex-direction: column; z-index: 10;
  }
  .matrix-header-row {
    display: flex; position: sticky; top: 0; z-index: 40; width: max-content; background: rgba(0, 0, 0, 0.25);
    backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-bottom: 1px solid var(--line-color);
  }
  .corner-cell { width: var(--time-col-width); flex-shrink: 0; position: sticky; left: 0; z-index: 50; background: inherit; border-right: 1px solid var(--line-color); }
  .days-header-track { display: flex; flex: 1; }
  .day-col-header {
    width: var(--day-col-width); flex-shrink: 0; text-align: center; height: 58px; 
    padding: 8px 0 0 0;
    font-size: 11px; color: var(--text-muted); border-right: 1px solid var(--line-color);
    display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
    gap: 2px; position: relative; cursor: pointer;
  }
  .dch-day { font-weight: 600; text-transform: uppercase; line-height: 1; }
  .dch-num { font-size: 16px; font-weight: 500; color: #fff; line-height: 1; }
  .day-col-header.today .dch-day { color: var(--acc-blue); }
  .day-col-header.today::after { content: ''; width: 4px; height: 4px; border-radius: 50%; background: var(--acc-blue); margin-top: 0px; box-shadow: 0 0 6px var(--acc-blue); }
  .dch-stats { width: 32px; height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 5px; overflow: hidden; display: flex; }
  .dch-stats-fill { height: 100%; background: var(--acc-current); width: 0%; transition: width 0.3s ease, background 0.3s ease; }
  .matrix-body { display: flex; width: max-content; position: relative; }
  .time-column {
    width: var(--time-col-width); flex-shrink: 0; position: sticky; left: 0; z-index: 30;
    background: rgba(0, 0, 0, 0.25); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
    border-right: 1px solid var(--line-color); padding-bottom: 20px;
  }
  .time-label { height: var(--grid-h); position: relative; cursor: pointer; } 
  .time-label span { position: absolute; top: -7px; right: 6px; font-size: 11px; font-weight: 500; color: var(--text-muted); font-variant-numeric: tabular-nums; }
  .time-label:first-child span { top: 2px; }
  .time-line-badge {
    position: absolute; right: 4px; background: var(--acc-current); color: #fff; font-size: 11px; font-weight: 700;
    padding: 2px 6px; border-radius: 4px; z-index: 31; transform: translateY(-50%); pointer-events: none;
    font-variant-numeric: tabular-nums; text-align: center; min-width: 40px; display: none;
  }
  .grid-columns-container { display: flex; flex: 1; position: relative; }
  .day-column {
    width: var(--day-col-width); flex-shrink: 0; border-right: 1px solid var(--line-color); position: relative;
    background-image: linear-gradient(to bottom, var(--line-color) 1px, transparent 1px); background-size: 100% var(--grid-h);
    padding-bottom: 20px; cursor: pointer; touch-action: pan-y;
  }
  .touch-feedback {
    position: absolute; width: 100%; background: rgba(60, 156, 253, 0.25); border-radius: 4px; pointer-events: none; z-index: 20;
    animation: pulse-create 0.6s infinite ease-in-out; border: 1px solid var(--acc-current);
    display: flex; align-items: center; justify-content: center;
  }
  .touch-feedback::after { content: '+'; font-size: 24px; font-weight: 300; color: #fff; opacity: 0.9; }
  @keyframes pulse-create { 0% { opacity: 0.3; transform: scale(0.98); } 50% { opacity: 0.7; transform: scale(1.0); } 100% { opacity: 0.3; transform: scale(0.98); } }
  .blocked-slot { position: absolute; left: 0; right: 0; height: var(--grid-h); background: repeating-linear-gradient(45deg, rgba(255,255,255,0.03), rgba(255,255,255,0.03) 10px, rgba(255,255,255,0.06) 10px, rgba(255,255,255,0.06) 20px); pointer-events: none; z-index: 1; }
  .blocked-range-part { position: absolute; left: 0; right: 0; background-color: var(--bg-core); background-image: repeating-linear-gradient(45deg, rgba(60, 156, 253, 0.1), rgba(60, 156, 253, 0.1) 10px, rgba(60, 156, 253, 0.2) 10px, rgba(60, 156, 253, 0.2) 20px); border-top: 1px solid rgba(60, 156, 253, 0.4); border-bottom: 1px solid rgba(60, 156, 253, 0.4); z-index: 2; pointer-events: none; }
  .day-off-overlay { position: absolute; inset: 0; background-color: var(--bg-core); background-image: repeating-linear-gradient(45deg, rgba(60, 156, 253, 0.1), rgba(60, 156, 253, 0.1) 10px, rgba(60, 156, 253, 0.2) 10px, rgba(60, 156, 253, 0.2) 20px); z-index: 8; pointer-events: none; }
  .global-time-line { position: absolute; left: 0; width: 100%; height: 1px; background: var(--acc-current); z-index: 10; pointer-events: none; display: none; }
  .global-time-line::before { content: ''; position: absolute; left: -4px; top: -3px; width: 7px; height: 7px; background: var(--acc-current); border-radius: 50%; }
  .event-card { position: absolute; left: 2px; right: 2px; border-radius: 6px; padding: 3px 5px; overflow: hidden; border-left: 3px solid; background: rgba(30, 30, 32, 0.95); cursor: pointer; z-index: 5; box-shadow: 0 2px 8px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); }
  .event-card.ghost { opacity: 0.7; border-style: dashed; }
  .ev-title { font-size: 11px; font-weight: 700; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
  .ev-time { font-size: 9px; color: rgba(255,255,255,0.9); margin-top: 1px; font-weight: 500; }

  /* === OVERLAYS === */
  .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(4px); }
  .sheet-overlay.active { opacity: 1; pointer-events: auto; }
  
  /* STANDARD SHEET (DEFAULT) */
  .sheet {
    position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-panel);
    border-radius: 20px 20px 0 0; padding: 0 16px calc(24px + var(--safe-bottom)) 16px;
    transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); z-index: 101; border-top: 1px solid rgba(255,255,255,0.1);
    max-height: 90vh; overflow-y: auto;
  }
  .sheet.open { transform: translateY(0); }

  /* === FIXED LAYOUT SHEET (FOR CLIENT EDIT) === */
  .sheet.fixed-layout {
    display: flex; flex-direction: column;
    height: 85vh; /* Fixed tall height */
    padding: 0; /* Reset padding for flex control */
    overflow: hidden; /* Body doesn't scroll, inner does */
  }
  .sheet.fixed-layout .sheet-header {
    margin: 0; padding: 20px 16px 10px 16px; flex-shrink: 0;
    position: relative; top: auto; /* Reset sticky */
  }
  .sheet-fixed-section { padding: 0 16px; flex-shrink: 0; }
  .sheet-scroll-area {
    flex: 1; overflow-y: auto; padding: 10px 16px;
    -webkit-overflow-scrolling: touch;
  }
  .sheet-fixed-footer {
    padding: 16px 16px calc(16px + var(--safe-bottom)) 16px;
    border-top: 1px solid rgba(255,255,255,0.05);
    background: var(--bg-panel); flex-shrink: 0;
    z-index: 10;
  }

  /* General Components */
  .sheet-header { display: flex; justify-content: space-between; align-items: center; margin: 0 -16px 20px -16px; position: sticky; top: 0; background: var(--bg-panel); z-index: 10; padding: 24px 16px 10px 16px; border-radius: 20px 20px 0 0; }
  .sh-title { font-size: 18px; font-weight: 700; color: #fff; }
  .sh-close { color: var(--acc-blue); font-size: 16px; font-weight: 500; cursor: pointer; }
  .form-group { margin-bottom: 16px; }
  .form-label { font-size: 12px; color: #8E8E93; margin-bottom: 6px; margin-left: 2px; text-transform: uppercase; }
  .input-box { width: 100%; background: rgba(118, 118, 128, 0.24); border: none; border-radius: 10px; padding: 12px; color: #fff; font-size: 16px; appearance: none; }
  .input-row { display: flex; gap: 12px; }
  .btn-primary { width: 100%; padding: 14px; background: #fff; color: #000; font-weight: 600; font-size: 16px; border-radius: 12px; border: none; margin-top: 0; cursor: pointer; }
  .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
  .btn-danger { background: rgba(255, 69, 58, 0.15); color: var(--acc-red); }

  .client-list-item { display: flex; align-items: center; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; margin-bottom: 8px; cursor: pointer; }
  .color-dot { width: 16px; height: 16px; border-radius: 50%; margin-right: 12px; border: 2px solid rgba(255,255,255,0.1); }
  .client-name { flex: 1; font-weight: 500; }
  
  .color-grid { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 16px; overflow-y: visible; padding: 22px; justify-content: flex-start; margin-left: -10px; width: calc(100% + 20px); }
  .color-option { width: 44px; height: 44px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.5); transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s; flex-shrink: 0; }
  .color-option.selected { border-color: #fff; transform: scale(1.25); box-shadow: 0 4px 12px rgba(255,255,255,0.4); z-index: 2; }

  .ranges-list { max-height: 200px; overflow-y: auto; margin-top: 10px; }
  .range-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 8px; }
  .range-text { font-size: 14px; color: #fff; }
  .range-sub { font-size: 12px; color: #8E8E93; margin-top: 2px; }
  .range-actions, .list-actions { display: flex; gap: 12px; }
  .range-icon { color: var(--text-muted); cursor: pointer; }
  .range-icon.edit { color: var(--acc-blue); }
  .range-icon.del { color: var(--acc-red); }
  .sched-row { display: flex; align-items: center; margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 12px; }
  .sched-day { width: 40px; font-weight: 600; font-size: 14px; color: #fff; }
  .sched-slots { flex: 1; display: flex; flex-wrap: wrap; gap: 6px; }
  .sched-chip { padding: 6px 10px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.3); text-shadow: 0 1px 1px rgba(0,0,0,0.3); }
  .sched-add { background: rgba(255,255,255,0.1); color: #fff; width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; }

  .pattern-editor-overlay { position: fixed; inset: 0; background: var(--bg-core); z-index: 102; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
  .pattern-editor-overlay.open { transform: translateY(0); }
  .pe-header { background: rgba(10, 132, 255, 0.1); border-bottom: 1px solid var(--acc-blue); padding-top: calc(10px + var(--safe-top)); padding-bottom: 10px; flex-shrink: 0; }
  .pe-title { font-size: 16px; font-weight: 700; color: #fff; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 8px;}
  .pe-badge { background: var(--acc-blue); padding: 2px 6px; border-radius: 4px; font-size: 10px; }
  .pattern-editor-overlay .matrix-body, .pattern-editor-overlay .matrix-header-row { width: 100%; }
  .pattern-editor-overlay .day-col-header, .pattern-editor-overlay .day-column { width: auto; flex: 1; }
  .pattern-editor-overlay .blocked-slot { background: repeating-linear-gradient(45deg, rgba(10,132,255,0.15), rgba(10,132,255,0.15) 10px, rgba(10,132,255,0.25) 10px, rgba(10,132,255,0.25) 20px); pointer-events: auto; cursor: pointer; border-top: 1px solid rgba(10,132,255,0.3); border-bottom: 1px solid rgba(10,132,255,0.3); }
</style>
</head>
<body oncontextmenu="return false;">

<div class="fx-layer"><div class="orb orb-1"></div><div class="orb orb-2"></div><div class="noise"></div></div>

<div class="app-container">
  <div class="top-area">
    <div class="header-row">
      <div class="month-label" id="headerMonth">НОЯБРЬ 2025</div>
      <div class="week-controls">
        <div class="icon-btn" id="settingsBtn" onclick="openSettings()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </div>
      </div>
    </div>
  </div>

  <div class="matrix-viewport" id="matrixViewport">
    <div class="matrix-header-row">
      <div class="corner-cell"></div>
      <div class="days-header-track" id="daysHeaderTrack"></div>
    </div>
    <div class="matrix-body">
      <div class="time-column" id="timeColumn"><div class="time-line-badge" id="timeLineBadge">00:00</div></div>
      <div class="grid-columns-container" id="gridColumns"><div class="global-time-line" id="globalTimeLine"></div></div>
    </div>
  </div>
</div>

<!-- PATTERN EDITOR -->
<div class="pattern-editor-overlay" id="patternEditor">
  <div class="header-row pe-header">
    <div class="pe-title"><span class="pe-badge">ШАБЛОН</span>График работы</div>
    <div class="icon-btn" onclick="savePattern()" style="color: var(--acc-blue); font-weight:600; width:auto; font-size:14px;">Сохранить</div>
  </div>
  <div class="matrix-viewport">
    <div class="matrix-header-row"><div class="corner-cell"></div><div class="days-header-track" id="peHeaderTrack"></div></div>
    <div class="matrix-body"><div class="time-column" id="peTimeColumn"></div><div class="grid-columns-container" id="peGridColumns"></div></div>
  </div>
  <div style="padding: 16px; background: rgba(0,0,0,0.5); font-size: 13px; color: #8E8E93;">Нажмите на день или время, чтобы заблокировать.</div>
</div>

<!-- Overlays -->
<div class="sheet-overlay" id="overlay" onclick="closeAllSheets()"></div>

<!-- Session Form -->
<div class="sheet" id="sessionSheet">
  <div class="sheet-header"><div class="sh-title" id="sheetTitle">Тренировка</div><div class="sh-close" onclick="closeAllSheets()">Отмена</div></div>
  <div class="form-group">
    <div class="form-label">Клиент</div>
    <select class="input-box" id="inpClient" onchange="onClientSelect()">
      <!-- Populated dynamically -->
    </select>
  </div>
  <div class="form-group"><div class="form-label">Дата</div><input type="date" class="input-box" id="inpDate"></div>
  <div class="input-row">
    <div class="form-group" style="flex:1"><div class="form-label">Начало</div><input type="time" class="input-box" id="inpStart"></div>
    <div class="form-group" style="flex:1"><div class="form-label">Конец</div><input type="time" class="input-box" id="inpEnd"></div>
  </div>
  <div class="form-group"><div class="form-label">Заметка</div><input type="text" class="input-box" id="inpNote" placeholder="Тип тренировки..."></div>
  <button class="btn-primary" onclick="saveSession()">Сохранить</button>
  <button class="btn-primary btn-danger" id="btnDelete" style="display:none" onclick="deleteSession()">Удалить</button>
</div>

<!-- Settings Sheet -->
<div class="sheet" id="settingsSheet">
  <div class="sheet-header"><div class="sh-title">Настройки</div><div class="sh-close" onclick="closeAllSheets()">Готово</div></div>
  <div class="form-group"><div class="form-label">График работы</div><button class="btn-primary" onclick="openPatternEditor()">Редактор шаблона (7 дней)</button></div>
  <div class="form-group"><div class="form-label">Особые даты</div><button class="btn-primary btn-secondary" onclick="openRangesSheet()">Отпуск / Периоды</button></div>
  <div class="form-group"><div class="form-label">База</div><button class="btn-primary btn-secondary" onclick="openClientsSheet()">Клиенты</button></div>
</div>

<!-- CLIENTS LIST Sheet -->
<div class="sheet" id="clientsSheet">
  <div class="sheet-header"><div class="sh-title">Клиенты</div><div class="sh-close" onclick="closeAllSheets()">Закрыть</div></div>
  <div class="form-group"><button class="btn-primary" onclick="openClientEdit()">+ Добавить клиента</button></div>
  <div id="clientsListContainer" style="margin-top:20px;"></div>
</div>

<!-- CLIENT EDIT Sheet (UPDATED FIXED LAYOUT) -->
<div class="sheet fixed-layout" id="clientEditSheet">
  <div class="sheet-header"><div class="sh-title" id="ceTitle">Новый клиент</div><div class="sh-close" onclick="openClientsSheet()">Назад</div></div>
  
  <div class="sheet-fixed-section">
    <div class="form-group"><div class="form-label">Имя</div><input type="text" class="input-box" id="ceName" placeholder="Иван И."></div>
  </div>
  
  <div class="sheet-scroll-area">
    <div class="form-group"><div class="form-label">Цвет</div>
      <div class="color-grid" id="ceColorGrid"></div>
      <input type="hidden" id="ceColor">
    </div>

    <div class="form-group">
      <div class="form-label">График посещений (Паттерн)</div>
      <div id="ceScheduleContainer" style="background: rgba(255,255,255,0.03); padding:10px; border-radius:8px;"></div>
    </div>
  </div>

  <div class="sheet-fixed-footer">
    <button class="btn-primary" onclick="saveClient()">Сохранить клиента</button>
  </div>
</div>

<!-- ADD TIME SLOT DIALOG -->
<div class="sheet" id="timeSlotSheet" style="z-index: 105;">
  <div class="sheet-header"><div class="sh-title">Добавить время</div><div class="sh-close" onclick="closeTimeSlotSheet()">Отмена</div></div>
  <div class="input-row">
    <input type="time" class="input-box" id="tsStart" value="16:00">
    <input type="time" class="input-box" id="tsEnd" value="17:00">
  </div>
  <button class="btn-primary" onclick="confirmTimeSlot()">Добавить</button>
</div>

<!-- Ranges Sheet -->
<div class="sheet" id="rangesSheet">
  <div class="sheet-header"><div class="sh-title">Отпуск / Периоды</div><div class="sh-close" onclick="closeAllSheets()">Закрыть</div></div>
  <div class="input-row"><input type="date" class="input-box" id="rangeStartDate"><input type="time" class="input-box" id="rangeStartTime" value="00:00"></div>
  <div class="input-row" style="margin-top:8px"><input type="date" class="input-box" id="rangeEndDate"><input type="time" class="input-box" id="rangeEndTime" value="23:59"></div>
  <button class="btn-primary" id="rangeSubmitBtn" onclick="addRange()" style="margin-top:12px">Добавить период</button>
  <div class="ranges-list" id="rangesList"></div>
</div>
<div class="sheet" id="dayOptionsSheet">
  <div class="sheet-header"><div class="sh-title" id="dayOptionsTitle">Настройки дня</div><div class="sh-close" onclick="closeAllSheets()">Закрыть</div></div>
  <button class="btn-primary btn-danger" onclick="toggleDayOff()">Сделать выходным</button>
  <button class="btn-primary btn-secondary" onclick="clearDayOff()" style="margin-top:12px;">Сбросить</button>
</div>

<script>
  // Твои оригинальные настройки
  const GRID_H = 60; let startOffset=-30, endOffset=60;
  let currentStart = getStartOfWeek(new Date()); currentStart.setDate(currentStart.getDate()+startOffset);
  let updateInterval; let selectedDayForOptions = null;
  
  // Переменные для Long Press
  let longPressTimer = null;
  let isScrolling = false;
  let activeTouchEl = null;

  const KEY_PATTERN = 'uc_pattern', KEY_EXCEPTIONS = 'uc_exceptions', KEY_RANGES = 'uc_ranges', KEY_CLIENTS = 'uc_clients', KEY_SESSIONS = 'uc_sessions';

  let availabilityPattern = {0:[],1:[],2:[],3:[],4:[],5:[],6:[]};
  let dateExceptions = {};
  let specialRanges = [];
  let editingRangeIndex = null;
  
  // НОВАЯ ПАЛИТРА (50 ГРАДИЕНТНЫХ ОТТЕНКОВ)
  const colorPalette = [
    // Grays (5)
    '#B0BEC5', '#90A4AE', '#78909C', '#607D8B', '#455A64',
    // Browns (3)
    '#BCAAA4', '#8D6E63', '#5D4037',
    // Reds (4)
    '#FF5252', '#FF1744', '#D50000', '#B71C1C',
    // Pinks (4)
    '#FF4081', '#F50057', '#C51162', '#880E4F',
    // Purples (4)
    '#E040FB', '#D500F9', '#AA00FF', '#4A148C',
    // Deep Blues (4)
    '#7C4DFF', '#651FFF', '#6200EA', '#311B92',
    // Blues (4)
    '#448AFF', '#2979FF', '#2962FF', '#0D47A1',
    // Cyans (4)
    '#40C4FF', '#00B0FF', '#0091EA', '#01579B',
    // Teals (4)
    '#18FFFF', '#00E5FF', '#00B8D4', '#006064',
    // Greens (4)
    '#69F0AE', '#00E676', '#00C853', '#1B5E20',
    // Limes (3)
    '#B2FF59', '#76FF03', '#64DD17',
    // Yellows (3)
    '#FFFF00', '#FFEA00', '#FFD600',
    // Oranges (4)
    '#FFD740', '#FFC400', '#FFAB00', '#FF6D00'
  ];

  let clients = []; 
  const defaultClients = [
    { id: 1, name: 'Алиса В.', color: '#00B0FF', schedule: { 0: [{s:'09:00', e:'10:00'}], 2: [{s:'09:00', e:'10:00'}] } }, 
    { id: 2, name: 'Марк Д.', color: '#00E676', schedule: { 0: [{s:'16:00', e:'17:00'}], 4: [{s:'16:00', e:'17:00'}], 2: [{s:'17:30', e:'18:30'}] } }
  ];
  let sessions = [];
  let editingId = null; 
  let editingClient = null; 
  let editingDayIdx = null; 

  function getDateStr(offset) { const d=new Date(); d.setDate(d.getDate()+offset); return d.toISOString().split('T')[0]; }
  function getStartOfWeek(date) { const d=new Date(date); const day=d.getDay(); const diff=d.getDate()-day+(day===0?-6:1); d.setDate(diff); d.setHours(0,0,0,0); return d; }

  function init() {
    loadData();
    renderTimeColumn(); renderDayRange(startOffset, endOffset);
    reRenderBlocks(); scrollToToday(); startClock();
    
    // Добавлен слушатель для отмены Long Press при скролле
    const vp = document.getElementById('matrixViewport');
    vp.addEventListener('scroll', ()=>{ 
        isScrolling = true; 
        cancelLongPress(); 
        onScroll(); 
        handleInfiniteScroll(); 
    }, {passive: true});
    
    const tg = window.Telegram?.WebApp; if(tg) { tg.ready(); tg.expand(); try { tg.setHeaderColor('#050505'); tg.setBackgroundColor('#050505'); } catch(e){} }
  }

  function loadData() {
    try {
      const p = localStorage.getItem(KEY_PATTERN); if(p) availabilityPattern = JSON.parse(p); else { availabilityPattern[0]=[0,1,2,3,4,5,6,7]; availabilityPattern[6]=Array.from({length:24},(_,i)=>i); }
      const e = localStorage.getItem(KEY_EXCEPTIONS); if(e) dateExceptions = JSON.parse(e);
      const r = localStorage.getItem(KEY_RANGES); if(r) specialRanges = JSON.parse(r);
      const c = localStorage.getItem(KEY_CLIENTS); if(c) clients = JSON.parse(c); else clients = defaultClients;
      const s = localStorage.getItem(KEY_SESSIONS); if(s) sessions = JSON.parse(s);
    } catch(err) { console.error(err); }
  }
  function saveData() {
    localStorage.setItem(KEY_PATTERN, JSON.stringify(availabilityPattern));
    localStorage.setItem(KEY_EXCEPTIONS, JSON.stringify(dateExceptions));
    localStorage.setItem(KEY_RANGES, JSON.stringify(specialRanges));
    localStorage.setItem(KEY_CLIENTS, JSON.stringify(clients));
    localStorage.setItem(KEY_SESSIONS, JSON.stringify(sessions));
    updateAllDayStats();
  }

  function renderTimeColumn() {
    const col=document.getElementById('timeColumn'), badge=document.getElementById('timeLineBadge');
    col.innerHTML=''; col.appendChild(badge);
    for(let i=0; i<24; i++) { const el=document.createElement('div'); el.className='time-label'; el.innerHTML=`<span>${String(i).padStart(2,'0')}:00</span>`; col.appendChild(el); }
  }

  function renderDayRange(from, to) {
    const track=document.getElementById('daysHeaderTrack'), grid=document.getElementById('gridColumns');
    const weekDays=['ПН','ВТ','СР','ЧТ','ПТ','СБ','ВС'];
    const todayStr=new Date().toISOString().split('T')[0];
    const base=new Date(); base.setHours(0,0,0,0);

    for(let i=from; i<=to; i++) {
      const d=new Date(base); d.setDate(d.getDate()+i);
      const dateStr=d.toISOString().split('T')[0];
      let dayIdx=d.getDay()-1; if(dayIdx===-1) dayIdx=6;

      const h=document.createElement('div'); h.className=`day-col-header ${dateStr===todayStr?'today':''}`;
      h.id=`header-${dateStr}`; h.setAttribute('data-date', dateStr);
      h.innerHTML=`<div class="dch-day">${weekDays[dayIdx]}</div><div class="dch-num">${d.getDate()}</div><div class="dch-stats" id="stat-${dateStr}"><div class="dch-stats-fill"></div></div>`;
      h.onclick=()=>openDayOptions(dateStr, `${weekDays[dayIdx]} ${d.getDate()}`);
      track.appendChild(h);

      const c=document.createElement('div'); c.className='day-column';
      c.setAttribute('data-date', dateStr); c.setAttribute('data-day-idx', dayIdx);
      renderEventsForColumn(c, dateStr, dayIdx);
      
      // === ИЗМЕНЕНИЕ: ВМЕСТО ONCLICK ТЕПЕРЬ LONG PRESS HANDLER ===
      attachLongPressHandler(c, d);
      
      grid.appendChild(c);
      
      updateDayStats(dateStr);
    }
  }

  // === НОВАЯ ФУНКЦИЯ ДЛЯ LONG PRESS (БЕЗ УДАЛЕНИЯ ТВОЕГО ФУНКЦИОНАЛА) ===
  function attachLongPressHandler(element, dateObj) {
    let startY = 0;
    let feedbackEl = null;

    const startHandler = (e) => {
        if(e.target.closest('.event-card')) return;
        
        isScrolling = false;
        startY = (e.touches ? e.touches[0].clientY : e.clientY);
        
        // Визуальный эффект
        const rect = element.getBoundingClientRect();
        const offsetY = startY - rect.top;
        const hour = Math.floor(offsetY / GRID_H);
        
        feedbackEl = document.createElement('div');
        feedbackEl.className = 'touch-feedback';
        feedbackEl.style.top = (hour * GRID_H) + 'px';
        feedbackEl.style.height = GRID_H + 'px';
        element.appendChild(feedbackEl);
        activeTouchEl = feedbackEl;

        longPressTimer = setTimeout(() => {
            if(!isScrolling) {
                // Вибрация
                if(window.Telegram?.WebApp?.HapticFeedback) {
                    window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
                } else if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
                
                if(feedbackEl) feedbackEl.remove();
                
                // Открываем твою функцию создания сессии
                const setD = new Date(dateObj);
                setD.setHours(hour, 0);
                openAddSession(setD);
            }
        }, 500);
    };

    const cancelHandler = () => {
        if(longPressTimer) clearTimeout(longPressTimer);
        if(activeTouchEl) { activeTouchEl.remove(); activeTouchEl = null; }
    };

    const moveHandler = (e) => {
        const currentY = (e.touches ? e.touches[0].clientY : e.clientY);
        if (Math.abs(currentY - startY) > 10) {
            isScrolling = true;
            cancelHandler();
        }
    };

    element.addEventListener('touchstart', startHandler, {passive: true});
    element.addEventListener('touchmove', moveHandler, {passive: true});
    element.addEventListener('touchend', cancelHandler);
    element.addEventListener('touchcancel', cancelHandler);
    
    // Мышь (для тестов на ПК)
    element.addEventListener('mousedown', startHandler);
    element.addEventListener('mousemove', moveHandler);
    element.addEventListener('mouseup', cancelHandler);
    element.addEventListener('mouseleave', cancelHandler);
  }

  function cancelLongPress() {
     if(longPressTimer) clearTimeout(longPressTimer);
     if(activeTouchEl) { activeTouchEl.remove(); activeTouchEl = null; }
  }

  function handleInfiniteScroll() {
    const vp=document.getElementById('matrixViewport');
    const sl=vp.scrollLeft, sw=vp.scrollWidth, cw=vp.clientWidth;
    if(sw-(sl+cw)<300) { const old=endOffset; endOffset+=14; renderDayRange(old+1, endOffset); reRenderBlocks(); }
    if(sl<300) { const old=startOffset; startOffset-=14; prependDays(startOffset, old-1); vp.scrollLeft+=(14*65); reRenderBlocks(); }
  }
  function prependDays(from, to) {
    const track=document.getElementById('daysHeaderTrack'), grid=document.getElementById('gridColumns');
    const weekDays=['ПН','ВТ','СР','ЧТ','ПТ','СБ','ВС'];
    const todayStr=new Date().toISOString().split('T')[0];
    const base=new Date(); base.setHours(0,0,0,0);
    const fragH=document.createDocumentFragment(), fragC=document.createDocumentFragment();

    for(let i=from; i<=to; i++) {
      const d=new Date(base); d.setDate(d.getDate()+i);
      const dateStr=d.toISOString().split('T')[0];
      let dayIdx=d.getDay()-1; if(dayIdx===-1) dayIdx=6;

      const h=document.createElement('div'); h.className=`day-col-header ${dateStr===todayStr?'today':''}`;
      h.id=`header-${dateStr}`; h.setAttribute('data-date', dateStr);
      h.innerHTML=`<div class="dch-day">${weekDays[dayIdx]}</div><div class="dch-num">${d.getDate()}</div><div class="dch-stats" id="stat-${dateStr}"><div class="dch-stats-fill"></div></div>`;
      h.onclick=()=>openDayOptions(dateStr, `${weekDays[dayIdx]} ${d.getDate()}`);
      fragH.appendChild(h);

      const c=document.createElement('div'); c.className='day-column';
      c.setAttribute('data-date', dateStr); c.setAttribute('data-day-idx', dayIdx);
      renderEventsForColumn(c, dateStr, dayIdx);
      
      // === ИЗМЕНЕНИЕ: ТОЖЕ LONG PRESS ===
      attachLongPressHandler(c, d);

      fragC.appendChild(c);
      updateDayStats(dateStr);
    }
    track.insertBefore(fragH, track.firstChild);
    grid.insertBefore(fragC, grid.querySelector('.day-column'));
  }

  function reRenderBlocks() {
    document.querySelectorAll('#gridColumns .day-column').forEach(col => {
      col.querySelectorAll('.blocked-slot, .day-off-overlay, .blocked-range-part').forEach(e=>e.remove());
      const dateStr=col.getAttribute('data-date'), dayIdx=parseInt(col.getAttribute('data-day-idx'));
      
      (availabilityPattern[dayIdx]||[]).forEach(h=>{
        const b=document.createElement('div'); b.className='blocked-slot'; b.style.top=`${h*GRID_H}px`; col.appendChild(b);
      });

      if(dateExceptions[dateStr]==='off') {
        const o=document.createElement('div'); o.className='day-off-overlay'; col.appendChild(o); 
      } else {
        const cS=new Date(dateStr+'T00:00:00').getTime(), cE=new Date(dateStr+'T23:59:59').getTime();
        specialRanges.forEach(r=>{
          const rS=new Date(r.start).getTime(), rE=new Date(r.end).getTime();
          const oS=Math.max(cS,rS), oE=Math.min(cE,rE);
          if(oS<oE) {
            if(oS<=cS && oE>=cE-60000) { if(!col.querySelector('.day-off-overlay')) { const o=document.createElement('div'); o.className='day-off-overlay'; col.appendChild(o); } }
            else {
              const top=(oS-cS)/3600000*GRID_H, h=(oE-oS)/3600000*GRID_H;
              const p=document.createElement('div'); p.className='blocked-range-part'; p.style.top=`${top}px`; p.style.height=`${h}px`; col.appendChild(p);
            }
          }
        });
      }
      updateDayStats(dateStr);
    });
  }

  function updateAllDayStats() {
    document.querySelectorAll('.day-col-header').forEach(h => { updateDayStats(h.getAttribute('data-date')); });
  }

  function updateDayStats(dateStr) {
    const track = document.getElementById(`stat-${dateStr}`);
    if(!track) return;
    
    // Check Day Off
    if(dateExceptions[dateStr] === 'off') { track.style.display = 'none'; return; }
    
    // Check Full Range
    let isFullBlocked = false;
    const cS=new Date(dateStr+'T00:00:00').getTime(), cE=new Date(dateStr+'T23:59:59').getTime();
    for(let r of specialRanges) {
        const rS=new Date(r.start).getTime(), rE=new Date(r.end).getTime();
        if (Math.max(cS,rS) < Math.min(cE,rE)) {
             if(rS<=cS && rE>=cE-60000) { isFullBlocked=true; break; }
        }
    }
    if(isFullBlocked) { track.style.display = 'none'; return; }

    // Calc Capacity
    let capacity = 1440;
    const dayIdx = new Date(dateStr).getDay()-1===-1?6:new Date(dateStr).getDay()-1;
    const pat = availabilityPattern[dayIdx] || [];
    capacity -= (pat.length * 60);
    
    specialRanges.forEach(r => {
        const rS=new Date(r.start).getTime(), rE=new Date(r.end).getTime();
        const oS=Math.max(cS,rS), oE=Math.min(cE,rE);
        if(oS<oE) capacity -= ((oE-oS)/60000);
    });
    
    if(capacity <= 0) { track.style.display = 'none'; return; }
    
    // Calc Occupied (Merging intervals)
    let intervals = [];
    
    // Explicit
    sessions.filter(s=>s.dateStr===dateStr).forEach(s => {
        const [h1,m1] = s.start.split(':').map(Number);
        const [h2,m2] = s.end.split(':').map(Number);
        intervals.push([h1*60+m1, h2*60+m2]);
    });
    
    // Pattern (Ghosts)
    clients.forEach(client => {
      const daySched = client.schedule?.[dayIdx];
      if(daySched) {
        daySched.forEach(slot => {
          const exists = sessions.some(s => s.client === client.name && s.dateStr === dateStr && s.start === slot.s);
          if(!exists) {
             const [h1,m1] = slot.s.split(':').map(Number);
             const [h2,m2] = slot.e.split(':').map(Number);
             intervals.push([h1*60+m1, h2*60+m2]);
          }
        });
      }
    });
    
    // Merge Intervals Logic
    intervals.sort((a,b) => a[0] - b[0]);
    let merged = [];
    if(intervals.length > 0) {
        let curr = intervals[0];
        for(let i=1; i<intervals.length; i++) {
            if(intervals[i][0] < curr[1]) {
                curr[1] = Math.max(curr[1], intervals[i][1]); // Merge
            } else {
                merged.push(curr);
                curr = intervals[i];
            }
        }
        merged.push(curr);
    }
    
    let occupied = 0;
    merged.forEach(iv => occupied += (iv[1] - iv[0]));

    // Update UI
    track.style.display = 'flex';
    const fill = track.querySelector('.dch-stats-fill');
    const pct = Math.min(100, Math.max(0, (occupied / capacity) * 100));
    
    fill.style.width = `${pct}%`;
    
    // Check if any occupied minute is inside a blocked hour/range?
    // Simplified Overload Check: If (occupied > capacity) -> Red.
    // Or if we specifically detect a collision with blocked time.
    // For now, strict volume check:
    if (occupied > capacity) fill.style.background = 'var(--acc-red)';
    else fill.style.background = 'var(--acc-current)';
  }

  function renderEventsForColumn(col, dateStr, dayIdx) {
    col.querySelectorAll('.event-card').forEach(e=>e.remove());
    
    sessions.filter(s=>s.dateStr===dateStr).forEach(s=>col.appendChild(createEventEl(s)));

    clients.forEach(client => {
      const daySched = client.schedule?.[dayIdx];
      if(daySched) {
        daySched.forEach(slot => {
          const exists = sessions.some(s => s.client === client.name && s.dateStr === dateStr && s.start === slot.s);
          if(!exists) {
            const ghost = { id: `ghost-${client.id}-${dateStr}-${slot.s}`, client: client.name, start: slot.s, end: slot.e, type: 'client', status: 'ghost', clientId: client.id };
            col.appendChild(createEventEl(ghost));
          }
        });
      }
    });
    updateDayStats(dateStr);
  }

  function hexToRgba(hex, alpha) {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
  }

  function createEventEl(s) {
    const [h,m]=s.start.split(':').map(Number);
    const [hE,mE]=s.end.split(':').map(Number);
    const top=(h*60+m)/60*GRID_H, height=(hE*60+mE-(h*60+m))/60*GRID_H;
    const div=document.createElement('div');
    div.className=`event-card ${s.status||''}`;
    div.style.top=`${top}px`; div.style.height=`${Math.max(height,20)}px`;
    
    const cli = clients.find(c => c.name === s.client);
    const color = cli ? cli.color : '#0a84ff';
    
    div.style.borderLeftColor = color;
    div.style.backgroundColor = hexToRgba(color, s.status === 'ghost' ? 0.2 : 0.6);
    
    if(s.status === 'ghost') { 
      div.style.borderStyle = 'dashed'; 
      div.style.borderWidth = '1px';
      div.style.borderLeftWidth = '3px'; 
    }

    div.innerHTML=`<div class="ev-title">${s.client}</div><div class="ev-time">${s.start} - ${s.end}</div>`;
    div.onclick=(e)=>{ e.stopPropagation(); if(s.status==='ghost') confirmGhost(s); else openEdit(s); };
    return div;
  }

  function confirmGhost(ghost) {
    const realSession = { id: Date.now(), client: ghost.client, dateStr: ghost.id.split('-')[2], start: ghost.start, end: ghost.end, note: '', status: 'planned', type: 'client' };
    sessions.push(realSession);
    saveData();
    const col = document.querySelector(`.day-column[data-date="${realSession.dateStr}"]`);
    if(col) renderEventsForColumn(col, realSession.dateStr, new Date(realSession.dateStr).getDay()-1===-1?6:new Date(realSession.dateStr).getDay()-1);
    openEdit(realSession);
  }

  // === CLIENTS LOGIC ===
  function openClientsSheet() { closeAllSheets(); renderClientsList(); openSheet('clientsSheet'); }
  function renderClientsList() {
    const cont = document.getElementById('clientsListContainer'); cont.innerHTML = '';
    clients.forEach(c => {
      const el = document.createElement('div'); el.className='client-list-item';
      el.innerHTML = `<div class="color-dot" style="background:${c.color}"></div><div class="client-name">${c.name}</div>`;
      el.onclick = () => openClientEdit(c);
      cont.appendChild(el);
    });
  }
  
  function openClientEdit(client = null) {
    closeAllSheets();
    editingClient = client ? JSON.parse(JSON.stringify(client)) : { id: Date.now(), name: '', color: colorPalette[0], schedule: {} };
    document.getElementById('ceTitle').textContent = client ? 'Редактировать' : 'Новый клиент';
    document.getElementById('ceName').value = editingClient.name;
    document.getElementById('ceColor').value = editingClient.color;
    renderColorGrid();
    renderClientSchedule();
    openSheet('clientEditSheet');
  }

  function renderColorGrid() {
    const grid = document.getElementById('ceColorGrid'); grid.innerHTML = '';
    colorPalette.forEach(c => {
      const d = document.createElement('div'); d.className = `color-option ${editingClient.color === c ? 'selected' : ''}`;
      d.style.backgroundColor = c;
      d.onclick = () => { editingClient.color = c; renderColorGrid(); };
      grid.appendChild(d);
    });
  }

  function getContrastYIQ(hexcolor){
    hexcolor = hexcolor.replace("#", "");
    var r = parseInt(hexcolor.substr(0,2),16);
    var g = parseInt(hexcolor.substr(2,2),16);
    var b = parseInt(hexcolor.substr(4,2),16);
    var yiq = ((r*299)+(g*587)+(b*114))/1000;
    return (yiq >= 128) ? 'black' : 'white';
  }

  function renderClientSchedule() {
    const cont = document.getElementById('ceScheduleContainer'); cont.innerHTML = '';
    const days = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс']; // 0-6
    
    days.forEach((dName, idx) => {
      const row = document.createElement('div'); row.className = 'sched-row';
      const slots = editingClient.schedule[idx] || [];
      let slotsHtml = slots.map((s, sIdx) => 
        `<div class="sched-chip" style="background:${editingClient.color}; color:${getContrastYIQ(editingClient.color)}" onclick="removeClientSlot(${idx}, ${sIdx})">${s.s}-${s.e} ×</div>`
      ).join('');
      row.innerHTML = `<div class="sched-day">${dName}</div><div class="sched-slots">${slotsHtml}<div class="sched-add" onclick="addClientSlot(${idx})">+</div></div>`;
      cont.appendChild(row);
    });
  }

  function addClientSlot(dayIdx) { editingDayIdx = dayIdx; openSheet('timeSlotSheet'); }
  function removeClientSlot(dayIdx, slotIdx) { editingClient.schedule[dayIdx].splice(slotIdx, 1); renderClientSchedule(); }
  function closeTimeSlotSheet() { document.getElementById('timeSlotSheet').classList.remove('open'); }
  function confirmTimeSlot() {
    const s = document.getElementById('tsStart').value;
    const e = document.getElementById('tsEnd').value;
    if(!editingClient.schedule[editingDayIdx]) editingClient.schedule[editingDayIdx] = [];
    editingClient.schedule[editingDayIdx].push({s, e});
    closeTimeSlotSheet(); renderClientSchedule();
  }

  function saveClient() {
    const name = document.getElementById('ceName').value;
    if(!name) return alert('Введите имя');
    editingClient.name = name;
    
    const idx = clients.findIndex(c => c.id === editingClient.id);
    if(idx !== -1) clients[idx] = editingClient; else clients.push(editingClient);
    
    saveData(); closeAllSheets();
    document.querySelectorAll('.day-column').forEach(c => {
       const d = c.getAttribute('data-date'); 
       const dIdx = c.getAttribute('data-day-idx');
       renderEventsForColumn(c, d, parseInt(dIdx));
    });
  }

  // === SESSION FORM UTILS ===
  function populateClientSelect() {
    const sel = document.getElementById('inpClient'); sel.innerHTML = '';
    clients.forEach(c => { const opt = document.createElement('option'); opt.value = c.name; opt.textContent = c.name; sel.appendChild(opt); });
  }

  // === STANDARD FUNCTIONS ===
  function scrollToToday() { const el=document.getElementById(`header-${new Date().toISOString().split('T')[0]}`); if(el) document.getElementById('matrixViewport').scrollLeft=el.offsetLeft-70; }
  function onScroll() { 
    const vp=document.getElementById('matrixViewport'), headers=document.querySelectorAll('.day-col-header');
    for(let h of headers) if(h.offsetLeft>=vp.scrollLeft) { 
      const d=new Date(h.getAttribute('data-date')); document.getElementById('headerMonth').textContent=`${d.toLocaleString('ru',{month:'long'}).toUpperCase()} ${d.getFullYear()}`; break; 
    }
  }
  function openAddSession(d) {
    editingId=null; populateClientSelect();
    document.getElementById('sheetTitle').textContent='Новая'; document.getElementById('btnDelete').style.display='none';
    document.getElementById('inpDate').value=d.toISOString().split('T')[0];
    const h=d.getHours(); document.getElementById('inpStart').value=`${String(h).padStart(2,'0')}:00`; document.getElementById('inpEnd').value=`${String(h+1).padStart(2,'0')}:00`;
    openSheet('sessionSheet');
  }
  function openEdit(s) {
    editingId=s.id; populateClientSelect();
    document.getElementById('sheetTitle').textContent='Редактировать'; document.getElementById('btnDelete').style.display='block';
    document.getElementById('inpClient').value=s.client; document.getElementById('inpDate').value=s.dateStr;
    document.getElementById('inpStart').value=s.start; document.getElementById('inpEnd').value=s.end; document.getElementById('inpNote').value=s.note||'';
    openSheet('sessionSheet');
  }
  function saveSession() {
    const client=document.getElementById('inpClient').value, dateStr=document.getElementById('inpDate').value, start=document.getElementById('inpStart').value, end=document.getElementById('inpEnd').value, note=document.getElementById('inpNote').value;
    if(editingId) { const idx=sessions.findIndex(s=>s.id===editingId); if(idx!==-1) sessions[idx]={...sessions[idx], client, dateStr, start, end, note}; }
    else sessions.push({ id:Date.now(), client, dateStr, start, end, note, status:'planned', type:'client' });
    saveData(); closeAllSheets(); 
    const col=document.querySelector(`.day-column[data-date="${dateStr}"]`); if(col) renderEventsForColumn(col, dateStr, new Date(dateStr).getDay()-1===-1?6:new Date(dateStr).getDay()-1);
  }
  function deleteSession() { 
    if(editingId) { 
      const s=sessions.find(x=>x.id===editingId); sessions=sessions.filter(x=>x.id!==editingId); saveData(); closeAllSheets();
      if(s) { const col=document.querySelector(`.day-column[data-date="${s.dateStr}"]`); if(col) renderEventsForColumn(col, s.dateStr, new Date(s.dateStr).getDay()-1===-1?6:new Date(s.dateStr).getDay()-1); }
    } 
  }
  
  function openDayOptions(d,t){selectedDayForOptions=d;document.getElementById('dayOptionsTitle').textContent=t;openSheet('dayOptionsSheet');}
  function toggleDayOff(){if(selectedDayForOptions){dateExceptions[selectedDayForOptions]='off';saveData();reRenderBlocks();closeAllSheets();}}
  function clearDayOff(){if(selectedDayForOptions){delete dateExceptions[selectedDayForOptions];saveData();reRenderBlocks();closeAllSheets();}}
  function openSettings(){openSheet('settingsSheet');}
  function openSheet(id){document.getElementById('overlay').classList.add('active');document.getElementById(id).classList.add('open');}
  function closeAllSheets(){document.getElementById('overlay').classList.remove('active');document.querySelectorAll('.sheet').forEach(s=>s.classList.remove('open'));}
  
  function openRangesSheet(){closeAllSheets();resetRangeForm();renderRangesList();openSheet('rangesSheet');}
  function resetRangeForm(){editingRangeIndex=null;document.getElementById('rangeStartDate').value='';document.getElementById('rangeStartTime').value='00:00';document.getElementById('rangeEndDate').value='';document.getElementById('rangeEndTime').value='23:59';document.getElementById('rangeSubmitBtn').textContent='Добавить период';}
  function addRange(){
    const dS=document.getElementById('rangeStartDate').value, tS=document.getElementById('rangeStartTime').value;
    const dE=document.getElementById('rangeEndDate').value, tE=document.getElementById('rangeEndTime').value;
    if(!dS||!tS||!dE||!tE)return alert('Заполните все поля');
    const start=`${dS}T${tS}`, end=`${dE}T${tE}`; if(start>=end)return alert('Ошибка дат');
    const nr={start,end}; if(editingRangeIndex!==null)specialRanges[editingRangeIndex]=nr; else specialRanges.push(nr);
    saveData(); resetRangeForm(); renderRangesList(); reRenderBlocks();
  }
  function editRange(i){const r=specialRanges[i]; editingRangeIndex=i; const [d1,t1]=r.start.split('T'), [d2,t2]=r.end.split('T'); document.getElementById('rangeStartDate').value=d1; document.getElementById('rangeStartTime').value=t1.substring(0,5); document.getElementById('rangeEndDate').value=d2; document.getElementById('rangeEndTime').value=t2.substring(0,5); document.getElementById('rangeSubmitBtn').textContent='Сохранить';}
  function deleteRange(i){specialRanges.splice(i,1); if(editingRangeIndex===i) resetRangeForm(); saveData(); renderRangesList(); reRenderBlocks();}
  function renderRangesList(){
    const l=document.getElementById('rangesList'); l.innerHTML='';
    if(!specialRanges.length) { l.innerHTML='<div style="color:#8E8E93;font-size:13px;text-align:center">Нет периодов</div>'; return; }
    specialRanges.forEach((r,i)=>{
      const el=document.createElement('div'); el.className='range-item';
      const f=(iso)=>{const d=new Date(iso); return `${d.getDate()}.${d.getMonth()+1} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;};
      el.innerHTML=`<div><div class="range-text">${f(r.start)} — ${f(r.end)}</div><div class="range-sub">Недоступно</div></div><div class="range-actions"><div class="range-icon edit" onclick="editRange(${i})"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></div><div class="range-icon del" onclick="deleteRange(${i})"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></div></div>`;
      l.appendChild(el);
    });
  }

  function openPatternEditor(){closeAllSheets();document.getElementById('patternEditor').classList.add('open');renderPatternEditor();}
  function savePattern(){document.getElementById('patternEditor').classList.remove('open');saveData();reRenderBlocks();}
  function renderPatternEditor(){
    const t=document.getElementById('peTimeColumn'); t.innerHTML='';
    for(let i=0;i<24;i++){const e=document.createElement('div');e.className='time-label';e.innerHTML=`<span>${String(i).padStart(2,'0')}:00</span>`;e.onclick=()=>toggleRowPattern(i);t.appendChild(e);}
    const h=document.getElementById('peHeaderTrack'); h.innerHTML='';
    const w=['ПН','ВТ','СР','ЧТ','ПТ','СБ','ВС'];
    for(let i=0;i<7;i++){const e=document.createElement('div');e.className='day-col-header';e.innerHTML=`<div class="dch-day" style="margin-top:16px">${w[i]}</div>`;e.onclick=()=>toggleColPattern(i);h.appendChild(e);}
    const g=document.getElementById('peGridColumns'); g.innerHTML='';
    for(let i=0;i<7;i++){const c=document.createElement('div');c.className='day-column';c.onclick=(e)=>{if(e.target!==c)return;toggleSinglePattern(i,Math.floor(e.offsetY/GRID_H));};renderPCol(c,i);g.appendChild(c);}
  }
  function renderPCol(c,d){c.innerHTML='';(availabilityPattern[d]||[]).forEach(x=>{const b=document.createElement('div');b.className='blocked-slot';b.style.top=`${x*GRID_H}px`;b.onclick=(e)=>{e.stopPropagation();toggleSinglePattern(d,x);};c.appendChild(b);});}
  function toggleSinglePattern(d,h){const a=availabilityPattern[d],i=a.indexOf(h);if(i===-1)a.push(h);else a.splice(i,1);renderPCol(document.getElementById('peGridColumns').children[d],d);}
  function toggleRowPattern(h){let all=true;for(let d=0;d<7;d++)if(!availabilityPattern[d].includes(h)){all=false;break;} for(let d=0;d<7;d++){const a=availabilityPattern[d],i=a.indexOf(h);if(all&&i!==-1)a.splice(i,1);if(!all&&i===-1)a.push(h);} const g=document.getElementById('peGridColumns');for(let d=0;d<7;d++)renderPCol(g.children[d],d);}
  function toggleColPattern(d){const a=availabilityPattern[d];if(a.length===24)availabilityPattern[d]=[];else availabilityPattern[d]=Array.from({length:24},(_,i)=>i);renderPCol(document.getElementById('peGridColumns').children[d],d);}

  function startClock(){updateClock();if(updateInterval)clearInterval(updateInterval);updateInterval=setInterval(updateClock,60000);}
  function updateClock(){const n=new Date(),l=document.getElementById('globalTimeLine'),b=document.getElementById('timeLineBadge'),px=(n.getHours()*60+n.getMinutes())/60*GRID_H;l.style.top=`${px}px`;l.style.display='block';b.textContent=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;b.style.display='block';b.style.top=`${px}px`;}

  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
