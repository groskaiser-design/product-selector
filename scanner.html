<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Ultima Scanner Final</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  /* === CORE UTILS === */
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
  
  /* –ì–õ–ê–í–ù–û–ï: –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä –≤–∏–∑—É–∞–ª—å–Ω–æ, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª.
     –≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è Chrome/Safari/Edge 
  */
  *::-webkit-scrollbar { display: none; width: 0; height: 0; background: transparent; }
  /* –î–ª—è Firefox */
  * { scrollbar-width: none; }
  
  :root {
    --bg-core: #050505;
    --text-main: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.55);
    
    --surface-glass: rgba(255, 255, 255, 0.08);
    --surface-border: rgba(255, 255, 255, 0.12);
    
    --acc-orange: #ff9f0a;
    --acc-green: #30d158;
    --acc-blue: #0a84ff;
    --acc-red: #ff453a;
    
    --radius-xl: 28px;
    --radius-l: 22px;
    
    --safe-top: calc(12px + env(safe-area-inset-top));
    --safe-bottom: calc(12px + env(safe-area-inset-bottom));
  }

  body {
    margin: 0; padding: 0;
    background: var(--bg-core);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', Roboto, sans-serif;
    color: var(--text-main);
    height: 100vh;
    display: flex; flex-direction: column;
    overflow: hidden; 
  }

  /* === FX BACKGROUND === */
  .fx-layer { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
  .orb { position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.5; animation: float 25s infinite linear; }
  .orb-1 { width: 320px; height: 320px; background: radial-gradient(circle, #5e60ce 0%, transparent 70%); top: -15%; left: -20%; }
  .orb-2 { width: 280px; height: 280px; background: radial-gradient(circle, #0a84ff 0%, transparent 70%); bottom: 10%; right: -10%; animation-direction: reverse; }
  .noise { position: fixed; inset: 0; opacity: 0.05; background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); }
  @keyframes float { 0%{transform:rotate(0deg)} 50%{transform:rotate(180deg)} 100%{transform:rotate(360deg)} }

  /* === CALENDAR STICKY HEADER === */
  .calendar-sticky {
    position: sticky; top: 0; z-index: 50;
    background: rgba(20, 20, 20, 0.2); 
    backdrop-filter: blur(50px); -webkit-backdrop-filter: blur(50px);
    border-bottom: 1px solid rgba(255,255,255,0.08);
    padding-top: var(--safe-top);
    padding-bottom: 8px;
    user-select: none;
    overflow: hidden;
  }

  .calendar-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 16px 8px 16px;
  }
  
  .month-label {
    font-size: 11px; font-weight: 700; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 1.5px;
    opacity: 0.9;
  }
  
  /* –û–ë–õ–ê–°–¢–¨ –°–í–ê–ô–ü–ê */
  .calendar-swipe-area {
    width: 100%;
    padding: 0 10px;
    /* –†–∞–∑—Ä–µ—à–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –Ω–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π */
    touch-action: pan-y; 
    cursor: grab;
  }
  .calendar-swipe-area:active { cursor: grabbing; }

  .calendar-grid {
    display: grid; 
    grid-template-columns: repeat(7, 1fr); 
    gap: 4px;
    /* –£–±–∏—Ä–∞–µ–º transition –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, —á—Ç–æ–±—ã –º—ã—à—å —É–ø—Ä–∞–≤–ª—è–ª–∞ –ø–æ–∑–∏—Ü–∏–µ–π –Ω–∞–ø—Ä—è–º—É—é */
    /* transition –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è JS-–æ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç–ø—É—Å–∫–∞–Ω–∏–∏ */
    will-change: transform; 
  }
  
  /* –ö–ª–∞—Å—Å—ã –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è (—Å—Ç—Ä–µ–ª–∫–∞–º–∏ –∏–ª–∏ –ø–æ—Å–ª–µ —Å–≤–∞–π–ø–∞) */
  .calendar-grid.animating { transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.2s; }
  .calendar-grid.hidden { opacity: 0; }

  /* Day Cell */
  .day-cell {
    height: 52px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    border-radius: 12px;
    background: transparent;
    transition: background 0.2s, transform 0.1s, box-shadow 0.2s; /* –û–±–Ω–æ–≤–∏–ª transition */
    position: relative;
    cursor: pointer;
    /* –ó–∞–ø—Ä–µ—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤–Ω—É—Ç—Ä–∏ –¥–Ω—è, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–æ –¥—Ä–∞–≥—É */
    user-select: none; 
    -webkit-user-drag: none;
  }
  
  @media (hover: hover) {
    .day-cell:hover:not(.selected) { background: rgba(255,255,255,0.05); }
  }
  .day-cell:active { transform: scale(0.92); }

  .dc-name { font-size: 9px; font-weight: 600; color: var(--text-muted); margin-bottom: 3px; text-transform: uppercase; }
  .dc-num { font-size: 17px; font-weight: 600; color: #fff; font-variant-numeric: tabular-nums; }

  .day-cell.selected { background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transform: scale(1); }
  .day-cell.selected .dc-name { color: rgba(0,0,0,0.5); font-weight: 700; }
  .day-cell.selected .dc-num { color: #000; font-weight: 800; }

  .day-cell.is-today::after { content: ''; position: absolute; bottom: 5px; width: 4px; height: 4px; border-radius: 50%; background: var(--acc-blue); box-shadow: 0 0 4px var(--acc-blue); }
  .day-cell.selected.is-today::after { background: #000; box-shadow: none; }

  /* === SCROLL AREA === */
  .scroll-container {
    flex: 1;
    overflow-y: auto; /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª —Ä–∞–±–æ—Ç–∞–µ—Ç */
    padding-bottom: 120px;
    -webkit-overflow-scrolling: touch;
    mask-image: linear-gradient(to bottom, transparent 0%, black 15px);
    -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15px);
  }

  /* === WIDGETS === */
  .carousel-wrap { padding: 12px 0 10px 0; }
  .carousel-track { 
    display: flex; gap: 12px; padding: 0 16px; 
    overflow-x: auto; scroll-snap-type: x mandatory; 
    cursor: grab;
  }
  .carousel-track:active { cursor: grabbing; }
  
  .widget {
    flex: 0 0 calc(100% - 16px); scroll-snap-align: center;
    height: 150px;
    border-radius: var(--radius-xl);
    background: linear-gradient(165deg, rgba(255,255,255,0.09) 0%, rgba(255,255,255,0.02) 100%);
    border: 1px solid var(--surface-border); 
    border-top: 1px solid rgba(255,255,255,0.15);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    position: relative; overflow: hidden;
    padding: 16px;
    user-select: none; /* –ß—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –Ω–µ –≤—ã–¥–µ–ª—è–ª—Å—è –ø—Ä–∏ –¥—Ä–∞–≥–µ */
  }

  .macros-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; height: 100%; align-items: center; }
  .macro-item { display: flex; flex-direction: column; align-items: center; justify-content: center; }
  
  .donut-box { width: 100%; max-width: 62px; aspect-ratio: 1; position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 6px; }
  .mini-donut { width: 100%; height: 100%; transform: rotate(-90deg); filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
  .md-bg { fill: none; stroke: rgba(255,255,255,0.06); stroke-width: 6; }
  .md-val { fill: none; stroke-width: 6; stroke-linecap: round; stroke-dasharray: 151; transition: stroke-dashoffset 1s ease; }
  .m-icon { position: absolute; font-size: 16px; }
  
  .m-data { display: flex; flex-direction: column; align-items: center; line-height: 1.1; }
  .m-nums { font-size: 11px; font-weight: 700; color: #fff; font-variant-numeric: tabular-nums; }
  .m-nums span { color: var(--text-muted); font-weight: 500; font-size: 9px; }
  .m-lbl { font-size: 9px; font-weight: 600; text-transform: uppercase; color: var(--text-muted); margin-top: 2px; letter-spacing: 0.5px; }

  /* Water Widget */
  .widget.water-card { padding: 0; display: flex; flex-direction: column; justify-content: space-between; background: rgba(30, 40, 50, 0.3); }
  .liquid-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
  .liquid { position: absolute; bottom: 0; left: 0; width: 100%; height: var(--h, 30%); background: linear-gradient(to top, rgba(10,132,255,0.6), rgba(10,132,255,0.3)); transition: height 0.5s ease-out; }
  .liquid::after { content: ''; position: absolute; top: -10px; left: 0; width: 200%; height: 20px; background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 120' preserveAspectRatio='none'%3E%3Cpath d='M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z' style='fill:rgba(10,132,255,0.3)'/%3E%3C/svg%3E"); background-size: 50% 100%; animation: waveFlow 10s linear infinite; }
  @keyframes waveFlow { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

  .water-ui { position: relative; z-index: 2; height: 100%; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
  .w-btn-box { width: 44px; height: 44px; border-radius: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; font-size: 22px; color: #fff; font-weight: 300; cursor: pointer; transition: 0.1s; }
  .w-btn-box:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }
  .w-center { text-align: center; }
  .w-val { font-size: 32px; font-weight: 800; line-height: 1; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
  .w-unit { font-size: 12px; font-weight: 600; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px; }

  .dots { display: flex; justify-content: center; gap: 6px; margin-top: 6px; }
  .dot { width: 5px; height: 5px; border-radius: 50%; background: rgba(255,255,255,0.2); transition: 0.3s; }
  .dot.active { width: 16px; border-radius: 4px; background: #fff; }

  /* === TIMELINE === */
  .timeline { padding: 10px 16px 0 16px; display: flex; flex-direction: column; gap: 10px; }
  .section-title { font-size: 13px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-left: 4px; letter-spacing: 0.5px; }

  .meal-card { background: var(--surface-glass); border-radius: var(--radius-l); border: 1px solid rgba(255,255,255,0.05); padding: 16px; transition: background 0.2s; }
  .meal-card:active { background: rgba(255,255,255,0.1); }
  .meal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.06); }
  .mh-left { display: flex; align-items: center; gap: 8px; }
  .mh-time { font-size: 15px; font-weight: 700; color: #fff; }
  .mh-tag { font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 6px; background: rgba(255,255,255,0.1); color: var(--text-muted); }
  .mh-cal { font-size: 15px; font-weight: 700; color: var(--acc-green); }

  .prod-item { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 6px; }
  .prod-item:last-child { margin-bottom: 0; }
  .pi-name { color: rgba(255,255,255,0.85); flex: 1; }
  .pi-w { color: var(--text-muted); margin-right: 10px; font-feature-settings: "tnum"; font-size: 12px; }
  .pi-c { font-weight: 600; min-width: 30px; text-align: right; font-feature-settings: "tnum"; }

  /* === OMNI-BAR === */
  .omni-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(15, 15, 15, 0.9); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); border-top: 1px solid rgba(255,255,255,0.1); padding: 8px 12px var(--safe-bottom) 12px; z-index: 100; display: flex; align-items: flex-end; gap: 8px; }
  .icon-btn { width: 40px; height: 40px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; color: #fff; border-radius: 50%; cursor: pointer; transition: 0.2s; margin-bottom: 2px; }
  .icon-btn:active { background: rgba(255,255,255,0.15); }
  .input-wrap { flex: 1; min-height: 42px; background: rgba(255,255,255,0.08); border-radius: 20px; display: flex; align-items: center; padding: 4px 16px; border: 1px solid transparent; transition: 0.2s; }
  .input-wrap:focus-within { background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.15); }
  textarea { width: 100%; background: transparent; border: none; color: #fff; font-size: 15px; line-height: 20px; padding: 10px 0; margin: 0; resize: none; max-height: 100px; font-family: inherit; }
  textarea::placeholder { color: rgba(255,255,255,0.35); }
  .action-btn { width: 40px; height: 40px; flex-shrink: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); cursor: pointer; margin-bottom: 2px; }
  .mode-cam { background: transparent; color: #fff; }
  .mode-cam:active { transform: scale(0.9); opacity: 0.7; }
  .mode-send { background: var(--acc-blue); color: #fff; }
  .mode-send:active { transform: scale(0.92); }

  .stroke-kcal { stroke: url(#grad-kcal); }
  .stroke-prot { stroke: url(#grad-prot); }
  .stroke-fats { stroke: url(#grad-fats); }
  .stroke-carb { stroke: url(#grad-carb); }

  .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(4px); }
  .sheet-overlay.visible { opacity: 1; pointer-events: auto; }
  .sheet { position: fixed; bottom: 0; left: 0; right: 0; background: #151517; border-radius: 24px 24px 0 0; padding: 24px 16px calc(30px + env(safe-area-inset-bottom)) 16px; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.1, 0.7, 0.1, 1); border-top: 1px solid rgba(255,255,255,0.15); }
  .sheet-overlay.visible .sheet { transform: translateY(0); }
  .sheet-item { background: rgba(255,255,255,0.06); border-radius: 16px; padding: 16px; display: flex; align-items: center; gap: 16px; cursor: pointer; margin-bottom: 8px; }
  .sheet-item:active { background: rgba(255,255,255,0.12); }
  .sheet-icon { font-size: 24px; }
  .sheet-lbl { font-size: 16px; font-weight: 600; color: #fff; }

</style>
</head>
<body>

<svg width="0" height="0" style="position:absolute">
  <defs>
    <linearGradient id="grad-kcal" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#ff9f0a"/><stop offset="100%" stop-color="#ff453a"/></linearGradient>
    <linearGradient id="grad-prot" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#48bfe3"/><stop offset="100%" stop-color="#5e60ce"/></linearGradient>
    <linearGradient id="grad-fats" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#f1c40f"/><stop offset="100%" stop-color="#e67e22"/></linearGradient>
    <linearGradient id="grad-carb" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#2ecc71"/><stop offset="100%" stop-color="#1abc9c"/></linearGradient>
  </defs>
</svg>

<div class="fx-layer"><div class="orb orb-1"></div><div class="orb orb-2"></div><div class="noise"></div></div>

<div class="calendar-sticky">
  <div class="calendar-header">
    <div class="month-label" id="monthLabel">...</div>
  </div>
  <div class="calendar-swipe-area" id="swipeArea">
    <div class="calendar-grid" id="calGrid"></div>
  </div>
</div>

<div class="scroll-container">
  
  <div class="carousel-wrap">
    <div class="carousel-track" id="track">
      <div class="widget">
        <div class="macros-grid">
          <div class="macro-item">
            <div class="donut-box">
              <svg class="mini-donut" viewBox="0 0 60 60"><circle class="md-bg" cx="30" cy="30" r="24"/><circle class="md-val stroke-kcal" cx="30" cy="30" r="24" style="stroke-dashoffset: 40px"/></svg>
              <div class="m-icon">üî•</div>
            </div>
            <div class="m-data"><div class="m-nums">1450<span>/2100</span></div><div class="m-lbl">–ö–∫–∞–ª</div></div>
          </div>
          <div class="macro-item">
            <div class="donut-box">
              <svg class="mini-donut" viewBox="0 0 60 60"><circle class="md-bg" cx="30" cy="30" r="24"/><circle class="md-val stroke-prot" cx="30" cy="30" r="24" style="stroke-dashoffset: 100px"/></svg>
              <div class="m-icon">üêì</div>
            </div>
            <div class="m-data"><div class="m-nums">110<span>/160</span></div><div class="m-lbl">–ë–µ–ª–∫–∏</div></div>
          </div>
          <div class="macro-item">
            <div class="donut-box">
              <svg class="mini-donut" viewBox="0 0 60 60"><circle class="md-bg" cx="30" cy="30" r="24"/><circle class="md-val stroke-fats" cx="30" cy="30" r="24" style="stroke-dashoffset: 110px"/></svg>
              <div class="m-icon">ü•ë</div>
            </div>
            <div class="m-data"><div class="m-nums">45<span>/70</span></div><div class="m-lbl">–ñ–∏—Ä—ã</div></div>
          </div>
          <div class="macro-item">
            <div class="donut-box">
              <svg class="mini-donut" viewBox="0 0 60 60"><circle class="md-bg" cx="30" cy="30" r="24"/><circle class="md-val stroke-carb" cx="30" cy="30" r="24" style="stroke-dashoffset: 60px"/></svg>
              <div class="m-icon">üåæ</div>
            </div>
            <div class="m-data"><div class="m-nums">180<span>/250</span></div><div class="m-lbl">–£–≥–ª–∏</div></div>
          </div>
        </div>
      </div>

      <div class="widget water-card">
        <div class="liquid-container"><div class="liquid" id="waterLevel"></div></div>
        <div class="water-ui">
          <div class="w-btn-box" onclick="updateWater(-0.25)">‚àí</div>
          <div class="w-center">
            <div class="w-val" id="waterVal">1.25</div>
            <div class="w-unit">–õ–∏—Ç—Ä–æ–≤</div>
          </div>
          <div class="w-btn-box" onclick="updateWater(0.25)">+</div>
        </div>
      </div>
    </div>
    <div class="dots"><div class="dot active"></div><div class="dot"></div></div>
  </div>

  <div class="timeline">
    <div class="section-title">–°–µ–≥–æ–¥–Ω—è</div>
    <div class="meal-card">
      <div class="meal-head">
        <div class="mh-left"><div class="mh-time">09:00</div><div class="mh-tag">–ó–∞–≤—Ç—Ä–∞–∫</div></div>
        <div class="mh-cal">420</div>
      </div>
      <div class="prod-item"><div class="pi-name">–û–≤—Å—è–Ω–∞—è –∫–∞—à–∞ –Ω–∞ –º–æ–ª–æ–∫–µ</div><div class="pi-w">250 –≥</div><div class="pi-c">220</div></div>
      <div class="prod-item"><div class="pi-name">–ú–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ</div><div class="pi-w">10 –≥</div><div class="pi-c">75</div></div>
      <div class="prod-item"><div class="pi-name">–ö–æ—Ñ–µ —Å –º–æ–ª–æ–∫–æ–º</div><div class="pi-w">250 –º–ª</div><div class="pi-c">125</div></div>
    </div>
    <div class="meal-card">
      <div class="meal-head">
        <div class="mh-left"><div class="mh-time">13:30</div><div class="mh-tag">–û–±–µ–¥</div></div>
        <div class="mh-cal">650</div>
      </div>
      <div class="prod-item"><div class="pi-name">–ë–æ—Ä—â —Å –≥–æ–≤—è–¥–∏–Ω–æ–π</div><div class="pi-w">300 –≥</div><div class="pi-c">240</div></div>
      <div class="prod-item"><div class="pi-name">–°–º–µ—Ç–∞–Ω–∞ 20%</div><div class="pi-w">30 –≥</div><div class="pi-c">62</div></div>
      <div class="prod-item"><div class="pi-name">–ü—é—Ä–µ –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å–Ω–æ–µ</div><div class="pi-w">150 –≥</div><div class="pi-c">160</div></div>
    </div>
  </div>

</div>

<div class="omni-bar">
  <div class="icon-btn" onclick="toggleSheet()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
  </div>
  <div class="input-wrap">
    <textarea id="msgInput" rows="1" placeholder="–Ø–±–ª–æ–∫–æ 200–≥, –∫–æ—Ñ–µ..."></textarea>
  </div>
  <div class="action-btn mode-cam" id="actionBtn" onclick="handleAction()">
    <svg id="iconCam" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
    <svg id="iconSend" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display:none"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
  </div>
</div>

<div class="sheet-overlay" id="sheet" onclick="toggleSheet()">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-item" onclick="alert('–õ–æ–≥–∏–∫–∞ FatSecret PDF')">
      <div class="sheet-icon" style="color: #30d158">ü•ó</div>
      <div class="sheet-lbl">FatSecret (PDF)</div>
    </div>
    <div class="sheet-item">
      <div class="sheet-icon" style="color: #0a84ff">üîó</div>
      <div class="sheet-lbl">–í—Å—Ç–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É</div>
    </div>
  </div>
</div>

<script>
  const tg = window.Telegram?.WebApp;
  if(tg) { tg.ready(); tg.expand(); tg.setHeaderColor('#050505'); tg.setBackgroundColor('#050505'); }

  function haptic(type) {
    if(!tg?.HapticFeedback) return;
    if(type === 'selection') tg.HapticFeedback.selectionChanged();
    else if (['light', 'medium', 'heavy'].includes(type)) tg.HapticFeedback.impactOccurred(type);
    else if (['error', 'success', 'warning'].includes(type)) tg.HapticFeedback.notificationOccurred(type);
  }

  // === 1. –ö–ê–õ–ï–ù–î–ê–†–¨ –° –ñ–ò–í–´–ú –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–ï–ú (Live Drag) ===
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º Pointer Events, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–æ –∏ –Ω–∞ –º—ã—à–∫–µ, –∏ –Ω–∞ –ø–∞–ª—å—Ü–∞—Ö –æ–¥–∏–Ω–∞–∫–æ–≤–æ.

  let currentWeekStart = getStartOfWeek(new Date());
  let selectedDate = new Date();
  
  // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–≤–∞–π–ø–∞
  let isDragging = false;
  let startX = 0;
  let currentTranslate = 0;
  let isSwipeAction = false; // –ß—Ç–æ–±—ã –æ—Ç–ª–∏—á–∏—Ç—å —Å–≤–∞–π–ø –æ—Ç –∫–ª–∏–∫–∞

  const area = document.getElementById('swipeArea');
  const grid = document.getElementById('calGrid');

  function getStartOfWeek(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
    return new Date(d.setDate(diff));
  }

  function initCalendar() {
    renderWeek();
    
    // Pointer Events (–ú—ã—à—å + –¢–∞—á)
    area.onpointerdown = handleStart;
    area.onpointermove = handleMove;
    area.onpointerup = handleEnd;
    area.onpointercancel = handleEnd;
    area.onpointerleave = handleEnd;
  }

  function renderWeek() {
    // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—É—â–∞—è –∞–Ω–∏–º–∞—Ü–∏—è —Å–¥–≤–∏–≥–∞, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
    grid.style.transform = `translateX(0px)`; 
    grid.innerHTML = '';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Å—è—Ü
    const midWeek = new Date(currentWeekStart);
    midWeek.setDate(midWeek.getDate() + 3);
    const label = document.getElementById('monthLabel');
    label.textContent = midWeek.toLocaleString('ru', { month: 'long', year: 'numeric' });

    const weekDays = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
    const today = new Date();

    for(let i=0; i<7; i++) {
      const d = new Date(currentWeekStart);
      d.setDate(d.getDate() + i);
      
      const isToday = d.toDateString() === today.toDateString();
      const isSelected = d.toDateString() === selectedDate.toDateString();

      const el = document.createElement('div');
      el.className = `day-cell ${isSelected ? 'selected' : ''} ${isToday ? 'is-today' : ''}`;
      el.innerHTML = `<div class="dc-name">${weekDays[i]}</div><div class="dc-num">${d.getDate()}</div>`;
      
      // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ, –µ—Å–ª–∏ –±—ã–ª —Å–≤–∞–π–ø
      el.onclick = (e) => {
        if(isSwipeAction) { e.preventDefault(); return; } 
        
        document.querySelectorAll('.day-cell').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        selectedDate = new Date(d);
        haptic('selection');
      };
      
      // –ó–∞–ø—Ä–µ—Ç –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ –¥—Ä–∞–≥–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫/—Ç–µ–∫—Å—Ç–∞ –≤–Ω—É—Ç—Ä–∏ —è—á–µ–π–∫–∏
      el.ondragstart = () => false; 
      
      grid.appendChild(el);
    }
  }

  // === –õ–û–ì–ò–ö–ê –î–†–ê–ì–ê (PHYSICS) ===
  
  function handleStart(e) {
    // –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ –ª–µ–≤—É—é –∫–Ω–æ–ø–∫—É –º—ã—à–∏
    if (e.button !== 0) return;
    
    isDragging = true;
    startX = e.clientX;
    isSwipeAction = false;
    currentTranslate = 0;
    
    // –£–±–∏—Ä–∞–µ–º –ø–ª–∞–≤–Ω–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ –≤–æ –≤—Ä–µ–º—è –¥—Ä–∞–≥–∞, —á—Ç–æ–±—ã —Å–µ—Ç–∫–∞ "–ø—Ä–∏–ª–∏–ø–ª–∞" –∫ –ø–∞–ª—å—Ü—É
    grid.classList.remove('animating');
    area.setPointerCapture(e.pointerId); // –ó–∞—Ö–≤–∞—Ç –∫—É—Ä—Å–æ—Ä–∞, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è–ª—Å—è –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã
    area.style.cursor = 'grabbing';
  }

  function handleMove(e) {
    if (!isDragging) return;
    
    const diff = e.clientX - startX;
    
    // –ï—Å–ª–∏ —Å–¥–≤–∏–Ω—É–ª–∏ —Ö–æ—Ç—å –Ω–µ–º–Ω–æ–≥–æ, —Å—á–∏—Ç–∞–µ–º —ç—Ç–æ –ø–æ–ø—ã—Ç–∫–æ–π —Å–≤–∞–π–ø–∞
    if (Math.abs(diff) > 5) isSwipeAction = true;

    // –î–≤–∏–≥–∞–µ–º —Å–µ—Ç–∫—É –∑–∞ –ø–∞–ª—å—Ü–µ–º (—Å –Ω–µ–±–æ–ª—å—à–∏–º —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ–º)
    currentTranslate = diff;
    grid.style.transform = `translateX(${currentTranslate}px)`;
  }

  function handleEnd(e) {
    if (!isDragging) return;
    isDragging = false;
    area.style.cursor = 'grab';
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–ª–∞—Å—Å –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    grid.classList.add('animating');

    // –ü–æ—Ä–æ–≥ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è —Å–º–µ–Ω—ã –Ω–µ–¥–µ–ª–∏ (50px)
    const threshold = 50;
    
    if (currentTranslate > threshold) {
      // –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ -> –ü—Ä–µ–¥. –Ω–µ–¥–µ–ª—è
      changeWeek(-1);
    } else if (currentTranslate < -threshold) {
      // –°–≤–∞–π–ø –≤–ª–µ–≤–æ -> –°–ª–µ–¥. –Ω–µ–¥–µ–ª—è
      changeWeek(1);
    } else {
      // –û—Ç–º–µ–Ω–∞ —Å–≤–∞–π–ø–∞ (–≤–æ–∑–≤—Ä–∞—Ç –Ω–∞ –º–µ—Å—Ç–æ)
      grid.style.transform = `translateX(0px)`;
    }
  }

  function changeWeek(direction) {
    haptic('light');
    
    // –£–ª–µ—Ç–∞–µ–º –≤ —Å—Ç–æ—Ä–æ–Ω—É –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–≤–∞–π–ø–∞
    const exitX = direction > 0 ? -100 : 100; // –ü—Ä–æ—Ü–µ–Ω—Ç—ã –∏–ª–∏ px, —á—Ç–æ–±—ã —É–ª–µ—Ç–µ–ª–æ –∑–∞ —ç–∫—Ä–∞–Ω
    // –ù–æ —É –Ω–∞—Å transform —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ px. –°–¥–µ–ª–∞–µ–º —Å–¥–≤–∏–≥ –ø–æ–¥–∞–ª—å—à–µ.
    grid.style.transform = `translateX(${direction > 0 ? -50 : 50}px)`; // –≠—Ç–æ –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ñ–µ–π–∫, –ª—É—á—à–µ —á–µ—Ä–µ–∑ opacity
    grid.classList.add('hidden'); // –°–∫—Ä—ã–≤–∞–µ–º
    
    setTimeout(() => {
      // –ú–µ–Ω—è–µ–º –¥–∞—Ç—É
      currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
      renderWeek();
      
      // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è: –°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞–≤–∏–º –≤ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É
      grid.classList.remove('animating'); // –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
      grid.style.transform = `translateX(${direction > 0 ? 50 : -50}px)`;
      
      // –§–æ—Ä—Å–∏—Ä—É–µ–º –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É
      void grid.offsetWidth;
      
      // –í–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ —Ü–µ–Ω—Ç—Ä
      grid.classList.remove('hidden');
      grid.classList.add('animating');
      grid.style.transform = `translateX(0px)`;
    }, 200);
  }

  // === 2. CAROUSEL SCROLL (Mouse Drag Support) ===
  const track = document.getElementById('track');
  const dots = document.querySelectorAll('.dot');
  
  let isDown = false; let startXCarousel; let scrollLeft;
  
  track.addEventListener('mousedown', (e) => { 
    isDown = true; 
    track.style.cursor = 'grabbing';
    startXCarousel = e.pageX - track.offsetLeft; 
    scrollLeft = track.scrollLeft; 
  });
  track.addEventListener('mouseleave', () => { isDown = false; track.style.cursor = 'grab'; });
  track.addEventListener('mouseup', () => { isDown = false; track.style.cursor = 'grab'; });
  track.addEventListener('mousemove', (e) => { 
    if(!isDown) return; 
    e.preventDefault(); 
    const x = e.pageX - track.offsetLeft; 
    const walk = (x - startXCarousel) * 2; 
    track.scrollLeft = scrollLeft - walk; 
  });
  
  track.addEventListener('scroll', () => {
    const idx = Math.round(track.scrollLeft / track.clientWidth);
    dots.forEach((d,i) => d.classList.toggle('active', i===idx));
  });

  // === 3. OTHER LOGIC ===
  let waterL = 1.25; const maxWater = 3.0;
  function updateWater(delta) {
    haptic(delta > 0 ? 'light' : 'warning');
    waterL = Math.max(0, Math.min(maxWater, waterL + delta));
    document.getElementById('waterVal').textContent = waterL.toFixed(2);
    document.getElementById('waterLevel').style.setProperty('--h', Math.max(5, (waterL/maxWater)*100) + '%');
  }

  const txt = document.getElementById('msgInput');
  const btn = document.getElementById('actionBtn');
  const iCam = document.getElementById('iconCam');
  const iSend = document.getElementById('iconSend');

  txt.addEventListener('input', () => {
    txt.style.height = 'auto'; txt.style.height = Math.min(txt.scrollHeight, 100) + 'px';
    const hasText = txt.value.trim().length > 0;
    if(hasText) { btn.classList.replace('mode-cam','mode-send'); iCam.style.display='none'; iSend.style.display='block'; }
    else { btn.classList.replace('mode-send','mode-cam'); iCam.style.display='block'; iSend.style.display='none'; }
  });

  function handleAction() {
    haptic('light');
    if(txt.value.trim().length > 0) {
      console.log('Sending:', txt.value);
      txt.value=''; txt.style.height='auto'; txt.blur();
      btn.classList.replace('mode-send','mode-cam'); iCam.style.display='block'; iSend.style.display='none';
    } else {
      setTimeout(() => window.location.href='cam.html', 50);
    }
  }

  function toggleSheet() {
    haptic('light');
    document.getElementById('sheet').classList.toggle('visible');
  }

  initCalendar();

</script>
</body>
</html>
