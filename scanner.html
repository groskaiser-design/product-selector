<!DOCTYPE html>
<html lang="ru">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<meta charset="UTF-8" />
<title>–ö–ë–ñ–£ ‚Äî –î–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è</title>

<style>
  html, body, button, [role="button"], .btn {
    touch-action: manipulation;
  }
  input, select, textarea { font-size: 16px; }
  
  :root{
    --bg: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    --cardA: rgba(255,255,255,.18);
    --cardB: rgba(255,255,255,.16);
    --border: rgba(255,255,255,.28);
    --shadow: 0 8px 28px rgba(0,0,0,.18);
    --okA:#fbbf24; --okB:#f59e0b;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  html{background:transparent;}
  body{
    min-height:100svh;background:transparent;
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
    color:#fff;position:relative;isolation:isolate;overflow-x:hidden;
  }
  body::before{content:"";position:fixed;inset:0;background:var(--bg);z-index:0;pointer-events:none;}
  .page{max-width:560px;margin:0 auto;padding:18px 14px 80px;position:relative;z-index:1}

  /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å */
  .calendar-wrapper{
    background:linear-gradient(180deg,var(--cardA),var(--cardB));
    border:1px solid var(--border);border-radius:18px;
    box-shadow:var(--shadow);backdrop-filter:blur(12px);
    padding:14px;margin-bottom:14px;overflow:hidden;
  }
  .calendar-scroll{
    display:flex;gap:8px;overflow-x:auto;overflow-y:hidden;
    scroll-snap-type:x mandatory;
    -webkit-overflow-scrolling:touch;scrollbar-width:none;
    padding:4px 0;white-space:nowrap;
  }
  .calendar-scroll::-webkit-scrollbar{display:none}
  .day-item{
    flex:0 0 56px;display:flex;flex-direction:column;align-items:center;
    gap:4px;padding:10px 8px;border-radius:12px;
    background:rgba(255,255,255,.12);scroll-snap-align:center;
    cursor:pointer;transition:all .2s ease;user-select:none;
    border:2px solid transparent;
  }
  .day-item.selected{
    background:linear-gradient(135deg,var(--okA),var(--okB));
    box-shadow:0 4px 12px rgba(251,191,36,.4);
    transform:scale(1.05);
  }
  .day-item.today{
    background:rgba(255,255,255,.25);
    border-color:rgba(255,255,255,.5);
    box-shadow:0 0 20px rgba(255,255,255,.4);
  }
  .day-item:hover{
    background:rgba(255,255,255,.2);
  }
  .day-name{font-size:11px;opacity:.85;font-weight:600;text-transform:uppercase;}
  .day-date{font-size:18px;font-weight:900;}
  .day-month{font-size:10px;opacity:.75;}

  /* –í–∏–¥–∂–µ—Ç –ö–ë–ñ–£ */
  .stats-widget{
    background:linear-gradient(180deg,var(--cardA),var(--cardB));
    border:1px solid var(--border);border-radius:18px;
    box-shadow:var(--shadow);backdrop-filter:blur(12px);
    padding:16px;margin-bottom:14px;
  }
  .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
  .stat-item{text-align:center;}
  .stat-label{font-size:11px;opacity:.85;margin-bottom:4px;font-weight:600;}
  .stat-bar{
    height:80px;background:rgba(255,255,255,.15);border-radius:8px;
    position:relative;overflow:hidden;margin-bottom:6px;
  }
  .stat-fill{
    position:absolute;bottom:0;left:0;right:0;
    background:linear-gradient(180deg,var(--okA),var(--okB));
    transition:height .3s ease;border-radius:8px 8px 0 0;
  }
  .stat-value{font-size:13px;font-weight:900;}
  .stat-target{font-size:10px;opacity:.7;}

  /* –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ */
  .food-table{
    background:linear-gradient(180deg,var(--cardA),var(--cardB));
    border:1px solid var(--border);border-radius:18px;
    box-shadow:var(--shadow);backdrop-filter:blur(12px);
    overflow:hidden;margin-bottom:14px;
  }
  .table-header{
    display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr 1fr;
    gap:8px;padding:12px 14px;font-size:11px;font-weight:700;
    opacity:.9;border-bottom:1px solid rgba(255,255,255,.14);
  }
  .table-row{
    display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr 1fr;
    gap:8px;padding:12px 14px;font-size:13px;
    border-bottom:1px solid rgba(255,255,255,.08);
    cursor:pointer;transition:background .15s ease;
  }
  .table-row:hover{background:rgba(255,255,255,.08);}
  .table-row:last-child{border-bottom:none;}
  .col-name{font-weight:600;}
  .col-value{text-align:center;font-variant-numeric:tabular-nums;}
  .empty-state{padding:40px 20px;text-align:center;opacity:.7;}
  .empty-state svg{width:48px;height:48px;margin-bottom:12px;opacity:.5;}

  /* –ö–Ω–æ–ø–∫–∞ –∫–∞–º–µ—Ä—ã */
  .camera-btn-fixed{
    position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
    z-index:100;
  }
  .camera-btn{
    width:64px;height:64px;border-radius:50%;border:0;
    background:linear-gradient(135deg,var(--okA),var(--okB));
    box-shadow:0 8px 24px rgba(251,191,36,.5);
    cursor:pointer;transition:all .2s ease;
    display:flex;align-items:center;justify-content:center;
  }
  .camera-btn:active{transform:scale(.95);}
  .camera-btn svg{width:32px;height:32px;color:#fff;}

  /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–∞–º–µ—Ä—ã */
  .camera-modal{
    position:fixed;inset:0;z-index:200;
    background:rgba(0,0,0,.95);
    display:none;flex-direction:column;
  }
  .camera-modal.active{display:flex;}
  .camera-header{
    padding:14px 16px;display:flex;justify-content:space-between;
    align-items:center;background:rgba(0,0,0,.5);
  }
  .camera-title{font-size:16px;font-weight:700;}
  .close-btn{
    background:transparent;border:0;color:#fff;
    font-size:28px;cursor:pointer;padding:0;width:32px;height:32px;
  }
  .camera-container{
    flex:1;position:relative;display:flex;align-items:center;
    justify-content:center;background:#000;
  }
  video{width:100%;height:100%;object-fit:cover;}
  canvas{display:none;}
  
  /* –ü—Ä–∏—Ü–µ–ª –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è —Å –≥–∏—Ä–æ—Å–∫–æ–ø–æ–º */
  .alignment-overlay{
    position:absolute;inset:0;pointer-events:none;
    display:flex;align-items:center;justify-content:center;
  }
  .alignment-target{
    position:relative;width:120px;height:120px;
  }
  /* –ù–µ–ø–æ–¥–≤–∏–∂–Ω—ã–π –∑–µ–ª–µ–Ω—ã–π –∫—Ä–µ—Å—Ç–∏–∫ (—Ü–µ–ª—å) */
  .target-cross{
    position:absolute;left:50%;top:50%;
    transform:translate(-50%, -50%);
    width:60px;height:60px;
  }
  .target-cross::before,
  .target-cross::after{
    content:"";position:absolute;background:#4ade80;
    box-shadow:0 0 12px rgba(74,222,128,.8);
  }
  .target-cross::before{
    left:50%;top:0;bottom:0;width:3px;
    transform:translateX(-50%);
  }
  .target-cross::after{
    top:50%;left:0;right:0;height:3px;
    transform:translateY(-50%);
  }
  /* –í–Ω–µ—à–Ω–µ–µ –∫–æ–ª—å—Ü–æ —Ü–µ–ª–∏ */
  .target-ring{
    position:absolute;left:50%;top:50%;
    transform:translate(-50%, -50%);
    width:80px;height:80px;
    border:2px solid rgba(74,222,128,.6);
    border-radius:50%;
  }
  /* –ü–æ–¥–≤–∏–∂–Ω—ã–π –∫—Ä–∞—Å–Ω—ã–π/–±–µ–ª—ã–π –∫—Ä–µ—Å—Ç–∏–∫ (—Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –Ω–∞–∫–ª–æ–Ω) */
  .moving-cross{
    position:absolute;left:50%;top:50%;
    width:40px;height:40px;
    transition:background .2s ease;
  }
  .moving-cross::before,
  .moving-cross::after{
    content:"";position:absolute;
    transition:background .2s ease;
  }
  .moving-cross::before{
    left:50%;top:0;bottom:0;width:4px;
    transform:translateX(-50%);
  }
  .moving-cross::after{
    top:50%;left:0;right:0;height:4px;
    transform:translateY(-50%);
  }
  /* –ö—Ä–∞—Å–Ω—ã–π –∫–æ–≥–¥–∞ –Ω–µ –≤—ã—Ä–æ–≤–Ω–µ–Ω */
  .moving-cross.misaligned::before,
  .moving-cross.misaligned::after{
    background:#ef4444;
    box-shadow:0 0 16px rgba(239,68,68,.9);
  }
  /* –ó–µ–ª–µ–Ω—ã–π –∫–æ–≥–¥–∞ –≤—ã—Ä–æ–≤–Ω–µ–Ω */
  .moving-cross.aligned::before,
  .moving-cross.aligned::after{
    background:#4ade80;
    box-shadow:0 0 16px rgba(74,222,128,.9);
  }
  /* –¢–µ–∫—Å—Ç-–ø–æ–¥—Å–∫–∞–∑–∫–∞ */
  .alignment-hint{
    position:absolute;bottom:100px;left:50%;
    transform:translateX(-50%);
    background:rgba(0,0,0,.7);
    padding:8px 16px;border-radius:20px;
    font-size:13px;font-weight:600;
    white-space:nowrap;
    opacity:0;
    transition:opacity .3s ease;
  }
  .alignment-hint.show{opacity:1;}
  .alignment-hint.aligned{color:#4ade80;}
  .alignment-hint.misaligned{color:#ef4444;}

  .camera-controls{
    padding:20px;display:flex;justify-content:center;
    gap:20px;background:rgba(0,0,0,.5);
  }
  .control-btn{
    width:72px;height:72px;border-radius:50%;
    border:4px solid #fff;background:transparent;
    cursor:pointer;transition:all .2s ease;
    display:flex;align-items:center;justify-content:center;
  }
  .control-btn.capture{
    background:#fff;
  }
  .control-btn:active{transform:scale(.95);}
  .control-btn svg{width:32px;height:32px;color:#fff;}
  .control-btn.capture svg{color:#000;}

  /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
  .edit-modal{
    position:fixed;inset:0;z-index:300;
    background:rgba(0,0,0,.9);
    display:none;flex-direction:column;
    overflow-y:auto;
  }
  .edit-modal.active{display:flex;}
  .edit-content{
    max-width:560px;width:100%;margin:auto;padding:20px;
  }
  .preview-image{
    width:100%;max-height:300px;object-fit:contain;
    border-radius:12px;margin-bottom:20px;
  }
  .edit-section{
    background:linear-gradient(180deg,var(--cardA),var(--cardB));
    border:1px solid var(--border);border-radius:18px;
    box-shadow:var(--shadow);backdrop-filter:blur(12px);
    padding:16px;margin-bottom:14px;
  }
  .edit-section h3{font-size:14px;margin-bottom:12px;opacity:.9;}
  .edit-field{margin-bottom:12px;}
  .edit-field:last-child{margin-bottom:0;}
  .edit-label{font-size:12px;opacity:.85;margin-bottom:6px;display:block;}
  .edit-input{
    width:100%;padding:10px 12px;border-radius:10px;
    background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);
    color:#fff;font-size:14px;font-family:inherit;
  }
  .edit-input:focus{
    outline:none;border-color:var(--okA);
    background:rgba(255,255,255,.2);
  }
  textarea.edit-input{
    min-height:80px;resize:vertical;
  }
  .edit-grid{
    display:grid;grid-template-columns:repeat(2,1fr);gap:12px;
  }
  .btn-group{
    display:flex;gap:12px;margin-top:20px;
  }
  .btn{
    flex:1;padding:14px 20px;border:0;border-radius:14px;
    font-weight:900;font-size:15px;cursor:pointer;
    transition:all .2s ease;
  }
  .btn-primary{
    background:linear-gradient(135deg,var(--okA),var(--okB));
    color:#fff;box-shadow:var(--shadow);
  }
  .btn-secondary{
    background:rgba(255,255,255,.2);color:#fff;
  }
  .btn:active{transform:scale(.98);}
  .btn.loading{opacity:.7;pointer-events:none;}
  .spinner{
    display:inline-block;width:16px;height:16px;
    border:2px solid rgba(255,255,255,.3);
    border-top-color:#fff;border-radius:50%;
    animation:spin .8s linear infinite;
    margin-left:8px;
  }
  @keyframes spin{to{transform:rotate(360deg);}}

  /* –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ */
  #fileInput{display:none;}

  /* Loading overlay */
  .loading-overlay{
    position:fixed;inset:0;z-index:400;
    background:rgba(0,0,0,.8);
    display:none;align-items:center;justify-content:center;
    flex-direction:column;gap:16px;
  }
  .loading-overlay.active{display:flex;}
  .loading-spinner{
    width:48px;height:48px;border:4px solid rgba(255,255,255,.3);
    border-top-color:#fff;border-radius:50%;
    animation:spin .8s linear infinite;
  }
  .loading-text{font-size:16px;opacity:.9;}
</style>
</head>
<body>

<div class="page">
  <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
  <div class="calendar-wrapper">
    <div class="calendar-scroll" id="calendar">
      <!-- –î–Ω–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è JS -->
    </div>
  </div>

  <!-- –í–∏–¥–∂–µ—Ç –ö–ë–ñ–£ -->
  <div class="stats-widget">
    <div class="stats-grid">
      <div class="stat-item">
        <div class="stat-label">–ö</div>
        <div class="stat-bar">
          <div class="stat-fill" id="cal-fill" style="height:0%"></div>
        </div>
        <div class="stat-value"><span id="cal-current">0</span></div>
        <div class="stat-target">–∏–∑ <span id="cal-target">2000</span></div>
      </div>
      <div class="stat-item">
        <div class="stat-label">–ë</div>
        <div class="stat-bar">
          <div class="stat-fill" id="protein-fill" style="height:0%"></div>
        </div>
        <div class="stat-value"><span id="protein-current">0</span></div>
        <div class="stat-target">–∏–∑ <span id="protein-target">150</span></div>
      </div>
      <div class="stat-item">
        <div class="stat-label">–ñ</div>
        <div class="stat-bar">
          <div class="stat-fill" id="fat-fill" style="height:0%"></div>
        </div>
        <div class="stat-value"><span id="fat-current">0</span></div>
        <div class="stat-target">–∏–∑ <span id="fat-target">65</span></div>
      </div>
      <div class="stat-item">
        <div class="stat-label">–£</div>
        <div class="stat-bar">
          <div class="stat-fill" id="carbs-fill" style="height:0%"></div>
        </div>
        <div class="stat-value"><span id="carbs-current">0</span></div>
        <div class="stat-target">–∏–∑ <span id="carbs-target">250</span></div>
      </div>
    </div>
  </div>

  <!-- –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ -->
  <div class="food-table">
    <div class="table-header">
      <div>–ü—Ä–æ–¥—É–∫—Ç</div>
      <div class="col-value">–í–µ—Å, –≥</div>
      <div class="col-value">–ö</div>
      <div class="col-value">–ë</div>
      <div class="col-value">–ñ</div>
      <div class="col-value">–£</div>
      <div class="col-value">üíß</div>
    </div>
    <div id="foodList">
      <div class="empty-state">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
        </svg>
        <div>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç</div>
      </div>
    </div>
  </div>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ –∫–∞–º–µ—Ä—ã -->
<div class="camera-btn-fixed">
  <button class="camera-btn" id="openCamera" aria-label="–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
    </svg>
  </button>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–∞–º–µ—Ä—ã -->
<div class="camera-modal" id="cameraModal">
  <div class="camera-header">
    <div class="camera-title">–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ –ø—Ä–æ–¥—É–∫—Ç</div>
    <button class="close-btn" id="closeCamera">&times;</button>
  </div>
  <div class="camera-container">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
    <div class="alignment-overlay">
      <div class="alignment-target">
        <div class="target-ring"></div>
        <div class="target-cross"></div>
        <div class="moving-cross misaligned" id="movingCross"></div>
      </div>
      <div class="alignment-hint" id="alignmentHint">–í—ã—Ä–æ–≤–Ω—è–π—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏</div>
    </div>
  </div>
  <div class="camera-controls">
    <button class="control-btn" id="uploadBtn" aria-label="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
      </svg>
    </button>
    <button class="control-btn capture" id="captureBtn" aria-label="–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ">
      <svg fill="currentColor" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="8"/>
      </svg>
    </button>
    <button class="control-btn" id="switchCamera" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É" style="display:none;">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
      </svg>
    </button>
  </div>
</div>

<!-- –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ -->
<input type="file" id="fileInput" accept="image/*">

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div class="edit-modal" id="editModal">
  <div class="edit-content">
    <img id="previewImage" class="preview-image" alt="Preview">
    
    <div class="edit-section">
      <h3>–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
      <div class="edit-field">
        <label class="edit-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞</label>
        <input type="text" class="edit-input" id="productName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
      </div>
      <div class="edit-field">
        <label class="edit-label">–í–µ—Å –ø–æ—Ä—Ü–∏–∏, –≥</label>
        <input type="number" class="edit-input" id="productWeight" placeholder="0">
      </div>
    </div>

    <div class="edit-section">
      <h3>–ö–ë–ñ–£ –Ω–∞ 100–≥</h3>
      <div class="edit-grid">
        <div class="edit-field">
          <label class="edit-label">–ö–∞–ª–æ—Ä–∏–∏</label>
          <input type="number" class="edit-input" id="calories" placeholder="0">
        </div>
        <div class="edit-field">
          <label class="edit-label">–ë–µ–ª–∫–∏, –≥</label>
          <input type="number" class="edit-input" id="protein" placeholder="0">
        </div>
        <div class="edit-field">
          <label class="edit-label">–ñ–∏—Ä—ã, –≥</label>
          <input type="number" class="edit-input" id="fats" placeholder="0">
        </div>
        <div class="edit-field">
          <label class="edit-label">–£–≥–ª–µ–≤–æ–¥—ã, –≥</label>
          <input type="number" class="edit-input" id="carbs" placeholder="0">
        </div>
      </div>
    </div>

    <div class="edit-section">
      <h3>–í–æ–¥–∞, –º–ª</h3>
      <div class="edit-field">
        <input type="number" class="edit-input" id="water" placeholder="0">
      </div>
    </div>

    <div class="edit-section">
      <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è AI</h3>
      <div class="edit-field">
        <textarea class="edit-input" id="aiComment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Ç–∞—Ä–µ–ª–∫–∞ —Å—É–ø–∞, –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –±–µ–ª–∫–∞..."></textarea>
      </div>
    </div>

    <div class="btn-group">
      <button class="btn btn-secondary" id="cancelEdit">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" id="saveFood">
        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        <span class="spinner" style="display:none;" id="saveSpinner"></span>
      </button>
    </div>
  </div>
</div>

<!-- Loading overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–æ—Ç–æ...</div>
</div>

<script>
// ========== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ==========
const API_CONFIG = {
  // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π API endpoint
  analyzeEndpoint: '/api/analyze-food',
  saveEndpoint: '/api/save-food',
  getFoodsEndpoint: '/api/get-foods',
  getTargetsEndpoint: '/api/get-targets'
};

// ========== –í–∏–±—Ä–æ –æ—Ç–∫–ª–∏–∫ ==========
function hapticFeedback(type = 'light') {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É Vibration API
  if (!navigator.vibrate) return;
  
  switch(type) {
    case 'light':
      navigator.vibrate(10); // –õ–µ–≥–∫–∏–π —Ç–∞–ø
      break;
    case 'medium':
      navigator.vibrate(20); // –°—Ä–µ–¥–Ω–∏–π —Ç–∞–ø
      break;
    case 'heavy':
      navigator.vibrate(30); // –°–∏–ª—å–Ω—ã–π —Ç–∞–ø
      break;
    case 'success':
      navigator.vibrate([10, 50, 10]); // –î–≤–æ–π–Ω–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –¥–ª—è —É—Å–ø–µ—Ö–∞
      break;
    case 'error':
      navigator.vibrate([50, 100, 50]); // –¢—Ä–æ–π–Ω–∞—è –¥–ª—è –æ—à–∏–±–∫–∏
      break;
    default:
      navigator.vibrate(10);
  }
  
  // –î–ª—è iOS/Telegram WebApp –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö API
  if (window.Telegram?.WebApp?.HapticFeedback) {
    const haptic = window.Telegram.WebApp.HapticFeedback;
    switch(type) {
      case 'light':
        haptic.impactOccurred('light');
        break;
      case 'medium':
        haptic.impactOccurred('medium');
        break;
      case 'heavy':
      case 'success':
        haptic.impactOccurred('heavy');
        break;
      case 'error':
        haptic.notificationOccurred('error');
        break;
    }
  }
}

// ========== –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ==========
let currentDate = new Date();
let selectedDate = new Date();
let cameraStream = null;
let capturedImageData = null;
let currentFacingMode = 'environment';
let deviceOrientationActive = false;

// ========== –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è ==========
let isFirstCalendarLoad = true;

function generateCalendar(scrollToSelected = false) {
  const calendar = document.getElementById('calendar');
  const currentScroll = calendar.scrollLeft; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞
  calendar.innerHTML = '';
  
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 61 –¥–µ–Ω—å: 30 –Ω–∞–∑–∞–¥ –∏ 30 –≤–ø–µ—Ä–µ–¥ –æ—Ç currentDate
  for (let i = -30; i <= 30; i++) {
    const date = new Date(currentDate);
    date.setDate(date.getDate() + i);
    
    const dayItem = document.createElement('div');
    dayItem.className = 'day-item';
    
    const isToday = date.toDateString() === new Date().toDateString();
    const isSelected = date.toDateString() === selectedDate.toDateString();
    
    if (isToday) dayItem.classList.add('today');
    if (isSelected) dayItem.classList.add('selected');
    
    const dayNames = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
    const monthNames = ['—è–Ω–≤', '—Ñ–µ–≤', '–º–∞—Ä', '–∞–ø—Ä', '–º–∞–π', '–∏—é–Ω', '–∏—é–ª', '–∞–≤–≥', '—Å–µ–Ω', '–æ–∫—Ç', '–Ω–æ—è', '–¥–µ–∫'];
    
    dayItem.innerHTML = `
      <div class="day-name">${dayNames[date.getDay()]}</div>
      <div class="day-date">${date.getDate()}</div>
      <div class="day-month">${monthNames[date.getMonth()]}</div>
    `;
    
    dayItem.addEventListener('click', () => {
      hapticFeedback('light'); // –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –¥–Ω—è
      selectedDate = new Date(date);
      loadFoodData(selectedDate);
      generateCalendar(false); // –ù–µ —Å–∫—Ä–æ–ª–ª–∏–º –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –¥–Ω—è
    });
    
    calendar.appendChild(dayItem);
  }
  
  // –°–∫—Ä–æ–ª–ª–∏–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –∏–ª–∏ –µ—Å–ª–∏ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω–æ
  if (isFirstCalendarLoad || scrollToSelected) {
    isFirstCalendarLoad = false;
    requestAnimationFrame(() => {
      const selectedElement = calendar.querySelector('.today');
      if (selectedElement) {
        selectedElement.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      }
    });
  } else {
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞
    calendar.scrollLeft = currentScroll;
  }
}

// –°–∫—Ä–æ–ª–ª –∫–∞–ª–µ–Ω–¥–∞—Ä—è –¥–ª—è –ø–æ–¥–≥—Ä—É–∑–∫–∏ –Ω–æ–≤—ã—Ö –¥–Ω–µ–π
let calendarScrollTimeout;
let isScrollingCalendar = false;

document.getElementById('calendar').addEventListener('scroll', (e) => {
  if (isScrollingCalendar) return; // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è
  
  clearTimeout(calendarScrollTimeout);
  calendarScrollTimeout = setTimeout(() => {
    const container = e.target;
    const scrollLeft = container.scrollLeft;
    const scrollWidth = container.scrollWidth;
    const clientWidth = container.clientWidth;
    
    // –ï—Å–ª–∏ –ø—Ä–æ—Å–∫—Ä–æ–ª–ª–∏–ª–∏ –∫ –Ω–∞—á–∞–ª—É –∏–ª–∏ –∫–æ–Ω—Ü—É, —Å–¥–≤–∏–≥–∞–µ–º currentDate
    if (scrollLeft < 300) {
      isScrollingCalendar = true;
      currentDate.setDate(currentDate.getDate() - 14);
      generateCalendar(false);
      setTimeout(() => { isScrollingCalendar = false; }, 100);
    } else if (scrollLeft > scrollWidth - clientWidth - 300) {
      isScrollingCalendar = true;
      currentDate.setDate(currentDate.getDate() + 14);
      generateCalendar(false);
      setTimeout(() => { isScrollingCalendar = false; }, 100);
    }
  }, 150);
});

// ========== –†–∞–±–æ—Ç–∞ —Å –≥–∏—Ä–æ—Å–∫–æ–ø–æ–º –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è ==========
function startDeviceOrientation() {
  if (deviceOrientationActive) return;
  
  // –î–ª—è iOS 13+ –Ω—É–∂–Ω–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
  if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
    DeviceOrientationEvent.requestPermission()
      .then(permissionState => {
        if (permissionState === 'granted') {
          window.addEventListener('deviceorientation', handleOrientation);
          deviceOrientationActive = true;
        }
      })
      .catch(console.error);
  } else {
    // –î–ª—è –¥—Ä—É–≥–∏—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤/—É—Å—Ç—Ä–æ–π—Å—Ç–≤
    window.addEventListener('deviceorientation', handleOrientation);
    deviceOrientationActive = true;
  }
}

function stopDeviceOrientation() {
  window.removeEventListener('deviceorientation', handleOrientation);
  deviceOrientationActive = false;
}

function handleOrientation(event) {
  const beta = event.beta;   // –ù–∞–∫–ª–æ–Ω –≤–ø–µ—Ä–µ–¥-–Ω–∞–∑–∞–¥ (-180 –¥–æ 180)
  const gamma = event.gamma;  // –ù–∞–∫–ª–æ–Ω –≤–ª–µ–≤–æ-–≤–ø—Ä–∞–≤–æ (-90 –¥–æ 90)
  
  if (beta === null || gamma === null) return;
  
  const movingCross = document.getElementById('movingCross');
  const hint = document.getElementById('alignmentHint');
  
  if (!movingCross || !hint) return;
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç –∏–¥–µ–∞–ª—å–Ω–æ–π –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
  // –ò–¥–µ–∞–ª—å–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: beta –æ–∫–æ–ª–æ 90 (–∏–ª–∏ -90), gamma –æ–∫–æ–ª–æ 0
  const targetBeta = 90;  // –¢–µ–ª–µ—Ñ–æ–Ω –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏
  const tolerance = 5;     // –ì—Ä–∞–¥—É—Å–æ–≤ –¥–æ–ø—É—Å–∫–∞
  
  // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º beta (–º–æ–∂–µ—Ç –±—ã—Ç—å 90 –∏–ª–∏ -90 –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏)
  let normalizedBeta = Math.abs(beta);
  if (normalizedBeta > 90) normalizedBeta = 180 - normalizedBeta;
  
  const betaOffset = normalizedBeta - targetBeta;
  const gammaOffset = gamma;
  
  // –î–≤–∏–≥–∞–µ–º –∫—Ä–∞—Å–Ω—ã–π –∫—Ä–µ—Å—Ç–∏–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–∫–ª–æ–Ω–∞
  // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º —Å–º–µ—â–µ–Ω–∏–µ (¬±30 –≥—Ä–∞–¥—É—Å–æ–≤ = ¬±40px)
  const maxOffset = 40;
  const scale = maxOffset / 30;
  
  const offsetX = Math.max(-maxOffset, Math.min(maxOffset, gammaOffset * scale));
  const offsetY = Math.max(-maxOffset, Math.min(maxOffset, betaOffset * scale));
  
  movingCross.style.transform = `translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px))`;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ
  const isAligned = Math.abs(betaOffset) < tolerance && Math.abs(gammaOffset) < tolerance;
  
  if (isAligned) {
    movingCross.classList.remove('misaligned');
    movingCross.classList.add('aligned');
    hint.classList.remove('misaligned');
    hint.classList.add('aligned', 'show');
    hint.textContent = '‚úì –ò–¥–µ–∞–ª—å–Ω–æ! –ú–æ–∂–Ω–æ —Å–Ω–∏–º–∞—Ç—å';
  } else {
    movingCross.classList.remove('aligned');
    movingCross.classList.add('misaligned');
    hint.classList.remove('aligned');
    hint.classList.add('misaligned', 'show');
    
    // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é
    let hintText = '';
    if (Math.abs(betaOffset) > Math.abs(gammaOffset)) {
      hintText = betaOffset > 0 ? '–ü–æ–¥–Ω–∏–º–∏—Ç–µ –≤–µ—Ä—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–∞' : '–û–ø—É—Å—Ç–∏—Ç–µ –≤–µ—Ä—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–∞';
    } else {
      hintText = gammaOffset > 0 ? '–ù–∞–∫–ª–æ–Ω–∏—Ç–µ –≤–ª–µ–≤–æ' : '–ù–∞–∫–ª–æ–Ω–∏—Ç–µ –≤–ø—Ä–∞–≤–æ';
    }
    hint.textContent = hintText;
  }
}

// ========== –†–∞–±–æ—Ç–∞ —Å –∫–∞–º–µ—Ä–æ–π ==========
async function startCamera() {
  try {
    if (cameraStream) {
      cameraStream.getTracks().forEach(track => track.stop());
    }
    
    const constraints = {
      video: {
        facingMode: currentFacingMode,
        width: { ideal: 1920 },
        height: { ideal: 1080 }
      }
    };
    
    cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
    const video = document.getElementById('video');
    video.srcObject = cameraStream;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã, –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞–º–µ—Ä
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videoDevices = devices.filter(device => device.kind === 'videoinput');
    if (videoDevices.length > 1) {
      document.getElementById('switchCamera').style.display = 'flex';
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    startDeviceOrientation();
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', error);
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ');
  }
}

function stopCamera() {
  if (cameraStream) {
    cameraStream.getTracks().forEach(track => track.stop());
    cameraStream = null;
  }
  stopDeviceOrientation();
}

function capturePhoto() {
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0);
  
  canvas.toBlob(blob => {
    capturedImageData = blob;
    showEditModal(URL.createObjectURL(blob));
    stopCamera();
    document.getElementById('cameraModal').classList.remove('active');
  }, 'image/jpeg', 0.9);
}

// ========== –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ ==========
document.getElementById('openCamera').addEventListener('click', () => {
  hapticFeedback('medium'); // –°—Ä–µ–¥–Ω—è—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–∞–º–µ—Ä—ã
  document.getElementById('cameraModal').classList.add('active');
  startCamera();
});

document.getElementById('closeCamera').addEventListener('click', () => {
  hapticFeedback('light'); // –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
  document.getElementById('cameraModal').classList.remove('active');
  stopCamera();
});

document.getElementById('captureBtn').addEventListener('click', capturePhoto);

document.getElementById('captureBtn').addEventListener('click', () => {
  hapticFeedback('heavy'); // –°–∏–ª—å–Ω–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ —Å—ä–µ–º–∫–µ
});

document.getElementById('switchCamera').addEventListener('click', () => {
  hapticFeedback('light'); // –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
  currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
  startCamera();
});

document.getElementById('uploadBtn').addEventListener('click', () => {
  hapticFeedback('light'); // –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≥–∞–ª–µ—Ä–µ–∏
  document.getElementById('fileInput').click();
});

document.getElementById('fileInput').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (file) {
    capturedImageData = file;
    showEditModal(URL.createObjectURL(file));
    document.getElementById('cameraModal').classList.remove('active');
    stopCamera();
  }
});

function showEditModal(imageUrl) {
  document.getElementById('previewImage').src = imageUrl;
  document.getElementById('editModal').classList.add('active');
  
  // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
  document.getElementById('productName').value = '';
  document.getElementById('productWeight').value = '';
  document.getElementById('calories').value = '';
  document.getElementById('protein').value = '';
  document.getElementById('fats').value = '';
  document.getElementById('carbs').value = '';
  document.getElementById('water').value = '';
  document.getElementById('aiComment').value = '';
  
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –Ω–∞ –∞–Ω–∞–ª–∏–∑
  analyzePhoto(capturedImageData);
}

document.getElementById('cancelEdit').addEventListener('click', () => {
  hapticFeedback('light'); // –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ
  document.getElementById('editModal').classList.remove('active');
  capturedImageData = null;
});

// ========== API –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ ==========
async function analyzePhoto(imageBlob) {
  try {
    document.getElementById('loadingOverlay').classList.add('active');
    
    const formData = new FormData();
    formData.append('image', imageBlob);
    formData.append('date', selectedDate.toISOString());
    
    // –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ –∫ –≤–∞—à–µ–º—É –±—ç–∫–µ–Ω–¥—É
    const response = await fetch(API_CONFIG.analyzeEndpoint, {
      method: 'POST',
      body: formData
    });
    
    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞');
    
    const data = await response.json();
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    document.getElementById('productName').value = data.name || '';
    document.getElementById('productWeight').value = data.weight || '';
    document.getElementById('calories').value = data.calories || '';
    document.getElementById('protein').value = data.protein || '';
    document.getElementById('fats').value = data.fats || '';
    document.getElementById('carbs').value = data.carbs || '';
    document.getElementById('water').value = data.water || '';
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞:', error);
    // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–ª—è –ø—É—Å—Ç—ã–º–∏ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
  } finally {
    document.getElementById('loadingOverlay').classList.remove('active');
  }
}

async function saveFoodEntry() {
  const saveBtn = document.getElementById('saveFood');
  const spinner = document.getElementById('saveSpinner');
  
  try {
    saveBtn.classList.add('loading');
    spinner.style.display = 'inline-block';
    
    const weight = parseFloat(document.getElementById('productWeight').value) || 0;
    const caloriesPer100 = parseFloat(document.getElementById('calories').value) || 0;
    const proteinPer100 = parseFloat(document.getElementById('protein').value) || 0;
    const fatsPer100 = parseFloat(document.getElementById('fats').value) || 0;
    const carbsPer100 = parseFloat(document.getElementById('carbs').value) || 0;
    
    const foodData = {
      date: selectedDate.toISOString(),
      name: document.getElementById('productName').value,
      weight: weight,
      calories: (caloriesPer100 * weight / 100).toFixed(1),
      protein: (proteinPer100 * weight / 100).toFixed(1),
      fats: (fatsPer100 * weight / 100).toFixed(1),
      carbs: (carbsPer100 * weight / 100).toFixed(1),
      water: parseFloat(document.getElementById('water').value) || 0,
      comment: document.getElementById('aiComment').value,
      image: capturedImageData
    };
    
    const formData = new FormData();
    Object.keys(foodData).forEach(key => {
      formData.append(key, foodData[key]);
    });
    
    const response = await fetch(API_CONFIG.saveEndpoint, {
      method: 'POST',
      body: formData
    });
    
    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
    
    hapticFeedback('success'); // –î–≤–æ–π–Ω–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
    
    document.getElementById('editModal').classList.remove('active');
    capturedImageData = null;
    
    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    await loadFoodData(selectedDate);
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
    hapticFeedback('error'); // –¢—Ä–æ–π–Ω–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç');
  } finally {
    saveBtn.classList.remove('loading');
    spinner.style.display = 'none';
  }
}

document.getElementById('saveFood').addEventListener('click', saveFoodEntry);

// ========== –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î ==========
async function loadFoodData(date) {
  try {
    const dateStr = date.toISOString().split('T')[0];
    console.log('üìÖ –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è:', dateStr);
    
    const response = await fetch(`${API_CONFIG.getFoodsEndpoint}?date=${dateStr}`);
    
    if (!response.ok) {
      // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      console.log('‚ÑπÔ∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã');
      displayFoodList([]);
      updateStats({ calories: 0, protein: 0, fats: 0, carbs: 0, water: 0 });
      return;
    }
    
    const data = await response.json();
    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', data);
    displayFoodList(data.foods || []);
    updateStats(data.totals || { calories: 0, protein: 0, fats: 0, carbs: 0, water: 0 });
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
    console.log('üîÑ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏');
    displayMockData();
  }
}

function displayFoodList(foods) {
  const listContainer = document.getElementById('foodList');
  
  if (foods.length === 0) {
    listContainer.innerHTML = `
      <div class="empty-state">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
        </svg>
        <div>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç</div>
      </div>
    `;
    return;
  }
  
  listContainer.innerHTML = foods.map(food => `
    <div class="table-row" data-id="${food.id}" onclick="hapticFeedback('light')">
      <div class="col-name">${food.name}</div>
      <div class="col-value">${food.weight}</div>
      <div class="col-value">${food.calories}</div>
      <div class="col-value">${food.protein}</div>
      <div class="col-value">${food.fats}</div>
      <div class="col-value">${food.carbs}</div>
      <div class="col-value">${food.water || '-'}</div>
    </div>
  `).join('');
}

function updateStats(totals) {
  // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–º–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –∑–∞–≥—Ä—É–∂–∞—Ç—å –∏–∑ API)
  const targets = {
    calories: parseInt(document.getElementById('cal-target').textContent),
    protein: parseInt(document.getElementById('protein-target').textContent),
    fats: parseInt(document.getElementById('fat-target').textContent),
    carbs: parseInt(document.getElementById('carbs-target').textContent)
  };
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
  document.getElementById('cal-current').textContent = Math.round(totals.calories);
  document.getElementById('protein-current').textContent = Math.round(totals.protein);
  document.getElementById('fat-current').textContent = Math.round(totals.fats);
  document.getElementById('carbs-current').textContent = Math.round(totals.carbs);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã
  updateProgressBar('cal-fill', totals.calories, targets.calories);
  updateProgressBar('protein-fill', totals.protein, targets.protein);
  updateProgressBar('fat-fill', totals.fats, targets.fats);
  updateProgressBar('carbs-fill', totals.carbs, targets.carbs);
}

function updateProgressBar(id, current, target) {
  const element = document.getElementById(id);
  const percentage = Math.min((current / target) * 100, 100);
  element.style.height = percentage + '%';
}

// ========== –ú–æ–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ ==========
function displayMockData() {
  const mockFoods = [
    { id: 1, name: '–û–≤—Å—è–Ω–∞—è –∫–∞—à–∞', weight: 200, calories: 140, protein: 5, fats: 3, carbs: 23, water: 0 },
    { id: 2, name: '–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞', weight: 150, calories: 165, protein: 31, fats: 3.6, carbs: 0, water: 0 },
    { id: 3, name: '–ì—Ä–µ—á–µ—Å–∫–∏–π —Å–∞–ª–∞—Ç', weight: 250, calories: 200, protein: 8, fats: 15, carbs: 12, water: 0 },
    { id: 4, name: '–í–æ–¥–∞', weight: 0, calories: 0, protein: 0, fats: 0, carbs: 0, water: 500 }
  ];
  
  const mockTotals = {
    calories: 505,
    protein: 44,
    fats: 21.6,
    carbs: 35,
    water: 500
  };
  
  displayFoodList(mockFoods);
  updateStats(mockTotals);
}

// ========== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ==========
generateCalendar();
loadFoodData(selectedDate);

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Ü–µ–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ API
async function loadTargets() {
  try {
    const response = await fetch(API_CONFIG.getTargetsEndpoint);
    if (response.ok) {
      const targets = await response.json();
      document.getElementById('cal-target').textContent = targets.calories;
      document.getElementById('protein-target').textContent = targets.protein;
      document.getElementById('fat-target').textContent = targets.fats;
      document.getElementById('carbs-target').textContent = targets.carbs;
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ü–µ–ª–µ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π:', error);
  }
}

loadTargets();

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
document.getElementById('cameraModal').addEventListener('click', (e) => {
  if (e.target.id === 'cameraModal') {
    document.getElementById('cameraModal').classList.remove('active');
    stopCamera();
  }
});

document.getElementById('editModal').addEventListener('click', (e) => {
  if (e.target.id === 'editModal') {
    document.getElementById('editModal').classList.remove('active');
    capturedImageData = null;
  }
});
</script>

</body>
</html>
