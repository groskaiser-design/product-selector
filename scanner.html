<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Food AI</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* ============================================================
       –†–ê–ó–î–ï–õ 1: –°–¢–ò–õ–ò –û–°–ù–û–í–ù–û–ì–û –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (measurements + ai)
       ============================================================ */
    :root {
      --bg: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --text-primary: #fff;
      /* –ê–∫–∫–æ—Ä–¥–µ–æ–Ω—ã */
      --cardA: rgba(255,255,255,.18);
      --cardB: rgba(255,255,255,.12);
      --border: rgba(255,255,255,.28);
      --shadow: 0 8px 28px rgba(0,0,0,.18);
      /* –¶–≤–µ—Ç–∞ UI */
      --okA: #fbbf24; --okB: #f59e0b;
      /* –ß–∞—Ç */
      --userBubble: rgba(251,191,36,.25);
      --userBorder: rgba(251,191,36,.4);
      --aiBubble: rgba(255,255,255,.18);
      --aiBorder: rgba(255,255,255,.28);
      --inputBg: rgba(255,255,255,.12);
      --inputBorder: rgba(255,255,255,.24);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body {
      min-height: 100vh; color: var(--text-primary); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      position: relative; isolation: isolate;
    }
    body::before { content: ""; position: fixed; inset: 0; background: var(--bg); z-index: 0; pointer-events: none; }

    .page { position: relative; z-index: 1; max-width: 560px; margin: 0 auto; padding: 16px 12px; padding-bottom: 80px; }

    /* --- –ê–ö–ö–û–†–î–ï–û–ù (–¢–æ—á–Ω–∞—è –∫–æ–ø–∏—è measurements) --- */
    .section {
      background: linear-gradient(180deg, var(--cardA), var(--cardB));
      border: 1px solid var(--border); border-radius: 18px; box-shadow: var(--shadow);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      overflow: hidden; margin-bottom: 14px; transition: all 0.3s ease;
    }
    .section-h { display: flex; align-items: center; gap: 10px; padding: 14px 16px; cursor: pointer; user-select: none; }
    .section-h h2 { font-size: 1rem; font-weight: 800; flex: 1; }
    .toggle { width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: .9; }
    .toggle svg { transition: transform .18s ease; }
    .section.collapsed .toggle svg { transform: rotate(-90deg); }
    .section.collapsed .section-content { display: none; }
    .section-content { padding: 0; }

    /* --- –ß–ê–¢ (–¢–æ—á–Ω–∞—è –∫–æ–ø–∏—è ai) --- */
    .chat-container { display: flex; flex-direction: column; height: 480px; background: rgba(0,0,0,0.1); }
    .chat-messages { flex: 1; overflow-y: auto; padding: 16px 14px; display: flex; flex-direction: column; gap: 12px; -webkit-overflow-scrolling: touch; }
    
    .message { display: flex; flex-direction: column; max-width: 85%; animation: slideIn .3s ease; position: relative; }
    @keyframes slideIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
    .message.user { align-self: flex-end; align-items: flex-end; }
    .message.ai { align-self: flex-start; align-items: flex-start; }

    .message-bubble {
      padding: 12px 16px; border-radius: 18px; backdrop-filter: blur(12px); font-size: 15px; line-height: 1.5; box-shadow: var(--shadow);
    }
    .message.user .message-bubble {
      background: linear-gradient(135deg, var(--userBubble), rgba(251,191,36,.2)); border: 1px solid var(--userBorder); border-bottom-right-radius: 4px;
    }
    .message.ai .message-bubble {
      background: linear-gradient(180deg, var(--aiBubble), rgba(255,255,255,.14)); border: 1px solid var(--aiBorder); border-bottom-left-radius: 4px;
    }
    
    /* –§–æ—Ç–æ –≤–Ω—É—Ç—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏—è */
    .msg-img-wrap { border-radius: 12px; overflow: hidden; margin-bottom: 6px; border: 1px solid rgba(255,255,255,0.3); }
    .msg-img-wrap img { display: block; width: 100%; height: auto; }

    /* --- –í–ò–î–ñ–ï–¢ –ü–†–û–î–£–ö–¢–û–í (–ß–ï–ö) --- */
    .fw-container { width: 100%; min-width: 220px; }
    .fw-header { font-weight: 800; font-size: 13px; text-transform: uppercase; opacity: 0.7; margin-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 4px; }
    .fw-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 14px; }
    .fw-total { margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2); font-weight: 900; color: var(--okA); display: flex; justify-content: space-between; }
    .fw-btn { margin-top: 12px; width: 100%; padding: 10px; border-radius: 10px; background: linear-gradient(135deg, var(--okA), var(--okB)); border:none; color: white; font-weight: 700; cursor: pointer; font-size: 14px;}
    .fw-btn.done { background: #22c55e; pointer-events: none; }

    /* --- –ò–ù–ü–£–¢ –ü–ê–ù–ï–õ–¨ --- */
    .input-area { padding: 12px 14px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; align-items: flex-end; gap: 10px; }
    .input-field {
      flex: 1; min-height: 44px; max-height: 120px; padding: 12px 16px;
      border: 1px solid var(--inputBorder); border-radius: 22px; background: var(--inputBg);
      backdrop-filter: blur(8px); color: #fff; font-size: 15px; resize: none; outline: none;
    }
    .send-btn {
      width: 44px; height: 44px; border: 0; border-radius: 50%;
      background: linear-gradient(135deg, var(--okA), var(--okB)); color: #fff;
      display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow); flex-shrink: 0; cursor: pointer;
    }
    .cam-btn-chat {
      width: 44px; height: 44px; border: 1px solid var(--inputBorder); border-radius: 50%;
      background: var(--inputBg); color: #fff; display: flex; align-items: center; justify-content: center; flex-shrink: 0; cursor: pointer; backdrop-filter: blur(8px);
    }


    /* ============================================================
       –†–ê–ó–î–ï–õ 2: –°–¢–ò–õ–ò –ö–ê–ú–ï–†–´ (–¢–û–ß–ù–ê–Ø –ö–û–ü–ò–Ø cam.html)
       –í—Å—Ç–∞–≤–ª–µ–Ω—ã "–∫–∞–∫ –µ—Å—Ç—å", –Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç –≤–Ω—É—Ç—Ä–∏ #cam-overlay
       ============================================================ */
    #cam-overlay {
      position: fixed; inset: 0; z-index: 9999; background: #000;
      display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    }
    #cam-overlay.visible { display: block; }

    /* --- CSS –∏–∑ cam.html --- */
    .cam-container { max-width: 760px; margin: 0 auto; padding: 16px; height: 100%; display: flex; flex-direction: column; }
    .hidden { display: none!important } 
    .row { display: flex; gap: 10px; flex-wrap: wrap }
    .btn-cam { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 16px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: #fff; font-weight: 600; cursor: pointer; font-size: 16px; backdrop-filter: blur(4px); }
    .btn-cam.primary { background: #2563eb; color: #fff; border-color: transparent } 
    .btn-cam[disabled] { opacity: .45; cursor: not-allowed }

    /* Viewport */
    .cam-wrap { position: relative; border: 1px solid rgba(255,255,255,0.2); border-radius: 16px; overflow: hidden; background: #000; aspect-ratio: 3/4; contain: layout paint; width: 100%; margin: 0 auto; flex-shrink: 0; }
    .cam-video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover }
    .cam-preview { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; display: none; opacity: 0; transition: opacity .3s ease }
    .cam-photo { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; display: block; background: #000 }
    .cam-overlay { position: absolute; inset: 0; pointer-events: none }

    /* Grids & Icons */
    .grid { position: absolute; inset: 0; opacity: .15; background: linear-gradient(#fff 1px,transparent 1px) 0 calc(33.333% - .5px)/100% 33.333% repeat-y, linear-gradient(#fff 1px,transparent 1px) 0 calc(66.666% - .5px)/100% 33.333% repeat-y, linear-gradient(90deg,#fff 1px,transparent 1px) calc(33.333% - .5px) 0/33.333% 100% repeat-x, linear-gradient(90deg,#fff 1px,transparent 1px) calc(66.666% - .5px) 0/33.333% 100% repeat-x }
    .topbar { position: absolute; left: 0; right: 0; top: 16px; display: flex; justify-content: center; gap: 10px; z-index: 9; padding: 0 12px }
    .chip { pointer-events: auto; display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.25); background: rgba(0,0,0,.65); color: #fff; font-size: 13px; backdrop-filter: blur(8px); max-width: calc(100% - 24px); text-align: center }

    .top-icon { position: absolute; top: 12px; z-index: 10; pointer-events: auto; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 999px; border: 1px solid rgba(255,255,255,.35); color: #fff; background: rgba(0,0,0,.48); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0,0,0,.25); cursor: pointer; transition: transform .08s ease,opacity .2s ease }
    .top-icon:active { transform: scale(.96) }
    .top-left { left: 12px }
    .top-right { right: 12px }
    /* –î–û–ü: –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç—å –æ–≤–µ—Ä–ª–µ–π (—Å–ª–µ–≤–∞ –≤–≤–µ—Ä—Ö—É, –≤–º–µ—Å—Ç–æ —Ñ–æ–Ω–∞—Ä–∏–∫–∞ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –∏–ª–∏ —Ä—è–¥–æ–º) */
    .top-close { position: absolute; top: 12px; left: 12px; z-index: 20; width: 40px; height: 40px; background:rgba(239,68,68,0.8); border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; cursor:pointer; border:1px solid rgba(255,255,255,0.3); pointer-events:auto; }

    /* Level */
    .center-level { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none }
    .level-outer { position: relative; width: 140px; height: 140px; border-radius: 50% }
    .level-target { position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%); border-radius: 50%; border: 2px solid rgba(255,255,255,.6); background: rgba(0,0,0,.1); width: 23px; height: 23px }
    .level-target.ok { border-color: #34d399; background: rgba(34,197,94,.15) }
    .level-bubble { position: absolute; left: 50%; top: 50%; width: 20px; height: 20px; border-radius: 50%; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,.4) }
    .level-bubble.ok { background: #22c55e }

    .card-guide { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); width: 100px; height: 160px; border-radius: 12px; border: 2px dashed rgba(255,255,255,.4); background: rgba(128,128,128,.2); pointer-events: none; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,.7); font-size: 11px; text-align: center; padding: 8px; backdrop-filter: blur(2px) }
    .indicators { position: absolute; left: 0; right: 0; bottom: 96px; display: flex; gap: 10px; justify-content: center; z-index: 9; pointer-events: none }
    .ind { pointer-events: auto; display: flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 12px; background: rgba(0,0,0,.6); border: 1px solid rgba(255,255,255,.2); color: #fff; backdrop-filter: blur(4px); font-size: 13px }
    .ind .bulb { width: 10px; height: 10px; border-radius: 50%; background: #f59e0b; box-shadow: 0 0 0 2px rgba(0,0,0,.3) inset }
    .ind.ok .bulb { background: #22c55e }

    .controls { position: absolute; left: 0; right: 0; bottom: 0; padding: 16px; display: flex; gap: 10px; align-items: center; justify-content: center; background: linear-gradient(to top,rgba(0,0,0,.6),rgba(0,0,0,0)); color: #fff }
    .shutter { width: 72px; height: 72px; border-radius: 50%; border: 4px solid rgba(255,255,255,.9); background: #fff; cursor: pointer; box-shadow: 0 4px 16px rgba(0,0,0,.3); transition: transform .1s }
    .shutter:active:not([disabled]) { transform: scale(.95) }

    /* Form elements inside Camera */
    .meta { color: rgba(255,255,255,0.7); font-size: 13px; margin-top: 8px }
    .field-cam { display: flex; flex-direction: column; gap: 6px; margin-top: 12px; flex: 1;}
    .textarea-cam { width: 100%; min-height: 72px; resize: vertical; padding: 10px 12px; border: 1px solid rgba(255,255,255,0.3); border-radius: 12px; font: inherit; line-height: 1.4; background: rgba(0,0,0,0.3); color: white; }
    .helper { color: rgba(255,255,255,0.6); font-size: 13px }
  </style>
</head>
<body>

<div class="page">

  <section class="section" id="sec-food">
    <div class="section-h" onclick="toggleAccordion('sec-food')">
      <h2>–î–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è</h2>
      <div class="toggle">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
          <path d="M8 10l4 4 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
    </div>

    <div class="section-content">
      <div class="chat-container">
        
        <div class="chat-messages" id="chatFeed">
          <div class="message ai">
            <div class="message-bubble">
              –ü—Ä–∏–≤–µ—Ç! –ù–∞–∂–º–∏ üì∑, —á—Ç–æ–±—ã —Å—Ñ–æ—Ç–∫–∞—Ç—å –µ–¥—É, –∏–ª–∏ –Ω–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç–æ–º.
            </div>
          </div>
        </div>

        <div class="input-area">
          <button class="cam-btn-chat" onclick="startCameraFlow()">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
              <circle cx="12" cy="13" r="4"/>
            </svg>
          </button>
          <textarea id="mainInput" class="input-field" rows="1" placeholder="–û–ø–∏—à–∏—Ç–µ –µ–¥—É..."></textarea>
          <button class="send-btn" id="chatSendBtn" onclick="handleTextSend()">
            <svg viewBox="0 0 24 24" fill="none" width="20" height="20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
          </button>
        </div>

      </div>
    </div>
  </section>

  <section class="section collapsed" id="sec-stats">
    <div class="section-h" onclick="toggleAccordion('sec-stats')">
      <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
      <div class="toggle">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
          <path d="M8 10l4 4 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
    </div>
    <div class="section-content" style="padding: 16px;">
      <div style="text-align:center; opacity:0.7;">–ó–¥–µ—Å—å –±—É–¥–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ (—Ç–∞–±–ª–∏—Ü–∞ –∏ –≥—Ä–∞—Ñ–∏–∫–∏)</div>
    </div>
  </section>

</div>

<div id="cam-overlay">
  <div class="top-close" onclick="closeCameraOverlay()">‚úï</div>

  <div class="cam-container">
    <div id="err" class="error hidden"></div>

    <section id="sec-main" style="flex:1; display:flex; flex-direction:column;">
      <input id="file-cam" type="file" accept="image/*" capture="environment" class="hidden" />
      <input id="file-gallery" type="file" accept="image/*" class="hidden" />

      <div class="cam-wrap" id="camWrap" aria-label="–ö–∞–º–µ—Ä–∞">
        <video id="video" class="cam-video" playsinline muted autoplay></video>
        <canvas id="preview" class="cam-preview" aria-label="–ü—Ä–µ–≤—å—é –∫–∞–º–µ—Ä—ã" role="img"></canvas>
        <img id="photo" class="cam-photo hidden" alt="–°–Ω–∏–º–æ–∫" />

        <div id="overlay" class="cam-overlay">
          <div class="grid" aria-hidden="true"></div>
          <div class="topbar"><div id="chipInfo" class="chip" role="status" aria-live="polite">–û—Ç–∫—Ä—ã–≤–∞—é –∫–∞–º–µ—Ä—É‚Ä¶</div></div>
          
          <button id="btnTorch" class="top-icon" style="right: 60px; top: 12px;" aria-label="–§–æ–Ω–∞—Ä–∏–∫">
            <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M7 2l9 0-4 7h5l-9 13 3-9H7z"/></svg>
          </button>
          <button id="btnLevelReset" class="top-icon top-right" aria-label="–°–±—Ä–æ—Å">
            <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12 4a8 8 0 1 0 7.45 5.11h-2.2A6 6 0 1 1 12 6c1.3 0 2.5.42 3.46 1.13L14 8.6h6V2l-2.1 2.1A9.96 9.96 0 0 0 12 4z"/></svg>
          </button>

          <button id="btnPermission" class="btn-permission hidden" style="position:absolute; right:12px; top:60px; z-index:10; pointer-events:auto; padding:8px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.3); color:#fff; background:rgba(245,158,11,.85);">‚ö†Ô∏è</button>
          
          <div class="center-level" aria-hidden="true">
            <div class="level-outer" id="levelOuter">
              <div id="levelTarget" class="level-target"></div>
              <div id="levelBubble" class="level-bubble"></div>
            </div>
          </div>
          <div class="card-guide"><span>–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞, (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–æ–≤—ã—Å–∏—Ç —Ç–æ—á–Ω–æ—Å—Ç—å)</span></div>
          <div class="indicators"><div id="indLevel" class="ind"><span class="bulb"></span><span class="label">–†–æ–≤–Ω–æ</span></div></div>
        </div>

        <div id="controls" class="controls">
          <button id="btnShot" class="shutter" aria-label="–°–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫" disabled></button>
        </div>
      </div>

      <div class="field-cam">
        <label for="comment" class="helper">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
        <textarea id="comment" class="textarea-cam" maxlength="200" placeholder="–†–∏—Å –±–µ–ª—ã–π, –∫—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞..."></textarea>
        <div id="commentWarn" class="helper hidden"></div>
      </div>

      <div class="row" style="margin-top:12px; justify-content: space-between;">
        <button id="btnRetake" class="btn-cam" disabled>–ü–µ—Ä–µ—Å–Ω—è—Ç—å</button>
        <button id="btnGallery" class="btn-cam">–ì–∞–ª–µ—Ä–µ—è</button>
        <button id="camSendBtn" class="btn-cam primary" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </section>
  </div>
</div>

<script>
/* ============================================================
   –†–ê–ó–î–ï–õ 6: –°–ö–†–ò–ü–¢–´ UI (–ê–ö–ö–û–†–î–ï–û–ù + –ß–ê–¢)
   ============================================================ */
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram
  const tg = window.Telegram?.WebApp;
  if(tg) { tg.ready(); tg.expand(); }

  // 1. –ê–∫–∫–æ—Ä–¥–µ–æ–Ω
  function toggleAccordion(id) {
    document.getElementById(id).classList.toggle('collapsed');
  }

  // 2. –ß–∞—Ç –õ–æ–≥–∏–∫–∞
  const feed = document.getElementById('chatFeed');
  const mainInput = document.getElementById('mainInput');

  function scrollToBottom() {
    feed.parentElement.scrollTop = feed.parentElement.scrollHeight;
  }

  function addMessage(role, htmlContent) {
    const msg = document.createElement('div');
    msg.className = `message ${role}`;
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    bubble.innerHTML = htmlContent;
    msg.appendChild(bubble);
    feed.appendChild(msg);
    scrollToBottom();
  }

  // –í–∏–¥–∂–µ—Ç –ß–µ–∫–∞ (Mockup)
  function addFoodWidget(data) {
    const msg = document.createElement('div');
    msg.className = 'message ai';
    
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    bubble.style.padding = '0';
    bubble.style.overflow = 'hidden';

    let listHtml = '';
    data.items.forEach(item => {
      listHtml += `<div class="fw-row"><span>${item.name}</span><span>${item.kcal} –∫–∫–∞–ª</span></div>`;
    });

    const btnId = 'btn_' + Date.now();
    bubble.innerHTML = `
      <div class="fw-container" style="padding: 12px 16px;">
        <div class="fw-header">–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ</div>
        ${listHtml}
        <div class="fw-total"><span>–ò–¢–û–ì–û:</span><span>${data.total} –∫–∫–∞–ª</span></div>
        <button id="${btnId}" class="fw-btn" onclick="saveToLog('${btnId}')">‚úÖ –ó–∞–ø–∏—Å–∞—Ç—å –≤ –¥–Ω–µ–≤–Ω–∏–∫</button>
      </div>
    `;
    msg.appendChild(bubble);
    feed.appendChild(msg);
    scrollToBottom();
  }

  function saveToLog(id) {
    const btn = document.getElementById(id);
    btn.innerText = '–ó–∞–ø–∏—Å–∞–Ω–æ ‚úì';
    btn.classList.add('done');
    if(window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
  }

  function handleTextSend() {
    const txt = mainInput.value.trim();
    if(!txt) return;
    addMessage('user', txt);
    mainInput.value = '';
    
    // –°–∏–º—É–ª—è—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ AI
    setTimeout(() => {
      addFoodWidget({ total: 200, items: [{name: txt, kcal: 200}] });
    }, 1000);
  }

  /* –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å –∫–∞–º–µ—Ä—ã (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –ª–æ–≥–∏–∫–∏ –∫–∞–º–µ—Ä—ã) */
  function handleCameraResult(blob, comment) {
    // 1. –°–æ–∑–¥–∞–µ–º URL –¥–ª—è –ø—Ä–µ–≤—å—é
    const url = URL.createObjectURL(blob);
    let html = `<div class="msg-img-wrap"><img src="${url}"></div>`;
    if(comment) html += `<div>${comment}</div>`;
    
    // 2. –î–æ–±–∞–≤–ª—è–µ–º –≤ —á–∞—Ç
    addMessage('user', html);
    
    // 3. –°–∏–º—É–ª—è—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ —Ñ–æ—Ç–æ
    setTimeout(() => {
       addFoodWidget({ total: 450, items: [{name: "–û–±–µ–¥ –ø–æ —Ñ–æ—Ç–æ", kcal: 450}] });
    }, 1500);
  }


/* ============================================================
   –†–ê–ó–î–ï–õ 7: –°–ö–†–ò–ü–¢–´ –ö–ê–ú–ï–†–´ (–¢–û–ß–ù–ê–Ø –ö–û–ü–ò–Ø cam.html JS)
   ============================================================ */
  'use strict';
  const PERM_KEY = 'fc_motion_perm_v1';
  const PLATFORM = { isIOS: /iP(hone|od|ad)/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1), isAndroid: /Android/.test(navigator.userAgent) };
  const CONFIG = { idealFacing: { facingMode: { ideal: 'environment' }, aspectRatio: { ideal: 3/4 } }, maxPhotoSide: 4096, jpegQuality: 0.9, bubbleRadius: 10, targetRadius: 15, levelRadius: 50, needsPermissionRequest: PLATFORM.isIOS, tiltSmoothing: 0.15, allowTakePhoto: false };
  
  const STATE = { stream:null, track:null, videoElement:null, imageCapture:null, hasTorch:false, torchOn:false, sensorsEnabled:false, lastSensorTime:0, rawNx:0, rawNy:0, smoothNx:0, smoothNy:0, levelOK:false, currentView:'camera', lastBlob:null, capturing:false, sensorPermission:'unknown', levelRaf:null };

  // DOM Elements (Mapping to IDs inside overlay)
  const $ = id => document.getElementById(id);
  const DOM = {
    overlay: $('cam-overlay'), err: $('err'), video: $('video'), preview: $('preview'), photo: $('photo'), overlayUI: $('overlay'), controls: $('controls'),
    btnShot: $('btnShot'), btnTorch: $('btnTorch'), btnPermission: $('btnPermission'), btnLevelReset: $('btnLevelReset'), chipInfo: $('chipInfo'), 
    levelBubble: $('levelBubble'), levelTarget: $('levelTarget'), levelOuter: $('levelOuter'), indLevel: $('indLevel'),
    btnRetake: $('btnRetake'), btnGallery: $('btnGallery'), btnSend: $('camSendBtn'), comment: $('comment'), commentWarn: $('commentWarn'), camWrap: $('camWrap'),
    fileGallery: $('file-gallery'), fileCam: $('file-cam')
  };

  // --- Helpers ---
  const sleep = ms => new Promise(r => setTimeout(r, ms));
  function haptic(){ try{ window.Telegram?.WebApp?.HapticFeedback?.impactOccurred?.('light'); }catch{} }
  function setError(msg){ if(!msg){ DOM.err.classList.add('hidden'); DOM.err.textContent=''; return;} DOM.err.textContent=msg; DOM.err.classList.remove('hidden'); }
  function sanitizeComment(input){ return String(input||'').slice(0,200).trim(); }
  function hasContent(){ return STATE.lastBlob || sanitizeComment(DOM.comment.value).length>0; }

  // --- UI Update ---
  function updateButtons(){ 
    DOM.btnRetake.disabled = STATE.currentView==='camera'||STATE.capturing; 
    DOM.btnSend.disabled = !hasContent()||STATE.capturing; 
    DOM.btnShot.disabled = !STATE.levelOK||STATE.capturing; 
  }
  function syncLevelIndicator(){ DOM.indLevel.classList.toggle('ok',STATE.levelOK); }

  function showCameraUI(){
    STATE.currentView='camera';
    DOM.video.classList.remove('hidden'); DOM.preview.classList.add('hidden'); DOM.overlayUI.classList.remove('hidden'); DOM.controls.classList.remove('hidden'); DOM.photo.classList.add('hidden');
    DOM.chipInfo.textContent='–ù–∞–≤–æ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É';
    computeLevelRadiusDeferred(); startLevelLoop();
    updateButtons(); syncLevelIndicator();
  }
  function showPhotoUI(){
    STATE.currentView='photo';
    DOM.preview.classList.add('hidden'); DOM.video.classList.add('hidden'); DOM.overlayUI.classList.add('hidden'); DOM.controls.classList.add('hidden'); DOM.photo.classList.remove('hidden');
    updateButtons();
  }

  // --- Camera Logic ---
  async function openCamera(){
    try{
      const stream=await navigator.mediaDevices.getUserMedia({ video: CONFIG.idealFacing, audio:false });
      bindStream(stream);
      return true;
    } catch(err){
      console.warn('Camera failed:',err); return false;
    }
  }
  function bindStream(stream){
    if(STATE.stream) stopCamera();
    STATE.stream=stream; STATE.track=stream.getVideoTracks()[0];
    DOM.video.srcObject=stream;
    
    const caps=STATE.track.getCapabilities?.()||{};
    STATE.hasTorch=!!caps.torch;
    if(!STATE.hasTorch) DOM.btnTorch.style.opacity = 0.5;
    
    if(typeof ImageCapture!=='undefined'){ try{ STATE.imageCapture=new ImageCapture(STATE.track); }catch{} }
  }
  function stopCamera(){
    try{ DOM.video.pause(); DOM.video.srcObject=null; }catch{}
    try{ STATE.track?.stop(); }catch{}
    STATE.stream=null; STATE.track=null; STATE.imageCapture=null; STATE.torchOn=false;
  }

  // --- Capture ---
  function canvasToBlob(canvas,quality=CONFIG.jpegQuality){ return new Promise(r=>{ canvas.toBlob(b=>r(b),'image/jpeg',quality); }); }
  function computeCoverCropByAspect(vw,vh,canvasAspect){ let sx,sy,sw,sh; const videoAspect=vw/vh; if(videoAspect>canvasAspect){ sh=vh; sw=Math.round(sh*canvasAspect); sx=Math.floor((vw-sw)/2); sy=0; } else { sw=vw; sh=Math.round(sw/canvasAspect); sx=0; sy=Math.floor((vh-sh)/2); } return {sx,sy,sw,sh}; }

  async function captureWysiwygFromVideo(){
    const video=DOM.video; const vw=video.videoWidth, vh=video.videoHeight;
    const aspect = DOM.camWrap.clientWidth/DOM.camWrap.clientHeight;
    const {sx,sy,sw,sh}=computeCoverCropByAspect(vw,vh,aspect);
    const scale=Math.min(1,CONFIG.maxPhotoSide/Math.max(sw,sh));
    const outW=Math.max(1,Math.round(sw*scale)), outH=Math.max(1,Math.round(sh*scale));
    const c=document.createElement('canvas'); c.width=outW; c.height=outH;
    c.getContext('2d').drawImage(video,sx,sy,sw,sh,0,0,outW,outH);
    return canvasToBlob(c);
  }
  
  async function onShutter(){ 
    if(DOM.btnShot.disabled||STATE.capturing) return; 
    STATE.capturing=true; updateButtons(); haptic(); 
    try{ 
      const blob=await captureWysiwygFromVideo(); 
      STATE.lastBlob=blob; 
      const url=URL.createObjectURL(blob); 
      DOM.photo.onload=()=>{ URL.revokeObjectURL(url); }; 
      DOM.photo.src=url; 
      showPhotoUI(); 
    }catch(err){ 
      setError('–û—à–∏–±–∫–∞ —Å–Ω–∏–º–∫–∞'); 
    } finally { 
      STATE.capturing=false; updateButtons(); 
    } 
  }

  // --- Sensors (Full Tilt Logic) ---
  function refreshScreenAngle(){ STATE.screenAngle=((window.orientation||0)%360+360)%360; }
  function mapTilt(pitchDeg,rollDeg){ const maxTilt=30; const pr=Math.max(-1,Math.min(1,pitchDeg/maxTilt)); const rr=Math.max(-1,Math.min(1,rollDeg/maxTilt)); let nx=0,ny=0; switch(STATE.screenAngle){ case 0:nx=rr;ny=pr;break; case 90:nx=-pr;ny=rr;break; case 180:nx=-rr;ny=-pr;break; case 270:nx=pr;ny=-rr;break; } return {nx,ny}; }
  
  function onDeviceOrientation(e){ 
    if(STATE.currentView!=='camera') return; 
    const {nx,ny}=mapTilt(e.beta||0, e.gamma||0); 
    const a=CONFIG.tiltSmoothing; 
    STATE.smoothNx=STATE.smoothNx + a*(nx-STATE.smoothNx); 
    STATE.smoothNy=STATE.smoothNy + a*(ny-STATE.smoothNy); 
  }
  
  async function requestSensorPermission(){ 
    if(!CONFIG.needsPermissionRequest){ attachListeners(); return; }
    if(typeof DeviceOrientationEvent.requestPermission==='function'){
       try{ const r=await DeviceOrientationEvent.requestPermission(); if(r==='granted') attachListeners(); }catch{}
    }
  }
  function attachListeners(){ window.addEventListener('deviceorientation',onDeviceOrientation,true); DOM.btnPermission.classList.add('hidden'); STATE.sensorsEnabled=true; }
  function removeListeners(){ window.removeEventListener('deviceorientation',onDeviceOrientation,true); }

  function computeLevelRadius(){ const rect = DOM.levelOuter.getBoundingClientRect(); if(rect.width) CONFIG.levelRadius = Math.max(10, Math.floor(rect.width * 0.35)); }
  function computeLevelRadiusDeferred(){ requestAnimationFrame(()=>requestAnimationFrame(computeLevelRadius)); }
  
  function updateLevel(){ 
    const R=CONFIG.levelRadius; const dx=STATE.smoothNx*R, dy=STATE.smoothNy*R; 
    DOM.levelBubble.style.transform=`translate(-50%, -50%) translate(${dx}px, ${dy}px)`; 
    const dist=Math.hypot(dx,dy); 
    const wasOK=STATE.levelOK; STATE.levelOK=(dist+CONFIG.bubbleRadius)<=CONFIG.targetRadius; 
    if(STATE.levelOK!==wasOK){ DOM.levelBubble.classList.toggle('ok',STATE.levelOK); DOM.levelTarget.classList.toggle('ok',STATE.levelOK); syncLevelIndicator(); updateButtons(); } 
  }
  function startLevelLoop(){ if(STATE.levelRaf)return; const tick=()=>{ if(STATE.currentView==='camera') updateLevel(); STATE.levelRaf=requestAnimationFrame(tick); }; STATE.levelRaf=requestAnimationFrame(tick); }
  function stopLevelLoop(){ if(STATE.levelRaf){ cancelAnimationFrame(STATE.levelRaf); STATE.levelRaf=null; } }

  // --- Integration Functions ---
  async function startCameraFlow(){
    DOM.overlay.classList.add('visible');
    stopLevelLoop(); STATE.lastBlob=null; STATE.capturing=false; STATE.levelOK=false;
    STATE.rawNx=0; STATE.rawNy=0; STATE.smoothNx=0; STATE.smoothNy=0;
    updateButtons(); setError(''); refreshScreenAngle();
    
    const opened=await openCamera();
    if(!opened){ setError('–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'); return; }
    
    if(!STATE.sensorsEnabled) requestSensorPermission(); // Auto-req if needed
    showCameraUI();
  }
  
  function closeCameraOverlay() {
    DOM.overlay.classList.remove('visible');
    stopCamera(); stopLevelLoop();
  }

  // --- Event Listeners ---
  DOM.btnShot.addEventListener('click', onShutter);
  DOM.btnRetake.addEventListener('click', startCameraFlow);
  DOM.btnLevelReset.addEventListener('click', ()=>{ STATE.smoothNx=0; STATE.smoothNy=0; });
  DOM.btnPermission.addEventListener('click', requestSensorPermission);
  
  // –ì–∞–ª–µ—Ä–µ—è
  DOM.btnGallery.addEventListener('click', ()=>{ DOM.fileGallery.click(); });
  DOM.fileGallery.addEventListener('change', (e)=>{ 
    const file=e.target.files[0]; 
    if(file){ STATE.lastBlob=file; DOM.photo.src=URL.createObjectURL(file); showPhotoUI(); } 
  });

  // ! –ì–õ–ê–í–ù–ê–Ø –°–í–Ø–ó–ö–ê: –û–¢–ü–†–ê–í–ò–¢–¨ –í –ß–ê–¢ !
  DOM.btnSend.addEventListener('click', ()=>{
     if(!STATE.lastBlob) return;
     const comment = sanitizeComment(DOM.comment.value);
     
     // 1. –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π
     closeCameraOverlay();
     
     // 2. –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —á–∞—Ç
     handleCameraResult(STATE.lastBlob, comment);
     
     // 3. –°–±—Ä–æ—Å
     DOM.comment.value = '';
     DOM.photo.src = '';
  });

  window.addEventListener('resize', computeLevelRadius);

</script>
</body>
</html>
