<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>FoodTracker AI</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root {
      --bg: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --text-primary: #fff;
      --cardA: rgba(255,255,255,.18);
      --cardB: rgba(255,255,255,.12);
      --okA: #fbbf24; --okB: #f59e0b;
      --danger: #ef4444;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body {
      background: var(--bg); color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh; padding-bottom: 40px;
    }
    
    /* --- –ê–ö–ö–û–†–î–ï–û–ù–´ (–ë–∞–∑–∞) --- */
    .page { max-width: 560px; margin: 0 auto; padding: 16px; }
    .section {
      background: linear-gradient(180deg, var(--cardA), var(--cardB));
      border: 1px solid rgba(255,255,255,0.2); border-radius: 18px;
      margin-bottom: 14px; overflow: hidden; backdrop-filter: blur(12px);
    }
    .section-h {
      padding: 16px; display: flex; align-items: center; justify-content: space-between;
      font-weight: 800; cursor: pointer;
    }
    .section.collapsed .section-content { display: none; }
    .section-content { padding: 0 16px 16px; }

    /* --- –ß–ê–¢ (–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π) --- */
    .chat-area {
      height: 400px; overflow-y: auto;
      display: flex; flex-direction: column; gap: 12px;
      padding-bottom: 10px; scroll-behavior: smooth;
    }
    .message { max-width: 85%; animation: fadeUp 0.3s ease; }
    .message.user { align-self: flex-end; }
    .message.ai { align-self: flex-start; width: 100%; }
    
    @keyframes fadeUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

    .bubble {
      padding: 10px 14px; border-radius: 14px; font-size: 15px; line-height: 1.4;
    }
    .message.user .bubble {
      background: rgba(251,191,36,0.2); border: 1px solid rgba(251,191,36,0.4);
      border-bottom-right-radius: 2px;
    }
    .message.ai .bubble {
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
      border-bottom-left-radius: 2px; padding: 0; /* –ü–∞–¥–¥–∏–Ω–≥ 0 –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞ */
    }

    /* --- –í–ò–î–ñ–ï–¢ –ï–î–´ (–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —á–µ–∫) --- */
    .food-widget { width: 100%; }
    .fw-header {
      padding: 10px 14px; background: rgba(255,255,255,0.05);
      border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 700; font-size: 13px; opacity: 0.8;
    }
    .fw-list { padding: 10px 14px; }
    .fw-item { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 14px; }
    .fw-item span:last-child { font-weight: 700; opacity: 0.9; }
    
    .fw-total {
      padding: 10px 14px; border-top: 1px solid rgba(255,255,255,0.1);
      display: flex; justify-content: space-between; font-weight: 900; color: var(--okA);
    }
    
    .fw-actions { padding: 10px; display: flex; gap: 8px; }
    .btn-save {
      flex: 1; padding: 10px; border-radius: 10px; border: none;
      background: linear-gradient(135deg, var(--okA), var(--okB));
      color: #fff; font-weight: 700; cursor: pointer; transition: transform 0.1s;
    }
    .btn-save:active { transform: scale(0.96); }
    .btn-save.saved { background: #22c55e; pointer-events: none; }

    /* --- –ü–ê–ù–ï–õ–¨ –í–í–û–î–ê --- */
    .input-bar {
      margin-top: 12px; display: flex; gap: 8px; align-items: flex-end;
    }
    .btn-icon {
      width: 44px; height: 44px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.1); color: #fff; font-size: 20px;
      display: flex; align-items: center; justify-content: center; cursor: pointer;
    }
    .text-input {
      flex: 1; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3);
      border-radius: 12px; padding: 12px; color: #fff; font-size: 16px; resize: none;
    }

    /* --- –ö–ê–ú–ï–†–ê (–û–≤–µ—Ä–ª–µ–π) --- */
    #camera-overlay {
      position: fixed; inset: 0; z-index: 9999; background: #000;
      display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    }
    /* –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª–∞—Å—Å—ã –∏–∑ cam.html –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π */
    .cam-wrap { width: 100%; height: 100%; position: relative; }
    video { width: 100%; height: 100%; object-fit: cover; }
    .cam-ui { position: absolute; bottom: 30px; left: 0; right: 0; display: flex; justify-content: center; gap: 20px; }
    .shutter { width: 70px; height: 70px; border-radius: 50%; background: #fff; border: 4px solid rgba(255,255,255,0.5); }
    .close-cam { 
      position: absolute; top: 20px; right: 20px; z-index: 10000;
      background: rgba(0,0,0,0.5); color: #fff; padding: 8px 16px; border-radius: 20px; font-weight: bold;
    }
    
    /* –£–†–û–í–ï–ù–¨ (–∏–∑ cam.html simplified) */
    .level-guide {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 100px; height: 100px; border: 2px dashed rgba(255,255,255,0.5); border-radius: 50%;
      pointer-events: none;
    }
    .level-bubble {
      position: absolute; width: 20px; height: 20px; background: var(--okA); border-radius: 50%;
      top: 50%; left: 50%; transform: translate(-50%, -50%); transition: all 0.2s;
    }

    /* --- –ê–ù–ê–õ–ò–¢–ò–ö–ê --- */
    .stats-grid { display: flex; gap: 10px; margin-bottom: 16px; }
    .stat-col { flex: 1; text-align: center; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px; }
    .stat-val { font-size: 18px; font-weight: 900; display: block; }
    .stat-lbl { font-size: 12px; opacity: 0.7; }
    
    .today-list { font-size: 13px; }
    .today-row { 
      display: flex; justify-content: space-between; padding: 8px 0; 
      border-bottom: 1px solid rgba(255,255,255,0.1); 
    }
  </style>
</head>
<body>

<div class="page">

  <section class="section" id="sec-chat">
    <div class="section-h" onclick="toggleSection('sec-chat')">
      <span>–î–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è</span>
      <span>‚ñº</span>
    </div>
    <div class="section-content">
      
      <div class="chat-area" id="chatFeed">
        <div class="message ai">
          <div class="bubble">
            –ü—Ä–∏–≤–µ—Ç! –Ø –≥–æ—Ç–æ–≤. –°—Ñ–æ—Ç–∫–∞–π –µ–¥—É –∏–ª–∏ –Ω–∞–ø–∏—à–∏.
          </div>
        </div>
      </div>

      <div class="input-bar">
        <button class="btn-icon" onclick="openCamera()">üì∑</button>
        <textarea id="msgInput" class="text-input" rows="1" placeholder="–ß—Ç–æ —Å—ä–µ–ª–∏?"></textarea>
        <button class="btn-icon" style="background: var(--okA)" onclick="sendText()">‚û§</button>
      </div>

    </div>
  </section>

  <section class="section" id="sec-stats">
    <div class="section-h" onclick="toggleSection('sec-stats')">
      <span>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (–°–µ–≥–æ–¥–Ω—è)</span>
      <span>‚ñº</span>
    </div>
    <div class="section-content">
      <div class="stats-grid">
        <div class="stat-col"><span class="stat-val" id="st-cal">0</span><span class="stat-lbl">–ö–∫–∞–ª</span></div>
        <div class="stat-col"><span class="stat-val" id="st-prot">0</span><span class="stat-lbl">–ë–µ–ª–∫–∏</span></div>
        <div class="stat-col"><span class="stat-val" id="st-fat">0</span><span class="stat-lbl">–ñ–∏—Ä—ã</span></div>
        <div class="stat-col"><span class="stat-val" id="st-carb">0</span><span class="stat-lbl">–£–≥–ª–∏</span></div>
      </div>
      
      <div class="today-list" id="todayList">
        <div style="opacity:0.5; text-align:center; padding:10px">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>
      </div>
    </div>
  </section>

</div>

<div id="camera-overlay">
  <div class="cam-wrap">
    <video id="camVideo" autoplay muted playsinline></video>
    
    <div class="close-cam" onclick="closeCamera()">–ó–∞–∫—Ä—ã—Ç—å ‚úï</div>
    
    <div class="level-guide">
      <div id="lvlBubble" class="level-bubble"></div>
    </div>

    <div class="cam-ui">
      <button class="shutter" onclick="takePhoto()"></button>
    </div>
  </div>
</div>

<script>
/* ================= –õ–û–ì–ò–ö–ê UI ================= */
function toggleSection(id) {
  document.getElementById(id).classList.toggle('collapsed');
}

/* ================= –ß–ê–¢ –ò –í–ò–î–ñ–ï–¢–´ ================= */
const feed = document.getElementById('chatFeed');

function addMessage(role, content) {
  const div = document.createElement('div');
  div.className = `message ${role}`;
  div.innerHTML = `<div class="bubble">${content}</div>`;
  feed.appendChild(div);
  feed.scrollTop = feed.scrollHeight;
}

// –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∞ –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–û–ì–û –ß–ï–ö–ê
function addFoodWidget(data) {
  const div = document.createElement('div');
  div.className = 'message ai';
  
  // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞
  const btnId = 'btn_' + Date.now();
  const jsonStr = JSON.stringify(data).replace(/"/g, '&quot;'); // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –¥–ª—è –∞—Ç—Ä–∏–±—É—Ç–∞

  let listHtml = '';
  data.products.forEach(p => {
    listHtml += `<div class="fw-item"><span>${p.name}</span><span>${p.kcal} –∫–∫–∞–ª</span></div>`;
  });

  div.innerHTML = `
    <div class="bubble food-widget">
      <div class="fw-header">–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ</div>
      <div class="fw-list">${listHtml}</div>
      <div class="fw-total">
        <span>–ò—Ç–æ–≥–æ:</span>
        <span>${data.total_kcal} –∫–∫–∞–ª</span>
      </div>
      <div class="fw-actions">
        <button id="${btnId}" class="btn-save" onclick="saveToLog('${btnId}', ${jsonStr})">
          ‚úÖ –ó–∞–ø–∏—Å–∞—Ç—å –≤ –¥–Ω–µ–≤–Ω–∏–∫
        </button>
      </div>
    </div>
  `;
  feed.appendChild(div);
  feed.scrollTop = feed.scrollHeight;
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ó–∞–ø–∏—Å–∞—Ç—å" –í–ù–£–¢–†–ò —á–∞—Ç–∞
function saveToLog(btnId, data) {
  const btn = document.getElementById(btnId);
  if (!btn) return;
  
  // 1. –í–∏–∑—É–∞–ª—å–Ω–æ –º–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É
  btn.textContent = '–ó–∞–ø–∏—Å–∞–Ω–æ ‚úì';
  btn.classList.add('saved');
  
  // 2. –í–∏–±—Ä–∞—Ü–∏—è
  if(window.Telegram?.WebApp?.HapticFeedback) {
    window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
  }

  // 3. –û–±–Ω–æ–≤–ª—è–µ–º "–ë–∞–∑—É" (–ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é)
  updateStats(data);
}

/* ================= –ê–ù–ê–õ–ò–¢–ò–ö–ê ================= */
let dailyStats = { cal: 0, prot: 0, fat: 0, carb: 0, items: [] };

function updateStats(data) {
  // –°—É–º–º–∏—Ä—É–µ–º
  dailyStats.cal += data.total_kcal;
  data.products.forEach(p => {
     dailyStats.prot += (p.p || 0);
     dailyStats.fat += (p.f || 0);
     dailyStats.carb += (p.c || 0);
     dailyStats.items.push(p);
  });

  // –û–±–Ω–æ–≤–ª—è–µ–º UI –≤ —Å–µ–∫—Ü–∏–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
  document.getElementById('st-cal').textContent = Math.round(dailyStats.cal);
  document.getElementById('st-prot').textContent = Math.round(dailyStats.prot);
  document.getElementById('st-fat').textContent = Math.round(dailyStats.fat);
  document.getElementById('st-carb').textContent = Math.round(dailyStats.carb);

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
  const list = document.getElementById('todayList');
  list.innerHTML = dailyStats.items.map((item, idx) => `
    <div class="today-row">
      <span>${item.name}</span>
      <span>${item.kcal}</span>
      <span style="color:#ef4444; font-weight:bold; cursor:pointer" onclick="removeItem(${idx})">‚úï</span>
    </div>
  `).join('');
}

/* ================= –û–¢–ü–†–ê–í–ö–ê –¢–ï–ö–°–¢–ê ================= */
function sendText() {
  const inp = document.getElementById('msgInput');
  const txt = inp.value.trim();
  if(!txt) return;
  
  addMessage('user', txt);
  inp.value = '';

  // –ò–º–∏—Ç–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ AI —á–µ—Ä–µ–∑ 1 —Å–µ–∫ (–ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ç–≤–æ–π fetch –∫ –±—ç–∫–µ–Ω–¥—É)
  setTimeout(() => {
    // –¢–≤–æ–π –±—ç–∫–µ–Ω–¥ –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å —Ç–∞–∫–æ–π JSON
    const mockResponse = {
      total_kcal: 350,
      products: [
        { name: txt, kcal: 350, p: 15, f: 10, c: 40 }
      ]
    };
    addFoodWidget(mockResponse);
  }, 1000);
}

/* ================= –ö–ê–ú–ï–†–ê (–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ cam.html) ================= */
const camOverlay = document.getElementById('camera-overlay');
const video = document.getElementById('camVideo');
let stream = null;

async function openCamera() {
  camOverlay.style.display = 'block';
  try {
    stream = await navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: 'environment' } 
    });
    video.srcObject = stream;
    startLevelSensor(); // –ó–∞–ø—É—Å–∫ –≥–∏—Ä–æ—Å–∫–æ–ø–∞
  } catch(e) {
    alert('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: ' + e.message);
    closeCamera();
  }
}

function closeCamera() {
  camOverlay.style.display = 'none';
  if(stream) stream.getTracks().forEach(t => t.stop());
  stopLevelSensor();
}

function takePhoto() {
  // 1. –§–µ–π–∫ —Å–Ω–∏–º–∫–∞: –±–µ—Ä–µ–º –∫–∞–¥—Ä –∏–∑ –≤–∏–¥–µ–æ
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  
  // 2. –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–∞–º–µ—Ä—É
  closeCamera();
  
  // 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ —á–∞—Ç–µ "–§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ"
  addMessage('user', 'üì∑ [–§–æ—Ç–æ –µ–¥—ã]');
  addMessage('ai', '–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ñ–æ—Ç–æ...');
  
  // 4. –ò–º–∏—Ç–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ AI
  setTimeout(() => {
    const mockPhotoResponse = {
      total_kcal: 420,
      products: [
        { name: '–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞', kcal: 200, p: 30, f: 5, c: 0 },
        { name: '–†–∏—Å –±–µ–ª—ã–π', kcal: 220, p: 4, f: 1, c: 45 }
      ]
    };
    addFoodWidget(mockPhotoResponse);
  }, 1500);
}

/* ================= –ì–ò–†–û–°–ö–û–ü (–£—Ä–æ–≤–µ–Ω—å) ================= */
// –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è –ø—É–∑—ã—Ä—å–∫–∞
function handleOrientation(event) {
  const bubble = document.getElementById('lvlBubble');
  // beta: –Ω–∞–∫–ª–æ–Ω –≤–ø–µ—Ä–µ–¥-–Ω–∞–∑–∞–¥ [-180, 180]
  // gamma: –Ω–∞–∫–ª–æ–Ω –≤–ª–µ–≤–æ-–≤–ø—Ä–∞–≤–æ [-90, 90]
  // –î–ª—è "–ø–ª–æ—Å–∫–æ–≥–æ" –ø–æ–ª–æ–∂–µ–Ω–∏—è beta ~ 0, gamma ~ 0
  
  let x = event.gamma || 0; 
  let y = event.beta || 0;
  
  // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –∫—Ä—É–≥–∞
  if(x > 20) x = 20; if(x < -20) x = -20;
  if(y > 20) y = 20; if(y < -20) y = -20;
  
  bubble.style.transform = `translate(calc(-50% + ${x * 2}px), calc(-50% + ${y * 2}px))`;
  
  // –ï—Å–ª–∏ —Ä–æ–≤–Ω–æ - –∑–µ–ª–µ–Ω—ã–π, –∏–Ω–∞—á–µ –∂–µ–ª—Ç—ã–π
  if(Math.abs(x) < 3 && Math.abs(y) < 3) {
    bubble.style.background = '#22c55e'; // Green
  } else {
    bubble.style.background = '#fbbf24'; // Yellow
  }
}

function startLevelSensor() {
  if (window.DeviceOrientationEvent) {
    window.addEventListener('deviceorientation', handleOrientation);
  }
}
function stopLevelSensor() {
  window.removeEventListener('deviceorientation', handleOrientation);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TMA
if(window.Telegram?.WebApp) {
  window.Telegram.WebApp.ready();
  window.Telegram.WebApp.expand();
}
</script>

</body>
</html>
