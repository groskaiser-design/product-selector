<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Food AI</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* ============================================================
       –†–ê–ó–î–ï–õ 1: –ì–õ–û–ë–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò (–ë–ê–ó–ê)
       ============================================================ */
    :root {
      --bg: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --text-primary: #fff;
      
      /* –ê–∫–∫–æ—Ä–¥–µ–æ–Ω—ã */
      --cardA: rgba(255,255,255,.18);
      --cardB: rgba(255,255,255,.12);
      --border: rgba(255,255,255,.28);
      --shadow: 0 8px 28px rgba(0,0,0,.18);
      
      /* –¶–≤–µ—Ç–∞ */
      --okA: #fbbf24; --okB: #f59e0b; /* –û—Ä–∞–Ω–∂–µ–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
      
      /* –ß–∞—Ç */
      --userBubble: rgba(251,191,36,.25);
      --userBorder: rgba(251,191,36,.4);
      --aiBubble: rgba(255,255,255,.18);
      --aiBorder: rgba(255,255,255,.28);
      --inputBg: rgba(255,255,255,.12);
      --inputBorder: rgba(255,255,255,.24);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body {
      min-height: 100vh; color: var(--text-primary); 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      position: relative; isolation: isolate;
    }
    body::before { content: ""; position: fixed; inset: 0; background: var(--bg); z-index: 0; pointer-events: none; }

    .page { position: relative; z-index: 1; max-width: 560px; margin: 0 auto; padding: 16px 12px; padding-bottom: 80px; }

    /* --- –ê–ö–ö–û–†–î–ï–û–ù --- */
    .section {
      background: linear-gradient(180deg, var(--cardA), var(--cardB));
      border: 1px solid var(--border); border-radius: 18px; box-shadow: var(--shadow);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      overflow: hidden; margin-bottom: 14px; transition: all 0.3s ease;
    }
    .section-h { display: flex; align-items: center; gap: 10px; padding: 14px 16px; cursor: pointer; user-select: none; }
    .section-h h2 { font-size: 1rem; font-weight: 800; flex: 1; }
    .toggle { width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: .9; }
    .toggle svg { transition: transform .18s ease; }
    .section.collapsed .toggle svg { transform: rotate(-90deg); }
    .section.collapsed .section-content { display: none; }
    .section-content { padding: 0; }

    /* --- –ß–ê–¢ --- */
    .chat-container { display: flex; flex-direction: column; height: 480px; background: rgba(0,0,0,0.1); }
    .chat-messages { flex: 1; overflow-y: auto; padding: 16px 14px; display: flex; flex-direction: column; gap: 12px; -webkit-overflow-scrolling: touch; }
    
    .message { display: flex; flex-direction: column; max-width: 85%; animation: slideIn .3s ease; position: relative; }
    @keyframes slideIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
    .message.user { align-self: flex-end; align-items: flex-end; }
    .message.ai { align-self: flex-start; align-items: flex-start; }

    .message-bubble {
      padding: 12px 16px; border-radius: 18px; backdrop-filter: blur(12px); font-size: 15px; line-height: 1.5; box-shadow: var(--shadow);
    }
    .message.user .message-bubble {
      background: linear-gradient(135deg, var(--userBubble), rgba(251,191,36,.2)); border: 1px solid var(--userBorder); border-bottom-right-radius: 4px;
    }
    .message.ai .message-bubble {
      background: linear-gradient(180deg, var(--aiBubble), rgba(255,255,255,.14)); border: 1px solid var(--aiBorder); border-bottom-left-radius: 4px;
    }
    .msg-img-wrap { border-radius: 12px; overflow: hidden; margin-bottom: 6px; border: 1px solid rgba(255,255,255,0.3); }
    .msg-img-wrap img { display: block; width: 100%; height: auto; }

    /* --- –í–ò–î–ñ–ï–¢ –ü–†–û–î–£–ö–¢–û–í --- */
    .fw-container { width: 100%; min-width: 220px; }
    .fw-header { font-weight: 800; font-size: 13px; text-transform: uppercase; opacity: 0.7; margin-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 4px; }
    .fw-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 14px; }
    .fw-total { margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2); font-weight: 900; color: var(--okA); display: flex; justify-content: space-between; }
    .fw-btn { margin-top: 12px; width: 100%; padding: 10px; border-radius: 10px; background: linear-gradient(135deg, var(--okA), var(--okB)); border:none; color: white; font-weight: 700; cursor: pointer; font-size: 14px;}
    .fw-btn.done { background: #22c55e; pointer-events: none; }

    /* --- –ò–ù–ü–£–¢ –ü–ê–ù–ï–õ–¨ --- */
    .input-area { padding: 12px 14px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; align-items: flex-end; gap: 10px; }
    .input-field {
      flex: 1; min-height: 44px; max-height: 120px; padding: 12px 16px;
      border: 1px solid var(--inputBorder); border-radius: 22px; background: var(--inputBg);
      backdrop-filter: blur(8px); color: #fff; font-size: 15px; resize: none; outline: none;
    }
    .send-btn {
      width: 44px; height: 44px; border: 0; border-radius: 50%;
      background: linear-gradient(135deg, var(--okA), var(--okB)); color: #fff;
      display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow); flex-shrink: 0; cursor: pointer;
    }
    .cam-btn-chat {
      width: 44px; height: 44px; border: 1px solid var(--inputBorder); border-radius: 50%;
      background: var(--inputBg); color: #fff; display: flex; align-items: center; justify-content: center; flex-shrink: 0; cursor: pointer; backdrop-filter: blur(8px);
    }

    /* ============================================================
       –†–ê–ó–î–ï–õ 2: –°–¢–ò–õ–ò –ö–ê–ú–ï–†–´
       ============================================================ */
    #cam-overlay {
      position: fixed; inset: 0; z-index: 9999; background: #000;
      display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    }
    #cam-overlay.visible { display: block; }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    .cam-container { max-width: 760px; margin: 0 auto; padding: 16px; height: 100%; display: flex; flex-direction: column; }
    .hidden { display: none!important } 
    .row { display: flex; gap: 10px; flex-wrap: wrap }
    
    /* –ö–Ω–æ–ø–∫–∏ –∫–∞–º–µ—Ä—ã */
    .btn-cam { 
      display: inline-flex; align-items: center; justify-content: center; gap: 8px; 
      padding: 12px 16px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.3); 
      background: rgba(255,255,255,0.1); color: #fff; font-weight: 600; cursor: pointer; 
      font-size: 16px; backdrop-filter: blur(4px); flex: 1;
    }
    /* –ü–†–ê–í–ö–ê 5: –û—Ä–∞–Ω–∂–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å */
    .btn-cam.primary { 
      background: linear-gradient(135deg, var(--okA), var(--okB)); 
      color: #fff; border-color: transparent; 
    } 
    .btn-cam[disabled] { opacity: .45; cursor: not-allowed }

    /* –í—å—é–ø–æ—Ä—Ç –∫–∞–º–µ—Ä—ã */
    .cam-wrap { 
      position: relative; border: 1px solid rgba(255,255,255,0.2); border-radius: 16px; 
      overflow: hidden; background: #000; aspect-ratio: 3/4; 
      width: 100%; margin: 0 auto; flex-shrink: 0; 
    }
    .cam-video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover }
    .cam-preview { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; display: none; opacity: 0; transition: opacity .3s ease }
    .cam-photo { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; display: block; background: #000 }
    .cam-overlay { position: absolute; inset: 0; pointer-events: none }

    /* –ò–∫–æ–Ω–∫–∏ —Å–≤–µ—Ä—Ö—É */
    .topbar { position: absolute; left: 0; right: 0; top: 16px; display: flex; justify-content: center; gap: 10px; z-index: 9; padding: 0 12px }
    .chip { pointer-events: auto; display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.25); background: rgba(0,0,0,.65); color: #fff; font-size: 13px; backdrop-filter: blur(8px); max-width: calc(100% - 24px); text-align: center }

    /* –ï–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è –∫—Ä—É–≥–ª—ã—Ö –∏–∫–æ–Ω–æ–∫ —Å–≤–µ—Ä—Ö—É */
    .top-icon, .top-close { 
      position: absolute; top: 12px; z-index: 20; pointer-events: auto; 
      width: 40px; height: 40px; border-radius: 50%; 
      display: flex; align-items: center; justify-content: center; 
      border: 1px solid rgba(255,255,255,.35); color: #fff; 
      background: rgba(0,0,0,.48); backdrop-filter: blur(10px); 
      box-shadow: 0 2px 8px rgba(0,0,0,.25); cursor: pointer; 
    }
    .top-icon:active, .top-close:active { transform: scale(.96) }

    /* –ü–†–ê–í–ö–ê 3: –ö—Ä–∞—Å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –≤—ã—Ä–æ–≤–Ω–µ–Ω–∞ */
    .top-close { 
      left: 12px; 
      background: rgba(239,68,68,0.85); /* –ö—Ä–∞—Å–Ω—ã–π */
      border-color: rgba(255,255,255,0.3);
    }
    .top-right-1 { right: 12px; }
    .top-right-2 { right: 60px; }

    /* –£—Ä–æ–≤–µ–Ω—å */
    .center-level { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none }
    .level-outer { position: relative; width: 140px; height: 140px; border-radius: 50% }
    .level-target { position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%); border-radius: 50%; border: 2px solid rgba(255,255,255,.6); background: rgba(0,0,0,.1); width: 23px; height: 23px }
    .level-target.ok { border-color: #34d399; background: rgba(34,197,94,.15) }
    .level-bubble { position: absolute; left: 50%; top: 50%; width: 20px; height: 20px; border-radius: 50%; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,.4) }
    .level-bubble.ok { background: #22c55e }
    .indicators { position: absolute; left: 0; right: 0; bottom: 96px; display: flex; gap: 10px; justify-content: center; z-index: 9; pointer-events: none }
    .ind { pointer-events: auto; display: flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 12px; background: rgba(0,0,0,.6); border: 1px solid rgba(255,255,255,.2); color: #fff; backdrop-filter: blur(4px); font-size: 13px }
    .ind .bulb { width: 10px; height: 10px; border-radius: 50%; background: #f59e0b; box-shadow: 0 0 0 2px rgba(0,0,0,.3) inset }
    .ind.ok .bulb { background: #22c55e }

    /* –ö–Ω–æ–ø–∫–∞ —Å–ø—É—Å–∫–∞ */
    .controls { position: absolute; left: 0; right: 0; bottom: 0; padding: 16px; display: flex; gap: 10px; align-items: center; justify-content: center; background: linear-gradient(to top,rgba(0,0,0,.6),rgba(0,0,0,0)); color: #fff }
    .shutter { width: 72px; height: 72px; border-radius: 50%; border: 4px solid rgba(255,255,255,.9); background: #fff; cursor: pointer; box-shadow: 0 4px 16px rgba(0,0,0,.3); transition: transform .1s }
    .shutter:active:not([disabled]) { transform: scale(.95) }
    
    /* –ü–†–ê–í–ö–ê 1: –í–∏–∑—É–∞–ª—å–Ω–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */
    .shutter[disabled] {
      opacity: 0.3;
      border-color: rgba(255,255,255,0.3);
      cursor: not-allowed;
      background: rgba(255,255,255,0.5);
    }

    /* –§–æ—Ä–º–∞ –≤ –∫–∞–º–µ—Ä–µ */
    .field-cam { display: flex; flex-direction: column; gap: 6px; margin-top: 12px; flex: 1;}
    .textarea-cam { width: 100%; min-height: 72px; resize: vertical; padding: 10px 12px; border: 1px solid rgba(255,255,255,0.3); border-radius: 12px; font: inherit; line-height: 1.4; background: rgba(0,0,0,0.3); color: white; }
    .helper { color: rgba(255,255,255,0.6); font-size: 13px }
    
    /* –ü–†–ê–í–ö–ê 4: –ö–ª–∞—Å—Å, –∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ */
    .keyboard-active .controls, 
    .keyboard-active .btn-cam:not(#camSendBtn) {
       display: none !important; /* –ü—Ä—è—á–µ–º –∫–Ω–æ–ø–∫—É —Å–ø—É—Å–∫–∞ –∏ –¥—Ä—É–≥–∏–µ –∫–Ω–æ–ø–∫–∏, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–∏ */
    }
  </style>
</head>
<body>

<div class="page">

  <section class="section" id="sec-food">
    <div class="section-h" onclick="toggleAccordion('sec-food')">
      <h2>–î–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è</h2>
      <div class="toggle">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
          <path d="M8 10l4 4 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
    </div>

    <div class="section-content">
      <div class="chat-container">
        <div class="chat-messages" id="chatFeed">
          <div class="message ai">
            <div class="message-bubble">
              –ü—Ä–∏–≤–µ—Ç! –ù–∞–∂–º–∏ üì∑, —á—Ç–æ–±—ã —Å—Ñ–æ—Ç–∫–∞—Ç—å –µ–¥—É, –∏–ª–∏ –Ω–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç–æ–º.
            </div>
          </div>
        </div>

        <div class="input-area">
          <button class="cam-btn-chat" onclick="startCameraFlow()">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
              <circle cx="12" cy="13" r="4"/>
            </svg>
          </button>
          <textarea id="mainInput" class="input-field" rows="1" placeholder="–û–ø–∏—à–∏—Ç–µ –µ–¥—É..."></textarea>
          <button class="send-btn" id="chatSendBtn" onclick="handleTextSend()">
            <svg viewBox="0 0 24 24" fill="none" width="20" height="20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </section>

  <section class="section collapsed" id="sec-stats">
    <div class="section-h" onclick="toggleAccordion('sec-stats')">
      <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
      <div class="toggle">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
          <path d="M8 10l4 4 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
    </div>
    <div class="section-content" style="padding: 16px;">
      <div style="text-align:center; opacity:0.7;">–ó–¥–µ—Å—å –±—É–¥–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
    </div>
  </section>
</div>

<div id="cam-overlay">
  <div class="top-close" onclick="closeCameraOverlay()">‚úï</div>

  <div class="cam-container">
    <div id="err" class="error hidden"></div>

    <section id="sec-main" style="flex:1; display:flex; flex-direction:column;">
      <input id="file-cam" type="file" accept="image/*" capture="environment" class="hidden" />
      <input id="file-gallery" type="file" accept="image/*" class="hidden" />

      <div class="cam-wrap" id="camWrap" aria-label="–ö–∞–º–µ—Ä–∞">
        <video id="video" class="cam-video" playsinline muted autoplay></video>
        <canvas id="preview" class="cam-preview" aria-label="–ü—Ä–µ–≤—å—é –∫–∞–º–µ—Ä—ã" role="img"></canvas>
        <img id="photo" class="cam-photo hidden" alt="–°–Ω–∏–º–æ–∫" />

        <div id="overlay" class="cam-overlay">
          <div class="grid" aria-hidden="true"></div>
          <div class="topbar"><div id="chipInfo" class="chip" role="status" aria-live="polite">–û—Ç–∫—Ä—ã–≤–∞—é –∫–∞–º–µ—Ä—É‚Ä¶</div></div>
          
          <button id="btnTorch" class="top-icon top-right-2" aria-label="–§–æ–Ω–∞—Ä–∏–∫">
            <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M7 2l9 0-4 7h5l-9 13 3-9H7z"/></svg>
          </button>
          <button id="btnLevelReset" class="top-icon top-right-1" aria-label="–°–±—Ä–æ—Å">
            <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12 4a8 8 0 1 0 7.45 5.11h-2.2A6 6 0 1 1 12 6c1.3 0 2.5.42 3.46 1.13L14 8.6h6V2l-2.1 2.1A9.96 9.96 0 0 0 12 4z"/></svg>
          </button>

          <button id="btnPermission" class="hidden" style="position:absolute; right:12px; top:60px; z-index:10; padding:8px; border-radius:99px; background:rgba(245,158,11,.8); border:none">‚ö†Ô∏è</button>
          
          <div class="center-level" aria-hidden="true">
            <div class="level-outer" id="levelOuter">
              <div id="levelTarget" class="level-target"></div>
              <div id="levelBubble" class="level-bubble"></div>
            </div>
          </div>
          <div class="card-guide"><span>–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</span></div>
          <div class="indicators"><div id="indLevel" class="ind"><span class="bulb"></span><span class="label">–†–æ–≤–Ω–æ</span></div></div>
        </div>

        <div id="controls" class="controls">
          <button id="btnShot" class="shutter" aria-label="–°–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫" disabled></button>
        </div>
      </div>

      <div class="field-cam">
        <label for="comment" class="helper">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
        <textarea id="comment" class="textarea-cam" maxlength="200" placeholder="–ß—Ç–æ –Ω–∞ —Ñ–æ—Ç–æ?"></textarea>
        <div id="commentWarn" class="helper hidden"></div>
      </div>

      <div class="row" style="margin-top:12px; justify-content: space-between;">
        <button id="btnRetake" class="btn-cam" disabled>–ü–µ—Ä–µ—Å–Ω—è—Ç—å</button>
        <button id="btnGallery" class="btn-cam">–ì–∞–ª–µ—Ä–µ—è</button>
        <button id="camSendBtn" class="btn-cam primary" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </section>
  </div>
</div>

<script>
/* ============================================================
   –†–ê–ó–î–ï–õ 6: –°–ö–†–ò–ü–¢–´ UI (–ß–ê–¢)
   ============================================================ */
  const tg = window.Telegram?.WebApp;
  if(tg) { tg.ready(); tg.expand(); }

  function toggleAccordion(id) {
    document.getElementById(id).classList.toggle('collapsed');
  }

  const feed = document.getElementById('chatFeed');
  const mainInput = document.getElementById('mainInput');

  function scrollToBottom() {
    feed.parentElement.scrollTop = feed.parentElement.scrollHeight;
  }

  function addMessage(role, htmlContent) {
    const msg = document.createElement('div');
    msg.className = `message ${role}`;
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    bubble.innerHTML = htmlContent;
    msg.appendChild(bubble);
    feed.appendChild(msg);
    scrollToBottom();
  }

  function addFoodWidget(data) {
    const msg = document.createElement('div');
    msg.className = 'message ai';
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    bubble.style.padding = '0';
    bubble.style.overflow = 'hidden';

    let listHtml = '';
    data.items.forEach(item => {
      listHtml += `<div class="fw-row"><span>${item.name}</span><span>${item.kcal} –∫–∫–∞–ª</span></div>`;
    });

    const btnId = 'btn_' + Date.now();
    bubble.innerHTML = `
      <div class="fw-container" style="padding: 12px 16px;">
        <div class="fw-header">–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ</div>
        ${listHtml}
        <div class="fw-total"><span>–ò–¢–û–ì–û:</span><span>${data.total} –∫–∫–∞–ª</span></div>
        <button id="${btnId}" class="fw-btn" onclick="saveToLog('${btnId}')">‚úÖ –ó–∞–ø–∏—Å–∞—Ç—å –≤ –¥–Ω–µ–≤–Ω–∏–∫</button>
      </div>
    `;
    msg.appendChild(bubble);
    feed.appendChild(msg);
    scrollToBottom();
  }

  function saveToLog(id) {
    const btn = document.getElementById(id);
    btn.innerText = '–ó–∞–ø–∏—Å–∞–Ω–æ ‚úì';
    btn.classList.add('done');
    if(window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
  }

  function handleTextSend() {
    const txt = mainInput.value.trim();
    if(!txt) return;
    addMessage('user', txt);
    mainInput.value = '';
    setTimeout(() => {
      addFoodWidget({ total: 200, items: [{name: txt, kcal: 200}] });
    }, 1000);
  }

  function handleCameraResult(blob, comment) {
    const url = URL.createObjectURL(blob);
    let html = `<div class="msg-img-wrap"><img src="${url}"></div>`;
    if(comment) html += `<div>${comment}</div>`;
    addMessage('user', html);
    setTimeout(() => {
       addFoodWidget({ total: 450, items: [{name: "–û–±–µ–¥ –ø–æ —Ñ–æ—Ç–æ", kcal: 450}] });
    }, 1500);
  }

/* ============================================================
   –†–ê–ó–î–ï–õ 7: –°–ö–†–ò–ü–¢–´ –ö–ê–ú–ï–†–´ (–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø)
   ============================================================ */
  'use strict';
  const PERM_KEY = 'fc_motion_perm_v1';
  const CONFIG = { idealFacing: { facingMode: { ideal: 'environment' }, aspectRatio: { ideal: 3/4 } }, maxPhotoSide: 4096, jpegQuality: 0.9, bubbleRadius: 10, targetRadius: 15, levelRadius: 50, needsPermissionRequest: /iP(hone|od|ad)/.test(navigator.userAgent), tiltSmoothing: 0.15 };
  
  const STATE = { stream:null, track:null, videoElement:null, hasTorch:false, torchOn:false, sensorsEnabled:false, smoothNx:0, smoothNy:0, levelOK:false, currentView:'camera', lastBlob:null, capturing:false, sensorPermission:'unknown', levelRaf:null };

  const $ = id => document.getElementById(id);
  const DOM = {
    overlay: $('cam-overlay'), err: $('err'), video: $('video'), preview: $('preview'), photo: $('photo'), overlayUI: $('overlay'), controls: $('controls'),
    btnShot: $('btnShot'), btnTorch: $('btnTorch'), btnPermission: $('btnPermission'), btnLevelReset: $('btnLevelReset'), chipInfo: $('chipInfo'), 
    levelBubble: $('levelBubble'), levelTarget: $('levelTarget'), levelOuter: $('levelOuter'), indLevel: $('indLevel'),
    btnRetake: $('btnRetake'), btnGallery: $('btnGallery'), btnSend: $('camSendBtn'), comment: $('comment'), camWrap: $('camWrap'),
    fileGallery: $('file-gallery'), camContainer: $('cam-container')
  };

  // --- Helpers ---
  function haptic(){ try{ window.Telegram?.WebApp?.HapticFeedback?.impactOccurred?.('light'); }catch{} }
  function setError(msg){ if(!msg){ DOM.err.classList.add('hidden'); DOM.err.textContent=''; return;} DOM.err.textContent=msg; DOM.err.classList.remove('hidden'); }
  function hasContent(){ return STATE.lastBlob || DOM.comment.value.trim().length>0; }

  // --- –ü–†–ê–í–ö–ê 1: –ö–Ω–æ–ø–∫–∞ –≤–∏–∑—É–∞–ª—å–Ω–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞ ---
  function updateButtons(){ 
    const cantShoot = !STATE.levelOK || STATE.capturing;
    DOM.btnShot.disabled = cantShoot; 
    // CSS .shutter[disabled] —Ç–µ–ø–µ—Ä—å –¥–µ–ª–∞–µ—Ç –µ—ë –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–π
    
    DOM.btnRetake.disabled = STATE.currentView==='camera'||STATE.capturing; 
    DOM.btnSend.disabled = !hasContent()||STATE.capturing; 
  }
  
  function syncLevelIndicator(){ DOM.indLevel.classList.toggle('ok',STATE.levelOK); }

  function showCameraUI(){
    STATE.currentView='camera';
    DOM.video.classList.remove('hidden'); DOM.preview.classList.add('hidden'); DOM.overlayUI.classList.remove('hidden'); DOM.controls.classList.remove('hidden'); DOM.photo.classList.add('hidden');
    DOM.chipInfo.textContent='–ù–∞–≤–æ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É';
    computeLevelRadiusDeferred(); startLevelLoop();
    updateButtons(); syncLevelIndicator();
  }
  function showPhotoUI(){
    STATE.currentView='photo';
    DOM.preview.classList.add('hidden'); DOM.video.classList.add('hidden'); DOM.overlayUI.classList.add('hidden'); DOM.controls.classList.add('hidden'); DOM.photo.classList.remove('hidden');
    updateButtons();
  }

  // --- Camera Logic ---
  async function openCamera(){
    try{
      const stream=await navigator.mediaDevices.getUserMedia({ video: CONFIG.idealFacing, audio:false });
      bindStream(stream);
      return true;
    } catch(err){ console.warn(err); return false; }
  }
  function bindStream(stream){
    if(STATE.stream) stopCamera();
    STATE.stream=stream; STATE.track=stream.getVideoTracks()[0];
    DOM.video.srcObject=stream;
    // Check Torch
    const caps=STATE.track.getCapabilities?.()||{};
    STATE.hasTorch=!!caps.torch;
    DOM.btnTorch.style.opacity = STATE.hasTorch ? 1 : 0.3;
  }
  function stopCamera(){
    try{ DOM.video.pause(); DOM.video.srcObject=null; }catch{}
    try{ STATE.track?.stop(); }catch{}
    STATE.stream=null; STATE.track=null; STATE.torchOn=false;
  }

  // --- –ü–†–ê–í–ö–ê 2: –í—Å–ø—ã—à–∫–∞ (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ) ---
  async function toggleTorch(){ 
    if(!STATE.track || !STATE.hasTorch) return; 
    try{ 
      STATE.torchOn=!STATE.torchOn; 
      await STATE.track.applyConstraints({advanced:[{torch:STATE.torchOn}]}); 
      haptic(); 
    }catch(err){ console.warn(err); STATE.torchOn=false; }
  }

  // --- Capture (Simplified) ---
  function canvasToBlob(canvas){ return new Promise(r=>{ canvas.toBlob(b=>r(b),'image/jpeg',0.9); }); }
  
  async function onShutter(){ 
    if(DOM.btnShot.disabled||STATE.capturing) return; 
    STATE.capturing=true; updateButtons(); haptic(); 
    try{ 
      const canvas = document.createElement('canvas');
      canvas.width = DOM.video.videoWidth; canvas.height = DOM.video.videoHeight;
      canvas.getContext('2d').drawImage(DOM.video, 0, 0);
      const blob = await canvasToBlob(canvas);
      STATE.lastBlob=blob; DOM.photo.src=URL.createObjectURL(blob); 
      showPhotoUI(); 
    }catch(err){ setError('–û—à–∏–±–∫–∞'); } finally { STATE.capturing=false; updateButtons(); } 
  }

  // --- Sensors ---
  function mapTilt(b, g){ 
    const ang=((window.orientation||0)%360+360)%360; 
    let nx=0, ny=0; 
    // –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥
    const max=30; const pr=Math.max(-1,Math.min(1,b/max)); const rr=Math.max(-1,Math.min(1,g/max));
    if(ang===0){nx=rr;ny=pr;} else if(ang===90){nx=-pr;ny=rr;} else if(ang===180){nx=-rr;ny=-pr;} else {nx=pr;ny=-rr;}
    return {nx,ny};
  }
  function onDeviceOrientation(e){ 
    if(STATE.currentView!=='camera') return; 
    const {nx,ny}=mapTilt(e.beta||0, e.gamma||0); 
    const a=CONFIG.tiltSmoothing; 
    STATE.smoothNx=STATE.smoothNx + a*(nx-STATE.smoothNx); 
    STATE.smoothNy=STATE.smoothNy + a*(ny-STATE.smoothNy); 
  }
  function requestSensorPermission(){ 
    if(typeof DeviceOrientationEvent.requestPermission==='function'){
       DeviceOrientationEvent.requestPermission().then(r=>{if(r==='granted') attachListeners();});
    } else attachListeners();
  }
  function attachListeners(){ window.addEventListener('deviceorientation',onDeviceOrientation,true); DOM.btnPermission.classList.add('hidden'); STATE.sensorsEnabled=true; }

  function computeLevelRadius(){ const rect = DOM.levelOuter.getBoundingClientRect(); if(rect.width) CONFIG.levelRadius = Math.max(10, Math.floor(rect.width * 0.35)); }
  function computeLevelRadiusDeferred(){ requestAnimationFrame(()=>requestAnimationFrame(computeLevelRadius)); }
  
  function updateLevel(){ 
    const R=CONFIG.levelRadius; const dx=STATE.smoothNx*R, dy=STATE.smoothNy*R; 
    DOM.levelBubble.style.transform=`translate(-50%, -50%) translate(${dx}px, ${dy}px)`; 
    const dist=Math.hypot(dx,dy); 
    const wasOK=STATE.levelOK; STATE.levelOK=(dist+CONFIG.bubbleRadius)<=CONFIG.targetRadius; 
    if(STATE.levelOK!==wasOK){ DOM.levelBubble.classList.toggle('ok',STATE.levelOK); DOM.levelTarget.classList.toggle('ok',STATE.levelOK); syncLevelIndicator(); updateButtons(); } 
  }
  function startLevelLoop(){ if(STATE.levelRaf)return; const tick=()=>{ if(STATE.currentView==='camera') updateLevel(); STATE.levelRaf=requestAnimationFrame(tick); }; STATE.levelRaf=requestAnimationFrame(tick); }
  function stopLevelLoop(){ if(STATE.levelRaf){ cancelAnimationFrame(STATE.levelRaf); STATE.levelRaf=null; } }

  // --- Integration ---
  async function startCameraFlow(){
    DOM.overlay.classList.add('visible');
    stopLevelLoop(); STATE.lastBlob=null; STATE.capturing=false; STATE.levelOK=false;
    STATE.rawNx=0; STATE.rawNy=0; STATE.smoothNx=0; STATE.smoothNy=0;
    updateButtons(); setError('');
    const opened=await openCamera();
    if(!opened){ setError('–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'); return; }
    if(!STATE.sensorsEnabled && CONFIG.needsPermissionRequest) DOM.btnPermission.classList.remove('hidden');
    else if(!STATE.sensorsEnabled) attachListeners();
    showCameraUI();
  }
  function closeCameraOverlay() { DOM.overlay.classList.remove('visible'); stopCamera(); stopLevelLoop(); }

  // Listeners
  DOM.btnShot.addEventListener('click', onShutter);
  DOM.btnTorch.addEventListener('click', toggleTorch);
  DOM.btnRetake.addEventListener('click', startCameraFlow);
  DOM.btnLevelReset.addEventListener('click', ()=>{ STATE.smoothNx=0; STATE.smoothNy=0; });
  DOM.btnPermission.addEventListener('click', requestSensorPermission);
  DOM.btnGallery.addEventListener('click', ()=>{ DOM.fileGallery.click(); });
  DOM.fileGallery.addEventListener('change', (e)=>{ const f=e.target.files[0]; if(f){ STATE.lastBlob=f; DOM.photo.src=URL.createObjectURL(f); showPhotoUI(); } });
  
  DOM.btnSend.addEventListener('click', ()=>{
     if(!STATE.lastBlob) return;
     closeCameraOverlay();
     handleCameraResult(STATE.lastBlob, DOM.comment.value.trim());
     DOM.comment.value = ''; DOM.photo.src = '';
  });

  // –ü–†–ê–í–ö–ê 4: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (—Å–∫—Ä—ã–≤–∞–µ–º –ª–∏—à–Ω–µ–µ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ)
  DOM.comment.addEventListener('focus', () => { document.body.classList.add('keyboard-active'); });
  DOM.comment.addEventListener('blur', () => { document.body.classList.remove('keyboard-active'); });
  // –ó–∞–∫—Ä—ã—Ç—å –∫–ª–∞–≤—É –ø–æ Enter
  DOM.comment.addEventListener('keydown', (e) => { if(e.key === 'Enter'){ e.preventDefault(); DOM.comment.blur(); } });
  // –ó–∞–∫—Ä—ã—Ç—å –∫–ª–∞–≤—É –ø–æ —Ç–∞–ø—É –≤ –ø—É—Å—Ç–æ—Ç—É (cam-wrap)
  DOM.camWrap.addEventListener('click', () => { DOM.comment.blur(); });

  window.addEventListener('resize', computeLevelRadius);
</script>
</body>
</html>
