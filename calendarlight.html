<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Ultima Client</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  /* === CORE STYLES === */
  :root {
    --bg-core: #050505; 
    --bg-panel: #1C1C1E; 
    --text-main: #ffffff;
    --text-muted: #8E8E93;
    
    --line-color: rgba(255, 255, 255, 0.08);
    --time-col-width: 55px;
    --day-col-width: 65px; 
    
    /* –¶–í–ï–¢–ê –°–¢–ê–¢–£–°–û–í */
    --acc-blue: #0a84ff; /* –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ */
    --acc-red: #ff453a; /* –û—Ç–º–µ–Ω–∞ */
    --acc-green: #30d158; /* –ó–∞–≤–µ—Ä—à–µ–Ω–æ */
    --acc-current: #3c9cfd;
    
    --grid-h: 60px;
    --safe-top: env(safe-area-inset-top);
    --safe-bottom: env(safe-area-inset-bottom);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
  *::-webkit-scrollbar { display: none; }

  body {
    background-color: var(--bg-core);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', Roboto, sans-serif;
    color: var(--text-main);
    height: 100%; width: 100%;
    overflow: hidden; position: fixed; inset: 0; user-select: none;
  }

  /* === FX LAYER === */
  .fx-layer { position: absolute; inset: 0; z-index: 0; pointer-events: none; }
  .orb { position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.4; }
  .orb-1 { width: 300px; height: 300px; background: #5e60ce; top: -50px; left: -100px; }
  .orb-2 { width: 250px; height: 250px; background: var(--acc-blue); bottom: -50px; right: -50px; }
  .noise { position: fixed; inset: 0; opacity: 0.04; background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); }

  /* === LAYOUT === */
  .app-container { display: flex; flex-direction: column; height: 100%; width: 100%; position: relative; z-index: 1; }

  /* === TOP HEADER === */
  .top-area {
    position: relative;
    background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--line-color); padding-top: calc(10px + var(--safe-top)); padding-bottom: 10px;
    z-index: 60; flex-shrink: 0;
  }
  .header-row { display: flex; justify-content: space-between; align-items: center; padding: 0 16px; margin-bottom: 2px; }
  .month-label { font-family: 'SF Pro Display', sans-serif; font-size: 16px; font-weight: 700; color: #fff; text-transform: uppercase; letter-spacing: 1px; }
  
  /* Buttons in Header */
  .icon-btn { width: 32px; height: 32px; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s opacity; }
  .icon-btn:active { opacity: 0.6; }
  .icon-btn img { width: 24px; height: 24px; display: block; pointer-events: none; }

  /* === MATRIX === */
  .matrix-viewport {
    flex: 1; overflow: auto; position: relative; -webkit-overflow-scrolling: touch; overscroll-behavior: none;
    display: flex; flex-direction: column; z-index: 10;
  }
  .matrix-header-row {
    display: flex; position: sticky; top: 0; z-index: 40; width: max-content; background: rgba(0, 0, 0, 0.25);
    backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-bottom: 1px solid var(--line-color);
  }
  .corner-cell { width: var(--time-col-width); flex-shrink: 0; position: sticky; left: 0; z-index: 50; background: inherit; border-right: 1px solid var(--line-color); }
  .days-header-track { display: flex; flex: 1; }
  
  .day-col-header {
    width: var(--day-col-width); flex-shrink: 0; text-align: center; height: 50px; 
    padding-top: 8px;
    font-size: 11px; color: var(--text-muted); border-right: 1px solid var(--line-color);
    display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
    gap: 2px;
  }
  .dch-day { font-weight: 600; text-transform: uppercase; line-height: 1; }
  .dch-num { font-size: 16px; font-weight: 500; color: #fff; line-height: 1; }
  
  .day-col-header.today { background: rgba(10, 132, 255, 0.15); border-bottom: 2px solid var(--acc-blue); }
  .day-col-header.today .dch-day { color: var(--acc-blue); }
  .day-col-header.today .dch-num { color: #fff; font-weight: 700; }

  .matrix-body { display: flex; width: max-content; position: relative; }
  
  .time-column {
    width: var(--time-col-width); flex-shrink: 0; position: sticky; left: 0; z-index: 30;
    background: rgba(0, 0, 0, 0.25); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
    border-right: 1px solid var(--line-color); padding-bottom: 20px;
  }
  .time-label { height: var(--grid-h); position: relative; } 
  .time-label span { position: absolute; top: -7px; right: 6px; font-size: 11px; font-weight: 500; color: var(--text-muted); font-variant-numeric: tabular-nums; }
  
  .time-line-badge {
    position: absolute; right: 4px; background: var(--acc-current); color: #fff; font-size: 11px; font-weight: 700;
    padding: 2px 6px; border-radius: 4px; z-index: 31; transform: translateY(-50%); pointer-events: none;
    font-variant-numeric: tabular-nums; text-align: center; min-width: 40px; display: none;
  }

  .grid-columns-container { display: flex; flex: 1; position: relative; }
  
  .day-column {
    width: var(--day-col-width); flex-shrink: 0; border-right: 1px solid var(--line-color); position: relative;
    background-image: linear-gradient(to bottom, var(--line-color) 1px, transparent 1px); background-size: 100% var(--grid-h);
    padding-bottom: 20px;
  }
  .day-column.today { background-color: rgba(10, 132, 255, 0.02); }
  
  /* –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏ —Å–µ—Ä—ã–µ –∑–æ–Ω—ã */
  .blocked-slot { position: absolute; left: 0; right: 0; height: var(--grid-h); background: repeating-linear-gradient(45deg, rgba(255,255,255,0.03), rgba(255,255,255,0.03) 10px, rgba(255,255,255,0.06) 10px, rgba(255,255,255,0.06) 20px); pointer-events: none; z-index: 1; }
  .blocked-range-part { position: absolute; left: 0; right: 0; background-color: var(--bg-core); background-image: repeating-linear-gradient(45deg, rgba(60, 156, 253, 0.1), rgba(60, 156, 253, 0.1) 10px, rgba(60, 156, 253, 0.2) 10px, rgba(60, 156, 253, 0.2) 20px); border-top: 1px solid rgba(60, 156, 253, 0.4); border-bottom: 1px solid rgba(60, 156, 253, 0.4); z-index: 2; pointer-events: none; }
  .day-off-overlay { position: absolute; inset: 0; background-color: var(--bg-core); background-image: repeating-linear-gradient(45deg, rgba(60, 156, 253, 0.1), rgba(60, 156, 253, 0.1) 10px, rgba(60, 156, 253, 0.2) 10px, rgba(60, 156, 253, 0.2) 20px); z-index: 8; pointer-events: none; }
  
  /* –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è */
  .global-time-line { position: absolute; left: 0; width: 100%; height: 1px; background: var(--acc-current); z-index: 10; pointer-events: none; display: none; }
  .global-time-line::before { content: ''; position: absolute; left: -4px; top: -3px; width: 7px; height: 7px; background: var(--acc-current); border-radius: 50%; }
  
  /* === EVENT CARD (DYNAMIC COLOR) === */
  .event-card { 
    position: absolute; left: 2px; right: 2px; 
    border-radius: 6px; padding: 2px 4px; overflow: hidden; 
    border-left: 3px solid; cursor: pointer; z-index: 15; 
    border: 1px solid rgba(255,255,255,0.1);
    transition: transform 0.1s, opacity 0.3s;
  }
  .event-card:active { transform: scale(0.96); }
  
  .ev-title { font-size: 10px; font-weight: 700; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.1; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
  .ev-time { font-size: 8.5px; color: rgba(255,255,255,0.95); margin-top: 1px; font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }

  .event-card.status-completed {
      box-shadow: 0 2px 12px rgba(0,0,0,0.5); 
      z-index: 16;
  }
  
  .card-icon { position: absolute; bottom: 2px; width: 11px; height: 11px; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.6)); }
  .ev-recurring-icon { right: 16px; opacity: 0.8; }
  .ev-status-icon { right: 3px; color: #fff; opacity: 1; }

  .event-card.mini { display: flex; align-items: center; justify-content: center; padding: 0; }
  .event-card.mini .ev-title, .event-card.mini .ev-time, .event-card.mini .ev-recurring-icon { display: none; }
  .event-card.mini .ev-status-icon { position: static; width: 14px; height: 14px; }

  /* === OVERLAYS & SHEETS === */
  .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(4px); }
  .sheet-overlay.active { opacity: 1; pointer-events: auto; }
  
  .sheet { 
    position: fixed; bottom: 0; left: 0; right: 0; 
    background: rgba(28, 28, 30, 0.95); 
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.08); border-bottom: none;
    border-radius: 24px 24px 0 0; 
    box-shadow: 0 -4px 24px -1px rgba(0, 0, 0, 0.2);
    padding: 24px 16px calc(24px + var(--safe-bottom)) 16px; 
    transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); 
    z-index: 101; 
  }
  .sheet.open { transform: translateY(0); }

  .sh-title { font-size: 18px; font-weight: 700; color: #fff; margin-bottom: 4px; }
  .sh-sub { font-size: 14px; color: var(--acc-blue); margin-bottom: 20px; font-weight: 500; }
  .sh-close { color: var(--acc-blue); font-size: 16px; font-weight: 500; cursor: pointer; float: right; margin-top: -30px; }
  
  .info-row { display: flex; justify-content: space-between; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); }
  .ir-label { color: #8E8E93; font-size: 13px; text-transform: uppercase; }
  .ir-val { color: #fff; font-size: 16px; font-weight: 500; }

  .btn-close {
    width: 100%; padding: 14px; background: rgba(255,255,255,0.1); 
    color: #fff; border-radius: 12px; border: none; font-size: 16px; font-weight: 600; cursor: pointer;
    margin-top: 10px;
  }

  /* === ANALYTICS STYLES (ORIGINAL DESIGN) === */
  .period-switch {
    display: flex; background: rgba(118, 118, 128, 0.24); 
    border-radius: 9px; padding: 2px; margin-bottom: 20px;
  }
  .p-btn {
    flex: 1; text-align: center; padding: 6px 0; font-size: 13px; font-weight: 500; 
    color: #fff; border-radius: 7px; transition: 0.2s; cursor: pointer;
  }
  .p-btn.active { background: #636366; color: #fff; box-shadow: 0 3px 8px rgba(0,0,0,0.2); font-weight: 600; }
  
  .custom-dates-row {
    display: flex; gap: 10px; margin-bottom: 20px; display: none;
    animation: fadeIn 0.3s ease;
  }
  .input-box { width: 100%; background: rgba(118, 118, 128, 0.24); border: none; border-radius: 10px; padding: 12px; color: #fff; font-size: 16px; }
  
  .analytics-overview {
    display: flex; align-items: center; justify-content: space-between;
    background: linear-gradient(165deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.03) 100%);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 20px; padding: 20px; margin-bottom: 24px;
    box-shadow: 0 12px 32px rgba(0,0,0,0.3);
  }
  .ao-info { display: flex; flex-direction: column; gap: 4px; }
  .ao-label { font-size: 13px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .ao-val { font-size: 32px; font-weight: 800; color: #fff; line-height: 1; }
  .ao-sub { font-size: 13px; color: var(--text-muted); font-weight: 500; margin-top: 4px; }
  
  .ao-chart { width: 80px; height: 80px; position: relative; display: flex; align-items: center; justify-content: center; }
  .donut-svg { width: 100%; height: 100%; transform: rotate(-90deg); }
  .d-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 8; }
  .d-val { 
      fill: none; stroke: var(--acc-blue); stroke-width: 8; stroke-linecap: round; 
      stroke-dasharray: 220; stroke-dashoffset: 220; 
      transition: stroke-dashoffset 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  .stats-list-header { font-size: 17px; font-weight: 600; margin-bottom: 12px; color: #fff; letter-spacing: -0.4px; }
  
  .client-stat-card {
    background: rgba(255, 255, 255, 0.05); 
    border-radius: 12px; padding: 12px 16px; margin-bottom: 8px;
    border: 1px solid rgba(255,255,255,0.05);
    border-left: 4px solid transparent; 
  }
  .csc-row-top { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 15px; font-weight: 500; }
  .csc-name { color: #fff; }
  .csc-nums { color: var(--text-muted); font-variant-numeric: tabular-nums; font-size: 13px; }
  .csc-nums span { color: #fff; font-weight: 600; font-size: 15px; }

  .progress-track { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
  .progress-fill { height: 100%; width: 0%; transition: width 1s ease 0.2s; border-radius: 3px; background: var(--acc-blue) !important; }
  .empty-state { text-align: center; color: var(--text-muted); padding: 30px; font-size: 14px; }

  /* TOAST */
  .toast-notification {
    position: fixed; top: calc(20px + var(--safe-top)); left: 16px; right: 16px;
    background: rgba(28, 28, 30, 0.8); backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 24px;
    color: #fff; padding: 16px; z-index: 9999; 
    font-size: 14px; font-weight: 500; text-align: center;
    transform: translateY(-150%); transition: transform 0.4s;
    pointer-events: none; opacity: 0;
  }
  .toast-notification.show { transform: translateY(0); opacity: 1; }
  
  .btn-cancel {
      width: 100%; padding: 14px; 
      background: rgba(255, 69, 58, 0.15); /* –ö—Ä–∞—Å–Ω—ã–π —Ñ–æ–Ω –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π */
      color: var(--acc-red); 
      border-radius: 12px; border: none; 
      font-size: 16px; font-weight: 600; cursor: pointer;
      transition: 0.2s;
    }
    .btn-cancel:active { transform: scale(0.98); opacity: 0.8; }

  /* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞ –≤ –¥–µ—Ç–∞–ª—è—Ö (—Å–∏–Ω—è—è) */
  .btn-reschedule {
    width: 100%; padding: 14px; 
    background: var(--acc-blue); color: #fff; 
    border-radius: 12px; border: none; 
    font-size: 16px; font-weight: 600; cursor: pointer;
    margin-bottom: 8px; /* –û—Ç—Å—Ç—É–ø –æ—Ç –∫–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã */
  }
  .btn-reschedule:active { transform: scale(0.98); opacity: 0.9; }

  /* === CUSTOM CONFIRM POPUP === */
  .confirm-overlay {
    position: fixed; inset: 0; z-index: 9999;
    background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none; transition: opacity 0.2s ease;
  }
  .confirm-overlay.visible { opacity: 1; pointer-events: auto; }
  
  .confirm-box {
    width: 270px; background: rgba(30, 30, 32, 0.85);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-radius: 14px; overflow: hidden; text-align: center;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    transform: scale(1.1); transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
  }
  .confirm-overlay.visible .confirm-box { transform: scale(1); }

  .cb-title { padding: 18px 16px 4px 16px; color: #fff; font-size: 17px; font-weight: 600; }
  .cb-text { padding: 4px 16px 18px 16px; color: var(--text-muted); font-size: 13px; line-height: 1.4; }
  
  .cb-buttons { display: flex; border-top: 1px solid rgba(255,255,255,0.12); }
  .cb-btn {
    flex: 1; padding: 12px; background: transparent; border: none;
    font-size: 17px; cursor: pointer; height: 44px;
    border-right: 1px solid rgba(255,255,255,0.12);
    color: #0a84ff; /* –°–∏–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
  }
  .cb-btn:last-child { border-right: none; }
  .cb-btn:active { background: rgba(255,255,255,0.1); }
  
  /* –ö–Ω–æ–ø–∫–∞ "–î–∞" –±—É–¥–µ—Ç –∫—Ä–∞—Å–Ω–æ–π, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ —É–¥–∞–ª–µ–Ω–∏–µ */
  .cb-btn.destructive { color: #ff453a; font-weight: 600; }
  .cb-btn.cancel { font-weight: 400; color: #0a84ff; }
  
  /* === RESCHEDULE UI === */
  .rs-dates-scroller {
    display: flex; gap: 8px; overflow-x: auto; padding: 4px 0 16px 0;
    margin-bottom: 10px; scroll-behavior: smooth;
    -ms-overflow-style: none; scrollbar-width: none;
  }
  .rs-dates-scroller::-webkit-scrollbar { display: none; }

  .rs-date-chip {
    flex-shrink: 0; width: 60px; height: 64px;
    background: rgba(118, 118, 128, 0.24); border-radius: 10px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    color: var(--text-muted); cursor: pointer; transition: 0.2s;
    border: 1px solid transparent;
  }
  .rs-date-chip.active {
    background: #fff; color: #000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }
  .rs-date-chip.disabled { opacity: 0.3; pointer-events: none; }
  
  .rs-day-name { font-size: 11px; font-weight: 600; text-transform: uppercase; margin-bottom: 2px; }
  .rs-day-num { font-size: 20px; font-weight: 600; line-height: 1; }

  .rs-slots-grid {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
    max-height: 250px; overflow-y: auto; padding-bottom: 20px;
    min-height: 100px;
  }
  
  .rs-time-btn {
    background: rgba(10, 132, 255, 0.15); color: var(--acc-blue);
    border: 1px solid rgba(10, 132, 255, 0.3);
    border-radius: 8px; padding: 12px 0; font-size: 15px; font-weight: 600;
    cursor: pointer; transition: 0.2s;
  }
  .rs-time-btn:active { transform: scale(0.96); opacity: 0.8; }
  
  .rs-loader {
    grid-column: 1 / -1; display: flex; align-items: center; justify-content: center;
    height: 100px; color: var(--text-muted); font-size: 14px;
  }
  .rs-empty { grid-column: 1 / -1; text-align: center; color: var(--text-muted); padding: 20px; }
  
</style>
</head>
<body oncontextmenu="return false;">

<div class="fx-layer"><div class="orb orb-1"></div><div class="orb orb-2"></div><div class="noise"></div></div>

<div class="toast-notification" id="toast">–û–±–Ω–æ–≤–ª–µ–Ω–æ</div>
  <div class="confirm-overlay" id="customConfirm">
  <div class="confirm-box">
    <div class="cb-title">–û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏</div>
    <div class="cb-text">–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?</div>
    <div class="cb-buttons">
      <button class="cb-btn cancel" onclick="resolveCustomConfirm(false)">–û—Ç–º–µ–Ω–∞</button>
      <button class="cb-btn destructive" onclick="resolveCustomConfirm(true)">–î–∞</button>
    </div>
  </div>
</div>
  

<div class="app-container">
  <div class="top-area">
    <div class="header-row">
      <div class="month-label" id="headerMonth">–ó–ê–ì–†–£–ó–ö–ê...</div>
      <div class="week-controls">
        <div class="icon-btn" onclick="openAnalytics()">
          <img src="https://raw.githubusercontent.com/groskaiser-design/icons/main/analytics.svg" alt="Analytics">
        </div>
      </div>
    </div>
  </div>

  <div class="matrix-viewport" id="matrixViewport">
    <div class="matrix-header-row">
      <div class="corner-cell"></div>
      <div class="days-header-track" id="daysHeaderTrack"></div>
    </div>
    <div class="matrix-body">
      <div class="time-column" id="timeColumn">
          <div class="time-line-badge" id="timeLineBadge">00:00</div>
      </div>
      <div class="grid-columns-container" id="gridColumns"><div class="global-time-line" id="globalTimeLine"></div></div>
    </div>
  </div>
</div>

<div class="sheet-overlay" id="overlay" onclick="closeAllSheets()"></div>

<div class="sheet" id="detailsSheet">
  <div class="sh-title">–î–µ—Ç–∞–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</div>
  <div class="sh-sub" id="detDate"></div>
  <div class="info-row">
    <div class="ir-label">–í—Ä–µ–º—è</div>
    <div class="ir-val" id="detTime"></div>
  </div>
  <div class="info-row">
    <div class="ir-label">–ó–∞–º–µ—Ç–∫–∞</div>
    <div class="ir-val" id="detNote"></div>
  </div>
  <div class="info-row" style="border:none">
    <div class="ir-label">–°—Ç–∞—Ç—É—Å</div>
    <div class="ir-val" id="detStatus"></div>
  </div>
  <div id="cancelContainer" style="margin-top: 24px; display: none;">
      <button class="btn-reschedule" onclick="startRescheduleFlow()">
          –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∑–∞–ø–∏—Å—å
      </button>

      <button class="btn-cancel" onclick="tryCancelCurrentSession()">
          –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å
      </button>
      <div id="cancelHint" style="font-size:12px; color:#8E8E93; text-align:center; margin-top:8px;">
          –û—Ç–º–µ–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–ø–æ–∑–¥–Ω–æ)
      </div>
  </div>
  <button class="btn-close" onclick="closeAllSheets()">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>

<div class="sheet" id="analyticsSheet">
  <div class="sheet-header">
    <div class="sh-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
    <div class="sh-close" onclick="closeAllSheets()">–ó–∞–∫—Ä—ã—Ç—å</div>
  </div>
  
  <div class="period-switch">
    <div class="p-btn active" onclick="setAnalyticsPeriod('week', this)">–ù–µ–¥–µ–ª—è</div>
    <div class="p-btn" onclick="setAnalyticsPeriod('month', this)">–ú–µ—Å—è—Ü</div>
    <div class="p-btn" onclick="setAnalyticsPeriod('custom', this)">–ü–µ—Ä–∏–æ–¥</div>
  </div>

  <div class="custom-dates-row" id="anCustomDates">
    <input type="date" class="input-box" id="anStart" onchange="refreshAnalytics()">
    <input type="date" class="input-box" id="anEnd" onchange="refreshAnalytics()">
  </div>

  <div class="analytics-overview">
    <div class="ao-info">
      <div class="ao-label">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
      <div class="ao-val" id="anPercent">0%</div>
      <div class="ao-sub" id="anTotalStats">0 –∏–∑ 0 –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
    </div>
    <div class="ao-chart">
      <svg class="donut-svg" viewBox="0 0 80 80">
        <circle class="d-bg" cx="40" cy="40" r="35"/>
        <circle class="d-val" id="anDonutCircle" cx="40" cy="40" r="35"/>
      </svg>
      <div class="d-icon"></div>
    </div>
  </div>

  <div class="stats-list-header">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Ç—Ä–µ–Ω–µ—Ä–∞–º</div>
  <div id="analyticsList" style="padding-bottom: 20px;"></div>
</div>

<div class="sheet" id="rescheduleSheet">
  <div class="sheet-header">
    <div class="sh-title">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</div>
    <div class="sh-close" onclick="closeAllSheets()">–ó–∞–∫—Ä—ã—Ç—å</div>
  </div>
  <div class="sh-sub" style="margin-bottom: 12px;">–ë–ª–∏–∂–∞–π—à–∏–µ 14 –¥–Ω–µ–π</div>
  
  <div class="rs-dates-scroller" id="rsDatesTrack"></div>
  
  <div class="rs-slots-grid" id="rsSlotsGrid">
    <div class="rs-loader">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ—Ç–æ–≤...</div>
  </div>
</div>

<script>
  // === CONFIG ===
  const APP_VERSION = 'v9.5-CLIENT-ANALYTICS';
  const API_URL = 'https://script.google.com/macros/s/AKfycbxXxlp8PCCZ6dBlc4fyKafLKNDPIv8FQJV663YHp3vp5lcbtvH9CmRsrs9hccEC1weJRQ/exec'; 
  const GRID_H = 60;
  
  const KEY_SESSIONS = 'uc_client_sessions';
  const KEY_SETTINGS = 'uc_client_settings';
  const KEY_CLIENTS = 'uc_client_list'; 

  let startOffset = -30, endOffset = 60; 
  let sessions = [];
  let clients = []; 
  let availabilityPattern = {0:[],1:[],2:[],3:[],4:[],5:[],6:[]}; 
  let specialRanges = []; 
  let dateExceptions = {};
  let updateInterval;
  let isScrolling = false;
  let currentAnPeriod = 'week'; // Analytics state
  let coachProfiles = {}; // –•—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç—Ä–µ–Ω–µ—Ä–æ–≤ { coachId: { cancel_window: 24 } }
  let currentSession = null; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏, –æ—Ç–∫—Ä—ã—Ç–æ–π –≤ —à—Ç–æ—Ä–∫–µ

   /* ============================================================
 * BLOCK 0: TMA boot (FIXED & SAFE)
 * ============================================================ */
(function initTMA() {
  try {
    const tg = window.Telegram?.WebApp;
    if (!tg) return; // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –¢–µ–ª–µ–≥—Ä–∞–º, –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º, –Ω–µ –ª–æ–º–∞—è —Å–∞–π—Ç

    tg.ready();
    tg.expand();

    // 1. –ö—Ä–∞—Å–∏–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–æ–±–µ—Ä–Ω—É—Ç–æ –≤ –∑–∞—â–∏—Ç—É, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫—É)
    try {
      tg.setHeaderColor('#050505'); // –ß–µ—Ä–Ω—ã–π —Ü–≤–µ—Ç
      if (tg.setBackgroundColor) {
        tg.setBackgroundColor('#050505');
      }
    } catch (e) {
      console.log('Error setting color:', e);
    }

    // 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
    try {
      if (tg.BackButton) {
        tg.BackButton.show();
        // –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –Ω–µ —Ç—É–ø–∏–ª–∞
        tg.BackButton.offClick(); 
        // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ—Ö–æ–¥
        tg.BackButton.onClick(function() {
          window.location.href = 'router.html';
        });
      }
    } catch (e) {
      console.log('Error setting back button:', e);
    }

    // 3. –û—Ç–∫–ª—é—á–∞–µ–º —Å–≤–∞–π–ø—ã (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
    try {
      if (tg.disableVerticalSwipes) tg.disableVerticalSwipes();
    } catch (e) {}

  } catch (globalErr) {
    // –ï—Å–ª–∏ –≤–æ–æ–±—â–µ –≤—Å–µ —É–ø–∞–ª–æ –≤ TMA, –≤—ã–≤–æ–¥–∏–º –æ—à–∏–±–∫—É, –Ω–æ –ù–ï –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫—Ä–∏–ø—Ç
    console.error('Critical TMA Error:', globalErr);
  }
})();
  
/**
 * –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
 * @returns {boolean} true, –µ—Å–ª–∏ Telegram user.id —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
 */
function isAdmin() {
  try {
    const userId = Number(window.Telegram?.WebApp?.initDataUnsafe?.user?.id);
    return userId === 196047220;
  } catch (_) {
    return false;
  }
}

  // === DATA LAYER ===
  const DataManager = {
    saveLocally() {
      try {
        localStorage.setItem(KEY_SESSIONS, JSON.stringify(sessions));
        localStorage.setItem(KEY_CLIENTS, JSON.stringify(clients));
        localStorage.setItem(KEY_SETTINGS, JSON.stringify({ pattern: availabilityPattern, ranges: specialRanges, exceptions: dateExceptions }));
      } catch(e) {}
    },

    loadLocal() {
      try {
        const s = localStorage.getItem(KEY_SESSIONS); if(s) sessions = JSON.parse(s);
        const c = localStorage.getItem(KEY_CLIENTS); if(c) clients = JSON.parse(c);
        const set = localStorage.getItem(KEY_SETTINGS);
        if(set) {
            const parsed = JSON.parse(set);
            if(parsed.pattern) availabilityPattern = parsed.pattern;
            if(parsed.ranges) specialRanges = parsed.ranges;
            if(parsed.exceptions) dateExceptions = parsed.exceptions;
        }
      } catch(e) {}
    },

    async syncLoad() {
      const d = new Date();
      const m1 = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      const nextM = new Date(d); nextM.setMonth(d.getMonth() + 1);
      const m2 = `${nextM.getFullYear()}-${String(nextM.getMonth()+1).padStart(2,'0')}`;

      try {
        const tg = window.Telegram?.WebApp;
        const initData = tg?.initData || '';

        const [r1, r2] = await Promise.all([
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'client_load', init_data: initData, month_str: m1 }) }).then(r=>r.json()),
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'client_load', init_data: initData, month_str: m2 }) }).then(r=>r.json())
        ]);

        if(r1.ok) this.applyData(r1.data, m1);
        if(r2.ok) this.applyData(r2.data, m2);
        
        this.saveLocally();
        showToast("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ");
      } catch (e) {
        showToast("–û—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º");
      }
    },

    applyData(data, monthStr) {
      if(!data) return;
      if (data.settings) {
        if(data.settings.pattern) availabilityPattern = data.settings.pattern;
        if(data.settings.ranges) specialRanges = data.settings.ranges;
        if(data.settings.exceptions) dateExceptions = data.settings.exceptions;
      }
      if (data.clients && Array.isArray(data.clients)) clients = data.clients;

      // 3. Coach Profiles (–ù–û–í–û–ï)
        if (data.coach_profiles) {
            // –ú–µ—Ä–∂–∏–º –Ω–æ–≤—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏
            coachProfiles = { ...coachProfiles, ...data.coach_profiles };
        }
      
      if (data.calendar) {
        sessions = sessions.filter(s => !s.dateStr.startsWith(monthStr));
        Object.keys(data.calendar).forEach(dayKey => {
            const evts = data.calendar[dayKey];
            evts.forEach(evt => {
                sessions.push({
                    id: evt.i,
                    clientId: evt.c, 
                    coachId: evt.cid, // IMPORTANT: Trainer ID from backend
                    dateStr: `${monthStr}-${dayKey.padStart(2, '0')}`,
                    start: evt.s,
                    end: evt.e,
                    note: evt.n || '',
                    status: evt.st || 'planned',
                    seriesId: evt.sid
                });
            });
        });
      }
      reRenderBlocks();
    }
  };

  // === INITIALIZATION ===
  function init() {
    DataManager.loadLocal(); 
    
    renderTimeColumn();
    renderDayRange(startOffset, endOffset);
    scrollToToday();
    startClock();
    reRenderBlocks();
    
    document.getElementById('matrixViewport').addEventListener('scroll', ()=>{ 
        isScrolling=true; 
        onScroll(); 
        handleInfiniteScroll(); 
    }, {passive: true});
    
    DataManager.syncLoad();
  }

  // === RENDER ENGINE ===
  function renderTimeColumn() { 
      const col=document.getElementById('timeColumn'); 
      const badge=document.getElementById('timeLineBadge');
      col.innerHTML=''; 
      col.appendChild(badge); 
      for(let i=0; i<24; i++) { 
          const el=document.createElement('div'); el.className='time-label'; 
          if (i > 0) el.innerHTML=`<span>${String(i).padStart(2,'0')}:00</span>`; 
          col.appendChild(el); 
      } 
  }
  
  function renderDayRange(from, to) {
    const track=document.getElementById('daysHeaderTrack'), grid=document.getElementById('gridColumns');
    const weekDays=['–ü–ù','–í–¢','–°–†','–ß–¢','–ü–¢','–°–ë','–í–°']; const base=new Date(); base.setHours(0,0,0,0);
    const todayStr = getLocalDateStr(new Date());
    
    for(let i=from; i<=to; i++) {
      const d=new Date(base); d.setDate(d.getDate()+i); const dateStr=getLocalDateStr(d);
      let dayIdx=d.getDay()-1; if(dayIdx===-1) dayIdx=6;
      const isToday = dateStr === todayStr;
      
      const h=document.createElement('div'); h.className=`day-col-header ${isToday ? 'today' : ''}`; h.setAttribute('data-date', dateStr);
      h.innerHTML=`<div class="dch-day">${weekDays[dayIdx]}</div><div class="dch-num">${d.getDate()}</div>`;
      track.appendChild(h);
      
      const c=document.createElement('div'); c.className=`day-column ${isToday ? 'today' : ''}`; c.setAttribute('data-date', dateStr); c.setAttribute('data-day-idx', dayIdx);
      grid.appendChild(c);
    }
  }

  function reRenderBlocks() {
      document.querySelectorAll('.day-column').forEach(col => {
        col.querySelectorAll('.blocked-slot, .day-off-overlay, .blocked-range-part, .event-card').forEach(e => e.remove());
        
        const dateStr = col.getAttribute('data-date');
        const dayIdx = parseInt(col.getAttribute('data-day-idx'));
        const colLeft = Math.round(col.offsetLeft); 

        // Gray Zones
        (availabilityPattern[dayIdx] || []).forEach(h => {
          const b = document.createElement('div'); b.className = 'blocked-slot stripe-bg';
          b.style.top = `${h * GRID_H}px`; b.style.backgroundPosition = `-${colLeft}px -${h * GRID_H}px`; col.appendChild(b);
        });
        
        // Ranges
        if (specialRanges.length > 0) {
            const cS = new Date(dateStr + 'T00:00:00').getTime();
            const cE = new Date(dateStr + 'T23:59:59').getTime();
            specialRanges.forEach(r => {
                const rS = new Date(r.start).getTime(); const rE = new Date(r.end).getTime();
                const oS = Math.max(cS, rS); const oE = Math.min(cE, rE);
                if (oS < oE) {
                    const top = (oS - cS) / 3600000 * GRID_H;
                    const h = (oE - oS) / 3600000 * GRID_H;
                    const p = document.createElement('div');
                    if (h >= 23.5 * GRID_H) {
                        p.className = 'day-off-overlay stripe-bg'; 
                        p.style.backgroundPosition = `-${colLeft}px 0px`;
                    } else { 
                        p.className = 'blocked-range-part stripe-bg'; 
                        p.style.top = `${top}px`; p.style.height = `${h}px`; 
                        p.style.backgroundPosition = `-${colLeft}px -${top}px`;
                    }
                    col.appendChild(p);
                }
            });
        }

        // Sessions
        renderEventsForColumn(col, dateStr);
      });
  }

  function renderEventsForColumn(col, dateStr) {
      const dayEvents = sessions.filter(s => s.dateStr === dateStr);
      const items = dayEvents.map(s => {
          const [h, m] = s.start.split(':').map(Number);
          const [hE, mE] = s.end.split(':').map(Number);
          return { data: s, start: h * 60 + m, end: hE * 60 + mE, colIndex: 0 };
      });

      items.sort((a, b) => (a.start - b.start) || ((b.end - b.start) - (a.end - a.start)));
      const columns = [];
      items.forEach(item => {
          let placed = false;
          for (let i = 0; i < columns.length; i++) {
              const colItems = columns[i];
              if (item.start >= colItems[colItems.length - 1].end) {
                  colItems.push(item); item.colIndex = i; placed = true; break;
              }
          }
          if (!placed) { columns.push([item]); item.colIndex = columns.length - 1; }
      });

      items.forEach(item => {
          let maxCol = 0;
          items.forEach(other => { if (Math.max(item.start, other.start) < Math.min(item.end, other.end) && other.colIndex > maxCol) maxCol = other.colIndex; });
          
          const totalCols = maxCol + 1;
          const widthPercent = 100 / totalCols;
          const leftPercent = item.colIndex * widthPercent;

          const el = document.createElement('div');
          const s = item.data;
          
          // === COLOR LOGIC ===
          // Use Client Base Color + Opacity
          let baseColor = '#0a84ff'; 
          if (clients && clients.length > 0) {
              const cli = clients.find(c => String(c.id) === String(s.clientId));
              if (cli && cli.color) baseColor = cli.color;
          }

          const isCompleted = s.status === 'completed';
          const opacity = isCompleted ? 1.0 : 0.45; 
          
          el.className = 'event-card' + (isCompleted ? ' status-completed' : '');
          el.style.backgroundColor = hexToRgba(baseColor, opacity);
          el.style.borderLeftColor = baseColor; 
          
          const top = item.start / 60 * GRID_H;
          const height = (item.end - item.start) / 60 * GRID_H;
          
          el.style.top = `${top}px`;
          el.style.height = `${Math.max(height, 20)}px`;
          el.style.width = `calc(${widthPercent}% - 4px)`;
          el.style.left = `calc(${leftPercent}% + 2px)`;
          el.style.zIndex = 10 + item.colIndex;

          if (widthPercent < 85) el.classList.add('mini');

          let icons = '';
          if(s.seriesId) icons += `<svg class="card-icon ev-recurring-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>`;
          if(isCompleted) icons += `<svg class="card-icon ev-status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>`;

          el.innerHTML = `
             <div class="ev-title">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</div>
             <div class="ev-time">${s.start} - ${s.end}</div>
             ${icons}
          `;
          
          el.onclick = (e) => { e.stopPropagation(); openDetails(s); };
          col.appendChild(el);
      });
  }

  // === ANALYTICS LOGIC ===
  function openAnalytics() {
      const weekBtn = document.querySelector('.period-switch .p-btn'); 
      setAnalyticsPeriod('week', weekBtn); 
      openSheet('analyticsSheet');
  }

  function setAnalyticsPeriod(period, btnEl) {
      currentAnPeriod = period;
      
      document.querySelectorAll('.period-switch .p-btn').forEach(b => b.classList.remove('active'));
      if(btnEl) btnEl.classList.add('active');

      const customRow = document.getElementById('anCustomDates');
      customRow.style.display = (period === 'custom') ? 'flex' : 'none';

      const now = new Date();
      let start = new Date();
      let end = new Date();

      if (period === 'week') {
          start = getStartOfWeek(now);
          end = new Date(start);
          end.setDate(end.getDate() + 6);
      } else if (period === 'month') {
          start = new Date(now.getFullYear(), now.getMonth(), 1);
          end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      } else {
          if (!document.getElementById('anStart').value) {
              document.getElementById('anStart').value = getLocalDateStr(now);
              document.getElementById('anEnd').value = getLocalDateStr(now);
          }
          refreshAnalytics(); 
          return;
      }

      document.getElementById('anStart').value = getLocalDateStr(start);
      document.getElementById('anEnd').value = getLocalDateStr(end);
      
      refreshAnalytics();
  }

  function refreshAnalytics() {
      const sStr = document.getElementById('anStart').value;
      const eStr = document.getElementById('anEnd').value;
      if (!sStr || !eStr) return;

      const rangeSessions = sessions.filter(s => s.dateStr >= sStr && s.dateStr <= eStr && s.status !== 'cancelled');

      const total = rangeSessions.length;
      const completed = rangeSessions.filter(s => s.status === 'completed').length;
      const percent = total > 0 ? Math.round((completed / total) * 100) : 0;

      document.getElementById('anPercent').textContent = `${percent}%`;
      document.getElementById('anTotalStats').textContent = `${completed} –∏–∑ ${total} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ`;
      
      const circle = document.getElementById('anDonutCircle');
      const circumference = 2 * Math.PI * 35; 
      const offset = circumference - (percent / 100) * circumference;
      circle.style.strokeDashoffset = offset;
      
      // Group by Coach ID
      const trainerStats = {};
      rangeSessions.forEach(s => {
          const tid = s.coachId || 'Unknown';
          if (!trainerStats[tid]) {
              // Generate a consistent color for trainer ID hash
              const colorHash = '#' + (tid.toString().substr(0,6)); 
              trainerStats[tid] = { total: 0, done: 0, color: colorHash };
          }
          trainerStats[tid].total++;
          if (s.status === 'completed') trainerStats[tid].done++;
      });

      const list = document.getElementById('analyticsList');
      list.innerHTML = '';
      
      const sortedTrainers = Object.entries(trainerStats).sort((a, b) => b[1].total - a[1].total);

      if (sortedTrainers.length === 0) {
          list.innerHTML = `<div class="empty-state">–ù–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥</div>`;
          return;
      }

      sortedTrainers.forEach(([tid, stat]) => {
          const cPercent = Math.round((stat.done / stat.total) * 100);
          const el = document.createElement('div');
          el.className = 'client-stat-card';
          el.style.borderLeftColor = stat.color; 
          
          el.innerHTML = `
            <div class="csc-row-top">
               <div class="csc-name">–¢—Ä–µ–Ω–µ—Ä #${tid.substr(0,5)}</div>
               <div class="csc-nums"><span>${stat.done}</span> / ${stat.total}</div>
            </div>
            <div class="progress-track">
               <div class="progress-fill" style="width: ${cPercent}%"></div>
            </div>
          `;
          list.appendChild(el);
      });
  }

  // === COMMON HELPERS ===
function openDetails(s) {
  currentSession = s; // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é

  const d = new Date(s.dateStr);
  const datePretty = d.toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' });

  document.getElementById('detDate').textContent = datePretty.charAt(0).toUpperCase() + datePretty.slice(1);
  document.getElementById('detTime').textContent = `${s.start} - ${s.end}`;
  document.getElementById('detNote').textContent = s.note || '–ë–µ–∑ –∑–∞–º–µ—Ç–æ–∫';

  const statEl = document.getElementById('detStatus');
  const cancelContainer = document.getElementById('cancelContainer');
  const cancelBtn = cancelContainer.querySelector('.btn-cancel');
  const reschedBtn = cancelContainer.querySelector('.btn-reschedule'); // NEW
  const cancelHint = document.getElementById('cancelHint');

  // 1. –°—Ç–∞—Ç—É—Å –∏ —Ü–≤–µ—Ç
  if (s.status === 'completed') {
      statEl.textContent = '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∞'; statEl.style.color = 'var(--acc-green)';
      cancelContainer.style.display = 'none'; // –ù–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—É—é
  } else {
      statEl.textContent = 'üìÖ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞'; statEl.style.color = 'var(--acc-blue)';
      cancelContainer.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ –æ—Ç–º–µ–Ω—ã

      // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –í—Ä–µ–º–µ–Ω–∏ (Validation Logic)
      const sessionStart = new Date(`${s.dateStr}T${s.start}`);
      const now = new Date();
      const diffHours = (sessionStart - now) / (1000 * 60 * 60); // –†–∞–∑–Ω–∏—Ü–∞ –≤ —á–∞—Å–∞—Ö

      // –ë–µ—Ä–µ–º –ø—Ä–∞–≤–∏–ª–æ —Ç—Ä–µ–Ω–µ—Ä–∞. –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, —Å—á–∏—Ç–∞–µ–º 24 —á–∞—Å–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      const trainerRule = (coachProfiles[s.coachId] && coachProfiles[s.coachId].cancel_window) 
                          ? parseInt(coachProfiles[s.coachId].cancel_window) 
                          : 24; 

      if (trainerRule === 0 || diffHours >= trainerRule) {
          // –ú–û–ñ–ù–û –û–¢–ú–ï–ù–ò–¢–¨ / –ü–ï–†–ï–ù–ï–°–¢–ò
          cancelBtn.style.display = 'block';
          reschedBtn.style.display = 'block';
          cancelHint.style.display = 'none';
      } else {
          // –ù–ï–õ–¨–ó–Ø –û–¢–ú–ï–ù–ò–¢–¨
          cancelBtn.style.display = 'none';
          reschedBtn.style.display = 'none';
          cancelHint.style.display = 'block';

          // –ö—Ä–∞—Å–∏–≤—ã–π —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
          let ruleText = (trainerRule === 0) ? '–≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è' : `–∑–∞ ${trainerRule} —á.`;
          cancelHint.textContent = `–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤–æ–∑–º–æ–∂–Ω—ã —Ç–æ–ª—å–∫–æ ${ruleText} –¥–æ –Ω–∞—á–∞–ª–∞`;
      }
  }

  document.getElementById('overlay').classList.add('active');
  document.getElementById('detailsSheet').classList.add('open');
}
  

  function closeAllSheets() {
    document.getElementById('overlay').classList.remove('active');
    document.querySelectorAll('.sheet').forEach(s => s.classList.remove('open'));
  }
  function openSheet(id){
      document.getElementById('overlay').classList.add('active');
      document.getElementById(id).classList.add('open');
  }

  function getLocalDateStr(date) { const y = date.getFullYear(); const m = String(date.getMonth() + 1).padStart(2, '0'); const d = String(date.getDate()).padStart(2, '0'); return `${y}-${m}-${d}`; }
  function getStartOfWeek(date) { const d=new Date(date); const day=d.getDay(); const diff=d.getDate()-day+(day===0?-6:1); d.setDate(diff); d.setHours(0,0,0,0); return d; }
  
  function scrollToToday() { 
      const today = getLocalDateStr(new Date()); 
      setTimeout(() => {
          const el = document.querySelector(`.day-col-header[data-date="${today}"]`); 
          if(el) { 
              const vp = document.getElementById('matrixViewport'); 
              const offset = el.offsetLeft - (vp.clientWidth/2) + (el.offsetWidth/2);
              vp.scrollTo({ left: offset, behavior: 'auto' }); 
              vp.scrollTop = 9 * GRID_H; 
          }
      }, 50);
  }
  
  function startClock(){updateClock();if(updateInterval)clearInterval(updateInterval);updateInterval=setInterval(updateClock,60000);}
  function updateClock(){
      const n=new Date();
      const l=document.getElementById('globalTimeLine');
      const b=document.getElementById('timeLineBadge');
      const px=(n.getHours()*60+n.getMinutes())/60*GRID_H;
      l.style.top=`${px}px`; l.style.display='block';
      b.style.top=`${px}px`; b.style.display='block';
      b.textContent=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;
  }
  function onScroll() { const vp=document.getElementById('matrixViewport'), headers=document.querySelectorAll('.day-col-header'); for(let h of headers) if(h.offsetLeft>=vp.scrollLeft) { const d=new Date(h.getAttribute('data-date')); document.getElementById('headerMonth').textContent=`${d.toLocaleString('ru',{month:'long'}).toUpperCase()} ${d.getFullYear()}`; break; } }
  function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2000); }
  function handleInfiniteScroll() { const vp=document.getElementById('matrixViewport'); const sl=vp.scrollLeft, sw=vp.scrollWidth, cw=vp.clientWidth; if(sw-(sl+cw)<300) { const old=endOffset; endOffset+=14; renderDayRange(old+1, endOffset); reRenderBlocks(); } if(sl<300) { const old=startOffset; startOffset-=14; prependDays(startOffset, old-1); vp.scrollLeft+=(14*65); reRenderBlocks(); } }
  function prependDays(from, to) { const track=document.getElementById('daysHeaderTrack'), grid=document.getElementById('gridColumns'); const weekDays=['–ü–ù','–í–¢','–°–†','–ß–¢','–ü–¢','–°–ë','–í–°']; const base=new Date(); base.setHours(0,0,0,0); const todayStr = getLocalDateStr(new Date()); const fragH=document.createDocumentFragment(), fragC=document.createDocumentFragment(); for(let i=from; i<=to; i++) { const d=new Date(base); d.setDate(d.getDate()+i); const dateStr=getLocalDateStr(d); let dayIdx=d.getDay()-1; if(dayIdx===-1) dayIdx=6; const isToday = dateStr === todayStr; const h=document.createElement('div'); h.className=`day-col-header ${isToday ? 'today' : ''}`; h.setAttribute('data-date', dateStr); h.innerHTML=`<div class="dch-day">${weekDays[dayIdx]}</div><div class="dch-num">${d.getDate()}</div>`; fragH.appendChild(h); const c=document.createElement('div'); c.className=`day-column ${isToday ? 'today' : ''}`; c.setAttribute('data-date', dateStr); c.setAttribute('data-day-idx', dayIdx); fragC.appendChild(c); } track.insertBefore(fragH, track.firstChild); grid.insertBefore(fragC, grid.querySelector('.day-column')); }

 function hexToRgba(hex, alpha) { 
      let c;
      if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
          c= hex.substring(1).split('');
          if(c.length== 3){ c= [c[0], c[0], c[1], c[1], c[2], c[2]]; }
          c= '0x'+c.join('');
          return 'rgba('+[(c>>16)&255, (c>>8)&255, c&255].join(',')+','+alpha+')';
      }
      return 'rgba(10, 132, 255, ' + alpha + ')';
  }

  // === CANCEL FUNCTION (MOVED INSIDE SCRIPT) ===
  // === CUSTOM CONFIRM LOGIC ===
  let confirmResolver = null;

  function showCustomConfirm() {
    return new Promise((resolve) => {
      confirmResolver = resolve;
      document.getElementById('customConfirm').classList.add('visible');
    });
  }

  function resolveCustomConfirm(result) {
    document.getElementById('customConfirm').classList.remove('visible');
    if (confirmResolver) confirmResolver(result);
  }

  async function tryCancelCurrentSession() {
      if (!currentSession) return;
      const isConfirmed = await showCustomConfirm();
      if (!isConfirmed) return;

      const s = currentSession;
      closeAllSheets(); 

      sessions = sessions.filter(x => x.id !== s.id);
      reRenderBlocks();
      showToast("–û—Ç–º–µ–Ω–µ–Ω–æ");

      try {
          const tg = window.Telegram?.WebApp;
          const initData = tg?.initData || '';

          const resp = await fetch(API_URL, {
              method: 'POST',
              body: JSON.stringify({
                  action: 'client_cancel',
                  init_data: initData,
                  coachId: s.coachId,
                  dateStr: s.dateStr,
                  sessionId: s.id
              })
          });
          const json = await resp.json();

          if (!json.ok) {
              showToast("–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã");
          } else {
              DataManager.saveLocally();
          }
      } catch (e) {
          console.error(e);
          showToast("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
      }
  }

  // === RESCHEDULE LOGIC (v9.5) ===
  let availableSlotsCache = {}; 
  let selectedRsDate = null;

async function startRescheduleFlow() {
    if (!currentSession) return;
    
    document.getElementById('detailsSheet').classList.remove('open'); 
    document.getElementById('rescheduleSheet').classList.add('open');
    
    const track = document.getElementById('rsDatesTrack');
    const grid = document.getElementById('rsSlotsGrid');
    track.innerHTML = '';
    grid.innerHTML = '<div class="rs-loader">–ü–æ–∏—Å–∫ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –æ–∫–æ—à–µ–∫...</div>';
    
    const [hS, mS] = currentSession.start.split(':').map(Number);
    const [hE, mE] = currentSession.end.split(':').map(Number);
    const durationMinutes = (hE * 60 + mE) - (hS * 60 + mS);

    try {
      const tg = window.Telegram?.WebApp;
      const resp = await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'get_slots',
          coachId: currentSession.coachId,
          duration: durationMinutes,
          init_data: tg?.initData || '',
          // !!! –í–ê–ñ–ù–û: –ü–µ—Ä–µ–¥–∞–µ–º ID —Å–µ—Å—Å–∏–∏, —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å –µ—ë –∏–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏
          excludeSessionId: currentSession.id 
        })
      });
      
      const json = await resp.json();
      if (json.ok && json.data) {
        availableSlotsCache = json.data; 
        renderRescheduleDates();
      } else {
        grid.innerHTML = '<div class="rs-empty">–ù–µ—Ç –º–µ—Å—Ç</div>';
      }
    } catch (e) {
      grid.innerHTML = '<div class="rs-empty">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</div>';
    }
  }

  function renderRescheduleDates() {
    const track = document.getElementById('rsDatesTrack');
    track.innerHTML = '';
    
    const dates = Object.keys(availableSlotsCache).sort();
    const weekDays = ['–í–°','–ü–ù','–í–¢','–°–†','–ß–¢','–ü–¢','–°–ë']; 
    
    if (dates.length === 0) {
       document.getElementById('rsSlotsGrid').innerHTML = '<div class="rs-empty">–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 14 –¥–Ω–µ–π</div>';
       return;
    }

    dates.forEach((dateStr, index) => {
       const d = new Date(dateStr);
       const dayName = weekDays[d.getDay()];
       const dayNum = d.getDate();
       
       const chip = document.createElement('div');
       chip.className = 'rs-date-chip';
       if (index === 0) chip.classList.add('active'); 
       
       chip.innerHTML = `<div class="rs-day-name">${dayName}</div><div class="rs-day-num">${dayNum}</div>`;
       chip.onclick = () => selectRsDate(dateStr, chip);
       
       track.appendChild(chip);
    });

    selectRsDate(dates[0], track.firstChild);
  }

  function selectRsDate(dateStr, chipEl) {
    selectedRsDate = dateStr;
    
    document.querySelectorAll('.rs-date-chip').forEach(c => c.classList.remove('active'));
    if(chipEl) chipEl.classList.add('active');
    
    const grid = document.getElementById('rsSlotsGrid');
    grid.innerHTML = '';
    
    const slots = availableSlotsCache[dateStr] || [];
    if (slots.length === 0) {
      grid.innerHTML = '<div class="rs-empty">–ù–µ—Ç –º–µ—Å—Ç</div>';
      return;
    }

    slots.forEach(time => {
      const btn = document.createElement('button');
      btn.className = 'rs-time-btn';
      btn.textContent = time;
      btn.onclick = () => confirmReschedule(time);
      grid.appendChild(btn);
    });
  }

  async function confirmReschedule(newTime) {
     if(!confirm(`–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –Ω–∞ ${selectedRsDate} –≤ ${newTime}?`)) return;
     
     closeAllSheets();
     showToast("–ü–µ—Ä–µ–Ω–æ—Å–∏–º...");
     
     const oldDate = currentSession.dateStr;
     const sId = currentSession.id;
     
     const [hS, mS] = currentSession.start.split(':').map(Number);
     const [hE, mE] = currentSession.end.split(':').map(Number);
     const duration = (hE * 60 + mE) - (hS * 60 + mS);
     
     const [nH, nM] = newTime.split(':').map(Number);
     const newEndMin = nH * 60 + nM + duration;
     const newH = Math.floor(newEndMin / 60);
     const newM = newEndMin % 60;
     const newEndTime = `${String(newH).padStart(2,'0')}:${String(newM).padStart(2,'0')}`;

     const sIdx = sessions.findIndex(s => s.id === sId);
     if (sIdx !== -1) {
         sessions[sIdx].dateStr = selectedRsDate;
         sessions[sIdx].start = newTime;
         sessions[sIdx].end = newEndTime;
         reRenderBlocks(); 
     }

     try {
       const tg = window.Telegram?.WebApp;
       const resp = await fetch(API_URL, {
         method: 'POST',
         body: JSON.stringify({
           action: 'reschedule',
           init_data: tg?.initData || '',
           oldSessionId: sId,
           oldDate: oldDate,
           newDate: selectedRsDate,
           newTime: newTime,
           coachId: currentSession.coachId
         })
       });
       
       const json = await resp.json();
       if (!json.ok) {
         showToast("–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞!");
         DataManager.syncLoad(); 
       } else {
         showToast("–£—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ");
         DataManager.saveLocally();
       }
     } catch (e) {
       showToast("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
     }
  }

  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
