<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Ultima Client</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  /* === CORE STYLES (Clean Version) === */
  :root {
    --bg-core: #050505; 
    --bg-panel: #1C1C1E; 
    --text-main: #ffffff;
    --text-muted: #8E8E93;
    --line-color: rgba(255, 255, 255, 0.08);
    --time-col-width: 55px;
    --day-col-width: 65px; 
    --acc-current: #3c9cfd; /* –û—Å–Ω–æ–≤–Ω–æ–π –∞–∫—Ü–µ–Ω—Ç */
    --acc-blue: #0a84ff;
    --grid-h: 60px;
    --safe-top: env(safe-area-inset-top);
    --safe-bottom: env(safe-area-inset-bottom);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
  *::-webkit-scrollbar { display: none; }

  body {
    background-color: var(--bg-core);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', Roboto, sans-serif;
    color: var(--text-main);
    height: 100%; width: 100%;
    overflow: hidden; position: fixed; inset: 0; user-select: none;
  }

  /* === FX LAYER === */
  .fx-layer { position: absolute; inset: 0; z-index: 0; pointer-events: none; }
  .orb { position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.4; }
  .orb-1 { width: 300px; height: 300px; background: #5e60ce; top: -50px; left: -100px; }
  .orb-2 { width: 250px; height: 250px; background: #0a84ff; bottom: -50px; right: -50px; }
  .noise { position: fixed; inset: 0; opacity: 0.04; background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); }

  /* === LAYOUT === */
  .app-container { display: flex; flex-direction: column; height: 100%; width: 100%; position: relative; z-index: 1; }

  /* === HEADER (SIMPLIFIED) === */
  .top-area {
    position: relative;
    background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--line-color); padding-top: calc(10px + var(--safe-top)); padding-bottom: 10px;
    z-index: 60; flex-shrink: 0; display: flex; justify-content: center;
  }
  .month-label { font-size: 16px; font-weight: 700; color: #fff; text-transform: uppercase; letter-spacing: 1px; }

  /* === MATRIX === */
  .matrix-viewport { flex: 1; overflow: auto; position: relative; display: flex; flex-direction: column; z-index: 10; }
  .matrix-header-row { display: flex; position: sticky; top: 0; z-index: 40; width: max-content; background: rgba(0,0,0,0.4); backdrop-filter: blur(15px); border-bottom: 1px solid var(--line-color); }
  .corner-cell { width: var(--time-col-width); flex-shrink: 0; position: sticky; left: 0; z-index: 50; background: inherit; border-right: 1px solid var(--line-color); }
  .days-header-track { display: flex; flex: 1; }
  
  .day-col-header {
    width: var(--day-col-width); flex-shrink: 0; text-align: center; height: 50px; 
    padding-top: 8px; font-size: 11px; color: var(--text-muted); border-right: 1px solid var(--line-color);
  }
  .dch-day { font-weight: 600; text-transform: uppercase; margin-bottom: 2px; }
  .dch-num { font-size: 16px; font-weight: 500; color: #fff; }
  .day-col-header.today .dch-day { color: var(--acc-blue); }
  .day-col-header.today .dch-num { color: #fff; font-weight: 700; }
  .day-col-header.today { border-bottom: 2px solid var(--acc-blue); background: rgba(10,132,255,0.1); }

  .matrix-body { display: flex; width: max-content; position: relative; }
  .time-column { width: var(--time-col-width); flex-shrink: 0; position: sticky; left: 0; z-index: 30; background: rgba(0,0,0,0.4); backdrop-filter: blur(15px); border-right: 1px solid var(--line-color); }
  .time-label { height: var(--grid-h); position: relative; }
  .time-label span { position: absolute; top: -7px; right: 6px; font-size: 11px; color: var(--text-muted); }

  .grid-columns-container { display: flex; flex: 1; position: relative; }
  .day-column {
    width: var(--day-col-width); flex-shrink: 0; border-right: 1px solid var(--line-color); position: relative;
    background-image: linear-gradient(to bottom, var(--line-color) 1px, transparent 1px); background-size: 100% var(--grid-h);
  }
  .day-column.today { background-color: rgba(10, 132, 255, 0.02); }

  /* === BLOCKS & EVENTS === */
  /* –°–µ—Ä—ã–µ –∑–æ–Ω—ã (–Ω–µ—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è) */
  .blocked-slot { position: absolute; left: 0; right: 0; height: var(--grid-h); background: repeating-linear-gradient(45deg, rgba(255,255,255,0.03), rgba(255,255,255,0.03) 10px, rgba(255,255,255,0.06) 10px, rgba(255,255,255,0.06) 20px); pointer-events: none; z-index: 1; }
  /* –û—Ç–ø—É—Å–∫–∞/–í—ã—Ö–æ–¥–Ω—ã–µ */
  .day-off-overlay, .blocked-range-part { position: absolute; left: 0; right: 0; background: repeating-linear-gradient(45deg, rgba(255,255,255,0.05), rgba(255,255,255,0.05) 10px, rgba(255,255,255,0.08) 10px, rgba(255,255,255,0.08) 20px); z-index: 2; pointer-events: none; }

  /* –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (–°–∏–Ω—è—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞) */
  .event-card { 
    position: absolute; left: 2px; right: 2px; border-radius: 6px; 
    background: var(--acc-blue); 
    border: 1px solid rgba(255,255,255,0.2);
    padding: 4px; overflow: hidden; z-index: 10; cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }
  .ev-title { font-size: 11px; font-weight: 700; color: #fff; margin-bottom: 2px; }
  .ev-time { font-size: 10px; color: rgba(255,255,255,0.9); }
  .event-card.status-completed { background: var(--acc-green); } /* –ï—Å–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ - –∑–µ–ª–µ–Ω–∞—è */

  /* === SHEET (VIEW ONLY) === */
  .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(4px); }
  .sheet-overlay.active { opacity: 1; pointer-events: auto; }
  
  .sheet { 
    position: fixed; bottom: 0; left: 0; right: 0; 
    background: #1C1C1E; border-radius: 20px 20px 0 0; 
    padding: 24px 16px calc(24px + var(--safe-bottom)) 16px; 
    transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); 
    z-index: 101; border-top: 1px solid rgba(255,255,255,0.1);
  }
  .sheet.open { transform: translateY(0); }
  
  .sh-title { font-size: 20px; font-weight: 700; color: #fff; margin-bottom: 4px; }
  .sh-sub { font-size: 14px; color: var(--acc-blue); margin-bottom: 20px; }
  
  .info-row { display: flex; justify-content: space-between; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); }
  .ir-label { color: #8E8E93; font-size: 13px; }
  .ir-val { color: #fff; font-size: 15px; font-weight: 500; }

  .btn-close {
    width: 100%; padding: 14px; background: rgba(255,255,255,0.1); 
    color: #fff; border-radius: 12px; border: none; font-size: 16px; font-weight: 600; cursor: pointer;
  }

  /* Toast */
  .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #333; color: #fff; padding: 10px 20px; border-radius: 20px; font-size: 13px; z-index: 200; transition: 0.3s; opacity: 0; }
  .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

</style>
</head>
<body oncontextmenu="return false;">

<div class="fx-layer"><div class="orb orb-1"></div><div class="orb orb-2"></div><div class="noise"></div></div>

<div class="toast" id="toast">–û–±–Ω–æ–≤–ª–µ–Ω–æ</div>

<div class="app-container">
  <div class="top-area">
    <div class="month-label" id="headerMonth">–ó–ê–ì–†–£–ó–ö–ê...</div>
  </div>

  <div class="matrix-viewport" id="matrixViewport">
    <div class="matrix-header-row">
      <div class="corner-cell"></div>
      <div class="days-header-track" id="daysHeaderTrack"></div>
    </div>
    <div class="matrix-body">
      <div class="time-column" id="timeColumn"></div>
      <div class="grid-columns-container" id="gridColumns"></div>
    </div>
  </div>
</div>

<div class="sheet-overlay" id="overlay" onclick="closeSheet()"></div>

<div class="sheet" id="detailsSheet">
  <div class="sh-title">–î–µ—Ç–∞–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</div>
  <div class="sh-sub" id="detDate">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, 12 –û–∫—Ç—è–±—Ä—è</div>
  
  <div class="info-row">
    <div class="ir-label">–í—Ä–µ–º—è</div>
    <div class="ir-val" id="detTime">10:00 - 11:00</div>
  </div>
  
  <div class="info-row">
    <div class="ir-label">–¢–∏–ø / –ó–∞–º–µ—Ç–∫–∞</div>
    <div class="ir-val" id="detNote">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è</div>
  </div>

  <div class="info-row" style="border:none">
    <div class="ir-label">–°—Ç–∞—Ç—É—Å</div>
    <div class="ir-val" id="detStatus">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</div>
  </div>

  <button class="btn-close" onclick="closeSheet()">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>

<script>
  // === CONFIG ===
  const API_URL = 'https://script.google.com/macros/s/AKfycbxXxlp8PCCZ6dBlc4fyKafLKNDPIv8FQJV663YHp3vp5lcbtvH9CmRsrs9hccEC1weJRQ/exec'; 
  const GRID_H = 60;
  
  let startOffset = -7, endOffset = 30; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–µ–¥–µ–ª—é –Ω–∞–∑–∞–¥ –∏ –º–µ—Å—è—Ü –≤–ø–µ—Ä–µ–¥
  let sessions = [];
  let availabilityPattern = {0:[],1:[],2:[],3:[],4:[],5:[],6:[]}; 
  let specialRanges = []; 
  let dateExceptions = {};

  // === TMA INIT ===
  (function initTMA() {
    try {
      const tg = window.Telegram?.WebApp;
      if (tg) {
        tg.ready(); 
        tg.expand();
        tg.setHeaderColor('#050505'); 
        tg.setBackgroundColor('#050505');
        // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –Ω–µ –Ω—É–∂–Ω–∞, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–ª–∏–µ–Ω—Ç–∞
      }
    } catch (e) {}
  })();

  // === DATA LAYER ===
  const DataManager = {
    // –í–ê–ñ–ù–û: –í—ã–∑—ã–≤–∞–µ–º client_load, –∫–æ—Ç–æ—Ä—ã–π –≤–µ—Ä–Ω–µ—Ç –¢–û–õ–¨–ö–û –º–æ–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
    async syncLoad() {
      const d = new Date();
      const m1 = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      const nextM = new Date(d); nextM.setMonth(d.getMonth() + 1);
      const m2 = `${nextM.getFullYear()}-${String(nextM.getMonth()+1).padStart(2,'0')}`;

      try {
        const tg = window.Telegram?.WebApp;
        const initData = tg?.initData || '';

        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
        const resp = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'client_load', init_data: initData, month_str: m1 })
        });
        const json = await resp.json();
        
        if (json.ok && json.data) {
           this.applyData(json.data, m1);
        }
        
        // –í—Ç–æ—Ä–æ–π –º–µ—Å—è—Ü (—Ñ–æ–Ω–æ–º)
        fetch(API_URL, {
           method: 'POST',
           body: JSON.stringify({ action: 'client_load', init_data: initData, month_str: m2 })
        }).then(r=>r.json()).then(j=>{ if(j.ok) this.applyData(j.data, m2); });

        showToast("–û–±–Ω–æ–≤–ª–µ–Ω–æ");
      } catch (e) {
        console.error(e);
        showToast("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
      }
    },

    applyData(data, monthStr) {
      // 1. Settings (–ì—Ä–∞—Ñ–∏–∫ —Ç—Ä–µ–Ω–µ—Ä–∞)
      if (data.settings) {
        if(data.settings.pattern) availabilityPattern = data.settings.pattern;
        if(data.settings.ranges) specialRanges = data.settings.ranges;
      }
      
      // 2. Calendar (–¢–æ–ª—å–∫–æ –º–æ–∏ —Å–µ—Å—Å–∏–∏)
      if (data.calendar) {
        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü, —á—Ç–æ–±—ã –Ω–µ –¥–≤–æ–∏–ª–æ—Å—å
        sessions = sessions.filter(s => !s.dateStr.startsWith(monthStr));
        
        Object.keys(data.calendar).forEach(dayKey => {
            const evts = data.calendar[dayKey]; // –≠—Ç–æ —É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤ —Å –±—ç–∫–∞
            evts.forEach(evt => {
                sessions.push({
                    id: evt.i,
                    dateStr: `${monthStr}-${dayKey.padStart(2, '0')}`,
                    start: evt.s,
                    end: evt.e,
                    note: evt.n || '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞',
                    status: evt.st || 'planned'
                });
            });
        });
        reRenderBlocks();
      }
    }
  };

  // === RENDER LOGIC ===
  function init() {
    renderTimeColumn();
    renderDayRange(startOffset, endOffset);
    scrollToToday();
    
    // Scroll Monitor
    document.getElementById('matrixViewport').addEventListener('scroll', onScroll, {passive: true});
    
    // Load Data
    DataManager.syncLoad();
  }

  function renderTimeColumn() {
    const col = document.getElementById('timeColumn');
    col.innerHTML = '';
    for(let i=0; i<24; i++) {
      const el = document.createElement('div');
      el.className = 'time-label';
      if(i>0) el.innerHTML = `<span>${String(i).padStart(2,'0')}:00</span>`;
      col.appendChild(el);
    }
  }

  function renderDayRange(from, to) {
    const track = document.getElementById('daysHeaderTrack');
    const grid = document.getElementById('gridColumns');
    const weekDays = ['–ü–ù','–í–¢','–°–†','–ß–¢','–ü–¢','–°–ë','–í–°'];
    const base = new Date(); base.setHours(0,0,0,0);
    const todayStr = getLocalDateStr(new Date());

    for(let i=from; i<=to; i++) {
      const d = new Date(base); d.setDate(d.getDate()+i);
      const dateStr = getLocalDateStr(d);
      let dayIdx = d.getDay()-1; if(dayIdx===-1) dayIdx=6;
      const isToday = dateStr === todayStr;

      // Header
      const h = document.createElement('div');
      h.className = `day-col-header ${isToday ? 'today' : ''}`;
      h.setAttribute('data-date', dateStr);
      h.innerHTML = `<div class="dch-day">${weekDays[dayIdx]}</div><div class="dch-num">${d.getDate()}</div>`;
      track.appendChild(h);

      // Column
      const c = document.createElement('div');
      c.className = `day-column ${isToday ? 'today' : ''}`;
      c.setAttribute('data-date', dateStr);
      c.setAttribute('data-day-idx', dayIdx);
      grid.appendChild(c);
    }
  }

  function reRenderBlocks() {
    document.querySelectorAll('.day-column').forEach(col => {
      col.innerHTML = ''; // Clear
      const dateStr = col.getAttribute('data-date');
      const dayIdx = parseInt(col.getAttribute('data-day-idx'));
      
      // 1. –†–∏—Å—É–µ–º —Å–µ—Ä—ã–µ –∑–æ–Ω—ã (–≥—Ä–∞—Ñ–∏–∫ —Ç—Ä–µ–Ω–µ—Ä–∞)
      const blocked = availabilityPattern[dayIdx] || [];
      blocked.forEach(h => {
         const b = document.createElement('div');
         b.className = 'blocked-slot';
         b.style.top = `${h * GRID_H}px`;
         col.appendChild(b);
      });

      // 2. –†–∏—Å—É–µ–º –æ—Ç–ø—É—Å–∫–∞
      if (specialRanges && specialRanges.length > 0) {
          const cS = new Date(dateStr + 'T00:00:00').getTime();
          const cE = new Date(dateStr + 'T23:59:59').getTime();
          specialRanges.forEach(r => {
              const rS = new Date(r.start).getTime();
              const rE = new Date(r.end).getTime();
              const oS = Math.max(cS, rS);
              const oE = Math.min(cE, rE);
              if (oS < oE) {
                  const top = (oS - cS) / 3600000 * GRID_H;
                  const h = (oE - oS) / 3600000 * GRID_H;
                  const p = document.createElement('div');
                  p.className = 'blocked-range-part';
                  p.style.top = `${top}px`;
                  p.style.height = `${h}px`;
                  col.appendChild(p);
              }
          });
      }

      // 3. –†–∏—Å—É–µ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞
      const daySessions = sessions.filter(s => s.dateStr === dateStr);
      daySessions.forEach(s => {
         const [h, m] = s.start.split(':').map(Number);
         const [hE, mE] = s.end.split(':').map(Number);
         const top = (h*60+m)/60 * GRID_H;
         const height = (hE*60+mE - (h*60+m))/60 * GRID_H;
         
         const el = document.createElement('div');
         el.className = 'event-card' + (s.status==='completed'?' status-completed':'');
         el.style.top = `${top}px`;
         el.style.height = `${Math.max(height, 24)}px`;
         el.innerHTML = `<div class="ev-title">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</div><div class="ev-time">${s.start} - ${s.end}</div>`;
         el.onclick = () => openDetails(s);
         col.appendChild(el);
      });
    });
  }

  // === UI HELPERS ===
  function openDetails(s) {
    const d = new Date(s.dateStr);
    const opts = { weekday: 'long', day: 'numeric', month: 'long' };
    const datePretty = d.toLocaleDateString('ru-RU', opts);
    
    document.getElementById('detDate').textContent = datePretty.charAt(0).toUpperCase() + datePretty.slice(1);
    document.getElementById('detTime').textContent = `${s.start} - ${s.end}`;
    document.getElementById('detNote').textContent = s.note || '–ë–µ–∑ –∑–∞–º–µ—Ç–æ–∫';
    document.getElementById('detStatus').textContent = (s.status === 'completed') ? '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∞' : 'üìÖ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞';
    
    document.getElementById('overlay').classList.add('active');
    document.getElementById('detailsSheet').classList.add('open');
  }

  function closeSheet() {
    document.getElementById('overlay').classList.remove('active');
    document.getElementById('detailsSheet').classList.remove('open');
  }

  function getLocalDateStr(date) { 
    const y = date.getFullYear(); 
    const m = String(date.getMonth() + 1).padStart(2, '0'); 
    const d = String(date.getDate()).padStart(2, '0'); 
    return `${y}-${m}-${d}`; 
  }

  function scrollToToday() {
    const today = getLocalDateStr(new Date());
    const el = document.querySelector(`.day-col-header[data-date="${today}"]`);
    if(el) {
       const vp = document.getElementById('matrixViewport');
       vp.scrollLeft = el.offsetLeft - (vp.clientWidth/2) + (el.offsetWidth/2);
       vp.scrollTop = 9 * GRID_H; // Scroll to 09:00
    }
  }

  function onScroll() {
    const vp = document.getElementById('matrixViewport');
    const headers = document.querySelectorAll('.day-col-header');
    for(let h of headers) {
        if(h.offsetLeft >= vp.scrollLeft) {
            const d = new Date(h.getAttribute('data-date'));
            const m = d.toLocaleString('ru',{month:'long'}).toUpperCase();
            document.getElementById('headerMonth').textContent = `${m} ${d.getFullYear()}`;
            break;
        }
    }
  }

  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 2000);
  }

  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
