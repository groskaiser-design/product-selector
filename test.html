<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>AI Чат (Debug View)</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    :root {
      --bg: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --userBubble: rgba(251,191,36,.25);
      --aiBubble: rgba(255,255,255,.18);
      --inputBg: rgba(255,255,255,.12);
      --okA: #fbbf24; --okB: #f59e0b;
    }

    /* 1. ТЕМНАЯ ПОДЛОЖКА (Чтобы не было белых вспышек) */
    html {
      width: 100%; height: 100%;
      background-color: #000000; /* ЧЕРНЫЙ ФОН БРАУЗЕРА */
      overflow: hidden;
      position: fixed;
    }

    body {
      width: 100%; height: 100%;
      overflow: hidden;
      /* Если body сдвинется, ты увидишь черный фон html, а не белый */
      background: transparent; 
      position: fixed;
      top: 0; left: 0;
    }

    /* 2. ПЛАВАЮЩИЙ КОНТЕЙНЕР (С КРАСНОЙ РАМКОЙ ДЛЯ ТЕСТА) */
    #app {
      position: absolute;
      top: 0; left: 0; width: 100%;
      /* Высота задается JS-ом */
      background: var(--bg); /* Твой градиент здесь */
      
      display: flex; flex-direction: column;
      
      /* ТЕСТОВАЯ РАМКА: Чтобы ты видел границы окна */
      border: 2px solid red; 
      box-sizing: border-box;
    }

    /* Шапка */
    .header {
      flex-shrink: 0; height: 54px;
      display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.1);
      color: #fff; font-weight: bold; font-family: sans-serif;
    }
    .clear-btn {
      position: absolute; right: 10px; background: #ef4444; border:none; color:#fff; padding: 5px 10px; border-radius: 6px; cursor: pointer;
    }

    /* Чат */
    .chat-area {
      flex-grow: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 15px;
      display: flex; flex-direction: column; gap: 10px;
      color: #fff; font-family: sans-serif;
    }
    .message { padding: 10px 14px; border-radius: 12px; max-width: 80%; }
    .message.user { align-self: flex-end; background: var(--userBubble); }
    .message.ai { align-self: flex-start; background: var(--aiBubble); }

    /* Ввод */
    .input-area {
      flex-shrink: 0;
      padding: 10px;
      background: rgba(0,0,0,0.3);
      display: flex; gap: 10px; align-items: flex-end;
    }
    textarea {
      flex: 1; background: var(--inputBg); border: 1px solid rgba(255,255,255,0.3);
      border-radius: 15px; padding: 10px; color: #fff; font-size: 16px;
      max-height: 100px; resize: none; outline: none;
    }
    button {
      width: 40px; height: 40px; border-radius: 50%; border: none; background: var(--okA);
      flex-shrink: 0; display: flex; align-items: center; justify-content: center;
    }
    
    /* Модалка */
    .modal { position: fixed; inset:0; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; z-index:999; }
    .modal.show { display:flex; }
    .modal-box { background:#333; padding:20px; border-radius:10px; color:#fff; text-align:center; }
    .modal-btns { display:flex; gap:10px; margin-top:15px; }
    .modal-btns button { flex:1; border-radius:5px; padding:10px; font-weight:bold; cursor:pointer; }
  </style>
</head>
<body>

  <div id="app">
    <div class="header">
      AI Коуч
      <button class="clear-btn" id="clearBtn">Clear</button>
    </div>
    <div class="chat-area" id="chatArea">
      <div class="message ai" style="margin: auto;">Готов к работе.</div>
    </div>
    <div class="input-area">
      <textarea id="messageInput" rows="1" placeholder="Сообщение..."></textarea>
      <button id="sendBtn">➤</button>
    </div>
  </div>

  <div class="modal" id="confirmModal">
    <div class="modal-box">
      <h3>Удалить?</h3>
      <div class="modal-btns">
        <button id="modalCancel" style="background:#555; color:#fff;">Нет</button>
        <button id="modalConfirm" style="background:#ef4444; color:#fff;">Да</button>
      </div>
    </div>
  </div>

  <script>
    // --- АНТИ-ПРЫЖОК ---
    const app = document.getElementById('app');
    const input = document.getElementById('messageInput');
    const chat = document.getElementById('chatArea');

    function updateLayout() {
      // Если есть VisualViewport (iOS/Android)
      if (window.visualViewport) {
        // 1. Устанавливаем высоту равной ВИДИМОЙ части
        app.style.height = `${window.visualViewport.height}px`;
        // 2. Компенсируем сдвиг сверху
        app.style.top = `${window.visualViewport.offsetTop}px`;
        
        // 3. Принудительно возвращаем страницу на место (если iOS попытался сдвинуть body)
        window.scrollTo(0, 0);
      } else {
        app.style.height = `${window.innerHeight}px`;
        app.style.top = `0px`;
      }
      
      // Докручиваем чат вниз
      chat.scrollTop = chat.scrollHeight;
    }

    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', updateLayout);
      window.visualViewport.addEventListener('scroll', updateLayout);
    }
    window.addEventListener('resize', updateLayout);
    
    // Старт
    updateLayout();

    // === ХАК ПРИ ФОКУСЕ ===
    input.addEventListener('focus', () => {
      // Каждые 10мс бьем по рукам браузеру, чтобы не сдвигал фон
      const i = setInterval(() => {
        window.scrollTo(0, 0);
        updateLayout();
      }, 10);

      // Через 400мс (когда клава выехала) останавливаем долбежку
      setTimeout(() => {
        clearInterval(i);
        updateLayout();
        chat.scrollTop = chat.scrollHeight;
      }, 400);
    });

    input.addEventListener('blur', () => {
      setTimeout(updateLayout, 100);
    });

    // --- ТВОЙ БЭКЕНД ---
    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbzvlDKUH6qsON-A6iSHYvMU_6XWtReZc5oXnnZOMTgETfvZqMMh2zUbdQJF-iOanMBc/exec';
    let msgs = [];

    // Init TG
    (function(){ 
      const t = window.Telegram?.WebApp; 
      if(t){ t.ready(); t.expand(); t.disableVerticalSwipes?.(); }
    })();

    function render() {
      // Чистка
      Array.from(chat.children).forEach(c => {
         if(!c.style.margin) c.remove(); // оставляем только приветствие если список пуст
      });
      if(msgs.length > 0) chat.innerHTML = ''; // если есть смс, чистим приветствие

      msgs.forEach((m, idx) => {
        const d = document.createElement('div');
        d.className = `message ${m.role}`;
        d.textContent = m.content;
        
        // Удаление
        d.onclick = () => confirmDel(idx);
        chat.appendChild(d);
      });
      chat.scrollTop = chat.scrollHeight;
    }

    async function send() {
      const txt = input.value.trim();
      if(!txt) return;
      
      msgs.push({role:'user', content:txt});
      save(); render();
      input.value=''; input.style.height='auto';

      // Fake loading
      const lid = Date.now();
      msgs.push({role:'ai', content:'...', id:lid});
      render();

      try {
        const u = window.Telegram?.WebApp?.initDataUnsafe?.user || {};
        const uid = u.id || localStorage.getItem('uid') || 'd-'+Math.random();
        localStorage.setItem('uid', uid);

        const res = await fetch(BACKEND_URL, {
          method:'POST',
          body:JSON.stringify({
            action:'send_message',
            user_id: uid,
            message: txt,
            user_data: u
          })
        }).then(r=>r.json());

        msgs = msgs.filter(m=>m.id!==lid);
        if(res.success) msgs.push({role:'ai', content:res.text});
        else msgs.push({role:'ai', content:'Ошибка'});

      } catch(e) {
        msgs = msgs.filter(m=>m.id!==lid);
        msgs.push({role:'ai', content:'Сбой сети'});
      }
      save(); render();
    }

    // Utils
    function save() { localStorage.setItem('chat', JSON.stringify(msgs)); }
    function load() { const s=localStorage.getItem('chat'); if(s){ msgs=JSON.parse(s); render(); } }
    
    input.addEventListener('input', function(){
      this.style.height='auto'; this.style.height=Math.min(this.scrollHeight,100)+'px';
    });
    document.getElementById('sendBtn').onclick = send;

    // Modal
    const modal = document.getElementById('confirmModal');
    let onDel = null;
    function confirmDel(i){ 
      onDel = ()=>{ msgs.splice(i,1); save(); render(); }; 
      modal.classList.add('show'); 
    }
    document.getElementById('modalCancel').onclick = ()=>modal.classList.remove('show');
    document.getElementById('modalConfirm').onclick = ()=>{ if(onDel)onDel(); modal.classList.remove('show'); };
    
    document.getElementById('clearBtn').onclick = () => {
       onDel = async () => {
          msgs=[]; save(); render();
          const u = window.Telegram?.WebApp?.initDataUnsafe?.user || {};
          const uid = u.id || localStorage.getItem('uid');
          fetch(BACKEND_URL, {method:'POST', body:JSON.stringify({action:'clear_history', user_id:uid})}).catch(()=>{});
       };
       modal.classList.add('show');
    }

    load();
  </script>
</body>
</html>
