<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>AI –ß–∞—Ç</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* === 1. CSS LOCK (–ë–ï–¢–û–ù–ù–´–ô –§–£–ù–î–ê–ú–ï–ù–¢) === */
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    :root {
      --bg: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --userBubble: rgba(251,191,36,.25);
      --userBorder: rgba(251,191,36,.4);
      --aiBubble: rgba(255,255,255,.18);
      --aiBorder: rgba(255,255,255,.28);
      --inputBg: rgba(255,255,255,.12);
      --inputBorder: rgba(255,255,255,.24);
      --okA: #fbbf24; --okB: #f59e0b;
    }

    /* –§–∏–∫—Å–∏—Ä—É–µ–º html –∏ body –Ω–∞–º–µ—Ä—Ç–≤–æ */
    html {
      width: 100%; height: 100%;
      overflow: hidden;
      position: fixed; /* –ó–∞–ø—Ä–µ—â–∞–µ—Ç –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã –±—Ä–∞—É–∑–µ—Ä–æ–º */
    }

    body {
      width: 100%; height: 100%;
      overflow: hidden;
      background: var(--bg); /* –¢–≤–æ–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      color: #fff;
      position: fixed; 
      top: 0; left: 0;
      /* –í–∞–∂–Ω–æ: iOS –∏–Ω–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç –æ—Ç—Å—Ç—É–ø—ã, —É–±–∏—Ä–∞–µ–º –∏—Ö */
      margin: 0; padding: 0;
    }

    /* === 2. –ü–õ–ê–í–ê–Æ–©–ï–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï === */
    /* –≠—Ç–æ—Ç –±–ª–æ–∫ –±—É–¥–µ—Ç –º–µ–Ω—è—Ç—å —Ä–∞–∑–º–µ—Ä—ã —á–µ—Ä–µ–∑ JS */
    #app {
      position: fixed; /* –ò—Å–ø–æ–ª—å–∑—É–µ–º fixed –≤–Ω—É—Ç—Ä–∏ body */
      left: 0; right: 0;
      /* top –∏ height –∑–∞–¥–∞—é—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º */
      display: flex; flex-direction: column;
      max-width: 560px;
      margin: 0 auto;
    }

    /* –®–∞–ø–∫–∞ */
    .header {
      flex-shrink: 0; height: 54px;
      display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      z-index: 10; position: relative;
    }
    .header h4 { font-weight: 800; font-size: 17px; }
    .clear-btn {
      position: absolute; right: 15px; background: rgba(255,0,0,0.2);
      border: 1px solid rgba(255,0,0,0.3); color: #fff;
      padding: 5px 10px; border-radius: 8px; font-size: 12px; cursor: pointer;
    }

    /* –ß–∞—Ç */
    .chat-area {
      flex-grow: 1;
      overflow-y: scroll; /* –ò–º–µ–Ω–Ω–æ scroll, –∞ –Ω–µ auto –¥–ª—è iOS */
      overflow-x: hidden;
      padding: 15px;
      display: flex; flex-direction: column; gap: 10px;
      -webkit-overflow-scrolling: touch; /* –ò–Ω–µ—Ä—Ü–∏—è */
    }
    /* –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–æ—Å—É –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
    .chat-area::-webkit-scrollbar { display: none; }

    .message { max-width: 85%; display: flex; flex-direction: column; position: relative; animation: fadeIn 0.2s ease; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }
    .message.user { align-self: flex-end; align-items: flex-end; }
    .message.ai { align-self: flex-start; align-items: flex-start; }

    .bubble {
      padding: 10px 14px; border-radius: 16px; font-size: 15px; line-height: 1.4; word-wrap: break-word;
      backdrop-filter: blur(5px); box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .message.user .bubble { background: var(--userBubble); border: 1px solid var(--userBorder); border-bottom-right-radius: 2px; }
    .message.ai .bubble { background: var(--aiBubble); border: 1px solid var(--aiBorder); border-bottom-left-radius: 2px; }
    
    .time { font-size: 10px; opacity: 0.6; margin-top: 4px; margin-right: 4px; }

    /* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è */
    .delete-btn {
      position: absolute; top: 50%; transform: translateY(-50%);
      width: 28px; height: 28px; background: #ef4444; border-radius: 50%;
      display: none; align-items: center; justify-content: center; color: white; z-index: 5;
    }
    .message.user .delete-btn { left: -35px; } .message.ai .delete-btn { right: -35px; }
    .message.show-delete .delete-btn { display: flex; }

    /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */
    .input-area {
      flex-shrink: 0;
      padding: 10px;
      background: rgba(0,0,0,0.2); backdrop-filter: blur(10px);
      display: flex; gap: 10px; align-items: flex-end;
      /* –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞ —Å–Ω–∏–∑—É –Ω–µ –Ω—É–∂–Ω–∞ –∑–¥–µ—Å—å, —Ç–∞–∫ –∫–∞–∫ –º—ã —Ä–µ—Å–∞–π–∑–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–æ–≤–Ω–æ –¥–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã */
    }
    .input-field {
      flex: 1; background: var(--inputBg); border: 1px solid var(--inputBorder);
      border-radius: 20px; padding: 10px 15px; color: #fff; font-size: 16px; /* 16px fix zoom */
      max-height: 100px; min-height: 40px; resize: none; outline: none; font-family: inherit;
    }
    .send-btn {
      width: 40px; height: 40px; border-radius: 50%; border: none; flex-shrink: 0;
      background: linear-gradient(135deg,var(--okA),var(--okB)); color: #fff;
      display: flex; align-items: center; justify-content: center;
    }
    .send-btn:disabled { opacity: 0.5; }

    /* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
    .empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0.7; }
    .empty-state div { font-size: 40px; margin-bottom: 10px; }

    /* –ú–æ–¥–∞–ª–∫–∞ */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100; display: none; align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-box { background: #252525; padding: 20px; border-radius: 16px; text-align: center; width: 280px; border: 1px solid rgba(255,255,255,0.1); }
    .modal-btns { display: flex; gap: 10px; margin-top: 15px; }
    .modal-btns button { flex: 1; padding: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
    
  </style>
</head>
<body>

  <div id="app">
    <div class="header">
      <h4>Ai-–ö–æ—É—á</h4>
      <button class="clear-btn" id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <div class="chat-area" id="chatArea">
      <div class="empty-state" id="emptyState">
        <div>üí¨</div>
        <p>–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥</p>
      </div>
    </div>

    <div class="input-area">
      <textarea class="input-field" id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
      <button class="send-btn" id="sendBtn" disabled>‚û§</button>
    </div>
  </div>

  <div class="modal" id="confirmModal">
    <div class="modal-box">
      <h3>–£–¥–∞–ª–∏—Ç—å?</h3>
      <div class="modal-btns">
        <button style="background:rgba(255,255,255,0.1); color:#fff" id="modalCancel">–ù–µ—Ç</button>
        <button style="background:#fbbf24; color:#000" id="modalConfirm">–î–∞</button>
      </div>
    </div>
  </div>

  <script>
    // --- 1. LOGIC: FIX JUMPING (–°–ê–ú–û–ï –í–ê–ñ–ù–û–ï) ---
    const app = document.getElementById('app');
    const chatArea = document.getElementById('chatArea');
    const input = document.getElementById('messageInput');

    function updateLayout() {
      // –ï—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç VisualViewport API (iOS Safari –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç)
      if (window.visualViewport) {
        // 1. –í—ã—Å–æ—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è = –≤—ã—Å–æ—Ç–µ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏ (—ç–∫—Ä–∞–Ω –º–∏–Ω—É—Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞)
        app.style.height = `${window.visualViewport.height}px`;
        
        // 2. –°–º–µ—â–µ–Ω–∏–µ —Å–≤–µ—Ä—Ö—É = —Å–º–µ—â–µ–Ω–∏—é –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏.
        // –≠—Ç–æ –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç –ø–æ–ø—ã—Ç–∫—É iOS —Å–¥–≤–∏–Ω—É—Ç—å body –≤–≤–µ—Ä—Ö.
        app.style.top = `${window.visualViewport.offsetTop}px`;
        
        // 3. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ 0,0
        window.scrollTo(0, 0);
      } else {
        // –§–æ–ª–ª–±—ç–∫
        app.style.height = `${window.innerHeight}px`;
        app.style.top = `0px`;
      }
      
      // –î–æ–∫—Ä—É—Ç–∫–∞ —á–∞—Ç–∞
      requestAnimationFrame(() => {
        chatArea.scrollTop = chatArea.scrollHeight;
      });
    }

    // –°–ª—É—à–∞–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', updateLayout);
      window.visualViewport.addEventListener('scroll', updateLayout);
    }
    window.addEventListener('resize', updateLayout);
    updateLayout(); // –°—Ç–∞—Ä—Ç

    // –•–ê–ö: –ü—Ä–∏ —Ñ–æ–∫—É—Å–µ iOS –ª—é–±–∏—Ç —Å–∫—Ä–æ–ª–ª–∏—Ç—å body. –ù–µ –¥–∞–µ–º –µ–º—É —ç—Ç–æ –¥–µ–ª–∞—Ç—å.
    input.addEventListener('focus', () => {
      // –ó–∞–ø—É—Å–∫–∞–µ–º –±—ã—Å—Ç—Ä—ã–π —Ç–∞–π–º–µ—Ä –Ω–∞ –≤—Ä–µ–º—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
      const interval = setInterval(() => {
        window.scrollTo(0, 0);
        updateLayout();
      }, 10);
      
      setTimeout(() => {
        clearInterval(interval);
        updateLayout();
        // –§–∏–Ω–∞–ª—å–Ω–∞—è –¥–æ–∫—Ä—É—Ç–∫–∞ —á–∞—Ç–∞
        setTimeout(() => chatArea.scrollTop = chatArea.scrollHeight, 50);
      }, 500);
    });

    input.addEventListener('blur', () => {
      setTimeout(updateLayout, 100);
    });

    // --- 2. BUSINESS LOGIC (–ë–≠–ö–ï–ù–î –ò –§–£–ù–ö–¶–ò–û–ù–ê–õ) ---
    
    // Init Telegram
    (function init(){
      const tg = window.Telegram?.WebApp;
      if(tg){ tg.ready(); tg.expand(); tg.disableVerticalSwipes?.(); }
    })();

    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbzvlDKUH6qsON-A6iSHYvMU_6XWtReZc5oXnnZOMTgETfvZqMMh2zUbdQJF-iOanMBc/exec';
    let messages = [];
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const emptyState = document.getElementById('emptyState');

    function formatTime(ts) {
       const d = new Date(ts);
       return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
    }

    function render() {
      // –û—á–∏—Å—Ç–∫–∞ DOM –∫—Ä–æ–º–µ emptyState
      Array.from(chatArea.children).forEach(c => { if(c.id!=='emptyState') c.remove(); });

      if(messages.length === 0) emptyState.style.display = 'flex';
      else {
        emptyState.style.display = 'none';
        messages.forEach((m, i) => chatArea.appendChild(createMsgEl(m, i)));
      }
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    function createMsgEl(m, index) {
      const div = document.createElement('div');
      div.className = `message ${m.role}`;
      
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = m.content;

      const delBtn = document.createElement('div');
      delBtn.className = 'delete-btn';
      delBtn.innerHTML = '‚úï';
      delBtn.onclick = (e) => { e.stopPropagation(); confirmDelete(index); };

      // Long press
      let t;
      bubble.addEventListener('touchstart', () => t = setTimeout(() => {
         div.classList.add('show-delete');
         window.Telegram?.WebApp?.HapticFeedback?.impactOccurred('medium');
      }, 500));
      bubble.addEventListener('touchend', () => clearTimeout(t));

      const time = document.createElement('div');
      time.className = 'time';
      time.textContent = formatTime(m.timestamp);

      div.appendChild(delBtn);
      div.appendChild(bubble);
      div.appendChild(time);
      return div;
    }

    // Send
    async function send() {
      const text = input.value.trim();
      if(!text) return;
      window.Telegram?.WebApp?.HapticFeedback?.impactOccurred('light');

      messages.push({ role:'user', content:text, timestamp:Date.now() });
      save(); render();
      
      input.value = ''; input.style.height = 'auto'; sendBtn.disabled = true;
      
      // Loading
      const loadId = Date.now();
      messages.push({ role:'ai', content:'...', timestamp:loadId });
      render();

      try {
        const u = window.Telegram?.WebApp?.initDataUnsafe?.user || {};
        const uid = u.id || localStorage.getItem('debug_uid') || 'd-'+Math.random();
        if(!u.id) localStorage.setItem('debug_uid', uid);

        const res = await fetch(BACKEND_URL, {
           method:'POST', body:JSON.stringify({
             action:'send_message', user_id:uid, message:text,
             user_data: {first_name:u.first_name}, init_data: window.Telegram?.WebApp?.initData||''
           })
        }).then(r=>r.json());

        messages.pop(); // remove loading
        if(res.success) {
           messages.push({ role:'ai', content:res.text||'–ü—É—Å—Ç–æ', timestamp:Date.now() });
           window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred('success');
        } else {
           messages.push({ role:'ai', content:'–û—à–∏–±–∫–∞', timestamp:Date.now() });
        }
      } catch(e) {
        messages.pop();
        messages.push({ role:'ai', content:'–°–±–æ–π —Å–µ—Ç–∏', timestamp:Date.now() });
      }
      save(); render();
    }

    function save(){ localStorage.setItem('ai_chat_v2', JSON.stringify(messages)); }
    function load(){ const s=localStorage.getItem('ai_chat_v2'); if(s){ messages=JSON.parse(s); render(); } }

    input.addEventListener('input', function(){
       this.style.height='auto'; this.style.height=Math.min(this.scrollHeight, 100)+'px';
       sendBtn.disabled = !this.value.trim();
    });
    sendBtn.onclick = send;

    // Modals
    const modal = document.getElementById('confirmModal');
    let onConfirm = null;
    function confirmDelete(i) { onConfirm = () => { messages.splice(i,1); save(); render(); }; modal.classList.add('show'); }
    
    clearBtn.onclick = () => {
       if(!messages.length) return;
       onConfirm = async () => { 
          messages=[]; save(); render();
          const u = window.Telegram?.WebApp?.initDataUnsafe?.user || {};
          const uid = u.id || localStorage.getItem('debug_uid');
          fetch(BACKEND_URL, {method:'POST', body:JSON.stringify({action:'clear_history', user_id:uid})}).catch(()=>{});
       };
       modal.classList.add('show');
    }

    document.getElementById('modalCancel').onclick = () => modal.classList.remove('show');
    document.getElementById('modalConfirm').onclick = () => { if(onConfirm) onConfirm(); modal.classList.remove('show'); };
    document.addEventListener('click', (e)=>{ document.querySelectorAll('.show-delete').forEach(el=>el.classList.remove('show-delete')); });

    load();
  </script>
</body>
</html>
