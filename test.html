<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>AI Chat Stable</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* –°–±—Ä–æ—Å */
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    :root {
      --bg: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --userBubble: rgba(251,191,36,.25);
      --aiBubble: rgba(255,255,255,.15);
      --input-h: 60px;
    }

    /* –ñ–ï–°–¢–ö–ê–Ø –§–ò–ö–°–ê–¶–ò–Ø
       –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–¥–≤–∏–≥ —Å–∞–º–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –±—Ä–∞—É–∑–µ—Ä–æ–º
    */
    html {
      width: 100%; height: 100%;
      overflow: hidden; /* –ó–∞–ø—Ä–µ—Ç —Å–∫—Ä–æ–ª–ª–∞ html */
      position: fixed;  /* –ó–∞–ø—Ä–µ—Ç "—Ä–µ–∑–∏–Ω–æ–≤–æ–≥–æ" —ç—Ñ—Ñ–µ–∫—Ç–∞ */
    }

    body {
      width: 100%; height: 100%;
      overflow: hidden;
      background: var(--bg);
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      color: #fff;
      position: fixed; /* –î–≤–æ–π–Ω–∞—è —Ñ–∏–∫—Å–∞—Ü–∏—è */
      top: 0; left: 0;
    }

    /* –í–ò–†–¢–£–ê–õ–¨–ù–´–ô –í–¨–Æ–ü–û–†–¢
       –ú—ã –±—É–¥–µ–º –º–µ–Ω—è—Ç—å –≤—ã—Å–æ—Ç—É —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞ —á–µ—Ä–µ–∑ JS
    */
    #app {
      position: absolute;
      top: 0; left: 0; width: 100%;
      /* –í—ã—Å–æ—Ç–∞ –±—É–¥–µ—Ç –∑–∞–¥–∞–≤–∞—Ç—å—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º */
      height: 100%; 
      display: flex; flex-direction: column;
    }

    /* –®–∞–ø–∫–∞ */
    header {
      flex-shrink: 0; height: 50px;
      display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.1); border-bottom: 1px solid rgba(255,255,255,0.1);
      font-weight: bold;
    }
    .clear-btn {
      position: absolute; right: 15px; font-size: 12px;
      padding: 5px 10px; background: rgba(255,0,0,0.2); border-radius: 8px; border:none; color:#fff;
    }

    /* –ß–∞—Ç */
    #chat {
      flex-grow: 1;
      overflow-y: auto; /* –°–∫—Ä–æ–ª–ª –¢–û–õ–¨–ö–û –∑–¥–µ—Å—å */
      overflow-x: hidden;
      padding: 15px;
      display: flex; flex-direction: column; gap: 10px;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 10px;
    }
    /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
    #chat::-webkit-scrollbar { display: none; }

    .msg { padding: 10px 14px; border-radius: 16px; max-width: 85%; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
    .msg.user { align-self: flex-end; background: var(--userBubble); border-bottom-right-radius: 2px; }
    .msg.ai { align-self: flex-start; background: var(--aiBubble); border-bottom-left-radius: 2px; }

    /* –í–≤–æ–¥ */
    footer {
      flex-shrink: 0;
      padding: 10px;
      background: rgba(0,0,0,0.2);
      backdrop-filter: blur(10px);
      display: flex; gap: 10px; align-items: flex-end;
    }

    textarea {
      flex-grow: 1;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 20px; padding: 10px 15px;
      color: #fff; font-size: 16px; /* 16px –í–ê–ñ–ù–û —á—Ç–æ–±—ã –Ω–µ –∑—É–º–∏–ª–æ */
      max-height: 120px; min-height: 40px;
      resize: none; outline: none; font-family: inherit;
    }

    button {
      width: 40px; height: 40px; border-radius: 50%; border: none;
      background: #fbbf24; flex-shrink: 0; display: flex; align-items: center; justify-content: center;
      font-weight: bold; color: #000;
    }
    button:disabled { opacity: 0.5; }

    /* –•–∞–∫ –¥–ª—è –≤—ã—Å–æ—Ç—ã –Ω–∞ iOS Safari */
    @supports (-webkit-touch-callout: none) {
       /* CSS —Ñ–∏–∫—Å –≤—ã—Å–æ—Ç—ã –¥–ª—è iOS (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ JS –Ω–µ —É—Å–ø–µ–µ—Ç) */
       #app { height: -webkit-fill-available; }
    }
  </style>
</head>
<body>

  <div id="app">
    <header>
      AI Assistant
      <button class="clear-btn" id="clearBtn">–°–±—Ä–æ—Å</button>
    </header>
    
    <div id="chat">
      <div class="msg ai" style="margin: auto 0;">–ü—Ä–∏–≤–µ—Ç! –Ø –≥–æ—Ç–æ–≤.</div>
    </div>

    <footer>
      <textarea id="input" rows="1" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
      <button id="sendBtn">‚û§</button>
    </footer>
  </div>

  <script>
    // --- CONFIG ---
    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbzvlDKUH6qsON-A6iSHYvMU_6XWtReZc5oXnnZOMTgETfvZqMMh2zUbdQJF-iOanMBc/exec'; 
    
    // --- ELEMENTS ---
    const app = document.getElementById('app');
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const tg = window.Telegram?.WebApp;
    
    // --- INIT ---
    if(tg) {
      tg.ready();
      tg.expand();
      // –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º, –∫–æ–≥–¥–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ù–ï —Å–∂–∏–º–∞–µ—Ç viewport –Ω–∞—Ç–∏–≤–Ω–æ, –º—ã —Å–¥–µ–ª–∞–µ–º —ç—Ç–æ —Ä—É–∫–∞–º–∏
      // –ï—Å–ª–∏ —ç—Ç–æ—Ç –º–µ—Ç–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Å–∫—Ä–∏–ø—Ç –Ω–∏–∂–µ –≤—Å–µ —Ä–∞–≤–Ω–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
      try { tg.requestFullscreen(); } catch(e){} 
    }

    // ============================================================
    // üõë ANTI-JUMP SYSTEM (–°–ò–°–¢–ï–ú–ê –ü–†–û–¢–ò–í –ü–†–´–ñ–ö–û–í)
    // ============================================================
    
    // 1. –§—É–Ω–∫—Ü–∏—è —Ä–µ—Å–∞–π–∑–∞
    function handleResize() {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º visualViewport –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ window.innerHeight
      const h = window.visualViewport ? window.visualViewport.height : window.innerHeight;
      const offset = window.visualViewport ? window.visualViewport.offsetTop : 0;
      
      app.style.height = `${h}px`;
      app.style.top = `${offset}px`;
      
      // –î–æ–∫—Ä—É—á–∏–≤–∞–µ–º —á–∞—Ç, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –≤–Ω–∏–∑—É
      scrollToBottom();
    }

    // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', handleResize);
      window.visualViewport.addEventListener('scroll', handleResize); // –ò–Ω–æ–≥–¥–∞ iOS —Å–∫—Ä–æ–ª–ª–∏—Ç –≤—å—é–ø–æ—Ä—Ç
    } else {
      window.addEventListener('resize', handleResize);
    }
    handleResize(); // –ó–∞–ø—É—Å–∫ —Å—Ä–∞–∑—É

    // 2. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–∫—Ä–æ–ª–ª–∞ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ (–°–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ)
    input.addEventListener('focus', () => {
      // –ó–∞–ø—É—Å–∫–∞–µ–º "–¥–æ–ª–±–µ–∂–∫—É", –∫–æ—Ç–æ—Ä–∞—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ 0
      // –≠—Ç–æ –¥–ª–∏—Ç—Å—è 400–º—Å - –≤—Ä–µ–º—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
      const lockInterval = setInterval(() => {
        window.scrollTo(0, 0);
        document.body.scrollTop = 0;
        handleResize(); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—ã—Å–æ—Ç—É
      }, 10);

      setTimeout(() => {
        clearInterval(lockInterval);
        // –ö–æ–≥–¥–∞ –∫–ª–∞–≤–∞ –æ—Ç–∫—Ä—ã–ª–∞—Å—å, –¥–æ–∫—Ä—É—á–∏–≤–∞–µ–º —á–∞—Ç –¥–æ –Ω–∏–∑–∞
        setTimeout(scrollToBottom, 50); 
      }, 400);
    });

    // –¢–∞–∫–∂–µ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞ –æ–±–Ω–æ–≤–ª—è–µ–º
    input.addEventListener('blur', () => {
      setTimeout(handleResize, 100);
    });

    // ============================================================
    // LOGIC
    // ============================================================
    let messages = [];
    
    function scrollToBottom() {
      chat.scrollTop = chat.scrollHeight;
    }

    function render() {
      // –ü—Ä–æ—Å—Ç–∞—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ (–¥–ª—è —Ç–µ—Å—Ç–∞)
      const saved = localStorage.getItem('msgs');
      if(saved) messages = JSON.parse(saved);
      
      chat.innerHTML = '';
      if(messages.length === 0) {
         chat.innerHTML = '<div class="msg ai" style="margin: auto 0;">–ü—Ä–∏–≤–µ—Ç! –ù–∞—á–Ω–∏ –¥–∏–∞–ª–æ–≥.</div>';
      }
      messages.forEach(m => {
        const div = document.createElement('div');
        div.className = `msg ${m.role}`;
        div.textContent = m.text;
        chat.appendChild(div);
      });
      scrollToBottom();
    }

    async function send() {
      const text = input.value.trim();
      if(!text) return;
      
      window.Telegram?.WebApp?.HapticFeedback?.impactOccurred('light');

      messages.push({ role:'user', text });
      localStorage.setItem('msgs', JSON.stringify(messages));
      render();
      
      input.value = '';
      input.style.height = 'auto';
      
      // Fake AI Delay & Fetch
      const tempId = Date.now();
      messages.push({ role:'ai', text:'...', id:tempId });
      render();

      // Backend
      try {
        const u = window.Telegram?.WebApp?.initDataUnsafe?.user || {};
        const uid = u.id || 'debug';
        
        const res = await fetch(BACKEND_URL, {
          method: 'POST',
          body: JSON.stringify({
             action: 'send_message',
             user_id: uid,
             message: text,
             user_data: u
          })
        }).then(r => r.json());

        messages = messages.filter(m => m.id !== tempId); // Remove loading
        
        if(res.success) {
           messages.push({ role:'ai', text: res.text });
           window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred('success');
        } else {
           messages.push({ role:'ai', text: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
      } catch(e) {
        messages = messages.filter(m => m.id !== tempId);
        messages.push({ role:'ai', text: '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏' });
      }
      
      localStorage.setItem('msgs', JSON.stringify(messages));
      render();
    }

    // Handlers
    sendBtn.onclick = send;
    input.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 100) + 'px';
    });

    document.getElementById('clearBtn').onclick = () => {
      messages = [];
      localStorage.removeItem('msgs');
      render();
    };

    // Init Load
    render();
  </script>
</body>
</html>
