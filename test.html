<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>AI –ß–∞—Ç</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* === –°–ë–†–û–° –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï === */
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    :root {
      --bg: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --userBubble: rgba(251,191,36,.25);
      --userBorder: rgba(251,191,36,.4);
      --aiBubble: rgba(255,255,255,.18);
      --aiBorder: rgba(255,255,255,.28);
      --inputBg: rgba(255,255,255,.12);
      --inputBorder: rgba(255,255,255,.24);
      --shadow: 0 8px 28px rgba(0,0,0,.18);
      --okA:#fbbf24; --okB:#f59e0b;
      --maxw: 560px;
    }

    /* === –ñ–ï–õ–ï–ó–û–ë–ï–¢–û–ù–ù–ê–Ø –§–ò–ö–°–ê–¶–ò–Ø (–ü—Ä–æ—Ç–∏–≤ –ø—Ä—ã–∂–∫–æ–≤) === */
    html {
      width: 100%; height: 100%;
      overflow: hidden;
      position: fixed;
    }
    body {
      width: 100%; height: 100%;
      overflow: hidden;
      background: var(--bg);
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      position: fixed; /* –î–≤–æ–π–Ω–æ–π –∑–∞–º–æ–∫ */
      top: 0; left: 0;
    }

    /* === –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ô–ù–ï–† (–†–µ—Å–∞–π–∑–∏—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º) === */
    #app-viewport {
      position: absolute;
      top: 0; left: 0; width: 100%;
      height: 100%; /* JS –±—É–¥–µ—Ç –º–µ–Ω—è—Ç—å —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ */
      max-width: var(--maxw);
      margin: 0 auto; /* –¶–µ–Ω—Ç—Ä–æ–≤–∫–∞ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
      left: 50%; transform: translateX(-50%); /* –¶–µ–Ω—Ç—Ä–æ–≤–∫–∞ absolute */
      display: flex; flex-direction: column;
      transition: height 0.1s ease-out; /* –ü–ª–∞–≤–Ω–æ—Å—Ç—å –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ */
    }

    /* === –®–ê–ü–ö–ê === */
    .header {
      flex-shrink: 0; height: 56px;
      display: flex; align-items: center; justify-content: center;
      background: linear-gradient(180deg,var(--aiBubble),rgba(255,255,255,.12));
      border-bottom: 1px solid var(--aiBorder);
      border-radius: 0 0 20px 20px;
      z-index: 20;
      position: relative;
    }
    .header h4 { font-size: 18px; font-weight: 900; letter-spacing: .3px; }
    .clear-btn {
      position: absolute; right: 16px; padding: 6px 12px; border: 0; border-radius: 10px;
      background: rgba(239,68,68,.2); border: 1px solid rgba(239,68,68,.4);
      color: #fff; font-weight: 700; font-size: 13px; cursor: pointer;
    }

    /* === –ß–ê–¢ === */
    .chat-area {
      flex-grow: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px 14px;
      display: flex; flex-direction: column; gap: 12px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none; /* Firefox */
    }
    .chat-area::-webkit-scrollbar { display: none; } /* Chrome/Safari */

    /* –°–æ–æ–±—â–µ–Ω–∏—è */
    .message { display: flex; flex-direction: column; max-width: 85%; animation: slideIn .3s ease; position: relative; }
    @keyframes slideIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
    .message.user { align-self: flex-end; align-items: flex-end; }
    .message.ai { align-self: flex-start; align-items: flex-start; }

    .message-bubble {
      padding: 12px 16px; border-radius: 18px; 
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      box-shadow: var(--shadow); font-size: 15px; line-height: 1.5; word-wrap: break-word;
    }
    .message.user .message-bubble {
      background: linear-gradient(135deg,var(--userBubble),rgba(251,191,36,.2));
      border: 1px solid var(--userBorder); border-bottom-right-radius: 4px;
    }
    .message.ai .message-bubble {
      background: linear-gradient(180deg,var(--aiBubble),rgba(255,255,255,.14));
      border: 1px solid var(--aiBorder); border-bottom-left-radius: 4px;
    }
    .message-time { font-size: 11px; opacity: .7; margin-top: 4px; padding: 0 4px; }

    /* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è */
    .delete-btn {
      position: absolute; top: 50%; transform: translateY(-50%); width: 32px; height: 32px;
      border-radius: 50%; background: rgba(239,68,68,.9); color: #fff; display: none;
      align-items: center; justify-content: center; cursor: pointer; z-index: 10;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .message.user .delete-btn { left: -40px; } .message.ai .delete-btn { right: -40px; }
    .message.show-delete .delete-btn { display: flex; }

    /* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
    .empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: .7; text-align: center; }
    .empty-state-icon { font-size: 64px; margin-bottom: 16px; }
    
    /* === –í–í–û–î === */
    .input-area {
      flex-shrink: 0;
      padding: 12px 14px;
      background: transparent;
      display: flex; gap: 10px; align-items: flex-end;
      z-index: 20;
      /* –í–∞–∂–Ω–æ: padding-bottom –Ω–µ –Ω—É–∂–µ–Ω, —Ä–µ—Å–∞–π–∑ –¥–µ–ª–∞–µ—Ç JS */
    }
    .input-field {
      flex: 1; min-height: 44px; max-height: 120px; padding: 12px 16px;
      border: 1px solid var(--inputBorder); border-radius: 22px;
      background: var(--inputBg); backdrop-filter: blur(8px);
      color: #fff; font-size: 16px; /* 16px = no zoom on iOS */
      font-family: inherit; resize: none; outline: none;
    }
    .input-field:focus { border-color: var(--okA); box-shadow: 0 0 0 3px rgba(251,191,36,.2); }
    
    .send-btn {
      width: 44px; height: 44px; border: 0; border-radius: 50%; flex-shrink: 0;
      background: linear-gradient(135deg,var(--okA),var(--okB));
      color: #fff; display: flex; align-items: center; justify-content: center;
      box-shadow: var(--shadow); transition: .2s;
    }
    .send-btn:disabled { opacity: .5; }

    /* === –ú–û–î–ê–õ–ö–ê === */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.7); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; backdrop-filter: blur(5px); }
    .modal.show { display: flex; }
    .modal-content { background: linear-gradient(180deg,var(--aiBubble),rgba(255,255,255,.12)); border: 1px solid var(--aiBorder); border-radius: 20px; padding: 24px; width: 100%; max-width: 320px; text-align: center; backdrop-filter: blur(20px); box-shadow: 0 20px 60px rgba(0,0,0,.4); }
    .modal h3 { font-size: 18px; font-weight: 900; margin-bottom: 12px; }
    .modal p { font-size: 14px; opacity: .9; margin-bottom: 20px; }
    .modal-buttons { display: flex; gap: 10px; }
    .modal-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; }
    .modal-btn.cancel { background: rgba(255,255,255,.15); color: #fff; }
    .modal-btn.confirm { background: linear-gradient(135deg,var(--okA),var(--okB)); color: #fff; }
  </style>
</head>
<body>

  <div id="app-viewport">
    <div class="header">
      <h4>Ai-–ö–æ—É—á</h4>
      <button class="clear-btn" id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <div class="chat-area" id="chatArea">
      <div class="empty-state" id="emptyState">
        <div class="empty-state-icon">üí¨</div>
        <h2>–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥</h2>
        <p>–ó–∞–¥–∞–π—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É</p>
      </div>
    </div>

    <div class="input-area">
      <textarea class="input-field" id="messageInput" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å..." rows="1"></textarea>
      <button class="send-btn" id="sendBtn" disabled>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
  </div>

  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <h3 id="modalTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
      <p id="modalText">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
      <div class="modal-buttons">
        <button class="modal-btn cancel" id="modalCancel">–û—Ç–º–µ–Ω–∞</button>
        <button class="modal-btn confirm" id="modalConfirm">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    /* ===============================================================
       1. ANTI-JUMP CORE (–Ø–¥—Ä–æ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏)
       =============================================================== */
    const viewport = document.getElementById('app-viewport');
    const input = document.getElementById('messageInput');
    const chatArea = document.getElementById('chatArea');

    // –§—É–Ω–∫—Ü–∏—è —Ä–µ—Å–∞–π–∑–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø–æ–¥ —Ä–µ–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
    function resizeViewport() {
      const h = window.visualViewport ? window.visualViewport.height : window.innerHeight;
      const offset = window.visualViewport ? window.visualViewport.offsetTop : 0;
      
      viewport.style.height = `${h}px`;
      viewport.style.top = `${offset}px`;
      
      // –î–æ–∫—Ä—É—Ç–∫–∞ —á–∞—Ç–∞ –≤–Ω–∏–∑, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –≤–Ω–∏–∑—É
      scrollToBottom();
    }

    // –°–ª—É—à–∞—Ç–µ–ª–∏ —Ä–µ—Å–∞–π–∑–∞
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', resizeViewport);
      window.visualViewport.addEventListener('scroll', resizeViewport);
    } else {
      window.addEventListener('resize', resizeViewport);
    }
    resizeViewport(); // –°—Ç–∞—Ä—Ç

    // === –•–ê–ö: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–∫—Ä–æ–ª–ª–∞ body –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ ===
    input.addEventListener('focus', () => {
      // –ö–∞–∂–¥—ã–µ 10–º—Å –≤ —Ç–µ—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∞–Ω–∏–º–∞—Ü–∏–∏ (400–º—Å) –ø—Ä–∏–±–∏–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª –∫ –≤–µ—Ä—Ö—É
      const lockInterval = setInterval(() => {
        window.scrollTo(0, 0);
        document.body.scrollTop = 0;
        resizeViewport();
      }, 10);

      setTimeout(() => {
        clearInterval(lockInterval);
        setTimeout(scrollToBottom, 50); // –§–∏–Ω–∞–ª—å–Ω–∞—è –¥–æ–∫—Ä—É—Ç–∫–∞
      }, 400);
    });

    input.addEventListener('blur', () => setTimeout(resizeViewport, 100));


    /* ===============================================================
       2. APP LOGIC (–ë—ç–∫–µ–Ω–¥ –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
       =============================================================== */
    
    // --- Init Telegram ---
    (function initTMA(){
      const tg = window.Telegram?.WebApp;
      if(tg){ 
          tg.ready(); 
          tg.expand(); 
          tg.setHeaderColor?.('secondary_bg_color');
          if (tg.isVersionAtLeast?.('6.1')) tg.disableVerticalSwipes?.();
          tg.disableClosingConfirmation?.();
          
          // –ö–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥
          const HOME = './router.html'; // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ
          tg.BackButton?.offClick?.();
          tg.BackButton?.show?.();
          tg.BackButton?.onClick?.(()=>{ location.href = HOME; });
      }
    })();

    // --- Config ---
    // –¢–í–û–ô –°–£–©–ï–°–¢–í–£–Æ–©–ò–ô URL:
    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbzvlDKUH6qsON-A6iSHYvMU_6XWtReZc5oXnnZOMTgETfvZqMMh2zUbdQJF-iOanMBc/exec';
    const TIMEOUT = 45000;

    let messages = [];
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const emptyState = document.getElementById('emptyState');

    // --- Helpers ---
    function scrollToBottom() {
      requestAnimationFrame(() => { chatArea.scrollTop = chatArea.scrollHeight; });
    }
    function formatTime(ts) {
      const d = new Date(ts);
      return String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
    }

    // --- Render ---
    function render() {
      // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è, –æ—Å—Ç–∞–≤–ª—è–µ–º emptyState
      Array.from(chatArea.children).forEach(c => { if(c.id !== 'emptyState') c.remove(); });
      
      if(messages.length === 0) {
        emptyState.style.display = 'flex';
      } else {
        emptyState.style.display = 'none';
        messages.forEach((m, i) => chatArea.appendChild(createMsgEl(m, i)));
      }
      scrollToBottom();
    }

    function createMsgEl(m, index) {
      const div = document.createElement('div');
      div.className = `message ${m.role}`;
      
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.textContent = m.content;
      
      // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
      const delBtn = document.createElement('div');
      delBtn.className = 'delete-btn';
      delBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6"/></svg>';
      delBtn.onclick = (e) => { e.stopPropagation(); confirmDelete(index); };
      
      // Long press
      let timer;
      const showDel = () => { 
          div.classList.add('show-delete');
          window.Telegram?.WebApp?.HapticFeedback?.impactOccurred('medium');
      };
      bubble.addEventListener('touchstart', () => timer = setTimeout(showDel, 500));
      bubble.addEventListener('touchend', () => clearTimeout(timer));

      const time = document.createElement('div');
      time.className = 'message-time';
      time.textContent = formatTime(m.timestamp);

      div.appendChild(delBtn);
      div.appendChild(bubble);
      div.appendChild(time);
      return div;
    }

    // --- API ---
    async function sendMessage() {
      const text = input.value.trim();
      if(!text) return;
      
      window.Telegram?.WebApp?.HapticFeedback?.impactOccurred('light');

      // Local Add
      messages.push({ role:'user', content:text, timestamp:Date.now() });
      save();
      render();
      
      input.value = '';
      input.style.height = 'auto';
      sendBtn.disabled = true;

      // Fake AI Loading
      const loadingId = Date.now();
      messages.push({ role:'ai', content:'...', timestamp:loadingId });
      render();

      try {
        const u = window.Telegram?.WebApp?.initDataUnsafe?.user || {};
        const uid = u.id || localStorage.getItem('debug_uid') || 'd-'+Math.floor(Math.random()*1e9);
        if(!u.id) localStorage.setItem('debug_uid', uid);

        // FETCH
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), TIMEOUT);
        
        const res = await fetch(BACKEND_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({
             action: 'send_message',
             user_id: uid,
             message: text,
             user_data: { first_name: u.first_name, username: u.username },
             init_data: window.Telegram?.WebApp?.initData || ''
          }),
          signal: controller.signal
        }).then(r => r.json());
        clearTimeout(id);

        // Remove loading
        messages.pop(); 

        if(res.success) {
           messages.push({ role:'ai', content: res.text || '–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç', timestamp:Date.now() });
           window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred('success');
        } else {
           messages.push({ role:'ai', content: `–û—à–∏–±–∫–∞: ${res.error || res.code}`, timestamp:Date.now() });
           window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred('error');
        }
      } catch(e) {
        messages.pop();
        messages.push({ role:'ai', content: '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Ç–∞–π–º-–∞—É—Ç', timestamp:Date.now() });
      }
      
      save();
      render();
    }

    // --- Utils ---
    function save() { localStorage.setItem('ai_chat_messages', JSON.stringify(messages)); }
    function load() { 
        const s = localStorage.getItem('ai_chat_messages'); 
        if(s) { messages = JSON.parse(s); render(); }
    }

    input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        sendBtn.disabled = !this.value.trim();
    });
    sendBtn.onclick = sendMessage;

    // --- Modals ---
    const modal = document.getElementById('confirmModal');
    const mTitle = document.getElementById('modalTitle');
    const mText = document.getElementById('modalText');
    let modalAction = null;

    function confirmDelete(i) {
        mTitle.textContent = '–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?';
        mText.textContent = '–î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.';
        modalAction = () => { messages.splice(i, 1); save(); render(); };
        modal.classList.add('show');
    }
    
    clearBtn.onclick = () => {
        if(!messages.length) return;
        mTitle.textContent = '–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?';
        mText.textContent = '–£–¥–∞–ª–∏—Ç –ø–µ—Ä–µ–ø–∏—Å–∫—É –ª–æ–∫–∞–ª—å–Ω–æ –∏ –Ω–∞—á–Ω–µ—Ç—Å—è –Ω–æ–≤—ã–π —Ç—Ä–µ–¥.';
        modalAction = async () => { 
            messages = []; save(); render();
            // Async call to clear backend
            const u = window.Telegram?.WebApp?.initDataUnsafe?.user || {};
            const uid = u.id || localStorage.getItem('debug_uid');
            fetch(BACKEND_URL, { method:'POST', body:JSON.stringify({action:'clear_history', user_id: uid}) }).catch(()=>{});
        };
        modal.classList.add('show');
    }

    document.getElementById('modalCancel').onclick = () => modal.classList.remove('show');
    document.getElementById('modalConfirm').onclick = () => { if(modalAction) modalAction(); modal.classList.remove('show'); };

    document.addEventListener('click', (e) => {
       document.querySelectorAll('.show-delete').forEach(el => el.classList.remove('show-delete'));
    });

    // START
    load();
  </script>
</body>
</html>
