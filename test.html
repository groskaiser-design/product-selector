<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Ultima Dashboard</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root {
    /* --- COLOR PALETTE (Deep Space) --- */
    --bg-core: #050505;
    --accent-primary: #6c5ce7; /* Royal Purple */
    --accent-secondary: #00cec9; /* Cyan */
    --accent-warn: #fdcb6e;    /* Amber */
    --accent-danger: #ff7675;  /* Soft Red */
    
    --text-main: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.55);
    
    /* --- SURFACES --- */
    /* –°–µ–∫—Ä–µ—Ç –ø—Ä–µ–º–∏—É–º–∞: –Ω–µ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å, –∞ —Å–ª–æ–∂–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç + —à—É–º */
    --surface-glass: rgba(255, 255, 255, 0.08);
    --surface-border: rgba(255, 255, 255, 0.12);
    --surface-border-light: rgba(255, 255, 255, 0.25);
    
    /* --- METRICS --- */
    --radius-xl: 28px;
    --radius-l: 22px;
    --radius-m: 16px;
    --pad: 16px;
    --gap: 12px;
  }

  /* === RESET & BASE === */
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body {
    background-color: var(--bg-core);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, sans-serif;
    color: var(--text-main);
    min-height: 100vh;
    overflow-x: hidden;
    /* –§–∏–∫—Å "—Ä–µ–∑–∏–Ω–∫–∏" –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞ iOS */
    overscroll-behavior-y: none;
    -webkit-font-smoothing: antialiased;
  }

 
  /* === BACKGROUND FX (OPTIMIZED) === */
  .fx-layer {
    position: fixed; inset: 0; z-index: -1; overflow: hidden; 
    pointer-events: none;
    /* –ò–∑–æ–ª–∏—Ä—É–µ–º —Å–ª–æ–π, —á—Ç–æ–±—ã —Å–∫—Ä–æ–ª–ª –Ω–µ –∑–∞—Å—Ç–∞–≤–ª—è–ª –µ–≥–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞—Ç—å—Å—è */
    transform: translate3d(0,0,0);
    contain: strict; 
  }

  /* –û—Ä–±—ã (–ü—è—Ç–Ω–∞ —Å–≤–µ—Ç–∞) */
  .orb {
    position: absolute; 
    border-radius: 50%; 
    opacity: 0.5;
    /* –£–ë–†–ê–õ–ò filter: blur - —ç—Ç–æ —É–±–∏–≤–∞–ª–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å */
    /* –î–û–ë–ê–í–ò–õ–ò will-change –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏ –±—Ä–∞—É–∑–µ—Ä—É */
    will-change: transform;
    animation: float 25s infinite linear; 
  }

  .orb-1 { 
    /* –£–≤–µ–ª–∏—á–∏–ª–∏ —Ä–∞–∑–º–µ—Ä, —á—Ç–æ–±—ã –∏–º–∏—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–º—ã—Ç–∏–µ –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º */
    width: 500px; height: 500px; 
    top: -15%; left: -25%;
    /* –ì—Ä–∞–¥–∏–µ–Ω—Ç –≤–º–µ—Å—Ç–æ –∑–∞–ª–∏–≤–∫–∏ —Å –±–ª—é—Ä–æ–º */
    background: radial-gradient(circle, var(--accent-primary) 0%, transparent 70%);
  }

  .orb-2 { 
    width: 450px; height: 450px; 
    bottom: 5%; right: -25%; 
    background: radial-gradient(circle, var(--accent-secondary) 0%, transparent 70%);
    animation-direction: reverse; 
  }
  
  /* –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è —Å 3D —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–µ–π */
  @keyframes float {
    0% { transform: translate3d(0, 0, 0) rotate(0deg); }
    33% { transform: translate3d(30px, 50px, 0) rotate(120deg); }
    66% { transform: translate3d(-20px, 20px, 0) rotate(240deg); }
    100% { transform: translate3d(0, 0, 0) rotate(360deg); }
  }

  /* === LAYOUT === */
  .app-shell {
    max-width: 480px; margin: 0 auto;
    padding: var(--pad);
    padding-top: calc(var(--pad) + env(safe-area-inset-top));
    padding-bottom: calc(40px + env(safe-area-inset-bottom));
    display: flex; flex-direction: column; gap: 24px;
  }

  /* === 1. HEADER === */
  .header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 4px 0;
  }
  .profile-lockup { display: flex; align-items: center; gap: 12px; }
  
  .avatar-box {
    width: 44px; height: 44px; border-radius: 50%;
    /* –≠—Ñ—Ñ–µ–∫—Ç –¥–≤–æ–π–Ω–æ–π —Ä–∞–º–∫–∏ */
    box-shadow: 0 0 0 2px rgba(255,255,255,0.1), 0 0 0 4px rgba(0,0,0,0.2);
    background: #222; overflow: hidden; position: relative;
  }
  .avatar-img { width: 100%; height: 100%; object-fit: cover; display: block; }
  .avatar-placeholder {
    width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
    background: linear-gradient(135deg, #333, #444); font-weight: 700; color: #fff;
  }

  .user-text h1 { font-size: 20px; font-weight: 800; line-height: 1.1; letter-spacing: 0.3px; }
  .user-text p { font-size: 12px; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }

  .icon-btn {
    width: 40px; height: 40px; border-radius: 50%;
    background: var(--surface-glass);
    border: 1px solid var(--surface-border);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: transform 0.1s;
  }
  .icon-btn:active { transform: scale(0.92); background: rgba(255,255,255,0.15); }

  /* === 2. WIDGETS (CAROUSEL) === */
  .widgets-container {
    /* –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ä–¥–∂–∏–Ω—ã –¥–ª—è –≤—ã—Ö–æ–¥–∞ –∑–∞ –ø–∞–¥–¥–∏–Ω–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
    margin: 0 calc(var(--pad) * -1);
  }
  
  .carousel {
    display: flex; gap: 12px;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    padding: 0 var(--pad) 20px var(--pad); /* –ü–∞–¥–¥–∏–Ω–≥–∏ –≤–Ω—É—Ç—Ä–∏ —Å–∫—Ä–æ–ª–ª–∞ */
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  .carousel::-webkit-scrollbar { display: none; }

  .widget {
    /* Peeking logic: 100% —à–∏—Ä–∏–Ω—ã –º–∏–Ω—É—Å –æ—Ç—Å—Ç—É–ø, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –∫—Ä–∞–π —Å–ª–µ–¥—É—é—â–µ–≥–æ */
    flex: 0 0 calc(100% - 20px); 
    scroll-snap-align: center;
    height: 170px;
    border-radius: var(--radius-xl);
    background: linear-gradient(165deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.02) 100%);
    border: 1px solid var(--surface-border);
    border-top: 1px solid var(--surface-border-light); /* –°–≤–µ—Ç —Å–≤–µ—Ä—Ö—É */
    backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    position: relative; overflow: hidden;
    transition: transform 0.2s;
  }
  .widget:active { transform: scale(0.98); }

  /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –≤–∏–¥–∂–µ—Ç–∞ (–ö–ë–ñ–£) */
  .w-body {
    position: absolute; inset: 0; padding: 22px;
    display: flex; align-items: center; justify-content: space-between;
  }
  
  .w-info { display: flex; flex-direction: column; justify-content: center; height: 100%; z-index: 2; }
  .w-label { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 4px; }
  .w-value { font-size: 36px; font-weight: 800; line-height: 1; letter-spacing: -1px; }
  .w-sub { font-size: 14px; color: var(--text-muted); margin-top: 6px; font-weight: 500; }
  
  /* –ö—Ä—É–≥–æ–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å */
  .w-chart { position: relative; width: 110px; height: 110px; display: flex; align-items: center; justify-content: center; }
  .ring-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
  .ring-track { fill: none; stroke: rgba(255,255,255,0.08); stroke-width: 8; }
  .ring-fill { 
    fill: none; stroke: url(#grad-ring); stroke-width: 8; stroke-linecap: round;
    stroke-dasharray: 283; /* 2 * PI * 45 */
    stroke-dashoffset: 283; /* –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS */
    transition: stroke-dashoffset 1.2s cubic-bezier(0.2, 0.8, 0.2, 1);
  }
  .w-icon { position: absolute; font-size: 28px; }

  /* –ü–∞–≥–∏–Ω–∞—Ü–∏—è */
  .dots { display: flex; justify-content: center; gap: 6px; margin-top: -8px; }
  .dot { width: 6px; height: 6px; border-radius: 10px; background: rgba(255,255,255,0.2); transition: 0.3s; }
  .dot.active { width: 24px; background: #fff; }

  /* === 3. BENTO GRID === */
  .grid-title { font-size: 17px; font-weight: 700; margin-bottom: 12px; margin-left: 4px; opacity: 0.9; }

  .grid-container {
    display: grid;
    grid-template-columns: 1fr 1fr; /* 2 –∫–æ–ª–æ–Ω–∫–∏ */
    gap: var(--gap);
    grid-auto-flow: dense; /* –ó–∞–ø–æ–ª–Ω—è—Ç—å –¥—ã—Ä–∫–∏ */
  }

  /* –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –ø–ª–∏—Ç–∫–∞ */
  .tile {
    background: var(--surface-glass);
    border: 1px solid var(--surface-border);
    border-radius: var(--radius-l);
    padding: 16px;
    position: relative; overflow: hidden;
    display: flex; flex-direction: column; justify-content: space-between;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
  }
  .tile:active { background: rgba(255,255,255,0.12); transform: scale(0.97); }

  /* –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã —Ä–∞–∑–º–µ—Ä–∞ */
  .tile.tall { grid-row: span 2; background: linear-gradient(145deg, #48bfe3 0%, #5e60ce 100%); border: none; }
  .tile.wide { grid-column: span 2; flex-direction: row; align-items: center; justify-content: flex-start; gap: 16px; height: 84px; }
  .tile.std  { aspect-ratio: 1; }

  /* –ö–æ–Ω—Ç–µ–Ω—Ç –ø–ª–∏—Ç–∫–∏ */
  .t-icon-box {
    width: 38px; height: 38px; border-radius: 12px;
    background: rgba(255,255,255,0.1);
    display: flex; align-items: center; justify-content: center;
    margin-bottom: auto; /* –ü—Ä–∏–∂–∞—Ç—å –≤–≤–µ—Ä—Ö –≤ Tall/Std */
  }
  .wide .t-icon-box { margin-bottom: 0; } /* –í Wide –ø–æ —Ü–µ–Ω—Ç—Ä—É */
  
  .t-icon-img { width: 22px; height: 22px; object-fit: contain; opacity: 0.95; }
  
  .t-info { margin-top: 8px; }
  .wide .t-info { margin-top: 0; }
  
  .t-title { font-size: 15px; font-weight: 700; line-height: 1.2; }
  .t-sub { font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 2px; font-weight: 500; }
  
  /* –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –∞–∫—Ü–µ–Ω—Ç–Ω–æ–π –ø–ª–∏—Ç–∫–µ */
  .tall .t-title, .tall .t-sub { color: #fff; opacity: 1; }
  .tall .t-sub { opacity: 0.8; }

  /* –ú–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫ –≤ Wide –ø–ª–∏—Ç–∫–µ */
  .mini-graph {
    margin-left: auto; display: flex; align-items: flex-end; gap: 4px; height: 30px; opacity: 0.8;
  }
  .g-bar { width: 6px; border-radius: 2px; background: #fff; opacity: 0.5; }
  .g-bar.active { opacity: 1; background: var(--accent-secondary); }

  /* === 4. SETTINGS LIST === */
  .settings-box {
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--surface-border);
    border-radius: var(--radius-l);
    overflow: hidden;
  }
  .set-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.05);
    cursor: pointer;
  }
  .set-row:last-child { border-bottom: none; }
  .set-row:active { background: rgba(255,255,255,0.05); }
  
  .set-left { display: flex; align-items: center; gap: 12px; font-weight: 600; font-size: 15px; }
  .set-icon { width: 20px; opacity: 0.7; }
  .set-arrow { opacity: 0.3; transform: rotate(-90deg); font-size: 12px; }

  /* === LOADING STATE === */
  #loader { position: fixed; inset: 0; background: #050505; z-index: 2000; display: flex; align-items: center; justify-content: center; transition: opacity 0.4s; }
  .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.2); border-top-color: var(--accent-secondary); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .hidden { opacity: 0; pointer-events: none; }

</style>
</head>
<body>

<div class="fx-layer">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="noise"></div>
</div>

<div id="loader"><div class="spinner"></div></div>

<div class="app-shell">
  
  <div class="header">
    <div class="profile-lockup">
      <div class="avatar-box" id="userAvatar">
        <div class="avatar-placeholder">?</div>
      </div>
      <div class="user-text">
        <p>–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º,</p>
        <h1 id="userName">–ì–æ—Å—Ç—å</h1>
      </div>
    </div>
    <div class="icon-btn" onclick="haptic('light')">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
    </div>
  </div>

  <div>
    <div class="widgets-container">
      <div class="carousel" id="carouselTrack">
        </div>
    </div>
    <div class="dots" id="carouselDots"></div>
  </div>

  <div>
    <div class="grid-title">–î–Ω–µ–≤–Ω–∏–∫</div>
    <div class="grid-container" id="diaryGrid">
      </div>
  </div>

  <div>
    <div class="grid-title">–¢–µ–ª–æ & –ü—Ä–æ–≥—Ä–µ—Å—Å</div>
    <div class="grid-container" id="bodyGrid">
      </div>
  </div>

  <div>
    <div class="grid-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    <div class="settings-box" id="settingsList">
      </div>
  </div>

</div>

<script>
  /* ============================================================
     CONFIGURATION (SINGLE SOURCE OF TRUTH)
     –í –±—É–¥—É—â–µ–º —ç—Ç–æ—Ç JSON –±—É–¥–µ—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å —Å –±—ç–∫–∞/—Ç–∞–±–ª–∏—Ü—ã.
     ============================================================ */
  const CONFIG = {
    version: 1,
    iconBase: 'https://groskaiser-design.github.io/icons/',
    
    widgets: [
      {
        id: 'w_kbju',
        type: 'progress',
        label: '–≠–Ω–µ—Ä–≥–∏—è',
        valCurrent: 1250,
        valMax: 2100,
        unit: '–∫–∫–∞–ª',
        icon: 'üî•',
        accent1: '#48bfe3',
        accent2: '#5e60ce'
      },
      {
        id: 'w_tip',
        type: 'card',
        label: '–°–æ–≤–µ—Ç –¥–Ω—è',
        title: '–ü–µ–π—Ç–µ –≤–æ–¥—É –∑–∞ 20 –º–∏–Ω –¥–æ –µ–¥—ã',
        subtitle: '–≠—Ç–æ —É–ª—É—á—à–∞–µ—Ç –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏–µ',
        icon: 'üíß',
        accent1: '#fdcb6e',
        accent2: '#fab1a0'
      }
    ],

    menu: [
      // section: 'diary' | 'body' | 'settings'
      // layout: 'tall' (2 rows) | 'wide' (2 cols) | 'std' (1x1)
      
      { id: 'scanner', section: 'diary', layout: 'tall', title: '–°–∫–∞–Ω–µ—Ä –µ–¥—ã', sub: '–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–µ–º', icon: 'diary.svg', link: 'scanner.html' },
      { id: 'kbju',    section: 'diary', layout: 'std',  title: '–ü–ª–∞–Ω',       sub: '–ö–ë–ñ–£',           icon: 'clipboard.svg', link: 'kbju.html' },
      { id: 'menu',    section: 'diary', layout: 'std',  title: '–†–∞—Ü–∏–æ–Ω',     sub: '–ú–µ–Ω—é –¥–Ω—è',       icon: 'menu.svg',      link: '#' },
      
      { id: 'measure', section: 'body',  layout: 'wide', title: '–ó–∞–º–µ—Ä—ã',     sub: '–û–±–Ω–æ–≤–∏—Ç—å –≤–µ—Å',   icon: 'scales.svg',    link: 'measurements.html' },
      { id: 'ai',      section: 'body',  layout: 'std',  title: 'AI –ö–æ—É—á',    sub: '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç',      icon: 'ai.svg',        link: 'ai.html' },
      { id: 'analyt',  section: 'body',  layout: 'std',  title: '–ê–Ω–∞–ª–∏–∑',     sub: '–ì—Ä–∞—Ñ–∏–∫–∏',        icon: 'analytics.svg', link: '2.html' },
      
      { id: 'profile', section: 'settings', icon: 'profile.svg', title: '–ü—Ä–æ—Ñ–∏–ª—å', link: '#' },
      { id: 'subs',    section: 'settings', icon: 'rub.svg',     title: '–ü–æ–¥–ø–∏—Å–∫–∞ PRO', link: '#' },
      { id: 'help',    section: 'settings', icon: 'question.svg', title: '–ü–æ–º–æ—â—å', link: '#' }
    ]
  };

  /* ============================================================
     APP LOGIC
     ============================================================ */
  
  const tg = window.Telegram?.WebApp;
  
  // 1. INIT
  function initApp() {
    if (tg) {
      tg.ready();
      tg.expand();
      tg.setHeaderColor('#050505');
      tg.setBackgroundColor('#050505');
      tg.BackButton?.hide();
    }
    
    loadProfile();
    renderWidgets();
    renderMenu();
    
    // Hide loader after slight delay for smoothness
    setTimeout(() => document.getElementById('loader').classList.add('hidden'), 300);
  }

  // 2. PROFILE
  function loadProfile() {
    const u = tg?.initDataUnsafe?.user || { first_name: '–ì–æ—Å—Ç—å' };
    document.getElementById('userName').textContent = u.first_name;
    if (u.photo_url) {
      document.getElementById('userAvatar').innerHTML = `<img src="${u.photo_url}" class="avatar-img">`;
    }
  }

  // 3. RENDER WIDGETS
  function renderWidgets() {
    const track = document.getElementById('carouselTrack');
    const dotsBox = document.getElementById('carouselDots');
    
    CONFIG.widgets.forEach((w, i) => {
      // --- Widget HTML ---
      const el = document.createElement('div');
      el.className = 'widget';
      
      if (w.type === 'progress') {
        // Calculate ring stroke offset
        const radius = 45;
        const circumference = 2 * Math.PI * radius; // ~283
        const percent = Math.min(100, Math.max(0, (w.valCurrent / w.valMax) * 100));
        const offset = circumference - (percent / 100) * circumference;

        el.innerHTML = `
          <div class="w-body">
            <div class="w-info">
              <div class="w-label">${w.label}</div>
              <div class="w-value">${w.valCurrent}</div>
              <div class="w-sub">–∏–∑ ${w.valMax} ${w.unit}</div>
            </div>
            <div class="w-chart">
              <svg class="ring-svg" viewBox="0 0 100 100">
                <defs>
                  <linearGradient id="grad-ring-${i}" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:${w.accent1};stop-opacity:1" />
                    <stop offset="100%" style="stop-color:${w.accent2};stop-opacity:1" />
                  </linearGradient>
                </defs>
                <circle class="ring-track" cx="50" cy="50" r="${radius}" />
                <circle class="ring-fill" cx="50" cy="50" r="${radius}" 
                  style="stroke: url(#grad-ring-${i}); stroke-dasharray: ${circumference}; stroke-dashoffset: ${offset};" />
              </svg>
              <div class="w-icon">${w.icon}</div>
            </div>
          </div>
        `;
      } else {
        // Info Card Widget
        el.innerHTML = `
          <div class="w-body">
            <div class="w-info">
              <div class="w-label" style="color:${w.accent1}">${w.label}</div>
              <div class="w-value" style="font-size:22px; line-height:1.3">${w.title}</div>
              <div class="w-sub">${w.subtitle}</div>
            </div>
            <div class="w-chart">
              <div class="w-icon" style="font-size:48px">${w.icon}</div>
            </div>
          </div>
        `;
      }
      
      el.onclick = () => haptic('medium');
      track.appendChild(el);

      // --- Dot HTML ---
      const dot = document.createElement('div');
      dot.className = `dot ${i===0 ? 'active' : ''}`;
      dotsBox.appendChild(dot);
    });

    // Scroll Observer
    const observer = new IntersectionObserver(entries => {
      entries.forEach(e => {
        if (e.isIntersecting) {
          const idx = Array.from(track.children).indexOf(e.target);
          Array.from(dotsBox.children).forEach((d, ii) => d.classList.toggle('active', ii === idx));
        }
      });
    }, { root: track, threshold: 0.6 });
    
    Array.from(track.children).forEach(c => observer.observe(c));
  }

  // 4. RENDER MENU
  function renderMenu() {
    const diaryBox = document.getElementById('diaryGrid');
    const bodyBox  = document.getElementById('bodyGrid');
    const setBox   = document.getElementById('settingsList');

    CONFIG.menu.forEach(item => {
      const iconUrl = CONFIG.iconBase + item.icon;
      
      // --- SETTINGS LIST ---
      if (item.section === 'settings') {
        const row = document.createElement('div');
        row.className = 'set-row';
        row.onclick = () => nav(item.link);
        row.innerHTML = `
          <div class="set-left">
            <img src="${iconUrl}" class="set-icon"> ${item.title}
          </div>
          <div class="set-arrow">‚åÑ</div>
        `;
        setBox.appendChild(row);
        return;
      }

      // --- BENTO TILES ---
      const tile = document.createElement('div');
      tile.className = `tile ${item.layout}`;
      tile.onclick = () => nav(item.link);

      // Content Logic
      let html = `
        <div class="t-icon-box">
          <img src="${iconUrl}" class="t-icon-img">
        </div>
        <div class="t-info">
          <div class="t-title">${item.title}</div>
          <div class="t-sub">${item.sub}</div>
        </div>
      `;

      // Add Mini-Graph for Wide tiles (Decor)
      if (item.layout === 'wide') {
        html += `
          <div class="mini-graph">
            <div class="g-bar" style="height:40%"></div>
            <div class="g-bar" style="height:60%"></div>
            <div class="g-bar" style="height:50%"></div>
            <div class="g-bar active" style="height:80%"></div>
          </div>
        `;
      }

      tile.innerHTML = html;

      // Append to correct container
      if (item.section === 'diary') diaryBox.appendChild(tile);
      else if (item.section === 'body') bodyBox.appendChild(tile);
    });
  }

  // 5. ACTIONS
  function haptic(style='light') {
    try { tg?.HapticFeedback?.impactOccurred(style); } catch(e){}
  }

  function nav(url) {
    haptic('light');
    if (!url || url === '#') {
      tg?.showPopup({ title: '–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', message: '–≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è.' });
      return;
    }
    // Ripple delay
    setTimeout(() => window.location.href = url, 80);
  }

  // BOOT
  document.addEventListener('DOMContentLoaded', initApp);

</script>
</body>
</html>
