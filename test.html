<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
  <title>AI Чат</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    :root {
      --bg: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --userBubble: rgba(251,191,36,.25);
      --aiBubble: rgba(255,255,255,.18);
      --maxw: 560px;
    }

    html {
      background-color: #000; /* Черный фон подложки, чтобы не было белых полос */
    }

    body {
      margin: 0; 
      padding: 0;
      width: 100%;
      background: var(--bg);
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      overflow: hidden; /* ЗАПРЕЩАЕМ СКРОЛЛ ВСЕЙ СТРАНИЦЫ */
      height: 100vh; /* Фоллбэк */
    }

    /* Главная обертка */
    #app {
      display: flex;
      flex-direction: column;
      margin: 0 auto;
      max-width: var(--maxw);
      height: 100%; /* Будет перезаписано JS */
      position: relative;
      overflow: hidden; /* Важно */
    }

    .header {
      flex-shrink: 0; height: 50px;
      display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.2); font-weight: bold;
      position: relative;
      z-index: 10;
    }
    .clear-btn {
      position: absolute; right: 15px; font-size: 12px; 
      background: rgba(255,0,0,0.3); border:none; color:#fff; padding:4px 8px; border-radius:4px;
    }

    /* Чат: резиновый */
    .chat-area {
      flex-grow: 1;
      overflow-y: auto; /* Скролл только здесь */
      padding: 15px;
      display: flex; flex-direction: column; gap: 10px;
      -webkit-overflow-scrolling: touch;
    }
    /* Скроллбар */
    .chat-area::-webkit-scrollbar { width: 4px; }
    .chat-area::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); }

    .message { padding: 10px 14px; border-radius: 14px; max-width: 85%; word-wrap: break-word; font-size: 15px; line-height: 1.4; }
    .message.user { align-self: flex-end; background: var(--userBubble); }
    .message.ai { align-self: flex-start; background: var(--aiBubble); }
    .time { font-size: 10px; opacity: 0.6; margin-top: 4px; text-align: right; }

    /* Ввод: лежит в потоке (не fixed) */
    .input-area {
      flex-shrink: 0;
      background: rgba(0,0,0,0.2);
      backdrop-filter: blur(10px);
      padding: 10px;
      display: flex; gap: 10px; align-items: flex-end;
    }
    
    textarea {
      flex: 1; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
      border-radius: 18px; padding: 10px 14px; color: #fff; font-size: 16px; /* 16px чтобы iOS не зумил */
      max-height: 100px; resize: none; outline: none; font-family: inherit;
    }
    
    button {
      width: 40px; height: 40px; border-radius: 50%; border: none;
      background: #fbbf24; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }

    /* Модалка */
    .modal { position: fixed; inset:0; background:rgba(0,0,0,0.7); display:none; align-items:center; justify-content:center; z-index:100; }
    .modal.show { display:flex; }
    .modal-box { background:#222; padding:20px; border-radius:12px; text-align:center; min-width:250px; }
    .modal-btns { margin-top:15px; display:flex; gap:10px; }
    .modal-btns button { flex:1; border-radius:6px; }
  </style>
</head>
<body>

  <div id="app">
    <div class="header">
      AI Чат
      <button class="clear-btn" id="clearBtn">Сброс</button>
    </div>

    <div class="chat-area" id="chatArea">
      <div class="message ai">Привет!</div>
    </div>

    <div class="input-area">
      <textarea id="messageInput" rows="1" placeholder="Сообщение..."></textarea>
      <button id="sendBtn">➤</button>
    </div>
  </div>

  <div class="modal" id="confirmModal">
    <div class="modal-box">
      <h3>Удалить?</h3>
      <div class="modal-btns">
        <button id="modalCancel" style="background:#444; color:#fff">Нет</button>
        <button id="modalConfirm" style="background:#ef4444; color:#fff">Да</button>
      </div>
    </div>
  </div>

  <script>
    // ===========================================================
    // 1. STABLE VIEWPORT (OFFICIAL TELEGRAM API)
    // ===========================================================
    const app = document.getElementById('app');
    const chatArea = document.getElementById('chatArea');
    const input = document.getElementById('messageInput');
    const tg = window.Telegram?.WebApp;

    // Главная функция установки высоты
    function setAppHeight() {
        // Если мы в Телеграме, берем высоту ИЗ SDK. Она уже вычла клавиатуру.
        if (tg && tg.viewportHeight) {
            app.style.height = `${tg.viewportHeight}px`;
        } else {
            // Фолбэк для браузера
            app.style.height = `${window.innerHeight}px`;
        }
    }

    if (tg) {
        tg.ready();
        tg.expand(); // Раскрываем на всю
        
        // Слушаем официальное событие изменения вьюпорта
        // Телеграм сам скажет, когда клавиатура открылась и какая теперь высота
        tg.onEvent('viewportChanged', ({ isStateStable }) => {
            setAppHeight();
            // Если состояние стабильно (анимация закончилась), докручиваем скролл
            if (isStateStable) {
                scrollToBottom();
            }
        });
    }
    
    // На всякий случай слушаем и обычный ресайз
    window.addEventListener('resize', setAppHeight);
    
    // Запуск при старте
    setAppHeight();

    // Маленький фикс: при фокусе скроллим чат вниз через небольшую задержку,
    // чтобы убедиться, что клавиатура не перекрыла последнее сообщение
    input.addEventListener('focus', () => {
        setTimeout(scrollToBottom, 300);
    });


    // ===========================================================
    // 2. ТВОЯ ЛОГИКА
    // ===========================================================
    
    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbzvlDKUH6qsON-A6iSHYvMU_6XWtReZc5oXnnZOMTgETfvZqMMh2zUbdQJF-iOanMBc/exec';
    let messages = [];

    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');

    function formatTime(ts) {
       const d = new Date(ts);
       return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
    }

    function scrollToBottom() {
       chatArea.scrollTop = chatArea.scrollHeight;
    }

    function render() {
       chatArea.innerHTML = '';
       if(messages.length === 0) {
           chatArea.innerHTML = '<div class="message ai" style="margin:auto">Начните диалог</div>';
       }
       messages.forEach((m, i) => {
           const div = document.createElement('div');
           div.className = `message ${m.role}`;
           div.innerHTML = `<div>${m.content}</div><div class="time">${formatTime(m.timestamp)}</div>`;
           
           // Удаление по клику
           div.onclick = () => confirmDelete(i);
           chatArea.appendChild(div);
       });
       scrollToBottom();
    }

    async function send() {
       const txt = input.value.trim();
       if(!txt) return;
       
       messages.push({role:'user', content:txt, timestamp:Date.now()});
       save(); render();
       input.value=''; input.style.height='auto';
       
       // Loading
       const loadId = Date.now();
       messages.push({role:'ai', content:'...', timestamp:loadId});
       render();

       try {
           const u = tg?.initDataUnsafe?.user || {};
           const uid = u.id || localStorage.getItem('uid') || 'debug';
           if(!u.id) localStorage.setItem('uid', uid);

           const res = await fetch(BACKEND_URL, {
               method: 'POST',
               body: JSON.stringify({
                   action: 'send_message',
                   user_id: uid,
                   message: txt,
                   user_data: u,
                   init_data: tg?.initData || ''
               })
           }).then(r=>r.json());
           
           messages = messages.filter(m=>m.timestamp !== loadId);
           
           if(res.success) messages.push({role:'ai', content:res.text, timestamp:Date.now()});
           else messages.push({role:'ai', content:'Ошибка', timestamp:Date.now()});
           
           if(tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred(res.success ? 'success' : 'error');

       } catch(e) {
           messages = messages.filter(m=>m.timestamp !== loadId);
           messages.push({role:'ai', content:'Сбой сети', timestamp:Date.now()});
       }
       save(); render();
    }

    function save(){ localStorage.setItem('chat_fix', JSON.stringify(messages)); }
    function load(){ const s=localStorage.getItem('chat_fix'); if(s){ messages=JSON.parse(s); render(); } }

    input.addEventListener('input', function(){
        this.style.height='auto'; this.style.height=Math.min(this.scrollHeight,100)+'px';
    });
    sendBtn.onclick = send;

    // Modal Logic
    const modal = document.getElementById('confirmModal');
    let onDel = null;
    function confirmDelete(i) {
        onDel = () => { messages.splice(i,1); save(); render(); };
        modal.classList.add('show');
    }
    document.getElementById('modalCancel').onclick = () => modal.classList.remove('show');
    document.getElementById('modalConfirm').onclick = () => { if(onDel)onDel(); modal.classList.remove('show'); };

    clearBtn.onclick = () => {
        if(!messages.length) return;
        onDel = async () => {
           messages=[]; save(); render();
           const u = tg?.initDataUnsafe?.user || {};
           const uid = u.id || localStorage.getItem('uid');
           fetch(BACKEND_URL, {method:'POST', body:JSON.stringify({action:'clear_history', user_id:uid})}).catch(()=>{});
        };
        modal.classList.add('show');
    }

    // Start
    load();
  </script>
</body>
</html>
