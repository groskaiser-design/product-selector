<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>AI –ß–∞—Ç (No Jump)</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root {
      --bg: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --userBubble: rgba(251,191,36,.25);
      --userBorder: rgba(251,191,36,.4);
      --aiBubble: rgba(255,255,255,.18);
      --aiBorder: rgba(255,255,255,.28);
      --inputBg: rgba(255,255,255,.12);
      --inputBorder: rgba(255,255,255,.24);
      --okA: #fbbf24; --okB: #f59e0b;
      --maxw: 560px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    /* –°–ê–ú–û–ï –í–ê–ñ–ù–û–ï: 
      –§–∏–∫—Å–∏—Ä—É–µ–º body –Ω–∞–º–µ—Ä—Ç–≤–æ. –ù–∏–∫–∞–∫–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
      –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –º–æ–∂–µ—Ç "–ø—Ä—ã–≥–Ω—É—Ç—å", –µ—Å–ª–∏ –æ–Ω–∞ –ø—Ä–∏–±–∏—Ç–∞ –≥–≤–æ–∑–¥—è–º–∏.
    */
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden; /* –ó–∞–ø—Ä–µ—Ç –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
      position: fixed;  /* –ó–∞–ø—Ä–µ—Ç —Å–¥–≤–∏–≥–∞ –Ω–∞ iOS */
      top: 0; left: 0;
      background: var(--bg);
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    /*
      –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
      –ï–≥–æ –≤—ã—Å–æ—Ç—É –º—ã –±—É–¥–µ–º –º–µ–Ω—è—Ç—å JS-–æ–º.
    */
    #app-viewport {
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 100%; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 100%, JS –∏–∑–º–µ–Ω–∏—Ç —ç—Ç–æ */
      max-width: var(--maxw);
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      /* –ü–ª–∞–≤–Ω–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã */
      transition: height 0.1s ease-out;
    }

    /* –®–∞–ø–∫–∞ */
    .header {
      flex-shrink: 0;
      height: 54px;
      display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      z-index: 20;
    }
    .header h4 { font-size: 17px; font-weight: 700; }
    .clear-btn {
      position: absolute; right: 16px; padding: 6px 12px;
      border: 1px solid rgba(239,68,68,0.5); border-radius: 8px;
      background: rgba(239,68,68,0.2); color: #fff; font-size: 12px;
    }

    /* –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ */
    .chat-area {
      flex-grow: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px 14px;
      display: flex; flex-direction: column; gap: 10px;
      -webkit-overflow-scrolling: touch;
      /* –°–∫—Ä–æ–ª–ª–±–∞—Ä */
      scrollbar-width: none; 
    }
    .chat-area::-webkit-scrollbar { display: none; }

    /* –°–æ–æ–±—â–µ–Ω–∏—è */
    .message { max-width: 85%; display: flex; flex-direction: column; position: relative; animation: fadeUp 0.2s ease; }
    @keyframes fadeUp { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }
    
    .message.user { align-self: flex-end; align-items: flex-end; }
    .message.ai { align-self: flex-start; align-items: flex-start; }

    .bubble {
      padding: 10px 14px; border-radius: 16px; font-size: 15px; line-height: 1.4;
      word-wrap: break-word; backdrop-filter: blur(5px);
    }
    .message.user .bubble { background: rgba(251,191,36,0.2); border: 1px solid rgba(251,191,36,0.4); border-bottom-right-radius: 2px; }
    .message.ai .bubble { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); border-bottom-left-radius: 2px; }
    
    .time { font-size: 10px; opacity: 0.6; margin-top: 3px; padding: 0 2px; }

    /* –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ */
    .input-area {
      flex-shrink: 0;
      background: rgba(0,0,0,0.2);
      backdrop-filter: blur(10px);
      padding: 10px 14px;
      /* padding-bottom –ù–ï –Ω—É–∂–µ–Ω, —Ç–∞–∫ –∫–∞–∫ –º—ã —Ä–µ—Å–∞–π–∑–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–æ–≤–Ω–æ –¥–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã */
      display: flex; gap: 10px; align-items: flex-end;
      z-index: 20;
    }

    .input-field {
      flex: 1;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 20px;
      padding: 10px 14px;
      color: #fff; font-size: 16px; /* –í–∞–∂–Ω–æ 16px –¥–ª—è iOS */
      max-height: 100px;
      min-height: 40px;
      resize: none; outline: none;
      font-family: inherit;
    }
    .send-btn {
      width: 40px; height: 40px; border-radius: 50%; border: none;
      background: linear-gradient(135deg, var(--okA), var(--okB));
      color: #fff; display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }
    .send-btn:disabled { opacity: 0.5; }

    /* UI states */
    .empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0.6; text-align: center; }
    .empty-state div { font-size: 40px; margin-bottom: 10px; }
    
    /* –ú–æ–¥–∞–ª–∫–∞ –∏ –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è (—Ç–≤–æ–∏ —Å—Ç–∏–ª–∏) */
    .delete-btn { position: absolute; top: 50%; transform: translateY(-50%); width: 28px; height: 28px; background: #ef4444; border-radius: 50%; display: none; align-items: center; justify-content: center; color: #fff; z-index: 5; }
    .message.user .delete-btn { left: -36px; } .message.ai .delete-btn { right: -36px; }
    .message.show-delete .delete-btn { display: flex; }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: none; align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-box { background: #2d2d2d; padding: 20px; border-radius: 16px; width: 300px; text-align: center; border: 1px solid rgba(255,255,255,0.2); }
    .modal-btns { display: flex; gap: 10px; margin-top: 15px; }
    .modal-btns button { flex: 1; padding: 10px; border-radius: 8px; border: none; font-weight: bold; }
    
  </style>
</head>
<body>

  <div id="app-viewport">
    <div class="header">
      <h4>Ai-–ö–æ—É—á</h4>
      <button class="clear-btn" id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <div class="chat-area" id="chatArea">
      <div class="empty-state" id="emptyState">
        <div>üí¨</div>
        <h3>–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥</h3>
      </div>
    </div>

    <div class="input-area">
      <textarea class="input-field" id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
      <button class="send-btn" id="sendBtn" disabled>‚û§</button>
    </div>
  </div>

  <div class="modal" id="confirmModal">
    <div class="modal-box">
      <h3>–£–¥–∞–ª–∏—Ç—å?</h3>
      <p>–û—Ç–º–µ–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è.</p>
      <div class="modal-btns">
        <button style="background:#ffffff20; color:#fff" id="modalCancel">–ù–µ—Ç</button>
        <button style="background:#fbbf24; color:#000" id="modalConfirm">–î–∞</button>
      </div>
    </div>
  </div>

  <script>
  // ========================================================
  // 1. FIX VIEWPORT JUMPS (–ì–õ–ê–í–ù–´–ô –°–ö–†–ò–ü–¢)
  // ========================================================
  const viewport = document.getElementById('app-viewport');
  const input = document.getElementById('messageInput');
  const chat = document.getElementById('chatArea');

  // –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –∂–µ—Å—Ç–∫–æ –∑–∞–¥–∞–µ—Ç –≤—ã—Å–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ä–∞–≤–Ω–æ–π –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
  function resizeViewport() {
    // window.visualViewport.height - —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –ë–ï–ó –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    if (window.visualViewport) {
      viewport.style.height = `${window.visualViewport.height}px`;
      // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–º–µ—â–µ–Ω–∏–µ —Å–≤–µ—Ä—Ö—É (–±—ã–≤–∞–µ—Ç –Ω–∞ iOS), –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ–º
      viewport.style.top = `${window.visualViewport.offsetTop}px`;
      
      // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–∫—Ä–æ–ª–ª–∏–º —á–∞—Ç –≤–Ω–∏–∑ –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ
      scrollToBottom();
    } else {
      viewport.style.height = `${window.innerHeight}px`;
    }
    // –•–∞–∫: –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ 0, —á—Ç–æ–±—ã –Ω–µ —Å—ä–µ–∑–∂–∞–ª–∞ —à–∞–ø–∫–∞
    window.scrollTo(0, 0);
  }

  // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏ (–æ—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –∫–ª–∞–≤—ã)
  if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', resizeViewport);
    window.visualViewport.addEventListener('scroll', resizeViewport);
  } else {
    window.addEventListener('resize', resizeViewport);
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  resizeViewport();

  // –•–∞–∫ –¥–ª—è iOS –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ: –∏–Ω–æ–≥–¥–∞ iOS –≤—Å–µ —Ä–∞–≤–Ω–æ –ø—ã—Ç–∞–µ—Ç—Å—è —Å–¥–≤–∏–Ω—É—Ç—å body
  input.addEventListener('focus', () => {
    setTimeout(() => {
      window.scrollTo(0, 0);
      resizeViewport();
      scrollToBottom();
    }, 100);
  });
  
  // ========================================================
  // 2. LOGIC (–¢–í–û–ô –ö–û–î)
  // ========================================================
  (function initTMA(){
    const tg = window.Telegram?.WebApp;
    if(tg){ 
        tg.ready(); 
        tg.expand(); 
        tg.disableVerticalSwipes?.();
    }
  })();

  const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbzvlDKUH6qsON-A6iSHYvMU_6XWtReZc5oXnnZOMTgETfvZqMMh2zUbdQJF-iOanMBc/exec';
  let messages = [];

  const sendBtn = document.getElementById('sendBtn');
  const clearBtn = document.getElementById('clearBtn');
  const emptyState = document.getElementById('emptyState');
  
  // --- Helper Functions ---
  function scrollToBottom() {
    // requestAnimationFrame –ø–æ–º–æ–≥–∞–µ—Ç —Å–∫—Ä–æ–ª–ª–∏—Ç—å –ü–û–°–õ–ï –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
    requestAnimationFrame(() => {
      chat.scrollTop = chat.scrollHeight;
    });
  }

  function formatTime(ts) {
    const d = new Date(ts);
    return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
  }

  // --- Rendering ---
  function render() {
    // –ß–∏—Å—Ç–∏–º (–∫—Ä–æ–º–µ emptyState)
    Array.from(chat.children).forEach(c => { if(c.id !== 'emptyState') c.remove(); });
    
    if(messages.length === 0) {
      emptyState.style.display = 'flex';
    } else {
      emptyState.style.display = 'none';
      messages.forEach((m, i) => {
        const el = createMsgEl(m, i);
        chat.appendChild(el);
      });
    }
    scrollToBottom();
  }

  function createMsgEl(m, index) {
    const div = document.createElement('div');
    div.className = `message ${m.role}`;
    
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = m.content;
    
    // Delete logic
    const delBtn = document.createElement('div');
    delBtn.className = 'delete-btn';
    delBtn.innerHTML = '‚úï';
    delBtn.onclick = (e) => { e.stopPropagation(); confirmDelete(index); };
    
    let timer;
    bubble.addEventListener('touchstart', () => timer = setTimeout(() => {
       div.classList.add('show-delete');
       window.Telegram?.WebApp?.HapticFeedback?.impactOccurred('medium');
    }, 500));
    bubble.addEventListener('touchend', () => clearTimeout(timer));

    const time = document.createElement('div');
    time.className = 'time';
    time.textContent = formatTime(m.timestamp);

    div.appendChild(delBtn);
    div.appendChild(bubble);
    div.appendChild(time);
    return div;
  }

  // --- API ---
  async function sendMessage() {
    const text = input.value.trim();
    if(!text) return;
    
    window.Telegram?.WebApp?.HapticFeedback?.impactOccurred('light');
    
    // Local add
    messages.push({ role:'user', content:text, timestamp:Date.now() });
    save();
    render();
    
    input.value = '';
    input.style.height = 'auto';
    sendBtn.disabled = true;

    // AI placeholder
    const loadingId = Date.now();
    messages.push({ role:'ai', content:'...', timestamp:loadingId }); // Placeholder
    render();

    // Fetch
    try {
        const u = window.Telegram?.WebApp?.initDataUnsafe?.user || {};
        const uid = u.id || localStorage.getItem('debug_uid') || 'd-'+Math.random();
        if(!u.id) localStorage.setItem('debug_uid', uid);

        const res = await fetch(BACKEND_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'send_message',
                message: text,
                user_id: uid,
                user_data: { first_name: u.first_name || '' },
                init_data: window.Telegram?.WebApp?.initData || ''
            })
        }).then(r => r.json());
        
        // Replace placeholder
        messages.pop(); // remove loading
        if(res.success) {
            messages.push({ role:'ai', content: res.text || '–ü—É—Å—Ç–æ', timestamp:Date.now() });
            window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred('success');
        } else {
            messages.push({ role:'ai', content: '–û—à–∏–±–∫–∞: '+(res.error||'Unknown'), timestamp:Date.now() });
            window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred('error');
        }
    } catch(e) {
        messages.pop();
        messages.push({ role:'ai', content: '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', timestamp:Date.now() });
    }
    save();
    render();
  }

  // --- Storage ---
  function save() { localStorage.setItem('chat_hist', JSON.stringify(messages)); }
  function load() { 
      const s = localStorage.getItem('chat_hist'); 
      if(s) { messages = JSON.parse(s); render(); }
  }

  // --- Events ---
  input.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 100) + 'px';
      sendBtn.disabled = !this.value.trim();
  });
  sendBtn.onclick = sendMessage;

  // Modal
  let delCallback = null;
  function confirmDelete(i) {
      delCallback = () => { messages.splice(i, 1); save(); render(); };
      document.getElementById('confirmModal').classList.add('show');
  }
  document.getElementById('modalCancel').onclick = () => document.getElementById('confirmModal').classList.remove('show');
  document.getElementById('modalConfirm').onclick = () => { if(delCallback) delCallback(); document.getElementById('confirmModal').classList.remove('show'); };
  
  clearBtn.onclick = () => {
      delCallback = async () => {
         messages = []; save(); render();
         // Call backend clear if needed
         const u = window.Telegram?.WebApp?.initDataUnsafe?.user || {};
         const uid = u.id || localStorage.getItem('debug_uid');
         await fetch(BACKEND_URL, { method:'POST', body:JSON.stringify({action:'clear_history', user_id: uid}) });
      };
      document.getElementById('confirmModal').classList.add('show');
  }

  document.addEventListener('click', (e) => {
     document.querySelectorAll('.show-delete').forEach(el => el.classList.remove('show-delete'));
  });

  load();

  </script>
</body>
</html>
