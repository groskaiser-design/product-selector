<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Ultima Breath</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root {
    --bg-core: #000000;
    --text-main: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.4);
    --font-stack: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
    
    /* Dynamic Color (меняется JS-ом) */
    --theme-color: #fff; 
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
  
  body {
    background-color: var(--bg-core);
    font-family: var(--font-stack);
    color: var(--text-main);
    height: 100vh;
    overflow: hidden;
    display: flex; flex-direction: column;
  }

  /* === ФОНОВАЯ АТМОСФЕРА === */
  .ambient-light {
    position: fixed; inset: 0; z-index: 0; pointer-events: none;
    background: radial-gradient(circle at 50% 120%, var(--theme-color), transparent 70%);
    opacity: 0.15; transition: background 1s ease;
  }

  /* === ГЛАВНЫЙ ЭКРАН (МЕНЮ) === */
  #menuScreen {
    z-index: 10; flex: 1; display: flex; flex-direction: column;
    padding: 24px; padding-top: calc(20px + env(safe-area-inset-top));
    transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.4s;
  }
  
  .hero-title { font-size: 34px; font-weight: 800; letter-spacing: -0.5px; margin-bottom: 6px; }
  .hero-sub { font-size: 16px; color: var(--text-muted); font-weight: 400; margin-bottom: 40px; }

  .cards-stack { display: grid; gap: 16px; }

  .b-card {
    position: relative; height: 120px; width: 100%;
    border-radius: 24px;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.1);
    overflow: hidden; cursor: pointer;
    display: flex; flex-direction: column; justify-content: center; padding: 0 24px;
    transition: transform 0.2s, background 0.2s;
  }
  .b-card:active { transform: scale(0.96); background: rgba(255,255,255,0.12); }
  
  /* Градиентные подложки для карточек */
  .b-card::before {
    content: ''; position: absolute; right: -20px; top: -20px; width: 150px; height: 150px;
    border-radius: 50%; filter: blur(50px); opacity: 0.4; z-index: 0;
  }
  .c-stress::before { background: #ff9f0a; }
  .c-sleep::before { background: #5e60ce; }
  .c-focus::before { background: #30d158; }

  .bc-content { position: relative; z-index: 2; }
  .bc-title { font-size: 20px; font-weight: 700; letter-spacing: 0.3px; margin-bottom: 4px; }
  .bc-meta { font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; opacity: 0.6; display: flex; align-items: center; gap: 6px; }
  .bc-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }

  /* === ЭКРАН ПРАКТИКИ (IMMERSIVE) === */
  #breathScreen {
    position: fixed; inset: 0; z-index: 20;
    background: #000;
    display: flex; flex-direction: column; align-items: center; justify-content: space-between;
    padding: calc(60px + env(safe-area-inset-top)) 20px calc(40px + env(safe-area-inset-bottom)) 20px;
    opacity: 0; pointer-events: none; transform: scale(1.1);
    transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
  }
  #breathScreen.active { opacity: 1; pointer-events: all; transform: scale(1); }

  /* 1. Верхняя панель (Инструкция) */
  .top-status { text-align: center; height: 60px; display: flex; flex-direction: column; justify-content: flex-end; }
  .instruction-lbl {
    font-size: 14px; font-weight: 700; letter-spacing: 4px; text-transform: uppercase;
    color: var(--theme-color); opacity: 0; transform: translateY(10px);
    transition: all 0.5s ease;
  }
  .instruction-lbl.show { opacity: 1; transform: translateY(0); }

  /* 2. ЦЕНТРАЛЬНЫЙ ЭФФЕКТ (AURA) */
  .visualizer-wrapper {
    position: relative; width: 300px; height: 300px;
    display: flex; align-items: center; justify-content: center;
  }
  
  /* Ядро */
  .aura-core {
    width: 40px; height: 40px; border-radius: 50%;
    background: #fff;
    box-shadow: 0 0 30px 5px var(--theme-color);
    z-index: 5;
    transition: transform 0.1s linear; /* JS controlled */
  }

  /* Слои свечения (Waves) */
  .aura-wave {
    position: absolute; border-radius: 50%;
    border: 1px solid var(--theme-color);
    box-shadow: 0 0 20px var(--theme-color), inset 0 0 20px var(--theme-color);
    opacity: 0;
    /* JS будет менять scale и opacity */
    transition: all 0.1s linear; 
  }
  .w1 { width: 100px; height: 100px; z-index: 4; }
  .w2 { width: 180px; height: 180px; z-index: 3; }
  .w3 { width: 260px; height: 260px; z-index: 2; border: none; background: radial-gradient(circle, var(--theme-color) 0%, transparent 70%); opacity: 0.1; }

  /* 3. Нижняя панель (Таймер) */
  .timer-huge {
    font-family: 'SF Pro Display', sans-serif;
    font-size: 82px; font-weight: 200;
    font-variant-numeric: tabular-nums;
    letter-spacing: -2px;
    color: rgba(255,255,255,0.9);
    text-shadow: 0 10px 30px rgba(0,0,0,0.5);
  }

  /* 3-2-1 Overlay */
  #overlay {
    position: fixed; inset: 0; z-index: 100;
    background: rgba(0,0,0,0.6); backdrop-filter: blur(20px);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none; transition: opacity 0.3s;
  }
  #overlay.visible { opacity: 1; }
  .countdown-num { font-size: 140px; font-weight: 900; color: #fff; transform: scale(0.5); opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
  .countdown-num.pop { transform: scale(1); opacity: 1; }

</style>
</head>
<body>

<div class="ambient-light"></div>

<div id="menuScreen">
  <div>
    <h1 class="hero-title">Состояние</h1>
    <p class="hero-sub">Выберите практику для настройки нервной системы</p>
  </div>

  <div class="cards-stack">
    <div class="b-card c-stress" onclick="initSession('stress')">
      <div class="bc-content">
        <div class="bc-title">Снятие стресса</div>
        <div class="bc-meta"><div class="bc-dot"></div>Физиологический вздох • 2 мин</div>
      </div>
    </div>
    <div class="b-card c-sleep" onclick="initSession('sleep')">
      <div class="bc-content">
        <div class="bc-title">Глубокий сон</div>
        <div class="bc-meta"><div class="bc-dot"></div>Техника 4-7-8 • 3 мин</div>
      </div>
    </div>
    <div class="b-card c-focus" onclick="initSession('focus')">
      <div class="bc-content">
        <div class="bc-title">Концентрация</div>
        <div class="bc-meta"><div class="bc-dot"></div>Box Breathing • 5 мин</div>
      </div>
    </div>
  </div>
</div>

<div id="breathScreen">
  <div class="top-status">
    <div class="instruction-lbl" id="lbl">ВДОХ</div>
  </div>

  <div class="visualizer-wrapper">
    <div class="aura-wave w3" id="aw3"></div>
    <div class="aura-wave w2" id="aw2"></div>
    <div class="aura-wave w1" id="aw1"></div>
    <div class="aura-core" id="core"></div>
  </div>

  <div class="timer-huge" id="timer">00:00</div>
</div>

<div id="overlay"><div class="countdown-num" id="cntNum">3</div></div>

<script>
  const tg = window.Telegram?.WebApp;
  if(tg) { 
    tg.ready(); 
    tg.expand(); 
    tg.setHeaderColor('#000000'); 
    tg.setBackgroundColor('#000000');
    // Настраиваем кнопку Назад
    tg.BackButton.onClick(() => {
      if(isRunning) stopSession();
      else history.back(); // Или window.close(), если это корневая страница
    });
  }

  // === НАСТРОЙКИ ПРАКТИК ===
  const PRACTICES = {
    stress: {
      color: '#ff9f0a', // Orange
      duration: 120,
      // Резкий вдох, довдох, длинный выдох
      phases: [
        { label: 'ВДОХ', time: 1500,  core: 1.5, w1: 1.2, w2: 1.1, op: 0.8, haptic: 'heavy' },
        { label: 'ДОВДОХ', time: 800,   core: 1.8, w1: 1.4, w2: 1.2, op: 1.0, haptic: 'rigid' },
        { label: 'ВЫДОХ', time: 6000, core: 0.5, w1: 0.6, w2: 0.8, op: 0.3, haptic: 'soft' }
      ]
    },
    sleep: {
      color: '#5e60ce', // Purple
      duration: 180,
      phases: [
        { label: 'ВДОХ',   time: 4000, core: 1.6, w1: 1.4, w2: 1.2, op: 0.9, haptic: 'medium' },
        { label: 'ЗАДЕРЖКА', time: 7000, core: 1.6, w1: 1.5, w2: 1.4, op: 0.7, haptic: 'pulse' }, // Special pulse logic
        { label: 'ВЫДОХ',  time: 8000, core: 0.4, w1: 0.5, w2: 0.6, op: 0.2, haptic: 'soft' }
      ]
    },
    focus: {
      color: '#30d158', // Green
      duration: 300,
      phases: [
        { label: 'ВДОХ',   time: 4000, core: 1.5, w1: 1.3, w2: 1.1, op: 0.9, haptic: 'medium' },
        { label: 'ПАУЗА',  time: 4000, core: 1.5, w1: 1.4, w2: 1.2, op: 0.8, haptic: 'pulse' },
        { label: 'ВЫДОХ',  time: 4000, core: 0.5, w1: 0.6, w2: 0.7, op: 0.3, haptic: 'light' },
        { label: 'ПАУЗА',  time: 4000, core: 0.5, w1: 0.5, w2: 0.6, op: 0.2, haptic: 'pulse' }
      ]
    }
  };

  // Элементы DOM
  const el = {
    menu: document.getElementById('menuScreen'),
    screen: document.getElementById('breathScreen'),
    timer: document.getElementById('timer'),
    lbl: document.getElementById('lbl'),
    core: document.getElementById('core'),
    w1: document.getElementById('aw1'),
    w2: document.getElementById('aw2'),
    w3: document.getElementById('aw3'), // glow
    overlay: document.getElementById('overlay'),
    cnt: document.getElementById('cntNum'),
    root: document.documentElement
  };

  let isRunning = false;
  let sessionTimer = null;
  let animFrame = null;
  let currentPhaseIdx = 0;
  let phaseStartTime = 0;

  // === ЛОГИКА ===

  async function initSession(type) {
    const p = PRACTICES[type];
    
    // 1. Set Styles
    el.root.style.setProperty('--theme-color', p.color);
    el.menu.style.transform = 'scale(0.95)';
    el.menu.style.opacity = '0';
    
    setTimeout(() => {
      el.menu.style.display = 'none';
      el.screen.classList.add('active');
      tg?.BackButton.show();
    }, 400);

    // 2. Countdown
    el.overlay.classList.add('visible');
    for(let i=3; i>0; i--){
      el.cnt.textContent = i;
      el.cnt.classList.remove('pop');
      void el.cnt.offsetWidth; // trigger reflow
      el.cnt.classList.add('pop');
      haptic('medium');
      await delay(1000);
    }
    el.overlay.classList.remove('visible');

    // 3. Start
    startBreathing(p);
  }

  function startBreathing(practice) {
    isRunning = true;
    currentPhaseIdx = 0;
    phaseStartTime = performance.now();
    
    // Таймер сессии
    let timeLeft = practice.duration;
    updateTimerDisplay(timeLeft);
    
    sessionTimer = setInterval(() => {
      timeLeft--;
      updateTimerDisplay(timeLeft);
      if(timeLeft <= 0) stopSession(true);
    }, 1000);

    // Анимационный цикл (Render Loop)
    requestAnimationFrame((t) => loop(t, practice));
  }

  // Main Animation Loop
  function loop(now, p) {
    if(!isRunning) return;

    const phases = p.phases;
    const phase = phases[currentPhaseIdx];
    const elapsed = now - phaseStartTime;

    // Прогресс текущей фазы (0.0 -> 1.0)
    const progress = Math.min(elapsed / phase.time, 1);

    // Плавная интерполяция (Lerp)
    // Нам нужно интерполировать от "предыдущего состояния" к "текущему".
    // Для простоты и плавности в CSS (transition) мы задаем конечные точки,
    // но здесь мы делаем это через JS для контроля фаз.
    
    // Упрощение: используем CSS Transition на каждом шаге фазы
    // Мы вызываем applyPhaseStyle ТОЛЬКО один раз в начале фазы
    if (elapsed < 20) { // Новый кадр фазы
      applyPhaseVisuals(phase, p.color);
      applyPhaseHaptics(phase);
    }

    // Логика "пульса" во время задержки (эмуляция сердца)
    if (phase.haptic === 'pulse' && elapsed % 1000 < 50) {
       // Бьем тик каждую секунду на задержке
       haptic('soft');
    }

    // Конец фазы?
    if (elapsed >= phase.time) {
      currentPhaseIdx = (currentPhaseIdx + 1) % phases.length;
      phaseStartTime = now;
    }

    requestAnimationFrame((t) => loop(t, p));
  }

  function applyPhaseVisuals(phase, color) {
    // Текст
    el.lbl.classList.remove('show');
    setTimeout(() => {
      el.lbl.textContent = phase.label;
      el.lbl.classList.add('show');
    }, 200);

    // CSS переходы для плавности
    const dur = phase.time + 'ms';
    const ease = 'cubic-bezier(0.25, 1, 0.5, 1)'; // Smooth ease-out

    [el.core, el.w1, el.w2, el.w3].forEach(e => e.style.transition = `all ${dur} ${ease}`);

    // Применяем стили
    el.core.style.transform = `scale(${phase.core})`;
    el.w1.style.transform = `scale(${phase.w1})`;
    el.w2.style.transform = `scale(${phase.w2})`;
    
    el.w1.style.opacity = phase.op;
    el.w2.style.opacity = phase.op * 0.6;
    
    // Свечение (w3) дышит медленнее
    el.w3.style.transform = `scale(${phase.core * 2.5})`;
  }

  function applyPhaseHaptics(phase) {
    if (phase.haptic === 'pulse') return; // обрабатывается в цикле
    haptic(phase.haptic);
  }

  function stopSession(completed = false) {
    isRunning = false;
    clearInterval(sessionTimer);
    
    // Сброс
    el.screen.classList.remove('active');
    tg?.BackButton.hide();
    
    setTimeout(() => {
      el.menu.style.display = 'flex';
      // Force reflow
      void el.menu.offsetWidth;
      el.menu.style.opacity = '1';
      el.menu.style.transform = 'scale(1)';
    }, 500);

    if(completed && tg) tg.showPopup({ title: 'Отлично', message: 'Практика завершена.' });
  }

  function updateTimerDisplay(sec) {
    const m = Math.floor(sec / 60).toString().padStart(2, '0');
    const s = (sec % 60).toString().padStart(2, '0');
    el.timer.textContent = `${m}:${s}`;
  }

  function haptic(type) {
    if(!tg || !tg.HapticFeedback) return;
    if(type === 'heavy') tg.HapticFeedback.impactOccurred('heavy');
    else if(type === 'medium') tg.HapticFeedback.impactOccurred('medium');
    else if(type === 'light') tg.HapticFeedback.impactOccurred('light');
    else if(type === 'rigid') tg.HapticFeedback.impactOccurred('rigid');
    else if(type === 'soft') tg.HapticFeedback.impactOccurred('soft');
  }

  function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

</script>
</body>
</html>
