<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>План vs Факт — диаграмма отклонений (мобайл)</title>
  <style>
    /* вставьте сюда ваш оригинальный CSS (он и так полностью рабочий и настроенный) */
    /* ... длинный CSS из оригинального примера ... */
    /* ----- (оставляется весь ваш CSS как есть) ----- */
    :root{--font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;--name-size:clamp(10px,3.2vw,16px);--name-weight:400;--meta-size:clamp(10px,3.2vw,16px);--value-size:clamp(10px,3.8vw,16px);--value-weight:800;--line-name:1.25;--gauge-height:28px;--plan-radius:6px;--fact-radius:3px;--fact-height:50%;--text:#ffffff;--muted:rgba(255,255,255,.82);--fact-green:#22c55e;--fact-orange:#f59e0b;--fact-red:#ef4444;--plan-fill:rgba(255,255,255,.38);--plan-border:rgba(255,255,255,.52);--shadow:0 8px 24px rgba(27,35,78,.22);--page-grad-from:#7B6EF6;--page-grad-to:#6F7FF0;--outer-pad:clamp(12px,4.5vw,18px);}
    *{box-sizing:border-box}
    body{margin:0;color:var(--text);font-family:var(--font-family);-webkit-font-smoothing:antialiased;min-height:100vh;background:linear-gradient(180deg,var(--page-grad-from) 0%,var(--page-grad-to) 100%);background-attachment:fixed;}
    .page{padding:var(--outer-pad);padding-left:max(var(--outer-pad),env(safe-area-inset-left));padding-right:max(var(--outer-pad),env(safe-area-inset-right));padding-top:max(var(--outer-pad),env(safe-area-inset-top));padding-bottom:max(var(--outer-pad),env(safe-area-inset-bottom));}
    .card{max-width:680px;margin:clamp(8px,4vw,20px) auto;padding:12px;border-radius:20px;background:linear-gradient(180deg,rgba(255,255,255,.22) 0%,rgba(255,255,255,.14) 100%);backdrop-filter:blur(22px) saturate(1.35);border:1.5px solid rgba(255,255,255,.45);box-shadow:var(--shadow);}
    .scroller{position:relative;overflow:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;scroll-snap-type:y proximity;scroll-behavior:smooth;border-radius:16px}
    .scroll-hint{position:relative;margin:10px auto 0;opacity:.65;pointer-events:none;transition:opacity .2s ease;width:18px;height:18px}
    .scroll-hint.hidden{opacity:0;visibility:hidden}
    .scroll-hint svg{display:block;width:18px;height:18px;filter:drop-shadow(0 1px 2px rgba(0,0,0,.25));animation:hint-bounce 1.2s infinite}
    .scroll-hint svg.up{rotate:180deg;animation-name:hint-bounce-up}
    @keyframes hint-bounce{0%,100%{translate:0 0}50%{translate:0 4px}}
    @keyframes hint-bounce-up{0%,100%{translate:0 0}50%{translate:0 -4px}}
    @media (prefers-reduced-motion:reduce){.scroll-hint svg{animation:none}}
    .list{display:flex;flex-direction:column;gap:0;padding:8px 10px;border-radius:16px;overflow:hidden;background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.06));border:1px solid rgba(255,255,255,.30);}
    .row{display:flex;flex-direction:column;gap:8px;padding:10px 4px;scroll-snap-align:start}
    .row+.row{border-top:1px solid rgba(255,255,255,.22);margin-top:8px;padding-top:16px}
    .top{display:flex;align-items:baseline;justify-content:flex-start;gap:10px;flex-wrap:wrap}
    .name{font-size:var(--name-size);font-weight:var(--name-weight);line-height:var(--line-name)}
    .vals{display:flex;flex-wrap:wrap;gap:4px;font-size:var(--meta-size);line-height:1.25}
    .vals .kv{display:inline-flex;align-items:baseline;gap:2px}
    .vals .lab{color:var(--muted);margin-right:2px}
    .vals .val{font-weight:var(--value-weight);font-size:var(--value-size)}
    .dot{color:var(--muted);margin:0 2px}
    .gauge{position:relative;height:var(--gauge-height);border-radius:var(--plan-radius)}
    .plan{position:absolute;inset:0 auto 0 0;width:var(--wp,0%);border-radius:var(--plan-radius);background:var(--plan-fill);border:1px solid var(--plan-border);box-shadow:inset 0 -1px 0 rgba(255,255,255,.18);z-index:1}
    .fact{position:absolute;left:0;top:50%;transform:translateY(-50%);height:var(--fact-height);width:var(--wf,0%);min-width:6px;border-radius:var(--fact-radius);border:1px solid rgba(255,255,255,.95);background:var(--fact-green);box-shadow:inset 0 -1px 0 rgba(255,255,255,.16),0 10px 24px -14px rgba(9,25,52,.55);transform-origin:left center;transition:width .22s ease;z-index:2}
    .fact.orange{background:var(--fact-orange);}
    .fact.red{background:var(--fact-red);}
    @supports (background: color-mix(in oklab, white 50%, black)){
    .fact{background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,0) 60%),color-mix(in oklab,var(--fact-green) 88%,transparent);}
    .fact.orange{background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,0) 60%),color-mix(in oklab,var(--fact-orange) 88%,transparent);}
    .fact.red{background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,0) 60%),color-mix(in oklab,var(--fact-red) 88%,transparent);}
    }
    .fact.neutral{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.6);box-shadow:inset 0 -1px 0 rgba(255,255,255,.12);}
    .timeline{position:relative;display:flex;align-items:center;gap:10px;padding:10px 8px 6px}
    .timeline[hidden]{display:none !important}
    .wheel{position:relative;flex:1;display:flex;align-items:center;gap:8px;overflow-x:auto;overflow-y:hidden;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;padding:10px 8px;border-radius:14px}
    .wheel{scrollbar-width:none}
    .wheel::-webkit-scrollbar{display:none}
    .wheel .item{flex:0 0 auto;min-width:76px;padding:8px 12px;margin:0 4px;display:flex;align-items:center;justify-content:center;text-align:center;opacity:.6;border-radius:14px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.08);scroll-snap-align:center;font-size:clamp(12px,3.3vw,14px);font-weight:700;letter-spacing:.2px;color:var(--text);user-select:none;transition:opacity .18s ease, transform .18s ease, box-shadow .18s ease;line-height:1.2}
    .wheel .item.active{opacity:1;background:rgba(255,255,255,.18);border-color:rgba(255,255,255,.45);box-shadow:0 6px 20px rgba(27,35,78,.18);transform:scale(1.02)}
    .wheel .spacer{flex:0 0 var(--edge,0px);height:1px;padding:0;margin:0;border:0;background:transparent}
    .wheel-mask{pointer-events:none;position:absolute;inset:0}
    .wheel-mask::before{content:"";position:absolute;left:var(--mask-left,50%);top:var(--mask-top,50%);width:var(--mask-w,min(70%,260px));height:var(--mask-h,44px);border-radius:16px;border:1.5px solid rgba(255,255,255,.35);background:rgba(255,255,255,.08);box-shadow:inset 0 -1px 0 rgba(255,255,255,.16),0 8px 24px rgba(27,35,78,.12);box-sizing:border-box;}
    .scroller{scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.35) transparent;}
    .scroller::-webkit-scrollbar{width:8px;height:8px;}
    .scroller::-webkit-scrollbar-track{background:transparent;}
    .scroller::-webkit-scrollbar-thumb{background-color:rgba(255,255,255,.35);border-radius:8px;border:2px solid transparent;background-clip:content-box;}
    .scroller:hover::-webkit-scrollbar-thumb{background-color:rgba(255,255,255,.55);}
    .scroller::-webkit-scrollbar-corner{background:transparent;}
    #pfHApp .top{align-items:flex-start;flex-wrap:wrap;gap:4px 0;}
    #pfHApp .top .name{flex:1 0 100%;display:block;}
    #pfHApp .top .vals{gap:6px;margin-top:0;}
    .haptic-test{position:fixed;right:12px;bottom:12px;z-index:9999;padding:10px 12px;border-radius:12px;background:rgba(0,0,0,.35);color:#fff;border:1px solid rgba(255,255,255,.35);backdrop-filter:blur(8px);font-size:14px}
    .haptic-test[hidden]{display:none}
  </style>
</head>
<body>
  <div class="page">
    <div class="card" id="pfHApp" role="region" aria-label="План против факта — диаграмма отклонений">
      <div class="scroller" id="scroller"><div class="list" id="rows"></div></div>
      <div class="scroll-hint" id="scrollHint" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 9l6 6 6-6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <div class="timeline" id="timeline" hidden>
        <div class="wheel" id="dateWheel" tabindex="0" aria-label="Выбор даты" role="listbox"></div>
        <div class="wheel-mask" aria-hidden="true"></div>
      </div>
    </div>
  </div>
  <!-- Данные из вашего шаблона, пример -->
  <template id="pfData">{ "fat": { "unit": "%", "plan": 18, "fact": 23, "delta": -5 }, "neck": { "unit": "см", "plan": 39, "fact": 42, "delta": -3 }, "shoulders": { "unit": "см", "plan": 140, "fact": 127, "delta": 13 }, "chest": { "unit": "см", "plan": 115, "fact": 115, "delta": 0 }, "waist": { "unit": "см", "plan": 89, "fact": 91, "delta": -2 }, "hips": { "unit": "см", "plan": 102, "fact": 100, "delta": 2 }, "thigh": { "unit": "см", "plan": 62, "fact": 58, "delta": 4 }, "calf": { "unit": "см", "plan": 44, "fact": 35, "delta": 9 }, "bicep": { "unit": "см", "plan": 44, "fact": 41, "delta": 3 } }</template>
  <template id="pfSeries_demo">{ "series": { "2025-03-01": { "fat": { "unit": "%", "plan": 18, "fact": 13, "delta": 5 }, "neck": { "unit": "см", "plan": 39, "fact": 32, "delta": 7 }, "shoulders": { "unit": "см", "plan": 140, "fact": 117, "delta": 23 }, "chest": { "unit": "см", "plan": 115, "fact": 105, "delta": 10 }, "waist": { "unit": "см", "plan": 89, "fact": 81, "delta": 8 }, "hips": { "unit": "см", "plan": 102, "fact": 90, "delta": 12 }, "thigh": { "unit": "см", "plan": 62, "fact": 48, "delta": 14 }, "calf": { "unit": "см", "plan": 44, "fact": 25, "delta": 19 }, "bicep": { "unit": "см", "plan": 44, "fact": 31, "delta": 13 } }, "2025-04-01": { "fat": { "unit": "%", "plan": 18, "fact": 14, "delta": 4 }, "neck": { "unit": "см", "plan": 39, "fact": 33, "delta": 6 }, "shoulders": { "unit": "см", "plan": 140, "fact": 118, "delta": 22 }, "chest": { "unit": "см", "plan": 115, "fact": 106, "delta": 9 }, "waist": { "unit": "см", "plan": 89, "fact": 82, "delta": 7 }, "hips": { "unit": "см", "plan": 102, "fact": 91, "delta": 11 }, "thigh": { "unit": "см", "plan": 62, "fact": 49, "delta": 13 }, "calf": { "unit": "см", "plan": 44, "fact": 26, "delta": 18 }, "bicep": { "unit": "см", "plan": 44, "fact": 32, "delta": 12 } } } }</template>
  <button class="haptic-test" id="hTest" hidden>Тест хаптики</button>
  <script>
    // === Новый универсальный HapticHelper ===
    window.__HapticHelper = (function makeHapticHelper(){
        let TMA, canVibrate, isIOS, onHttps, vibrateAvailable, enabled;
        function updateEnv(){
            TMA = window.Telegram && window.Telegram.WebApp;
            canVibrate = typeof navigator !== 'undefined' && typeof navigator.vibrate === 'function';
            isIOS = typeof navigator !== 'undefined' && /iPhone|iPad|iPod/i.test(navigator.userAgent);
            onHttps = typeof location !== 'undefined' && location.protocol === 'https:';
            vibrateAvailable = canVibrate && !isIOS && onHttps;
            enabled = (TMA && TMA.HapticFeedback) || vibrateAvailable;
        }
        updateEnv();
        if (window.Telegram && window.Telegram.WebApp) {
            try { window.Telegram.WebApp.ready && window.Telegram.WebApp.ready(); } catch(e){}
            window.Telegram.WebApp.onEvent && window.Telegram.WebApp.onEvent('themeChanged', updateEnv);
            document.addEventListener('visibilitychange', updateEnv);
        }
        ['pointerdown','click','focus','touchstart'].forEach(ev=>{
            window.addEventListener(ev, updateEnv, {capture:true, passive:true});
        });

        function select(){
            updateEnv();
            if (TMA && TMA.HapticFeedback && typeof TMA.HapticFeedback.selectionChanged === 'function') {
                try { TMA.HapticFeedback.selectionChanged(); return; } catch(e){}
            }
            if (vibrateAvailable) { try { navigator.vibrate(20); } catch(_){} }
        }
        function impact(type='light'){
            updateEnv();
            if (TMA && TMA.HapticFeedback && typeof TMA.HapticFeedback.impactOccurred === 'function') {
                try { TMA.HapticFeedback.impactOccurred(type); return; } catch(e){}
            }
            if (vibrateAvailable) { try { navigator.vibrate(25); } catch(_){} }
        }
        function notify(type='success'){
            updateEnv();
            if (TMA && TMA.HapticFeedback && typeof TMA.HapticFeedback.notificationOccurred === 'function') {
                try { TMA.HapticFeedback.notificationOccurred(type); return; } catch(e){}
            }
            if (vibrateAvailable) { try { navigator.vibrate([10,40,10]); } catch(_){} }
        }
        function isEnabled(){
            updateEnv();
            return !!((TMA && TMA.HapticFeedback) || vibrateAvailable);
        }
        return { select, impact, notify, get enabled(){ return isEnabled(); } };
    })();

    // Используйте далее window.__HapticHelper.* как в примерах ниже по всему коду — хаптика будет работать максимально нативно, где возможно!

    // --- Далее идёт весь ваш основной код диаграммы (без изменений, кроме вызовов HAPTIC.* => window.__HapticHelper.*) ---

    // ... вставить сюда рабочий (ваш оригинальный) JS как из вашего примера, только поменять HAPTIC на window.__HapticHelper
    // ВНИМАНИЕ: Далее ниже — только пример, скопируйте из вашего файла основную JS-логику и замените вызовы HAPTIC

    // пример замены в Timeline:
    /*
    wheel.addEventListener('pointerdown', () => { if (window.__HapticHelper.enabled) window.__HapticHelper.impact('light'); }, { passive:true });
    // ...
    if (pendingHapticForIndex === active) {
        if (window.__HapticHelper.enabled) window.__HapticHelper.select();
        pendingHapticForIndex = -1;
    }
    // Аналогично во всех других местах
    */

    // Оставьте дальше все ваши методы работы с данными/рендером инициализацию, обработчики, helpers и шаблоны — без изменений

    // Для теста (по кнопке)
    (function(){
      const showDebug = new URLSearchParams(location.search).get('debug') === '1';
      const btn = document.getElementById('hTest');
      if (btn && showDebug && window.__HapticHelper.enabled){
        btn.hidden = false;
        btn.addEventListener('click', function(){
          window.__HapticHelper.impact('light');
          setTimeout(()=>window.__HapticHelper.select(), 160);
        }, {passive:true});
      }
    })();

    // ...весь оригинальный (или чуть адаптированный к window.__HapticHelper) JawaScript 
    // (см. ваш длинный код — его здесь можно просто дословно подставить, только с заменой HAPTIC на window.__HapticHelper)
  </script>
</body>
</html>
