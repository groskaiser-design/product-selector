<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>План vs Факт — диаграмма отклонений (мобайл)</title>
    <style>
      /* ===== Базовые переменные (минимально необходимые) ===== */
      :root{
        --font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
        --name-size: clamp(10px, 3.2vw, 16px);
        --name-weight: 400;
        --meta-size: clamp(10px, 3.2vw, 16px);
        --value-size: clamp(10px, 3.8vw, 16px);
        --value-weight: 800;
        --line-name: 1.25;

        --gauge-height: 28px;
        --plan-radius: 6px;
        --fact-radius: 3px;
        --fact-height: 50%;

        --text:#ffffff;
        --muted:rgba(255,255,255,.82);

        --fact-green:#22c55e;
        --fact-orange:#f59e0b;
        --fact-red:#ef4444;

        --plan-fill: rgba(255,255,255,.38);
        --plan-border: rgba(255,255,255,.52);

        --shadow:0 8px 24px rgba(27,35,78,.22);
        --page-grad-from:#7B6EF6;
        --page-grad-to:#6F7FF0;
        --outer-pad: clamp(12px, 4.5vw, 18px);
      }

      *{box-sizing:border-box}
      body{ margin:0; color:var(--text); font-family:var(--font-family); -webkit-font-smoothing:antialiased; min-height:100vh;
        background:linear-gradient(180deg,var(--page-grad-from) 0%,var(--page-grad-to) 100%); background-attachment:fixed; }
      .page{ padding: var(--outer-pad); padding-left: max(var(--outer-pad), env(safe-area-inset-left)); padding-right: max(var(--outer-pad), env(safe-area-inset-right)); padding-top: max(var(--outer-pad), env(safe-area-inset-top)); padding-bottom: max(var(--outer-pad), env(safe-area-inset-bottom)); }

      .card{ max-width:680px; margin:clamp(8px,4vw,20px) auto; padding:12px; border-radius:20px;
        background:linear-gradient(180deg,rgba(255,255,255,.22) 0%,rgba(255,255,255,.14) 100%);
        backdrop-filter:blur(22px) saturate(1.35);
        border:1.5px solid rgba(255,255,255,.45);
        box-shadow:var(--shadow); }

      /* Контейнер со скроллом: показываем 5 строк, остальное прокручивается */
      .scroller{ position:relative; overflow:auto; -webkit-overflow-scrolling:touch; overscroll-behavior:contain; scroll-snap-type:y proximity; scroll-behavior:smooth; border-radius:16px }

      /* Подсказка-стрелка для вертикального скролла */
      .scroll-hint{ position:relative; margin:10px auto 0; opacity:.65; pointer-events:none; transition:opacity .2s ease; width:18px; height:18px }
      .scroll-hint.hidden{ opacity:0; visibility:hidden }
      .scroll-hint svg{ display:block; width:18px; height:18px; filter:drop-shadow(0 1px 2px rgba(0,0,0,.25)); animation:hint-bounce 1.2s infinite }
      .scroll-hint svg.up{ rotate:180deg; animation-name:hint-bounce-up }
      @keyframes hint-bounce{0%,100%{translate:0 0}50%{translate:0 4px}}
      @keyframes hint-bounce-up{0%,100%{translate:0 0}50%{translate:0 -4px}}
      @media (prefers-reduced-motion:reduce){ .scroll-hint svg{ animation:none } }

      .list{ display:flex; flex-direction:column; gap:0; padding:8px 10px; border-radius:16px; overflow:hidden;
        background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.06)); border:1px solid rgba(255,255,255,.30); }
      .row{ display:flex; flex-direction:column; gap:8px; padding:10px 4px; scroll-snap-align:start }
      .row+.row{ border-top:1px solid rgba(255,255,255,.22); margin-top:8px; padding-top:16px }

      .top{ display:flex; align-items:baseline; justify-content:flex-start; gap:10px; flex-wrap:wrap }
      .name{ font-size: var(--name-size); font-weight: var(--name-weight); line-height: var(--line-name) }
      .vals{ display:flex; flex-wrap:wrap; gap:4px; font-size:var(--meta-size); line-height:1.25 }
      .vals .kv{ display:inline-flex; align-items:baseline; gap:2px }
      .vals .lab{ color:var(--muted); margin-right:2px }
      .vals .val{ font-weight: var(--value-weight); font-size: var(--value-size) }
      .dot{ color:var(--muted); margin:0 2px }

      .gauge{ position:relative; height:var(--gauge-height); border-radius:var(--plan-radius) }
      .plan{ position:absolute; inset:0 auto 0 0; width:var(--wp,0%); border-radius:var(--plan-radius);
        background:var(--plan-fill); border:1px solid var(--plan-border); box-shadow:inset 0 -1px 0 rgba(255,255,255,.18); z-index:1 }
      .fact{ position:absolute; left:0; top:50%; transform:translateY(-50%); height:var(--fact-height); width:var(--wf,0%);
        min-width:6px; border-radius:var(--fact-radius); border:1px solid rgba(255,255,255,.95);
        background: var(--fact-green);
        box-shadow:inset 0 -1px 0 rgba(255,255,255,.16),0 10px 24px -14px rgba(9,25,52,.55);
        transform-origin:left center; transition:width .22s ease; z-index:2 }
      .fact.orange{ background: var(--fact-orange); }
      .fact.red{ background: var(--fact-red); }
      @supports (background: color-mix(in oklab, white 50%, black)){
        .fact{ background: linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,0) 60%), color-mix(in oklab,var(--fact-green) 88%, transparent); }
        .fact.orange{ background: linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,0) 60%), color-mix(in oklab,var(--fact-orange) 88%, transparent); }
        .fact.red{ background: linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,0) 60%), color-mix(in oklab,var(--fact-red) 88%, transparent); }
      }
      .fact.neutral{ background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.6); box-shadow: inset 0 -1px 0 rgba(255,255,255,.12); }

      /* === Timeline (горизонтальное колесо) === */
      .timeline{ position:relative; display:flex; align-items:center; gap:10px; padding:10px 8px 6px }
      .timeline[hidden]{ display:none !important }
      .wheel{ position:relative; flex:1; display:flex; align-items:center; gap:8px; overflow-x:auto; overflow-y:hidden; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch; padding:10px 8px; border-radius:14px }
      .wheel{ scrollbar-width:none }
      .wheel::-webkit-scrollbar{ display:none }
      .wheel .item{ flex:0 0 auto; min-width:76px; padding:8px 12px; margin:0 4px; display:flex; align-items:center; justify-content:center; text-align:center; opacity:.6; border-radius:14px; border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.08); scroll-snap-align:center; font-size:clamp(12px,3.3vw,14px); font-weight:700; letter-spacing:.2px; color:var(--text); user-select:none; transition:opacity .18s ease, transform .18s ease, box-shadow .18s ease; line-height:1.2 }
      .wheel .item.active{ opacity:1; background:rgba(255,255,255,.18); border-color:rgba(255,255,255,.45); box-shadow:0 6px 20px rgba(27,35,78,.18); transform:scale(1.02) }
      .wheel .spacer{ flex:0 0 var(--edge,0px); height:1px; padding:0; margin:0; border:0; background:transparent }

      /* Маска стеклянной подложки под активной датой */
      .wheel-mask{ pointer-events:none; position:absolute; inset:0 }
      .wheel-mask::before{
        content:""; position:absolute;
        left:var(--mask-left,50%); top:var(--mask-top,50%);
        width:var(--mask-w,min(70%,260px)); height:var(--mask-h,44px);
        border-radius:16px;
        border:1.5px solid rgba(255,255,255,.35);
        background:rgba(255,255,255,.08);
        box-shadow:inset 0 -1px 0 rgba(255,255,255,.16),0 8px 24px rgba(27,35,78,.12);
        box-sizing:border-box;
      }

      /* Custom thin scrollbar for .scroller (WebKit + Firefox) */
      .scroller{ scrollbar-width: thin; scrollbar-color: rgba(255,255,255,.35) transparent; }
      .scroller::-webkit-scrollbar{ width: 8px; height: 8px; }
      .scroller::-webkit-scrollbar-track{ background: transparent; }
      .scroller::-webkit-scrollbar-thumb{ background-color: rgba(255,255,255,.35); border-radius: 8px; border: 2px solid transparent; background-clip: content-box; }
      .scroller:hover::-webkit-scrollbar-thumb{ background-color: rgba(255,255,255,.55); }
      .scroller::-webkit-scrollbar-corner{ background: transparent; }

/* Делаем верх блока из двух строк: 1) название, 2) Факт/План/∆ */
#pfHApp .top{
  align-items: flex-start;
  flex-wrap: wrap;        /* важно: разрешаем перенос */
  gap: 4px 0;             /* вертикальный/горизонтальный зазоры между строками */
}

#pfHApp .top .name{
  flex: 1 0 100%;         /* занять всю ширину -> переносит .vals на следующую строку */
  display: block;
}

#pfHApp .top .vals{
  gap: 6px;               /* при желании подправьте интервал между «Факт/План/∆» */
  margin-top: 0;          /* можно чуть увеличить: 2–4px, если нужно больше воздуха */
}

      
    </style>
  </head>
  <body>
    <div class="page">
      <div class="card" id="pfHApp" role="region" aria-label="План против факта — диаграмма отклонений">
        <div class="scroller" id="scroller">
          <div class="list" id="rows"></div>
        </div>
        <div class="scroll-hint" id="scrollHint" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M6 9l6 6 6-6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="timeline" id="timeline" hidden>
          <div class="wheel" id="dateWheel" tabindex="0" aria-label="Выбор даты" role="listbox"></div>
          <div class="wheel-mask" aria-hidden="true"></div>
        </div>
      </div>
    </div>

    <!-- Основной одношаговый JSON (оставлен как есть) -->
    <template id="pfData">{ "fat": { "unit": "%", "plan": 18, "fact": 23, "delta": -5 }, "neck": { "unit": "см", "plan": 39, "fact": 42, "delta": -3 }, "shoulders": { "unit": "см", "plan": 140, "fact": 127, "delta": 13 }, "chest": { "unit": "см", "plan": 115, "fact": 115, "delta": 0 }, "waist": { "unit": "см", "plan": 89, "fact": 91, "delta": -2 }, "hips": { "unit": "см", "plan": 102, "fact": 100, "delta": 2 }, "thigh": { "unit": "см", "plan": 62, "fact": 58, "delta": 4 }, "calf": { "unit": "см", "plan": 44, "fact": 35, "delta": 9 }, "bicep": { "unit": "см", "plan": 44, "fact": 41, "delta": 3 } }</template>

    <!-- Серии дат (оставлены как есть) -->
    <template id="pfSeries_demo">{ "series": { "2025-03-01": { "fat": { "unit": "%", "plan": 18, "fact": 13, "delta": 5 }, "neck": { "unit": "см", "plan": 39, "fact": 32, "delta": 7 }, "shoulders": { "unit": "см", "plan": 140, "fact": 117, "delta": 23 }, "chest": { "unit": "см", "plan": 115, "fact": 105, "delta": 10 }, "waist": { "unit": "см", "plan": 89, "fact": 81, "delta": 8 }, "hips": { "unit": "см", "plan": 102, "fact": 90, "delta": 12 }, "thigh": { "unit": "см", "plan": 62, "fact": 48, "delta": 14 }, "calf": { "unit": "см", "plan": 44, "fact": 25, "delta": 19 }, "bicep": { "unit": "см", "plan": 44, "fact": 31, "delta": 13 } }, "2025-04-01": { "fat": { "unit": "%", "plan": 18, "fact": 14, "delta": 4 }, "neck": { "unit": "см", "plan": 39, "fact": 33, "delta": 6 }, "shoulders": { "unit": "см", "plan": 140, "fact": 118, "delta": 22 }, "chest": { "unit": "см", "plan": 115, "fact": 106, "delta": 9 }, "waist": { "unit": "см", "plan": 89, "fact": 82, "delta": 7 }, "hips": { "unit": "см", "plan": 102, "fact": 91, "delta": 11 }, "thigh": { "unit": "см", "plan": 62, "fact": 49, "delta": 13 }, "calf": { "unit": "см", "plan": 44, "fact": 26, "delta": 18 }, "bicep": { "unit": "см", "plan": 44, "fact": 32, "delta": 12 } }, "2025-05-01": { "fat": { "unit": "%", "plan": 18, "fact": 15, "delta": 3 }, "neck": { "unit": "см", "plan": 39, "fact": 34, "delta": 5 }, "shoulders": { "unit": "см", "plan": 140, "fact": 119, "delta": 21 }, "chest": { "unit": "см", "plan": 115, "fact": 107, "delta": 8 }, "waist": { "unit": "см", "plan": 89, "fact": 83, "delta": 6 }, "hips": { "unit": "см", "plan": 102, "fact": 92, "delta": 10 }, "thigh": { "unit": "см", "plan": 62, "fact": 50, "delta": 12 }, "calf": { "unit": "см", "plan": 44, "fact": 27, "delta": 17 }, "bicep": { "unit": "см", "plan": 44, "fact": 33, "delta": 11 } }, "2025-06-01": { "fat": { "unit": "%", "plan": 18, "fact": 16, "delta": 2 }, "neck": { "unit": "см", "plan": 39, "fact": 35, "delta": 4 }, "shoulders": { "unit": "см", "plan": 140, "fact": 120, "delta": 20 }, "chest": { "unit": "см", "plan": 115, "fact": 108, "delta": 7 }, "waist": { "unit": "см", "plan": 89, "fact": 84, "delta": 5 }, "hips": { "unit": "см", "plan": 102, "fact": 93, "delta": 9 }, "thigh": { "unit": "см", "plan": 62, "fact": 51, "delta": 11 }, "calf": { "unit": "см", "plan": 44, "fact": 28, "delta": 16 }, "bicep": { "unit": "см", "plan": 44, "fact": 34, "delta": 10 } }, "2025-07-01": { "fat": { "unit": "%", "plan": 18, "fact": 17, "delta": 1 }, "neck": { "unit": "см", "plan": 39, "fact": 36, "delta": 3 }, "shoulders": { "unit": "см", "plan": 140, "fact": 121, "delta": 19 }, "chest": { "unit": "см", "plan": 115, "fact": 109, "delta": 6 }, "waist": { "unit": "см", "plan": 89, "fact": 85, "delta": 4 }, "hips": { "unit": "см", "plan": 102, "fact": 94, "delta": 8 }, "thigh": { "unit": "см", "plan": 62, "fact": 52, "delta": 10 }, "calf": { "unit": "см", "plan": 44, "fact": 29, "delta": 15 }, "bicep": { "unit": "см", "plan": 44, "fact": 35, "delta": 9 } }, "2025-08-01": { "fat": { "unit": "%", "plan": 18, "fact": 18, "delta": 0 }, "neck": { "unit": "см", "plan": 39, "fact": 37, "delta": 2 }, "shoulders": { "unit": "см", "plan": 140, "fact": 122, "delta": 18 }, "chest": { "unit": "см", "plan": 115, "fact": 110, "delta": 5 }, "waist": { "unit": "см", "plan": 89, "fact": 86, "delta": 3 }, "hips": { "unit": "см", "plan": 102, "fact": 95, "delta": 7 }, "thigh": { "unit": "см", "plan": 62, "fact": 53, "delta": 9 }, "calf": { "unit": "см", "plan": 44, "fact": 30, "delta": 14 }, "bicep": { "unit": "см", "plan": 44, "fact": 36, "delta": 8 } }, "2025-09-01": { "fat": { "unit": "%", "plan": 18, "fact": 19, "delta": -1 }, "neck": { "unit": "см", "plan": 39, "fact": 38, "delta": 1 }, "shoulders": { "unit": "см", "plan": 140, "fact": 123, "delta": 17 }, "chest": { "unit": "см", "plan": 115, "fact": 111, "delta": 4 }, "waist": { "unit": "см", "plan": 89, "fact": 87, "delta": 2 }, "hips": { "unit": "см", "plan": 102, "fact": 96, "delta": 6 }, "thigh": { "unit": "см", "plan": 62, "fact": 54, "delta": 8 }, "calf": { "unit": "см", "plan": 44, "fact": 31, "delta": 13 }, "bicep": { "unit": "см", "plan": 44, "fact": 37, "delta": 7 } }, "2025-10-01": { "fat": { "unit": "%", "plan": 18, "fact": 20, "delta": -2 }, "neck": { "unit": "см", "plan": 39, "fact": 39, "delta": 0 }, "shoulders": { "unit": "см", "plan": 140, "fact": 124, "delta": 16 }, "chest": { "unit": "см", "plan": 115, "fact": 112, "delta": 3 }, "waist": { "unit": "см", "plan": 89, "fact": 88, "delta": 1 }, "hips": { "unit": "см", "plan": 102, "fact": 97, "delta": 5 }, "thigh": { "unit": "см", "plan": 62, "fact": 55, "delta": 7 }, "calf": { "unit": "см", "plan": 44, "fact": 32, "delta": 12 }, "bicep": { "unit": "см", "plan": 44, "fact": 38, "delta": 6 } }, "2025-11-01": { "fat": { "unit": "%", "plan": 18, "fact": 21, "delta": -3 }, "neck": { "unit": "см", "plan": 39, "fact": 40, "delta": -1 }, "shoulders": { "unit": "см", "plan": 140, "fact": 125, "delta": 15 }, "chest": { "unit": "см", "plan": 115, "fact": 113, "delta": 2 }, "waist": { "unit": "см", "plan": 89, "fact": 89, "delta": 0 }, "hips": { "unit": "см", "plan": 102, "fact": 98, "delta": 4 }, "thigh": { "unit": "см", "plan": 62, "fact": 56, "delta": 6 }, "calf": { "unit": "см", "plan": 44, "fact": 33, "delta": 11 }, "bicep": { "unit": "см", "plan": 44, "fact": 39, "delta": 5 } }, "2025-12-01": { "fat": { "unit": "%", "plan": 18, "fact": 22, "delta": -4 }, "neck": { "unit": "см", "plan": 39, "fact": 41, "delta": -2 }, "shoulders": { "unit": "см", "plan": 140, "fact": 126, "delta": 14 }, "chest": { "unit": "см", "plan": 115, "fact": 114, "delta": 1 }, "waist": { "unit": "см", "plan": 89, "fact": 90, "delta": -1 }, "hips": { "unit": "см", "plan": 102, "fact": 99, "delta": 3 }, "thigh": { "unit": "см", "plan": 62, "fact": 57, "delta": 5 }, "calf": { "unit": "см", "plan": 44, "fact": 34, "delta": 10 }, "bicep": { "unit": "см", "plan": 44, "fact": 40, "delta": 4 } } } }</template>

    <!-- Доп. тесты серии (оставлены как есть) -->
    <template id="pfSeries_array">[ { "date":"2025-01-01", "data": { "fat": {"unit":"%","plan":18,"fact":23}, "neck": {"unit":"см","plan":39,"fact":42} } }, { "date":"2025-02-01", "data": { "fat": {"unit":"%","plan":18,"fact":22}, "neck": {"unit":"см","plan":39,"fact":41} } }, { "date":"2025-03-01", "data": { "fat": {"unit":"%","plan":18,"fact":21}, "neck": {"unit":"см","plan":39,"fact":40} } } ]</template>
    <template id="pfSeries_single">{ "series": { "2025-05-01": { "fat": {"unit":"%","plan":18,"fact":18}, "bicep": {"unit":"см","plan":44,"fact":44} } } }</template>
    <template id="pfSeries_two">{ "series": { "2025-01-01": { "fat": {"unit":"%","plan":18,"fact":22} }, "2025-01-15": { "fat": {"unit":"%","plan":18,"fact":21} } } }</template>
    <template id="pfSeries_unsorted">{ "series": { "2025-12-01": { "fat": {"unit":"%","plan":18,"fact":22} }, "2025-01-01": { "fat": {"unit":"%","plan":18,"fact":23} }, "2025-06-01": { "fat": {"unit":"%","plan":18,"fact":20} } } }</template>

    <!-- Прочие тестовые наборы (оставлены как есть) -->
    <template id="pfData_missingDelta">{ "fat": { "unit": "%", "plan": 18, "fact": 23 }, "neck": { "unit": "см", "plan": 39, "fact": 42 }, "shoulders": { "unit": "см", "plan": 140, "fact": 127 }, "chest": { "unit": "см", "plan": 115, "fact": 115 }, "waist": { "unit": "см", "plan": 89, "fact": 91 }, "hips": { "unit": "см", "plan": 102, "fact": 100 }, "thigh": { "unit": "см", "plan": 62, "fact": 58 }, "calf": { "unit": "см", "plan": 44, "fact": 35 }, "bicep": { "unit": "см", "plan": 44, "fact": 41 } }</template>
    <template id="pfData_extreme">{ "fat": { "unit": "%", "plan": 15, "fact": 35, "delta": -20 }, "neck": { "unit": "см", "plan": 39, "fact": 39, "delta": 0 }, "shoulders": { "unit": "см", "plan": 140, "fact": 160, "delta": -20 }, "chest": { "unit": "см", "plan": 115, "fact": 100, "delta": 15 }, "waist": { "unit": "см", "plan": 89, "fact": 120, "delta": -31 }, "hips": { "unit": "см", "plan": 102, "fact": 102, "delta": 0 }, "thigh": { "unit": "см", "plan": 62, "fact": 50, "delta": 12 }, "calf": { "unit": "см", "plan": 44, "fact": 30, "delta": 14 }, "bicep": { "unit": "см", "plan": 44, "fact": 60, "delta": -16 } }</template>
    <template id="pfData_minimal">{ "fat": { "unit": "%", "plan": 20, "fact": 22, "delta": -2 }, "bicep": { "unit": "см", "plan": 44, "fact": 41, "delta": 3 } }</template>
    <template id="pfData_empty"></template>
    <template id="pfData_malformed">{ /* комментарий */
      “fat”: { "unit": "%", "plan": 18, "fact": 23, "delta":  }, // пустая дельта
      "neck": { "unit": "см", "plan": 39, "fact": 42, },         // висячая запятая
      "bicep": { "unit": "см", "plan": 44, "fact": 41 }
    }</template>

    <!-- Доп. новые тест-кейсы (добавлены, но не меняют существующие) -->
    <template id="pfSeries_oneDate">{ "series": { "2025-01-10": { "fat": {"unit":"%","plan":18,"fact":18}, "neck": {"unit":"см","plan":39,"fact":39} } } }</template>
    <template id="pfSeries_badKeys">[
      { "date":"not-a-date", "data": { "fat": {"unit":"%","plan":18,"fact":18} } },
      { "date":"2025-01-01",   "data": { "fat": {"unit":"%","plan":18,"fact":19} } }
    ]</template>

    <script>
      (function(){
        const LABELS = { fat:'% Жира', neck:'Шея', shoulders:'Плечи', chest:'Грудь', waist:'Талия', hips:'Ягодицы', thigh:'Бедро', calf:'Икра', bicep:'Бицепс' };
        const ORDER = ['fat','neck','shoulders','chest','waist','hips','thigh','calf','bicep'];

        /* -------- JSON helpers -------- */
        function parseJSONFromTemplate(id){
          const el = document.getElementById(id);
          if (!el || el.tagName !== 'TEMPLATE') return null;
          let raw = '';
          if (el.content && typeof el.content.textContent === 'string') raw = el.content.textContent; else raw = el.textContent || '';
          raw = raw.trim();
          if (!raw || (raw[0] !== '{' && raw[0] !== '[')) return null;
          try { return JSON.parse(raw); } catch (e) {
            function softSanitizeJSON(txt){
              let s = String(txt);
              for(;;){ const i = s.indexOf('/*'); if(i === -1) break; const j = s.indexOf('*/', i+2); s = (j === -1) ? (s.slice(0,i) + s.slice(i+2)) : (s.slice(0,i) + s.slice(j+2)); }
              s = s.split('\n').map(line => { const idx = line.indexOf('//'); return (idx > 0 && line[idx-1] === ':') ? line : (idx !== -1 ? line.slice(0, idx) : line); }).join('\n');
              s = s.split('“').join('"').split('”').join('"').split('‘').join("'").split('’').join("'");
              let out = '';
              for(let i=0;i<s.length;i++){
                const ch = s[i];
                if(ch === ','){
                  let k=i+1; while(k<s.length && (s[k]===' '||s[k]==='\t'||s[k]==='\r'||s[k]==='\n')) k++;
                  if(k<s.length && (s[k] === '}' || s[k] === ']')){ continue; }
                }
                out += ch;
              }
              s = out;
              let res = '';
              for(let i=0;i<s.length;){
                const p = s.indexOf('"delta"', i);
                if(p === -1){ res += s.slice(i); break; }
                res += s.slice(i, p + 7);
                let c = p + 7; while(c < s.length && s[c] !== ':') c++;
                if(c >= s.length){ i = c; break; }
                res += s.slice(p + 7, c + 1);
                let k = c + 1; while(k<s.length && (s[k]===' '||s[k]==='\t'||s[k]==='\r'||s[k]==='\n')) k++;
                if(k<s.length && (s[k] === ',' || s[k] === '}')){ res += ' null'; i = k; }
                else { i = k; }
              }
              return res;
            }
            try { return JSON.parse(softSanitizeJSON(raw)); } catch (e2) { return null; }
          }
        }

        function toRows(json){
          var rows=[]; if(!json) return rows;
          for(var i=0;i<ORDER.length;i++){
            var key = ORDER[i];
            var it = json[key];
            if(!it) continue;
            var unit = it.unit || (key==='fat' ? '%' : 'см');
            var planRaw = (it.plan != null ? it.plan : it.target);
            var factRaw = (it.fact != null ? it.fact : it.actual);
            var plan = Number(planRaw);
            var fact = Number(factRaw);
            if(!isFinite(plan) || !isFinite(fact)) continue;
            var delta = (it.hasOwnProperty('delta') && isFinite(Number(it.delta))) ? Number(it.delta) : null;
            rows.push({ key: key, label: (LABELS[key]||key), unit: unit, target: plan, actual: fact, delta: delta });
          }
          return rows;
        }

        /* -------------------- Рендер списка -------------------- */
        function render(el, initialData){
          var state = { data: initialData };
          var rowsEl = el.querySelector('#rows');
          var scroller = el.querySelector('#scroller');
          var hint = el.querySelector('#scrollHint');
          if(!rowsEl || !scroller){ return { setData: function(_){} }; }

          // Track last scroll direction to orient the arrow correctly
          var lastScrollTop = scroller.scrollTop || 0;
          var lastDirUp = false;

          function buildDomains(list){
            var cmMax = 0; for(var i=0;i<list.length;i++){ var d=list[i]; var u=(d.unit||'').trim(); if(u!=='%') cmMax=Math.max(cmMax, (d.target||0), (d.actual||0)); }
            return { '%':100, 'см':cmMax||1, 'cm':cmMax||1 };
          }

          function draw(){
            var data = state.data || []; var maxByUnit = buildDomains(data); rowsEl.innerHTML='';
            for(var i=0;i<data.length;i++){
              var d = data[i]; var delta = (isFinite(d.delta) ? d.delta : null); var unitMax = maxByUnit[(d.unit||'').trim()] || 1;
              var wp = Math.max(0, Math.min(100, ((d.target||0)/unitMax)*100));
              var wf = Math.max(0, Math.min(100, ((d.actual||0)/unitMax)*100));

              var row = document.createElement('div'); row.className='row';
              var top = document.createElement('div'); top.className='top';
              top.innerHTML = '<span class="name">'+(d.key==='fat' ? (LABELS[d.key]||d.label) : (d.label+' ('+d.unit+')'))+'</span>'+
                '<span class="vals">'+
                  '<span class="kv"><span class="lab">Факт:</span> <b class="val">'+round(d.actual,1)+'</b></span>'+
                  '<span class="dot">•</span>'+
                  '<span class="kv"><span class="lab">План:</span> <b class="val">'+round(d.target,1)+'</b></span>'+
                  '<span class="dot">•</span>'+
                  '<span class="kv"><span class="lab">∆:</span> <b class="val">'+fmtDeltaNoUnit(delta)+(isFinite(delta)?(delta>0?' ▲':(delta<0?' ▼':'')):'')+'</b></span>'+
                '</span>';

              var g = document.createElement('div'); g.className='gauge';
              var plan = document.createElement('div'); plan.className='plan'; plan.style.setProperty('--wp', wp+'%');
              var fact = document.createElement('div'); fact.className='fact'; fact.style.setProperty('--wf', wf+'%');

              if (isFinite(delta)) {
                if (d.key === 'fat' || d.key === 'waist') { if (d.actual > d.target) fact.classList.add('red'); }
                else { if (d.actual < d.target) fact.classList.add('orange'); }
              } else { fact.classList.add('neutral'); }

              g.appendChild(plan); g.appendChild(fact); row.appendChild(top); row.appendChild(g);
              rowsEl.appendChild(row);
            }
            limitToRows(4);
            updateHint();
          }

          function limitToRows(n){
            var items = rowsEl.children; var rows=[]; for(var i=0;i<items.length;i++){ if(items[i].classList && items[i].classList.contains('row')) rows.push(items[i]); }
            if(!rows.length) return; var csList = getComputedStyle(rowsEl); var maxH = parseFloat(csList.paddingTop) + parseFloat(csList.paddingBottom);
            for(var i=0;i<Math.min(n,rows.length);i++){ var r=rows[i]; var cs=getComputedStyle(r); maxH += r.offsetHeight + parseFloat(cs.marginTop||0) + parseFloat(cs.marginBottom||0); }
            maxH += 2; scroller.style.maxHeight = Math.ceil(maxH) + 'px';
          }

          function updateHint(){
            if(!hint) return;
            var hasMore = (scroller.scrollHeight - scroller.clientHeight) > 2;
            hint.classList.toggle('hidden', !hasMore);
            if(!hasMore) return;

            // compute direction
            var st = scroller.scrollTop;
            if (Math.abs(st - lastScrollTop) > 0.5) {
              lastDirUp = st < lastScrollTop; // true when scrolling up
            }
            lastScrollTop = st;

            var nearTop = st <= 1;
            var nearBottom = Math.ceil(st + scroller.clientHeight) >= scroller.scrollHeight - 2;

            // Decide arrow direction:
            // - at top -> point down
            // - at bottom -> point up
            // - otherwise -> follow last scroll direction
            var showUp = false;
            if (nearTop && !nearBottom) showUp = false;
            else if (nearBottom && !nearTop) showUp = true;
            else showUp = lastDirUp;

            var svg = hint.querySelector('svg');
            if(svg){ svg.classList.toggle('up', showUp); }
          }

          function fmt(n,d){ return d.unit==='%' ? (round(n,1)+'%') : (round(n,1)+' '+d.unit); }
          function fmtDelta(n,d){ if(!isFinite(n)) return '—'; var s=n>0?'+':''; return d.unit==='%'? (s+round(n,1)+' п.п.') : (s+round(n,1)+' '+d.unit); }
          function fmtDeltaNoUnit(n){ if(!isFinite(n)) return '—'; var s=n>0?'+':''; return s+round(n,1); }
          function round(n,p){ var m=Math.pow(10, (p||1)); return Math.round(n*m)/m; }

          draw();
          scroller.addEventListener('scroll', updateHint, { passive:true });
          window.addEventListener('resize', function(){ limitToRows(4); updateHint(); }, { passive:true });

          return { setData:function(payload){ state.data = Array.isArray(payload) ? payload : toRows(payload); draw(); } };
        }

        // Инициализация базовых данных
        var container = document.getElementById('pfHApp');
        var params = new URLSearchParams(location.search);
        var caseName = (params.get('case')||'').toLowerCase();

        var input = null;
        if(typeof window !== 'undefined' && window.PLAN_FACT_JSON){ input = window.PLAN_FACT_JSON; }
        else if(caseName === 'missing'){ input = parseJSONFromTemplate('pfData_missingDelta'); }
        else if(caseName === 'extreme'){ input = parseJSONFromTemplate('pfData_extreme'); }
        else if(caseName === 'minimal'){ input = parseJSONFromTemplate('pfData_minimal'); }
        else if(caseName === 'empty'){ input = parseJSONFromTemplate('pfData_empty'); }
        else if(caseName === 'malformed'){ input = parseJSONFromTemplate('pfData_malformed'); }
        else { input = parseJSONFromTemplate('pfData'); }
        if (input == null) { input = {}; }

        var api = render(container, toRows(input||{}));
        if(typeof window!== 'undefined'){
          window.PlanFactChart = { mount:function(el, json){ return render(el, toRows(json)); }, setData:function(json){ api && api.setData(json); } };
        }

        /* ==================== Временная шкала (серии дат) ==================== */
        (function initTimeline(){
          function parseJSONFromTemplateIfExists(id){ var el=document.getElementById(id); if(!el) return null; return parseJSONFromTemplate(id); }
          function normalizeSeries(input){
            if(!input) return { dates:[], rows:[] };
            var seriesMap = null;
            if (input.series && typeof input.series === 'object' && !Array.isArray(input.series)) {
              seriesMap = input.series;
            } else if (Array.isArray(input) && input.length && input[0] && typeof input[0] === 'object' && ('date' in input[0])) {
              seriesMap = {}; for (var i=0;i<input.length;i++){ var it=input[i]; if(!it) continue; var k=String(it.date||i); seriesMap[k] = it.data || it.snapshot || {}; }
            } else {
              return { dates:['—'], rows:[ toRows(input) ] };
            }
            var dates = Object.keys(seriesMap);
            dates.sort(function(a,b){ var da=new Date(a), db=new Date(b); if(isFinite(da.getTime()) && isFinite(db.getTime())) return da-db; return (a>b?1:-1); });
            var rows = []; for(var j=0;j<dates.length;j++){ rows.push( toRows(seriesMap[dates[j]]||{}) ); }
            return { dates:dates, rows:rows };
          }
          function formatDateRu(s){ var d=new Date(s); if(!isFinite(d.getTime())) return s; try{ return d.toLocaleDateString('ru-RU',{year:'numeric',month:'short',day:'2-digit'}); }catch(_){ return s; } }

          function setupTimeline(norm, api){
            const tl = document.getElementById('timeline');
            const wheel = document.getElementById('dateWheel');
            const maskEl = tl ? tl.querySelector('.wheel-mask') : null;
            if(!tl || !wheel) return;

            const n = (norm && Array.isArray(norm.rows)) ? norm.rows.length : 0;
            if(n <= 1){ tl.hidden = true; return; }

            tl.hidden = false; wheel.innerHTML = '';
            const items = new Array(n);

            function syncMask(){
              if(!maskEl) return;
              const el = items[Math.max(0, active)] || items[0];
              if(!el) return;
              const rect = el.getBoundingClientRect();
              const wr = wheel.getBoundingClientRect();
              const pr = tl.getBoundingClientRect();
              const padX = 8, padY = 8;
              const scale = 1.5; // шире чипа на 50%
              const w = Math.round(rect.width * scale + padX*2);
              const h = Math.round(rect.height + padY*2);
              // Прибиваем подложку к центру области колеса
              const centerX = wr.left + wr.width/2;
              const left = Math.round(centerX - w/2 - pr.left);
              const top  = Math.round((wr.top - pr.top) + (wr.height - h)/2);
              maskEl.style.setProperty('--mask-left', left + 'px');
              maskEl.style.setProperty('--mask-top',  top  + 'px');
              maskEl.style.setProperty('--mask-w',    w    + 'px');
              maskEl.style.setProperty('--mask-h',    h    + 'px');
            }
            for(let i=0;i<n;i++){
              const label = formatDateRu(norm.dates[i]||String(i));
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'item';
              btn.setAttribute('role','option');
              btn.setAttribute('aria-selected','false');
              btn.dataset.idx = String(i);
              btn.textContent = label;
              btn.addEventListener('click', function(){ centerTo(Number(this.dataset.idx), true, 'smooth'); });
              wheel.appendChild(btn);
              items[i] = btn;
            }

            function ensureSpacers(){
              const olds = wheel.querySelectorAll('.spacer'); olds.forEach(x=>x.remove());
              const left = document.createElement('div'); left.className='spacer'; left.setAttribute('aria-hidden','true');
              const right = document.createElement('div'); right.className='spacer'; right.setAttribute('aria-hidden','true');
              wheel.prepend(left); wheel.appendChild(right); resizeSpacers();
            }
            function resizeSpacers(){ const edge = Math.max(0, Math.floor(wheel.clientWidth/2)); wheel.style.setProperty('--edge', edge+'px'); }
            ensureSpacers();

            let active = -1, rafId = 0, snapTimer = 0;
            function setAria(){ for(let k=0;k<items.length;k++){ if(!items[k]) continue; items[k].setAttribute('aria-selected', String(k===active)); items[k].setAttribute('tabindex', k===active? '0':'-1'); } }
            function activate(i, announce){
              if(i === active || i < 0 || i >= n) return;
              if(items[active]){ items[active].classList.remove('active'); items[active].setAttribute('aria-selected','false'); }
              active = i;
              if(items[active]){ items[active].classList.add('active'); items[active].setAttribute('aria-selected','true'); }
              setAria();
              api && api.setData(norm.rows[i]||[]);
              syncMask();
            }
            function centerTo(i, announce, behavior){
              i = Math.max(0, Math.min(n-1, i)); const el = items[i]; if(!el) return;
              const target = el.offsetLeft + el.offsetWidth/2 - wheel.clientWidth/2;
              wheel.scrollTo({ left: Math.max(0, target), behavior: (behavior||'auto') });
              activate(i, announce);
              syncMask();
            }
            function onScroll(){
              if(rafId) cancelAnimationFrame(rafId);
              rafId = requestAnimationFrame(function(){
                const center = wheel.scrollLeft + wheel.clientWidth/2;
                let best = -1, bestDist = 1e12;
                for(let k=0;k<n;k++){
                  const el = items[k]; const c = el.offsetLeft + el.offsetWidth/2; const d = Math.abs(c - center);
                  if(d < bestDist){ bestDist = d; best = k; }
                }
                const changed = best !== active;
                activate(best, changed);
                syncMask();
                if(snapTimer) clearTimeout(snapTimer);
                snapTimer = setTimeout(function(){
                  const el = items[active]; if(!el) return;
                  const target = el.offsetLeft + el.offsetWidth/2 - wheel.clientWidth/2;
                  const curCenter = wheel.scrollLeft + wheel.clientWidth/2;
                  if(Math.abs(curCenter - (el.offsetLeft + el.offsetWidth/2)) > 3){
                    wheel.scrollTo({ left: Math.max(0, target), behavior: 'auto' });
                  }
                }, 140);
              });
            }

            wheel.addEventListener('scroll', onScroll, { passive:true });
            wheel.addEventListener('wheel', function(e){ if(Math.abs(e.deltaY) > Math.abs(e.deltaX)){ e.preventDefault(); wheel.scrollLeft += e.deltaY; } }, { passive:false });
            wheel.addEventListener('keydown', function(e){ if(e.key==='ArrowLeft'){ e.preventDefault(); centerTo(active-1, true, 'smooth'); } else if(e.key==='ArrowRight'){ e.preventDefault(); centerTo(active+1, true, 'smooth'); } });
            window.addEventListener('resize', function(){ resizeSpacers(); centerTo(active, false, 'auto'); syncMask(); }, { passive:true });

            centerTo(n-1, false, 'auto');
            syncMask();
          }

          function pickSeriesInput(){
            let seriesInput = parseJSONFromTemplateIfExists('pfSeries_demo');
            if (typeof window !== 'undefined' && window.PLAN_FACT_SERIES) { seriesInput = window.PLAN_FACT_SERIES; }
            else if (typeof window !== 'undefined' && window.PLAN_FACT_JSON && (window.PLAN_FACT_JSON.series || Array.isArray(window.PLAN_FACT_JSON))) { seriesInput = window.PLAN_FACT_JSON; }
            return seriesInput;
          }

          const seriesInput = pickSeriesInput();
          const norm = normalizeSeries(seriesInput||{});
          if (norm.rows.length>1){ const last = norm.rows[(norm.rows.length-1)|0] || []; api && api.setData(last); setupTimeline(norm, api); }
          else { const tl=document.getElementById('timeline'); if(tl) tl.hidden=true; }

          if (typeof window !== 'undefined' && window.PlanFactChart){
            window.PlanFactChart.setSeries = function(json){
              const nrm = normalizeSeries(json||{});
              if(api){ const l = nrm.rows[(nrm.rows.length-1)|0] || []; api.setData(l); }
              setupTimeline(nrm, api);
            };
          }
        })();
      })();
</script>
<!-- HAPTIC for horizontal wheel: touch-gated + throttled -->
<script>
(function () {
  var tg = window.Telegram && window.Telegram.WebApp;
  var h  = tg && tg.HapticFeedback;
  if (!tg || !h) return;
  try { tg.ready(); } catch(_) {}

  // утилиты
  var tick = function(){ try{ h.selectionChanged(); }catch(_){} };
  var bump = function(style){ try{ h.impactOccurred(style||'medium'); }catch(_){} };

  // корень и реальный скроллер
  var root = document.getElementById('dateWheel');
  if (!root) return;

  function isScrollableX(el){
    var cs = getComputedStyle(el), ox = cs.overflowX;
    return (ox==='auto'||ox==='scroll'||ox==='overlay') && (el.scrollWidth - el.clientWidth > 1);
  }
  var scroller = isScrollableX(root) ? root : Array.prototype.find.call(root.querySelectorAll('*'), isScrollableX) || root;

  // touch-гейтинг + троттлинг
  var touching = false, lastTick = 0, stopTimer = 0;
  var TICK_EVERY = 180;   // минимум ~0.18s между «тиками»
  var STOP_DELAY = 160;   // «тычок» после паузы

  root.addEventListener('touchstart', function(){ touching = true; clearTimeout(stopTimer); }, {passive:true});
  root.addEventListener('touchend',   function(){ touching = false; }, {passive:true});
  root.addEventListener('touchcancel',function(){ touching = false; }, {passive:true});

  scroller.addEventListener('scroll', function(){
    if (!touching) return;                         // только реальный жест
    var now = (performance && performance.now) ? performance.now() : Date.now();
    if (now - lastTick >= TICK_EVERY) { lastTick = now; tick(); }  // редкий «тик»
    clearTimeout(stopTimer);
    stopTimer = setTimeout(function(){ bump('medium'); }, STOP_DELAY); // «тычок» на стопе
  }, {passive:true});

  // быстрый «тик» при явном выборе
  root.addEventListener('click', function(e){
    if (e.target.closest && e.target.closest('.item')) tick();
  }, {passive:true});
})();
</script>

</body>
</html>
