<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Router</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --sbi: env(safe-area-inset-bottom,0px);
    --tile: 64px;
    --tile-gap: 16px;
    --tile-radius: 18px;
    --tile-bg: calc(var(--tile) + 4px);
    --tile-bg-radius: calc(var(--tile-radius) + 4px);
    --spawn-distance: 128px;
    --ripple-scale: 20;
  }

  *{margin:0;padding:0;box-sizing:border-box}
  html,body{height:100%;scrollbar-gutter:stable both-edges}
  html, body, button, .tile, .icon { -webkit-tap-highlight-color: transparent; }
  button { background: transparent; border: 0; }

  body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
    min-height:100vh;
    background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    padding:20px 16px calc(24px + var(--sbi)) 16px;
    color:#111;
    user-select:none;
  }
  .container{max-width:520px;margin:0 auto}

  .profile-card{
    background:rgba(255,255,255,.15);
    backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
    border-radius:24px;padding:20px 22px;margin-bottom:20px;
    border:1px solid rgba(255,255,255,.22);
    box-shadow:0 8px 32px rgba(0,0,0,.12),inset 0 1px 0 rgba(255,255,255,.35)
  }
  .profile-header{display:flex;gap:14px;align-items:center}
  .profile-photo{
    width:88px;height:88px;border-radius:50%;overflow:hidden;position:relative;flex:0 0 88px;
    display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:28px;
    background:linear-gradient(135deg,rgba(255,255,255,.35),rgba(255,255,255,.15));
    border:2px solid rgba(255,255,255,.28);
    box-shadow:0 10px 24px rgba(0,0,0,.22), inset 0 2px 6px rgba(255,255,255,.25)
  }
  .profile-photo::before{
    content:"";position:absolute;inset:0;border-radius:50%;
    background:radial-gradient(120% 120% at 50% -10%,rgba(255,255,255,.35),transparent 60%)
  }
  .avatar-img{width:100%;height:100%;display:block;border-radius:50%;object-fit:cover;object-position:50% 35%}
  .profile-name{color:#fff;font-weight:800;font-size:20px;line-height:1.15}
  .profile-id{margin-top:6px;font-size:12px;display:inline-block;color:rgba(255,255,255,.9);
    background:rgba(255,255,255,.14);padding:4px 8px;border-radius:8px}

  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--tile-gap);position:relative}
  .tile{position:relative;text-align:center;cursor:pointer;overflow:visible;
    transition:transform .18s ease, filter .22s ease, opacity .22s ease}
  .icon-wrap{width:var(--tile);height:var(--tile);margin:0 auto 8px;position:relative}
  .icon-bg{
    position:absolute;left:-2px;top:-2px;width:var(--tile-bg);height:var(--tile-bg);border-radius:var(--tile-bg-radius);
    background:linear-gradient(135deg,rgba(255,255,255,.4),rgba(255,255,255,.1));opacity:.6;transition:opacity .2s,transform .2s
  }
  .icon{
    position:absolute;inset:0;margin:auto;width:var(--tile);height:var(--tile);border-radius:var(--tile-radius);
    background:rgba(255,255,255,.22);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
    border:1.5px solid rgba(255,255,255,.45);display:flex;align-items:center;justify-content:center;
    box-shadow:0 8px 24px rgba(0,0,0,.12),inset 0 1px 0 rgba(255,255,255,.55);
    transition:transform .18s ease,box-shadow .18s ease
  }
  .icon-img{width:34px;height:34px;display:block}
  .label{font-size:12px;font-weight:700;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,.25)}
  .tile:active .icon{transform:scale(.92)}

  .grid .tile:hover > .icon-wrap > .icon{
    transform:translateY(-6px) scale(1.04);
    box-shadow:0 14px 28px rgba(0,0,0,.18),inset 0 1px 0 rgba(255,255,255,.6),0 0 22px rgba(102,126,234,.35)
  }
  .grid .tile:hover > .icon-wrap > .icon-bg{opacity:1;transform:scale(1.05)}

  .r{
    position:absolute;width:12px;height:12px;border-radius:999px;background:rgba(255,255,255,.35);
    left:0;top:0;transform:translate(-50%,-50%) scale(0);pointer-events:none;filter:blur(1px);
    animation:rr .6s ease-out forwards;will-change:transform,opacity
  }
  @keyframes rr{to{transform:translate(-50%,-50%) scale(var(--ripple-scale));opacity:0}}

  #startB{z-index:3}
  .spawn{
    position:absolute;left:50%;top:50%;width:90px;height:104px;
    transform:translate(-50%,-50%);
    opacity:0;pointer-events:none;background:transparent;padding:0;appearance:none;-webkit-appearance:none
  }
  .spawn .icon-wrap{width:var(--tile);height:var(--tile)}
  .spawn .label{margin-top:2px}

  .open-b .spawn{pointer-events:auto}
  .open-b .spawn.s1{opacity:1;transform:translate(-50%,-50%) rotate(-24deg) translate(var(--spawn-distance)) rotate(24deg)}
  .open-b .spawn.s2{opacity:1;transform:translate(-50%,-50%) rotate(24deg) translate(var(--spawn-distance)) rotate(-24deg)}
  .open-b #startB > .icon-wrap > .icon{transform:scale(.9)}

  .grid.focus .tile{filter:blur(2px) saturate(.85);opacity:.18;transform:translateY(8px)}
  .grid.focus #startB{filter:none;opacity:1;transform:none}

  .backdrop{position:fixed;inset:0;display:none}
  .backdrop.show{display:block}

  /* ===== Инструкция (модалка + слайды) ===== */
  .manual-overlay{
    position:fixed; inset:0; display:none;
    align-items:center; justify-content:center;
    background:rgba(0,0,0,.45); backdrop-filter:blur(6px);
    z-index:1000; padding:20px;
    overscroll-behavior: contain; /* не тянем подложку */
    touch-action: none; /* жесты ловим сами */
  }
  .manual-overlay.show{display:flex}
  .manual{
    position:relative; width:min(520px,92vw); max-height:86vh; background:#fff; border-radius:16px;
    box-shadow:0 22px 60px rgba(0,0,0,.35); overflow:hidden; display:flex; flex-direction:column;
    margin:auto; overscroll-behavior: contain;
  }
  .manual-header{padding:12px 16px 8px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between}
  .manual-title{font-weight:800;font-size:16px;color:#333}
  .manual-close{border:none;background:transparent;font-size:28px;line-height:1;padding:6px;cursor:pointer;color:#555}

  .manual-body{position:relative;overflow:hidden;height: calc(86vh - 56px - 44px);}
  .slides{display:flex;transition:transform .28s ease;height:100%;will-change:transform; touch-action: pan-y;}
  .slide{flex:0 0 100%; overflow:auto; padding:14px 16px 18px; -webkit-overflow-scrolling:touch; scrollbar-gutter:stable; content-visibility:auto; contain-intrinsic-size: 800px;}

  .slide::-webkit-scrollbar{width:8px}
  .slide::-webkit-scrollbar-thumb{background:#c5c9d2;border-radius:8px}
  .slide::-webkit-scrollbar-track{background:transparent}
  .slide{scrollbar-width:thin; scrollbar-color:#c5c9d2 transparent}

  .slide h3{margin:2px 0 10px;font-size:18px;color:#222}
  .slide .img-wrap{margin:6px 0 10px; position:relative}
  .slide .img-wrap img{width:100%;height:auto;display:block;border-radius:10px}
  .slide .img-wrap img.is-lq{filter:blur(12px); transform:scale(1.01); transition:filter .25s ease, transform .25s ease;}
  /* Debug badge (включается только когда есть data-flag) */
  .slide .img-wrap[data-flag]::after{content:attr(data-flag); position:absolute; top:8px; left:8px; padding:2px 6px; border-radius:999px; font-weight:800; font-size:10px; color:#fff; background:rgba(0,0,0,.62); letter-spacing:.4px}

  .slide p{white-space:pre-wrap;line-height:1.6;color:#333}

  .manual-footer{display:flex;align-items:center;justify-content:center;gap:8px;padding:10px}
  .dot{width:8px;height:8px;border-radius:999px;background:#d1d5db;cursor:pointer}
  .dot.active{background:#6366f1}

  .manual-loader{position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:#fff; gap:10px;}
  .manual-loader.show{display:flex}
  .spinner{width:28px; height:28px; border-radius:999px; border:3px solid #e5e7eb; border-top-color:#6366f1; animation:spin 0.8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .loading-text{font-weight:700;color:#4b5563}

  body.modal-open { overflow:hidden; touch-action:none; }
/* ==================================================
   ДОБАВЬТЕ В router.html В СЕКЦИЮ <style>
   После строки ~180
   ================================================== */

/* Убираем отступ под картинкой */
.slide .img-wrap {
    margin: 0 !important;
}

/* Картинка display: block убирает нижний отступ */
.slide .img-wrap img {
    display: block;
    margin: 0;
    padding: 0;
}

/* Отступ только у заголовка сверху */
.slide h3 {
    margin-top: 14px !important;
}


</style>
</head>
<body>
  <div class="container">
    <div class="profile-card">
      <div class="profile-header">
        <div class="profile-photo" id="userPhoto">A</div>
        <div class="profile-main">
          <div class="profile-name" id="userName">Загрузка...</div>
          <div class="profile-id" id="userId">ID: ---</div>
        </div>
      </div>
    </div>

    <div class="grid" id="gridB">
      <div class="tile" data-module="manual">
        <div class="icon-wrap"><div class="icon-bg"></div>
          <div class="icon"><img class="icon-img" id="ico-manual" alt="Инструкция"></div>
        </div>
        <div class="label">Инструкция</div>
      </div>

      <div class="tile" id="startB">
        <div class="icon-wrap"><div class="icon-bg"></div>
          <div class="icon"><img class="icon-img" id="ico-start" alt="Старт"></div>
        </div>
        <div class="label">Старт</div>

        <button class="spawn s1" id="btnProducts" aria-label="Выбор продуктов">
          <div class="icon-wrap"><div class="icon-bg"></div>
            <div class="icon"><img class="icon-img" id="ico-products" alt="Выбор продуктов"></div>
          </div>
          <div class="label">Выбор продуктов</div>
        </button>

        <button class="spawn s2" id="btnKbju" aria-label="Анкета КБЖУ">
          <div class="icon-wrap"><div class="icon-bg"></div>
            <div class="icon"><img class="icon-img" id="ico-kbju" alt="Анкета КБЖУ"></div>
          </div>
          <div class="label">Анкета КБЖУ</div>
        </button>
      </div>

      <div class="tile" data-module="measurements" data-href="https://groskaiser-design.github.io/product-selector/measurements.html">
        <div class="icon-wrap"><div class="icon-bg"></div>
          <div class="icon"><img class="icon-img" id="ico-measurements" alt="Замеры"></div>
        </div>
        <div class="label">Замеры</div>
      </div>

      <div class="tile" data-module="menu">
        <div class="icon-wrap"><div class="icon-bg"></div>
          <div class="icon"><img class="icon-img" id="ico-menu" alt="Рацион"></div>
        </div>
        <div class="label">Рацион</div>
      </div>

      <div class="tile" data-module="diary">
        <div class="icon-wrap"><div class="icon-bg"></div>
          <div class="icon"><img class="icon-img" id="ico-diary" alt="Отчёт"></div>
        </div>
        <div class="label">Отчёт</div>
      </div>

     
      <div class="tile" data-module="ai" data-href="https://groskaiser-design.github.io/product-selector/ai.html">
        <div class="icon-wrap"><div class="icon-bg"></div>
          <div class="icon"><img class="icon-img" id="ico-ai" alt="AI-Коуч"></div>
        </div>
        <div class="label">AI-Коуч</div>
      </div>

      <div class="tile" data-module="analytics" data-href="https://groskaiser-design.github.io/product-selector/2.html">
      <div class="icon-wrap"><div class="icon-bg"></div>
          <div class="icon"><img class="icon-img" id="ico-analytics" alt="Аналитика"></div>
        </div>
        <div class="label">Аналитика</div>
      </div>

      <div class="tile" data-module="profile">
        <div class="icon-wrap"><div class="icon-bg"></div>
          <div class="icon"><img class="icon-img" id="ico-profile" alt="Профиль"></div>
        </div>
        <div class="label">Профиль</div>
      </div>

      <div class="tile" data-module="subscription">
        <div class="icon-wrap"><div class="icon-bg"></div>
          <div class="icon"><img class="icon-img" id="ico-subscription" alt="Подписка"></div>
        </div>
        <div class="label">Подписка</div>
      </div>
    </div>
  </div>

  <div class="backdrop" id="backdrop"></div>
  <div id="toast" style="position:fixed;left:50%;bottom:86px;transform:translateX(-50%);background:rgba(0,0,0,.82);color:#fff;padding:10px 14px;border-radius:10px;font-weight:700;z-index:1000;opacity:0;transition:opacity .2s"></div>

  <div class="manual-overlay" id="manualOverlay" aria-hidden="true">
    <div class="manual" role="dialog" aria-modal="true" aria-labelledby="manualTitle">
      <div class="manual-header">
        <div class="manual-title" id="manualTitle">Инструкция</div>
        <button class="manual-close" id="manualClose" aria-label="Закрыть">×</button>
      </div>
      <div class="manual-body">
        <div class="manual-loader" id="manualLoader">
          <div class="spinner"></div>
          <div class="loading-text">Загрузка…</div>
        </div>
        <div class="slides" id="slides"></div>
      </div>
      <div class="manual-footer" id="dots"></div>
    </div>
  </div>

<script>
  /* ====== ВЕРСИЯ ПРИЛОЖЕНИЯ ====== */
  const APP_HTML_VERSION = 'router-logger-v21';

  /* ====== КОНСТАНТЫ КЛЮЧЕЙ ====== */
  const KEY_APP_VER = 'router:app_version';
  const KEY_USER    = 'router:user';

  // === Параметры дебага progressive-изображений из URL ===
  const URLP = new URLSearchParams(location.search);
  const IMG_TEST = URLP.get('imgtest') === '1';
  let   IMG_LQ_WIDTH   = parseInt(URLP.get('lqw') || '640', 10);
  let   IMG_LQ_QUALITY = Math.max(0.05, Math.min(1, parseFloat(URLP.get('lqq')||'0.6') || 0.6));
  let   HQ_SWITCH_MIN_DELAY = parseInt(URLP.get('hqdelay') || (IMG_TEST ? '1000' : '0'), 10);
  const net = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
  let   FORCE_LQ_ONLY = URLP.get('lqonly') === '1' || (!!net && net.saveData && URLP.get('lqonly') === null);

  // Пул вариантов изображений { lq, hq }
  const manualVariantsMap = new Map();

  // Не трогаем URL в TG, но если не совпадает параметр версии и это НЕ TG — добавим.
  (function ensureVersionParam(){
    try{
      const isTG = !!(window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData);
      if (isTG) return; // в TG не ковыряем URL
      const u = new URL(location.href);
      if (u.searchParams.get('v') !== APP_HTML_VERSION) {
        u.searchParams.set('v', APP_HTML_VERSION);
        history.replaceState(null, '', u.toString());
      }
    }catch(_){ }
  })();

  // Чистим ТОЛЬКО данные инструкции при смене версии (пользователя не трогаем)
  (async function ensureVersionedStorage(){
    try{
      const prev = localStorage.getItem(KEY_APP_VER);
      if (prev === APP_HTML_VERSION) return;

      // чистим только manual
      for (let i=localStorage.length-1;i>=0;i--){
        const k = localStorage.key(i);
        if (!k) continue;
        if (k.startsWith('router:manual:')) localStorage.removeItem(k);
      }
      // чистим кэши инструкций
      if (window.caches && caches.keys){
        const keys = await caches.keys();
        await Promise.all(keys.filter(k=>k.startsWith('router-manual-') && k !== `router-manual-${APP_HTML_VERSION}`).map(k=>caches.delete(k)));
      }
      // ревокнем objectURL-ы
      manualVariantsMap.forEach(rec=>{ ['lq','hq'].forEach(key=>{ try{ if(rec[key]) URL.revokeObjectURL(rec[key]); }catch(_){ } }); });
      manualVariantsMap.clear();

      localStorage.setItem(KEY_APP_VER, APP_HTML_VERSION);
    }catch(_){ }
  })();

  /* ====== КОНФИГ ====== */
  const LOG_URL  = 'https://script.google.com/macros/s/AKfycbxiAK2m6ms2ckXFQGHB9m3Lvb2tgv1TnS4wYVOGCm_-Hvc-ranLbQeKfQM_lnOkEQUH/exec';
  const ICON_BASE = 'https://groskaiser-design.github.io/icons/';
  const ICONS = { manual:'question.svg', start:'play.svg', products:'cart.svg', kbju:'clipboard.svg', measurements:'scales.svg', menu:'menu.svg', diary:'diary.svg', ai:'ai.svg', analytics:'analytics.svg', profile:'profile.svg', subscription:'rub.svg' };

  // Telegram env
  var tg=(window.Telegram&&window.Telegram.WebApp)?window.Telegram.WebApp:{
    initData:'',initDataUnsafe:{},ready:function(){},expand:function(){},
    BackButton:{show:function(){},hide:function(){},onClick:function(){}},
    HapticFeedback:{impactOccurred:function(){},selectionChanged:function(){},notificationOccurred:function(){}},
    showAlert:function(m){console.log(m)}
  };
  try{tg.ready();tg.expand();}catch(e){}

  // Haptics
  function hImpact(type='light'){ try{ tg.HapticFeedback?.impactOccurred?.(type); } catch(_){} }
  function hSelect(){ try{ tg.HapticFeedback?.selectionChanged?.(); } catch(_){} }
  function hNotify(type='success'){ try{ tg.HapticFeedback?.notificationOccurred?.(type); } catch(_){} }

  // Logging helpers
  function baseUser(){
    // берём из TG или из локального хранилища
    const u = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) || (function(){ try{ return JSON.parse(localStorage.getItem(KEY_USER)||'null'); }catch(_){ return null; } })() || {};
    return { user_id: u.id || '', username: ((u.first_name||'') + (u.last_name ? ' '+u.last_name : '') || u.username || '').trim() };
  }
  function pixelFallback(body){ try{ const q = new URLSearchParams({ action:'log', module: body.module || 'router', page: body.page || (location.pathname.split('/').pop()||'router.html'), event: body.event || '', user_id: body.user_id || '', username: body.username || '', client_ts: body.client_ts || new Date().toISOString(), payload: btoa(unescape(encodeURIComponent(JSON.stringify(body.payload||{})))) }).toString(); const img = new Image(); img.src = LOG_URL + '?' + q + '&_t=' + Date.now(); }catch(_){ } }
  function _sendLog(body){ try{ if(navigator.sendBeacon){ const blob = new Blob([JSON.stringify(body)], {type:'application/json'}); navigator.sendBeacon(LOG_URL, blob); } }catch(_){ } pixelFallback(body); }
  function logEvent(event, payload){ try{ const body = { action:'log', module:'router', page:(location.pathname.split('/').pop()||'router.html'), event:String(event||''), ...baseUser(), payload:payload||{}, client_ts:new Date().toISOString() }; _sendLog(body); }catch(_){ } }
  function logManual(event, payload){ logEvent(event, payload); }

  // Иконки
  (function attachIcons(){ const map = [['ico-manual',ICONS.manual],['ico-start',ICONS.start],['ico-products',ICONS.products],['ico-kbju',ICONS.kbju],['ico-measurements',ICONS.measurements],['ico-menu',ICONS.menu],['ico-diary',ICONS.diary],['ico-ai',ICONS.ai],['ico-analytics',ICONS.analytics],['ico-profile',ICONS.profile],['ico-subscription',ICONS.subscription]]; map.forEach(([id,file])=>{ const el=document.getElementById(id); if(el){ el.src=ICON_BASE+file; el.decoding='async'; el.loading='eager'; } }); })();

  // Глобальная хаптика на иконки
  document.addEventListener('pointerdown', (e)=>{ const host = e.target.closest?.('.icon'); if(!host) return; hImpact('light'); }, {passive:true});

  /* ====== Профиль (никогда не теряем) ====== */
  (function(){
    try{
      const nameEl=document.getElementById('userName');
      const idEl=document.getElementById('userId');
      const photoEl=document.getElementById('userPhoto');

      // Пробуем TG
      let u = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) || null;
      if (u && u.id){
        // Сохраним на будущее
        try{ localStorage.setItem(KEY_USER, JSON.stringify({ id:u.id, first_name:u.first_name, last_name:u.last_name, username:u.username, photo_url:u.photo_url })); }catch(_){ }
      } else {
        // Возьмём из локального кеша, если нет TG
        try{ u = JSON.parse(localStorage.getItem(KEY_USER)||'null'); }catch(_){ u=null; }
      }

      if (u && u.id){
        const full=((u.first_name||'')+' '+(u.last_name||'')).trim() || u.username || 'Пользователь';
        nameEl.textContent=full; idEl.textContent='ID: '+(u.id||'---');
        if(u.photo_url){
          const img=new Image(); img.src=u.photo_url; img.alt=full; img.className='avatar-img';
          photoEl.textContent='';
          photoEl.appendChild(img);
        } else {
          photoEl.textContent=(full.charAt(0)||'A').toUpperCase();
        }
        logEvent('profile_loaded', { has_photo: !!u.photo_url });
      } else {
        // Фолбэк демо, если ни TG, ни кеша нет
        nameEl.textContent='Пользователь'; idEl.textContent='ID: ---'; photoEl.textContent='P';
        logEvent('profile_loaded_demo', {});
      }
    }catch(e){}
  })();

  function toast(msg){ var t=document.getElementById('toast'); t.textContent=msg; t.style.opacity='1'; hNotify('success'); setTimeout(function(){t.style.opacity='0';},1200); }

  /* ====== Ripple ====== */
  function rippleIn(target, e){ try{ var host = (target.closest && target.closest('.icon')) || (target.querySelector && target.querySelector('.icon')) || null; if(!host){ return; } const prev = host.querySelector('.r'); if (prev) prev.remove(); var r=document.createElement('span'); r.className='r'; var b=host.getBoundingClientRect(); var pt = (e.touches && e.touches[0]) ? e.touches[0] : e; r.style.left=(pt.clientX-b.left)+'px'; r.style.top=(pt.clientY-b.top)+'px'; host.appendChild(r); r.addEventListener('animationend',function(){ r.remove(); },false); }catch(_){ } }

  function bindTap(el, handler){ let lastTouch = 0; if (window.PointerEvent){ el.addEventListener('pointerdown', function(e){ if (e.pointerType === 'mouse' && e.button !== 0) return; handler(e); }); } else { el.addEventListener('touchstart', function(e){ lastTouch = Date.now(); handler(e); }, {passive:true}); el.addEventListener('click', function(e){ if (Date.now() - lastTouch < 500) return; handler(e); }); } }

  /* ====== ВСПОМОГАТЕЛЬНЫЕ ДЛЯ КАРТИНОК ====== */
  function withVersion(url){ if(!url) return url; try{ const u = new URL(url, location.href); u.searchParams.set('v', APP_HTML_VERSION); return u.toString(); }catch(_){ return url + (url.includes('?')?'&':'?') + 'v=' + encodeURIComponent(APP_HTML_VERSION); } }

  async function blobToBitmap(blob){
    try{ return await createImageBitmap(blob); }
    catch(_){ return await new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=URL.createObjectURL(blob); }); }
  }

  async function makeLQBlobFromBlob(blob){
    const bmp = await blobToBitmap(blob);
    const scale = Math.min(1, IMG_LQ_WIDTH / (bmp.width||IMG_LQ_WIDTH));
    const w = Math.max(1, Math.round((bmp.width||IMG_LQ_WIDTH)*scale));
    const h = Math.max(1, Math.round((bmp.height||IMG_LQ_WIDTH)*scale));
    const canvas = document.createElement('canvas');
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(bmp, 0, 0, w, h);
    const asWebP = await new Promise(r=>canvas.toBlob(b=>r(b), 'image/webp', IMG_LQ_QUALITY));
    if (asWebP) return asWebP;
    return await new Promise(r=>canvas.toBlob(b=>r(b), 'image/jpeg', IMG_LQ_QUALITY));
  }

  async function ensureVariants(url){
    try{
      if(!url) return null;
      const vurl = withVersion(url);
      if (manualVariantsMap.has(vurl)) return manualVariantsMap.get(vurl);

      const rec = { lq:null, hq:null };
      manualVariantsMap.set(vurl, rec);

      const cache = ('caches' in window) ? await caches.open(`router-manual-${APP_HTML_VERSION}`) : null;

      const lqKey = vurl + (vurl.includes('?')?'&':'?') + `lq=1&w=${IMG_LQ_WIDTH}`;

      let hqResp = null;
      if (cache) hqResp = await cache.match(vurl);
      if (!hqResp){
        hqResp = await fetch(new Request(vurl, {mode:'cors'}));
        if (hqResp && hqResp.ok && cache) await cache.put(vurl, hqResp.clone());
      }
      const hqBlob = await hqResp.blob();

      // Попробуем достать LQ из кэша
      let lqResp = null;
      if (cache) lqResp = await cache.match(lqKey);
      let lqBlob = lqResp ? await lqResp.blob() : null;
      if (!lqBlob){
        // Сгенерим LQ и положим в кэш
        try{
          lqBlob = await makeLQBlobFromBlob(hqBlob);
          if (lqBlob && cache) await cache.put(lqKey, new Response(lqBlob));
        }catch(_){ /* игнор */ }
      }

      // Сформируем objectURL-ы
      if (lqBlob){ rec.lq = URL.createObjectURL(lqBlob); }
      if (hqBlob){ rec.hq = URL.createObjectURL(hqBlob); }

      return rec;
    }catch(_){ return null; }
  }

  async function preloadVariantsForSlides(slides){
    try{
      const imgs = (slides||[]).map(s=>s && s.image).filter(Boolean).slice(0,50);
      await Promise.all(imgs.map(u=>ensureVariants(u)));
    }catch(_){ }
  }

  /* ====== Меню и Инструкция ====== */
  (function(){
    var grid=document.getElementById('gridB');
    var start=document.getElementById('startB');
    var btnProducts=document.getElementById('btnProducts');
    var btnKbju=document.getElementById('btnKbju');
    var backdrop=document.getElementById('backdrop');
    var opened=false, backHandler=null;

    function openMenu(){ if(opened) return; opened=true; start.classList.add('open-b'); grid.classList.add('focus'); backdrop.classList.add('show'); logEvent('menu_open', {}); try{ tg.BackButton.show(); if(tg.BackButton.onClick){ backHandler=function(){ closeMenu(); }; tg.BackButton.onClick(backHandler);} }catch(_){ } }
    function closeMenu(){ if(!opened) return; opened=false; start.classList.remove('open-b'); grid.classList.remove('focus'); backdrop.classList.remove('show'); logEvent('menu_close', {}); try{ tg.BackButton.hide(); if(backHandler){ tg.BackButton.onClick(function(){}); backHandler=null; } }catch(_){ } }

    bindTap(start, function(e){ hImpact('light'); rippleIn(e.target, e); logEvent('start_tap', { was_opened: opened }); (opened ? closeMenu : openMenu)(); });

    function goAfterRipple(url, name, e){ hImpact('light'); rippleIn(e.target, e); logEvent('spawn_tap', { target: name, was_opened: opened }); if (opened) closeMenu(); setTimeout(function(){ logEvent('navigate', { to: url }); window.location.href=url; }, 90); }
    bindTap(btnProducts, function(e){ e.stopPropagation(); goAfterRipple('products.html', 'products', e); });
    bindTap(btnKbju,     function(e){ e.stopPropagation(); goAfterRipple('kbju.html',     'kbju',     e); });

    bindTap(backdrop, function(){ logEvent('backdrop_tap', {}); closeMenu(); });
    document.addEventListener('keydown',function(e){ if(e.key==='Escape'){ logEvent('press_escape', {}); closeMenu(); } });

    var tiles=document.querySelectorAll('.tile[data-module]');
    tiles.forEach(function(t){
      const mod = t.getAttribute('data-module');
      if(mod==='manual') return;
      bindTap(t, function(ev){
        hImpact('light'); rippleIn(ev.target, ev);
        logEvent('tile_tap', { module: mod, was_opened: opened });
        const href = t.dataset.href;
        if (opened) { closeMenu(); }
        if (href) {
          setTimeout(function(){ logEvent('navigate', { to: href, module: mod }); window.location.href = href; }, 90);
          return;
        }
        toast('Раздел в разработке');
      });
    });

    /* ====== Инструкция ====== */
    const manualTile = document.querySelector('.tile[data-module="manual"]');
    const overlay = document.getElementById('manualOverlay');
    const slidesEl = document.getElementById('slides');
    const dotsEl   = document.getElementById('dots');
    const closeBtn = document.getElementById('manualClose');
    const loaderEl = document.getElementById('manualLoader');

    const MANUAL_LS_KEY   = `router:manual:${APP_HTML_VERSION}`;

    let slidesCache = null; let cur = 0; let renderedOnce = false;

    function escapeHtml(s){ return (s||'').replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]||m)); }

    function renderSlides(slides){
      if (renderedOnce) return; // не перерисовываем повторно
      slidesEl.innerHTML=''; dotsEl.innerHTML='';
      slides.forEach((s,i)=>{
        const card = document.createElement('div'); card.className='slide';
        const parts=[];
        if (s.title) parts.push(`<h3>${escapeHtml(s.title)}</h3>`);
        if (s.image) parts.push(`<div class="img-wrap${IMG_TEST ? ' debug' : ''}" ${IMG_TEST ? 'data-flag="LQ"' : ''}><img class="is-lq" data-url="${s.image}" alt="" loading="eager" decoding="async"></div>`);
        if (s.text)  parts.push(`<p class="slide-text">${s.text}</p>`);
        if (!parts.length) parts.push(`<p style="color:#6B7280">Пустой слайд #${i+1}</p>`);
        card.innerHTML = parts.join(''); slidesEl.appendChild(card);
        const dot=document.createElement('div'); dot.className='dot'; if(i===0) dot.classList.add('active'); dot.addEventListener('pointerdown', ()=>hImpact('light'), {passive:true}); dot.addEventListener('click',()=>goTo(i)); dotsEl.appendChild(dot);
      });
      cur=0; applyTransform(); logManual('manual_slide_view',{index:0});
      renderedOnce = true;
    }

    async function hydrateImagesProgressive(){
      const imgs = slidesEl.querySelectorAll('img[data-url]');
      for (const img of imgs){
        const raw = img.getAttribute('data-url');
        const wrap = img.closest('.img-wrap');
        const t0 = performance.now();
        const rec = await ensureVariants(raw);
        if (!rec) {
          img.src = withVersion(raw); img.classList.remove('is-lq'); img.removeAttribute('data-url');
          if (IMG_TEST && wrap) wrap.setAttribute('data-flag','HQ');
          continue;
        }
        if (rec.lq) img.src = rec.lq;
        if (IMG_TEST && wrap) wrap.setAttribute('data-flag','LQ');
        // при режиме экономии трафика оставляем LQ
        if (FORCE_LQ_ONLY || !rec.hq) { img.classList.remove('is-lq'); if (IMG_TEST && wrap) wrap.setAttribute('data-flag','LQ*'); img.removeAttribute('data-url'); continue; }
        const hq = new Image();
        hq.decoding = 'async';
        hq.onload = ()=>{
          const dt = performance.now() - t0;
          const extra = Math.max(0, HQ_SWITCH_MIN_DELAY - dt);
          setTimeout(()=>{ img.src = rec.hq; img.classList.remove('is-lq'); if (IMG_TEST && wrap) wrap.setAttribute('data-flag','HQ'); console.debug('[manual] LQ→HQ', {ms: dt+extra, url: raw}); }, extra);
        };
        hq.src = rec.hq;
        img.removeAttribute('data-url');
      }
    }

    function applyTransform(){ slidesEl.style.transform = `translateX(${-100*cur}%)`; Array.from(dotsEl.children).forEach((d,i)=>d.classList.toggle('active', i===cur)); }
    function goTo(n){ if(!slidesCache) return; const max=slidesCache.length; const old=cur; cur=Math.max(0,Math.min(max-1,n)); if(cur!==old){ applyTransform(); hSelect(); logManual('manual_slide_view',{index:cur}); } }
    function next(){ if(!slidesCache) return; if(cur<slidesCache.length-1){ cur++; applyTransform(); hSelect(); logManual('manual_next',{index:cur}); } }
    function prev(){ if(!slidesCache) return; if(cur>0){ cur--; applyTransform(); hSelect(); logManual('manual_prev',{index:cur}); } }

    async function fetchManualFresh(){ const r = await fetch(`${LOG_URL}?action=get_manual`, {cache:'no-store'}); const j = await r.json(); const slides = (j && j.ok && Array.isArray(j.slides)) ? j.slides : []; return slides.length ? slides.slice(0,50) : [{title:'Инструкция недоступна', text:'Добавьте контент в лист "Manual" файла Router Logger.'}]; }

    async function openManual(){
      if (opened) closeMenu();
      hImpact('light');
      document.body.classList.add('modal-open');
      overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false');
      logManual('manual_open',{});

      if (renderedOnce){ return; }

      const cached = (function(){ try{ const raw = localStorage.getItem(MANUAL_LS_KEY); return raw ? JSON.parse(raw) : null; }catch(_){ return null; } })();
      if (cached) {
        slidesCache = cached; renderSlides(slidesCache); hydrateImagesProgressive(); return;
      }

      loaderEl.classList.add('show');
      try{
        const fresh = await fetchManualFresh();
        slidesCache = fresh; localStorage.setItem(MANUAL_LS_KEY, JSON.stringify(fresh));
        renderSlides(slidesCache);
        await preloadVariantsForSlides(fresh);
        await hydrateImagesProgressive();
      }catch(err){
        slidesCache = [{title:'Ошибка', text:String(err)}];
        renderSlides(slidesCache);
      } finally { loaderEl.classList.remove('show'); }
    }

    function closeManual(){ hImpact('light'); overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); document.body.classList.remove('modal-open'); logManual('manual_close',{index:cur}); }

    // Свайп — фикс подложки
    let startX=0, startY=0, tracking=false, lock=null; const THRESH_START = 12; const THRESH_SWITCH = 64;
    slidesEl.addEventListener('pointerdown', (e)=>{ tracking = true; lock = null; startX = e.clientX; startY = e.clientY; }, {passive:false});
    slidesEl.addEventListener('pointermove', (e)=>{ if(!tracking) return; const dx = e.clientX - startX, dy = e.clientY - startY; if (lock === null) { if (Math.abs(dx) > THRESH_START && Math.abs(dx) > Math.abs(dy)) { lock = 'x'; hSelect(); } else if (Math.abs(dy) > THRESH_START) { lock = 'y'; } } if (lock === 'x') { e.preventDefault(); } }, {passive:false});
    function endPointer(e){ if(!tracking) return; const dx = e.clientX - startX; const wasX = (lock === 'x'); tracking = false; lock = null; if (wasX && Math.abs(dx) > THRESH_SWITCH) { dx < 0 ? next() : prev(); } }
    ['pointerup','pointercancel','pointerleave'].forEach(ev=>{ slidesEl.addEventListener(ev, endPointer, {passive:false}); });

    document.addEventListener('keydown', e=>{ if (!overlay.classList.contains('show')) return; if (e.key==='ArrowRight') next(); if (e.key==='ArrowLeft')  prev(); if (e.key==='Escape') closeManual(); });

    bindTap(closeBtn, ()=>closeManual());
    bindTap(manualTile, e=>{ rippleIn(e.target,e); openManual(); });

    // Тёплый старт: если локально уже есть — заранее прогреть варианты
    (function warmManual(){ const idle = window.requestIdleCallback || function(cb){ setTimeout(cb, 700); }; idle(async ()=>{ const raw = localStorage.getItem(MANUAL_LS_KEY); if (!raw) return; try{ const slides = JSON.parse(raw); await preloadVariantsForSlides(slides); }catch(_){ } }); })();

    logEvent('app_open', {}); logEvent('ping', {version:APP_HTML_VERSION});
  })();

  window.addEventListener('error', function(e){ logEvent('js_error', { message: e.message, file: e.filename, line: e.lineno, col: e.colno }); });
  window.addEventListener('unhandledrejection', function(e){ logEvent('promise_rejection', { reason: (e.reason && (e.reason.stack || e.reason.message)) || String(e.reason) }); });
</script>
</body>
</html>
