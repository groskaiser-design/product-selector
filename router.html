<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Router</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --sbi: env(safe-area-inset-bottom,0px);
    --tile: 64px;
    --tile-gap: 16px;
    --tile-radius: 18px;
    --tile-bg: calc(var(--tile) + 4px);
    --tile-bg-radius: calc(var(--tile-radius) + 4px);
    --spawn-distance: 128px;
    --ripple-scale: 20;
  }

  *{margin:0;padding:0;box-sizing:border-box}
  html,body{height:100%;scrollbar-gutter:stable both-edges}
  html, body, button, .tile, .icon { -webkit-tap-highlight-color: transparent; }
  button { background: transparent; border: 0; }

  body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
    min-height:100vh;
    background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    padding:20px 16px calc(24px + var(--sbi)) 16px;
    color:#111;
    user-select:none;
  }
  .container{max-width:520px;margin:0 auto}

  .profile-card{
    background:rgba(255,255,255,.15);
    backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
    border-radius:24px;padding:20px 22px;margin-bottom:20px;
    border:1px solid rgba(255,255,255,.22);
    box-shadow:0 8px 32px rgba(0,0,0,.12),inset 0 1px 0 rgba(255,255,255,.35)
  }
  .profile-header{display:flex;gap:14px;align-items:center}
  .profile-photo{
    width:88px;height:88px;border-radius:50%;overflow:hidden;position:relative;flex:0 0 88px;
    display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:28px;
    background:linear-gradient(135deg,rgba(255,255,255,.35),rgba(255,255,255,.15));
    border:2px solid rgba(255,255,255,.28);
    box-shadow:0 10px 24px rgba(0,0,0,.22), inset 0 2px 6px rgba(255,255,255,.25)
  }
  .profile-photo::before{
    content:"";position:absolute;inset:0;border-radius:50%;
    background:radial-gradient(120% 120% at 50% -10%,rgba(255,255,255,.35),transparent 60%)
  }
  .avatar-img{width:100%;height:100%;display:block;border-radius:50%;object-fit:cover;object-position:50% 35%}
  .profile-name{color:#fff;font-weight:800;font-size:20px;line-height:1.15}
  .profile-id{margin-top:6px;font-size:12px;display:inline-block;color:rgba(255,255,255,.9);
    background:rgba(255,255,255,.14);padding:4px 8px;border-radius:8px}

  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--tile-gap);position:relative}
  .tile{position:relative;text-align:center;cursor:pointer;overflow:visible;
    transition:transform .18s ease, filter .22s ease, opacity .22s ease}
  .icon-wrap{width:var(--tile);height:var(--tile);margin:0 auto 8px;position:relative}
  .icon-bg{
    position:absolute;left:-2px;top:-2px;width:var(--tile-bg);height:var(--tile-bg);border-radius:var(--tile-bg-radius);
    background:linear-gradient(135deg,rgba(255,255,255,.4),rgba(255,255,255,.1));opacity:.6;transition:opacity .2s,transform .2s
  }
  .icon{
    position:absolute;inset:0;margin:auto;width:var(--tile);height:var(--tile);border-radius:var(--tile-radius);
    background:rgba(255,255,255,.22);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
    border:1.5px solid rgba(255,255,255,.45);display:flex;align-items:center;justify-content:center;
    box-shadow:0 8px 24px rgba(0,0,0,.12),inset 0 1px 0 rgba(255,255,255,.55);
    transition:transform .18s ease,box-shadow .18s ease
  }
  .icon-img{width:34px;height:34px;display:block}
  .label{font-size:12px;font-weight:700;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,.25)}
  .tile:active .icon{transform:scale(.92)}

  .grid .tile:hover > .icon-wrap > .icon{
    transform:translateY(-6px) scale(1.04);
    box-shadow:0 14px 28px rgba(0,0,0,.18),inset 0 1px 0 rgba(255,255,255,.6),0 0 22px rgba(102,126,234,.35)
  }
  .grid .tile:hover > .icon-wrap > .icon-bg{opacity:1;transform:scale(1.05)}

  .r{
    position:absolute;width:12px;height:12px;border-radius:999px;background:rgba(255,255,255,.35);
    left:0;top:0;transform:translate(-50%,-50%) scale(0);pointer-events:none;filter:blur(1px);
    animation:rr .6s ease-out forwards;will-change:transform,opacity
  }
  @keyframes rr{to{transform:translate(-50%,-50%) scale(var(--ripple-scale));opacity:0}}

  #startB{z-index:3}
  .spawn{
    position:absolute;left:50%;top:50%;width:90px;height:104px;
    transform:translate(-50%,-50%);
    opacity:0;pointer-events:none;background:transparent;padding:0;appearance:none;-webkit-appearance:none
  }
  .spawn .icon-wrap{width:var(--tile);height:var(--tile)}
  .spawn .label{margin-top:2px}

  .open-b .spawn{pointer-events:auto}
  .open-b .spawn.s1{opacity:1;transform:translate(-50%,-50%) rotate(-24deg) translate(var(--spawn-distance)) rotate(24deg)}
  .open-b .spawn.s2{opacity:1;transform:translate(-50%,-50%) rotate(24deg) translate(var(--spawn-distance)) rotate(-24deg)}
  .open-b #startB > .icon-wrap > .icon{transform:scale(.9)}

  .grid.focus .tile{filter:blur(2px) saturate(.85);opacity:.18;transform:translateY(8px)}
  .grid.focus #startB{filter:none;opacity:1;transform:none}

  .backdrop{position:fixed;inset:0;display:none}
  .backdrop.show{display:block}
</style>
</head>
<body>
  <div class="container">
    <div class="profile-card">
      <div class="profile-header">
        <div class="profile-photo" id="userPhoto">A</div>
        <div class="profile-main">
          <div class="profile-name" id="userName">Загрузка...</div>
          <div class="profile-id" id="userId">ID: ---</div>
        </div>
      </div>
    </div>

    <div class="grid" id="gridB">
      <div class="tile" data-module="manual">
        <div class="icon-wrap"><div class="icon-bg"></div>
          <div class="icon"><img class="icon-img" id="ico-manual" alt="Инструкция"></div>
        </div>
        <div class="label">Инструкция</div>
      </div>

      <div class="tile" id="startB">
        <div class="icon-wrap"><div class="icon-bg"></div>
          <div class="icon"><img class="icon-img" id="ico-start" alt="Старт"></div>
        </div>
        <div class="label">Старт</div>

        <button class="spawn s1" id="btnProducts" aria-label="Выбор продуктов">
          <div class="icon-wrap"><div class="icon-bg"></div>
            <div class="icon"><img class="icon-img" id="ico-products" alt="Выбор продуктов"></div>
          </div>
          <div class="label">Выбор продуктов</div>
        </button>

        <button class="spawn s2" id="btnKbju" aria-label="Анкета КБЖУ">
          <div class="icon-wrap"><div class="icon-bg"></div>
            <div class="icon"><img class="icon-img" id="ico-kbju" alt="Анкета КБЖУ"></div>
          </div>
          <div class="label">Анкета КБЖУ</div>
        </button>
      </div>

      <div class="tile" data-module="measurements">
        <div class="icon-wrap"><div class="icon-bg"></div>
          <div class="icon"><img class="icon-img" id="ico-measurements" alt="Замеры"></div>
        </div>
        <div class="label">Замеры</div>
      </div>

      <div class="tile" data-module="menu">
        <div class="icon-wrap"><div class="icon-bg"></div>
          <div class="icon"><img class="icon-img" id="ico-menu" alt="Рацион"></div>
        </div>
        <div class="label">Рацион</div>
      </div>

      <div class="tile" data-module="diary">
        <div class="icon-wrap"><div class="icon-bg"></div>
          <div class="icon"><img class="icon-img" id="ico-diary" alt="Отчёт"></div>
        </div>
        <div class="label">Отчёт</div>
      </div>

      <div class="tile" data-module="ai">
        <div class="icon-wrap"><div class="icon-bg"></div>
          <div class="icon"><img class="icon-img" id="ico-ai" alt="AI-Коуч"></div>
        </div>
        <div class="label">AI-Коуч</div>
      </div>

      <div class="tile" data-module="analytics">
        <div class="icon-wrap"><div class="icon-bg"></div>
          <div class="icon"><img class="icon-img" id="ico-analytics" alt="Аналитика"></div>
        </div>
        <div class="label">Аналитика</div>
      </div>

      <div class="tile" data-module="profile">
        <div class="icon-wrap"><div class="icon-bg"></div>
          <div class="icon"><img class="icon-img" id="ico-profile" alt="Профиль"></div>
        </div>
        <div class="label">Профиль</div>
      </div>

      <div class="tile" data-module="subscription">
        <div class="icon-wrap"><div class="icon-bg"></div>
          <div class="icon"><img class="icon-img" id="ico-subscription" alt="Подписка"></div>
        </div>
        <div class="label">Подписка</div>
      </div>
    </div>
  </div>

  <div class="backdrop" id="backdrop"></div>
  <div id="toast" style="position:fixed;left:50%;bottom:86px;transform:translateX(-50%);background:rgba(0,0,0,.82);color:#fff;padding:10px 14px;border-radius:10px;font-weight:700;z-index:1000;opacity:0;transition:opacity .2s"></div>

<script>
  /* ====== КОНФИГ ЛОГИРОВАНИЯ ====== */
  const LOG_URL = 'PASTE_YOUR_APPS_SCRIPT_WEBAPP_URL_HERE'; // <= замените здесь на URL логгера
  const ICON_BASE = 'https://groskaiser-design.github.io/icons/';

  const ICONS = {
    manual:       'question.svg',
    start:        'play.svg',
    products:     'cart.svg',
    kbju:         'clipboard.svg',
    measurements: 'scales.svg',
    menu:         'menu.svg',
    diary:        'diary.svg',
    ai:           'ai.svg',
    analytics:    'analytics.svg',
    profile:      'profile.svg',
    subscription: 'rub.svg'
  };

  /* Telegram env */
  var tg=(window.Telegram&&window.Telegram.WebApp)?window.Telegram.WebApp:{
    initData:'',initDataUnsafe:{},ready:function(){},expand:function(){},
    BackButton:{show:function(){},hide:function(){},onClick:function(){}},
    HapticFeedback:{impactOccurred:function(){}},showAlert:function(m){console.log(m)}
  };
  try{tg.ready();tg.expand();}catch(e){}

  /* ====== ЛОГГЕР ====== */
  const SESSION_ID = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now()+'-'+Math.random().toString(16).slice(2));
  const QUEUE = [];
  let SENDING = false;

  function enrich(payload){
    const u = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) || {};
    return Object.assign({
      action: 'log',
      timestamp: new Date().toISOString(),
      session_id: SESSION_ID,
      telegram_id: u.id || '',
      username: (u.first_name||'') + (u.last_name?(' '+u.last_name):'') || (u.username||''),
      path: location.pathname,
      referrer: document.referrer || '',
      ua: navigator.userAgent,
      screen: (window.screen ? (screen.width+'x'+screen.height) : ''),
      dpi: (window.devicePixelRatio||1),
      lang: navigator.language||''
    }, payload);
  }

  function sendNow(batch){
    if(!LOG_URL) return Promise.resolve();
    try{
      const blob = new Blob([JSON.stringify(batch)], {type:'application/json'});
      if (navigator.sendBeacon){
        navigator.sendBeacon(LOG_URL, blob);
        return Promise.resolve();
      }
      return fetch(LOG_URL, {method:'POST', body: JSON.stringify(batch), headers:{'Content-Type':'application/json'}, keepalive:true}).then(()=>{});
    }catch(e){
      return Promise.resolve(); // не ломаем UX
    }
  }

  function flush(){
    if (SENDING || QUEUE.length===0) return;
    SENDING = true;
    const batch = QUEUE.splice(0, Math.min(QUEUE.length, 50));
    sendNow(batch).finally(()=>{ SENDING=false; if(QUEUE.length) setTimeout(flush,100); });
  }

  function logEvent(event, meta){
    try{
      QUEUE.push(enrich({ event, meta: meta||{} }));
      if (QUEUE.length >= 5) flush();
    }catch(_){}
  }

  window.addEventListener('beforeunload', ()=>{ if(QUEUE.length){ try{ sendNow(QUEUE.splice(0, QUEUE.length)); }catch(_){}}});
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden' && QUEUE.length){ try{ sendNow(QUEUE.splice(0, QUEUE.length)); }catch(_){}}});

  // глобальный перехват ошибок
  window.addEventListener('error', function(e){
    logEvent('js_error', { message: e.message, file: e.filename, line: e.lineno, col: e.colno });
  });
  window.addEventListener('unhandledrejection', function(e){
    logEvent('promise_rejection', { reason: (e.reason && (e.reason.stack || e.reason.message)) || String(e.reason) });
  });

  /* ====== ИКОНКИ ====== */
  (function attachIcons(){
    const map = [
      ['ico-manual',       ICONS.manual],
      ['ico-start',        ICONS.start],
      ['ico-products',     ICONS.products],
      ['ico-kbju',         ICONS.kbju],
      ['ico-measurements', ICONS.measurements],
      ['ico-menu',         ICONS.menu],
      ['ico-diary',        ICONS.diary],
      ['ico-ai',           ICONS.ai],
      ['ico-analytics',    ICONS.analytics],
      ['ico-profile',      ICONS.profile],
      ['ico-subscription', ICONS.subscription],
    ];
    map.forEach(([id, file])=>{
      const el = document.getElementById(id);
      if(el){ el.src = ICON_BASE + file; el.decoding='async'; el.loading='eager'; }
    });
  })();

  /* ====== Профиль пользователя ====== */
  (function(){
    try{
      var u=(tg&&tg.initDataUnsafe&&tg.initDataUnsafe.user)?tg.initDataUnsafe.user:null;
      var nameEl=document.getElementById('userName');
      var idEl=document.getElementById('userId');
      var photoEl=document.getElementById('userPhoto');
      if(u){
        var full=((u.first_name||'')+' '+(u.last_name||'')).trim()||'Пользователь';
        nameEl.textContent=full; idEl.textContent='ID: '+(u.id||'---');
        if(u.photo_url){
          var img=new Image(); img.src=u.photo_url; img.alt=full; img.className='avatar-img';
          photoEl.textContent=''; photoEl.appendChild(img);
        } else {
          photoEl.textContent=(full.charAt(0)||'A').toUpperCase();
        }
        logEvent('profile_loaded', { has_photo: !!u.photo_url });
      } else {
        nameEl.textContent='Александр Петров'; idEl.textContent='ID: 123456789'; photoEl.textContent='А';
        logEvent('profile_loaded_demo', {});
      }
    }catch(e){}
  })();

  function toast(msg){var t=document.getElementById('toast');t.textContent=msg;t.style.opacity='1';setTimeout(function(){t.style.opacity='0';},1200);}

  /* ====== Ripple & Tap ====== */
  function rippleIn(target, e){
    try{
      var host = (target.closest && target.closest('.icon')) || (target.querySelector && target.querySelector('.icon')) || null;
      if(!host){ return; }
      var r=document.createElement('span'); r.className='r';
      var b=host.getBoundingClientRect();
      var pt = (e.touches && e.touches[0]) ? e.touches[0] : e;
      r.style.left=(pt.clientX-b.left)+'px'; r.style.top=(pt.clientY-b.top)+'px';
      host.appendChild(r);
      r.addEventListener('animationend',function(){ if(r&&r.parentNode){ r.parentNode.removeChild(r);} },false);
    }catch(_){}
  }

  function bindTap(el, handler){
    let lastTouch = 0;
    if (window.PointerEvent){
      el.addEventListener('pointerdown', function(e){
        if (e.pointerType === 'mouse' && e.button !== 0) return;
        handler(e);
      });
    } else {
      el.addEventListener('touchstart', function(e){ lastTouch = Date.now(); handler(e); }, {passive:true});
      el.addEventListener('click', function(e){ if (Date.now() - lastTouch < 500) return; handler(e); });
    }
  }

  /* ====== Логика меню/плиток ====== */
  (function(){
    var grid=document.getElementById('gridB');
    var start=document.getElementById('startB');
    var btnProducts=document.getElementById('btnProducts');
    var btnKbju=document.getElementById('btnKbju');
    var backdrop=document.getElementById('backdrop');
    var opened=false, backHandler=null;

    function openMenu(){ if(opened) return; opened=true;
      start.classList.add('open-b'); grid.classList.add('focus'); backdrop.classList.add('show');
      logEvent('menu_open', {});
      try{ tg.BackButton.show(); if(tg.BackButton.onClick){ backHandler=function(){ closeMenu(); }; tg.BackButton.onClick(backHandler);} }catch(_){}
    }
    function closeMenu(){ if(!opened) return; opened=false;
      start.classList.remove('open-b'); grid.classList.remove('focus'); backdrop.classList.remove('show');
      logEvent('menu_close', {});
      try{ tg.BackButton.hide(); if(backHandler){ tg.BackButton.onClick(function(){}); backHandler=null; } }catch(_){}
    }

    bindTap(start, function(e){
      rippleIn(e.target, e);
      logEvent('start_tap', { was_opened: opened });
      (opened ? closeMenu : openMenu)();
    });

    function goAfterRipple(url, name, e){
      rippleIn(e.target, e);
      logEvent('spawn_tap', { target: name, was_opened: opened });
      if (opened) closeMenu();
      setTimeout(function(){ logEvent('navigate', { to: url }); window.location.href=url; }, 90);
    }
    bindTap(btnProducts, function(e){ e.stopPropagation(); goAfterRipple('products.html', 'products', e); });
    bindTap(btnKbju,     function(e){ e.stopPropagation(); goAfterRipple('kbju.html',     'kbju',     e); });

    bindTap(backdrop, function(){ logEvent('backdrop_tap', {}); closeMenu(); });
    document.addEventListener('keydown',function(e){ if(e.key==='Escape'){ logEvent('press_escape', {}); closeMenu(); } });

    var tiles=document.querySelectorAll('.tile[data-module]');
    tiles.forEach(function(t){
      const mod = t.getAttribute('data-module');
      bindTap(t, function(ev){
        rippleIn(ev.target, ev);
        logEvent('tile_tap', { module: mod, was_opened: opened });
        if (opened){ closeMenu(); return; }
        toast('Раздел в разработке');
      });
    });

    // первое событие — открытие приложения
    logEvent('app_open', {});
  })();
</script>
</body>
</html>
