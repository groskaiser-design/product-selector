<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Ultima Dashboard</title>

<script>
  // üîî –ú–ï–ù–Ø–ô –≠–¢–£ –í–ï–†–°–ò–Æ –ü–†–ò –û–ë–ù–û–í–õ–ï–ù–ò–ò –ú–ï–ù–Æ –ò–õ–ò –ò–ö–û–ù–û–ö
  const APP_VERSION = 'v2025-00001'; 

  // –§–∏–∫—Å –≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç–∏ –≤ URL (—á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä –Ω–µ –±—Ä–∞–ª —Å—Ç–∞—Ä—ã–π HTML –∏–∑ –∫—ç—à–∞)
  (function smartVersionCheck(){
    try{
      const url = new URL(location.href);
      const v = url.searchParams.get('v');
      if (v !== APP_VERSION){ 
        url.searchParams.set('v', APP_VERSION); 
        // –ú—è–≥–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –±–µ–∑ –º–æ—Ä–≥–∞–Ω–∏—è, –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ
        if (window.history.replaceState) {
           window.history.replaceState(null, null, url.href);
        } else {
           location.replace(url.href); 
        }
      }
    }catch(_){}
  })();
</script>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root {
    /* --- PALETTE --- */
    --bg-core: #050505;
    --text-main: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.55);
    
    /* --- SURFACES --- */
    --surface-glass: rgba(255, 255, 255, 0.07);
    --surface-list: rgba(255, 255, 255, 0.04);
    --surface-border: rgba(255, 255, 255, 0.1);
    --surface-border-light: rgba(255, 255, 255, 0.2);
    
    /* --- METRICS --- */
    --radius-xl: 28px;
    --radius-l: 22px;
    --radius-m: 16px;
    --pad: 16px;
    --gap: 12px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body {
    background-color: var(--bg-core);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', Roboto, sans-serif;
    color: var(--text-main);
    min-height: 100vh;
    overflow-x: hidden;
    overscroll-behavior-y: none; /* –ë–ª–æ–∫ —Ä–µ–∑–∏–Ω–∫–∏ iOS */
    -webkit-font-smoothing: antialiased;
  }

  /* FX LAYER */
  .fx-layer { position: fixed; inset: 0; z-index: -1; pointer-events: none; transform: translate3d(0,0,0); }
  .orb { position: absolute; border-radius: 50%; will-change: transform; animation: float 30s infinite linear; }
  .orb-1 { width: 90vw; height: 90vw; opacity: 0.4; background: radial-gradient(circle, #6c5ce7 0%, transparent 70%); top: -20%; left: -20%; filter: blur(80px); }
  .orb-2 { width: 90vw; height: 90vw; opacity: 0.5; background: radial-gradient(circle, rgba(0, 206, 201, 0.5) 0%, transparent 70%); bottom: -10%; right: -20%; animation-direction: reverse; filter: blur(120px); }
  @keyframes float { 0% {transform:rotate(0deg)} 100% {transform:rotate(360deg)} }
  .noise { position: fixed; inset: 0; z-index: -1; opacity: 0.04; background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); pointer-events: none; }

  /* LAYOUT */
  .app-shell {
    max-width: 480px; margin: 0 auto;
    padding: var(--pad);
    padding-top: calc(12px + env(safe-area-inset-top));
    padding-bottom: calc(40px + env(safe-area-inset-bottom));
    display: flex; flex-direction: column; gap: 32px;
  }

  /* HEADER */
  .header { display: flex; justify-content: space-between; align-items: center; }
  .profile-lockup { display: flex; align-items: center; gap: 14px; }
  .avatar-box { width: 48px; height: 48px; border-radius: 50%; box-shadow: 0 0 0 2px rgba(255,255,255,0.08); background: #222; overflow: hidden; position: relative; }
  .avatar-img { width: 100%; height: 100%; object-fit: cover; }
  .user-text h1 { font-size: 22px; font-weight: 800; margin: 0; line-height: 1.1; }
  .user-text p { font-size: 13px; color: var(--text-muted); margin: 0; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
  .icon-btn { width: 44px; height: 44px; border-radius: 50%; background: var(--surface-glass); border: 1px solid var(--surface-border); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); transition: transform 0.1s; }
  .icon-btn:active { transform: scale(0.92); background: rgba(255,255,255,0.15); }

  /* WIDGETS */
  .widgets-wrapper { margin-top: -8px; }
  .widgets-container { margin: 0 calc(var(--pad) * -1); }
  .carousel { display: flex; gap: 14px; overflow-x: auto; scroll-snap-type: x mandatory; padding: 20px var(--pad) 30px var(--pad); scrollbar-width: none; -webkit-overflow-scrolling: touch; }
  .carousel::-webkit-scrollbar { display: none; }
  
  .widget {
    flex: 0 0 calc(100% - 30px); scroll-snap-align: center; height: 170px;
    border-radius: var(--radius-xl);
    background: linear-gradient(165deg, rgba(255,255,255,0.12) 0%, rgba(255,255,255,0.03) 100%);
    border: 1px solid var(--surface-border); border-top: 1px solid var(--surface-border-light);
    backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
    box-shadow: 0 12px 32px rgba(0,0,0,0.3);
    position: relative; overflow: hidden; display: flex; align-items: center; justify-content: space-between; padding: 24px;
    transition: transform 0.2s;
  }
  .widget:active { transform: scale(0.98); }

  .w-info { z-index: 2; display: flex; flex-direction: column; justify-content: center; gap: 6px; }
  .w-label { font-size: 12px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); letter-spacing: 1px; }
  .w-val { font-size: 36px; font-weight: 800; line-height: 1; letter-spacing: -1px; }
  .w-sub { font-size: 14px; color: var(--text-muted); font-weight: 500; }
  
  .ring-svg { width: 100px; height: 100px; transform: rotate(-90deg); }
  .ring-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 8; }
  .ring-val { fill: none; stroke: url(#g1); stroke-width: 8; stroke-linecap: round; stroke-dasharray: 251; stroke-dashoffset: 80; }

  .dots { display: flex; justify-content: center; gap: 6px; margin-top: -14px; margin-bottom: 8px; pointer-events: none; }
  .dot { width: 6px; height: 6px; border-radius: 10px; background: rgba(255,255,255,0.2); transition: 0.3s cubic-bezier(0.25, 0.1, 0.25, 1); }
  .dot.active { width: 24px; background: #fff; }

  /* SECTIONS */
  .section-wrapper { display: flex; flex-direction: column; gap: 16px; margin-bottom: 12px; }
  .section-title { font-size: 19px; font-weight: 800; margin-left: 4px; opacity: 0.9; display: flex; align-items: center; gap: 8px; }
  
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; grid-auto-flow: dense; }

  .tile {
    background: var(--surface-glass); border: 1px solid var(--surface-border); border-radius: var(--radius-l);
    padding: 18px; position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between;
    cursor: pointer; transition: transform 0.1s, background 0.2s; min-height: 110px;
  }
  .tile:active { transform: scale(0.96); background: rgba(255,255,255,0.12); }
  .tile.wide { grid-column: span 2; flex-direction: row; align-items: center; justify-content: flex-start; gap: 18px; height: 90px; }
  .tile.tall { grid-row: span 2; background: linear-gradient(145deg, #48bfe3 0%, #5e60ce 100%); border: none; }
  .tile.std  { aspect-ratio: 1; }

  .t-icon-box { width: 40px; height: 40px; border-radius: 12px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; margin-bottom: auto; }
  .wide .t-icon-box { margin-bottom: 0; } 
  .t-icon-img { width: 24px; height: 24px; object-fit: contain; }
  .t-content { margin-top: 4px; }
  .wide .t-content { margin-top: 0; }
  .t-title { font-size: 15px; font-weight: 700; line-height: 1.1; }
  .t-sub { font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 4px; font-weight: 500; }
  .tall .t-title, .tall .t-sub { color: #fff; opacity: 1; }

  .settings-list { background: var(--surface-list); border: 1px solid var(--surface-border); border-radius: var(--radius-l); overflow: hidden; }
  .list-item { display: flex; align-items: center; justify-content: space-between; padding: 18px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
  .list-item:last-child { border-bottom: none; }
  .list-item:active { background: rgba(255,255,255,0.05); }
  .li-left { display: flex; align-items: center; gap: 14px; font-weight: 600; font-size: 16px; }
  .li-icon { width: 22px; opacity: 0.8; }
  .li-arrow { opacity: 0.3; transform: rotate(-90deg); font-size: 14px; font-weight: 700;}

  /* LOADER */
  #loader { position: fixed; inset: 0; background: #050505; z-index: 2000; display: flex; align-items: center; justify-content: center; transition: opacity 0.4s; }
  .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.2); border-top-color: #00cec9; border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .hidden { opacity: 0; pointer-events: none; }

</style>
</head>
<body>

<div class="fx-layer">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="noise"></div>
</div>

<div id="loader"><div class="spinner"></div></div>

<div class="app-shell">
  
  <div class="header">
    <div class="profile-lockup">
      <div class="avatar-box"><img src="" id="ava" class="avatar-img" style="display:none"></div>
      <div class="user-text"><p>–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ,</p><h1 id="username">–ì–æ—Å—Ç—å</h1></div>
    </div>
    <div class="icon-btn" onclick="haptic('light')">
      <svg width="22" height="22" viewBox="0 0 24 24" stroke="white" stroke-width="2" fill="none"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
    </div>
  </div>

  <div class="widgets-wrapper">
    <div class="widgets-container">
      <div class="carousel" id="carouselTrack">
        <div class="widget" onclick="nav('kbju.html')">
          <div class="w-info">
            <div class="w-label">–ü–∏—Ç–∞–Ω–∏–µ</div>
            <div class="w-val">1,250</div>
            <div class="w-sub">–¶–µ–ª—å: 2,100 –∫–∫–∞–ª</div>
          </div>
          <div style="position:relative; width:100px; height:100px">
            <svg class="ring-svg" viewBox="0 0 100 100">
              <defs><linearGradient id="g1" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#48bfe3"/><stop offset="100%" stop-color="#5e60ce"/></linearGradient></defs>
              <circle class="ring-bg" cx="50" cy="50" r="40"/><circle class="ring-val" cx="50" cy="50" r="40"/>
            </svg>
            <div style="position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:28px">üî•</div>
          </div>
        </div>
        <div class="widget" style="border-top-color:#fdcb6e" onclick="haptic('medium')">
          <div class="w-info">
            <div class="w-label" style="color:#fdcb6e">–ò–Ω—Å–∞–π—Ç –¥–Ω—è</div>
            <div class="w-val" style="font-size:22px; line-height:1.3">–í–∑–≤–µ—à–∏–≤–∞–π—Ç–µ<br>—Å—É—Ö—É—é –∫—Ä—É–ø—É</div>
            <div class="w-sub">–ß–∏—Ç–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ ‚Üí</div>
          </div>
          <div style="font-size:48px">üí°</div>
        </div>
      </div>
    </div>
    <div class="dots" id="carouselDots"></div>
  </div>

  <div id="dynamicContent"></div>

</div>

<script>
  // --- 1. INIT TELEGRAM & SWIPE BLOCK ---
  const tg = window.Telegram?.WebApp;
  if(tg){ 
    tg.ready(); 
    tg.expand(); 
    tg.setHeaderColor('#050505'); 
    tg.setBackgroundColor('#050505'); 
    tg.BackButton?.hide();
    // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–≤–∞–π–ø –∑–∞–∫—Ä—ã—Ç–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏–π TG)
    if (tg.isVersionAtLeast && tg.isVersionAtLeast('6.1')) tg.disableVerticalSwipes(); 
  }

  // --- 2. DEFAULT CONFIG (Fallback) ---
  const CFG = { iconBase: 'https://groskaiser-design.github.io/icons/' };
  
  const DEFAULT_DATA = [
    {
      id: "diary", title: "–î–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è", type: "grid",
      items: [
        { title: "–°–∫–∞–Ω–µ—Ä",   sub: "–î–æ–±–∞–≤–∏—Ç—å",   icon: "diary.svg",      link: "scanner.html", layout: "tall" },
        { title: "–ö–ë–ñ–£",     sub: "–ù–æ—Ä–º–∞",      icon: "clipboard.svg",  link: "kbju.html",    layout: "std" },
        { title: "–í–æ–¥–∞",     sub: "–¢—Ä–µ–∫–µ—Ä",     icon: "water.svg",      link: "#",            layout: "std" },
        { title: "–†–∞—Ü–∏–æ–Ω",   sub: "–ú–µ–Ω—é",       icon: "menu.svg",       link: "#",            layout: "wide" },
        { title: "–ü—Ä–æ–¥—É–∫—Ç—ã", sub: "–ë–∞–∑–∞",       icon: "apple.svg",      link: "#",            layout: "std" },
        { title: "–†–µ—Ü–µ–ø—Ç—ã",  sub: "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ",  icon: "chef.svg",       link: "#",            layout: "std" }
      ]
    },
    {
      id: "body", title: "–¢–µ–ª–æ –∏ –ü—Ä–æ–≥—Ä–µ—Å—Å", type: "grid",
      items: [
        { title: "–ó–∞–º–µ—Ä—ã",    sub: "–û–±–Ω–æ–≤–∏—Ç—å –≤–µ—Å", icon: "scales.svg",    link: "measurements.html", layout: "wide" },
        { title: "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞", sub: "–ì—Ä–∞—Ñ–∏–∫–∏",      icon: "analytics.svg", link: "2.html",            layout: "std" },
        { title: "AI –ö–æ—É—á",   sub: "–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç",    icon: "ai.svg",        link: "ai.html",           layout: "std" }
      ]
    },
    {
      id: "settings", title: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏", type: "list",
      items: [
        { title: "–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", icon: "profile.svg", link: "#" },
        { title: "–ü–æ–¥–ø–∏—Å–∫–∞ PRO",         icon: "rub.svg",     link: "#" },
        { title: "–ü–æ–º–æ—â—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞",   icon: "question.svg",link: "#" }
      ]
    }
  ];

  // --- 3. VERSION CONTROL & CACHING ---
  function getCachedData() {
    try {
      const cachedVer = localStorage.getItem('router_ver');
      const cachedJson = localStorage.getItem('router_data');
      
      // –ï—Å–ª–∏ –≤–µ—Ä—Å–∏—è —Å–æ–≤–ø–∞–¥–∞–µ—Ç –∏ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Ö
      if (cachedVer === APP_VERSION && cachedJson) {
        return JSON.parse(cachedJson);
      }
    } catch(e) {}
    return null;
  }

  function saveCache(data) {
    try {
      localStorage.setItem('router_ver', APP_VERSION);
      localStorage.setItem('router_data', JSON.stringify(data));
    } catch(e) {}
  }

  // --- 4. RENDER LOGIC ---
  function renderApp(data) {
    const root = document.getElementById('dynamicContent');
    root.innerHTML = '';

    data.forEach(section => {
      const wrapper = document.createElement('div');
      wrapper.className = 'section-wrapper';

      if (section.title) {
        const t = document.createElement('div');
        t.className = 'section-title';
        t.textContent = section.title;
        wrapper.appendChild(t);
      }

      const container = document.createElement('div');
      
      if (section.type === 'list') {
        container.className = 'settings-list';
        section.items.forEach(item => {
          const row = document.createElement('div');
          row.className = 'list-item';
          row.onclick = () => nav(item.link);
          row.innerHTML = `
            <div class="li-left">
              <img src="${CFG.iconBase + (item.icon||'star.svg')}" class="li-icon">
              ${item.title}
            </div>
            <div class="li-arrow">‚åÑ</div>
          `;
          container.appendChild(row);
        });
      } else {
        container.className = 'grid';
        section.items.forEach(item => {
          const tile = document.createElement('div');
          const layout = item.layout || 'std';
          tile.className = `tile ${layout}`;
          tile.onclick = () => nav(item.link);
          tile.innerHTML = `
            <div class="t-icon-box"><img src="${CFG.iconBase + (item.icon||'star.svg')}" class="t-icon-img"></div>
            <div class="t-content">
              <div class="t-title">${item.title}</div>
              ${item.sub ? `<div class="t-sub">${item.sub}</div>` : ''}
            </div>
          `;
          container.appendChild(tile);
        });
      }

      wrapper.appendChild(container);
      root.appendChild(wrapper);
    });
  }

  // --- 5. CAROUSEL LOGIC ---
  function initCarousel() {
    const track = document.getElementById('carouselTrack');
    const dotsContainer = document.getElementById('carouselDots');
    const slides = track.querySelectorAll('.widget');
    
    if (slides.length < 2) { dotsContainer.style.display = 'none'; return; }

    dotsContainer.innerHTML = '';
    slides.forEach((_, i) => {
      const dot = document.createElement('div');
      dot.className = `dot ${i === 0 ? 'active' : ''}`;
      dotsContainer.appendChild(dot);
    });

    const dots = dotsContainer.querySelectorAll('.dot');
    const observer = new IntersectionObserver(entries => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const index = Array.from(slides).indexOf(entry.target);
          if (index !== -1) {
            dots.forEach(d => d.classList.remove('active'));
            if(dots[index]) dots[index].classList.add('active');
          }
        }
      });
    }, { root: track, threshold: 0.6 });

    slides.forEach(s => observer.observe(s));
  }

  // --- 6. BOOTSTRAP ---
  function nav(url) {
    if(tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    if(url && url !== '#') setTimeout(()=>window.location.href=url, 70);
    else tg?.showPopup({ title: '–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', message: '–†–∞–∑–¥–µ–ª —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è' });
  }

  function loadUser() {
    const u = tg?.initDataUnsafe?.user || { first_name: '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä' };
    document.getElementById('username').textContent = u.first_name;
    if(u.photo_url){ const img = document.getElementById('ava'); img.src=u.photo_url; img.style.display='block'; }
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadUser();
    
    // 1. –ü—ã—Ç–∞–µ–º—Å—è –¥–æ—Å—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞
    let activeData = getCachedData();
    
    // 2. –ï—Å–ª–∏ –∫—ç—à–∞ –Ω–µ—Ç –∏–ª–∏ –≤–µ—Ä—Å–∏—è —Å–º–µ–Ω–∏–ª–∞—Å—å - –±–µ—Ä–µ–º –¥–µ—Ñ–æ–ª—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
    if (!activeData) {
      console.log('Updating Config Cache...');
      activeData = DEFAULT_DATA;
      saveCache(activeData);
    }
    
    renderApp(activeData);
    initCarousel();
    
    setTimeout(() => document.getElementById('loader').classList.add('hidden'), 300);
  });

</script>
</body>
</html>
