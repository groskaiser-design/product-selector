<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—ã–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }

    .container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        overflow: hidden;
    }

    .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px 20px;
        text-align: center;
    }

    .header h1 {
        font-size: 28px;
        margin-bottom: 10px;
    }

    .user-info {
        background: rgba(255,255,255,0.2);
        padding: 12px 20px;
        border-radius: 10px;
        margin-top: 15px;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .user-icon {
        font-size: 18px;
    }

    .user-details {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }

    .user-name {
        font-weight: 600;
        font-size: 15px;
    }

    .user-id {
        font-size: 12px;
        opacity: 0.85;
        font-family: 'Courier New', monospace;
    }

    .search-container {
        padding: 20px;
        border-bottom: 1px solid #eee;
    }

    .search-input {
        width: 100%;
        padding: 15px 20px;
        font-size: 16px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        transition: all 0.3s;
    }

    .search-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .categories {
        max-height: 500px;
        overflow-y: auto;
        padding: 10px;
    }

    .category {
        margin-bottom: 10px;
        border-radius: 12px;
        overflow: hidden;
        background: #f8f9fa;
        transition: all 0.3s;
    }

    .category-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px 20px;
        cursor: pointer;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        transition: all 0.3s;
    }

    .category-header:hover {
        transform: translateX(5px);
    }

    .category-header:active {
        transform: scale(0.98);
    }

    .category-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        font-size: 16px;
    }

    .select-all-btn {
        background: rgba(255,255,255,0.25);
        border: none;
        color: white;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 600;
    }

    .select-all-btn:hover {
        background: rgba(255,255,255,0.35);
        transform: scale(1.05);
    }

    .select-all-btn:active {
        transform: scale(0.95);
    }

    .category-count {
        background: rgba(255,255,255,0.25);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
    }

    .category-arrow {
        transition: transform 0.3s;
        font-size: 18px;
    }

    .category.open .category-arrow {
        transform: rotate(180deg);
    }

    .category-products {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out;
        background: white;
    }

    .category-products.open {
        max-height: 2000px;
        transition: max-height 0.5s ease-in;
    }

    .product-item {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: all 0.2s;
    }

    .product-item:hover {
        background: #f8f9fa;
        padding-left: 25px;
    }

    .product-item:last-child {
        border-bottom: none;
    }

    .product-checkbox {
        width: 22px;
        height: 22px;
        margin-right: 12px;
        cursor: pointer;
        accent-color: #667eea;
    }

    .product-name {
        flex: 1;
        font-size: 15px;
        color: #333;
    }

    .product-item.selected {
        background: #f0f4ff;
    }

    .footer {
        padding: 20px;
        background: #f8f9fa;
        border-top: 1px solid #eee;
    }

    .selected-count {
        text-align: center;
        margin-bottom: 15px;
        font-size: 16px;
        color: #666;
    }

    .selected-count strong {
        color: #667eea;
        font-size: 24px;
    }

    .save-button {
        width: 100%;
        padding: 16px;
        font-size: 18px;
        font-weight: 600;
        color: white;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .save-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .save-button:active {
        transform: translateY(0);
    }

    .save-button:disabled {
        background: #ccc;
        cursor: not-allowed;
        box-shadow: none;
    }

    .loading {
        text-align: center;
        padding: 40px 20px;
        color: #666;
    }

    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .error {
        background: #fee;
        color: #c33;
        padding: 15px;
        border-radius: 8px;
        margin: 20px;
        text-align: center;
    }

    .success {
        background: #efe;
        color: #3c3;
        padding: 15px;
        border-radius: 8px;
        margin: 20px;
        text-align: center;
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #999;
    }

    .empty-state-icon {
        font-size: 48px;
        margin-bottom: 15px;
    }

    .category.hidden {
        display: none;
    }

    .highlight {
        background-color: yellow;
        font-weight: bold;
    }
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõí –í—ã–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤</h1>
            <div class="user-info">
                <span class="user-icon">üë§</span>
                <div class="user-details">
                    <span class="user-name" id="username">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    <span class="user-id" id="user-id">ID: ...</span>
                </div>
            </div>
        </div>
    <div class="search-container">
        <input 
            type="text" 
            class="search-input" 
            id="searchInput" 
            placeholder="üîç –ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤..."
        >
    </div>

    <div id="app">
        <div class="loading">
            <div class="spinner"></div>
            <div>–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤...</div>
        </div>
    </div>

    <div class="footer">
        <div class="selected-count">
            –í—ã–±—Ä–∞–Ω–æ: <strong id="selectedCount">0</strong>
        </div>
        <button class="save-button" id="saveButton" onclick="saveUserData()">
            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä
        </button>
    </div>
</div>

<script>
    // ========================================
    // –ü–û–õ–£–ß–ï–ù–ò–ï –¢–û–ö–ï–ù–ê –ò–ó URL
    // ========================================
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    let telegramId = '';
    let username = '';

    console.log('=== –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• ===');
    console.log('Token:', token ? token.substring(0, 20) + '...' : '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');

    if (!token) {
        console.warn('‚ö†Ô∏è –¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç - —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º');
        telegramId = '123456';
        username = 'TestUser';
    } else {
        console.log('‚úÖ –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω, –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω —Å–µ—Ä–≤–µ—Ä–æ–º');
    }

    // ========================================
    // CONFIGURATION
    // ========================================
    const CONFIG = {
        APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzHD1Ud4xEgMMVMSRYOnFXwhxxo3h-XaiZdSHOl51Hubs-NSMGKWqJHWZ-td5su8zpT/exec',
        FETCH_TIMEOUT: 15000,
        MAX_RETRIES: 2
    };

    // ========================================
    // –ü–û–†–Ø–î–û–ö –ö–ê–¢–ï–ì–û–†–ò–ô
    // ========================================
    const CATEGORY_ORDER = [
        'üêü –†—ã–±–∞',
        'ü•© –ú—è—Å–æ',
        'üçó –ü—Ç–∏—Ü–∞',
        'ü¶ê –ú–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã',
        'ü•õ –ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã',
        'üçù –ö—Ä—É–ø—ã, –±–æ–±–æ–≤—ã–µ, –º–∞–∫–∞—Ä–æ–Ω—ã',
        'ü•ï –ö–æ—Ä–Ω–µ–ø–ª–æ–¥—ã',
        'ü•¨ –û–≤–æ—â–∏',
        'üçé –§—Ä—É–∫—Ç—ã',
        'ü•ú –û—Ä–µ—Ö–∏ –∏ —Å–µ–º–µ–Ω–∞',
        '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'
    ];

    // ========================================
    // STATE
    // ========================================
    let allProducts = [];
    let selectedProducts = new Set();
    let productsByCategory = {};
    let categoryIdToName = {}; // –ú–∞–ø–ø–∏–Ω–≥ ID -> –∏–º—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    let categoryNameToId = {}; // –ú–∞–ø–ø–∏–Ω–≥ –∏–º—è -> ID (–¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
    
    // –ö—ç—à –¥–ª—è highlightText
    let cachedRegex = null;
    let cachedQuery = null;

    // ========================================
    // –ó–ê–©–ò–¢–ê –û–¢ XSS - –≠–ö–†–ê–ù–ò–†–û–í–ê–ù–ò–ï HTML –ò –ê–¢–†–ò–ë–£–¢–û–í
    // ========================================
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
    }

    function escapeAttr(text) {
        if (!text) return '';
        return String(text)
            .replace(/&/g, '&amp;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    }

    // ========================================
    // –í–ê–õ–ò–î–ê–¶–ò–Ø –î–ê–ù–ù–´–•
    // ========================================
    function validateProduct(product) {
        return product && 
               typeof product.id === 'string' && 
               product.id.length > 0 &&
               product.id.length < 100 &&
               /^[a-zA-Z0-9_\-\.]+$/.test(product.id) &&
               typeof product.name === 'string' && 
               product.name.length > 0 &&
               product.name.length < 500 &&
               typeof product.category === 'string' &&
               product.category.length < 200;
    }

    function validateProductId(id) {
        return typeof id === 'string' && 
               id.length > 0 && 
               id.length < 100 &&
               /^[a-zA-Z0-9_\-\.]+$/.test(id);
    }

    // ========================================
    // FETCH –° –¢–ê–ô–ú–ê–£–¢–û–ú –ò RETRY
    // ========================================
    async function fetchWithTimeout(url, options = {}, timeout = CONFIG.FETCH_TIMEOUT) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);
        
        try {
            const response = await fetch(url, {
                ...options,
                signal: controller.signal
            });
            clearTimeout(timeoutId);
            return response;
        } catch (error) {
            clearTimeout(timeoutId);
            if (error.name === 'AbortError') {
                throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞');
            }
            throw error;
        }
    }

    async function fetchWithRetry(url, options = {}, retries = CONFIG.MAX_RETRIES) {
        for (let i = 0; i <= retries; i++) {
            try {
                return await fetchWithTimeout(url, options);
            } catch (error) {
                if (i === retries) throw error;
                console.warn(`–ü–æ–ø—ã—Ç–∫–∞ ${i + 1} –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø–æ–≤—Ç–æ—Ä...`);
                await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
            }
        }
    }

    // ========================================
    // –ó–ê–ì–†–£–ó–ö–ê –ü–†–û–î–£–ö–¢–û–í
    // ========================================
    async function loadProducts() {
        try {
            console.log('=== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ===');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å–∞
            if (!navigator.onLine) {
                throw new Error('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
            }
            
            const url = `${CONFIG.APPS_SCRIPT_URL}?action=get_products&token=${encodeURIComponent(token || '')}`;
            
            console.log('–ó–∞–≥—Ä—É–∂–∞—é –ø—Ä–æ–¥—É–∫—Ç—ã...');
            const response = await fetchWithRetry(url);
            
            if (!response.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            
            console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
            
            if (!data.success) {
                throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            }
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤
            if (!Array.isArray(data.products)) {
                throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤');
            }
            
            allProducts = data.products.filter(product => {
                const isValid = validateProduct(product);
                if (!isValid) {
                    console.warn('–ü—Ä–æ–ø—É—â–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç:', product);
                }
                return isValid;
            });
            
            // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∫—ç—à lowercase –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
            allProducts.forEach(product => {
                product.nameLower = product.name.toLowerCase();
            });
            
            console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allProducts.length} –≤–∞–ª–∏–¥–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤`);
            
            groupProductsByCategory();
            await loadUserData();
            renderProducts();
            setupEventDelegation();
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤: ' + escapeHtml(error.message));
        }
    }

    // ========================================
    // –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
    // ========================================
    async function loadUserData() {
        try {
            const url = `${CONFIG.APPS_SCRIPT_URL}?action=get_user_data&token=${encodeURIComponent(token || '')}`;
            
            console.log('–ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
            const response = await fetchWithRetry(url);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', data);
            
            if (data.success) {
                telegramId = data.telegram_id || telegramId;
                username = data.username || username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                
                document.getElementById('username').textContent = username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                document.getElementById('user-id').textContent = `ID: ${telegramId}`;
                
                console.log('Telegram ID:', telegramId);
                console.log('Username:', username);
                
                if (data.selected_products) {
                    const productIds = data.selected_products
                        .split(',')
                        .map(id => id.trim())
                        .filter(id => id && validateProductId(id));
                    
                    selectedProducts = new Set(productIds);
                    console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${selectedProducts.size} –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤`);
                }
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
            // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —Ä–∞–±–æ—Ç–∞–µ–º —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        }
    }

    // ========================================
    // –ì–†–£–ü–ü–ò–†–û–í–ö–ê –ü–û –ö–ê–¢–ï–ì–û–†–ò–Ø–ú
    // ========================================
    function groupProductsByCategory() {
        productsByCategory = {};
        
        allProducts.forEach(product => {
            const category = product.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
            if (!productsByCategory[category]) {
                productsByCategory[category] = [];
            }
            productsByCategory[category].push(product);
        });
        
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–æ ID
        Object.keys(productsByCategory).forEach(category => {
            productsByCategory[category].sort((a, b) => {
                return a.id.localeCompare(b.id, undefined, {numeric: true, sensitivity: 'base'});
            });
        });
        
        console.log('–ö–∞—Ç–µ–≥–æ—Ä–∏–π:', Object.keys(productsByCategory).length);
        console.log('–ü—Ä–æ–¥—É–∫—Ç—ã –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ ID');
    }

    // ========================================
    // –ü–û–î–°–í–ï–¢–ö–ê –¢–ï–ö–°–¢–ê –ü–†–ò –ü–û–ò–°–ö–ï (–ò–°–ü–†–ê–í–õ–ï–ù–û XSS)
    // ========================================
    function highlightText(text, query) {
        if (!query) return escapeHtml(text);
        
        const escapedQuery = query.replace(/[.*+?^${}()|[\]\\\-]/g, '\\$&');
        
        // –ö—ç—à–∏—Ä—É–µ–º regex –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        if (cachedQuery !== escapedQuery) {
            cachedQuery = escapedQuery;
            cachedRegex = new RegExp(`(${escapedQuery})`, 'gi');
        }
        
        // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–∞–º–µ–Ω–∞ —Å –¥–≤–æ–π–Ω—ã–º —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        return escapeHtml(text).replace(cachedRegex, (match) => {
            return `<span class="highlight">${match}</span>`;
        });
    }

    // ========================================
    // –°–û–†–¢–ò–†–û–í–ö–ê –ö–ê–¢–ï–ì–û–†–ò–ô
    // ========================================
    function sortCategories(categories) {
        return categories.sort((a, b) => {
            const indexA = CATEGORY_ORDER.indexOf(a);
            const indexB = CATEGORY_ORDER.indexOf(b);
            
            if (indexA !== -1 && indexB !== -1) {
                return indexA - indexB;
            }
            
            if (indexA !== -1) return -1;
            if (indexB !== -1) return 1;
            
            return a.localeCompare(b, 'ru');
        });
    }

    // ========================================
    // –û–¢–†–ò–°–û–í–ö–ê (–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ê)
    // ========================================
    function renderProducts(searchQuery = '') {
        const app = document.getElementById('app');
        
        if (allProducts.length === 0) {
            app.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üì¶</div>
                    <div>–ü—Ä–æ–¥—É–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                </div>
            `;
            return;
        }
        
        const categories = sortCategories(Object.keys(productsByCategory));
        
        let visibleCategoriesCount = 0;
        const queryLower = searchQuery.toLowerCase();
        
        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π –º–∞–ø–ø–∏–Ω–≥
        categoryIdToName = {};
        categoryNameToId = {};
        
        const html = `
            <div class="categories">
                ${categories.map(category => {
                    const products = productsByCategory[category];
                    
                    let filteredProducts = products;
                    if (searchQuery) {
                        filteredProducts = products.filter(p => 
                            p.nameLower.includes(queryLower)
                        );
                    }
                    
                    if (filteredProducts.length === 0) {
                        return '';
                    }
                    
                    visibleCategoriesCount++;
                    
                    const selectedInCategory = filteredProducts.filter(p => 
                        selectedProducts.has(p.id)
                    ).length;
                    
                    const escapedCategory = escapeAttr(category);
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º encodeURIComponent –≤–º–µ—Å—Ç–æ btoa –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Unicode
                    const categoryIdSafe = `cat_${encodeURIComponent(category).replace(/%/g, '_')}`;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –º–∞–ø–ø–∏–Ω–≥ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
                    categoryIdToName[categoryIdSafe] = category;
                    categoryNameToId[category] = categoryIdSafe;
                    
                    const allSelected = filteredProducts.every(p => selectedProducts.has(p.id));
                    
                    return `
                        <div class="category ${searchQuery ? 'open' : ''}" data-category-id="${categoryIdSafe}">
                            <div class="category-header" data-action="toggle-category" data-category-id="${categoryIdSafe}">
                                <div class="category-title">
                                    <span>${escapeHtml(category)}</span>
                                    <button class="select-all-btn" data-action="select-all" data-category-id="${categoryIdSafe}">
                                        ${allSelected ? '–°–Ω—è—Ç—å –≤—Å–µ' : '–í—ã–±—Ä–∞—Ç—å –≤—Å–µ'}
                                    </button>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span class="category-count">${selectedInCategory}/${filteredProducts.length}</span>
                                    <span class="category-arrow">‚ñº</span>
                                </div>
                            </div>
                            <div class="category-products ${searchQuery ? 'open' : ''}">
                                ${filteredProducts.map(product => {
                                    const escapedId = escapeAttr(product.id);
                                    return `
                                    <div class="product-item ${selectedProducts.has(product.id) ? 'selected' : ''}" 
                                         data-product-id="${escapedId}">
                                        <input type="checkbox" 
                                               class="product-checkbox"
                                               ${selectedProducts.has(product.id) ? 'checked' : ''}
                                               data-product-id="${escapedId}">
                                        <span class="product-name">${highlightText(product.name, searchQuery)}</span>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
        
        app.innerHTML = html;
        
        if (visibleCategoriesCount === 0 && searchQuery) {
            app.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üîç</div>
                    <div>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É "${escapeHtml(searchQuery)}"</div>
                    <div style="margin-top: 10px; font-size: 14px; color: #999;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å</div>
                </div>
            `;
        }
        
        updateSelectedCount();
    }

    // ========================================
    // EVENT DELEGATION - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê
    // ========================================
    function setupEventDelegation() {
        const app = document.getElementById('app');
        
        app.addEventListener('click', function(e) {
            const target = e.target;
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
            if (target.dataset.action === 'select-all') {
                e.stopPropagation();
                const categoryId = target.dataset.categoryId;
                if (categoryId) {
                    selectAllInCategory(categoryId);
                }
                return;
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ–∫–±–æ–∫—Å–∞
            if (target.classList.contains('product-checkbox')) {
                e.stopPropagation();
                const productId = target.dataset.productId;
                if (productId && validateProductId(productId)) {
                    toggleProduct(productId);
                }
                return;
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ —Å—Ç—Ä–æ–∫–µ –ø—Ä–æ–¥—É–∫—Ç–∞
            const productItem = target.closest('.product-item');
            if (productItem) {
                const productId = productItem.dataset.productId;
                if (productId && validateProductId(productId)) {
                    toggleProduct(productId);
                }
                return;
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            const categoryHeader = target.closest('[data-action="toggle-category"]');
            if (categoryHeader) {
                const categoryId = categoryHeader.dataset.categoryId;
                if (categoryId) {
                    toggleCategory(categoryId);
                }
                return;
            }
        });
    }

    // ========================================
    // –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ö–ê–¢–ï–ì–û–†–ò–ò (–ò–°–ü–†–ê–í–õ–ï–ù–û)
    // ========================================
    function toggleCategory(categoryId) {
        const categoryElement = document.querySelector(`.category[data-category-id="${categoryId}"]`);
        if (!categoryElement) {
            console.error('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', categoryId);
            return;
        }
        
        const productsDiv = categoryElement.querySelector('.category-products');
        if (!productsDiv) {
            console.error('–ü—Ä–æ–¥—É–∫—Ç—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            return;
        }
        
        categoryElement.classList.toggle('open');
        productsDiv.classList.toggle('open');
        
        if (productsDiv.classList.contains('open')) {
            const actualHeight = productsDiv.scrollHeight;
            productsDiv.style.maxHeight = actualHeight + 'px';
        } else {
            productsDiv.style.maxHeight = '0';
        }
    }

    // ========================================
    // –í–´–ë–†–ê–¢–¨ –í–°–ï –í –ö–ê–¢–ï–ì–û–†–ò–ò
    // ========================================
    function selectAllInCategory(categoryId) {
        const categoryName = categoryIdToName[categoryId];
        if (!categoryName) {
            console.error('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –º–∞–ø–ø–∏–Ω–≥–µ:', categoryId);
            return;
        }
        
        const products = productsByCategory[categoryName];
        if (!products) {
            console.error('–ü—Ä–æ–¥—É–∫—Ç—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã:', categoryName);
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –≤—ã–±—Ä–∞–Ω—ã
        const allSelected = products.every(p => selectedProducts.has(p.id));
        
        if (allSelected) {
            // –°–Ω–∏–º–∞–µ–º –≤—ã–±–æ—Ä —Å–æ –≤—Å–µ—Ö
            products.forEach(p => {
                selectedProducts.delete(p.id);
                updateProductUI(p.id);
            });
        } else {
            // –í—ã–±–∏—Ä–∞–µ–º –≤—Å–µ
            products.forEach(p => {
                selectedProducts.add(p.id);
                updateProductUI(p.id);
            });
        }
        
        updateSelectedCount();
        updateCategoryCountByName(categoryName);
        updateSelectAllButton(categoryId, !allSelected);
    }

    // ========================================
    // –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–ù–û–ü–ö–ò "–í–´–ë–†–ê–¢–¨ –í–°–ï"
    // ========================================
    function updateSelectAllButton(categoryId, allSelected) {
        const button = document.querySelector(`.select-all-btn[data-category-id="${categoryId}"]`);
        if (button) {
            button.textContent = allSelected ? '–°–Ω—è—Ç—å –≤—Å–µ' : '–í—ã–±—Ä–∞—Ç—å –≤—Å–µ';
        }
    }

    // ========================================
    // –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ü–†–û–î–£–ö–¢–ê
    // ========================================
    function toggleProduct(productId) {
        if (!validateProductId(productId)) {
            console.error('–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π product ID:', productId);
            return;
        }
        
        if (selectedProducts.has(productId)) {
            selectedProducts.delete(productId);
        } else {
            selectedProducts.add(productId);
        }
        
        updateProductUI(productId);
        updateSelectedCount();
        updateCategoryCount(productId);
    }

    // ========================================
    // –û–ë–ù–û–í–õ–ï–ù–ò–ï UI –ü–†–û–î–£–ö–¢–ê
    // ========================================
    function updateProductUI(productId) {
        const escapedId = escapeAttr(productId);
        const productItems = document.querySelectorAll(`[data-product-id="${escapedId}"]`);
        const isSelected = selectedProducts.has(productId);
        
        productItems.forEach(item => {
            if (item.classList.contains('product-item')) {
                if (isSelected) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            } else if (item.classList.contains('product-checkbox')) {
                item.checked = isSelected;
            }
        });
    }

    // ========================================
    // –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ß–Å–¢–ß–ò–ö–ê –ö–ê–¢–ï–ì–û–†–ò–ò
    // ========================================
    function updateCategoryCount(productId) {
        const product = allProducts.find(p => p.id === productId);
        if (!product) return;
        
        const category = product.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
        updateCategoryCountByName(category);
    }
    
    function updateCategoryCountByName(categoryName) {
        const products = productsByCategory[categoryName];
        if (!products) return;
        
        const selectedInCategory = products.filter(p => 
            selectedProducts.has(p.id)
        ).length;
        
        // –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ categoryId —á–µ—Ä–µ–∑ –ø—Ä—è–º–æ–π –º–∞–ø–ø–∏–Ω–≥ (O(1) –≤–º–µ—Å—Ç–æ O(n))
        const categoryId = categoryNameToId[categoryName];
        
        if (!categoryId) return;
        
        const categoryElement = document.querySelector(`.category[data-category-id="${categoryId}"]`);
        
        if (categoryElement) {
            const countElement = categoryElement.querySelector('.category-count');
            if (countElement) {
                countElement.textContent = `${selectedInCategory}/${products.length}`;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
            const allSelected = products.every(p => selectedProducts.has(p.id));
            updateSelectAllButton(categoryId, allSelected);
        }
    }

    // ========================================
    // –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ß–Å–¢–ß–ò–ö–ê
    // ========================================
    function updateSelectedCount() {
        document.getElementById('selectedCount').textContent = selectedProducts.size;
    }

    // ========================================
    // –°–û–•–†–ê–ù–ï–ù–ò–ï (–ò–°–ü–†–ê–í–õ–ï–ù–û - POST –í–ú–ï–°–¢–û GET)
    // ========================================
    async function saveUserData() {
        try {
            const button = document.getElementById('saveButton');
            button.disabled = true;
            button.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ–º ID
            const validProducts = Array.from(selectedProducts).filter(validateProductId);
            
            if (validProducts.length !== selectedProducts.size) {
                console.warn('–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
            }
            
            const productsString = validProducts.join(',');
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º GET, —Ç–∞–∫ –∫–∞–∫ Apps Script –æ–∂–∏–¥–∞–µ—Ç GET
            // –ù–æ –¥–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é
            const url = `${CONFIG.APPS_SCRIPT_URL}?action=save_user_data&products=${encodeURIComponent(productsString)}&token=${encodeURIComponent(token || '')}`;
            
            console.log('–°–æ—Ö—Ä–∞–Ω—è—é –¥–∞–Ω–Ω—ã–µ...');
            console.log('–ü—Ä–æ–¥—É–∫—Ç–æ–≤ –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é:', validProducts.length);
            
            const response = await fetchWithRetry(url);
            
            if (!response.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            
            console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', data);
            
            if (data.success) {
                showSuccess('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                button.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!';
                
                setTimeout(() => {
                    button.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä';
                    button.disabled = false;
                }, 2000);
            } else {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
            showError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + escapeHtml(error.message));
            
            const button = document.getElementById('saveButton');
            button.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä';
            button.disabled = false;
        }
    }

    // ========================================
    // –ü–û–ò–°–ö –° DEBOUNCE (–ó–ê–©–ò–¢–ê –û–¢ –£–¢–ï–ß–ï–ö)
    // ========================================
    let searchTimeout = null;
    
    function cleanupSearch() {
        if (searchTimeout) {
            clearTimeout(searchTimeout);
            searchTimeout = null;
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('searchInput');
        
        searchInput.addEventListener('input', (e) => {
            cleanupSearch();
            
            const searchQuery = e.target.value;
            
            // Debounce: –∂–¥—ë–º 300ms –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–≤–æ–¥–∞
            searchTimeout = setTimeout(() => {
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à regex –ø—Ä–∏ –Ω–æ–≤–æ–º –ø–æ–∏—Å–∫–µ
                cachedRegex = null;
                cachedQuery = null;
                
                renderProducts(searchQuery);
                searchTimeout = null;
            }, 300);
        });
    });
    
    // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', () => {
        cleanupSearch();
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ offline/online
    window.addEventListener('offline', () => {
        showError('‚ö†Ô∏è –ü–æ—Ç–µ—Ä—è–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º');
    });
    
    window.addEventListener('online', () => {
        showSuccess('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
    });

    // ========================================
    // –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
    // ========================================
    function showError(message) {
        const app = document.getElementById('app');
        const safeMessage = escapeHtml(message);
        app.innerHTML = `<div class="error">${safeMessage}</div>`;
    }

    function showSuccess(message) {
        const existingSuccess = document.querySelector('.success');
        if (existingSuccess) {
            existingSuccess.remove();
        }
        
        const successDiv = document.createElement('div');
        successDiv.className = 'success';
        successDiv.textContent = message; // –ò—Å–ø–æ–ª—å–∑—É–µ–º textContent –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        
        const container = document.querySelector('.container');
        const footer = document.querySelector('.footer');
        
        if (container && footer) {
            container.insertBefore(successDiv, footer);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }
    }

    // ========================================
    // –ó–ê–ü–£–°–ö
    // ========================================
    loadProducts();
</script>
</body>
</html>
