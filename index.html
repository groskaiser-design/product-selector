<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—ã–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .user-info {
            background: rgba(255,255,255,0.2);
            padding: 12px 20px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 14px;
        }
        .search-container { padding: 20px; border-bottom: 1px solid #eee; }
        .search-input {
            width: 100%;
            padding: 15px 20px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            transition: all 0.3s;
        }
        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .categories { max-height: 500px; overflow-y: auto; padding: 10px; }
        .category {
            margin-bottom: 10px;
            border-radius: 12px;
            overflow: hidden;
            background: #f8f9fa;
        }
        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transition: all 0.3s;
        }
        .category-header:hover { transform: translateX(5px); }
        .category-title { font-weight: 600; font-size: 16px; }
        .select-all-container {
            padding: 12px 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: center;
        }
        .select-all-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 10px 24px;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            max-width: 200px;
        }
        .category-count {
            background: rgba(255,255,255,0.25);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        .category-arrow { transition: transform 0.3s; font-size: 18px; }
        .category.open .category-arrow { transform: rotate(180deg); }
        .category-products {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            background: white;
        }
        .category-products.open { max-height: 2000px; }
        .product-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s;
        }
        .product-item:hover { background: #f8f9fa; padding-left: 25px; }
        .product-checkbox {
            width: 22px;
            height: 22px;
            margin-right: 12px;
            cursor: pointer;
            accent-color: #667eea;
        }
        .product-name { flex: 1; font-size: 15px; color: #333; }
        .product-item.selected { background: #f0f4ff; }
        .footer { padding: 20px; background: #f8f9fa; border-top: 1px solid #eee; }
        .selected-count {
            text-align: center;
            margin-bottom: 15px;
            font-size: 16px;
            color: #666;
        }
        .selected-count strong { color: #667eea; font-size: 24px; }
        .save-button {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .loading { text-align: center; padding: 40px 20px; color: #666; }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
            text-align: center;
        }
        .success {
            background: #efe;
            color: #3c3;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõí –í—ã–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤</h1>
            <div class="user-info" id="userInfo">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        <div class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤...">
        </div>
        <div id="app">
            <div class="loading">
                <div class="spinner"></div>
                <div>–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤...</div>
            </div>
        </div>
        <div class="footer">
            <div class="selected-count">–í—ã–±—Ä–∞–Ω–æ: <strong id="selectedCount">0</strong></div>
            <button class="save-button" id="saveButton" onclick="saveUserData()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const CONFIG = {
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwJthB-APM4wacIQwWtohaz-6y_raHhTTSvUT-X2utL72csxqH_U8GWIw8CnJCG4QZH/exec'
        };

        const CATEGORY_ORDER = [
            'üêü –†—ã–±–∞', 'ü•© –ú—è—Å–æ', 'üçó –ü—Ç–∏—Ü–∞', 'ü¶ê –ú–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã',
            'ü•õ –ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã', 'üçù –ö—Ä—É–ø—ã, –±–æ–±–æ–≤—ã–µ, –º–∞–∫–∞—Ä–æ–Ω—ã',
            'ü•ï –ö–æ—Ä–Ω–µ–ø–ª–æ–¥—ã', 'ü•¨ –û–≤–æ—â–∏', 'üçé –§—Ä—É–∫—Ç—ã', 'ü•ú –û—Ä–µ—Ö–∏ –∏ —Å–µ–º–µ–Ω–∞',
            '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'
        ];

        let allProducts = [];
        let selectedProducts = new Set();
        let productsByCategory = {};
        let categoryIdToName = {};
        let categoryNameToId = {};

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        function escapeAttr(text) {
            if (!text) return '';
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        async function initApp() {
            try {
                console.log('Init app...');
                
                const url = CONFIG.APPS_SCRIPT_URL + 
                    '?action=init' +
                    '&initData=' + encodeURIComponent(tg.initData);

                console.log('Fetching:', url.substring(0, 100) + '...');

                const response = await fetch(url, {
                    method: 'GET',
                    cache: 'no-cache'
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }

                const data = await response.json();
                console.log('Data received:', data);

                if (!data.success && data.error) {
                    throw new Error(data.error);
                }

                document.getElementById('userInfo').textContent = 
                    `üë§ ${data.user.username} (ID: ${data.user.telegram_id})`;

                allProducts = data.products || [];
                allProducts.forEach(p => p.nameLower = p.name.toLowerCase());

                if (data.user_data && data.user_data.selected_products) {
                    selectedProducts = new Set(
                        data.user_data.selected_products.split(',')
                            .map(id => id.trim())
                            .filter(id => id)
                    );
                }

                groupProductsByCategory();
                renderProducts();
                setupEventDelegation();

                console.log('Init complete');

            } catch (error) {
                console.error('Init error:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
            }
        }

        function groupProductsByCategory() {
            productsByCategory = {};
            allProducts.forEach(product => {
                const category = product.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
                if (!productsByCategory[category]) {
                    productsByCategory[category] = [];
                }
                productsByCategory[category].push(product);
            });

            Object.keys(productsByCategory).forEach(category => {
                productsByCategory[category].sort((a, b) => 
                    a.id.localeCompare(b.id, undefined, {numeric: true, sensitivity: 'base'})
                );
            });
        }

        function sortCategories(categories) {
            return categories.sort((a, b) => {
                const indexA = CATEGORY_ORDER.indexOf(a);
                const indexB = CATEGORY_ORDER.indexOf(b);
                if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                if (indexA !== -1) return -1;
                if (indexB !== -1) return 1;
                return a.localeCompare(b, 'ru');
            });
        }

        function renderProducts(searchQuery = '') {
            const app = document.getElementById('app');
            const categories = sortCategories(Object.keys(productsByCategory));
            const queryLower = searchQuery.toLowerCase();

            categoryIdToName = {};
            categoryNameToId = {};

            const html = `
                <div class="categories">
                    ${categories.map(category => {
                        const products = productsByCategory[category];
                        let filteredProducts = searchQuery 
                            ? products.filter(p => p.nameLower.includes(queryLower))
                            : products;

                        if (filteredProducts.length === 0) return '';

                        const selectedInCategory = filteredProducts.filter(p => 
                            selectedProducts.has(p.id)
                        ).length;

                        const categoryId = `cat_${encodeURIComponent(category).replace(/%/g, '_')}`;
                        categoryIdToName[categoryId] = category;
                        categoryNameToId[category] = categoryId;

                        const allSelected = filteredProducts.every(p => selectedProducts.has(p.id));

                        return `
                            <div class="category ${searchQuery ? 'open' : ''}" data-category-id="${categoryId}">
                                <div class="category-header" data-action="toggle-category" data-category-id="${categoryId}">
                                    <div class="category-title">${escapeHtml(category)}</div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span class="category-count">${selectedInCategory}/${filteredProducts.length}</span>
                                        <span class="category-arrow">‚ñº</span>
                                    </div>
                                </div>
                                <div class="category-products ${searchQuery ? 'open' : ''}">
                                    <div class="select-all-container">
                                        <button class="select-all-btn" data-action="select-all" data-category-id="${categoryId}">
                                            ${allSelected ? '‚úì –°–Ω—è—Ç—å –≤—Å–µ' : '+ –í—ã–±—Ä–∞—Ç—å –≤—Å–µ'}
                                        </button>
                                    </div>
                                    ${filteredProducts.map(product => {
                                        const escapedId = escapeAttr(product.id);
                                        return `
                                        <div class="product-item ${selectedProducts.has(product.id) ? 'selected' : ''}" 
                                             data-product-id="${escapedId}">
                                            <input type="checkbox" 
                                                   class="product-checkbox"
                                                   ${selectedProducts.has(product.id) ? 'checked' : ''}
                                                   data-product-id="${escapedId}">
                                            <span class="product-name">${escapeHtml(product.name)}</span>
                                        </div>
                                    `}).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            app.innerHTML = html;
            updateSelectedCount();
        }

        function setupEventDelegation() {
            const app = document.getElementById('app');

            app.addEventListener('click', function(e) {
                const target = e.target;

                if (target.dataset.action === 'select-all') {
                    e.stopPropagation();
                    const categoryId = target.dataset.categoryId;
                    if (categoryId) selectAllInCategory(categoryId);
                    return;
                }

                if (target.classList.contains('product-checkbox')) {
                    e.stopPropagation();
                    const productId = target.dataset.productId;
                    if (productId) toggleProduct(productId);
                    return;
                }

                const productItem = target.closest('.product-item');
                if (productItem) {
                    const productId = productItem.dataset.productId;
                    if (productId) toggleProduct(productId);
                    return;
                }

                const categoryHeader = target.closest('[data-action="toggle-category"]');
                if (categoryHeader) {
                    const categoryId = categoryHeader.dataset.categoryId;
                    if (categoryId) toggleCategory(categoryId);
                }
            });

            document.getElementById('searchInput').addEventListener('input', (e) => {
                renderProducts(e.target.value);
            });
        }

        function toggleCategory(categoryId) {
            const categoryElement = document.querySelector(`.category[data-category-id="${categoryId}"]`);
            if (!categoryElement) return;

            const productsDiv = categoryElement.querySelector('.category-products');
            if (!productsDiv) return;

            categoryElement.classList.toggle('open');
            productsDiv.classList.toggle('open');
        }

        function selectAllInCategory(categoryId) {
            const categoryName = categoryIdToName[categoryId];
            if (!categoryName) return;

            const products = productsByCategory[categoryName];
            if (!products) return;

            const allSelected = products.every(p => selectedProducts.has(p.id));

            if (allSelected) {
                products.forEach(p => selectedProducts.delete(p.id));
            } else {
                products.forEach(p => selectedProducts.add(p.id));
            }

            products.forEach(p => updateProductUI(p.id));
            updateSelectedCount();
            updateCategoryCountByName(categoryName);
            updateSelectAllButton(categoryId, !allSelected);
        }

        function toggleProduct(productId) {
            if (selectedProducts.has(productId)) {
                selectedProducts.delete(productId);
            } else {
                selectedProducts.add(productId);
            }

            updateProductUI(productId);
            updateSelectedCount();
            updateCategoryCount(productId);
        }

        function updateProductUI(productId) {
            const escapedId = escapeAttr(productId);
            const productItems = document.querySelectorAll(`[data-product-id="${escapedId}"]`);
            const isSelected = selectedProducts.has(productId);

            productItems.forEach(item => {
                if (item.classList.contains('product-item')) {
                    if (isSelected) {
                        item.classList.add('selected');
                    } else {
                        item.classList.remove('selected');
                    }
                } else if (item.classList.contains('product-checkbox')) {
                    item.checked = isSelected;
                }
            });
        }

        function updateCategoryCount(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            updateCategoryCountByName(product.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
        }

        function updateCategoryCountByName(categoryName) {
            const products = productsByCategory[categoryName];
            if (!products) return;

            const selectedInCategory = products.filter(p => 
                selectedProducts.has(p.id)
            ).length;

            const categoryId = categoryNameToId[categoryName];
            if (!categoryId) return;

            const categoryElement = document.querySelector(`.category[data-category-id="${categoryId}"]`);
            if (categoryElement) {
                const countElement = categoryElement.querySelector('.category-count');
                if (countElement) {
                    countElement.textContent = `${selectedInCategory}/${products.length}`;
                }

                const allSelected = products.every(p => selectedProducts.has(p.id));
                updateSelectAllButton(categoryId, allSelected);
            }
        }

        function updateSelectAllButton(categoryId, allSelected) {
            const button = document.querySelector(`.select-all-btn[data-category-id="${categoryId}"]`);
            if (button) {
                button.textContent = allSelected ? '‚úì –°–Ω—è—Ç—å –≤—Å–µ' : '+ –í—ã–±—Ä–∞—Ç—å –≤—Å–µ';
            }
        }

        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedProducts.size;
        }

        async function saveUserData() {
            try {
                console.log('Saving...');
                
                const button = document.getElementById('saveButton');
                button.disabled = true;
                button.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

                const productsString = Array.from(selectedProducts).join(',');

                const url = CONFIG.APPS_SCRIPT_URL + 
                    '?action=save_user_data' +
                    '&initData=' + encodeURIComponent(tg.initData) +
                    '&products=' + encodeURIComponent(productsString);

                console.log('Saving to:', url.substring(0, 100) + '...');

                const response = await fetch(url, {
                    method: 'GET',
                    cache: 'no-cache'
                });

                console.log('Save response:', response.status);

                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }

                const data = await response.json();
                console.log('Save result:', data);

                if (data.success) {
                    showSuccess('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                    button.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!';

                    setTimeout(() => {
                        button.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä';
                        button.disabled = false;
                    }, 2000);
                } else {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }

            } catch (error) {
                console.error('Save error:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);

                const button = document.getElementById('saveButton');
                button.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä';
                button.disabled = false;
            }
        }

        function showError(message) {
            const app = document.getElementById('app');
            app.innerHTML = `<div class="error">${escapeHtml(message)}</div>`;
        }

        function showSuccess(message) {
            const existingSuccess = document.querySelector('.success');
            if (existingSuccess) {
                existingSuccess.remove();
            }

            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;

            const container = document.querySelector('.container');
            const footer = document.querySelector('.footer');

            if (container && footer) {
                container.insertBefore(successDiv, footer);

                setTimeout(() => {
                    successDiv.remove();
                }, 3000);
            }
        }

        initApp();
    </script>
</body>
</html>
