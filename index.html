<artifact identifier="product-selector-with-id-fixed" type="text/html" title="–í—ã–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)">
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—ã–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }

    .container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        overflow: hidden;
    }

    .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px 20px;
        text-align: center;
    }

    .header h1 {
        font-size: 28px;
        margin-bottom: 10px;
    }

    .user-info {
        background: rgba(255,255,255,0.2);
        padding: 12px 20px;
        border-radius: 10px;
        margin-top: 15px;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .user-icon {
        font-size: 18px;
    }

    .user-details {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }

    .user-name {
        font-weight: 600;
        font-size: 15px;
    }

    .user-id {
        font-size: 12px;
        opacity: 0.85;
        font-family: 'Courier New', monospace;
    }

    .search-container {
        padding: 20px;
        border-bottom: 1px solid #eee;
    }

    .search-input {
        width: 100%;
        padding: 15px 20px;
        font-size: 16px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        transition: all 0.3s;
    }

    .search-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .categories {
        max-height: 500px;
        overflow-y: auto;
        padding: 10px;
    }

    .category {
        margin-bottom: 10px;
        border-radius: 12px;
        overflow: hidden;
        background: #f8f9fa;
        transition: all 0.3s;
    }

    .category-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px 20px;
        cursor: pointer;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        transition: all 0.3s;
    }

    .category-header:hover {
        transform: translateX(5px);
    }

    .category-header:active {
        transform: scale(0.98);
    }

    .category-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        font-size: 16px;
    }

    .category-count {
        background: rgba(255,255,255,0.25);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
    }

    .category-arrow {
        transition: transform 0.3s;
        font-size: 18px;
    }

    .category.open .category-arrow {
        transform: rotate(180deg);
    }

    .category-products {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out;
        background: white;
    }

    .category-products.open {
        max-height: 2000px;
        transition: max-height 0.5s ease-in;
    }

    .product-item {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: all 0.2s;
    }

    .product-item:hover {
        background: #f8f9fa;
        padding-left: 25px;
    }

    .product-item:last-child {
        border-bottom: none;
    }

    .product-checkbox {
        width: 22px;
        height: 22px;
        margin-right: 12px;
        cursor: pointer;
        accent-color: #667eea;
    }

    .product-name {
        flex: 1;
        font-size: 15px;
        color: #333;
    }

    .product-item.selected {
        background: #f0f4ff;
    }

    .footer {
        padding: 20px;
        background: #f8f9fa;
        border-top: 1px solid #eee;
    }

    .selected-count {
        text-align: center;
        margin-bottom: 15px;
        font-size: 16px;
        color: #666;
    }

    .selected-count strong {
        color: #667eea;
        font-size: 24px;
    }

    .save-button {
        width: 100%;
        padding: 16px;
        font-size: 18px;
        font-weight: 600;
        color: white;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .save-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .save-button:active {
        transform: translateY(0);
    }

    .save-button:disabled {
        background: #ccc;
        cursor: not-allowed;
        box-shadow: none;
    }

    .loading {
        text-align: center;
        padding: 40px 20px;
        color: #666;
    }

    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .error {
        background: #fee;
        color: #c33;
        padding: 15px;
        border-radius: 8px;
        margin: 20px;
        text-align: center;
    }

    .success {
        background: #efe;
        color: #3c3;
        padding: 15px;
        border-radius: 8px;
        margin: 20px;
        text-align: center;
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #999;
    }

    .empty-state-icon {
        font-size: 48px;
        margin-bottom: 15px;
    }

    .category.hidden {
        display: none;
    }

    .highlight {
        background-color: yellow;
        font-weight: bold;
    }
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõí –í—ã–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤</h1>
            <div class="user-info">
                <span class="user-icon">üë§</span>
                <div class="user-details">
                    <span class="user-name" id="username">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    <span class="user-id" id="user-id">ID: ...</span>
                </div>
            </div>
        </div>
    <div class="search-container">
        <input 
            type="text" 
            class="search-input" 
            id="searchInput" 
            placeholder="üîç –ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤..."
        >
    </div>

    <div id="app">
        <div class="loading">
            <div class="spinner"></div>
            <div>–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤...</div>
        </div>
    </div>

    <div class="footer">
        <div class="selected-count">
            –í—ã–±—Ä–∞–Ω–æ: <strong id="selectedCount">0</strong>
        </div>
        <button class="save-button" id="saveButton" onclick="saveUserData()">
            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä
        </button>
    </div>
</div>

<script>
    // ========================================
    // –ü–û–õ–£–ß–ï–ù–ò–ï –¢–û–ö–ï–ù–ê –ò–ó URL
    // ========================================
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    let telegramId = '';
    let username = '';

    console.log('=== –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• ===');
    console.log('Token:', token ? token.substring(0, 20) + '...' : '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');

    if (!token) {
        console.warn('‚ö†Ô∏è –¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç - —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º');
        telegramId = '123456';
        username = 'TestUser';
    } else {
        console.log('‚úÖ –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω, –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω —Å–µ—Ä–≤–µ—Ä–æ–º');
    }

    // ========================================
    // CONFIGURATION
    // ========================================
    const CONFIG = {
        APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbyT5lxWKi0U8eXUnSikIY9MUb_pfWGKZTdVvS8XtiiCakmN9Cy7sDY8SMrT1wQfK4U8/exec'
    };

    // ========================================
    // STATE
    // ========================================
    let allProducts = [];
    let selectedProducts = new Set();
    let productsByCategory = {};

    // ========================================
    // –ó–ê–ì–†–£–ó–ö–ê –ü–†–û–î–£–ö–¢–û–í
    // ========================================
    async function loadProducts() {
        try {
            console.log('=== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ===');
            
            const url = `${CONFIG.APPS_SCRIPT_URL}?action=get_products&token=${encodeURIComponent(token || '')}`;
            
            console.log('–ó–∞–≥—Ä—É–∂–∞—é –ø—Ä–æ–¥—É–∫—Ç—ã...');
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
            
            if (!data.success) {
                throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
            }
            
            allProducts = data.products || [];
            console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allProducts.length} –ø—Ä–æ–¥—É–∫—Ç–æ–≤`);
            
            groupProductsByCategory();
            await loadUserData();
            renderProducts();
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤: ' + error.message);
        }
    }

    // ========================================
    // –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
    // ========================================
    async function loadUserData() {
        try {
            const url = `${CONFIG.APPS_SCRIPT_URL}?action=get_user_data&token=${encodeURIComponent(token || '')}`;
            
            console.log('–ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', data);
            
            if (data.success) {
                telegramId = data.telegram_id || telegramId;
                username = data.username || username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                
                document.getElementById('username').textContent = username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                document.getElementById('user-id').textContent = `ID: ${telegramId}`;
                
                console.log('Telegram ID:', telegramId);
                console.log('Username:', username);
                
                if (data.selected_products) {
                    const productIds = data.selected_products.split(',').filter(id => id.trim());
                    selectedProducts = new Set(productIds);
                    console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${selectedProducts.size} –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤`);
                }
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
        }
    }

    // ========================================
    // –ì–†–£–ü–ü–ò–†–û–í–ö–ê –ü–û –ö–ê–¢–ï–ì–û–†–ò–Ø–ú
    // ========================================
    function groupProductsByCategory() {
        productsByCategory = {};
        
        allProducts.forEach(product => {
            const category = product.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
            if (!productsByCategory[category]) {
                productsByCategory[category] = [];
            }
            productsByCategory[category].push(product);
        });
        
        console.log('–ö–∞—Ç–µ–≥–æ—Ä–∏–π:', Object.keys(productsByCategory).length);
    }

    // ========================================
    // –ü–û–î–°–í–ï–¢–ö–ê –¢–ï–ö–°–¢–ê –ü–†–ò –ü–û–ò–°–ö–ï
    // ========================================
    function highlightText(text, query) {
        if (!query) return text;
        
        const regex = new RegExp(`(${query})`, 'gi');
        return text.replace(regex, '<span class="highlight">$1</span>');
    }

    // ========================================
    // –ò–ö–û–ù–ö–ò –ö–ê–¢–ï–ì–û–†–ò–ô
    // ========================================
    function getCategoryIcon(category) {
        const icons = {
            '–†—ã–±–∞': 'üêü',
            '–ú—è—Å–æ': 'ü•©',
            '–ü—Ç–∏—Ü–∞': 'üçó',
            '–ú–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã': 'ü¶ê',
            '–ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã': 'ü•õ',
            '–ö—Ä—É–ø—ã, –±–æ–±–æ–≤—ã–µ, –º–∞–∫–∞—Ä–æ–Ω—ã': 'üçù',
            '–ö–æ—Ä–Ω–µ–ø–ª–æ–¥—ã': 'ü•ï',
            '–û–≤–æ—â–∏': 'ü•¨',
            '–§—Ä—É–∫—Ç—ã': 'üçé',
            '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏': 'üì¶'
        };
        return icons[category] || 'üì¶';
    }

    // ========================================
    // –û–¢–†–ò–°–û–í–ö–ê
    // ========================================
    function renderProducts(searchQuery = '') {
        const app = document.getElementById('app');
        
        if (allProducts.length === 0) {
            app.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üì¶</div>
                    <div>–ü—Ä–æ–¥—É–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                </div>
            `;
            return;
        }
        
        const categories = Object.keys(productsByCategory).sort();
        
        let visibleCategoriesCount = 0;
        
        const html = `
            <div class="categories">
                ${categories.map(category => {
                    const products = productsByCategory[category];
                    
                    let filteredProducts = products;
                    if (searchQuery) {
                        filteredProducts = products.filter(p => 
                            p.name.toLowerCase().includes(searchQuery.toLowerCase())
                        );
                    }
                    
                    if (filteredProducts.length === 0) {
                        return `<div class="category hidden" data-category="${category}"></div>`;
                    }
                    
                    visibleCategoriesCount++;
                    
                    const selectedInCategory = filteredProducts.filter(p => 
                        selectedProducts.has(p.id)
                    ).length;
                    
                    return `
                        <div class="category" data-category="${category}">
                            <div class="category-header" onclick="toggleCategory('${category}')">
                                <div class="category-title">
                                    <span>${getCategoryIcon(category)}</span>
                                    <span>${category}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span class="category-count">${selectedInCategory}/${filteredProducts.length}</span>
                                    <span class="category-arrow">‚ñº</span>
                                </div>
                            </div>
                            <div class="category-products">
                                ${filteredProducts.map(product => `
                                    <div class="product-item ${selectedProducts.has(product.id) ? 'selected' : ''}" 
                                         onclick="toggleProduct('${product.id}')">
                                        <input type="checkbox" 
                                               class="product-checkbox"
                                               ${selectedProducts.has(product.id) ? 'checked' : ''}
                                               onclick="event.stopPropagation(); toggleProduct('${product.id}')">
                                        <span class="product-name">${highlightText(product.name, searchQuery)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
        
        app.innerHTML = html;
        
        if (visibleCategoriesCount === 0 && searchQuery) {
            app.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üîç</div>
                    <div>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É "${searchQuery}"</div>
                </div>
            `;
        }
        
        updateSelectedCount();
    }

    // ========================================
    // –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ö–ê–¢–ï–ì–û–†–ò–ò
    // ========================================
    function toggleCategory(category) {
        const categoryElement = document.querySelector(`[data-category="${category}"]`);
        const productsDiv = categoryElement.querySelector('.category-products');
        
        categoryElement.classList.toggle('open');
        productsDiv.classList.toggle('open');
        
        if (productsDiv.classList.contains('open')) {
            const actualHeight = productsDiv.scrollHeight;
            productsDiv.style.maxHeight = actualHeight + 'px';
        } else {
            productsDiv.style.maxHeight = '0';
        }
    }

    // ========================================
    // –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ü–†–û–î–£–ö–¢–ê
    // ========================================
    function toggleProduct(productId) {
        if (selectedProducts.has(productId)) {
            selectedProducts.delete(productId);
        } else {
            selectedProducts.add(productId);
        }
        
        const searchQuery = document.getElementById('searchInput').value;
        renderProducts(searchQuery);
    }

    // ========================================
    // –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ß–Å–¢–ß–ò–ö–ê
    // ========================================
    function updateSelectedCount() {
        document.getElementById('selectedCount').textContent = selectedProducts.size;
    }

    // ========================================
    // –°–û–•–†–ê–ù–ï–ù–ò–ï
    // ========================================
    async function saveUserData() {
        try {
            const button = document.getElementById('saveButton');
            button.disabled = true;
            button.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            
            const productsString = Array.from(selectedProducts).join(',');
            const url = `${CONFIG.APPS_SCRIPT_URL}?action=save_user_data&products=${encodeURIComponent(productsString)}&token=${encodeURIComponent(token || '')}`;
            
            console.log('–°–æ—Ö—Ä–∞–Ω—è—é –¥–∞–Ω–Ω—ã–µ...');
            console.log('–ü—Ä–æ–¥—É–∫—Ç—ã:', productsString);
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', data);
            
            if (data.success) {
                showSuccess('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                button.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!';
                
                setTimeout(() => {
                    button.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä';
                    button.disabled = false;
                }, 2000);
            } else {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
            showError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
            
            const button = document.getElementById('saveButton');
            button.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä';
            button.disabled = false;
        }
    }

    // ========================================
    // –ü–û–ò–°–ö
    // ========================================
    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('searchInput');
        
        searchInput.addEventListener('input', (e) => {
            const searchQuery = e.target.value;
            renderProducts(searchQuery);
        });
    });

    // ========================================
    // –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
    // ========================================
    function showError(message) {
        const app = document.getElementById('app');
        app.innerHTML = `<div class="error">${message}</div>`;
    }

    function showSuccess(message) {
        const existingSuccess = document.querySelector('.success');
        if (existingSuccess) {
            existingSuccess.remove();
        }
        
        const successDiv = document.createElement('div');
        successDiv.className = 'success';
        successDiv.textContent = message;
        
        document.querySelector('.container').insertBefore(
            successDiv, 
            document.querySelector('.footer')
        );
        
        setTimeout(() => {
            successDiv.remove();
        }, 3000);
    }

    // ========================================
    // –ó–ê–ü–£–°–ö
    // ========================================
    loadProducts();
</script>
</body>
</html>
</artifact>
