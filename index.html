<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Выбор продуктов</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { min-height: 100%; height: auto; scrollbar-gutter: stable both-edges; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) fixed;
      padding: 20px 20px 160px 20px;
      color: #222;
    }

    .container {
      max-width: 600px;
      margin: 0 auto 20px;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,.28);
      overflow: visible;
    }

    .header { position: relative; background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; padding: 14px 18px; text-align: center; border-radius: 20px 20px 0 0; }
    .header h1 { font-size: 18px; font-weight: 800; letter-spacing: .2px; }

    .info-button { position: absolute; top: 12px; right: 12px; width: 28px; height: 28px; border-radius: 50%; border: 1.5px solid rgba(255,255,255,.6); background: rgba(255,255,255,.15); color: #fff; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform .2s, background .2s; box-shadow: 0 2px 8px rgba(0,0,0,.12) inset; }
    .info-button:hover { background: rgba(255,255,255,.25); transform: scale(1.08); }

    .search-container { padding: 14px 18px; border-bottom: 1px solid #eee; }
    .search-wrap { position: relative; }
    .search-input { width: 100%; padding: 14px 42px 14px 16px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 12px; transition: border-color .2s, box-shadow .2s; caret-color: #667eea; }
    .search-input::placeholder { color: #98a2b3; }
    .search-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,.12); }
    .search-clear { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 28px; height: 28px; border: none; background: #eef2ff; color: #4b5563; border-radius: 8px; cursor: pointer; display: none; align-items: center; justify-content: center; font-size: 18px; }
    .search-clear.visible { display: flex; }

    .categories { padding: 12px 18px; padding-bottom: var(--bottom-inset, 180px); }
    .category { margin-bottom: 12px; border-radius: 12px; background: #f7f8fb; }
    .category-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; cursor: pointer; background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; border-radius: 12px; }
    .category.open .category-header { border-radius: 12px 12px 0 0; }

    .category-products { max-height: 0; overflow: hidden; transition: max-height .32s ease; background: #fff; border-radius: 0 0 12px 12px; }

    .select-all-container { padding: 12px 16px; background: #f0f2f5; border-bottom: 1px solid #e8e8e8; display: flex; justify-content: center; }
    .select-all-btn { background: linear-gradient(135deg, #667eea, #764ba2); border: none; color: #fff; padding: 10px 22px; border-radius: 10px; font-size: 14px; cursor: pointer; font-weight: 700; width: 100%; max-width: 220px; }

    .product-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid #f0f0f0; }

    .save-button-container { position: fixed; left: 0; right: 0; bottom: 60px; padding: 12px 20px; background: #fff; border-top: 1px solid #eee; z-index: 100; }
    .save-button-wrapper { max-width: 600px; margin: 0 auto; }
    .selected-count { text-align: center; margin-bottom: 10px; font-weight: 700; }
    .save-button { width: 100%; padding: 12px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; font-size: 15px; color: #fff; background: linear-gradient(135deg, #667eea, #764ba2); box-shadow: 0 4px 12px rgba(102,126,234,.3); }

    .footer-nav { position: fixed; left: 0; right: 0; bottom: 0; height: 60px; background: #fff; border-top: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: space-around; z-index: 101; border-radius: 0 0 20px 20px; }

    .global-loader { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 2000; }
    .global-loader.active { display: flex; }
    .ring { width: 44px; height: 44px; border-radius: 50%; background: conic-gradient(from 0deg, #667eea, #764ba2 50%, #667eea); -webkit-mask: radial-gradient(farthest-side, transparent calc(100% - 5px), #000 0); mask: radial-gradient(farthest-side, transparent calc(100% - 5px), #000 0); animation: spin 1s linear infinite; }

    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Выбор продуктов</h1>
      <button class="info-button" id="infoButton">?</button>
    </div>

    <div class="search-container">
      <div class="search-wrap">
        <input id="searchInput" class="search-input" type="text" placeholder="Поиск продуктов" autocomplete="off" disabled />
        <button id="searchClear" class="search-clear" aria-label="Очистить">×</button>
      </div>
    </div>

    <div id="categories" class="categories"></div>
  </div>

  <div class="save-button-container">
    <div class="save-button-wrapper">
      <div class="selected-count">Выбрано: <strong><span id="selectedCount">0</span></strong></div>
      <button id="saveButton" class="save-button" disabled>💾 Сохранить</button>
    </div>
  </div>

  <div class="footer-nav"></div>

  <div class="global-loader" id="globalLoader">
    <div class="ring"></div>
  </div>

  <script>
    const CONFIG = { APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbxOJTIJ74ADNnwqjo-jTB5o80JBHI3LyZWGCefos4dJibThb8KUJ1avBieFaggSz_99/exec' };
    const tg = window.Telegram?.WebApp || { initData: '', expand: () => {} };

    const selectedProducts = new Set();
    let allCategories = {};
    let currentQuery = '';

    const loaderEl = document.getElementById('globalLoader');
    const searchInput = document.getElementById('searchInput');
    const searchClear = document.getElementById('searchClear');

    function showLoader(){ loaderEl.classList.add('active'); }
    function hideLoader(){ loaderEl.classList.remove('active'); }

    function updateBottomInset(){
      const saveH = document.querySelector('.save-button-container')?.offsetHeight || 0;
      const footH = document.querySelector('.footer-nav')?.offsetHeight || 0;
      const inset = saveH + footH + 16; // запас
      document.documentElement.style.setProperty('--bottom-inset', inset + 'px');
    }

    if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', initApp); } else { initApp(); }

    async function initApp(){
      showLoader();
      try{
        const res = await fetch(`${CONFIG.APPS_SCRIPT_URL}?action=init&initData=${encodeURIComponent(tg.initData||'')}`);
        const data = await res.json();
        const products = data.products || [];
        (data.user_data?.selected_products||'').split(',').filter(Boolean).forEach(id=>selectedProducts.add(String(id)));
        allCategories = groupByCategory(products);
        renderCategories();
        bindHandlers();
        updateTotalSelected();
        searchInput.disabled = false;
        updateBottomInset();
        window.addEventListener('resize', updateBottomInset);
      }catch(err){ alert('Ошибка загрузки: '+err.message); }
      finally{ hideLoader(); }
    }

    function groupByCategory(list){
      return list.reduce((acc,p)=>{ const cat=p.category||'Без категории'; (acc[cat] ||= []).push(p); return acc; },{});
    }

    function renderCategories(){
      const wrap = document.getElementById('categories');
      wrap.innerHTML = '';
      Object.entries(allCategories).forEach(([cat, items], i)=>{
        const selectedInCat = items.filter(p=>selectedProducts.has(String(p.id))).length;
        const el = document.createElement('div'); el.className='category'; el.dataset.products = JSON.stringify(items);
        el.innerHTML = `
          <div class='category-header'>
            <span class='category-title'>${escapeHtml(cat)}</span>
            <span class='category-count'>${selectedInCat}/${items.length}</span>
          </div>
          <div class='category-products'></div>`;
        wrap.appendChild(el);
      });
    }

    function bindHandlers(){
      document.getElementById('categories').addEventListener('click', e=>{
        const head=e.target.closest('.category-header');
        if(head){const cat=head.parentElement;toggleCategory(cat);} 
      });

      searchInput.addEventListener('input', e=>{
        const val=e.target.value.trim().toLowerCase();
        searchClear.classList.toggle('visible', val.length>0);
        currentQuery=val;applySearch();
      });
      searchClear.addEventListener('click',()=>{
        searchInput.value='';
        searchInput.focus();
        searchClear.classList.remove('visible');
        currentQuery='';
        applySearch();
      });

      document.getElementById('saveButton').addEventListener('click', onSave);
    }

    function toggleCategory(cat){
      const open=cat.classList.toggle('open');
      const panel=cat.querySelector('.category-products');
      if(open){
        renderCategoryProducts(cat);
        panel.style.maxHeight=panel.scrollHeight+'px';
        setTimeout(()=>panel.style.maxHeight='none',300);
      }else{
        panel.innerHTML='';
        panel.style.maxHeight='0';
      }
    }

    function renderCategoryProducts(cat){
      const panel=cat.querySelector('.category-products');
      const products=JSON.parse(cat.dataset.products);
      const filtered=currentQuery?products.filter(p=> (p.name||'').toLowerCase().includes(currentQuery)):products;
      const html = filtered.map(p=>`<div class='product-item'>
          <input type='checkbox' data-id='${p.id}' ${selectedProducts.has(String(p.id))?'checked':''}/>
          <label>${escapeHtml(p.name||'')}</label>
        </div>`).join('');
      panel.innerHTML = html || `<div style='padding:14px 16px; color:#667085;'>Нет совпадений</div>`;
      panel.querySelectorAll("input[type='checkbox']").forEach(i=>i.addEventListener('change',()=>{
        const id=i.dataset.id;
        if(i.checked)selectedProducts.add(id);else selectedProducts.delete(id);
        updateTotalSelected();
        updateCategoryHeaderCount(cat);
      }));
    }

    function updateCategoryHeaderCount(cat){
      const products = JSON.parse(cat.dataset.products);
      const sel = products.filter(p=>selectedProducts.has(String(p.id))).length;
      const total = products.length;
      const el = cat.querySelector('.category-count');
      if(el) el.textContent = `${sel}/${total}`;
    }

    function applySearch(){
      const cats=document.querySelectorAll('.category');
      cats.forEach(cat=>{
        const prods=JSON.parse(cat.dataset.products);
        const hasMatch=prods.some(p=> (p.name||'').toLowerCase().includes(currentQuery));
        cat.style.display=hasMatch||!currentQuery?'':'none';
        const panel = cat.querySelector('.category-products');
        if(currentQuery){
          if(hasMatch){
            // раскрываем все категории, где есть совпадения
            if(!cat.classList.contains('open')) cat.classList.add('open');
            renderCategoryProducts(cat);
            panel.style.maxHeight='none'; // без анимации в режиме поиска
          } else {
            cat.classList.remove('open');
            panel.innerHTML='';
            panel.style.maxHeight='0';
          }
        } else {
          // чистый режим — убираем автосостояния
          cat.classList.remove('open');
          panel.innerHTML='';
          panel.style.maxHeight='0';
        }
      });
    }

    async function onSave(){
      const btn=document.getElementById('saveButton');
      if(selectedProducts.size===0){ return; }
      btn.disabled=true;btn.textContent='Сохранение...';
      const ids=[...selectedProducts].join(',');
      const initData = tg?.initData || '';
      try{
        // Попытка №1: JSON (новый эндпоинт action=save)
        let res = await fetch(`${CONFIG.APPS_SCRIPT_URL}?action=save&initData=${encodeURIComponent(initData)}`,{
          method:'POST',
          headers:{'Content-Type':'application/json','X-Telegram-Init-Data': initData},
          body: JSON.stringify({ selected_products: ids })
        });
        let data = null; try{ data = await res.json(); }catch{}

        // Успех нового варианта
        if(res.ok && (data?.ok || data?.success || data?.status==='SUCCESS')){
          btn.textContent='✅ Сохранено'; setTimeout(()=>btn.textContent='💾 Сохранить',1100); return;
        }

        // Попытка №2: совместимость — FormData (старый эндпоинт action=save_user_data)
        const fd = new FormData();
        fd.append('action','save_user_data');
        fd.append('initData', initData);
        fd.append('products', ids);
        res = await fetch(`${CONFIG.APPS_SCRIPT_URL}`,{ method:'POST', body: fd, headers:{'X-Telegram-Init-Data': initData} });
        try{ data = await res.json(); }catch{}
        if(res.ok && (data?.ok || data?.success || data?.status==='SUCCESS')){
          btn.textContent='✅ Сохранено'; setTimeout(()=>btn.textContent='💾 Сохранить',1100); return;
        }

        // Если обе схемы не сработали — читаем текст и бросаем ошибку
        const text = data?.error || (await res.text().catch(()=>'')) || 'Не удалось сохранить';
        throw new Error(text);
      }catch(e){
        alert('Ошибка сохранения: '+ e.message);
        btn.textContent='💾 Сохранить';
      }finally{
        btn.disabled = selectedProducts.size===0;
      }
    }

    function updateTotalSelected(){
      document.getElementById('selectedCount').textContent=selectedProducts.size;
      document.getElementById('saveButton').disabled=selectedProducts.size===0;
    }

    const escapeHtml = s => (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  </script>
</body>
</html>
