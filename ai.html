<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
  <title>AI –ß–∞—Ç</title>

  <script>
  window.__pageLoadTime = (window.performance && performance.now) ? performance.now() : Date.now();
  const APP_HTML_VERSION = 'v2025-0010'; // –û–±–Ω–æ–≤–∏–ª –≤–µ—Ä—Å–∏—é

  if (!window.__vc_done) {
    window.__vc_done = true;
    (function smartVersionOnce(){
      try {
        const url = new URL(location.href);
        const v = url.searchParams.get('v');
        if (v !== APP_HTML_VERSION) {
          url.searchParams.set('v', APP_HTML_VERSION);
          history.replaceState(null, '', url.href);
        }
      } catch (_) {}
    })();
    window.addEventListener('pageshow', () => {
      try {
        const url = new URL(location.href);
        if (url.searchParams.get('v') !== APP_HTML_VERSION) {
          url.searchParams.set('v', APP_HTML_VERSION);
          history.replaceState(null, '', url.href);
        }
      } catch (_) {}
    }, { once: true });
  }
  </script>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* === 2. CSS LOCK (–ß—Ç–æ–±—ã –Ω–µ –ø—Ä—ã–≥–∞–ª–æ) === */
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    :root {
      --bg: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --userBubble: rgba(251,191,36,.25);
      --userBorder: rgba(251,191,36,.4);
      --aiBubble: rgba(255,255,255,.18);
      --aiBorder: rgba(255,255,255,.28);
      --inputBg: rgba(255,255,255,.12);
      --inputBorder: rgba(255,255,255,.24);
      --shadow: 0 8px 28px rgba(0,0,0,.18);
      --okA:#fbbf24; --okB:#f59e0b;
      --maxw: 560px;
    }

    html {
      background-color: #000; /* –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ–ª—ã—Ö –≤—Å–ø—ã—à–µ–∫ */
    }

    body {
      margin: 0; padding: 0; width: 100%;
      background: transparent; color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      overflow: hidden; /* –ó–ê–ü–†–ï–©–ê–ï–ú –°–ö–†–û–õ–õ BODY */
      position: fixed; top: 0; left: 0; bottom: 0; right: 0; /* –ñ–ï–°–¢–ö–ê–Ø –§–ò–ö–°–ê–¶–ò–Ø */
    }

    body::before {
      content:""; position:fixed; inset:0; background:var(--bg);
      z-index:-1; pointer-events:none;
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –º—ã –±—É–¥–µ–º —Ä–µ—Å–∞–π–∑–∏—Ç—å —á–µ—Ä–µ–∑ JS */
    .container {
      position: absolute; top: 0; left: 0; right: 0;
      height: 100%; 
      max-width: var(--maxw); margin: 0 auto;
      display: flex; flex-direction: column;
      overflow: hidden;
    }

    /* === –ò–ù–¢–ï–†–§–ï–ô–° === */
    .header {
      flex-shrink: 0; height: 56px;
      display: flex; align-items: center; justify-content: center;
      background: linear-gradient(180deg,var(--aiBubble),rgba(255,255,255,.12));
      border-bottom: 1px solid var(--aiBorder);
      border-radius: 0 0 20px 20px;
      position: relative; z-index: 10;
    }
    .header h4 { font-size: 18px; font-weight: 900; letter-spacing: .3px; }
    .clear-btn {
      position: absolute; right: 16px; padding: 8px 14px; border: 0; border-radius: 10px;
      background: rgba(239,68,68,.2); border: 1px solid rgba(239,68,68,.4);
      color: #fff; font-weight: 700; font-size: 13px; cursor: pointer; transition:.2s;
    }
    .clear-btn:active { transform:scale(.96); background:rgba(239,68,68,.3); }

    .chat-area {
      flex-grow: 1;
      overflow-y: auto; overflow-x: hidden;
      padding: 16px 14px;
      display: flex; flex-direction: column; gap: 12px;
      -webkit-overflow-scrolling: touch;
    }
    .chat-area::-webkit-scrollbar { width: 6px; }
    .chat-area::-webkit-scrollbar-thumb { background: rgba(255,255,255,.3); border-radius: 3px; }

    .message { display: flex; flex-direction: column; max-width: 80%; animation: slideIn .3s ease; position: relative; }
    @keyframes slideIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
    .message.user { align-self: flex-end; align-items: flex-end; }
    .message.ai { align-self: flex-start; align-items: flex-start; }

    .message-bubble {
      padding: 12px 16px; border-radius: 18px; 
      backdrop-filter: blur(12px); box-shadow: var(--shadow);
      font-size: 15px; line-height: 1.5; word-wrap: break-word;
    }
    .message.user .message-bubble {
      background: linear-gradient(135deg,var(--userBubble),rgba(251,191,36,.2));
      border: 1px solid var(--userBorder); border-bottom-right-radius: 4px;
    }
    .message.ai .message-bubble {
      background: linear-gradient(180deg,var(--aiBubble),rgba(255,255,255,.14));
      border: 1px solid var(--aiBorder); border-bottom-left-radius: 4px;
    }
    .message-time { font-size: 11px; opacity: .7; margin-top: 4px; padding: 0 4px; }

    .input-area {
      flex-shrink: 0; width: 100%;
      padding: 12px 14px; background: transparent; z-index: 5;
      /* position: fixed –£–ë–†–ê–ù–û */
    }
    .input-wrapper { display: flex; gap: 10px; align-items: flex-end; }
    .input-field {
      flex: 1; min-height: 44px; max-height: 120px; padding: 12px 16px;
      border: 1px solid var(--inputBorder); border-radius: 22px;
      background: var(--inputBg); backdrop-filter: blur(8px);
      color: #fff; font-size: 16px; font-family: inherit; resize: none; outline: none;
    }
    .input-field:focus { border-color: var(--okA); box-shadow: 0 0 0 3px rgba(251,191,36,.2); }
    .send-btn {
      width: 44px; height: 44px; border: 0; border-radius: 50%; flex-shrink: 0;
      background: linear-gradient(135deg,var(--okA),var(--okB));
      color: #fff; display: flex; align-items: center; justify-content: center;
      box-shadow: var(--shadow); transition:.2s;
    }
    .send-btn:active:not(:disabled){ transform:scale(.95); }
    .send-btn:disabled { opacity: .5; }
    .send-btn svg { width: 20px; height: 20px; }

    .empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: .7; text-align: center; }
    .empty-state-icon { font-size: 64px; margin-bottom: 16px; }
    .empty-state h2 { font-size: 20px; font-weight: 800; margin-bottom: 8px; }
    .empty-state p { font-size: 14px; opacity: .8; }

    .delete-btn {
      position: absolute; top: 50%; transform: translateY(-50%); width: 32px; height: 32px; border-radius: 50%;
      background: rgba(239,68,68,.9); border:1px solid rgba(239,68,68,1); color: #fff; display: none;
      align-items: center; justify-content: center; z-index: 10; box-shadow:0 4px 12px rgba(239,68,68,.4); transition:.2s;
    }
    .delete-btn:active { transform:translateY(-50%) scale(.9); }
    .message.user .delete-btn { left: -40px; } .message.ai .delete-btn { right: -40px; }
    .message.show-delete .delete-btn { display: flex; }
    .delete-btn svg { width:16px; height:16px; }

    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.7); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; backdrop-filter: blur(8px); }
    .modal.show { display: flex; }
    .modal-content { background: linear-gradient(180deg,var(--aiBubble),rgba(255,255,255,.12)); border: 1px solid var(--aiBorder); border-radius: 20px; padding: 24px; width: 100%; max-width: 340px; text-align: center; box-shadow:0 20px 60px rgba(0,0,0,.4); backdrop-filter:blur(20px); animation:modalSlideIn .3s ease; }
    @keyframes modalSlideIn{ from{opacity:0; transform:scale(.9) translateY(20px);} to{opacity:1; transform:scale(1) translateY(0);} }
    .modal h3 { font-size: 18px; font-weight: 900; margin-bottom: 12px; }
    .modal p { font-size: 14px; opacity: .9; margin-bottom: 20px; }
    .modal-buttons { display: flex; gap: 10px; }
    .modal-btn { flex: 1; padding: 12px; border-radius: 12px; border: 0; font-weight: 700; font-size:14px; cursor: pointer; transition:.2s; }
    .modal-btn:active { transform:scale(.96); }
    .modal-btn.cancel { background: rgba(255,255,255,.15); color: #fff; }
    .modal-btn.confirm { background: linear-gradient(135deg,var(--okA),var(--okB)); color: #fff; }

    .typing-indicator { display: flex; gap: 4px; padding: 12px 16px; }
    .typing-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,.7); animation: typing 1.4s infinite; }
    .typing-dot:nth-child(2){ animation-delay:.2s; } .typing-dot:nth-child(3){ animation-delay:.4s; }
    @keyframes typing{ 0%,60%,100%{transform:translateY(0);opacity:.7} 30%{transform:translateY(-10px);opacity:1} }
  </style>
</head>
<body>

  <div class="container">
    <div class="header">
      <h4>Ai-–ö–æ—É—á</h4>
      <button class="clear-btn" id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <div class="chat-area" id="chatArea">
      <div class="empty-state" id="emptyState">
        <div class="empty-state-icon">üí¨</div>
        <h2>–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥</h2>
        <p>–ó–∞–¥–∞–π—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É</p>
      </div>
    </div>

    <div class="input-area">
      <div class="input-wrapper">
        <textarea class="input-field" id="messageInput" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å..." rows="1"></textarea>
        <button class="send-btn" id="sendBtn" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <h3 id="modalTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
      <p id="modalText">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
      <div class="modal-buttons">
        <button class="modal-btn cancel" id="modalCancel">–û—Ç–º–µ–Ω–∞</button>
        <button class="modal-btn confirm" id="modalConfirm">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    /* ==================================================================
       1. STABLE VIEWPORT (OFFICIAL TELEGRAM API) - –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô –í–ï–†–ù–´–ô
       ================================================================== */
    (function initStableLayout() {
      const app = document.querySelector('.container');
      const input = document.getElementById('messageInput');
      const chatArea = document.getElementById('chatArea');
      const tg = window.Telegram?.WebApp;

      if (!app) return;

      function setHeight() {
        // –ï—Å–ª–∏ –µ—Å—Ç—å API –¢–µ–ª–µ–≥—Ä–∞–º–∞ - –±–µ—Ä–µ–º –≤—ã—Å–æ—Ç—É –æ—Ç—Ç—É–¥–∞ (–æ–Ω–∞ —É–∂–µ –±–µ–∑ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã)
        if (tg && tg.viewportHeight) {
          app.style.height = `${tg.viewportHeight}px`;
        } else {
          app.style.height = `${window.innerHeight}px`;
        }
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram
      if (tg) {
        try {
          tg.ready();
          tg.expand();
          tg.setHeaderColor?.('secondary_bg_color');
          if (tg.isVersionAtLeast?.('6.1')) tg.disableVerticalSwipes?.();
          tg.disableClosingConfirmation?.();
          
          // –ö–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥
          const HOME = './router.html'; // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ
          tg.BackButton?.offClick?.();
          tg.BackButton?.show?.();
          tg.BackButton?.onClick?.(()=>{ try{location.assign(HOME)}catch(_){location.href=HOME} });

          // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã—Å–æ—Ç—ã
          tg.onEvent('viewportChanged', ({ isStateStable }) => {
            setHeight();
            if (isStateStable) {
               requestAnimationFrame(() => { chatArea.scrollTop = chatArea.scrollHeight; });
            }
          });
        } catch (e) {}
        setHeight();
      } else {
        window.addEventListener('resize', setHeight);
        setHeight();
      }

      // FIX: –ü—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–µ–º–Ω–æ–≥–æ –∂–¥–µ–º –∏ —Å–∫—Ä–æ–ª–ª–∏–º —á–∞—Ç –≤–Ω–∏–∑
      if (input) {
        input.addEventListener('focus', () => {
          setTimeout(() => {
            chatArea.scrollTop = chatArea.scrollHeight;
          }, 300);
        });
      }
    })();

    /* ==================================================================
       2. BUSINESS LOGIC (–¢–í–û–ô –ë–≠–ö–ï–ù–î)
       ================================================================== */
    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbzvlDKUH6qsON-A6iSHYvMU_6XWtReZc5oXnnZOMTgETfvZqMMh2zUbdQJF-iOanMBc/exec';
    const REQUEST_TIMEOUT_MS = 45000;

    let messages = [];
    let isTyping = false;

    const chatArea = document.getElementById('chatArea');
    const emptyState = document.getElementById('emptyState');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    
    const modal = document.getElementById('confirmModal');
    const mTitle = document.getElementById('modalTitle');
    const mText = document.getElementById('modalText');
    const mCancel = document.getElementById('modalCancel');
    const mConfirm = document.getElementById('modalConfirm');
    let modalCallback = null;

    // --- API Call ---
    async function callBackend(action, payload) {
      const u = window.Telegram?.WebApp?.initDataUnsafe?.user || {};
      const uid = u.id || localStorage.getItem('debug_uid') || 'd-'+Math.floor(Math.random()*1e9);
      if(!u.id) localStorage.setItem('debug_uid', uid);

      const body = {
        action,
        user_id: uid,
        user_data: { first_name: u.first_name, username: u.username },
        init_data: window.Telegram?.WebApp?.initData || '',
        ...payload
      };

      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), REQUEST_TIMEOUT_MS);

      try {
        const res = await fetch(BACKEND_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify(body),
          signal: controller.signal
        });
        clearTimeout(id);
        return await res.json();
      } catch (e) {
        return { success:false, error: String(e) };
      }
    }

    // --- Render ---
    function formatTime(ts) {
      const d = new Date(ts);
      return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
    }

    function createMessageElement(m, idx) {
      const div = document.createElement('div');
      div.className = `message ${m.role}`;
      
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.textContent = m.content;
      
      const delBtn = document.createElement('div');
      delBtn.className = 'delete-btn';
      delBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6"/></svg>';
      delBtn.onclick = (e) => { e.stopPropagation(); confirmDelete(idx); };

      let timer;
      bubble.addEventListener('touchstart', () => timer = setTimeout(() => {
         div.classList.add('show-delete');
         if(window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
      }, 500));
      ['touchend','touchcancel','touchmove'].forEach(ev=>bubble.addEventListener(ev, ()=>clearTimeout(timer)));

      const time = document.createElement('div');
      time.className = 'message-time';
      time.textContent = formatTime(m.timestamp);

      div.appendChild(delBtn);
      div.appendChild(bubble);
      div.appendChild(time);
      return div;
    }

    function createTypingIndicator() {
      const div = document.createElement('div');
      div.className = 'message ai'; div.id = 'typingIndicator';
      div.innerHTML = `<div class="message-bubble"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
      return div;
    }

    function renderMessages() {
      const typ = document.getElementById('typingIndicator'); if(typ) typ.remove();
      chatArea.querySelectorAll('.message').forEach(m=>m.remove());
      
      if(messages.length > 0) {
        emptyState.style.display = 'none';
        messages.forEach((m,i) => chatArea.appendChild(createMessageElement(m,i)));
      } else {
        emptyState.style.display = 'flex';
      }
      requestAnimationFrame(() => chatArea.scrollTop = chatArea.scrollHeight);
    }

    // --- Actions ---
    function updateSendButton(){ const t=messageInput.value.trim(); sendBtn.disabled = !t || isTyping; }
    function autoResizeTextarea(){
        messageInput.style.height='auto';
        messageInput.style.height = Math.min(messageInput.scrollHeight,120)+'px';
    }

    async function sendMessage() {
      const text = messageInput.value.trim();
      if(!text || isTyping) return;
      
      if(window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('light');

      messages.push({ role:'user', content:text, timestamp:Date.now() });
      localStorage.setItem('ai_chat_messages', JSON.stringify(messages));
      renderMessages();

      messageInput.value = ''; autoResizeTextarea(); updateSendButton();
      isTyping = true;

      chatArea.appendChild(createTypingIndicator());
      chatArea.scrollTop = chatArea.scrollHeight;

      const res = await callBackend('send_message', { message: text });
      isTyping = false;
      const typ = document.getElementById('typingIndicator');
      if(typ) typ.remove();

      let aiContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
      if(res.success) {
         aiContent = res.text || '–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç';
         if(window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
      } else {
         aiContent = res.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞';
         if(window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
      }

      messages.push({ role:'ai', content:aiContent, timestamp:Date.now() });
      localStorage.setItem('ai_chat_messages', JSON.stringify(messages));
      renderMessages();
    }

    function confirmDelete(i) {
      mTitle.textContent = '–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?';
      mText.textContent = '–î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.';
      modalCallback = () => {
         messages.splice(i,1);
         localStorage.setItem('ai_chat_messages', JSON.stringify(messages));
         renderMessages();
      };
      modal.classList.add('show');
    }

    clearBtn.onclick = () => {
      if(!messages.length) return;
      mTitle.textContent = '–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?';
      mText.textContent = '–£–¥–∞–ª–∏—Ç –ø–µ—Ä–µ–ø–∏—Å–∫—É –ª–æ–∫–∞–ª—å–Ω–æ –∏ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥.';
      modalCallback = async () => {
         messages = [];
         localStorage.removeItem('ai_chat_messages');
         renderMessages();
         callBackend('clear_history', {});
      };
      modal.classList.add('show');
    };

    // --- Events & Init ---
    function hideModal(){ modal.classList.remove('show'); modalCallback=null; }
    mCancel.onclick = hideModal;
    mConfirm.onclick = () => { if(modalCallback) modalCallback(); hideModal(); };
    modal.onclick = (e) => { if(e.target===modal) hideModal(); };
    
    messageInput.addEventListener('input', ()=>{ updateSendButton(); autoResizeTextarea(); });
    messageInput.addEventListener('keydown', (e) => {
       if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });
    sendBtn.onclick = sendMessage;

    document.addEventListener('click', (e) => {
       document.querySelectorAll('.message.show-delete').forEach(el => {
          if(!el.contains(e.target)) el.classList.remove('show-delete');
       });
    });

    // Load data
    const saved = localStorage.getItem('ai_chat_messages');
    if(saved) { 
       try { messages = JSON.parse(saved); renderMessages(); } catch(e){} 
    }
    updateSendButton();
  </script>
</body>
</html>
