<!DOCTYPE html>
<html lang="ru">
<head>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1,
                 user-scalable=no, viewport-fit=cover, interactive-widget=overlays-content" />
  <meta charset="UTF-8" />
  <title>AI –ß–∞—Ç</title>

  <!-- === SMART VERSION CONTROL: –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–º–µ–Ω–µ –≤–µ—Ä—Å–∏–∏ (–±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫) === -->
  <script>
  // –§–∏–∫—Å–∏—Ä—É–µ–º –º–æ–º–µ–Ω—Ç –∑–∞–≥—Ä—É–∑–∫–∏
  window.__pageLoadTime = (window.performance && performance.now) ? performance.now() : Date.now();
  // ‚Üë –ú–µ–Ω—è–π –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Ä–µ–ª–∏–∑–µ
  const APP_HTML_VERSION = 'v2025-0005';

  if (!window.__vc_done) {
    window.__vc_done = true;

    (function smartVersionOnce(){
      try {
        const url = new URL(location.href);
        const v = url.searchParams.get('v');
        if (v !== APP_HTML_VERSION) {
          url.searchParams.set('v', APP_HTML_VERSION);
          // –º—è–≥–∫–∞—è –∑–∞–º–µ–Ω–∞ –∞–¥—Ä–µ—Å–∞ –±–µ–∑ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ –∏ –±–µ–∑ reload
          history.replaceState(null, '', url.href);
        }
      } catch (_) {}
    })();

    // –ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∏–∑ bfcache ‚Äî –ª–∏—à—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä, –ù–ï –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
    window.addEventListener('pageshow', () => {
      try {
        const url = new URL(location.href);
        if (url.searchParams.get('v') !== APP_HTML_VERSION) {
          url.searchParams.set('v', APP_HTML_VERSION);
          history.replaceState(null, '', url.href);
        }
      } catch (_) {}
    }, { once: true });
  }
  </script>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
    /* =========================================
       1. –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò
       ========================================= */
    :root {
      /* –í–∞—à–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ü–≤–µ—Ç–∞ */
      --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --userBubble: rgba(251, 191, 36, .25);
      --userBorder: rgba(251, 191, 36, .4);
      --aiBubble: rgba(255, 255, 255, .18);
      --aiBorder: rgba(255, 255, 255, .28);
      --inputBg: rgba(255, 255, 255, .12);
      --inputBorder: rgba(255, 255, 255, .24);
      --shadow: 0 8px 28px rgba(0, 0, 0, .18);
      --okA: #fbbf24; --okB: #f59e0b;

      /* –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è JS-—Ñ–∏–∫—Å–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã */
      --vh: 100vh;
      --kb: 0px;       /* –í—ã—Å–æ—Ç–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è JS) */
      --input-h: 56px; /* –í—ã—Å–æ—Ç–∞ –∏–Ω–ø—É—Ç–∞ (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è JS) */
      --maxw: 560px;
      --safe-bottom: env(safe-area-inset-bottom);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    /* –ó–∞—â–∏—Ç–∞ –æ—Ç –∞–≤—Ç–æ-–∑—É–º–∞ –Ω–∞ iOS */
    input, select, textarea { font-size: 16px; }
    button, [role="button"], .btn { touch-action: manipulation; }

    /* =========================================
       2. –ö–ê–†–ö–ê–° (FIX IOS BUG)
       –°–∞–º–∞—è –≤–∞–∂–Ω–∞—è —á–∞—Å—Ç—å: –∂–µ—Å—Ç–∫–∞—è —Ñ–∏–∫—Å–∞—Ü–∏—è
       ========================================= */
    html, body {
      position: fixed; /* –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ */
      top: 0; 
      left: 0;
      width: 100%; 
      height: 100%;
      overflow: hidden; /* –ù–∏–∫–∞–∫–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ */
      overscroll-behavior: none; /* –û—Ç–∫–ª—é—á–∞–µ–º "–ø—Ä—É–∂–∏–Ω–∫—É" iOS */
      background-color: #000; /* –¶–≤–µ—Ç –ø–æ–¥–ª–æ–∂–∫–∏, —á—Ç–æ–±—ã –Ω–µ –º–µ–ª—å–∫–∞–ª–æ –±–µ–ª—ã–º */
      touch-action: none; /* –û—Ç–∫–ª—é—á–∞–µ–º –ª–∏—à–Ω–∏–µ –∂–µ—Å—Ç—ã */
      z-index: 0;
    }

    /* –í–∞—à –∫—Ä–∞—Å–∏–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç –Ω–∞ —Ñ–æ–Ω–µ */
    body::before {
      content: ""; position: fixed; inset: 0;
      background: var(--bg);
      z-index: -1; pointer-events: none; transform: translateZ(0);
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —à–∏—Ä–∏–Ω—É –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
    .container {
      position: absolute;
      top: 0; 
      left: 0;
      width: 100%; 
      height: 100%;
      overflow: hidden;
      display: flex; 
      flex-direction: column;
    }

    /* =========================================
       3. –®–ê–ü–ö–ê (HEADER)
       ========================================= */
    .header {
      flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞—Ç—å —à–∞–ø–∫—É */
      padding: 14px 16px;
      display: flex; align-items: center; justify-content: center;
      background: linear-gradient(180deg, var(--aiBubble), rgba(255, 255, 255, .12));
      border-bottom: 1px solid var(--aiBorder);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border-radius: 0 0 20px 20px;
      position: relative; z-index: 10;
    }
    .header h4 { font-size: 18px; font-weight: 900; letter-spacing: .3px; }
    
    .clear-btn {
      position: absolute; right: 16px;
      padding: 8px 14px; border: 0; border-radius: 10px;
      background: rgba(239, 68, 68, .2); border: 1px solid rgba(239, 68, 68, .4);
      color: #fff; font-weight: 700; font-size: 13px; cursor: pointer; transition: .2s;
      -webkit-tap-highlight-color: transparent;
    }
    .clear-btn:active { transform: scale(.96); background: rgba(239, 68, 68, .3); }

    /* =========================================
       4. –û–ë–õ–ê–°–¢–¨ –ß–ê–¢–ê (SCROLL AREA)
       ========================================= */
    .chat-area {
      flex: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å–µ —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ */
      display: flex; flex-direction: column; gap: 12px;
      
      /* –°–∫—Ä–æ–ª–ª —Ä–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û –∑–¥–µ—Å—å */
      overflow-y: auto; 
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch; /* –ü–ª–∞–≤–Ω–æ—Å—Ç—å –Ω–∞ iOS */
      
      padding: 16px 14px;
      /* –ù–∏–∂–Ω–∏–π –æ—Ç—Å—Ç—É–ø = –ò–Ω–ø—É—Ç + –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ + –ó–∞–ø–∞—Å */
      padding-bottom: calc(var(--input-h) + var(--kb) + 20px);
    }
    /* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
    .chat-area::-webkit-scrollbar { width: 6px; }
    .chat-area::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, .3); border-radius: 3px; }

    /* =========================================
       5. –°–û–û–ë–©–ï–ù–ò–Ø (–°–¢–ò–õ–ò)
       ========================================= */
    .message { display: flex; flex-direction: column; max-width: 80%; animation: slideIn .3s ease; position: relative; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .message.user { align-self: flex-end; align-items: flex-end; }
    .message.ai { align-self: flex-start; align-items: flex-start; }
    
    .message-bubble {
      padding: 12px 16px; border-radius: 18px;
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      box-shadow: var(--shadow); font-size: 15px; line-height: 1.5;
      word-wrap: break-word; overflow-wrap: break-word;
      -webkit-user-select: none; user-select: none; -webkit-touch-callout: none;
    }
    
    .message.user .message-bubble {
      background: linear-gradient(135deg, var(--userBubble), rgba(251, 191, 36, .2));
      border: 1px solid var(--userBorder); border-bottom-right-radius: 4px;
    }
    .message.ai .message-bubble {
      background: linear-gradient(180deg, var(--aiBubble), rgba(255, 255, 255, .14));
      border: 1px solid var(--aiBorder); border-bottom-left-radius: 4px;
    }
    .message-time { font-size: 11px; opacity: .7; margin-top: 4px; padding: 0 4px; }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞ */
    .typing-indicator { display: flex; align-items: center; gap: 4px; padding: 12px 16px; }
    .typing-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255, 255, 255, .7); animation: typing 1.4s infinite; }
    .typing-dot:nth-child(2) { animation-delay: .2s; }
    .typing-dot:nth-child(3) { animation-delay: .4s; }
    @keyframes typing { 0%, 60%, 100% { transform: translateY(0); opacity: .7; } 30% { transform: translateY(-10px); opacity: 1; } }

    /* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è */
    .delete-btn {
      position: absolute; top: 50%; transform: translateY(-50%); width: 32px; height: 32px; border-radius: 50%;
      background: rgba(239, 68, 68, .9); border: 1px solid rgba(239, 68, 68, 1); color: #fff;
      display: none; align-items: center; justify-content: center; cursor: pointer;
      box-shadow: 0 4px 12px rgba(239, 68, 68, .4); z-index: 10; transition: .2s;
    }
    .message.user .delete-btn { left: -40px; }
    .message.ai .delete-btn { right: -40px; }
    .message.show-delete .delete-btn { display: flex; }
    .delete-btn:active { transform: translateY(-50%) scale(.9); }
    .delete-btn svg { width: 16px; height: 16px; }

    /* =========================================
       6. –ò–ù–ü–£–¢ (–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –î–õ–Ø iOS)
       ========================================= */
    .input-area {
      position: absolute; /* –í–Ω—É—Ç—Ä–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
      left: 0; right: 0;
      
      /* –ê–í–¢–û–ú–ê–¢–ò–ö–ê: –ü–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è JS-–æ–º —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é --kb */
      bottom: var(--kb, 0px);
      
      width: 100%;
      padding: 12px 14px;
      /* Safe area —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –∫–ª–∞–≤–∞ –∑–∞–∫—Ä—ã—Ç–∞ */
      padding-bottom: max(var(--safe-bottom), 8px);
      
      background: transparent;
      z-index: 20;
      
      /* –í–ê–ñ–ù–û: –£–±–∏—Ä–∞–µ–º transition, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∞ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π */
      /* –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏, –º–æ–∂–Ω–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, –Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã –±–∞–≥–∏ */
      /* transition: bottom 0.2s ease-out; */
    }

    .input-wrapper { display: flex; gap: 10px; align-items: flex-end; }
    .input-field {
      flex: 1; min-height: 44px; max-height: 120px;
      padding: 12px 16px; border: 1px solid var(--inputBorder);
      border-radius: 22px; background: var(--inputBg);
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      color: #fff; font-size: 15px; font-family: inherit;
      resize: none; overflow-y: auto; -webkit-overflow-scrolling: touch;
    }
    .input-field::placeholder { color: rgba(255, 255, 255, .6); }
    .input-field:focus { outline: none; border-color: var(--okA); box-shadow: 0 0 0 3px rgba(251, 191, 36, .2); }

    .send-btn {
      width: 44px; height: 44px; border: 0; border-radius: 50%; flex-shrink: 0;
      background: linear-gradient(135deg, var(--okA), var(--okB));
      color: #fff; display: flex; align-items: center; justify-content: center;
      box-shadow: var(--shadow); transition: .2s; -webkit-tap-highlight-color: transparent;
    }
    .send-btn:active:not(:disabled) { transform: scale(.95); }
    .send-btn:disabled { opacity: .5; cursor: not-allowed; }
    .send-btn svg { width: 20px; height: 20px; }

    /* =========================================
       7. EMPTY STATE –ò –ú–û–î–ê–õ–ö–ê
       ========================================= */
    .empty-state {
      flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 40px 20px; text-align: center; opacity: .7;
    }
    .empty-state-icon { font-size: 64px; margin-bottom: 16px; }
    .empty-state h2 { font-size: 20px; font-weight: 800; margin-bottom: 8px; }
    .empty-state p { font-size: 14px; opacity: .8; }

    .modal {
      position: fixed; inset: 0;
      background: rgba(0, 0, 0, .7);
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      display: none; align-items: center; justify-content: center;
      z-index: 1000; padding: 20px;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: linear-gradient(180deg, var(--aiBubble), rgba(255, 255, 255, .12));
      border: 1px solid var(--aiBorder); border-radius: 20px; padding: 24px;
      max-width: 340px; width: 100%; box-shadow: 0 20px 60px rgba(0, 0, 0, .4);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      animation: modalSlideIn .3s ease;
    }
    @keyframes modalSlideIn { from { opacity: 0; transform: scale(.9) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    .modal h3 { font-size: 18px; font-weight: 900; margin-bottom: 12px; }
    .modal p { font-size: 14px; opacity: .9; margin-bottom: 20px; line-height: 1.5; }
    .modal-buttons { display: flex; gap: 10px; }
    .modal-btn {
      flex: 1; padding: 12px; border: 0; border-radius: 12px; font-weight: 700; font-size: 14px;
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      cursor: pointer; transition: .2s; -webkit-tap-highlight-color: transparent;
    }
    .modal-btn.cancel { background: rgba(255, 255, 255, .15); color: #fff; }
    .modal-btn.confirm { background: linear-gradient(135deg, var(--okA), var(--okB)); color: #fff; }
    .modal-btn:active { transform: scale(.96); }
</style>

  <meta name="tma:home-url" content="./router.html" />
  <meta name="tma:home-hash" content="" />
</head>
<body>

  <div class="container">
    <div class="header">
      <h4>Ai-–ö–æ—É—á</h4>
      <button class="clear-btn" id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <div class="chat-area" id="chatArea">
      <div class="empty-state" id="emptyState">
        <div class="empty-state-icon">üí¨</div>
        <h2>–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥</h2>
        <p>–ó–∞–¥–∞–π—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É</p>
      </div>
    </div>

    <div class="input-area">
      <div class="input-wrapper">
        <textarea class="input-field" id="messageInput" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å..." rows="1"></textarea>
        <button class="send-btn" id="sendBtn" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <h3 id="modalTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
      <p id="modalText">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
      <div class="modal-buttons">
        <button class="modal-btn cancel" id="modalCancel">–û—Ç–º–µ–Ω–∞</button>
        <button class="modal-btn confirm" id="modalConfirm">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
 /* ====== 0) Telegram WebApp bootstrap + BackButton ====== */
(function initTMA(){
  const tg = window.Telegram?.WebApp;
  if (!tg) return;

  try {
    tg.ready();
    tg.expand();
    tg.setHeaderColor?.('secondary_bg_color');
    if (tg.isVersionAtLeast?.('6.1')) tg.disableVerticalSwipes?.();
    tg.disableClosingConfirmation?.(); // —á—Ç–æ–±—ã Telegram –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–ª –∑–∞–∫—Ä—ã—Ç–∏–µ
  } catch (_) {}

  const HOME = document.querySelector('meta[name="tma:home-url"]')?.content || './router.html';

  function closeKeyboardIfNeeded(){
    const el = document.activeElement;
    if (el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.isContentEditable)) {
      try { el.blur(); } catch(_){}
      return true; // –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –∑–∞–∫—Ä—ã–ª–∏ ‚Äî –Ω–∞–≤–∏–≥–∞—Ü–∏—é –ø–æ–∫–∞ –Ω–µ –¥–µ–ª–∞–µ–º
    }
    return false;
  }

  // –ö–∞—Å—Ç–æ–º–Ω–∞—è –∫–Ω–æ–ø–∫–∞ ¬´–ù–∞–∑–∞–¥¬ª: —Å–ø–µ—Ä–≤–∞ –∑–∞–∫—Ä—ã—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É, –ø–æ—Ç–æ–º –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ HOME
  try {
    tg.BackButton?.offClick?.();
    tg.BackButton?.show?.();
    tg.BackButton?.onClick?.(()=>{
      if (closeKeyboardIfNeeded()) return;
      try { location.assign(HOME); }
      catch(_) { try { location.href = HOME; } catch(__) { tg.close?.(); } }
    });
  } catch (_) {}

  // –°–∏—Å—Ç–µ–º–Ω—ã–π ¬´–Ω–∞–∑–∞–¥¬ª (–µ—Å–ª–∏ –ø–æ—è–≤–∏—Ç—Å—è): –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ ‚Äî —Ç–æ–ª—å–∫–æ blur, –±–µ–∑ —Ö–æ–∂–¥–µ–Ω–∏—è –ø–æ –∏—Å—Ç–æ—Ä–∏–∏
  window.addEventListener('popstate', () => {
    if (closeKeyboardIfNeeded()) {
      // –æ—Ç–º–µ–Ω—è–µ–º –ø—É—Å—Ç–æ–π —à–∞–≥ –Ω–∞–∑–∞–¥, —á—Ç–æ–±—ã —Å—Ç–µ–∫ –Ω–µ —Å—Ç—Ä–∞–¥–∞–ª
      try { history.forward(); } catch(_){}
    }
  }, { passive:true });
})();


  /* ====== 0.1) FIX: –°—Ç–∞–±–∏–ª–∏–∑–∞—Ç–æ—Ä –ë–ï–ó –ø—Ä—ã–∂–∫–æ–≤ ====== */
/* ====== 0.1) iOS/Telegram —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è (NUCLEAR FIX) ====== */
  (function initKeyboardStabilizer(){
    const tg   = window.Telegram && window.Telegram.WebApp;
    const vv   = window.visualViewport;
    
    // –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –≥–µ–æ–º–µ—Ç—Ä–∏–∏
    function updateGeometry() {
      // 1. –ñ–µ—Å—Ç–∫–∏–π —Å–±—Ä–æ—Å —Å–∫—Ä–æ–ª–ª–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ª–µ—á–∏—Ç "–ø—Ä—ã–∂–æ–∫" –∏ –¥—ã—Ä—É —Å–≤–µ—Ä—Ö—É)
      window.scrollTo(0, 0);
      document.body.scrollTop = 0;
      document.documentElement.scrollTop = 0;

      // 2. –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É –≤—å—é–ø–æ—Ä—Ç–∞
      // –ù–∞ iOS —Å overlays-content –≤—ã—Å–æ—Ç–∞ vv.height —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã?
      // –û–±—ã—á–Ω–æ —Å overlays-content –æ–Ω–∞ –ù–ï –º–µ–Ω—è–µ—Ç—Å—è, –∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø—Ä–æ—Å—Ç–æ –ª–æ–∂–∏—Ç—Å—è —Å–≤–µ—Ä—Ö—É.
      // –ù–æ –Ω–∞–º –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å –≤—ã—Å–æ—Ç—É –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã.
      
      let viewportHeight = window.innerHeight;
      let keyboardHeight = 0;
      
      if (vv) {
        // –í—ã—Å–æ—Ç–∞ –≤–∏–¥–∏–º–æ–π —á–∞—Å—Ç–∏
        viewportHeight = vv.height; 
        
        // –í—ã—á–∏—Å–ª—è–µ–º –≤—ã—Å–æ—Ç—É –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∫–∞–∫ —Ä–∞–∑–Ω–∏—Ü—É
        // (–° —É—á–µ—Ç–æ–º —Å–º–µ—â–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å)
        keyboardHeight = window.innerHeight - vv.height - vv.offsetTop;
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–±–∞–≥–∏ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è)
        if (keyboardHeight < 0) keyboardHeight = 0;
      }

      // 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
      document.documentElement.style.setProperty('--kb', `${keyboardHeight}px`);
      // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –æ–±–Ω–æ–≤–ª—è–µ–º –≤—ã—Å–æ—Ç—É, –µ—Å–ª–∏ –æ–Ω–∞ –ø–ª–∞–≤–∞–µ—Ç
      document.documentElement.style.setProperty('--vh', `${viewportHeight}px`); 
      
      // 4. –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã—Å–æ—Ç—É –∏–Ω–ø—É—Ç–∞
      const inputArea = document.querySelector('.input-area');
      if (inputArea) {
         document.documentElement.style.setProperty('--input-h', `${inputArea.offsetHeight}px`);
      }
    }

    // –°–õ–£–®–ê–¢–ï–õ–ò –°–û–ë–´–¢–ò–ô

    if (vv) {
      // –ö–æ–≥–¥–∞ –º–µ–Ω—è–µ—Ç—Å—è —Ä–∞–∑–º–µ—Ä –≤—å—é–ø–æ—Ä—Ç–∞ (–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –µ–¥–µ—Ç)
      vv.addEventListener('resize', updateGeometry);
      // –ö–æ–≥–¥–∞ –≤—å—é–ø–æ—Ä—Ç —Å–∫—Ä–æ–ª–ª–∏—Ç—Å—è (—ç—Ç–æ–≥–æ –±—ã—Ç—å –Ω–µ –¥–æ–ª–∂–Ω–æ, –Ω–æ –µ—Å–ª–∏ –≤–¥—Ä—É–≥)
      vv.addEventListener('scroll', updateGeometry);
    }

    // –û–±—ã—á–Ω—ã–π —Ä–µ—Å–∞–π–∑ –æ–∫–Ω–∞
    window.addEventListener('resize', updateGeometry);
    
    // –ê–ì–†–ï–°–°–ò–í–ù–ê–Ø –ë–û–†–¨–ë–ê –° –ü–†–´–ñ–ö–ê–ú–ò
    // –ö–∞–∫ —Ç–æ–ª—å–∫–æ —Å–∫—Ä–æ–ª–ª –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç (Safari –ø—ã—Ç–∞–µ—Ç—Å—è —Å–¥–≤–∏–Ω—É—Ç—å —ç–∫—Ä–∞–Ω) -> –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞–∑–∞–¥
    window.addEventListener('scroll', () => {
        if (window.scrollY !== 0) window.scrollTo(0, 0);
    }, { passive: false });

    // –ü—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ –∏–Ω–ø—É—Ç Safari —á–∞—Å—Ç–æ –¥–µ–ª–∞–µ—Ç –ø—Ä—ã–∂–æ–∫. 
    // –ú—ã –∂–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –≤—Å–µ.
    const input = document.getElementById('messageInput');
    if (input) {
      input.addEventListener('focus', () => {
        // –°—Ä–∞–∑—É
        window.scrollTo(0, 0);
        // –ò —á–µ—Ä–µ–∑ –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–∫–∏, –ø–æ–∫–∞ –∞–Ω–∏–º–∞—Ü–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∏–¥–µ—Ç
        setTimeout(() => window.scrollTo(0, 0), 100);
        setTimeout(() => window.scrollTo(0, 0), 300);
        setTimeout(updateGeometry, 350); // –§–∏–Ω–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç
      });
      
      // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞, –∫–æ–≥–¥–∞ –∫–ª–∏–∫–∞–µ—à—å –º–∏–º–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
      input.addEventListener('blur', () => {
        setTimeout(updateGeometry, 100);
      });
    }

    // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
    updateGeometry();
  })();

    function updateMetrics() {
      // 1. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –¥–µ—Ä–∂–∏–º –≤–µ—Ä—Ö
      forceScrollTop();
      
      // 2. –°—á–∏—Ç–∞–µ–º –≤—ã—Å–æ—Ç—É –∫–ª–∞–≤—ã
      let kbHeight = 0;
      if (vv) {
        // –í—ã—Å–æ—Ç–∞ —ç–∫—Ä–∞–Ω–∞ –ú–ò–ù–£–° –≤—ã—Å–æ—Ç–∞ –≤—å—é–ø–æ—Ä—Ç–∞ –ú–ò–ù–£–° —Å–º–µ—â–µ–Ω–∏–µ –≤—å—é–ø–æ—Ä—Ç–∞
        // –≠—Ç–æ —Å–∞–º–∞—è —Ç–æ—á–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ –¥–ª—è iOS WebKit
        kbHeight = window.innerHeight - vv.height - vv.offsetTop;
        if (kbHeight < 0) kbHeight = 0;
      }

      // 3. –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
      document.documentElement.style.setProperty('--kb', `${kbHeight}px`);
      
      // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã—Å–æ—Ç—É –∏–Ω–ø—É—Ç–∞
      const inputEl = document.querySelector('.input-area');
      if (inputEl) {
         document.documentElement.style.setProperty('--input-h', `${inputEl.offsetHeight}px`);
      }
    }

    // –°–õ–£–®–ê–¢–ï–õ–ò
    if (vv) {
      vv.addEventListener('resize', updateMetrics);
      vv.addEventListener('scroll', updateMetrics); // –õ–æ–≤–∏–º –ø–æ–ø—ã—Ç–∫–∏ —Å–∫—Ä–æ–ª–ª–∞ –≤—å—é–ø–æ—Ä—Ç–∞
    }
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª - –≤—Ä–∞–≥ ‚Ññ1. –£–±–∏–≤–∞–µ–º –µ–≥–æ.
    window.addEventListener('scroll', forceScrollTop, { passive: false });

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ
    const input = document.getElementById('messageInput');
    if (input) {
      input.addEventListener('focus', () => {
        setTimeout(forceScrollTop, 100); // –°—Ç—Ä–∞—Ö–æ–≤–∫–∞ —á–µ—Ä–µ–∑ 100–º—Å
      });
    }
    
    // –ó–∞–ø—É—Å–∫
    updateMetrics();
})();

  /* ====== 1) –ö–æ–Ω—Ñ–∏–≥ —Ñ—Ä–æ–Ω—Ç–∞ ====== */
  const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbz1fXF1OKxoku0ZbbSSu2uxnlndaiilEjWh3mR1GFoaOtM8eWoggAjwoDOVLetR3H7C/exec'; // ‚Üê –ó–ê–ú–ï–ù–ò –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
  const REQUEST_TIMEOUT_MS = 45000;

  /* ====== 2) –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏ DOM ====== */
  let messages = [];
  let isTyping = false;

  const chatArea   = document.getElementById('chatArea');
  const emptyState = document.getElementById('emptyState');
  const messageInput = document.getElementById('messageInput');
  const sendBtn    = document.getElementById('sendBtn');
  const clearBtn   = document.getElementById('clearBtn');

  const confirmModal = document.getElementById('confirmModal');
  const modalTitle   = document.getElementById('modalTitle');
  const modalText    = document.getElementById('modalText');
  const modalCancel  = document.getElementById('modalCancel');
  const modalConfirm = document.getElementById('modalConfirm');

  let modalCallback = null;

  /* ====== 3) –•–µ–ª–ø–µ—Ä—ã Telegram –∏ API ====== */
  function getInitData() {
    return (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) || '';
  }
  function getUser() {
    const u = (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) || {};
    return { id: u.id || null, first_name: u.first_name || '', username: u.username || '' };
  }

  // fetch —Å —Ç–∞–π–º–∞—É—Ç–æ–º (AbortController)
  function fetchWithTimeout(url, options = {}, ms = REQUEST_TIMEOUT_MS) {
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), ms);
    return fetch(url, { ...options, signal: controller.signal })
      .finally(() => clearTimeout(id));
  }

  // –µ–¥–∏–Ω—ã–π –≤—ã–∑–æ–≤ –±—ç–∫–∞ (–±–µ–∑ preflight ‚Üí text/plain)
  async function callBackend(action, payload) {
    const u = getUser();
    const body = Object.assign({
      action,
      user_id: u.id || localStorage.getItem('debug_uid') || (function(){ const x='debug-' + Math.floor(Math.random()*1e9); localStorage.setItem('debug_uid', x); return x; })(),
      user_data: { first_name: u.first_name, username: u.username },
      init_data: getInitData()
    }, payload || {});

    const res = await fetchWithTimeout(BACKEND_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(body)
    });

    let data;
    try { data = await res.json(); }
    catch(e) { data = { success:false, code:'bad_json', error:'Invalid JSON from backend' }; }
    return data;
  }

  /* ====== 4) –†–∞–±–æ—Ç–∞ —Å –ª–æ–∫–∞–ª—å–Ω—ã–º —Å—Ç–æ—Ä–æ–º ====== */
  function loadData() {
    try {
      const savedMessages = localStorage.getItem('ai_chat_messages');
      if (savedMessages) { messages = JSON.parse(savedMessages); renderMessages(); }
    } catch (e) { console.error('Error loading data:', e); }
  }
  function saveMessages() {
    try { localStorage.setItem('ai_chat_messages', JSON.stringify(messages)); } catch (e) { console.error('Error saving messages:', e); }
  }

  /* ====== 5) –†–µ–Ω–¥–µ—Ä ====== */
  function formatTime(date){ const h=String(date.getHours()).padStart(2,'0'); const m=String(date.getMinutes()).padStart(2,'0'); return h+':'+m; }

  function createMessageElement(message, index){
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message ' + message.role; messageDiv.dataset.index = index;

    const bubble = document.createElement('div'); bubble.className='message-bubble'; bubble.textContent = message.content;
    const time = document.createElement('div'); time.className='message-time'; time.textContent = formatTime(new Date(message.timestamp));
    const del = document.createElement('button'); del.className='delete-btn'; del.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6"/></svg>';
    del.onclick = (e)=>{ e.stopPropagation(); deleteMessage(index); };

    messageDiv.appendChild(del); messageDiv.appendChild(bubble); messageDiv.appendChild(time);

    // long-press –¥–ª—è –ø–æ–∫–∞–∑–∞ delete
    let longPressTimer;
    const startLP = ()=>{ longPressTimer = setTimeout(()=>{ messageDiv.classList.add('show-delete'); if(window.Telegram?.WebApp?.HapticFeedback){ window.Telegram.WebApp.HapticFeedback.impactOccurred('medium'); } },100); };
    const cancelLP = ()=>{ clearTimeout(longPressTimer); };
    bubble.addEventListener('touchstart', startLP, { passive:true });
    ['touchend','touchcancel','touchmove'].forEach(ev=>bubble.addEventListener(ev,cancelLP));

    return messageDiv;
  }

  function createTypingIndicator(){
    const messageDiv=document.createElement('div'); messageDiv.className='message ai'; messageDiv.id='typingIndicator';
    const bubble=document.createElement('div'); bubble.className='message-bubble';
    const indicator=document.createElement('div'); indicator.className='typing-indicator';
    indicator.innerHTML='<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
    bubble.appendChild(indicator); messageDiv.appendChild(bubble); return messageDiv;
  }

  function renderMessages(){
    const tip=document.getElementById('typingIndicator'); if(tip) tip.remove();
    chatArea.querySelectorAll('.message').forEach(m=>m.remove());
    emptyState.style.display = messages.length ? 'none' : 'flex';
    if(messages.length){ messages.forEach((m,i)=> chatArea.appendChild(createMessageElement(m,i))); }
    scrollToBottom();
  }
  function addMessageToChat(message){
    if (emptyState.style.display !== 'none') emptyState.style.display = 'none';
    const index = messages.length - 1;
    chatArea.appendChild(createMessageElement(message, index));
    scrollToBottom();
  }
  function scrollToBottom(){ requestAnimationFrame(()=>{ chatArea.scrollTop = chatArea.scrollHeight; }); }
  function showTyping(){ isTyping = true; chatArea.appendChild(createTypingIndicator()); scrollToBottom(); }
  function hideTyping(){ isTyping = false; const tip=document.getElementById('typingIndicator'); if(tip) tip.remove(); }

  /* ====== 6) –û—Ç–ø—Ä–∞–≤–∫–∞ ====== */
  async function sendMessage() {
    const text = messageInput.value.trim();
    if (!text || isTyping) return;

    if (window.Telegram?.WebApp?.HapticFeedback) {
      window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
    }

    const userMessage = { role: 'user', content: text, timestamp: Date.now() };
    messages.push(userMessage);
    saveMessages();
    addMessageToChat(userMessage);

    messageInput.value = '';
    messageInput.style.height = 'auto';
    updateSendButton();

    showTyping();

    try {
      const resp = await callBackend('send_message', { message: text });
      console.log('backend response:', resp);

      hideTyping();

      if (!resp || !resp.success) {
        const errText = (resp && (resp.error || resp.code))
          ? `–û—à–∏–±–∫–∞: ${resp.code || ''} ${resp.error || ''}`
          : '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
        const aiError = { role: 'ai', content: errText.trim(), timestamp: Date.now() };
        messages.push(aiError);
        saveMessages();
        addMessageToChat(aiError);
        return;
      }

      if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
      }

      const answer = resp.text
        || (resp.status === 'timeout'
            ? '–û—Ç–≤–µ—Ç —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –¥–æ–ª—å—à–µ –æ–±—ã—á–Ω–æ–≥–æ ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.'
            : '–ì–æ—Ç–æ–≤–æ.');

      const aiMessage = { role: 'ai', content: answer, timestamp: Date.now() };
      messages.push(aiMessage);
      saveMessages();
      addMessageToChat(aiMessage);
    } catch (error) {
      hideTyping();
      console.error('network error:', error);
      const aiError = { role: 'ai', content: '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.', timestamp: Date.now() };
      messages.push(aiError);
      saveMessages();
      addMessageToChat(aiError);
    }
  }

  /* ====== 7) –£–¥–∞–ª–µ–Ω–∏–µ/–æ—á–∏—Å—Ç–∫–∞ –∏ –º–æ–¥–∞–ª–∫–∞ ====== */
  function deleteMessage(index){
    showConfirmModal('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?','–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å', ()=>{
      messages.splice(index,1); saveMessages(); renderMessages();
      if (window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
    });
  }

  function clearChat(){
    if (messages.length === 0) return;
    showConfirmModal('–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç?','–í—Å—è –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞ —É –≤–∞—Å –ª–æ–∫–∞–ª—å–Ω–æ –∏ –Ω–∞—á–Ω—ë—Ç—Å—è –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º.', async ()=>{
      messages = []; saveMessages(); renderMessages();
      try {
        const resp = await callBackend('clear_history', {});
        if (!resp || !resp.success) {
          const aiMsg = { role:'ai', content:'–ù–µ —É–¥–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –ú–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å, –Ω–æ –∏—Å—Ç–æ—Ä–∏—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –Ω–µ –æ–±–Ω—É–ª–∏–ª–∞—Å—å.', timestamp: Date.now() };
          messages.push(aiMsg); saveMessages(); addMessageToChat(aiMsg);
        } else {
          const aiMsg = { role:'ai', content:'–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞. –ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥. ‚ú®', timestamp: Date.now() };
          messages.push(aiMsg); saveMessages(); addMessageToChat(aiMsg);
        }
      } catch (e) {
        const aiMsg = { role:'ai', content:'–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ª–æ–∫–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞.', timestamp: Date.now() };
        messages.push(aiMsg); saveMessages(); addMessageToChat(aiMsg);
      }
      if (window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
    });
  }

  function showConfirmModal(title,text,onConfirm){
    modalTitle.textContent = title; modalText.textContent = text; modalCallback = onConfirm; confirmModal.classList.add('show');
    if (window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
  }
  function hideConfirmModal(){ confirmModal.classList.remove('show'); modalCallback = null; }

  /* ====== 8) UI –º–µ–ª–æ—á–∏ ====== */
  function updateSendButton(){ const hasText = messageInput.value.trim().length > 0; sendBtn.disabled = !hasText || isTyping; }
  function autoResizeTextarea(){
    messageInput.style.height='auto';
    messageInput.style.height = Math.min(messageInput.scrollHeight,120)+'px';
  }

  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('input', ()=>{ updateSendButton(); autoResizeTextarea(); });
  messageInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
  clearBtn.addEventListener('click', clearChat);
  document.getElementById('modalCancel').addEventListener('click', hideConfirmModal);
  document.getElementById('modalConfirm').addEventListener('click', ()=>{ if (modalCallback) modalCallback(); hideConfirmModal(); });

  // –≥–ª–æ–±–∞–ª—å–Ω—ã–π –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å ‚Äî —Å–∫—Ä—ã–≤–∞—Ç—å delete —É –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  document.addEventListener('click', (e) => {
    document.querySelectorAll('.message.show-delete').forEach(el => {
      if (!el.contains(e.target)) el.classList.remove('show-delete');
    });
  });

  confirmModal.addEventListener('click', (e)=>{ if(e.target===confirmModal) hideConfirmModal(); });

  /* ====== 9) Init ====== */
  loadData(); updateSendButton();

  // Prevent zoom on double tap (iOS)
  let lastTouchEnd = 0;
  document.addEventListener('touchend', (e)=>{ const now=Date.now(); if(now-lastTouchEnd<=300){ e.preventDefault(); } lastTouchEnd=now; }, { passive:false });
  </script>

</body>
</html>
