<!DOCTYPE html>
<html lang="ru">
<head>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1,
                 user-scalable=no, viewport-fit=cover, interactive-widget=overlays-content" />
  <meta charset="UTF-8" />
  <title>AI –ß–∞—Ç</title>

  <!-- === SMART VERSION CONTROL === -->
  <script>
  window.__pageLoadTime = (window.performance && performance.now) ? performance.now() : Date.now();
  const APP_HTML_VERSION = 'v2025-0007'; // ‚Üê –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤–µ—Ä—Å–∏—è

  if (!window.__vc_done) {
    window.__vc_done = true;

    (function smartVersionOnce(){
      try {
        const url = new URL(location.href);
        const v = url.searchParams.get('v');
        if (v !== APP_HTML_VERSION) {
          url.searchParams.set('v', APP_HTML_VERSION);
          history.replaceState(null, '', url.href);
        }
      } catch (_) {}
    })();

    window.addEventListener('pageshow', () => {
      try {
        const url = new URL(location.href);
        if (url.searchParams.get('v') !== APP_HTML_VERSION) {
          url.searchParams.set('v', APP_HTML_VERSION);
          history.replaceState(null, '', url.href);
        }
      } catch (_) {}
    }, { once: true });
  }
  </script>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    html, body, button, [role="button"], .btn { touch-action: manipulation; }
    input, select, textarea { font-size: 16px; }

    :root{
      --bg: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --userBubble: rgba(251,191,36,.25);
      --userBorder: rgba(251,191,36,.4);
      --aiBubble: rgba(255,255,255,.18);
      --aiBorder: rgba(255,255,255,.28);
      --inputBg: rgba(255,255,255,.12);
      --inputBorder: rgba(255,255,255,.24);
      --shadow: 0 8px 28px rgba(0,0,0,.18);
      --okA:#fbbf24; --okB:#f59e0b;

      /* ==== –°—Ç–∞–±–∏–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ==== */
      --vh: 100svh;
      --input-h: 56px; /* —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã—Å–æ—Ç–∞ –∏–Ω–ø—É—Ç–∞ */
      --maxw: 560px;
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    html,body{ height:100%; }
    html{ background:transparent; }
    body{
      min-height: var(--vh);
      background:transparent; color:#fff;
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
      position:relative; isolation:isolate; display:flex; flex-direction:column;
      overscroll-behavior-y: contain;
    }
    @supports (min-height: 100dvh){
      body{ min-height: 100dvh; }
    }

    body::before{
      content:""; position:fixed; inset:0; background:var(--bg);
      z-index:0; pointer-events:none; transform:translateZ(0);
    }

    .container{
      position:relative; z-index:1; width:100%;
      max-width: var(--maxw); margin:0 auto; display:flex; flex-direction:column;
      min-height: var(--vh);
    }
    @supports (min-height: 100dvh){
      .container{ min-height: 100dvh; }
    }

    .header{
      padding:14px 16px; display:flex; align-items:center; justify-content:center;
      background:linear-gradient(180deg,var(--aiBubble),rgba(255,255,255,.12));
      border-bottom:1px solid var(--aiBorder); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
      position:relative; border-radius:0 0 20px 20px;
    }
    .header h4{ font-size:18px; font-weight:900; letter-spacing:.3px; }
    .clear-btn{
      position:absolute; right:16px; padding:8px 14px; border:0; border-radius:10px;
      background:rgba(239,68,68,.2); border:1px solid rgba(239,68,68,.4); color:#fff; font-weight:700; font-size:13px; cursor:pointer; transition:.2s;
      -webkit-tap-highlight-color:transparent;
    }
    .clear-btn:active{ transform:scale(.96); background:rgba(239,68,68,.3); }

    .chat-area{
      flex:1; overflow-y:auto; overflow-x:hidden; padding:16px 14px;
      display:flex; flex-direction:column; gap:12px;
      -webkit-overflow-scrolling:touch; scrollbar-width:thin; scrollbar-color:rgba(255,255,255,.3) transparent;

      /* –ò–°–ü–†–ê–í–õ–ï–ù–û: —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π padding –≤–º–µ—Å—Ç–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ */
      padding-bottom: calc(16px + env(safe-area-inset-bottom) + 80px);
      scroll-padding-bottom: 100px;
    }
    .chat-area::-webkit-scrollbar{ width:6px; }
    .chat-area::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.3); border-radius:3px; }

    .message{ display:flex; flex-direction:column; max-width:80%; animation:slideIn .3s ease; position:relative; }
    @keyframes slideIn{ from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
    .message.user{ align-self:flex-end; align-items:flex-end; }
    .message.ai{ align-self:flex-start; align-items:flex-start; }
    .message-bubble{
      padding:12px 16px; border-radius:18px; backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
      box-shadow:var(--shadow); font-size:15px; line-height:1.5; word-wrap:break-word; overflow-wrap:break-word;
      -webkit-user-select: none; user-select: none; -webkit-touch-callout: none;
    }
    .message.user .message-bubble{
      background:linear-gradient(135deg,var(--userBubble),rgba(251,191,36,.2));
      border:1px solid var(--userBorder); border-bottom-right-radius:4px;
    }
    .message.ai .message-bubble{
      background:linear-gradient(180deg,var(--aiBubble),rgba(255,255,255,.14));
      border:1px solid var(--aiBorder); border-bottom-left-radius:4px;
    }
    .message-time{ font-size:11px; opacity:.7; margin-top:4px; padding:0 4px; }

    .typing-indicator{ display:flex; align-items:center; gap:4px; padding:12px 16px; }
    .typing-dot{ width:8px; height:8px; border-radius:50%; background:rgba(255,255,255,.7); animation:typing 1.4s infinite; }
    .typing-dot:nth-child(2){ animation-delay:.2s; }
    .typing-dot:nth-child(3){ animation-delay:.4s; }
    @keyframes typing{ 0%,60%,100%{ transform:translateY(0); opacity:.7; } 30%{ transform:translateY(-10px); opacity:1; } }

    /* ==== –∏–Ω–ø—É—Ç-–ø–∞–Ω–µ–ª—å ==== */
    .input-area{
      position: fixed; left: 50%; transform: translateX(-50%) translateZ(0);
      bottom: 0; width: min(100%, var(--maxw)); padding:12px 14px;
      padding-bottom: max(env(safe-area-inset-bottom), 8px);
      background: transparent; will-change: transform;
      z-index: 5;
    }
    .input-wrapper{ display:flex; gap:10px; align-items:flex-end; }
    .input-field{
      flex:1; min-height:44px; max-height:120px; padding:12px 16px; border:1px solid var(--inputBorder);
      border-radius:22px; background:var(--inputBg); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px);
      color:#fff; font-size:15px; font-family:inherit; resize:none; overflow-y:auto; -webkit-overflow-scrolling:touch;
    }
    .input-field::placeholder{ color:rgba(255,255,255,.6); }
    .input-field:focus{ outline:none; border-color:var(--okA); box-shadow:0 0 0 3px rgba(251,191,36,.2); }
    .send-btn{
      width:44px; height:44px; border:0; border-radius:50%;
      background:linear-gradient(135deg,var(--okA),var(--okB));
      color:#fff; display:flex; align-items:center; justify-content:center; box-shadow:var(--shadow);
      transition:.2s; -webkit-tap-highlight-color:transparent;
    }
    .send-btn:active:not(:disabled){ transform:scale(.95); }
    .send-btn:disabled{ opacity:.5; cursor:not-allowed; }
    .send-btn svg{ width:20px; height:20px; }

    .empty-state{ flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:40px 20px; text-align:center; opacity:.7; }
    .empty-state-icon{ font-size:64px; margin-bottom:16px; }
    .empty-state h2{ font-size:20px; font-weight:800; margin-bottom:8px; }
    .empty-state p{ font-size:14px; opacity:.8; }

    .delete-btn{
      position:absolute; top:50%; transform:translateY(-50%); width:32px; height:32px; border-radius:50%;
      background:rgba(239,68,68,.9); border:1px solid rgba(239,68,68,1); color:#fff; display:none; align-items:center; justify-content:center; cursor:pointer;
      box-shadow:0 4px 12px rgba(239,68,68,.4); z-index:10; transition:.2s;
    }
    .message.user .delete-btn{ left:-40px; }
    .message.ai .delete-btn{ right:-40px; }
    .message.show-delete .delete-btn{ display:flex; }
    .delete-btn:active{ transform:translateY(-50%) scale(.9); }
    .delete-btn svg{ width:16px; height:16px; }

    .modal{
      position:fixed; inset:0; background:rgba(0,0,0,.7); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px);
      display:none; align-items:center; justify-content:center; z-index:1000; padding:20px;
    }
    .modal.show{ display:flex; }
    .modal-content{
      background:linear-gradient(180deg,var(--aiBubble),rgba(255,255,255,.12));
      border:1px solid var(--aiBorder); border-radius:20px; padding:24px; max-width:340px; width:100%; box-shadow:0 20px 60px rgba(0,0,0,.4);
      backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); animation:modalSlideIn .3s ease;
    }
    @keyframes modalSlideIn{ from{opacity:0; transform:scale(.9) translateY(20px);} to{opacity:1; transform:scale(1) translateY(0);} }
    .modal h3{ font-size:18px; font-weight:900; margin-bottom:12px; }
    .modal p{ font-size:14px; opacity:.9; margin-bottom:20px; line-height:1.5; }
    .modal-buttons{ display:flex; gap:10px; }
    .modal-btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px;
      flex:1; padding:12px; border:0; border-radius:12px; font-weight:700; font-size:14px; cursor:pointer; transition:.2s; -webkit-tap-highlight-color:transparent; }
    .modal-btn.cancel{ background:rgba(255,255,255,.15); color:#fff; }
    .modal-btn.confirm{ background:linear-gradient(135deg,var(--okA),var(--okB)); color:#fff; }
    .modal-btn:active{ transform:scale(.96); }
  </style>

  <meta name="tma:home-url" content="./router.html" />
  <meta name="tma:home-hash" content="" />
</head>
<body>

  <div class="container">
    <div class="header">
      <h4>Ai-–ö–æ—É—á</h4>
      <button class="clear-btn" id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <div class="chat-area" id="chatArea">
      <div class="empty-state" id="emptyState">
        <div class="empty-state-icon">üí¨</div>
        <h2>–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥</h2>
        <p>–ó–∞–¥–∞–π—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É</p>
      </div>
    </div>

    <div class="input-area">
      <div class="input-wrapper">
        <textarea class="input-field" id="messageInput" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å..." rows="1"></textarea>
        <button class="send-btn" id="sendBtn" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <h3 id="modalTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
      <p id="modalText">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
      <div class="modal-buttons">
        <button class="modal-btn cancel" id="modalCancel">–û—Ç–º–µ–Ω–∞</button>
        <button class="modal-btn confirm" id="modalConfirm">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
 /* ====== 0) Telegram WebApp bootstrap + BackButton ====== */
(function initTMA(){
  const tg = window.Telegram?.WebApp;
  if (!tg) return;

  try {
    tg.ready();
    tg.expand();
    tg.setHeaderColor?.('secondary_bg_color');
    if (tg.isVersionAtLeast?.('6.1')) tg.disableVerticalSwipes?.();
    tg.disableClosingConfirmation?.();
  } catch (_) {}

  const HOME = document.querySelector('meta[name="tma:home-url"]')?.content || './router.html';

  function closeKeyboardIfNeeded(){
    const el = document.activeElement;
    if (el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.isContentEditable)) {
      try { el.blur(); } catch(_){}
      return true;
    }
    return false;
  }

  try {
    tg.BackButton?.offClick?.();
    tg.BackButton?.show?.();
    tg.BackButton?.onClick?.(()=>{
      if (closeKeyboardIfNeeded()) return;
      try { location.assign(HOME); }
      catch(_) { try { location.href = HOME; } catch(__) { tg.close?.(); } }
    });
  } catch (_) {}

  window.addEventListener('popstate', () => {
    if (closeKeyboardIfNeeded()) {
      try { history.forward(); } catch(_){}
    }
  }, { passive:true });
})();


  /* ====== 0.1) –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø iOS/Telegram —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã ====== */
  (function initKeyboardStabilizer(){
    const tg   = window.Telegram && window.Telegram.WebApp;
    const vv   = window.visualViewport;
    const root = document.documentElement;
    const chat = document.getElementById('chatArea');
    const input = document.getElementById('messageInput');
    
    let isUserScrolling = false;
    let scrollTimeout = null;
    let lastScrollTop = 0;

    // –§–ª–∞–≥, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞
    let preventAutoScroll = false;

    function updateViewportHeight(){
      let vh = window.innerHeight;
      if (tg && tg.viewportStableHeight) vh = tg.viewportStableHeight;
      root.style.setProperty('--vh', Math.round(vh) + 'px');
    }

    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –º—è–≥–∫–∏–π —Å–∫—Ä–æ–ª–ª –±–µ–∑ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä—ã–∂–∫–∞
    function scrollToBottomSmooth(){
      if (!chat || preventAutoScroll || isUserScrolling) return;
      
      requestAnimationFrame(() => {
        const isNearBottom = chat.scrollHeight - chat.scrollTop - chat.clientHeight < 150;
        if (isNearBottom) {
          // –ü–ª–∞–≤–Ω–æ –¥–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤–Ω–∏–∑—É
          chat.scrollTo({
            top: chat.scrollHeight,
            behavior: 'smooth'
          });
        }
      });
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å–∫—Ä–æ–ª–ª–∏—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Ä—É—á–Ω—É—é
    if (chat) {
      chat.addEventListener('scroll', () => {
        clearTimeout(scrollTimeout);
        
        const currentScrollTop = chat.scrollTop;
        const isScrollingUp = currentScrollTop < lastScrollTop;
        
        if (isScrollingUp) {
          isUserScrolling = true;
          preventAutoScroll = true;
        }
        
        lastScrollTop = currentScrollTop;
        
        // –ï—Å–ª–∏ –¥–æ—Å–∫—Ä–æ–ª–ª–∏–ª–∏ –≤–Ω–∏–∑ - —Ä–∞–∑—Ä–µ—à–∞–µ–º –∞–≤—Ç–æ-—Å–∫—Ä–æ–ª–ª
        const isAtBottom = chat.scrollHeight - chat.scrollTop - chat.clientHeight < 10;
        if (isAtBottom) {
          isUserScrolling = false;
          preventAutoScroll = false;
        }
        
        scrollTimeout = setTimeout(() => {
          isUserScrolling = false;
        }, 150);
      }, { passive: true });
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤—ã—Å–æ—Ç—É viewport, –ë–ï–ó –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞
    function update(){
      updateViewportHeight();
      // –£–±—Ä–∞–ª–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π scrollTop!
    }

    // –ü—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ –∏–Ω–ø—É—Ç–µ - —Ä–∞–∑—Ä–µ—à–∞–µ–º –∞–≤—Ç–æ-—Å–∫—Ä–æ–ª–ª
    if (input) {
      input.addEventListener('focus', () => {
        preventAutoScroll = false;
        setTimeout(() => {
          scrollToBottomSmooth();
        }, 300);
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    updateViewportHeight();

    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –º–µ–Ω—å—à–µ —Å–ª—É—à–∞—Ç–µ–ª–µ–π, –±–µ–∑ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–≥–æ update()
    if (tg && tg.onEvent){
      tg.onEvent('viewportChanged', (e)=> { 
        if (e && e.isStateStable) {
          updateViewportHeight();
        }
      });
    }
    
    // –ò–°–ü–†–ê–í–õ–ï–ù–û: —É–±—Ä–∞–ª–∏ scroll listener –æ—Ç visualViewport
    if (vv){
      vv.addEventListener('resize', updateViewportHeight);
    }
    
    window.addEventListener('orientationchange', ()=> setTimeout(updateViewportHeight, 300));
    window.addEventListener('resize', updateViewportHeight);

    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö
    window.__scrollToBottomSmooth = scrollToBottomSmooth;
  })();

  /* ====== 1) –ö–æ–Ω—Ñ–∏–≥ —Ñ—Ä–æ–Ω—Ç–∞ ====== */
  const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbz1fXF1OKxoku0ZbbSSu2uxnlndaiilEjWh3mR1GFoaOtM8eWoggAjwoDOVLetR3H7C/exec';
  const REQUEST_TIMEOUT_MS = 45000;

  /* ====== 2) –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏ DOM ====== */
  let messages = [];
  let isTyping = false;

  const chatArea   = document.getElementById('chatArea');
  const emptyState = document.getElementById('emptyState');
  const messageInput = document.getElementById('messageInput');
  const sendBtn    = document.getElementById('sendBtn');
  const clearBtn   = document.getElementById('clearBtn');

  const confirmModal = document.getElementById('confirmModal');
  const modalTitle   = document.getElementById('modalTitle');
  const modalText    = document.getElementById('modalText');
  const modalCancel  = document.getElementById('modalCancel');
  const modalConfirm = document.getElementById('modalConfirm');

  let modalCallback = null;

  /* ====== 3) –•–µ–ª–ø–µ—Ä—ã Telegram –∏ API ====== */
  function getInitData() {
    return (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) || '';
  }
  function getUser() {
    const u = (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) || {};
    return { id: u.id || null, first_name: u.first_name || '', username: u.username || '' };
  }

  function fetchWithTimeout(url, options = {}, ms = REQUEST_TIMEOUT_MS) {
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), ms);
    return fetch(url, { ...options, signal: controller.signal })
      .finally(() => clearTimeout(id));
  }

  async function callBackend(action, payload) {
    const u = getUser();
    const body = Object.assign({
      action,
      user_id: u.id || localStorage.getItem('debug_uid') || (function(){ const x='debug-' + Math.floor(Math.random()*1e9); localStorage.setItem('debug_uid', x); return x; })(),
      user_data: { first_name: u.first_name, username: u.username },
      init_data: getInitData()
    }, payload || {});

    const res = await fetchWithTimeout(BACKEND_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(body)
    });

    let data;
    try { data = await res.json(); }
    catch(e) { data = { success:false, code:'bad_json', error:'Invalid JSON from backend' }; }
    return data;
  }

  /* ====== 4) –†–∞–±–æ—Ç–∞ —Å –ª–æ–∫–∞–ª—å–Ω—ã–º —Å—Ç–æ—Ä–æ–º ====== */
  function loadData() {
    try {
      const savedMessages = localStorage.getItem('ai_chat_messages');
      if (savedMessages) { messages = JSON.parse(savedMessages); renderMessages(); }
    } catch (e) { console.error('Error loading data:', e); }
  }
  function saveMessages() {
    try { localStorage.setItem('ai_chat_messages', JSON.stringify(messages)); } catch (e) { console.error('Error saving messages:', e); }
  }

  /* ====== 5) –†–µ–Ω–¥–µ—Ä ====== */
  function formatTime(date){ const h=String(date.getHours()).padStart(2,'0'); const m=String(date.getMinutes()).padStart(2,'0'); return h+':'+m; }

  function createMessageElement(message, index){
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message ' + message.role; messageDiv.dataset.index = index;

    const bubble = document.createElement('div'); bubble.className='message-bubble'; bubble.textContent = message.content;
    const time = document.createElement('div'); time.className='message-time'; time.textContent = formatTime(new Date(message.timestamp));
    const del = document.createElement('button'); del.className='delete-btn'; del.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6"/></svg>';
    del.onclick = (e)=>{ e.stopPropagation(); deleteMessage(index); };

    messageDiv.appendChild(del); messageDiv.appendChild(bubble); messageDiv.appendChild(time);

    let longPressTimer;
    const startLP = ()=>{ longPressTimer = setTimeout(()=>{ messageDiv.classList.add('show-delete'); if(window.Telegram?.WebApp?.HapticFeedback){ window.Telegram.WebApp.HapticFeedback.impactOccurred('medium'); } },100); };
    const cancelLP = ()=>{ clearTimeout(longPressTimer); };
    bubble.addEventListener('touchstart', startLP, { passive:true });
    ['touchend','touchcancel','touchmove'].forEach(ev=>bubble.addEventListener(ev,cancelLP));

    return messageDiv;
  }

  function createTypingIndicator(){
    const messageDiv=document.createElement('div'); messageDiv.className='message ai'; messageDiv.id='typingIndicator';
    const bubble=document.createElement('div'); bubble.className='message-bubble';
    const indicator=document.createElement('div'); indicator.className='typing-indicator';
    indicator.innerHTML='<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
    bubble.appendChild(indicator); messageDiv.appendChild(bubble); return messageDiv;
  }

  function renderMessages(){
    const tip=document.getElementById('typingIndicator'); if(tip) tip.remove();
    chatArea.querySelectorAll('.message').forEach(m=>m.remove());
    emptyState.style.display = messages.length ? 'none' : 'flex';
    if(messages.length){ messages.forEach((m,i)=> chatArea.appendChild(createMessageElement(m,i))); }
    scrollToBottom();
  }
  
  function addMessageToChat(message){
    if (emptyState.style.display !== 'none') emptyState.style.display = 'none';
    const index = messages.length - 1;
    chatArea.appendChild(createMessageElement(message, index));
    scrollToBottom();
  }
  
  // –ò–°–ü–†–ê–í–õ–ï–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º –º—è–≥–∫–∏–π —Å–∫—Ä–æ–ª–ª
  function scrollToBottom(){ 
    if (window.__scrollToBottomSmooth) {
      window.__scrollToBottomSmooth();
    } else {
      requestAnimationFrame(()=>{ chatArea.scrollTop = chatArea.scrollHeight; });
    }
  }
  
  function showTyping(){ isTyping = true; chatArea.appendChild(createTypingIndicator()); scrollToBottom(); }
  function hideTyping(){ isTyping = false; const tip=document.getElementById('typingIndicator'); if(tip) tip.remove(); }

  /* ====== 6) –û—Ç–ø—Ä–∞–≤–∫–∞ ====== */
  async function sendMessage() {
    const text = messageInput.value.trim();
    if (!text || isTyping) return;

    if (window.Telegram?.WebApp?.HapticFeedback) {
      window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
    }

    const userMessage = { role: 'user', content: text, timestamp: Date.now() };
    messages.push(userMessage);
    saveMessages();
    addMessageToChat(userMessage);

    messageInput.value = '';
    messageInput.style.height = 'auto';
    updateSendButton();

    showTyping();

    try {
      const resp = await callBackend('send_message', { message: text });
      console.log('backend response:', resp);

      hideTyping();

      if (!resp || !resp.success) {
        const errText = (resp && (resp.error || resp.code))
          ? `–û—à–∏–±–∫–∞: ${resp.code || ''} ${resp.error || ''}`
          : '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
        const aiError = { role: 'ai', content: errText.trim(), timestamp: Date.now() };
        messages.push(aiError);
        saveMessages();
        addMessageToChat(aiError);
        return;
      }

      if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
      }

      const answer = resp.text
        || (resp.status === 'timeout'
            ? '–û—Ç–≤–µ—Ç —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –¥–æ–ª—å—à–µ –æ–±—ã—á–Ω–æ–≥–æ ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.'
            : '–ì–æ—Ç–æ–≤–æ.');

      const aiMessage = { role: 'ai', content: answer, timestamp: Date.now() };
      messages.push(aiMessage);
      saveMessages();
      addMessageToChat(aiMessage);
    } catch (error) {
      hideTyping();
      console.error('network error:', error);
      const aiError = { role: 'ai', content: '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.', timestamp: Date.now() };
      messages.push(aiError);
      saveMessages();
      addMessageToChat(aiError);
    }
  }

  /* ====== 7) –£–¥–∞–ª–µ–Ω–∏–µ/–æ—á–∏—Å—Ç–∫–∞ –∏ –º–æ–¥–∞–ª–∫–∞ ====== */
  function deleteMessage(index){
    showConfirmModal('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?','–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å', ()=>{
      messages.splice(index,1); saveMessages(); renderMessages();
      if (window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
    });
  }

  function clearChat(){
    if (messages.length === 0) return;
    showConfirmModal('–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç?','–í—Å—è –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞ —É –≤–∞—Å –ª–æ–∫–∞–ª—å–Ω–æ –∏ –Ω–∞—á–Ω—ë—Ç—Å—è –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º.', async ()=>{
      messages = []; saveMessages(); renderMessages();
      try {
        const resp = await callBackend('clear_history', {});
        if (!resp || !resp.success) {
          const aiMsg = { role:'ai', content:'–ù–µ —É–¥–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –ú–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å, –Ω–æ –∏—Å—Ç–æ—Ä–∏—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –Ω–µ –æ–±–Ω—É–ª–∏–ª–∞—Å—å.', timestamp: Date.now() };
          messages.push(aiMsg); saveMessages(); addMessageToChat(aiMsg);
        } else {
          const aiMsg = { role:'ai', content:'–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞. –ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥. ‚ú®', timestamp: Date.now() };
          messages.push(aiMsg); saveMessages(); addMessageToChat(aiMsg);
        }
      } catch (e) {
        const aiMsg = { role:'ai', content:'–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ª–æ–∫–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞.', timestamp: Date.now() };
        messages.push(aiMsg); saveMessages(); addMessageToChat(aiMsg);
      }
      if (window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
    });
  }

  function showConfirmModal(title,text,onConfirm){
    modalTitle.textContent = title; modalText.textContent = text; modalCallback = onConfirm; confirmModal.classList.add('show');
    if (window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
  }
  function hideConfirmModal(){ confirmModal.classList.remove('show'); modalCallback = null; }

  /* ====== 8) UI –º–µ–ª–æ—á–∏ ====== */
  function updateSendButton(){ const hasText = messageInput.value.trim().length > 0; sendBtn.disabled = !hasText || isTyping; }
  function autoResizeTextarea(){
    messageInput.style.height='auto';
    messageInput.style.height = Math.min(messageInput.scrollHeight,120)+'px';
  }

  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('input', ()=>{ updateSendButton(); autoResizeTextarea(); });
  messageInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
  clearBtn.addEventListener('click', clearChat);
  document.getElementById('modalCancel').addEventListener('click', hideConfirmModal);
  document.getElementById('modalConfirm').addEventListener('click', ()=>{ if (modalCallback) modalCallback(); hideConfirmModal(); });

  document.addEventListener('click', (e) => {
    document.querySelectorAll('.message.show-delete').forEach(el => {
      if (!el.contains(e.target)) el.classList.remove('show-delete');
    });
  });

  confirmModal.addEventListener('click', (e)=>{ if(e.target===confirmModal) hideConfirmModal(); });

  /* ====== 9) Init ====== */
  loadData(); updateSendButton();

  let lastTouchEnd = 0;
  document.addEventListener('touchend', (e)=>{ const now=Date.now(); if(now-lastTouchEnd<=300){ e.preventDefault(); } lastTouchEnd=now; }, { passive:false });
  </script>

</body>
</html>
