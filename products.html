<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>–í—ã–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤ Ultima</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root {
    /* --- PALETTE --- */
    --bg-core: #050505;
    --text-main: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.55);
    
    /* --- GLASS SURFACES --- */
    --surface-glass: rgba(255, 255, 255, 0.07);
    --surface-dark: rgba(0, 0, 0, 0.3);
    --surface-border: rgba(255, 255, 255, 0.1);
    --surface-border-light: rgba(255, 255, 255, 0.2);
    
    /* --- ACCENTS --- */
    --acc-blue: #0a84ff;
    --acc-green: #30d158;
    
    /* --- KBJU VARS --- */
    --okA: #4facfe; 
    --okB: #0a84ff;
    
    /* --- METRICS --- */
    --radius-xl: 28px;
    --radius-l: 24px;
    --radius-m: 16px;
    --pad-x: 16px; 
    --gap: 8px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  
  /* üî• CRITICAL FOR IOS RESPONSIVENESS */
  html, body, button, .cat-card, .product-row, .btn-save { 
    touch-action: manipulation; 
  }

  body {
    background-color: var(--bg-core) !important;
    color: var(--text-main);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', Roboto, Helvetica, Arial, sans-serif;
    height: 100vh;
    overflow: hidden; 
    display: flex;
    flex-direction: column;
    -webkit-font-smoothing: antialiased;
  }

  /* --- FX LAYER --- */
  .fx-layer { position: fixed; inset: 0; z-index: 0; pointer-events: none; transform: translate3d(0,0,0); }
  .orb { position: absolute; border-radius: 50%; will-change: transform; animation: float 30s infinite linear; }
  .orb-1 { width: 90vw; height: 90vw; opacity: 0.4; background: radial-gradient(circle, rgba(108, 92, 231, 0.8) 0%, transparent 70%); top: -20%; left: -20%; }
  .orb-2 { width: 400px; height: 400px; opacity: 0.5; background: radial-gradient(circle, rgba(108, 92, 231, 0.8) 0%, transparent 70%); bottom: -150px; right: -100px; animation: breathe 6s infinite ease-in-out; }
  .noise { position: fixed; inset: 0; z-index: 0; opacity: 0.04; background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); pointer-events: none; }
  @keyframes float { 0% {transform:rotate(0deg)} 100% {transform:rotate(360deg)} }
  @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.4; } 50% { transform: scale(1.1); opacity: 0.6; } }

  /* --- LAYOUT --- */
  .app-header { position: relative; z-index: 10; padding: 12px var(--pad-x) 4px; background: transparent; flex-shrink: 0; }

  /* Search Bar */
  .search-box { position: relative; }
  .search-input {
    width: 100%; height: 40px; background: var(--surface-dark);
    border: 1px solid var(--surface-border); border-top: 1px solid var(--surface-border-light);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-radius: 14px; padding: 0 36px 0 40px;
    color: #fff; font-size: 16px; font-weight: 500;
    transition: all 0.2s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .search-input::placeholder { color: rgba(255,255,255,0.35); font-weight: 400; }
  .search-input:focus { background: rgba(0, 0, 0, 0.5); border-color: rgba(255, 255, 255, 0.25); outline: none; }
  .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.4); pointer-events: none; }
  .search-clear {
    position: absolute; right: 0; top: 0; bottom: 0; width: 36px;
    display: flex; align-items: center; justify-content: center;
    color: rgba(255,255,255,0.4); opacity: 0; pointer-events: auto; transition: opacity 0.2s;
  }
  .search-input:not(:placeholder-shown) ~ .search-clear { opacity: 1; }

  /* --- VIEW CONTAINER --- */
  .views-container { position: relative; flex: 1; overflow: hidden; z-index: 1; }
  
  .view {
    position: absolute; inset: 0; overflow-y: auto; overflow-x: hidden;
    -webkit-overflow-scrolling: touch; padding: 12px var(--pad-x) 140px;
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s ease;
    opacity: 0; pointer-events: none; transform: translateX(30px);
    background: transparent;
  }
  .view.active { opacity: 1; pointer-events: auto; transform: translateX(0); }
  .view.prev { transform: translateX(-10%) scale(0.98); opacity: 0; pointer-events: none; }

  /* --- CATEGORY GRID --- */
  .cat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--gap); }
  
  .cat-card {
    background: var(--surface-dark) !important;
    border: 1px solid var(--surface-border) !important;
    border-top: 1px solid var(--surface-border-light) !important;
    border-radius: var(--radius-l) !important;
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.2) !important;
    padding: 14px;
    display: flex; flex-direction: column; justify-content: space-between;
    min-height: 110px;
    cursor: pointer; position: relative; overflow: hidden;
    transition: background 0.2s; 
    will-change: transform;
  }
  
  /* Active state: only color change */
  .cat-card:active { background: rgba(0,0,0,0.4) !important; }
  
  .cat-icon { font-size: 24px; margin-bottom: 10px; filter: drop-shadow(0 4px 12px rgba(0,0,0,0.3)); }
  .cat-name { font-size: 14px; font-weight: 700; line-height: 1.2; margin-bottom: 2px; color: #fff; letter-spacing: 0.3px; }
  .cat-meta { font-size: 12px; color: rgba(255,255,255,0.55); font-weight: 500; }
  .cat-progress-track { position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: rgba(255,255,255,0.05); }
  .cat-progress-fill {
    height: 100%; background: var(--acc-blue); width: 0%; 
    transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 -1px 8px var(--acc-blue);
  }

  /* --- HEADER LIST --- */
  .list-header-area { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding: 0 4px; }
  .list-title { font-size: 20px; font-weight: 800; letter-spacing: 0.3px; color: #fff; }
  .btn-select-all {
    font-size: 15px; font-weight: 600; color: var(--acc-blue);
    background: none; border: none; padding: 6px 0; cursor: pointer; transition: opacity 0.2s;
  }
  .btn-select-all:active { opacity: 0.7; }

  /* --- PRODUCT LIST CONTAINER --- */
  .product-list-container {
    display: flex; flex-direction: column; gap: 8px;
    background: linear-gradient(165deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    padding: 14px; border-radius: 20px; backdrop-filter: blur(10px);
  }

  /* --- PRODUCT ROW --- */
  .product-row {
    display: flex; align-items: center; justify-content: flex-start;
    gap: 12px;
    padding: 12px 14px; border-radius: 12px;
    position: relative; cursor: pointer; background: transparent;
    transition: background 0.1s ease;
    will-change: transform; /* Prepare GPU for bump */
  }
  
  /* Active state (Grey flash) */
  .product-row:active { background: rgba(255,255,255,0.05); }
  .product-row.selected { background: transparent; } 

  /* üî• KEYFRAMES: BUMP (Stronger spring effect) */
  .bump { animation: bump 0.15s cubic-bezier(0.34, 1.56, 0.64, 1) !important; }
  @keyframes bump { 
    0% { transform: scale(1); } 
    50% { transform: scale(0.95); } /* Deep spring */ 
    100% { transform: scale(1); } 
  }

  .prod-info { flex: 1; z-index: 2; display: flex; flex-direction: column; gap: 3px; }
  .prod-name { font-size: 15px; font-weight: 600; color: #fff; line-height: 1.3; }
  .prod-meta { font-size: 12px; color: rgba(255,255,255,0.5); font-weight: 500; letter-spacing: 0.2px; }
  
  /* --- CHECKBOX --- */
  .check-square {
    width: 22px; height: 22px; border-radius: 6px;
    border: 2px solid rgba(255,255,255,.65);
    display: inline-flex; align-items: center; justify-content: center;
    flex-shrink: 0; transition: all .2s ease; background: transparent;
  }
  .check-square::after {
    content: ""; width: 12px; height: 12px; border-radius: 3px;
    background: #fff; opacity: 0; transform: scale(.7); transition: all .2s ease;
  }
  
  /* Checkbox Animation on Select */
  .product-row.selected .check-square {
    background: linear-gradient(135deg, var(--okA), var(--okB)); border-color: var(--okB);
    transform: scale(1.05); /* Slight pop */
  }
  .product-row.selected .check-square::after { opacity: 1; transform: scale(1); }

  /* --- FLOATING SAVE BUTTON --- */
  .save-floater { position: absolute; bottom: 34px; left: 0; right: 0; display: flex; justify-content: center; z-index: 30; pointer-events: none; }
  
  .btn-save {
    pointer-events: auto; background: linear-gradient(135deg, var(--okA), var(--okB));
    color: #fff; border: none; height: auto; min-width: 160px; padding: 14px 28px;
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', Roboto, sans-serif;
    font-size: 16px; font-weight: 900; border-radius: 14px;
    box-shadow: 0 8px 32px rgba(10, 132, 255, 0.4); -webkit-font-smoothing: antialiased;
    
    cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
    transition: opacity 0.2s;
    transform: translateY(100px); opacity: 0;
    will-change: transform;
  }
  .btn-save.visible { transform: translateY(0); opacity: 1; }
  
  .btn-save:active { filter: saturate(0.9); } 

  /* --- EMPTY STATE --- */
  .empty-state {
    display: flex; flex-direction: column; align-items: center;
    margin-top: 60px; color: var(--text-muted); padding: 20px;
    background: var(--surface-dark); border-radius: 24px;
    border: 1px solid var(--surface-border); backdrop-filter: blur(10px);
  }
  .empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.6; }

</style>
</head>
<body>

<div class="fx-layer">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="noise"></div>
</div>

<div class="app-header">
  <div class="search-box">
    <div class="search-icon">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    </div>
    <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤..." id="searchInput">
    <div class="search-clear" id="searchClear">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </div>
  </div>
</div>

<div class="views-container">
  
  <div class="view active" id="view-cats">
    <div class="cat-grid" id="catGrid"></div>
  </div>

  <div class="view" id="view-list">
    <div class="list-header-area">
      <h2 class="list-title" id="catTitle">–ù–∞–∑–≤–∞–Ω–∏–µ</h2>
      <button class="btn-select-all" id="btnSelectAll">–í—ã–±—Ä–∞—Ç—å –≤—Å—ë</button>
    </div>
    <div class="product-list-container" id="productList"></div>
  </div>

  <div class="view" id="view-search">
    <div class="product-list-container" id="searchResults" style="display:none; background:transparent!important; border:none!important; box-shadow:none!important; backdrop-filter:none!important;"></div>
  </div>

</div>

<div class="save-floater">
  <button class="btn-save" id="btnSave" onclick="saveSelection()">
    <span id="saveBtnText">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
  </button>
</div>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.ready();
    tg.expand();
    try {
        tg.setHeaderColor('#050505');
        tg.setBackgroundColor('#050505');
    } catch(e){}
    
    tg.BackButton.onClick(() => {
      if (state.searchMode) {
        exitSearchMode();
      } else if (state.activeCatId) {
        goBack();
      } else {
        window.location.href = 'router.html'; 
      }
    });
  }

  const DB = [
    { 
      id: 'c1', name: '–ë–µ–ª–∫–∏', icon: 'ü•©', 
      items: [
        { id: 'p1', name: '–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞', meta: '113 –∫–∫–∞–ª ¬∑ 24–ë ¬∑ 2–ñ ¬∑ 0–£' },
        { id: 'p2', name: '–ò–Ω–¥–µ–π–∫–∞ —Ñ–∏–ª–µ', meta: '115 –∫–∫–∞–ª ¬∑ 24–ë ¬∑ 1–ñ ¬∑ 0–£' },
        { id: 'p3', name: '–ì–æ–≤—è–¥–∏–Ω–∞ –ø–æ—Å—Ç–Ω–∞—è', meta: '180 –∫–∫–∞–ª ¬∑ 20–ë ¬∑ 10–ñ ¬∑ 0–£' },
        { id: 'p4', name: '–Ø–π—Ü–æ –∫—É—Ä–∏–Ω–æ–µ (C0)', meta: '86 –∫–∫–∞–ª ¬∑ 7–ë ¬∑ 6–ñ ¬∑ 0.5–£' },
        { id: 'p5', name: '–¢–≤–æ—Ä–æ–≥ 5%', meta: '121 –∫–∫–∞–ª ¬∑ 16–ë ¬∑ 5–ñ ¬∑ 3–£' },
        { id: 'p6', name: '–õ–æ—Å–æ—Å—å', meta: '208 –∫–∫–∞–ª ¬∑ 20–ë ¬∑ 13–ñ ¬∑ 0–£' },
        { id: 'p7', name: '–¢—É–Ω–µ—Ü (–∫–æ–Ω—Å.)', meta: '100 –∫–∫–∞–ª ¬∑ 23–ë ¬∑ 1–ñ ¬∑ 0–£' },
      ]
    },
    { 
      id: 'c2', name: '–ö—Ä—É–ø—ã', icon: 'üçö', 
      items: [
        { id: 'p9', name: '–ì—Ä–µ—á–∫–∞ (—Å—É—Ö–∞—è)', meta: '313 –∫–∫–∞–ª ¬∑ 12–ë ¬∑ 3–ñ ¬∑ 62–£' },
        { id: 'p10', name: '–†–∏—Å –ë–∞—Å–º–∞—Ç–∏', meta: '350 –∫–∫–∞–ª ¬∑ 7–ë ¬∑ 1–ñ ¬∑ 78–£' },
        { id: 'p11', name: '–û–≤—Å—è–Ω–∫–∞', meta: '360 –∫–∫–∞–ª ¬∑ 12–ë ¬∑ 6–ñ ¬∑ 65–£' },
        { id: 'p12', name: '–ú–∞–∫–∞—Ä–æ–Ω—ã —Ç–≤/—Å', meta: '340 –∫–∫–∞–ª ¬∑ 11–ë ¬∑ 1–ñ ¬∑ 70–£' },
        { id: 'p13', name: '–ö–∏–Ω–æ–∞', meta: '368 –∫–∫–∞–ª ¬∑ 14–ë ¬∑ 6–ñ ¬∑ 64–£' },
      ]
    },
    { 
      id: 'c3', name: '–û–≤–æ—â–∏', icon: 'ü•¶', 
      items: [
        { id: 'p15', name: '–û–≥—É—Ä—Ü—ã', meta: '15 –∫–∫–∞–ª ¬∑ 0.8–ë ¬∑ 0–ñ ¬∑ 3–£' },
        { id: 'p16', name: '–ü–æ–º–∏–¥–æ—Ä—ã', meta: '20 –∫–∫–∞–ª ¬∑ 1–ë ¬∑ 0–ñ ¬∑ 4–£' },
        { id: 'p17', name: '–ë—Ä–æ–∫–∫–æ–ª–∏', meta: '34 –∫–∫–∞–ª ¬∑ 3–ë ¬∑ 0.4–ñ ¬∑ 7–£' },
        { id: 'p18', name: '–®–ø–∏–Ω–∞—Ç', meta: '23 –∫–∫–∞–ª ¬∑ 2.9–ë ¬∑ 0.4–ñ ¬∑ 3.6–£' },
      ]
    },
    {
      id: 'c4', name: '–§—Ä—É–∫—Ç—ã', icon: 'üçé',
      items: [
        { id: 'p21', name: '–Ø–±–ª–æ–∫–æ', meta: '47 –∫–∫–∞–ª ¬∑ 0.4–ë ¬∑ 0–ñ ¬∑ 10–£' },
        { id: 'p22', name: '–ë–∞–Ω–∞–Ω', meta: '89 –∫–∫–∞–ª ¬∑ 1–ë ¬∑ 0–ñ ¬∑ 23–£' },
        { id: 'p23', name: '–ê–ø–µ–ª—å—Å–∏–Ω', meta: '43 –∫–∫–∞–ª ¬∑ 0.9–ë ¬∑ 0.2–ñ ¬∑ 8–£' },
      ]
    },
    {
      id: 'c5', name: '–ñ–∏—Ä—ã', icon: 'ü•ë',
      items: [
        { id: 'p25', name: '–û–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ', meta: '884 –∫–∫–∞–ª ¬∑ 0–ë ¬∑ 100–ñ ¬∑ 0–£' },
        { id: 'p26', name: '–ê–≤–æ–∫–∞–¥–æ', meta: '160 –∫–∫–∞–ª ¬∑ 2–ë ¬∑ 15–ñ ¬∑ 9–£' },
      ]
    },
    {
      id: 'c6', name: '–°–Ω–µ–∫–∏', icon: 'üç´',
      items: [
        { id: 'p30', name: '–ü—Ä–æ—Ç–µ–∏–Ω–æ–≤—ã–π –±–∞—Ç–æ–Ω—á–∏–∫', meta: '200 –∫–∫–∞–ª ¬∑ 20–ë ¬∑ 8–ñ ¬∑ 10–£' },
        { id: 'p31', name: '–•–ª–µ–±—Ü—ã', meta: '300 –∫–∫–∞–ª ¬∑ 10–ë ¬∑ 2–ñ ¬∑ 60–£' },
      ]
    }
  ];

  const state = {
    selected: new Set(),
    activeCatId: null,
    searchMode: false
  };

  const el = {
    catGrid: document.getElementById('catGrid'),
    productList: document.getElementById('productList'),
    viewCats: document.getElementById('view-cats'),
    viewList: document.getElementById('view-list'),
    viewSearch: document.getElementById('view-search'),
    catTitle: document.getElementById('catTitle'),
    btnSelectAll: document.getElementById('btnSelectAll'),
    searchInput: document.getElementById('searchInput'),
    searchClear: document.getElementById('searchClear'),
    searchResults: document.getElementById('searchResults'),
    btnSave: document.getElementById('btnSave'),
    saveBtnText: document.getElementById('saveBtnText')
  };

  function haptic(type = 'light') {
    try {
      const tg = window.Telegram?.WebApp?.HapticFeedback;
      if (!tg) return;
      if (type === 'light') tg.impactOccurred('light');
      if (type === 'medium') tg.impactOccurred('medium');
      if (type === 'heavy') tg.impactOccurred('heavy');
      if (type === 'success') tg.notificationOccurred('success');
      if (type === 'changed') tg.selectionChanged();
    } catch(e) {}
  }

  // --- ANIMATION LOGIC (SPRING EFFECT) ---
  const bump = el => { 
    if(!el) return; 
    el.classList.remove('bump'); 
    void el.offsetWidth; // force reflow
    el.classList.add('bump'); 
  };

  // üî• GLOBAL LISTENER FOR TOUCHSTART (Backup if event propagation fails)
  document.addEventListener('touchstart', (e) => {
    const el = e.target.closest('.cat-card, .btn-save');
    if (!el) return;
    haptic('light'); 
    bump(el);
  }, {passive: true});


  function init() {
    ['p1', 'p2', 'p15'].forEach(id => state.selected.add(id));
    
    renderCategories();
    updateSaveButton();
    
    el.searchInput.addEventListener('input', handleSearch);
    el.searchClear.addEventListener('click', clearSearch);
    
    if(tg) tg.BackButton.show();
  }

  function renderCategories() {
    el.catGrid.innerHTML = '';
    DB.forEach(cat => {
      const totalItems = cat.items.length;
      const selectedItems = cat.items.filter(i => state.selected.has(i.id)).length;
      const progress = (selectedItems / totalItems) * 100;
      
      const card = document.createElement('div');
      card.className = 'cat-card';
      // Click navigation
      card.onclick = () => openCategory(cat.id);
      
      card.innerHTML = `
        <div>
          <div class="cat-icon">${cat.icon}</div>
          <div class="cat-name">${cat.name}</div>
          <div class="cat-meta">${selectedItems} –∏–∑ ${totalItems}</div>
        </div>
        <div class="cat-progress-track">
          <div class="cat-progress-fill" style="width: ${progress}%"></div>
        </div>
      `;
      el.catGrid.appendChild(card);
    });
  }

  function openCategory(id) {
    state.activeCatId = id;
    const cat = DB.find(c => c.id === id);
    
    el.catTitle.textContent = cat.name;
    el.productList.style.display = 'flex';
    renderProductList(cat.items, el.productList);
    updateSelectAllBtn(cat);

    el.viewCats.classList.add('prev');
    el.viewCats.classList.remove('active');
    el.viewList.classList.add('active');
    el.viewList.classList.remove('next');
    
    if(tg) tg.BackButton.show();
  }

  function goBack() {
    state.activeCatId = null;
    
    el.viewList.classList.remove('active');
    el.viewCats.classList.add('active');
    el.viewCats.classList.remove('prev');
    
    setTimeout(renderCategories, 300); 
    
    if(tg) tg.BackButton.show(); 
  }

  function renderProductList(items, container, isSearch = false) {
    container.innerHTML = '';
    
    if (isSearch) {
        container.style.background = 'transparent';
        container.style.border = 'none';
        container.style.boxShadow = 'none';
    } else {
        container.style = ""; 
    }

    if (items.length === 0 && isSearch) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üîç</div><div>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div></div>';
        return;
    }

    let targetContainer = container;
    if (isSearch) {
        const wrapper = document.createElement('div');
        wrapper.className = 'product-list-container';
        container.appendChild(wrapper);
        targetContainer = wrapper;
    }

    items.forEach((item, index) => {
      const isSel = state.selected.has(item.id);
      const row = document.createElement('div');
      row.className = `product-row ${isSel ? 'selected' : ''}`;
      
      // üî• ATTACH TOUCHSTART DIRECTLY TO ELEMENT FOR INSTANT IOS RESPONSE
      row.addEventListener('touchstart', function() {
          haptic('light');
          bump(this);
      }, {passive: true});

      // Toggle logic on click (after bump)
      row.onclick = () => toggleProduct(item.id, row);
      
      if (!isSearch) {
        row.style.animation = `fadeInUp 0.2s ease forwards ${index * 0.02}s`;
        row.style.opacity = '0';
        row.style.transform = 'translateY(5px)';
      }
      
      // LEFT SIDE CHECKBOX
      row.innerHTML = `
        <div class="check-square"></div>
        <div class="prod-info">
          <div class="prod-name">${item.name}</div>
          <div class="prod-meta">${item.meta}</div>
        </div>
      `;
      targetContainer.appendChild(row);
    });
  }

  const styleSheet = document.createElement("style");
  styleSheet.innerText = `@keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }`;
  document.head.appendChild(styleSheet);

  function toggleProduct(id, rowEl) {
    if (state.selected.has(id)) {
      state.selected.delete(id);
      rowEl.classList.remove('selected');
    } else {
      state.selected.add(id);
      rowEl.classList.add('selected');
    }
    
    updateSaveButton();
    
    if (state.activeCatId && !state.searchMode) {
        const cat = DB.find(c => c.id === state.activeCatId);
        updateSelectAllBtn(cat);
    }
  }

  function updateSaveButton() {
    const count = state.selected.size;
    if (count > 0) {
      el.btnSave.classList.add('visible');
      el.saveBtnText.textContent = `–°–æ—Ö—Ä–∞–Ω–∏—Ç—å (${count})`;
    } else {
      el.btnSave.classList.remove('visible');
    }
  }

  function updateSelectAllBtn(cat) {
    const allSelected = cat.items.every(i => state.selected.has(i.id));
    el.btnSelectAll.textContent = allSelected ? '–°–Ω—è—Ç—å –≤—Å—ë' : '–í—ã–±—Ä–∞—Ç—å –≤—Å—ë';
    
    el.btnSelectAll.onclick = () => toggleAllInCategory(cat, !allSelected);
  }

  function toggleAllInCategory(cat, select) {
    haptic('medium');
    cat.items.forEach(i => {
      if (select) state.selected.add(i.id);
      else state.selected.delete(i.id);
    });
    renderProductList(cat.items, el.productList);
    updateSelectAllBtn(cat);
    updateSaveButton();
  }

  function handleSearch(e) {
    const query = e.target.value.toLowerCase().trim();
    if (query.length > 0) {
      if (!state.searchMode) enterSearchMode();
      
      let results = [];
      DB.forEach(cat => {
        const matches = cat.items.filter(i => i.name.toLowerCase().includes(query));
        results = [...results, ...matches];
      });
      
      renderProductList(results, el.searchResults, true);
      el.searchResults.style.display = 'block';
      
    } else {
      el.searchResults.innerHTML = '';
    }
  }

  function enterSearchMode() {
    state.searchMode = true;
    el.viewCats.classList.remove('active');
    el.viewList.classList.remove('active');
    el.viewSearch.classList.add('active');
    if(tg) tg.BackButton.show();
  }

  function exitSearchMode() {
    state.searchMode = false;
    el.viewSearch.classList.remove('active');
    el.searchResults.style.display = 'none';
    el.searchInput.value = '';
    
    if (state.activeCatId) {
      el.viewList.classList.add('active');
    } else {
      el.viewCats.classList.add('active');
      renderCategories();
      if(tg) tg.BackButton.show(); 
    }
  }

  function clearSearch() {
    exitSearchMode();
  }

  function saveSelection() {
    // Haptic/Bump handled by touchstart on button
    
    if (tg && tg.showPopup) {
       tg.showPopup({
          title: '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ',
          message: `–í—ã–±—Ä–∞–Ω–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤: ${state.selected.size}`,
          buttons: [{type: 'ok'}]
       }, function() {
           if (state.searchMode) exitSearchMode();
           if (state.activeCatId) goBack();
       });
    } else {
       alert(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${state.selected.size} –ø—Ä–æ–¥—É–∫—Ç–æ–≤!`);
       if (state.searchMode) exitSearchMode();
       if (state.activeCatId) goBack();
    }
  }

  init();

</script>
</body>
</html>
