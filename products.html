<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Ultima Market</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
  /* ==================== 1. CORE VARIABLES & RESET ==================== */
  :root {
    --bg: #050505; --text: #fff; --text-m: rgba(255,255,255,0.55);
    --glass: rgba(255,255,255,0.07); --dark: rgba(0,0,0,0.3);
    --border: rgba(255,255,255,0.1); --border-l: rgba(255,255,255,0.2);
    --blue: #0a84ff; --green: #30d158; --grad-a: #4facfe; --grad-b: #0a84ff;
    --r-xl: 28px; --r-l: 24px; --pad: 16px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  html, body, button { touch-action: manipulation; }
  body {
    background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif;
    height: 100vh; overflow: hidden; display: flex; flex-direction: column;
  }

  /* ==================== 2. FX LAYER (BACKGROUND) ==================== */
  .fx { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
  .orb { position: absolute; border-radius: 50%; animation: float 30s linear infinite; }
  .orb-1 { width: 90vw; height: 90vw; opacity: 0.4; background: radial-gradient(circle, #6c5ce7, transparent 70%); top: -20%; left: -20%; }
  .orb-2 { width: 400px; height: 400px; opacity: 0.5; background: radial-gradient(circle, #6c5ce7, transparent 70%); bottom: -150px; right: -100px; animation: breathe 6s ease-in-out infinite; }
  .noise { position: fixed; inset: 0; opacity: 0.04; background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); }
  @keyframes float { 0% {transform:rotate(0deg)} 100% {transform:rotate(360deg)} }
  @keyframes breathe { 0%,100% {transform:scale(1);opacity:.4} 50% {transform:scale(1.1);opacity:.6} }
  .bump { animation: bump .15s cubic-bezier(.34,1.56,.64,1); }
  @keyframes bump { 0% {transform:scale(1)} 50% {transform:scale(.95)} 100% {transform:scale(1)} }
  @keyframes fadeUp { to {opacity:1; transform:translateY(0)} }

  /* ==================== 3. LAYOUT & VIEWS ==================== */
  .head { position: relative; z-index: 10; padding: 12px var(--pad) 4px; flex-shrink: 0; }
  .view-wrap { position: relative; flex: 1; overflow: hidden; z-index: 1; }
  .view {
    position: absolute; inset: 0; overflow-y: auto; padding: 12px var(--pad) 140px;
    transition: .3s cubic-bezier(.2,.8,.2,1); opacity: 0; pointer-events: none; transform: translateX(30px);
    -webkit-overflow-scrolling: touch;
  }
  .view.active { opacity: 1; pointer-events: auto; transform: translateX(0); }
  .view.prev { transform: translateX(-10%) scale(.98); opacity: 0; }

  /* ==================== 4. COMPONENTS ==================== */
  /* --- Search --- */
  .s-box { position: relative; }
  .s-inp {
    width: 100%; height: 40px; background: var(--dark); border: 1px solid var(--border);
    border-radius: 14px; padding: 0 36px 0 40px; color: #fff; font-size: 16px;
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); transition: .2s;
  }
  .s-inp:focus { background: rgba(0,0,0,.5); border-color: rgba(255,255,255,.25); outline: none; }
  .s-icon { position: absolute; left: 12px; top: 11px; color: rgba(255,255,255,.4); pointer-events: none; }
  .s-clear { position: absolute; right: 0; top: 0; height: 100%; width: 36px; display: flex; align-items: center; justify-content: center; opacity: 0; transition: .2s; }
  .s-inp:not(:placeholder-shown) ~ .s-clear { opacity: 1; }

  /* --- Categories --- */
  .cat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .cat-card {
    background: var(--dark); border: 1px solid var(--border); border-radius: var(--r-l);
    padding: 14px; min-height: 110px; display: flex; flex-direction: column; justify-content: space-between;
    position: relative; overflow: hidden; backdrop-filter: blur(20px); transition: .2s;
  }
  .cat-card:active { background: rgba(0,0,0,.4); }
  .c-ico { font-size: 24px; margin-bottom: 10px; }
  .c-name { font-size: 14px; font-weight: 700; margin-bottom: 2px; }
  .c-meta { font-size: 12px; color: var(--text-m); }
  .c-prog { position: absolute; bottom: 0; left: 0; height: 3px; background: rgba(255,255,255,.05); width: 100%; }
  .c-fill { height: 100%; background: var(--blue); width: 0%; transition: width .4s ease; }

  /* --- Product List --- */
  .list-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .l-title { font-size: 20px; font-weight: 800; }
  .btn-all { color: var(--blue); font-weight: 600; background: none; border: none; padding: 6px; }
  
  .prod-cont {
    background: linear-gradient(165deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    border: 1px solid var(--border); padding: 14px; border-radius: 20px;
    display: flex; flex-direction: column; gap: 8px; backdrop-filter: blur(10px);
  }
  .p-row {
    display: flex; align-items: center; gap: 12px; padding: 12px 14px; border-radius: 12px;
    transition: .15s; opacity: 0; transform: translateY(10px); /* Animation start */
  }
  .p-row:active { background: rgba(255,255,255,.05); }
  
  .chk {
    width: 22px; height: 22px; border-radius: 6px; border: 2px solid rgba(255,255,255,.65);
    display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: .2s;
  }
  .chk::after { content: ""; width: 12px; height: 12px; background: #fff; border-radius: 3px; transform: scale(0); transition: .2s; }
  .p-row.sel .chk { background: linear-gradient(135deg, var(--grad-a), var(--grad-b)); border-color: var(--grad-b); }
  .p-row.sel .chk::after { transform: scale(1); }

  /* --- Save Button --- */
  .float-act { position: absolute; bottom: 34px; left: 0; right: 0; display: flex; justify-content: center; z-index: 30; pointer-events: none; }
  .btn-save {
    pointer-events: auto; background: linear-gradient(135deg, var(--grad-a), var(--grad-b));
    color: #fff; border: none; padding: 14px 28px; border-radius: 14px;
    font-size: 16px; font-weight: 900; box-shadow: 0 8px 32px rgba(10,132,255,.4);
    transform: translateY(100px); opacity: 0; transition: .2s;
  }
  .btn-save.show { transform: translateY(0); opacity: 1; }
  
  /* --- Misc --- */
  .empty { text-align: center; padding: 40px; color: var(--text-m); background: var(--dark); border-radius: 24px; border: 1px solid var(--border); }
  #sentinel { height: 20px; }
</style>
</head>
<body>

<div class="fx"><div class="orb orb-1"></div><div class="orb orb-2"></div><div class="noise"></div></div>

<div class="head">
  <div class="s-box">
    <div class="s-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35" stroke-linecap="round"/></svg></div>
    <input type="text" class="s-inp" placeholder="–ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤..." id="sInput">
    <div class="s-clear" id="sClear"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M18 6L6 18M6 6l12 12"/></svg></div>
  </div>
</div>

<div class="view-wrap">
  <div class="view active" id="v-cats"><div class="cat-grid" id="catGrid"></div></div>
  <div class="view" id="v-list">
    <div class="list-head"><div class="l-title" id="lTitle">...</div><button class="btn-all" id="btnAll">–í—ã–±—Ä–∞—Ç—å –≤—Å—ë</button></div>
    <div class="prod-cont" id="pList"></div><div id="sentinel"></div>
  </div>
  <div class="view" id="v-search"><div class="prod-cont" id="sRes" style="background:none;border:none;box-shadow:none;"></div></div>
</div>

<div class="float-act"><button class="btn-save" id="btnSave" onclick="App.save()"><span id="txtSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span></button></div>

<script>
  /* ==================== 1. CONFIG & UTILS ==================== */
  const tg = window.Telegram?.WebApp;
  
  const cfg = {
    // üëáüëáüëá –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ô URL GAS üëáüëáüëá
    api: "https://script.google.com/macros/s/AKfycbybxqI4xOLAUOcMXGReNl0PVjGToGg6_x3ZxlKNnUHg3XcaZGhkbsu61Adgkb4emrkm/exec", 
    // üëÜüëÜüëÜ ----------------------- üëÜüëÜüëÜ
    
    batch: 20,
    anim: 'fadeUp .2s ease forwards'
  };
  
  const Utils = {
    wait: ms => new Promise(r => setTimeout(r, ms)),
    bump: el => { el.classList.remove('bump'); void el.offsetWidth; el.classList.add('bump'); },
    haptic: (t='light') => tg?.HapticFeedback?.[t==='success'?'notificationOccurred':'impactOccurred'](t==='success'?'success':t),
    cache: { 
      get: k => JSON.parse(localStorage.getItem(k)||'null'), 
      set: (k,v) => localStorage.setItem(k, JSON.stringify(v)) 
    }
  };

  /* ==================== 2. DATA LAYER (GAS CONNECTED) ==================== */
  const Data = {
    cats: [], pMap: {}, ver: 0,

    init: async function() {
      // 1. –ì—Ä—É–∑–∏–º –∏–∑ –ø–∞–º—è—Ç–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (—á—Ç–æ–±—ã –±—ã–ª–æ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ)
      const local = Utils.cache.get('ultima_data_v2');
      if(local) { 
        this.cats = local.cats; 
        this.pMap = local.map; 
        this.ver = local.ver || 0;
        Render.cats(); // –†–∏—Å—É–µ–º —Å—Ä–∞–∑—É
      }

      // 2. –ò–¥–µ–º –≤ Google –¢–∞–±–ª–∏—Ü—É –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏
      try {
        const authData = tg?.initData || ''; 
        
        const res = await fetch(cfg.api, {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded'},
          body: JSON.stringify({ action: 'init', clientVer: this.ver, initData: authData })
        });
        
        const ans = await res.json();
        
        if (ans.ok) {
          // –ï—Å–ª–∏ –µ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞
          if (ans.needUpdate && ans.catalog) {
            this.processCatalog(ans.catalog);
            this.ver = ans.serverVer;
            Utils.cache.set('ultima_data_v2', { cats: this.cats, map: this.pMap, ver: this.ver });
            Render.cats(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
          }
          
          // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞ (–µ—Å–ª–∏ —é–∑–µ—Ä –≤—ã–±—Ä–∞–ª —á—Ç–æ-—Ç–æ —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)
          if (ans.userSelection) {
            State.mergeSelection(ans.userSelection);
          }
        }
      } catch(e) { 
        console.log('Offline / Error', e);
        if(!this.cats.length) document.getElementById('catGrid').innerHTML = '<div class="empty">–ù–µ—Ç —Å–≤—è–∑–∏ :(</div>';
      }
    },

    // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –º–∞—Å—Å–∏–≤ –º–∞—Å—Å–∏–≤–æ–≤ (–¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç—Ä–∞—Ñ–∏–∫–∞) –≤ —É–¥–æ–±–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
    processCatalog: function(raw) {
      this.cats = raw.categories;
      this.pMap = {};
      
      // raw.products —ç—Ç–æ –º–∞—Å—Å–∏–≤: [id, catId, name, meta]
      raw.products.forEach(p => {
        const [id, catId, name, meta] = p;
        if (!this.pMap[catId]) this.pMap[catId] = [];
        this.pMap[catId].push({ id, name, meta });
      });
    },

    get: cid => this.pMap[cid] || [],
    
    // –ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    search: q => {
      const all = Object.values(this.pMap).flat();
      return all.filter(p => p.name.toLowerCase().includes(q));
    },

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Google –¢–∞–±–ª–∏—Ü—É
    sendSave: async (ids) => {
      return fetch(cfg.api, {
        method: 'POST',
        headers: {'Content-Type': 'text/plain;charset=utf-8'},
        body: JSON.stringify({
          action: 'save',
          initData: tg?.initData || '',
          selection: JSON.stringify({ ids: ids })
        })
      });
    }
  };

  /* ==================== 3. STATE & ELEMENTS ==================== */
  const el = {
    grid: document.getElementById('catGrid'), list: document.getElementById('pList'),
    sRes: document.getElementById('sRes'), sInp: document.getElementById('sInput'),
    sClear: document.getElementById('sClear'), title: document.getElementById('lTitle'),
    bSave: document.getElementById('btnSave'), tSave: document.getElementById('txtSave'),
    bAll: document.getElementById('btnAll'), sent: document.getElementById('sentinel'),
    views: { cats: document.getElementById('v-cats'), list: document.getElementById('v-list'), search: document.getElementById('v-search') }
  };

  const State = {
    sel: new Set(), activeCat: null, search: false, q: [], idx: 0, cont: null,
    
    load: () => {
      // –ì—Ä—É–∑–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä, –ø–æ–∫–∞ –∂–¥–µ–º –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
      State.sel = new Set(Utils.cache.get('ultima_sel_v2') || []);
    },
    
    saveLocal: () => Utils.cache.set('ultima_sel_v2', [...State.sel]),
    
    // –û–±—ä–µ–¥–∏–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –∏ —Ç–æ, —á—Ç–æ –ø—Ä–∏—à–ª–æ —Å —Å–µ—Ä–≤–µ—Ä–∞
    mergeSelection: (serverJson) => {
      try {
        const obj = JSON.parse(serverJson);
        const ids = Array.isArray(obj) ? obj : (obj.ids || []);
        State.sel = new Set(ids);
        State.saveLocal();
        Render.ui();
      } catch(e) {}
    }
  };

  /* ==================== 4. RENDERERS ==================== */
  const Render = {
    cats: () => {
      if(!Data.cats.length) return;
      el.grid.innerHTML = Data.cats.map(c => {
        const prods = Data.get(c.id), total = prods.length;
        const sel = prods.filter(p => State.sel.has(p.id)).length;
        const pct = total ? (sel/total)*100 : 0;
        return `
        <div class="cat-card" onclick="App.openCat('${c.id}')">
          <div><div class="c-ico">${c.icon}</div><div class="c-name">${c.name}</div><div class="c-meta">${sel}/${total}</div></div>
          <div class="c-prog"><div class="c-fill" style="width:${pct}%"></div></div>
        </div>`;
      }).join('');
    },
    
    list: (items, cont, reset=true) => {
      if(reset) { 
        cont.innerHTML = items.length ? '' : '<div class="empty">–ù–∏—á–µ–≥–æ –Ω–µ—Ç</div>'; 
        State.q = items; State.idx = 0; State.cont = cont; 
      }
      const batch = State.q.slice(State.idx, State.idx + cfg.batch);
      if(!batch.length) return;
      
      const frag = document.createDocumentFragment();
      batch.forEach((p, i) => {
        const d = document.createElement('div');
        d.className = `p-row ${State.sel.has(p.id)?'sel':''}`;
        d.onclick = () => App.toggle(p.id, d);
        if(reset) d.style.animation = `${cfg.anim} ${i*0.02}s`; else d.style.opacity = 1;
        d.innerHTML = `<div class="chk"></div><div><div class="c-name">${p.name}</div><div class="c-meta">${p.meta}</div></div>`;
        frag.appendChild(d);
      });
      cont.appendChild(frag);
      State.idx += cfg.batch;
    },

    ui: () => {
      const count = State.sel.size;
      const inCat = State.activeCat && !State.search;
      
      let txt = inCat ? (count ? `–í—ã–±—Ä–∞—Ç—å (${count})` : '–ù–∞–∑–∞–¥') : `–°–æ—Ö—Ä–∞–Ω–∏—Ç—å (${count})`;
      if(inCat && count === 0) txt = '–ù–∞–∑–∞–¥';
      
      el.tSave.innerText = txt;
      el.bSave.classList.toggle('show', inCat || count > 0);
      
      if(inCat) {
        const all = Data.get(State.activeCat);
        const isAll = all.length && all.every(p => State.sel.has(p.id));
        el.bAll.innerText = isAll ? '–°–Ω—è—Ç—å –≤—Å—ë' : '–í—ã–±—Ä–∞—Ç—å –≤—Å—ë';
        el.bAll.onclick = () => App.toggleAll(all, !isAll);
      }
      
      if(!inCat && !State.search) Render.cats();
    }
  };

  /* ==================== 5. APP LOGIC ==================== */
  const App = {
    init: () => {
      tg?.ready(); tg?.expand(); tg?.BackButton.onClick(App.back);
      State.load(); 
      Data.init(); // <- –í—ã–∑–æ–≤ GAS
      Render.ui();
      
      new IntersectionObserver(e => e[0].isIntersecting && Render.list([], State.cont, false))
        .observe(el.sent);
      
      el.sInp.oninput = e => {
        const v = e.target.value.trim().toLowerCase();
        if(!v) return App.back();
        if(!State.search) { State.search=true; App.view('search'); tg?.BackButton.show(); }
        Render.list(Data.search(v), el.sRes);
      };
      el.sClear.onclick = () => { el.sInp.value=''; App.back(); };
    },

    openCat: id => {
      State.activeCat = id;
      const c = Data.cats.find(x => x.id == id);
      el.title.innerText = c.name;
      Render.list(Data.get(id), el.list);
      App.view('list'); tg?.BackButton.show(); Render.ui();
    },

    toggle: (id, node) => {
      Utils.haptic(); Utils.bump(node);
      State.sel.has(id) ? State.sel.delete(id) : State.sel.add(id);
      node.classList.toggle('sel'); 
      State.saveLocal(); 
      Render.ui();
    },

    toggleAll: (items, add) => {
      items.forEach(p => add ? State.sel.add(p.id) : State.sel.delete(p.id));
      State.saveLocal(); Render.list(items, el.list); Render.ui();
    },

    back: () => {
      if(State.search) { 
        State.search=false; el.sInp.value=''; el.sRes.innerHTML=''; 
        App.view(State.activeCat?'list':'cats'); 
      }
      else if(State.activeCat) { 
        State.activeCat=null; App.view('cats'); Render.cats(); tg?.BackButton.hide(); 
      }
      Render.ui();
    },

    view: v => {
      Object.values(el.views).forEach(x => x.classList.remove('active','prev'));
      el.views[v].classList.add('active');
      if(v==='list') el.views.cats.classList.add('prev');
    },

    save: async () => {
      Utils.haptic('success');
      if(State.activeCat && !State.search) return App.back();
      
      const originalText = el.tSave.innerText;
      el.tSave.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";
      
      try {
        await Data.sendSave(Array.from(State.sel));
        if(tg && tg.close) tg.close();
      } catch(e) {
        el.tSave.innerText = "–û—à–∏–±–∫–∞ :(";
        setTimeout(() => el.tSave.innerText = originalText, 2000);
      }
    }
  };

  // üî• BOOT
  App.init();
</script>
</body>
</html>
