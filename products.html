<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>–í—ã–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤ Ultima</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root {
    /* --- PALETTE (Copy from KBJU) --- */
    --bg-core: #050505;
    --text-main: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.55);
    
    /* --- GLASS SURFACES (Copy from KBJU .macro-card) --- */
    --surface-glass: rgba(0, 0, 0, 0.3);
    --surface-border: rgba(255, 255, 255, 0.1);
    --surface-highlight: rgba(255, 255, 255, 0.2);
    
    /* --- ACCENTS --- */
    --acc-orange: #ff9f0a;
    --acc-green: #30d158;
    --acc-blue: #0a84ff;
    --acc-red: #ff453a;
    --acc-purple: #5e60ce;

    /* --- METRICS --- */
    --radius-xl: 28px; /* –ö–∞–∫ –≤ KBJU */
    --radius-l: 22px;
    --radius-m: 16px;
    --pad: 16px;
    --gap: 12px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  
  body {
    background-color: var(--bg-core) !important;
    color: var(--text-main);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', Roboto, sans-serif;
    height: 100vh;
    overflow: hidden; 
    display: flex;
    flex-direction: column;
  }

  /* --- FX LAYER (Exact Copy from KBJU) --- */
  .fx-layer { position: fixed; inset: 0; z-index: 0; pointer-events: none; transform: translate3d(0,0,0); }
  .orb { position: absolute; border-radius: 50%; will-change: transform; animation: float 30s infinite linear; }
  
  /* Orb 1: –í–µ—Ä—Ö–Ω–∏–π –ª–µ–≤—ã–π */
  .orb-1 { 
    width: 90vw; height: 90vw; 
    opacity: 0.4; 
    background: radial-gradient(circle, rgba(108, 92, 231, 0.8) 0%, transparent 70%); 
    top: -20%; left: -20%; 
  }
  
  /* Orb 2: –ù–∏–∂–Ω–∏–π –ø—Ä–∞–≤—ã–π */
  .orb-2 { 
    width: 400px; height: 400px; 
    opacity: 0.5; 
    background: radial-gradient(circle, rgba(108, 92, 231, 0.8) 0%, transparent 70%); 
    bottom: -150px; right: -100px; 
    animation: breathe 6s infinite ease-in-out; 
  }

  .noise { 
    position: fixed; inset: 0; z-index: 0; opacity: 0.04; 
    background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); 
    pointer-events: none; 
  }

  @keyframes float { 0% {transform:rotate(0deg)} 100% {transform:rotate(360deg)} }
  @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.4; } 50% { transform: scale(1.1); opacity: 0.6; } }

  /* --- LAYOUT --- */
  .app-header {
    position: relative; z-index: 10;
    padding: 12px var(--pad) 0;
    background: transparent;
    flex-shrink: 0;
  }

  /* Search Bar - –°—Ç–∏–ª—å –∫–∞–∫ –≤ KBJU –ø–æ–ª—è */
  .search-box { position: relative; }
  .search-input {
    width: 100%; height: 44px;
    
    /* Dark Glass Input */
    background: rgba(0, 0, 0, 0.2); /* –¢–µ–º–Ω–µ–µ, –∫–∞–∫ –ø–æ–ª–µ –≤–≤–æ–¥–∞ */
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    
    border-radius: 14px;
    padding: 0 40px 0 44px;
    color: #fff; font-size: 16px; font-weight: 500;
    transition: all 0.2s ease;
  }
  .search-input::placeholder { color: rgba(255,255,255,0.35); font-weight: 400; }
  .search-input:focus {
    background: rgba(0, 0, 0, 0.4);
    border-color: rgba(255, 255, 255, 0.25);
    outline: none;
  }
  .search-icon {
    position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
    color: rgba(255,255,255,0.4); pointer-events: none;
  }
  .search-clear {
    position: absolute; right: 0; top: 0; bottom: 0; width: 40px;
    display: flex; align-items: center; justify-content: center;
    color: rgba(255,255,255,0.4); opacity: 0; pointer-events: none; transition: opacity 0.2s;
  }
  .search-input:not(:placeholder-shown) ~ .search-clear { opacity: 1; pointer-events: auto; }

  /* --- VIEW CONTAINER --- */
  .views-container {
    position: relative; flex: 1; overflow: hidden; z-index: 1;
  }
  
  .view {
    position: absolute; inset: 0;
    overflow-y: auto; overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
    padding: 12px var(--pad) 120px; /* –ë–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –¥–ª—è –∫–Ω–æ–ø–∫–∏ */
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s ease;
    opacity: 0; pointer-events: none; transform: translateX(30px);
    background: transparent;
  }
  .view.active { opacity: 1; pointer-events: auto; transform: translateX(0); }
  .view.prev { transform: translateX(-10%) scale(0.98); opacity: 0; pointer-events: none; }

  /* --- CATEGORY GRID (MATCHING KBJU MACRO-CARDS) --- */
  .cat-grid {
    display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;
  }
  
  .cat-card {
    /* üî• 100% COPY OF .macro-card FROM KBJU */
    background: rgba(0, 0, 0, 0.3) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-top: 1px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 24px !important;
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.2) !important;
    
    padding: 16px;
    display: flex; flex-direction: column; justify-content: space-between;
    min-height: 110px;
    cursor: pointer; position: relative; overflow: hidden;
    transition: transform 0.1s, background 0.2s;
  }
  .cat-card:active { transform: scale(0.96); background: rgba(0,0,0,0.4) !important; }
  
  .cat-icon { font-size: 28px; margin-bottom: 8px; filter: drop-shadow(0 4px 12px rgba(0,0,0,0.3)); }
  .cat-name { font-size: 15px; font-weight: 800; line-height: 1.1; margin-bottom: 2px; color: #fff; letter-spacing: 0.3px; }
  .cat-meta { font-size: 12px; color: rgba(255,255,255,0.5); font-weight: 500; }
  
  /* Progress Line (integrated nicely) */
  .cat-progress-track {
    position: absolute; bottom: 0; left: 0; right: 0; height: 3px; 
    background: rgba(255,255,255,0.05);
  }
  .cat-progress-fill {
    height: 100%; background: var(--acc-blue);
    width: 0%; transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 -1px 8px var(--acc-blue);
  }

  /* --- PRODUCT LIST --- */
  .list-header-area {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 16px; margin-top: 4px;
  }
  
  /* –¢–µ–∫—Å—Ç–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ "–í—ã–±—Ä–∞—Ç—å –≤—Å—ë" */
  .btn-select-all {
    font-size: 14px; font-weight: 600; color: var(--acc-blue);
    background: none; border: none; padding: 8px 0;
    cursor: pointer; transition: opacity 0.2s;
  }
  .btn-select-all:active { opacity: 0.6; }

  /* Header Title in List */
  .list-title { font-size: 26px; font-weight: 800; letter-spacing: -0.5px; line-height: 1.1; color: #fff; }

  /* --- PRODUCT ROW (With Shake Animation) --- */
  .product-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 16px;
    margin-bottom: 8px;
    
    /* Glass List Item */
    background: rgba(0, 0, 0, 0.3) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-top: 1px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 20px;
    
    cursor: pointer;
    transform: scale(1); 
    transition: background 0.15s ease, border-color 0.15s;
    position: relative;
    overflow: hidden;
  }
  
  /* Selected State - Neon Blue Border */
  .product-row.selected {
    background: rgba(10, 132, 255, 0.15) !important;
    border-color: var(--acc-blue) !important;
    box-shadow: 0 0 20px rgba(10, 132, 255, 0.15) !important;
  }
  
  /* SHAKE ANIMATION (Like iOS Wrong Passcode / Select) */
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(-2px); }
    40% { transform: translateX(2px); }
    60% { transform: translateX(-1px); }
    80% { transform: translateX(1px); }
  }
  .product-row.shake { 
    animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; 
  }

  .prod-info { flex: 1; z-index: 2; display: flex; flex-direction: column; gap: 2px; }
  .prod-name { font-size: 15px; font-weight: 600; color: #fff; line-height: 1.2; }
  .prod-meta { font-size: 12px; color: rgba(255,255,255,0.5); font-weight: 500; }
  
  /* Checkbox (Hidden logic visually, shown via row state, but icon added for clarity) */
  .prod-status {
    width: 24px; height: 24px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,0.2);
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s ease;
    margin-left: 12px;
  }
  .product-row.selected .prod-status {
    background: var(--acc-blue);
    border-color: var(--acc-blue);
    box-shadow: 0 0 10px var(--acc-blue);
  }
  .prod-status svg { opacity: 0; transform: scale(0.5); transition: all 0.2s; }
  .product-row.selected .prod-status svg { opacity: 1; transform: scale(1); }

  /* --- FLOATING SAVE BUTTON (No Background) --- */
  .save-floater {
    position: absolute; bottom: 30px; left: 0; right: 0;
    display: flex; justify-content: center;
    z-index: 30;
    pointer-events: none; /* Container transparent to clicks */
  }
  
  .btn-save {
    pointer-events: auto;
    background: linear-gradient(135deg, var(--acc-blue), #0066cc);
    color: #fff; border: none;
    height: 50px; 
    min-width: 200px;
    padding: 0 32px;
    border-radius: 25px; /* Pill shape */
    font-size: 16px; font-weight: 700;
    
    /* Neon Shadow */
    box-shadow: 0 8px 32px rgba(10, 132, 255, 0.5);
    
    cursor: pointer;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    transition: transform 0.1s, opacity 0.2s, box-shadow 0.2s;
    transform: translateY(100px); opacity: 0; /* Hidden by default */
  }
  .btn-save.visible { transform: translateY(0); opacity: 1; }
  .btn-save:active { transform: scale(0.96); }

  /* --- EMPTY STATE --- */
  .empty-state {
    text-align: center; margin-top: 60px; color: var(--text-muted);
  }
  .empty-icon { font-size: 40px; margin-bottom: 10px; opacity: 0.5; }

</style>
</head>
<body>

<!-- Background -->
<div class="fx-layer">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="noise"></div>
</div>

<!-- Header (Only Search) -->
<div class="app-header">
  <div class="search-box">
    <div class="search-icon">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    </div>
    <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤..." id="searchInput">
    <div class="search-clear" id="searchClear">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </div>
  </div>
</div>

<!-- Views Container -->
<div class="views-container">
  
  <!-- VIEW 1: Categories Grid -->
  <div class="view active" id="view-cats">
    <div class="cat-grid" id="catGrid">
      <!-- JS Injected -->
    </div>
  </div>

  <!-- VIEW 2: Product List -->
  <div class="view" id="view-list">
    <div class="list-header-area">
      <h2 class="list-title" id="catTitle">–ù–∞–∑–≤–∞–Ω–∏–µ</h2>
      <button class="btn-select-all" id="btnSelectAll">–í—ã–±—Ä–∞—Ç—å –≤—Å—ë</button>
    </div>
    <div id="productList"></div>
  </div>

  <!-- VIEW 3: Search Results -->
  <div class="view" id="view-search">
    <div id="searchResults"></div>
  </div>

</div>

<!-- Floating Save Button (No Bar Background) -->
<div class="save-floater">
  <button class="btn-save" id="btnSave" onclick="saveSelection()">
    <span id="saveBtnText">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
  </button>
</div>

<script>
  // --- TELEGRAM SETUP ---
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.ready();
    tg.expand();
    tg.setHeaderColor('#050505');
    tg.setBackgroundColor('#050505');
    
    // Back Button Logic
    tg.BackButton.onClick(() => {
      if (state.searchMode) {
        exitSearchMode();
      } else if (state.activeCatId) {
        goBack();
      } else {
        // –ï—Å–ª–∏ –º—ã –≤ –∫–æ—Ä–Ω–µ ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ–º –∏–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–æ—É—Ç–µ—Ä (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ª–æ–≥–∏–∫–∏)
        // window.location.href = 'router.html'; 
        tg.close(); 
      }
    });
  }

  // --- MOCK DATA ---
  const DB = [
    { 
      id: 'c1', name: '–ë–µ–ª–∫–∏', icon: 'ü•©', 
      items: [
        { id: 'p1', name: '–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞', meta: '113 –∫–∫–∞–ª' },
        { id: 'p2', name: '–ò–Ω–¥–µ–π–∫–∞ —Ñ–∏–ª–µ', meta: '115 –∫–∫–∞–ª' },
        { id: 'p3', name: '–ì–æ–≤—è–¥–∏–Ω–∞ –ø–æ—Å—Ç–Ω–∞—è', meta: '180 –∫–∫–∞–ª' },
        { id: 'p4', name: '–Ø–π—Ü–æ –∫—É—Ä–∏–Ω–æ–µ', meta: '86 –∫–∫–∞–ª' },
        { id: 'p5', name: '–¢–≤–æ—Ä–æ–≥ 5%', meta: '121 –∫–∫–∞–ª' },
        { id: 'p6', name: '–õ–æ—Å–æ—Å—å', meta: '208 –∫–∫–∞–ª' },
        { id: 'p7', name: '–¢—É–Ω–µ—Ü', meta: '100 –∫–∫–∞–ª' },
      ]
    },
    { 
      id: 'c2', name: '–ö—Ä—É–ø—ã', icon: 'üçö', 
      items: [
        { id: 'p9', name: '–ì—Ä–µ—á–∫–∞', meta: '313 –∫–∫–∞–ª' },
        { id: 'p10', name: '–†–∏—Å –ë–∞—Å–º–∞—Ç–∏', meta: '350 –∫–∫–∞–ª' },
        { id: 'p11', name: '–û–≤—Å—è–Ω–∫–∞', meta: '360 –∫–∫–∞–ª' },
        { id: 'p12', name: '–ú–∞–∫–∞—Ä–æ–Ω—ã —Ç–≤/—Å', meta: '340 –∫–∫–∞–ª' },
        { id: 'p13', name: '–ö–∏–Ω–æ–∞', meta: '368 –∫–∫–∞–ª' },
      ]
    },
    { 
      id: 'c3', name: '–û–≤–æ—â–∏', icon: 'ü•¶', 
      items: [
        { id: 'p15', name: '–û–≥—É—Ä—Ü—ã', meta: '15 –∫–∫–∞–ª' },
        { id: 'p16', name: '–ü–æ–º–∏–¥–æ—Ä—ã', meta: '20 –∫–∫–∞–ª' },
        { id: 'p17', name: '–ë—Ä–æ–∫–∫–æ–ª–∏', meta: '34 –∫–∫–∞–ª' },
        { id: 'p18', name: '–®–ø–∏–Ω–∞—Ç', meta: '23 –∫–∫–∞–ª' },
      ]
    },
    {
      id: 'c4', name: '–§—Ä—É–∫—Ç—ã', icon: 'üçé',
      items: [
        { id: 'p21', name: '–Ø–±–ª–æ–∫–æ', meta: '47 –∫–∫–∞–ª' },
        { id: 'p22', name: '–ë–∞–Ω–∞–Ω', meta: '89 –∫–∫–∞–ª' },
        { id: 'p23', name: '–ê–ø–µ–ª—å—Å–∏–Ω', meta: '43 –∫–∫–∞–ª' },
      ]
    },
    {
      id: 'c5', name: '–ñ–∏—Ä—ã', icon: 'ü•ë',
      items: [
        { id: 'p25', name: '–û–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ', meta: '884 –∫–∫–∞–ª' },
        { id: 'p26', name: '–ê–≤–æ–∫–∞–¥–æ', meta: '160 –∫–∫–∞–ª' },
      ]
    },
    {
      id: 'c6', name: '–°–Ω–µ–∫–∏', icon: 'üç´',
      items: [
        { id: 'p30', name: '–ü—Ä–æ—Ç–µ–∏–Ω–æ–≤—ã–π –±–∞—Ç–æ–Ω—á–∏–∫', meta: '200 –∫–∫–∞–ª' },
        { id: 'p31', name: '–•–ª–µ–±—Ü—ã', meta: '300 –∫–∫–∞–ª' },
      ]
    }
  ];

  // --- STATE ---
  const state = {
    selected: new Set(),
    activeCatId: null,
    searchMode: false
  };

  // --- DOM ELEMENTS ---
  const el = {
    catGrid: document.getElementById('catGrid'),
    productList: document.getElementById('productList'),
    viewCats: document.getElementById('view-cats'),
    viewList: document.getElementById('view-list'),
    viewSearch: document.getElementById('view-search'),
    catTitle: document.getElementById('catTitle'),
    btnSelectAll: document.getElementById('btnSelectAll'),
    searchInput: document.getElementById('searchInput'),
    searchClear: document.getElementById('searchClear'),
    searchResults: document.getElementById('searchResults'),
    btnSave: document.getElementById('btnSave'),
    saveBtnText: document.getElementById('saveBtnText')
  };

  // --- HAPTIC HELPER (Safe) ---
  function haptic(type = 'light') {
    try {
      const tg = window.Telegram?.WebApp?.HapticFeedback;
      if (!tg) return;
      if (type === 'light') tg.impactOccurred('light');
      if (type === 'medium') tg.impactOccurred('medium');
      if (type === 'heavy') tg.impactOccurred('heavy');
      if (type === 'success') tg.notificationOccurred('success');
      if (type === 'changed') tg.selectionChanged();
    } catch(e) {}
  }

  // --- INIT ---
  function init() {
    // Pre-select some for demo
    ['p1', 'p2', 'p15'].forEach(id => state.selected.add(id));
    
    renderCategories();
    updateSaveButton();
    
    // Listeners
    el.searchInput.addEventListener('input', handleSearch);
    el.searchClear.addEventListener('click', clearSearch);
    
    if(tg) tg.BackButton.isVisible = false; // Start state
  }

  // --- RENDER CATEGORIES ---
  function renderCategories() {
    el.catGrid.innerHTML = '';
    
    DB.forEach(cat => {
      const totalItems = cat.items.length;
      const selectedItems = cat.items.filter(i => state.selected.has(i.id)).length;
      const progress = (selectedItems / totalItems) * 100;
      
      const card = document.createElement('div');
      card.className = 'cat-card';
      card.onclick = () => openCategory(cat.id);
      
      card.innerHTML = `
        <div>
          <div class="cat-icon">${cat.icon}</div>
          <div class="cat-name">${cat.name}</div>
          <div class="cat-meta">${selectedItems} –∏–∑ ${totalItems}</div>
        </div>
        <div class="cat-progress-track">
          <div class="cat-progress-fill" style="width: ${progress}%"></div>
        </div>
      `;
      el.catGrid.appendChild(card);
    });
  }

  // --- NAVIGATION ---
  function openCategory(id) {
    haptic('light');
    state.activeCatId = id;
    const cat = DB.find(c => c.id === id);
    
    el.catTitle.textContent = cat.name;
    renderProductList(cat.items, el.productList);
    updateSelectAllBtn(cat);

    // Slide Transition
    el.viewCats.classList.add('prev');
    el.viewCats.classList.remove('active');
    el.viewList.classList.add('active');
    el.viewList.classList.remove('next');
    
    if(tg) tg.BackButton.show();
  }

  function goBack() {
    haptic('light');
    state.activeCatId = null;
    
    // Slide Back
    el.viewList.classList.remove('active');
    el.viewCats.classList.add('active');
    el.viewCats.classList.remove('prev');
    
    if(tg) tg.BackButton.hide();
    
    // Re-render to update progress bars
    setTimeout(renderCategories, 300); 
  }

  // --- RENDER LIST ---
  function renderProductList(items, container) {
    container.innerHTML = '';
    
    items.forEach((item, index) => {
      const isSel = state.selected.has(item.id);
      const row = document.createElement('div');
      row.className = `product-row ${isSel ? 'selected' : ''}`;
      row.onclick = () => toggleProduct(item.id, row);
      
      // Stagger animation for list items
      row.style.animation = `fadeInUp 0.2s ease forwards ${index * 0.02}s`;
      row.style.opacity = '0';
      row.style.transform = 'translateY(8px)';
      
      row.innerHTML = `
        <div class="prod-info">
          <div class="prod-name">${item.name}</div>
          <div class="prod-meta">${item.meta}</div>
        </div>
        <div class="prod-status">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        </div>
      `;
      container.appendChild(row);
    });
  }

  const styleSheet = document.createElement("style");
  styleSheet.innerText = `@keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }`;
  document.head.appendChild(styleSheet);

  // --- INTERACTION ---
  function toggleProduct(id, rowEl) {
    haptic('light');
    
    // SHAKE/BUMP Animation
    rowEl.classList.remove('shake');
    void rowEl.offsetWidth; 
    rowEl.classList.add('shake');

    if (state.selected.has(id)) {
      state.selected.delete(id);
      rowEl.classList.remove('selected');
    } else {
      state.selected.add(id);
      rowEl.classList.add('selected');
    }
    
    updateSaveButton();
    
    if (state.activeCatId && !state.searchMode) {
        const cat = DB.find(c => c.id === state.activeCatId);
        updateSelectAllBtn(cat);
    }
  }

  function updateSaveButton() {
    const count = state.selected.size;
    if (count > 0) {
      el.btnSave.classList.add('visible');
      el.saveBtnText.textContent = `–°–æ—Ö—Ä–∞–Ω–∏—Ç—å (${count})`;
    } else {
      // Optional: Hide if 0, or show disabled
      // el.btnSave.classList.remove('visible');
      el.saveBtnText.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    }
  }

  function updateSelectAllBtn(cat) {
    const allSelected = cat.items.every(i => state.selected.has(i.id));
    el.btnSelectAll.textContent = allSelected ? '–°–Ω—è—Ç—å –≤—Å—ë' : '–í—ã–±—Ä–∞—Ç—å –≤—Å—ë';
    el.btnSelectAll.onclick = () => toggleAllInCategory(cat, !allSelected);
  }

  function toggleAllInCategory(cat, select) {
    haptic('medium');
    cat.items.forEach(i => {
      if (select) state.selected.add(i.id);
      else state.selected.delete(i.id);
    });
    renderProductList(cat.items, el.productList);
    updateSelectAllBtn(cat);
    updateSaveButton();
  }

  // --- SEARCH ---
  function handleSearch(e) {
    const query = e.target.value.toLowerCase().trim();
    if (query.length > 0) {
      if (!state.searchMode) enterSearchMode();
      
      let results = [];
      DB.forEach(cat => {
        const matches = cat.items.filter(i => i.name.toLowerCase().includes(query));
        results = [...results, ...matches];
      });
      
      if (results.length === 0) {
        el.searchResults.innerHTML = '<div class="empty-state"><div class="empty-icon">üîç</div><div>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div></div>';
      } else {
        renderProductList(results, el.searchResults);
      }
    } else {
      exitSearchMode();
    }
  }

  function enterSearchMode() {
    state.searchMode = true;
    el.viewCats.classList.remove('active');
    el.viewList.classList.remove('active');
    el.viewSearch.classList.add('active');
    if(tg) tg.BackButton.show();
  }

  function exitSearchMode() {
    state.searchMode = false;
    el.viewSearch.classList.remove('active');
    
    if (state.activeCatId) {
      el.viewList.classList.add('active');
    } else {
      el.viewCats.classList.add('active');
      renderCategories();
      if(tg) tg.BackButton.hide();
    }
  }

  function clearSearch() {
    el.searchInput.value = '';
    exitSearchMode();
  }

  function saveSelection() {
    haptic('success');
    alert(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${state.selected.size} –ø—Ä–æ–¥—É–∫—Ç–æ–≤!`);
  }

  init();

</script>
</body>
</html>
