<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Ultima Market</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  /* 1. CORE */
  :root { --bg:#050505; --text:#fff; --text-m:rgba(255,255,255,.55); --dark:rgba(0,0,0,.3); --border:rgba(255,255,255,.1); --blue:#0a84ff; --r:24px; }
  * { box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; }
  body { background:var(--bg); color:var(--text); font-family:-apple-system,sans-serif; height:100vh; overflow:hidden; display:flex; flex-direction:column; }
  
  /* 2. FX */
  .fx { position:fixed; inset:0; z-index:0; pointer-events:none; }
  .orb { position:absolute; border-radius:50%; animation:float 30s linear infinite; }
  .orb-1 { width:90vw; height:90vw; opacity:.4; background:radial-gradient(circle,#6c5ce7,transparent 70%); top:-20%; left:-20%; }
  .noise { position:fixed; inset:0; opacity:.04; background:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); }
  @keyframes float { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }

  /* 3. LAYOUT */
  .head { position:relative; z-index:10; padding:12px 16px 4px; flex-shrink:0; }
  .view-wrap { position:relative; flex:1; overflow:hidden; z-index:1; }
  .view { position:absolute; inset:0; overflow-y:auto; padding:12px 16px 140px; transition:.3s; opacity:0; pointer-events:none; transform:translateX(30px); }
  .view.active { opacity:1; pointer-events:auto; transform:translateX(0); }
  .view.prev { transform:translateX(-10%) scale(.98); opacity:0; }

  /* 4. UI */
  .s-box { position:relative; }
  .s-inp { width:100%; height:40px; background:var(--dark); border:1px solid var(--border); border-radius:14px; padding:0 36px 0 40px; color:#fff; font-size:16px; backdrop-filter:blur(20px); }
  .s-icon { position:absolute; left:12px; top:11px; color:rgba(255,255,255,.4); }
  
  .cat-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .cat-card { background:var(--dark); border:1px solid var(--border); border-radius:var(--r); padding:14px; min-height:110px; display:flex; flex-direction:column; justify-content:space-between; position:relative; overflow:hidden; backdrop-filter:blur(20px); }
  .cat-card:active { background:rgba(255,255,255,.1); }
  .c-ico { font-size:24px; margin-bottom:10px; }
  .c-name { font-size:14px; font-weight:700; }
  .c-meta { font-size:12px; color:var(--text-m); }
  .c-prog { position:absolute; bottom:0; left:0; height:3px; background:rgba(255,255,255,.05); width:100%; }
  .c-fill { height:100%; background:var(--blue); width:0%; transition:.4s; }

  .list-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
  .l-title { font-size:20px; font-weight:800; }
  .btn-all { color:var(--blue); font-weight:600; background:none; border:none; padding:6px; }
  
  .prod-cont { background:rgba(255,255,255,.03); border:1px solid var(--border); padding:14px; border-radius:20px; display:flex; flex-direction:column; gap:8px; backdrop-filter:blur(10px); }
  .p-row { display:flex; align-items:center; gap:12px; padding:12px; border-radius:12px; transition:.15s; }
  .p-row:active { background:rgba(255,255,255,.05); }
  .chk { width:22px; height:22px; border-radius:6px; border:2px solid rgba(255,255,255,.6); display:flex; align-items:center; justify-content:center; }
  .chk::after { content:""; width:12px; height:12px; background:#fff; border-radius:3px; transform:scale(0); transition:.2s; }
  .p-row.sel .chk { background:var(--blue); border-color:var(--blue); }
  .p-row.sel .chk::after { transform:scale(1); }

  .float-act { position:absolute; bottom:34px; left:0; right:0; display:flex; justify-content:center; z-index:30; pointer-events:none; }
  .btn-save { pointer-events:auto; background:var(--blue); color:#fff; border:none; padding:14px 28px; border-radius:14px; font-weight:900; box-shadow:0 8px 32px rgba(10,132,255,.4); transform:translateY(100px); opacity:0; transition:.2s; }
  .btn-save.show { transform:translateY(0); opacity:1; }
  .empty { text-align:center; padding:40px; color:var(--text-m); }
</style>
</head>
<body>

<div class="fx"><div class="orb orb-1"></div><div class="noise"></div></div>

<div class="head">
  <div class="s-box">
    <div class="s-icon">üîç</div>
    <input type="text" class="s-inp" placeholder="–ü–æ–∏—Å–∫..." id="sInput">
  </div>
</div>

<div class="view-wrap">
  <div class="view active" id="v-cats"><div class="cat-grid" id="catGrid"></div></div>
  <div class="view" id="v-list">
    <div class="list-head"><div class="l-title" id="lTitle">...</div><button class="btn-all" id="btnAll">–í—ã–±—Ä–∞—Ç—å –≤—Å—ë</button></div>
    <div class="prod-cont" id="pList"></div><div id="sentinel" style="height:20px;"></div>
  </div>
  <div class="view" id="v-search"><div class="prod-cont" id="sRes"></div></div>
</div>

<div class="float-act"><button class="btn-save" id="btnSave" onclick="App.save()"><span id="txtSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span></button></div>

<script>
  /* CONFIG */
  const cfg = { 
    // üëá –°–Æ–î–ê URL üëá
    api: "–í–°–¢–ê–í–¨_–°–Æ–î–ê_–°–í–û–ô_URL_GAS", 
    batch: 20 
  };
  
  // –ó–ê–ü–ê–°–ù–´–ï –î–ê–ù–ù–´–ï (–ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —É–ø–∞–ª)
  const MOCK = [
    {id:'c1',name:'–ë–µ–ª–∫–∏',icon:'ü•©',items:[{id:'p1',name:'–ö—É—Ä–∏—Ü–∞',meta:'113 –∫–∫–∞–ª'},{id:'p2',name:'–¢–≤–æ—Ä–æ–≥',meta:'120 –∫–∫–∞–ª'}]},
    {id:'c2',name:'–ö—Ä—É–ø—ã',icon:'üçö',items:[{id:'p3',name:'–ì—Ä–µ—á–∫–∞',meta:'300 –∫–∫–∞–ª'}]}
  ];

  /* CORE */
  const tg = window.Telegram?.WebApp;
  const Utils = {
    cache: { get: k=>JSON.parse(localStorage.getItem(k)||'null'), set: (k,v)=>localStorage.setItem(k,JSON.stringify(v)) }
  };

  const Data = {
    cats: [], pMap: {}, ver: 0,
    
    init: async function() {
      // 1. –ü—ã—Ç–∞–µ–º—Å—è –≥—Ä—É–∑–∏—Ç—å –∫—ç—à
      const local = Utils.cache.get('ultima_v3');
      if(local) { this.load(local); Render.cats(); }
      else { this.useMock(); Render.cats(); } // –°—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º Mock, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø—É—Å—Ç–æ

      // 2. –°—Ç—É—á–∏–º—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      try {
        const res = await fetch(cfg.api, {
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body: JSON.stringify({ action:'init', clientVer:this.ver, initData: tg?.initData||'' })
        });
        const ans = await res.json();
        
        if(ans.ok && ans.catalog) {
          // –°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—Ç–∏–ª –¥–∞–Ω–Ω—ã–º–∏!
          this.process(ans.catalog);
          this.ver = ans.serverVer;
          Utils.cache.set('ultima_v3', { cats:this.cats, map:this.pMap, ver:this.ver });
          Render.cats(); // –û–±–Ω–æ–≤–ª—è–µ–º —ç–∫—Ä–∞–Ω
        }
        if(ans.userSelection) State.merge(ans.userSelection);
        
      } catch(e) { console.log('Server fail, staying on Mock', e); }
    },

    useMock: function() {
      this.cats = MOCK.map(c=>({id:c.id,name:c.name,icon:c.icon}));
      MOCK.forEach(c => this.pMap[c.id] = c.items);
    },

    load: function(d) { this.cats=d.cats; this.pMap=d.map; this.ver=d.ver; },
    
    process: function(raw) {
      this.cats = raw.categories; this.pMap = {};
      raw.products.forEach(p => {
        if(!this.pMap[p[1]]) this.pMap[p[1]]=[];
        this.pMap[p[1]].push({id:p[0],name:p[2],meta:p[3]});
      });
    },

    get: cid => this.pMap[cid]||[],
    search: q => Object.values(this.pMap).flat().filter(p => p.name.toLowerCase().includes(q)),
    sendSave: async (ids) => fetch(cfg.api, { method:'POST', body:JSON.stringify({action:'save',initData:tg?.initData||'',selection:{ids}}) })
  };

  const el = { grid:document.getElementById('catGrid'), list:document.getElementById('pList'), views:{cats:document.getElementById('v-cats'),list:document.getElementById('v-list'),search:document.getElementById('v-search')}, bSave:document.getElementById('btnSave'), tSave:document.getElementById('txtSave'), bAll:document.getElementById('btnAll') };

  const State = {
    sel: new Set(), activeCat: null, q:[], idx:0,
    init: () => State.sel = new Set(Utils.cache.get('sel_v3')||[]),
    save: () => Utils.cache.set('sel_v3', [...State.sel]),
    merge: (json) => { try{ State.sel=new Set(JSON.parse(json).ids); State.save(); Render.ui(); }catch(e){} }
  };

  const Render = {
    cats: () => {
      el.grid.innerHTML = Data.cats.map(c => {
        const total = Data.get(c.id).length, sel = Data.get(c.id).filter(p=>State.sel.has(p.id)).length;
        return `<div class="cat-card" onclick="App.open('${c.id}')"><div><div class="c-ico">${c.icon}</div><div class="c-name">${c.name}</div><div class="c-meta">${sel}/${total}</div></div><div class="c-prog"><div class="c-fill" style="width:${total?(sel/total)*100:0}%"></div></div></div>`;
      }).join('');
    },
    list: (items, cont) => {
      if(!items.length) { cont.innerHTML='<div class="empty">–ü—É—Å—Ç–æ</div>'; return; }
      const frag = document.createDocumentFragment();
      items.slice(0, 100).forEach(p => { // Simple render limit for now
        const d=document.createElement('div'); d.className=`p-row ${State.sel.has(p.id)?'sel':''}`;
        d.onclick=()=>App.toggle(p.id, d);
        d.innerHTML=`<div class="chk"></div><div><div class="c-name">${p.name}</div><div class="c-meta">${p.meta}</div></div>`;
        frag.appendChild(d);
      });
      cont.innerHTML=''; cont.appendChild(frag);
    },
    ui: () => {
      const c = State.sel.size, inCat = !!State.activeCat;
      el.tSave.innerText = inCat ? (c?`–í—ã–±—Ä–∞—Ç—å (${c})`:'–ù–∞–∑–∞–¥') : `–°–æ—Ö—Ä–∞–Ω–∏—Ç—å (${c})`;
      el.bSave.classList.toggle('show', inCat || c>0);
      if(!inCat) Render.cats();
    }
  };

  const App = {
    init: () => {
      tg?.ready(); tg?.expand(); tg?.BackButton.onClick(App.back);
      State.init(); Data.init(); Render.ui();
      
      document.getElementById('sInput').oninput = e => {
        const v = e.target.value.toLowerCase();
        if(!v) return App.back();
        App.view('search'); tg?.BackButton.show();
        Render.list(Data.search(v), document.getElementById('sRes'));
      };
    },
    open: id => { State.activeCat=id; document.getElementById('lTitle').innerText=Data.cats.find(x=>x.id==id).name; Render.list(Data.get(id),el.list); App.view('list'); tg?.BackButton.show(); Render.ui(); },
    toggle: (id,n) => { State.sel.has(id)?State.sel.delete(id):State.sel.add(id); n.classList.toggle('sel'); State.save(); Render.ui(); },
    back: () => { State.activeCat=null; document.getElementById('sInput').value=''; App.view('cats'); tg?.BackButton.hide(); Render.ui(); },
    view: v => { Object.values(el.views).forEach(x=>x.classList.remove('active')); el.views[v].classList.add('active'); },
    save: async () => {
      if(State.activeCat) return App.back();
      el.tSave.innerText='–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
      try { await Data.sendSave([...State.sel]); tg?.close(); } catch(e){ el.tSave.innerText='–û—à–∏–±–∫–∞'; }
    }
  };

  App.init();
</script>
</body>
</html>
