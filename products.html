<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>–í—ã–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤ Ultima</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<!-- Firebase SDK (Compat version) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
  :root {
    /* --- PALETTE --- */
    --bg-core: #050505;
    --text-main: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.55);
    
    /* --- GLASS SURFACES --- */
    --surface-glass: rgba(255, 255, 255, 0.07);
    --surface-dark: rgba(0, 0, 0, 0.3);
    --surface-border: rgba(255, 255, 255, 0.1);
    --surface-border-light: rgba(255, 255, 255, 0.2);
    
    /* --- ACCENTS --- */
    --acc-blue: #0a84ff;
    --acc-green: #30d158;
    
    /* --- KBJU VARS --- */
    --okA: #4facfe; 
    --okB: #0a84ff;
    
    /* --- METRICS --- */
    --radius-xl: 28px;
    --radius-l: 24px;
    --radius-m: 16px;
    --pad-x: 16px; 
    --gap: 8px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  
  /* üî• CRITICAL FOR IOS RESPONSIVENESS */
  html, body, button, .cat-card, .product-row, .btn-save { 
    touch-action: manipulation; 
  }

  /* =========================================
     PREMIUM UI STYLES (Glass & Air)
     ========================================= */

  /* 1. –ë–ê–ó–ê */
  body {
    background: radial-gradient(circle at top, #1a1a2e 0%, #050505 100%) !important; /* –ì–ª—É–±–æ–∫–∏–π –ø—Ä–µ–º–∏—É–º —Ñ–æ–Ω */
    color: var(--text-main);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', Roboto, sans-serif;
    -webkit-font-smoothing: antialiased;
    height: 100vh;
    overflow: hidden; 
    display: flex;
    flex-direction: column;
  }

  /* 2. –ö–û–ù–¢–ï–ô–ù–ï–† –≠–ö–†–ê–ù–û–í */
  .views-container {
    flex: 1; 
    position: relative;
    overflow: hidden; 
  }

  /* 3. –°–ü–ò–°–û–ö (–°–∫—Ä–æ–ª–ª –∏ –û—Ç—Å—Ç—É–ø—ã) */
  /* –î–µ–ª–∞–µ–º —Ç–∞–∫, —á—Ç–æ–±—ã —Å–ø–∏—Å–æ–∫ –Ω–µ –ª–∏–ø –∫ –∫—Ä–∞—è–º, –Ω–æ —Å–∫—Ä–æ–ª–ª–±–∞—Ä –±—ã–ª —Å –∫—Ä–∞—é */
  #view-list.active {
    display: flex !important;
    flex-direction: column;
    height: 100%;
  }

  .product-list-container, #productList {
    flex: 1;
    overflow-y: auto; 
    padding: 10px 16px; /* üî• –î–æ–±–∞–≤–∏–ª–∏ –≤–æ–∑–¥—É—Ö –ø–æ –±–æ–∫–∞–º (16px) */
    
    /* üî• –ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç: –Ω–∏–∂–Ω–∏–π –æ—Ç—Å—Ç—É–ø –±–æ–ª—å—à–µ –≤—ã—Å–æ—Ç—ã –∫–Ω–æ–ø–∫–∏, 
       —á—Ç–æ–±—ã –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–æ–≤–∞—Ä –º–æ–∂–Ω–æ –±—ã–ª–æ –ø—Ä–æ—Å–∫—Ä–æ–ª–ª–∏—Ç—å –í–´–®–ï –∫–Ω–æ–ø–∫–∏ */
    padding-bottom: 140px !important; 
    
    -webkit-overflow-scrolling: touch;
  }

  /* 4. –®–ê–ü–ö–ê –ö–ê–¢–ï–ì–û–†–ò–ò (Glass Header) */
  .list-header-area {
    position: absolute; /* –õ–µ–∂–∏—Ç –ø–æ–≤–µ—Ä—Ö —Å–ø–∏—Å–∫–∞ */
    top: 0; left: 0; right: 0;
    z-index: 20;
    
    /* –≠—Ñ—Ñ–µ–∫—Ç —Å—Ç–µ–∫–ª–∞ */
    background: rgba(5, 5, 5, 0.7); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —á–µ—Ä–Ω—ã–π */
    backdrop-filter: blur(20px);     /* üî• –¢–æ—Ç —Å–∞–º—ã–π –±–ª—é—Ä */
    -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.05); /* –¢–æ–Ω—á–∞–π—à–∞—è –ª–∏–Ω–∏—è */
    
    padding: 12px 20px;
    display: flex; 
    align-items: center; 
    justify-content: space-between;
  }
  
  /* –û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É –¥–ª—è —Å–ø–∏—Å–∫–∞, —á—Ç–æ–±—ã –ø–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä –Ω–µ –ø—Ä—è—Ç–∞–ª—Å—è –ø–æ–¥ —à–∞–ø–∫–æ–π */
  #productList {
    padding-top: 70px !important; 
  }

  /* 5. –ö–ù–û–ü–ö–ê (Floating Capsule) */
  .save-floater {
    position: absolute; /* –õ–µ—Ç–∞–µ—Ç –Ω–∞–¥ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º */
    bottom: 0; left: 0; right: 0;
    z-index: 30;
    
    /* –ì—Ä–∞–¥–∏–µ–Ω—Ç —Å–Ω–∏–∑—É, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –ø–ª–∞–≤–Ω–æ –∏—Å—á–µ–∑–∞–ª */
    background: linear-gradient(to top, #050505 30%, rgba(5,5,5,0.8) 70%, transparent 100%);
    padding: 20px 24px 40px; /* –û—Ç—Å—Ç—É–ø—ã –¥–ª—è –∫–Ω–æ–ø–∫–∏ */
    
    display: flex;
    justify-content: center;
    pointer-events: none; /* –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–ª–∏–∫–∏ —Å–∫–≤–æ–∑—å –≥—Ä–∞–¥–∏–µ–Ω—Ç */
  }

  .btn-save {
    pointer-events: auto; /* –í–∫–ª—é—á–∞–µ–º –∫–ª–∏–∫–∏ –Ω–∞ —Å–∞–º–æ–π –∫–Ω–æ–ø–∫–µ */
    width: 100%;
    max-width: 380px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö */
    height: 56px;
    
    /* üî• –í–∏–¥ –∫–Ω–æ–ø–∫–∏-–∫–∞–ø—Å—É–ª—ã */
    border-radius: 28px !important; 
    background: #0a84ff; /* –¢–≤–æ–π —Å–∏–Ω–∏–π */
    box-shadow: 0 8px 24px rgba(10, 132, 255, 0.35); /* –ö—Ä–∞—Å–∏–≤–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ */
    
    font-size: 17px;
    font-weight: 600;
    letter-spacing: -0.01em;
    border: none;
    color: #fff;
    
    transition: transform 0.1s, opacity 0.2s, background 0.2s;
  }
  
  .btn-save:active {
    transform: scale(0.96); /* –ü—Ä–∏—è—Ç–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ */
  }

  /* –î–∏–∑–µ–π–±–ª —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
  .btn-save.disabled {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.3);
    box-shadow: none;
  }

  /* --- FX LAYER --- */
  .fx-layer { position: fixed; inset: 0; z-index: 0; pointer-events: none; transform: translate3d(0,0,0); }
  .orb { position: absolute; border-radius: 50%; will-change: transform; animation: float 30s infinite linear; }
  .orb-1 { width: 90vw; height: 90vw; opacity: 0.4; background: radial-gradient(circle, rgba(108, 92, 231, 0.8) 0%, transparent 70%); top: -20%; left: -20%; }
  .orb-2 { width: 400px; height: 400px; opacity: 0.5; background: radial-gradient(circle, rgba(108, 92, 231, 0.8) 0%, transparent 70%); bottom: -150px; right: -100px; animation: breathe 6s infinite ease-in-out; }
  .noise { position: fixed; inset: 0; z-index: 0; opacity: 0.04; background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); pointer-events: none; }
  @keyframes float { 0% {transform:rotate(0deg)} 100% {transform:rotate(360deg)} }
  @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.4; } 50% { transform: scale(1.1); opacity: 0.6; } }

  /* --- LAYOUT --- */
  .app-header { position: relative; z-index: 10; padding: 12px var(--pad-x) 4px; background: transparent; flex-shrink: 0; }

  /* Search Bar */
  .search-box { position: relative; }
  .search-input {
    width: 100%; height: 40px; background: var(--surface-dark);
    border: 1px solid var(--surface-border); border-top: 1px solid var(--surface-border-light);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-radius: 14px; padding: 0 36px 0 40px;
    color: #fff; font-size: 16px; font-weight: 500;
    transition: all 0.2s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .search-input::placeholder { color: rgba(255,255,255,0.35); font-weight: 400; }
  .search-input:focus { background: rgba(0, 0, 0, 0.5); border-color: rgba(255, 255, 255, 0.25); outline: none; }
  .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.4); pointer-events: none; }
  .search-clear {
    position: absolute; right: 0; top: 0; bottom: 0; width: 36px;
    display: flex; align-items: center; justify-content: center;
    color: rgba(255,255,255,0.4); opacity: 0; pointer-events: auto; transition: opacity 0.2s;
  }
  .search-input:not(:placeholder-shown) ~ .search-clear { opacity: 1; }

  /* --- VIEW CONTAINER --- */
  .views-container { position: relative; flex: 1; overflow: hidden; z-index: 1; }
  
  .view {
    position: absolute; inset: 0; overflow-y: auto; overflow-x: hidden;
    -webkit-overflow-scrolling: touch; padding: 12px var(--pad-x) 140px;
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s ease;
    opacity: 0; pointer-events: none; transform: translateX(30px);
    background: transparent;
  }
  .view.active { opacity: 1; pointer-events: auto; transform: translateX(0); }
  .view.prev { transform: translateX(-10%) scale(0.98); opacity: 0; pointer-events: none; }

  /* --- CATEGORY GRID --- */
  .cat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--gap); }
  
  .cat-card {
    background: var(--surface-dark) !important;
    border: 1px solid var(--surface-border) !important;
    border-top: 1px solid var(--surface-border-light) !important;
    border-radius: var(--radius-l) !important;
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.2) !important;
    padding: 14px;
    display: flex; flex-direction: column; justify-content: space-between;
    min-height: 110px;
    cursor: pointer; position: relative; overflow: hidden;
    transition: background 0.2s; 
    will-change: transform;
  }
  
  .cat-card:active { background: rgba(0,0,0,0.4) !important; }
  
  .cat-icon { font-size: 24px; margin-bottom: 10px; filter: drop-shadow(0 4px 12px rgba(0,0,0,0.3)); }
  .cat-name { font-size: 14px; font-weight: 700; line-height: 1.2; margin-bottom: 2px; color: #fff; letter-spacing: 0.3px; }
  .cat-meta { font-size: 12px; color: rgba(255,255,255,0.55); font-weight: 500; }
  .cat-progress-track { position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: rgba(255,255,255,0.05); }
  .cat-progress-fill {
    height: 100%; background: var(--acc-blue); width: 0%; 
    transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 -1px 8px var(--acc-blue);
  }

  /* --- HEADER LIST --- */
  .list-header-area { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding: 0 4px; }
  .list-title { font-size: 20px; font-weight: 800; letter-spacing: 0.3px; color: #fff; }
  .btn-select-all {
    font-size: 15px; font-weight: 600; color: var(--acc-blue);
    background: none; border: none; padding: 6px 0; cursor: pointer; transition: opacity 0.2s;
  }
  .btn-select-all:active { opacity: 0.7; }

  /* --- PRODUCT LIST CONTAINER --- */
  .product-list-container {
    display: flex; flex-direction: column; gap: 8px;
    background: linear-gradient(165deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    padding: 14px; border-radius: 20px; backdrop-filter: blur(10px);
    min-height: 50px;
  }

  /* --- PRODUCT ROW --- */
  .product-row {
    display: flex; align-items: center; justify-content: flex-start;
    gap: 12px;
    padding: 12px 14px; border-radius: 12px;
    position: relative; cursor: pointer; background: transparent;
    transition: background 0.15s ease;
    will-change: transform;
    opacity: 1;
  }
  
  .product-row:active { background: rgba(255,255,255,0.05); }
  .product-row.selected { background: transparent; } 

  /* üî• ANIMATION: BUMP */
  .bump { animation: bump 0.15s cubic-bezier(0.34, 1.56, 0.64, 1) !important; }
  @keyframes bump { 
    0% { transform: scale(1); } 
    50% { transform: scale(0.95); } 
    100% { transform: scale(1); } 
  }

  .prod-info { flex: 1; z-index: 2; display: flex; flex-direction: column; gap: 3px; }
  .prod-name { font-size: 15px; font-weight: 600; color: #fff; line-height: 1.3; }
  .prod-meta { font-size: 12px; color: rgba(255,255,255,0.5); font-weight: 500; letter-spacing: 0.2px; }
  
  /* --- CHECKBOX --- */
  .check-square {
    width: 22px; height: 22px; border-radius: 6px;
    border: 2px solid rgba(255,255,255,.65);
    display: inline-flex; align-items: center; justify-content: center;
    flex-shrink: 0; transition: all .2s ease; background: transparent;
  }
  .check-square::after {
    content: ""; width: 12px; height: 12px; border-radius: 3px;
    background: #fff; opacity: 0; transform: scale(.7); transition: all .2s ease;
  }
  .product-row.selected .check-square {
    background: linear-gradient(135deg, var(--okA), var(--okB)); border-color: var(--okB);
    transform: scale(1.05);
  }
  .product-row.selected .check-square::after { opacity: 1; transform: scale(1); }

  /* --- EMPTY STATE --- */
  .empty-state {
    display: flex; flex-direction: column; align-items: center;
    margin-top: 60px; color: var(--text-muted); padding: 20px;
    background: var(--surface-dark); border-radius: 24px;
    border: 1px solid var(--surface-border); backdrop-filter: blur(10px);
  }
  .empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.6; }
  
  #sentinel { height: 20px; width: 100%; opacity: 0; pointer-events: none; }

  /* =========================================
     HIDE SCROLLBARS (BUT KEEP SCROLLING)
     ========================================= */
  
  /* 1. –î–ª—è Webkit-–±—Ä–∞—É–∑–µ—Ä–æ–≤ (Chrome, Safari, iOS, Android) */
  ::-webkit-scrollbar { width: 0; height: 0; display: none; }

  /* 2. –î–ª—è Firefox –∏ IE/Edge */
  * {
    scrollbar-width: none !important; /* Firefox */
    -ms-overflow-style: none !important; /* IE 10+ */
  }

  /* 3. –ì–∞—Ä–∞–Ω—Ç–∏—è –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ */
  html, body, .view, .product-list-container {
    scrollbar-width: none !important;
    -ms-overflow-style: none !important;
  }
</style>
</head>
<body>

<div class="fx-layer">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="noise"></div>
</div>

<div class="app-header">
  <div class="search-box">
    <div class="search-icon">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    </div>
    <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤..." id="searchInput">
    <div class="search-clear" id="searchClear">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </div>
  </div>
</div>

<div class="views-container">
  
  <!-- VIEW 1: Categories -->
  <div class="view active" id="view-cats">
    <div class="cat-grid" id="catGrid"></div>
  </div>

  <!-- VIEW 2: Product List -->
  <div class="view" id="view-list">
    <div class="list-header-area">
      <h2 class="list-title" id="catTitle">–ù–∞–∑–≤–∞–Ω–∏–µ</h2>
      <button class="btn-select-all" id="btnSelectAll">–í—ã–±—Ä–∞—Ç—å –≤—Å—ë</button>
    </div>
    <div class="product-list-container" id="productList"></div>
    <div id="sentinel"></div>
  </div>

  <!-- VIEW 3: Search -->
  <div class="view" id="view-search">
    <div class="product-list-container" id="searchResults" style="display:none; background:transparent!important; border:none!important; box-shadow:none!important; backdrop-filter:none!important;"></div>
  </div>

</div>

<!-- Save Button -->
<div class="save-floater">
  <button class="btn-save" id="btnSave" onclick="saveSelection()">
    <span id="saveBtnText">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
  </button>
</div>

<script>
  
  /**
   * ===============================================================
   * 1. CONFIG & API
   * ===============================================================
   */
  // üî¥ –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–°–´–õ–ö–£ –ù–ê –í–ï–ë-–ü–†–ò–õ–û–ñ–ï–ù–ò–ï (–∏–∑ Google Apps Script)
  const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbybxqI4xOLAUOcMXGReNl0PVjGToGg6_x3ZxlKNnUHg3XcaZGhkbsu61Adgkb4emrkm/exec';

  /**
   * ===============================================================
   * 2. STATE (–°–û–°–¢–û–Ø–ù–ò–ï)
   * ===============================================================
   */
  const state = {
    selected: new Set(),
    activeCatId: null,
    searchMode: false,
    renderQueue: [],
    renderIndex: 0,
    BATCH_SIZE: 20,
    currentContainer: null
  };

  const el = {
    catGrid: document.getElementById('catGrid'),
    productList: document.getElementById('productList'),
    viewCats: document.getElementById('view-cats'),
    viewList: document.getElementById('view-list'),
    viewSearch: document.getElementById('view-search'),
    catTitle: document.getElementById('catTitle'),
    btnSelectAll: document.getElementById('btnSelectAll'),
    searchInput: document.getElementById('searchInput'),
    searchClear: document.getElementById('searchClear'),
    searchResults: document.getElementById('searchResults'),
    btnSave: document.getElementById('btnSave'),
    saveBtnText: document.getElementById('saveBtnText'),
    sentinel: document.getElementById('sentinel')
  };

  /**
   * ===============================================================
   * 3. SAFE BOOT (–¢–≤–æ–π –∫–æ–¥ + –õ–æ–≥–∏–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏)
   * ===============================================================
   */
  const tg = window.Telegram?.WebApp;

  (function initTMA() {
    try {
      if (!tg) return;

      tg.ready();
      tg.expand();

      // 1. –¶–≤–µ—Ç–∞ (Safe)
      try {
        tg.setHeaderColor('#050505');
        if (tg.setBackgroundColor) tg.setBackgroundColor('#050505');
      } catch (e) { console.log('Color error:', e); }

      // 2. –ö–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥ (Safe + Logic)
      try {
        if (tg.BackButton) {
          tg.BackButton.show();
          tg.BackButton.offClick(); // üî• –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–µ –∫–ª–∏–∫–∏
          
          tg.BackButton.onClick(function() {
            // –£–ú–ù–ê–Ø –õ–û–ì–ò–ö–ê –ù–ê–í–ò–ì–ê–¶–ò–ò
            if (state.searchMode) {
              exitSearchMode();
            } else if (state.activeCatId) {
              goBack();
            } else {
              // –ï—Å–ª–∏ –º—ã –Ω–∞ –≥–ª–∞–≤–Ω–æ–π - —É—Ö–æ–¥–∏–º –≤ —Ä–æ—É—Ç–µ—Ä
              window.location.href = 'router.html';
            }
          });
        }
      } catch (e) { console.log('Back button error:', e); }

      // 3. –û—Ç–∫–ª—é—á–∞–µ–º —Å–≤–∞–π–ø—ã
      try {
        if (tg.disableVerticalSwipes) tg.disableVerticalSwipes();
      } catch (e) {}

    } catch (err) {
      console.error('Critical TMA Error:', err);
    }
  })();

  /**
   * ===============================================================
   * 4. DATA SERVICE
   * ===============================================================
   */
  const DataService = {
    categories: [],
    productsMap: {}, 
    allValidIds: new Set(), 

    async init() {
      this.loadFromCache();
      this.sanitizeCart(); 
      renderCategories(); 
      updateSaveButton(); // –°—Ä–∞–∑—É —Å—Ç–∞–≤–∏–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏

      await this.fetchFromServer();
    },

    loadFromCache() {
      try {
        const cachedCat = localStorage.getItem('ultima_catalog_v2');
        if (cachedCat) this.processCatalogData(JSON.parse(cachedCat));
        
        const cachedCart = localStorage.getItem('ultima_cart_v1');
        if (cachedCart) state.selected = new Set(JSON.parse(cachedCart));
      } catch(e) { console.error("Cache error", e); }
    },

    async fetchFromServer() {
      try {
        const currentVer = localStorage.getItem('ultima_ver') || 0;
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º tg.initData —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        const initDataStr = tg?.initData || ''; 
        
        const response = await fetch(BACKEND_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'init',
            clientVer: currentVer,
            initData: initDataStr
          })
        });

        const data = await response.json();

        if (data.ok) {
          if (data.needUpdate && data.catalog) {
            this.processCatalogData(data.catalog);
            localStorage.setItem('ultima_catalog_v2', JSON.stringify(data.catalog));
            localStorage.setItem('ultima_ver', data.serverVer);
            this.sanitizeCart();
            if (!state.activeCatId && !state.searchMode) renderCategories();
          }

          if (data.userSelection) {
            try {
              const parsed = typeof data.userSelection === 'string' ? JSON.parse(data.userSelection) : data.userSelection;
              if (Array.isArray(parsed)) {
                state.selected = new Set(parsed);
                this.sanitizeCart();
                saveSelectionToCache();
                updateSaveButton();
                if (!state.activeCatId) renderCategories();
              }
            } catch(e) {}
          }
        }
      } catch (e) {}
    },

    processCatalogData(rawCatalog) {
      if (!rawCatalog) return;
      this.categories = rawCatalog.categories || [];
      this.productsMap = {};
      this.allValidIds.clear();

      const rawProds = rawCatalog.products || [];
      rawProds.forEach(row => {
        const [pId, catId, pName, pMeta] = row;
        this.allValidIds.add(String(pId));
        if (!this.productsMap[catId]) this.productsMap[catId] = [];
        this.productsMap[catId].push({ id: pId, name: pName, meta: pMeta });
      });
    },

    sanitizeCart() {
      if (this.allValidIds.size === 0) return;
      let changed = false;
      state.selected.forEach(id => {
        if (!this.allValidIds.has(String(id))) {
          state.selected.delete(id);
          changed = true;
        }
      });
      if (changed) {
        saveSelectionToCache();
        updateSaveButton();
      }
    },

    getProducts(catId) { return this.productsMap[catId] || []; },
    
    search(query) {
      const res = []; 
      const q = query.toLowerCase();
      Object.values(this.productsMap).forEach(list => {
        list.forEach(p => {
          if (p.name.toLowerCase().includes(q)) res.push(p);
        });
      });
      return res;
    }
  };

  // --- Helpers ---
  function saveSelectionToCache() {
    try {
      const arr = Array.from(state.selected);
      localStorage.setItem('ultima_cart_v1', JSON.stringify(arr));
    } catch(e) {}
  }

  function haptic(type = 'light') {
    try { window.Telegram?.WebApp?.HapticFeedback?.impactOccurred(type); } catch(e){}
  }

  const bump = el => { 
    if(!el) return; el.classList.remove('bump'); void el.offsetWidth; el.classList.add('bump'); 
  };

  // –°–ª—É—à–∞—Ç–µ–ª—å –∫–∞—Å–∞–Ω–∏–π (–∞–Ω–∏–º–∞—Ü–∏—è)
  document.addEventListener('touchstart', (e) => {
    const el = e.target.closest('.cat-card, .btn-save');
    if (!el) return;
    // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞ - –Ω–µ –≤–∏–±—Ä–∏—Ä—É–µ–º
    if (el.classList.contains('btn-save') && el.classList.contains('disabled')) return;
    haptic('light'); bump(el);
  }, {passive: true});

  /**
   * ===============================================================
   * 5. RENDER LOGIC
   * ===============================================================
   */
  function renderCategories() {
    el.catGrid.innerHTML = '';
    if (DataService.categories.length === 0) {
      el.catGrid.innerHTML = '<div style="grid-column:span 2; text-align:center; padding:40px; color:#666;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
      return;
    }

    DataService.categories.forEach(cat => {
      const products = DataService.getProducts(cat.id);
      const total = products.length;
      const sel = products.filter(i => state.selected.has(i.id)).length;
      const progress = total > 0 ? (sel / total) * 100 : 0;
      
      const card = document.createElement('div');
      card.className = 'cat-card';
      card.onclick = () => openCategory(cat.id);
      
      card.innerHTML = `
        <div>
          <div class="cat-icon">${cat.icon || 'üì¶'}</div>
          <div class="cat-name">${cat.name}</div>
          <div class="cat-meta">${sel} –∏–∑ ${total}</div>
        </div>
        <div class="cat-progress-track">
          <div class="cat-progress-fill" style="width: ${progress}%"></div>
        </div>
      `;
      el.catGrid.appendChild(card);
    });
  }

  function openCategory(id) {
    state.activeCatId = id;
    const cat = DataService.categories.find(c => c.id === id);
    el.catTitle.textContent = cat ? cat.name : '–ü—Ä–æ–¥—É–∫—Ç—ã';
    el.productList.style.display = 'flex';
    const products = DataService.getProducts(id);
    startInfiniteRender(products, el.productList);
    updateSelectAllBtn();
    
    el.viewCats.classList.add('prev');
    el.viewCats.classList.remove('active');
    el.viewList.classList.add('active');
    
    updateSaveButton(); 
  }

  function goBack() {
    state.activeCatId = null;
    el.viewList.classList.remove('active');
    el.viewCats.classList.add('active');
    el.viewCats.classList.remove('prev');
    setTimeout(renderCategories, 300); 
    updateSaveButton();
  }

  function startInfiniteRender(items, container, isSearch = false) {
    container.innerHTML = '';
    if (isSearch) {
        container.style.background = 'transparent'; container.style.border = 'none'; container.style.boxShadow = 'none';
    } else { container.style = ""; }

    if (items.length === 0 && isSearch) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üîç</div><div>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div></div>';
        return;
    }

    state.renderQueue = items;
    state.renderIndex = 0;
    
    let target = container;
    if (isSearch) {
        const wrapper = document.createElement('div');
        wrapper.className = 'product-list-container';
        container.appendChild(wrapper);
        target = wrapper;
    }
    state.currentContainer = target;
    renderNextBatch(isSearch);
  }

  function renderNextBatch(isSearch = false) {
    if (state.renderIndex >= state.renderQueue.length) return;
    const batch = state.renderQueue.slice(state.renderIndex, state.renderIndex + state.BATCH_SIZE);
    const fragment = document.createDocumentFragment();

    batch.forEach((item, i) => {
      const isSel = state.selected.has(item.id);
      const row = document.createElement('div');
      row.className = `product-row ${isSel ? 'selected' : ''}`;
      
      row.addEventListener('touchstart', function() { haptic('light'); bump(this); }, {passive: true});
      row.onclick = () => toggleProduct(item.id, row);
      
      if (!isSearch) {
        row.style.opacity = '0';
        row.style.animation = `fadeInUp 0.2s ease forwards ${i * 0.02}s`;
        setTimeout(() => { row.style.opacity = '1'; row.style.animation = 'none'; }, (i * 20) + 300);
      }
      
      row.innerHTML = `
        <div class="check-square"></div>
        <div class="prod-info">
          <div class="prod-name">${item.name}</div>
          <div class="prod-meta">${item.meta}</div>
        </div>
      `;
      fragment.appendChild(row);
    });
    state.currentContainer.appendChild(fragment);
    state.renderIndex += state.BATCH_SIZE;
  }

  const styleSheet = document.createElement("style");
  styleSheet.innerText = `@keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }`;
  document.head.appendChild(styleSheet);

  /**
   * ===============================================================
   * 6. ACTIONS
   * ===============================================================
   */
  function toggleProduct(id, rowEl) {
    if (state.selected.has(id)) {
      state.selected.delete(id);
      rowEl.classList.remove('selected');
    } else {
      state.selected.add(id);
      rowEl.classList.add('selected');
    }
    saveSelectionToCache();
    updateSaveButton();
    if (state.activeCatId && !state.searchMode) updateSelectAllBtn();
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ (Disabled –ª–æ–≥–∏–∫–∞)
 // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–∏
  function updateSaveButton() {
    let count = 0;
    let text = '';
    
    // 1. –°–Ω–∞—á–∞–ª–∞ –¥–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–∫—Ç–∏–≤–Ω–æ–π (—É–±–∏—Ä–∞–µ–º —Å–µ—Ä–æ—Å—Ç—å)
    el.btnSave.classList.remove('disabled');

    // –°—Ü–µ–Ω–∞—Ä–∏–π –ê: –ú—ã –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Å–º–æ—Ç—Ä–∏–º —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤)
    if (state.activeCatId) {
        const products = DataService.getProducts(state.activeCatId);
        // –°—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–æ –∏–º–µ–Ω–Ω–æ –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        count = products.filter(i => state.selected.has(i.id)).length;
        
        if (count > 0) {
           text = `–í—ã–±—Ä–∞–Ω–æ (${count})`;
        } else {
           text = `–ù–∞–∑–∞–¥`; // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–ª–∏, –∫–Ω–æ–ø–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ "–ù–∞–∑–∞–¥"
        }
        
        // –í –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–Ω–æ–ø–∫–∞ –í–°–ï–ì–î–ê –∞–∫—Ç–∏–≤–Ω–∞ (–º—ã –ª–∏–±–æ –≤—ã–±–∏—Ä–∞–µ–º, –ª–∏–±–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è)
    } 
    
    // –°—Ü–µ–Ω–∞—Ä–∏–π –ë: –ú—ã –Ω–∞ –≥–ª–∞–≤–Ω–æ–π (–≤–∏–¥–∏–º —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π)
    else {
        count = state.selected.size; // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ
        text = `–°–æ—Ö—Ä–∞–Ω–∏—Ç—å (${count})`;
        
        // –ï—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ ‚Äî –¥–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–µ—Ä–æ–π (–Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π)
        if (count === 0) {
           el.btnSave.classList.add('disabled');
        }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø–∫–µ
    el.saveBtnText.textContent = text;
    
    // –í–ê–ñ–ù–û: –ú—ã –±–æ–ª—å—à–µ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º/—É–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å 'visible' –∏–ª–∏ 'hidden'.
    // –ö–Ω–æ–ø–∫–∞ –≤—Å–µ–≥–¥–∞ —Å—Ç–æ–∏—Ç –Ω–∞ –º–µ—Å—Ç–µ.
  }

  function updateSelectAllBtn() {
    if (!state.activeCatId) return;
    const products = DataService.getProducts(state.activeCatId);
    const allSelected = products.length > 0 && products.every(i => state.selected.has(i.id));
    el.btnSelectAll.textContent = allSelected ? '–°–Ω—è—Ç—å –≤—Å—ë' : '–í—ã–±—Ä–∞—Ç—å –≤—Å—ë';
    el.btnSelectAll.onclick = () => toggleAllInCategory(products, !allSelected);
  }

  function toggleAllInCategory(products, select) {
    haptic('medium');
    products.forEach(i => {
      if (select) state.selected.add(i.id);
      else state.selected.delete(i.id);
    });
    saveSelectionToCache();
    startInfiniteRender(products, el.productList); 
    updateSelectAllBtn();
    updateSaveButton();
  }

  // --- Search ---
  function handleSearch(e) {
    const query = e.target.value.toLowerCase().trim();
    if (query.length > 0) {
      if (!state.searchMode) enterSearchMode();
      const results = DataService.search(query);
      el.searchResults.style.display = 'block';
      startInfiniteRender(results, el.searchResults, true);
    } else { el.searchResults.innerHTML = ''; }
  }

  function enterSearchMode() {
    state.searchMode = true;
    el.viewCats.classList.remove('active');
    el.viewList.classList.remove('active');
    el.viewSearch.classList.add('active');
  }

  function exitSearchMode() {
    state.searchMode = false;
    el.viewSearch.classList.remove('active');
    el.searchResults.style.display = 'none';
    el.searchInput.value = '';
    if (state.activeCatId) el.viewList.classList.add('active');
    else {
      el.viewCats.classList.add('active');
      renderCategories();
    }
  }

  function clearSearch() { exitSearchMode(); }

  /**
   * ===============================================================
   * 7. SERVER SAVE
   * ===============================================================
   */
  async function saveSelection() {
    haptic('light'); // –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è
    
    if (state.activeCatId && !state.searchMode) { goBack(); return; }

    const originalText = el.saveBtnText.textContent;
    el.saveBtnText.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
    
    DataService.sanitizeCart(); 
    const selectionArray = Array.from(state.selected);
    
    try {
      const response = await fetch(BACKEND_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'save',
          selection: selectionArray,
          initData: tg?.initData || ''
        })
      });
      const res = await response.json();
      
      if (res.ok) {
        if (tg && tg.showPopup) {
           tg.showPopup({ 
             title: '–ì–æ—Ç–æ–≤–æ', 
             message: '–í–∞—à –≤—ã–±–æ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 
             buttons: [{type:'ok'}] 
           }, () => { if (state.searchMode) exitSearchMode(); });
        } else {
           alert(`‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!`);
           if (state.searchMode) exitSearchMode();
        }
      } else { throw new Error("Server error"); }
    } catch(e) {
      haptic('error');
      alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.');
    } finally {
      el.saveBtnText.textContent = originalText;
    }
  }

  // Init
  el.searchInput.addEventListener('input', handleSearch);
  el.searchClear.addEventListener('click', clearSearch);
  const observer = new IntersectionObserver((entries) => {
    if (entries[0].isIntersecting) renderNextBatch();
  }, { rootMargin: '200px' });
  observer.observe(el.sentinel);

  DataService.init();
</script>
</body>
</html>
