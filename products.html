<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–í—ã–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; scrollbar-gutter: stable both-edges; }

    /* —Ñ–æ–Ω –Ω–∞ –≤–µ—Å—å –¥–æ–∫—É–º–µ–Ω—Ç */
    html {
      min-height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-size: cover;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      min-height: 100%;
      background: transparent;
      padding: 20px 20px 140px 20px; /* –Ω–∏–∑ –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–¥ –±–ª–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è */
      color: #222;
    }

    .container {
      max-width: 600px;
      margin: 0 auto 20px;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,.28);
      overflow: visible;
    }

    /* Header */
    .header { position: relative; background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; padding: 14px 18px; text-align: center; }
    .header h1 { font-size: 18px; font-weight: 800; letter-spacing: .2px; }
    .info-button { position: absolute; top: 12px; right: 12px; width: 28px; height: 28px; border-radius: 50%; border: 1.5px solid rgba(255,255,255,.6); background: rgba(255,255,255,.15); color: #fff; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform .2s, background .2s; box-shadow: 0 2px 8px rgba(0,0,0,.12) inset; }
    .info-button:hover { background: rgba(255,255,255,.25); transform: scale(1.08); }
    .info-button:focus-visible { outline: 2px solid rgba(255,255,255,.9); outline-offset: 2px; }
    .user-info { display: none; }

    /* Search */
    .search-container { padding: 14px 18px; border-bottom: 1px solid #eee; }
    .search-wrap { position: relative; }
    .search-input { width: 100%; padding: 14px 44px 14px 16px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 12px; transition: border-color .2s, box-shadow .2s; caret-color: #667eea; }
    .search-input::placeholder { color: #98a2b3; }
    .search-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,.12); }
    .search-clear { position: absolute; right: 8px; top: 50%; translate: 0 -50%; width: 28px; height: 28px; border-radius: 999px; border: none; background: #eef2ff; color: #4f46e5; font-size: 18px; line-height: 1; display: none; align-items: center; justify-content: center; cursor: pointer; }
    .search-clear.visible { display: flex; }

    .loading-indicator { text-align: center; padding: 16px 18px; color: #667eea; font-weight: 600; display: none; }
    .loading-indicator.active { display: block; }

    /* Categories */
    .categories { padding: 12px 18px; padding-bottom: var(--bottom-inset, 180px); }
    .category { margin-bottom: 12px; border-radius: 12px; background: #f7f8fb; }

    .category-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; cursor: pointer; background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; border-radius: 12px; }
    .category.open .category-header { border-radius: 12px 12px 0 0; }
    .category-title { font-weight: 600; font-size: 16px; }
    .category-meta { display:flex; align-items:center; gap:8px; }
    .category-count { background: rgba(255,255,255,.25); padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; }
    .category-arrow { width: 8px; height: 8px; border: solid #fff; border-width: 0 2px 2px 0; transform: rotate(45deg); transition: transform .25s; margin-left: 4px; }
    .category.open .category-arrow { transform: rotate(-135deg); }

    .category-products { max-height: 0; overflow: hidden; transition: max-height .32s ease; background: #fff; border-radius: 0 0 12px 12px; }

    .select-all-container { padding: 12px 16px; background: #f0f2f5; border-bottom: 1px solid #e8e8e8; display: flex; justify-content: center; }
    .select-all-btn { background: linear-gradient(135deg, #667eea, #764ba2); border: none; color: #fff; padding: 10px 22px; border-radius: 10px; font-size: 14px; cursor: pointer; font-weight: 700; width: 100%; max-width: 220px; }

    /* –≤–∞–∂–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è: –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç—å —Ç–æ–ª—å–∫–æ —É —á–µ–∫–±–æ–∫—Å–∞ */
    .product-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid #f0f0f0; cursor: default; }
    .product-item:last-child { border-bottom: 0; }
    .product-checkbox { width: 20px; height: 20px; cursor: pointer; }
    .product-label { flex: 1; font-size: 15px; cursor: default; user-select: none; }

    /* Save button */
    .save-button-container { position: fixed; left: 0; right: 0; bottom: 0; padding: 12px 20px; background: #fff; border-top: 1px solid #eee; z-index: 100; }
    .save-button-wrapper { max-width: 600px; margin: 0 auto; }
    .selected-count { text-align: center; margin-bottom: 10px; font-weight: 700; }
    .save-button { width: 100%; padding: 12px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; font-size: 15px; color: #fff; background: linear-gradient(135deg, #667eea, #764ba2); box-shadow: 0 4px 12px rgba(102,126,234,.3); }
    .save-button:disabled { opacity: .6; cursor: not-allowed; }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.5); backdrop-filter: blur(6px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: #fff; border-radius: 16px; padding: 20px 16px; max-width: 560px; width: 100%; max-height: 80vh; overflow: hidden; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,.35); }
    .modal-title { font-size: 18px; font-weight: 800; margin-bottom: 10px; color: #333; padding-right: 40px; }
    .modal-body { overflow: auto; max-height: calc(80vh - 64px); padding-right: 6px; }
    .modal-text { font-size: 15px; line-height: 1.7; color: #333; white-space: pre-wrap; }
    .modal-close { position: absolute; top: 8px; right: 8px; width: 44px; height: 44px; background: transparent; border: none; color: #444; font-size: 28px; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; transform-origin: 50% 50%; }
    .modal-close.spin { animation: spin 420ms linear 1; }

    /* Loader */
    .global-loader { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 2000; pointer-events: none; }
    .global-loader.active { display: flex; }
    .loader-card { pointer-events: auto; background: rgba(255,255,255,.85); backdrop-filter: blur(6px); border-radius: 14px; padding: 14px 18px; box-shadow: 0 10px 30px rgba(0,0,0,.12); display: flex; align-items: center; gap: 12px; }
    .ring { width: 28px; height: 28px; border-radius: 50%; background: conic-gradient(from 0deg, #0ea5e9, #22d3ee 50%, #0ea5e9); -webkit-mask: radial-gradient(farthest-side, transparent calc(100% - 4px), #000 0); mask: radial-gradient(farthest-side, transparent calc(100% - 4px), #000 0); animation: spin 1s linear infinite; }
    .loader-text { color: #4b5563; font-weight: 600; font-size: 14px; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .error { padding: 12px 16px; background: #ffebee; color: #c62828; text-align: center; font-size: 14px; border-bottom: 3px solid #ef5350; }
    .success { padding: 12px 16px; background: #e8f5e9; color: #2e7d32; text-align: center; font-size: 14px; border-bottom: 3px solid #66bb6a; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>–í—ã–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤</h1>
      <button class="info-button" id="infoButton" aria-label="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è">?</button>
      <div class="user-info" id="userInfo"></div>
    </div>

    <div class="search-container">
      <div class="search-wrap">
        <input id="searchInput" class="search-input" type="text" placeholder="–ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤" autocomplete="off" disabled />
        <button id="searchClear" class="search-clear" aria-label="–û—á–∏—Å—Ç–∏—Ç—å">√ó</button>
      </div>
    </div>

    <div id="loadingIndicator" class="loading-indicator">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="categories" class="categories"></div>
  </div>

  <div class="save-button-container">
    <div class="save-button-wrapper">
      <div class="selected-count">–í—ã–±—Ä–∞–Ω–æ: <strong><span id="selectedCount">0</span></strong></div>
      <button id="saveButton" class="save-button" disabled>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>

  <!-- –£–±—Ä–∞–ª–∏ footer-nav -->

  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-content">
      <button class="modal-close" id="modalClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
      <div class="modal-title">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</div>
      <div class="modal-body">
        <div class="modal-text" id="modalText"><div class="modal-loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏...</div></div>
      </div>
    </div>
  </div>

  <!-- –ü—Ä–µ–ª–æ–∞–¥–µ—Ä -->
  <div class="global-loader" id="globalLoader">
    <div class="loader-card">
      <div class="ring"></div>
      <div class="loader-text" id="loaderText">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö‚Ä¶</div>
    </div>
  </div>

  <script>
    const CONFIG = { APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbxOJTIJ74ADNnwqjo-jTB5o80JBHI3LyZWGCefos4dJibThb8KUJ1avBieFaggSz_99/exec' };
    const tg = window.Telegram?.WebApp || { 
      initData: '', 
      expand: () => {},
      BackButton: { show:()=>{}, hide:()=>{}, onClick:()=>{} }
    };

    const selectedProducts = new Set();
    let allCategories = {};
    let manualCache = null, manualCacheTime = 0; const MANUAL_CACHE_DURATION = 5*60*1000;
    let currentQuery = '';

    const loaderEl = document.getElementById('globalLoader');
    const loaderTextEl = document.getElementById('loaderText');
    const searchInput = document.getElementById('searchInput');
    const searchClear = document.getElementById('searchClear');

    function showLoader(text){ if(text) loaderTextEl.textContent = text; loaderEl.classList.add('active'); }
    function hideLoader(){ loaderEl.classList.remove('active'); }

    function updateBottomInset(){
      const saveH = document.querySelector('.save-button-container')?.offsetHeight || 0;
      // –Ω–∏–∂–Ω–µ–≥–æ –º–µ–Ω—é –±–æ–ª—å—à–µ –Ω–µ—Ç
      const inset = saveH + 16;
      document.documentElement.style.setProperty('--bottom-inset', inset + 'px');
    }

    if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', initApp); } else { initApp(); }

    async function initApp(){
      try{ tg.expand?.(); }catch(e){}
      /* Telegram Back Button ‚Üí router.html */
      try{
        tg.BackButton.show();
        tg.BackButton.onClick(function(){
          // –í–æ–∑–≤—Ä–∞—Ç –Ω–∞ —Ä–æ—É—Ç–µ—Ä
          window.location.href = 'router.html';
        });
      }catch(e){}
      showLoader('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö‚Ä¶');
      try{
        const res = await fetch(`${CONFIG.APPS_SCRIPT_URL}?action=init&initData=${encodeURIComponent(tg.initData||'')}`, {cache:'no-cache'});
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const products = data.products || [];
        (data.user_data?.selected_products||'').split(',').filter(Boolean).forEach(id=>selectedProducts.add(String(id)));
        allCategories = groupByCategory(products);
        renderCategories();
        bindHandlers();
        updateTotalSelected();
        searchInput.disabled = false;
        updateBottomInset();
        window.addEventListener('resize', updateBottomInset);
      }catch(err){ showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+err.message); }
      finally{ hideLoader(); }
    }

    function groupByCategory(list){
      return (list||[]).reduce((acc,p)=>{ const cat=p.category||'–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'; (acc[cat] ||= []).push({id:String(p.id), name:p.name, category:cat}); return acc; },{});
    }

    function renderCategories(){
      const wrap = document.getElementById('categories');
      wrap.innerHTML = '';
      Object.entries(allCategories).forEach(([cat, items], idx)=>{
        const selectedInCat = items.filter(p=>selectedProducts.has(p.id)).length;
        const el = document.createElement('div'); el.className='category'; el.dataset.categoryId = 'cat-'+idx; el.dataset.products = JSON.stringify(items);
        el.innerHTML = `
          <div class="category-header">
            <span class="category-title">${escapeHtml(cat)}</span>
            <div class="category-meta">
              <span class="category-count">${selectedInCat}/${items.length}</span>
              <div class="category-arrow"></div>
            </div>
          </div>
          <div class="category-products"></div>
        `;
        wrap.appendChild(el);
      });
    }

    function bindHandlers(){
      const catsEl = document.getElementById('categories');

      // —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ/—Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –∏ –∫–Ω–æ–ø–∫–∞ ¬´–≤—ã–±—Ä–∞—Ç—å –≤—Å–µ¬ª
      catsEl.addEventListener('click', onCategoriesClick);

      // –≤—ã–±–æ—Ä —Ç–æ–ª—å–∫–æ –ø–æ —á–µ–∫–±–æ–∫—Å—É
      catsEl.addEventListener('change', (e)=>{
        if(e.target && e.target.classList.contains('product-checkbox')){
          handleCheckboxChange(e.target);
        }
      });

      let t=null; searchInput.addEventListener('input', e=>{
        clearTimeout(t);
        t=setTimeout(()=>{
          currentQuery = (e.target.value||'').trim().toLowerCase();
          searchClear.classList.toggle('visible', !!currentQuery);
          applySearch();
        }, 180);
      });

      searchClear.addEventListener('click', ()=>{
        searchInput.value='';
        currentQuery='';
        searchClear.classList.remove('visible');
        applySearch();
        searchInput.blur();
        const wasDisabled = searchInput.disabled;
        searchInput.disabled = true;
        setTimeout(()=>{ searchInput.disabled = wasDisabled; }, 50);
      });

      document.getElementById('saveButton').addEventListener('click', saveUserData);
      document.getElementById('infoButton').addEventListener('click', showManual);
      const closeBtn = document.getElementById('modalClose');
      closeBtn.addEventListener('click', ()=>{ closeBtn.classList.add('spin'); setTimeout(()=>closeBtn.classList.remove('spin'), 420); document.getElementById('modalOverlay').classList.remove('active'); });
      document.getElementById('modalOverlay').addEventListener('click', (e)=>{ if(e.target===e.currentTarget) e.currentTarget.classList.remove('active'); });
    }

    function onCategoriesClick(e){
      const header = e.target.closest('.category-header');
      if(header){
        const cat = header.parentElement; const panel = cat.querySelector('.category-products');
        const opening = !cat.classList.contains('open');
        if(opening){
          renderCategoryProducts(cat);
          cat.classList.add('open'); panel.style.maxHeight = panel.scrollHeight + 'px';
          panel.addEventListener('transitionend', function te(){ panel.style.maxHeight = 'none'; panel.removeEventListener('transitionend', te); }, {once:true});
        } else {
          panel.style.maxHeight = panel.scrollHeight + 'px';
          requestAnimationFrame(()=>{ panel.style.maxHeight = '0px'; });
          panel.addEventListener('transitionend', function te(){ cat.classList.remove('open'); panel.innerHTML=''; panel.style.maxHeight = '0px'; panel.removeEventListener('transitionend', te); }, {once:true});
        }
        return;
      }

      const selectAll = e.target.closest('.select-all-btn');
      if(selectAll){ e.stopPropagation(); handleSelectAll(selectAll); return; }

      // –∫–ª–∏–∫–∏ –ø–æ —Å—Ç—Ä–æ–∫–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –Ω–µ –≤–ª–∏—è—é—Ç (—Ç–æ–ª—å–∫–æ —á–µ–∫–±–æ–∫—Å)
    }

    function renderCategoryProducts(cat){
      const panel = cat.querySelector('.category-products');
      const products = JSON.parse(cat.dataset.products||'[]');
      const filtered = currentQuery ? products.filter(p => (p.name||'').toLowerCase().includes(currentQuery)) : products;
      const allSelected = filtered.length>0 && filtered.every(p=>selectedProducts.has(p.id));

      panel.innerHTML = `
        <div class="select-all-container">
          <button class="select-all-btn" data-category-id="${cat.dataset.categoryId}">${allSelected? '‚úì –°–Ω—è—Ç—å –≤—Å–µ' : '+ –í—ã–±—Ä–∞—Ç—å –≤—Å–µ'}</button>
        </div>
        ${filtered.length ? filtered.map(p=>`
          <div class="product-item" data-product-id="${p.id}">
            <input id="prod-${p.id}" type="checkbox" class="product-checkbox" ${selectedProducts.has(p.id)?'checked':''} />
            <span class="product-label">${escapeHtml(p.name)}</span>
          </div>
        `).join('') : `<div style="padding:14px 16px; color:#667085;">–ù–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π</div>`}
      `;
    }

    function handleCheckboxChange(cb){
      const id = cb.id.replace('prod-','');
      if(cb.checked) selectedProducts.add(id); else selectedProducts.delete(id);
      const cat = cb.closest('.category');
      if(cat) updateCategoryCount(cat);
      updateTotalSelected();
    }

    function handleSelectAll(btn){
      const cat = document.querySelector(`.category[data-category-id="${btn.dataset.categoryId}"]`);
      const panel = cat.querySelector('.category-products');
      const boxes = panel.querySelectorAll('.product-checkbox');
      const allChecked = boxes.length>0 && Array.from(boxes).every(cb=>cb.checked);
      boxes.forEach(cb=>{
        cb.checked = !allChecked;
        handleCheckboxChange(cb); // —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç selectedProducts –∏ —Å—á—ë—Ç—á–∏–∫–∏
      });
      btn.textContent = allChecked ? '+ –í—ã–±—Ä–∞—Ç—å –≤—Å–µ' : '‚úì –°–Ω—è—Ç—å –≤—Å–µ';
    }

    function updateCategoryCount(cat){
      const products = JSON.parse(cat.dataset.products||'[]');
      const count = products.filter(p=>selectedProducts.has(p.id)).length;
      const total = products.length;
      const countEl = cat.querySelector('.category-count');
      if(countEl) countEl.textContent = `${count}/${total}`;
      const panel = cat.querySelector('.category-products');
      const btn = panel.querySelector('.select-all-btn');
      if(btn){
        const visibleBoxes = panel.querySelectorAll('.product-checkbox');
        const allChecked = visibleBoxes.length>0 && Array.from(visibleBoxes).every(cb=>cb.checked);
        btn.textContent = allChecked ? '‚úì –°–Ω—è—Ç—å –≤—Å–µ' : '+ –í—ã–±—Ä–∞—Ç—å –≤—Å–µ';
      }
    }

    function applySearch(){
      const cats = document.querySelectorAll('.category');
      cats.forEach(cat=>{
        const products = JSON.parse(cat.dataset.products||'[]');
        const hasMatch = !currentQuery || products.some(p => (p.name||'').toLowerCase().includes(currentQuery));
        cat.style.display = hasMatch ? '' : 'none';
        const panel = cat.querySelector('.category-products');
        if(currentQuery){
          if(hasMatch){
            if(!cat.classList.contains('open')) cat.classList.add('open');
            renderCategoryProducts(cat);
            panel.style.maxHeight = 'none';
          } else {
            cat.classList.remove('open'); panel.innerHTML=''; panel.style.maxHeight='0';
          }
        } else {
          cat.classList.remove('open'); panel.innerHTML=''; panel.style.maxHeight='0';
        }
      });
    }

    /* —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏ –∏ –¥–µ—Ä–≥–∞–Ω–∏–π) */
    function collapseAllCategories(){
      document.querySelectorAll('.category').forEach(cat=>{
        const panel = cat.querySelector('.category-products');
        cat.classList.remove('open');
        if(panel){
          panel.innerHTML = '';
          panel.style.maxHeight = '0px';
        }
      });
    }

    // === –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å –ø–æ—Å–ª–µ–¥—É—é—â–∏–º —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ–º –∏ –æ—á–∏—Å—Ç–∫–æ–π –ø–æ–∏—Å–∫–∞ ===
    async function saveUserData() {
      try {
        const button = document.getElementById('saveButton');
        if (selectedProducts.size === 0) return;

        button.disabled = true;
        button.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

        const productsString = Array.from(selectedProducts).join(',');

        const formData = new FormData();
        formData.append('action', 'save_user_data');
        formData.append('initData', tg.initData || '');
        formData.append('products', productsString);

        const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.status === 'SUCCESS' && data.success) {
          // 1) —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
          collapseAllCategories();

          // 2) –æ—á–∏—â–∞–µ–º –ø–æ–∏—Å–∫ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫ –¥–µ—Ñ–æ–ª—Ç—É
          searchInput.value = '';
          currentQuery = '';
          searchClear.classList.remove('visible');
          applySearch();

          // 3) –ø—Ä—è—á–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –∞–∫–∫—É—Ä–∞—Ç–Ω–æ
          searchInput.blur();
          const wasDisabled = searchInput.disabled;
          searchInput.disabled = true;
          setTimeout(() => { searchInput.disabled = wasDisabled; }, 50);

          showSuccess('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
          button.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
          setTimeout(() => {
            button.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            button.disabled = selectedProducts.size===0;
          }, 1500);
        } else {
          throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        }
      } catch (error) {
        showError(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`);
        const button = document.getElementById('saveButton');
        button.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        button.disabled = selectedProducts.size===0;
      }
    }

    async function showManual(){
      const overlay = document.getElementById('modalOverlay'); const textEl = document.getElementById('modalText'); overlay.classList.add('active');
      const now = Date.now();
      if(manualCache && (now - manualCacheTime < MANUAL_CACHE_DURATION)){ textEl.textContent = manualCache; return; }
      textEl.innerHTML = '<div class="modal-loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏...</div>';
      try{
        const res = await fetch(`${CONFIG.APPS_SCRIPT_URL}?action=get_manual&initData=${encodeURIComponent(tg.initData||'')}`);
        let manual; try{ const j = await res.json(); manual = j.manual || j.text || JSON.stringify(j,null,2); }catch{ manual = await res.text(); }
        manualCache = manual; manualCacheTime = now; textEl.textContent = manual;
      }catch(err){ textEl.innerHTML = `<span style="color:#c62828">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å: ${escapeHtml(err.message)}</span>`; }
    }

    function updateTotalSelected(){ document.getElementById('selectedCount').textContent = selectedProducts.size; document.getElementById('saveButton').disabled = selectedProducts.size===0; }
    function showError(msg){ const c=document.querySelector('.container'); const ex=c.querySelector('.error'); if(ex) ex.remove(); const el=document.createElement('div'); el.className='error'; el.textContent=msg; c.insertBefore(el,c.firstChild); setTimeout(()=>el.remove(),5000); }
    function showSuccess(msg){ const c=document.querySelector('.container'); const ex=c.querySelector('.success'); if(ex) ex.remove(); const el=document.createElement('div'); el.className='success'; el.textContent=msg; c.insertBefore(el,c.firstChild.nextSibling); setTimeout(()=>el.remove(),3000); }
    const escapeHtml = s => (s||'').replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
  </script>
</body>
</html>
