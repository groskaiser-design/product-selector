<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>–í—ã–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤ Ultima</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
  /* üî• –°–ö–†–´–í–ê–ï–ú –°–ö–†–û–õ–õ–ë–ê–† –í–ï–ó–î–ï */
  *::-webkit-scrollbar { display: none; width: 0; height: 0; }
  * { -ms-overflow-style: none; scrollbar-width: none; }
  
  :root {
    --bg-core: #050505;
    --text-main: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.55);
    --surface-glass: rgba(255, 255, 255, 0.07);
    --surface-dark: rgba(0, 0, 0, 0.3);
    --surface-border: rgba(255, 255, 255, 0.1);
    --surface-border-light: rgba(255, 255, 255, 0.2);
    --acc-blue: #0a84ff;
    --acc-green: #30d158;
    --acc-red: #ff453a; 
    --okA: #4facfe; 
    --okB: #0a84ff;
    --radius-xl: 28px;
    --radius-l: 24px;
    --radius-m: 16px;
    --pad-x: 16px; 
    --gap: 8px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent !important; }
  html, body, button, .cat-card, .product-row, .btn-save { touch-action: manipulation; }

  body {
    background-color: var(--bg-core) !important;
    color: var(--text-main);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', Roboto, Helvetica, Arial, sans-serif;
    height: 100vh; overflow: hidden; display: flex; flex-direction: column;
    -webkit-font-smoothing: antialiased;
  }

  /* --- FX LAYER --- */
  .fx-layer { 
    position: fixed; top: 0; left: 0; width: 100vw; height: 100lvh; 
    z-index: 0; pointer-events: none; transform: translate3d(0,0,0); 
  }
  .orb { position: absolute; border-radius: 50%; will-change: transform; animation: float 30s infinite linear; }
  .orb-1 { width: 90vw; height: 90vw; opacity: 0.4; background: radial-gradient(circle, rgba(108, 92, 231, 0.8) 0%, transparent 70%); top: -20%; left: -20%; }
  .orb-2 { width: 400px; height: 400px; opacity: 0.5; background: radial-gradient(circle, rgba(108, 92, 231, 0.8) 0%, transparent 70%); top: 80%; right: -100px; animation: breathe 6s infinite ease-in-out; }
  .noise { position: fixed; inset: 0; z-index: 0; opacity: 0.04; background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); pointer-events: none; }
  @keyframes float { 0% {transform:rotate(0deg)} 100% {transform:rotate(360deg)} }
  @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.4; } 50% { transform: scale(1.1); opacity: 0.6; } }

  /* --- LAYOUT --- */
  .app-header {
    position: relative; z-index: 10; padding: 12px var(--pad-x) 4px;
    background: transparent !important; border: none !important; box-shadow: none !important;
  }
  
  .header-flex { display: flex; align-items: center; width: 100%; gap: 0; }

  /* Search Bar */
  .search-box { 
    position: relative; flex: 1; 
    transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
  }

  .search-input {
    width: 100%; height: 40px; background: var(--surface-dark);
    border: 1px solid var(--surface-border); border-top: 1px solid var(--surface-border-light);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-radius: 14px; padding: 0 36px 0 40px;
    color: #fff; font-size: 16px; font-weight: 500;
    transition: all 0.2s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    line-height: normal;
  }
  .search-input::placeholder { color: rgba(255,255,255,0.35); font-weight: 400; }
  .search-input:focus { background: rgba(0, 0, 0, 0.5); border-color: rgba(255, 255, 255, 0.25); outline: none; }

  .search-icon {
    position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
    color: rgba(255,255,255,0.4); pointer-events: none; z-index: 10;
    display: flex; align-items: center; justify-content: center; margin-top: 1px; 
  }
  .search-clear {
    position: absolute; right: 0; top: 0; bottom: 0; width: 36px;
    display: flex; align-items: center; justify-content: center;
    color: rgba(255,255,255,0.4); opacity: 0; pointer-events: auto; transition: opacity 0.2s;
  }
  .search-input:not(:placeholder-shown) ~ .search-clear { opacity: 1; }

  /* üî• –ï–î–ò–ù–ê–Ø –ö–ù–û–ü–ö–ê –î–ï–ô–°–¢–í–ò–Ø –í –•–ï–î–ï–†–ï */
  .header-action-btn {
    background: none; border: none;
    color: var(--acc-blue);
    font-size: 17px; font-weight: 500;
    padding: 0; width: 0; opacity: 0; overflow: hidden; white-space: nowrap;
    cursor: pointer; transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    text-align: right;
  }

  /* –ö–ª–∞—Å—Å .visible –¥–µ–ª–∞–µ—Ç –∫–Ω–æ–ø–∫—É –≤–∏–¥–∏–º–æ–π –∏ –æ—Ç–æ–¥–≤–∏–≥–∞–µ—Ç –∏–Ω–ø—É—Ç */
  .header-action-btn.visible {
    width: auto; 
    min-width: 90px; /* –ß—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –≤–ª–µ–∑–∞–ª */
    opacity: 1;
    padding-left: 12px;
  }

  /* --- VIEW CONTAINER --- */
  .views-container { position: relative; flex: 1; overflow: hidden; z-index: 1; }
  .view {
    position: absolute; inset: 0; overflow-y: auto; overflow-x: hidden;
    -webkit-overflow-scrolling: touch; padding: 12px var(--pad-x) 140px;
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s ease;
    opacity: 0; pointer-events: none; transform: translateX(30px);
    background: transparent;
  }
  .view.active { opacity: 1; pointer-events: auto; transform: translateX(0); }
  .view.prev { transform: translateX(-10%) scale(0.98); opacity: 0; pointer-events: none; }

  /* --- CATEGORY GRID --- */
  .cat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--gap); }
  .cat-card {
    background: linear-gradient(165deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: var(--radius-l) !important;
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.2) !important;
    padding: 14px; display: flex; flex-direction: column; justify-content: space-between;
    min-height: 110px; cursor: pointer; position: relative; overflow: hidden;
    transition: background 0.2s; will-change: transform;
  }
  .cat-icon { font-size: 20px; margin-bottom: 10px; filter: drop-shadow(0 4px 12px rgba(0,0,0,0.3)); }
  .cat-name { 
    font-size: 14px; font-weight: 500; line-height: 1.3; margin-bottom: 2px; color: #fff; letter-spacing: 0.3px; 
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; min-height: 2.6em;
  }
  .cat-meta {
    display: flex; flex-direction: column; align-items: flex-start; justify-content: flex-end;
    gap: 6px; font-size: 12px; color: rgba(255,255,255,0.55); font-weight: 500; margin-top: auto; width: 100%;
  }
  .mini-track { width: 40px; height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 2px; overflow: hidden; }
  .mini-fill { height: 100%; background: var(--acc-blue); border-radius: 2px; transition: width 0.3s ease; }

  /* --- HEADER LIST --- */
  .list-header-area { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding: 0 4px; }
  .list-title { font-size: 20px; font-weight: 800; letter-spacing: 0.3px; color: #fff; }

  /* --- PRODUCT LIST CONTAINER --- */
  .product-list-container {
    display: flex; flex-direction: column; gap: 8px;
    background: linear-gradient(165deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    padding: 14px; border-radius: 20px; backdrop-filter: blur(10px);
    min-height: 50px;
  }

  .product-row {
    display: flex; align-items: center; justify-content: flex-start; gap: 12px;
    padding: 12px 14px; border-radius: 12px; position: relative; cursor: pointer; background: transparent;
    transition: background 0.15s ease; will-change: transform; opacity: 1;
  }
  .product-row.selected { background: transparent; } 
  .bump { animation: bump 0.15s cubic-bezier(0.34, 1.56, 0.64, 1) !important; }
  @keyframes bump { 0% { transform: scale(1); } 50% { transform: scale(0.95); } 100% { transform: scale(1); } }

  .prod-info { flex: 1; z-index: 2; display: flex; flex-direction: column; gap: 3px; }
  .prod-name { font-size: 14px; font-weight: 400; color: #fff; line-height: 1.3; }
  .prod-meta { font-size: 12px; color: rgba(255,255,255,0.5); font-weight: 500; letter-spacing: 0.2px; }
  
  .check-square {
    width: 22px; height: 22px; border-radius: 6px; border: 2px solid rgba(255,255,255,.65);
    display: inline-flex; align-items: center; justify-content: center;
    flex-shrink: 0; transition: all .2s ease; background: transparent;
  }
  .check-square::after {
    content: ""; width: 12px; height: 12px; border-radius: 3px; background: #fff;
    opacity: 0; transform: scale(.7); transition: all .2s ease;
  }
  .product-row.selected .check-square {
    background: linear-gradient(135deg, var(--okA), var(--okB)); border-color: var(--okB); transform: scale(1.05);
  }
  .product-row.selected .check-square::after { opacity: 1; transform: scale(1); }

  /* --- FLOATING SAVE BUTTON --- */
  .save-floater { position: absolute; bottom: 34px; left: 0; right: 0; display: flex; justify-content: center; z-index: 30; pointer-events: none; }
  .btn-save {
    position: relative; z-index: 100; isolation: isolate; pointer-events: auto; 
    background: transparent; border: none; height: auto; min-width: 160px; padding: 14px 28px;
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', Roboto, sans-serif;
    font-size: 16px; font-weight: 600; color: #fff;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    cursor: pointer; transition: transform 0.2s; transform: translateY(100px); opacity: 0;
  }
  .btn-save::before {
    content: ""; position: absolute; z-index: -2; top: -8px; bottom: -8px; left: -8px; right: -8px;
    border-radius: 24px; background: rgba(255, 255, 255, 0.15); 
    backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.05); pointer-events: none;
  }
  .btn-save::after {
    content: ""; position: absolute; z-index: -1; inset: 0; border-radius: 16px; 
    background: linear-gradient(135deg, var(--okA), var(--okB)); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); transition: transform 0.1s;
  }
  .btn-save.visible { transform: translateY(0); opacity: 1; }
  .btn-save:active { transform: scale(0.96); }
 
  .empty-state {
    display: flex; flex-direction: column; align-items: center; margin-top: 60px;
    color: var(--text-muted); padding: 20px; background: var(--surface-dark);
    border-radius: 24px; border: 1px solid var(--surface-border); backdrop-filter: blur(10px);
  }
  #sentinel { height: 20px; width: 100%; opacity: 0; pointer-events: none; }

  body.search-active .btn-save { transform: translateY(150px) !important; opacity: 0 !important; pointer-events: none !important; }
  .simple-no-results { width: 100%; height: 30vh; display: flex; align-items: center; justify-content: center; color: rgba(255, 255, 255, 0.4); font-size: 17px; font-weight: 500; }
  
</style>
</head>
<body>

<div class="fx-layer">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="noise"></div>
</div>

<div class="app-header">
  <div class="header-flex">
    
    <div class="search-box">
      <div class="search-icon">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      </div>
      <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤" id="searchInput" onfocus="enterSearchMode()">
      
      <div class="search-clear" id="searchClear">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </div>
    </div>

    <button class="header-action-btn" id="btnHeaderAction">–û—Ç–º–µ–Ω–∞</button>
  
  </div>
</div>

<div class="views-container">
  
  <div class="view active" id="view-cats">
    <div class="cat-grid" id="catGrid"></div>
  </div>

  <div class="view" id="view-list">
    <div class="list-header-area">
      <h2 class="list-title" id="catTitle">–ù–∞–∑–≤–∞–Ω–∏–µ</h2>
      </div>
    <div class="product-list-container" id="productList"></div>
    <div id="sentinel"></div>
  </div>

  <div class="view" id="view-search">
    <div class="product-list-container" id="searchResults" style="display:none; background:transparent!important; border:none!important; box-shadow:none!important; backdrop-filter:none!important;"></div>
  </div>

</div>

<div class="save-floater">
  <button class="btn-save" id="btnSave" onclick="saveSelection()">
    <span id="saveBtnText">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
  </button>
</div>

<script>
  // üü¢ 1. FIREBASE CONFIG
  const firebaseConfig = {}; // Add config here if needed

  let db = null;
  try {
    if (firebaseConfig.apiKey) {
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      db.enablePersistence().catch(err => console.log("Persistence error:", err));
    }
  } catch(e) { console.log("Firebase skipped", e); }

  // üü¢ 2. MOCK DATA GENERATOR
  function generateBigData() {
    const catsData = [
      {n:'–ë–µ–ª–∫–∏', i:'ü•©'}, {n:'–ö—Ä—É–ø—ã', i:'üçö'}, {n:'–û–≤–æ—â–∏', i:'ü•¶'}, 
      {n:'–§—Ä—É–∫—Ç—ã', i:'üçé'}, {n:'–ñ–∏—Ä—ã', i:'ü•ë'}, {n:'–°–Ω–µ–∫–∏', i:'üç´'},
      {n:'–ú–æ–ª–æ—á–∫–∞', i:'ü•õ'}, {n:'–í—ã–ø–µ—á–∫–∞', i:'ü•ñ'}, {n:'–†—ã–±–∞', i:'üêü'},
      {n:'–ù–∞–ø–∏—Ç–∫–∏', i:'ü•§'}, {n:'–ó–∞–º–æ—Ä–æ–∑–∫–∞', i:'üßä'}, {n:'–ö–æ–Ω—Å–µ—Ä–≤—ã', i:'ü•´'},
      {n:'–°–ø–µ—Ü–∏–∏', i:'üßÇ'}, {n:'–°–æ—É—Å—ã', i:'ü•£'}, {n:'–ë—ã—Ç–æ–≤–∞—è', i:'üßπ'},
      {n:'–ó–æ–æ—Ç–æ–≤–∞—Ä—ã', i:'üê∂'}, {n:'–î–µ—Ç—Å–∫–æ–µ', i:'üë∂'}, {n:'–ê–ª–∫–æ–≥–æ–ª—å', i:'üç∑'},
      {n:'–ü–∞—Å—Ç–∞', i:'üçù'}, {n:'–í–µ–≥–∞–Ω', i:'ü•ó'}
    ];
    return catsData.map((cat, idx) => {
        const isHugeCategory = (idx === 2);
        const itemCount = isHugeCategory ? 200 : Math.floor(Math.random() * 8) + 4;
        const items = [];
        for(let i=0; i<itemCount; i++) {
            let name = `${cat.n} –ü—Ä–æ–¥—É–∫—Ç ${i+1}`;
            if (isHugeCategory && i % 3 === 0) name = `${cat.n} –î–ª–∏–Ω–Ω–æ–µ –ù–∞–∑–≤–∞–Ω–∏–µ ${i+1}`;
            items.push({
                id: `p_${idx}_${i}`,
                name: name,
                meta: `${100 + i} –∫–∫–∞–ª ¬∑ ${10 + (i%10)}–ë`
            });
        }
        return { id: `c${idx}`, name: cat.n, icon: cat.i, items: items };
    });
  }
  const MOCK_DB = generateBigData();

  // üü¢ 3. DATA SERVICE
  const DataService = {
    categories: [],
    productsMap: {},
    async init() {
      const cached = localStorage.getItem('ultima_products_v1');
      if (cached) {
        const data = JSON.parse(cached);
        this.categories = data.categories;
        this.productsMap = data.productsMap;
        renderCategories(); 
      } else {
        this.loadMock(); 
        renderCategories();
      }
      if (db) this.fetchFromFirebase();
    },
    loadMock() {
      this.categories = MOCK_DB.map(c => ({id:c.id, name:c.name, icon:c.icon}));
      MOCK_DB.forEach(c => { this.productsMap[c.id] = c.items; });
    },
    async fetchFromFirebase() {
      try {
        const catsSnap = await db.collection('categories').orderBy('order').get();
        const newCats = []; const newMap = {};
        if (!catsSnap.empty) {
            catsSnap.forEach(doc => {
                const d = doc.data();
                newCats.push({id: doc.id, name: d.name, icon: d.icon});
            });
            const prodsSnap = await db.collectionGroup('products').get();
            prodsSnap.forEach(doc => {
               const p = doc.data();
               if (!newMap[p.categoryId]) newMap[p.categoryId] = [];
               newMap[p.categoryId].push({id: doc.id, name: p.name, meta: p.meta});
            });
            this.categories = newCats;
            this.productsMap = newMap;
            localStorage.setItem('ultima_products_v1', JSON.stringify({categories: this.categories, productsMap: this.productsMap}));
            if (!state.activeCatId && !state.searchMode) renderCategories();
        }
      } catch(e) { console.warn("Offline/DB err", e); }
    },
    getProducts(catId) { return this.productsMap[catId] || []; },
    search(query) {
      const res = []; const q = query.toLowerCase();
      Object.values(this.productsMap).flat().forEach(p => {
        if (p.name.toLowerCase().includes(q)) res.push(p);
      });
      return res;
    }
  };

  // üü¢ 4. STATE
  const state = {
    selected: new Set(),
    activeCatId: null,
    searchMode: false,
    renderQueue: [],
    renderIndex: 0,
    BATCH_SIZE: 20,
    currentContainer: null
  };

  function loadSelectionFromCache() {
    try {
      const saved = localStorage.getItem('ultima_cart_v1');
      if (saved) state.selected = new Set(JSON.parse(saved));
    } catch(e) {}
  }

  function saveSelectionToCache() {
    try {
      const arr = Array.from(state.selected);
      localStorage.setItem('ultima_cart_v1', JSON.stringify(arr));
    } catch(e) {}
  }

  const el = {
    catGrid: document.getElementById('catGrid'),
    productList: document.getElementById('productList'),
    viewCats: document.getElementById('view-cats'),
    viewList: document.getElementById('view-list'),
    viewSearch: document.getElementById('view-search'),
    catTitle: document.getElementById('catTitle'),
    searchInput: document.getElementById('searchInput'),
    searchClear: document.getElementById('searchClear'),
    searchResults: document.getElementById('searchResults'),
    // üî• –ù–û–í–ê–Ø –°–°–´–õ–ö–ê –ù–ê –ö–ù–û–ü–ö–£
    btnHeaderAction: document.getElementById('btnHeaderAction'),
    btnSave: document.getElementById('btnSave'),
    saveBtnText: document.getElementById('saveBtnText'),
    sentinel: document.getElementById('sentinel')
  };

  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.ready(); tg.expand();
    try { tg.setHeaderColor('#050505'); tg.setBackgroundColor('#050505'); } catch(e){}
    tg.BackButton.onClick(() => {
      if (state.searchMode) exitSearchMode();
      else if (state.activeCatId) goBack();
      else window.location.href = 'router.html'; 
    });
  }

  // üü¢ UTILS & INIT
  function haptic(type = 'light') {
    try {
      const t = window.Telegram?.WebApp?.HapticFeedback;
      if (t) type==='light'?t.impactOccurred('light'):type==='medium'?t.impactOccurred('medium'):t.notificationOccurred('success');
    } catch(e) {}
  }
  const bump = el => { if(!el) return; el.classList.remove('bump'); void el.offsetWidth; el.classList.add('bump'); };

  document.addEventListener('touchstart', (e) => {
    const el = e.target.closest('.cat-card, .btn-save');
    if (!el) return; haptic('light'); bump(el);
  }, {passive: true});

  function init() {
    let viewportWidth = window.innerWidth;
    const fxLayer = document.querySelector('.fx-layer');
    const fixBackground = () => { fxLayer.style.height = window.innerHeight + 'px'; viewportWidth = window.innerWidth; };
    fixBackground(); 
    window.addEventListener('resize', () => { if (window.innerWidth !== viewportWidth) fixBackground(); });

    loadSelectionFromCache(); 
    DataService.init(); 
    
    // Initial UI Setup
    updateSaveButton();
    updateHeaderAction(); // üî• –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
    
    el.searchInput.addEventListener('input', handleSearch);
    el.searchClear.addEventListener('click', clearSearch);
    
    if(tg) tg.BackButton.show();
    const observer = new IntersectionObserver((entries) => {
      if (entries[0].isIntersecting) renderNextBatch();
    }, { rootMargin: '200px' });
    observer.observe(el.sentinel);
  }

  // üî•üî•üî• –°–¢–†–û–ì–ê–Ø –õ–û–ì–ò–ö–ê –ï–î–ò–ù–û–ô –ö–ù–û–ü–ö–ò (HEADER ACTION) üî•üî•üî•
  function updateHeaderAction() {
    const btn = el.btnHeaderAction;
    
    // –°–±—Ä–æ—Å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤, —á—Ç–æ–±—ã –Ω–µ –Ω–∞–∫–ª–∞–¥—ã–≤–∞–ª–∏—Å—å
    btn.onclick = null;
    
    // 1. –°—Ü–µ–Ω–∞—Ä–∏–π: –ü–û–ò–°–ö (–°–∞–º—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π)
    if (state.searchMode) {
        btn.classList.add('visible');
        if (state.selected.size > 0) {
             btn.textContent = '–í—ã–±—Ä–∞—Ç—å'; // –í—ã–±—Ä–∞–Ω–æ —á—Ç–æ-—Ç–æ –≤ –ø–æ–∏—Å–∫–µ
             btn.style.fontWeight = '600';
             btn.style.color = 'var(--acc-blue)';
             btn.onclick = () => exitSearchMode(); 
        } else {
             btn.textContent = '–û—Ç–º–µ–Ω–∞';
             btn.style.fontWeight = '500';
             btn.style.color = 'var(--acc-blue)';
             btn.onclick = () => exitSearchMode();
        }
        return;
    }

    // 2. –°—Ü–µ–Ω–∞—Ä–∏–π: –í–ù–£–¢–†–ò –ö–ê–¢–ï–ì–û–†–ò–ò
    if (state.activeCatId) {
        btn.classList.add('visible');
        btn.style.fontWeight = '500';
        btn.style.color = 'var(--acc-blue)';
        
        const products = DataService.getProducts(state.activeCatId);
        const hasProducts = products.length > 0;
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω—ã –ª–∏ –í–°–ï —Ç–æ–≤–∞—Ä—ã –ò–ú–ï–ù–ù–û –≠–¢–û–ô –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        const allSelected = hasProducts && products.every(p => state.selected.has(p.id));
        
        if (allSelected && hasProducts) {
            btn.textContent = '–£–±—Ä–∞—Ç—å –≤—Å—ë';
            btn.onclick = () => toggleAllInCategory(products, false);
        } else {
            btn.textContent = '–í—ã–±—Ä–∞—Ç—å –≤—Å—ë';
            btn.onclick = () => toggleAllInCategory(products, true);
        }
        return;
    }

    // 3. –°—Ü–µ–Ω–∞—Ä–∏–π: –ì–õ–ê–í–ù–ê–Ø (Home)
    // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É. –ï—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ -> "–í—ã–±—Ä–∞—Ç—å –≤—Å—ë" (–≥–ª–æ–±–∞–ª—å–Ω–æ).
    // –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—å –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä -> "–£–±—Ä–∞—Ç—å –≤—Å—ë".
    btn.classList.add('visible');
    btn.style.fontWeight = '500';
    
    if (state.selected.size > 0) {
        btn.textContent = '–£–±—Ä–∞—Ç—å –≤—Å—ë';
        btn.style.color = 'var(--acc-red)'; // –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è —Å–±—Ä–æ—Å–∞
        btn.onclick = () => toggleGlobalSelection(false);
    } else {
        btn.textContent = '–í—ã–±—Ä–∞—Ç—å –≤—Å—ë';
        btn.style.color = 'var(--acc-blue)';
        btn.onclick = () => toggleGlobalSelection(true);
    }
  }

  // –õ–æ–≥–∏–∫–∞ "–í—ã–±—Ä–∞—Ç—å –≤—Å—ë / –£–±—Ä–∞—Ç—å –≤—Å—ë" –ì–õ–û–ë–ê–õ–¨–ù–û (–Ω–∞ –≥–ª–∞–≤–Ω–æ–π)
  function toggleGlobalSelection(selectAll) {
    haptic('medium');
    
    if (selectAll) {
        // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã
        Object.values(DataService.productsMap).flat().forEach(p => state.selected.add(p.id));
    } else {
        // –û—á–∏—â–∞–µ–º
        if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É –ø–æ–ª–Ω–æ—Å—Ç—å—é?')) {
            state.selected.clear();
        } else {
            return; // –û—Ç–º–µ–Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è
        }
    }
    
    saveSelectionToCache();
    renderCategories(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã
    updateSaveButton();
    updateHeaderAction();
  }

  function renderCategories() {
    el.catGrid.innerHTML = '';
    DataService.categories.forEach(cat => {
      const products = DataService.getProducts(cat.id);
      const total = products.length;
      const sel = products.filter(i => state.selected.has(i.id)).length;
      const progress = total > 0 ? (sel / total) * 100 : 0;
      
      const card = document.createElement('div');
      card.className = 'cat-card';
      card.onclick = () => openCategory(cat.id);
      
      card.innerHTML = `
        <div style="width: 100%">
          <div class="cat-icon">${cat.icon}</div>
          <div class="cat-name">${cat.name}</div>
        </div>
        <div class="cat-meta">
          <span>${sel} –∏–∑ ${total}</span>
          <div class="mini-track">
             <div class="mini-fill" style="width: ${progress}%"></div>
          </div>
        </div>
      `;
      el.catGrid.appendChild(card);
    });
  }

  function openCategory(id) {
    state.activeCatId = id;
    const cat = DataService.categories.find(c => c.id === id);
    el.catTitle.textContent = cat.name;
    el.productList.style.display = 'flex';
    
    const products = DataService.getProducts(id);
    startInfiniteRender(products, el.productList);
    
    el.viewCats.classList.add('prev');
    el.viewCats.classList.remove('active');
    el.viewList.classList.add('active');
    el.viewList.classList.remove('next');
    
    updateSaveButton(); 
    updateHeaderAction(); // üî• –û–±–Ω–æ–≤–ª—è–µ–º —Ö–µ–¥–µ—Ä
    if(tg) tg.BackButton.show();
  }

  function goBack() {
    state.activeCatId = null;
    el.viewList.classList.remove('active');
    el.viewCats.classList.add('active');
    el.viewCats.classList.remove('prev');
    setTimeout(renderCategories, 300); 
    updateSaveButton();
    updateHeaderAction(); // üî• –û–±–Ω–æ–≤–ª—è–µ–º —Ö–µ–¥–µ—Ä
    if(tg) tg.BackButton.show(); 
  }

  function startInfiniteRender(items, container, isSearch = false) {
    container.innerHTML = '';
    container.style.cssText = ''; 
    if (items.length === 0 && isSearch) {
        container.innerHTML = '<div class="simple-no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
        return;
    }
    state.renderQueue = items;
    state.renderIndex = 0;
    let target = container;
    if (isSearch) {
        const wrapper = document.createElement('div');
        wrapper.className = 'product-list-container';
        wrapper.style.background = 'transparent'; wrapper.style.border = 'none'; wrapper.style.boxShadow = 'none';
        container.appendChild(wrapper); target = wrapper;
    }
    state.currentContainer = target;
    renderNextBatch(isSearch);
  }

  function renderNextBatch(isSearch = false) {
    if (state.renderIndex >= state.renderQueue.length) return;
    const batch = state.renderQueue.slice(state.renderIndex, state.renderIndex + state.BATCH_SIZE);
    const fragment = document.createDocumentFragment();
    batch.forEach((item, i) => {
      const isSel = state.selected.has(item.id);
      const row = document.createElement('div');
      row.className = `product-row ${isSel ? 'selected' : ''}`;
      row.addEventListener('touchstart', function() { haptic('light'); }, {passive: true});
      row.onclick = () => toggleProduct(item.id, row);
      if (!isSearch) {
        row.style.opacity = '0';
        row.style.animation = `fadeInUp 0.2s ease forwards ${i * 0.02}s`;
        setTimeout(() => { row.style.opacity = '1'; row.style.animation = 'none'; row.style.transform = 'none'; }, (i * 20) + 300);
      }
      row.innerHTML = `<div class="check-square"></div><div class="prod-info"><div class="prod-name">${item.name}</div><div class="prod-meta">${item.meta}</div></div>`;
      fragment.appendChild(row);
    });
    state.currentContainer.appendChild(fragment);
    state.renderIndex += state.BATCH_SIZE;
  }

  const styleSheet = document.createElement("style");
  styleSheet.innerText = `@keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }`;
  document.head.appendChild(styleSheet);

  function toggleProduct(id, rowEl) {
    if (state.selected.has(id)) {
      state.selected.delete(id); rowEl.classList.remove('selected');
    } else {
      state.selected.add(id); rowEl.classList.add('selected');
    }
    saveSelectionToCache(); 
    updateSaveButton();
    updateHeaderAction(); // üî• –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∫–ª–∏–∫–µ
  }

  function updateSaveButton() {
    let count = 0; let text = '';
    if (state.activeCatId) {
        const products = DataService.getProducts(state.activeCatId);
        count = products.filter(i => state.selected.has(i.id)).length;
        if (count > 0) text = `–í—ã–±—Ä–∞—Ç—å (${count})`;
        else text = `–ù–∞–∑–∞–¥`;
        el.btnSave.classList.add('visible'); 
    } else {
        count = state.selected.size;
        text = `–°–æ—Ö—Ä–∞–Ω–∏—Ç—å (${count})`;
        if (count > 0) el.btnSave.classList.add('visible');
        else el.btnSave.classList.remove('visible');
    }
    el.saveBtnText.textContent = text;
  }

  function toggleAllInCategory(products, select) {
    haptic('medium');
    products.forEach(i => {
      if (select) state.selected.add(i.id);
      else state.selected.delete(i.id);
    });
    saveSelectionToCache(); 
    startInfiniteRender(products, el.productList); 
    updateSaveButton();
    updateHeaderAction(); // üî• –û–±–Ω–æ–≤–ª—è–µ–º —Ö–µ–¥–µ—Ä
  }

  function handleSearch(e) {
    const query = e.target.value.toLowerCase().trim();
    if (query.length > 0) {
      if (!state.searchMode) enterSearchMode();
      const results = DataService.search(query);
      el.searchResults.style.display = 'block';
      startInfiniteRender(results, el.searchResults, true);
    } else {
      el.searchResults.innerHTML = '';
    }
  }

  function clearSearch() { exitSearchMode(); }

  function saveSelection() {
    haptic('success'); 
    if (state.activeCatId && !state.searchMode) { goBack(); return; }
    if (tg && tg.showPopup) {
       tg.showPopup({ title: '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', message: `–í—ã–±—Ä–∞–Ω–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤: ${state.selected.size}`, buttons: [{type: 'ok'}] }, function() { if (state.searchMode) exitSearchMode(); });
    } else {
       alert(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${state.selected.size} –ø—Ä–æ–¥—É–∫—Ç–æ–≤!`);
       if (state.searchMode) exitSearchMode();
    }
  }

  function enterSearchMode() {
    state.searchMode = true;
    document.body.classList.add('search-active');
    el.viewCats.classList.remove('active');
    el.viewList.classList.remove('active');
    el.viewSearch.classList.add('active');
    
    updateHeaderAction(); // üî• –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–û—Ç–º–µ–Ω–∞"
    updateSaveButton();   
    if(tg) tg.BackButton.show();
  }

  function exitSearchMode() {
    state.searchMode = false;
    document.body.classList.remove('search-active'); 
    el.searchInput.blur();
    el.viewSearch.classList.remove('active');
    el.searchResults.style.display = 'none';
    el.searchInput.value = '';
    
    if (state.activeCatId) el.viewList.classList.add('active');
    else {
        el.viewCats.classList.add('active');
        renderCategories();
    }
    updateSaveButton();
    updateHeaderAction(); // üî• –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –æ–±—ã—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  }
  
  init();
</script>
</body>
</html>
