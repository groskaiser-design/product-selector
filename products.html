<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>–í—ã–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤ Ultima</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root {
    /* --- PALETTE (Exact match from KBJU) --- */
    --bg-core: #050505;
    --text-main: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.55);
    
    /* --- GLASS SURFACES (Exact match from KBJU .macro-card) --- */
    /* –¢–µ–º–Ω–æ–µ —Å—Ç–µ–∫–ª–æ —Å —Å–∏–ª—å–Ω—ã–º –±–ª—é—Ä–æ–º */
    --surface-glass: rgba(0, 0, 0, 0.3);
    --surface-border: rgba(255, 255, 255, 0.1);
    --surface-highlight: rgba(255, 255, 255, 0.2); /* –í–µ—Ä—Ö–Ω–∏–π –±–ª–∏–∫ */
    
    /* --- ACCENTS --- */
    --acc-blue: #0a84ff;
    --acc-green: #30d158;
    
    /* --- METRICS --- */
    --radius-xl: 24px;
    --radius-l: 20px;
    --radius-m: 14px;
    --pad-x: 12px; /* –ü–ª–æ—Ç–Ω–µ–µ (–±—ã–ª–æ 16) */
    --bottom-bar-h: 64px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  
  body {
    background-color: var(--bg-core);
    color: var(--text-main);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', Roboto, sans-serif;
    height: 100vh;
    overflow: hidden; 
    display: flex;
    flex-direction: column;
  }

  /* --- FX LAYER (Exact code from KBJU/Breath) --- */
  .fx-layer { position: fixed; inset: 0; z-index: 0; pointer-events: none; transform: translate3d(0,0,0); }
  .orb { position: absolute; border-radius: 50%; will-change: transform; animation: float 30s infinite linear; }
  
  /* Orb 1: –ë–æ–ª—å—à–∞—è —Å–≤–µ—Ä—Ö—É */
  .orb-1 { 
    width: 90vw; height: 90vw; opacity: 0.4; 
    background: radial-gradient(circle, rgba(108, 92, 231, 0.8) 0%, transparent 70%); 
    top: -20%; left: -20%; 
  }
  
  /* Orb 2: –î—ã—à–∞—â–∞—è —Å–Ω–∏–∑—É */
  .orb-2 { 
    width: 400px; height: 400px; opacity: 0.5; 
    background: radial-gradient(circle, rgba(108, 92, 231, 0.8) 0%, transparent 70%); 
    bottom: -150px; right: -100px; 
    animation: breathe 6s infinite ease-in-out; 
  }

  @keyframes float { 0% {transform:rotate(0deg)} 100% {transform:rotate(360deg)} }
  @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.4; } 50% { transform: scale(1.1); opacity: 0.6; } }

  .noise { 
    position: fixed; inset: 0; z-index: 0; opacity: 0.04; 
    background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); 
    pointer-events: none; 
  }

  /* --- LAYOUT --- */
  .app-header {
    position: relative; z-index: 10;
    padding: 12px var(--pad-x) 4px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø */
    background: transparent; /* –ü–æ–ª–Ω–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å, –∫–∞–∫ –ø—Ä–æ—Å–∏–ª–∏ */
    flex-shrink: 0;
  }

  /* Search Bar (Floating Glass) */
  .search-box { position: relative; }
  .search-input {
    width: 100%; height: 40px; /* –ö–æ–º–ø–∞–∫—Ç–Ω–µ–µ */
    
    /* –°—Ç–∏–ª—å —Å—Ç–µ–∫–ª–∞, –∫–∞–∫ —É –∫–∞—Ä—Ç–æ—á–µ–∫ */
    background: var(--surface-glass);
    border: 1px solid var(--surface-border);
    border-top: 1px solid var(--surface-highlight); /* –ë–ª–∏–∫ —Å–≤–µ—Ä—Ö—É */
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    
    border-radius: 14px;
    padding: 0 36px 0 40px;
    color: #fff; font-size: 16px; font-weight: 500;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .search-input::placeholder { color: rgba(255,255,255,0.4); font-weight: 400; }
  .search-input:focus {
    background: rgba(0,0,0,0.5); /* –ß—É—Ç—å —Ç–µ–º–Ω–µ–µ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ */
    border-color: rgba(255, 255, 255, 0.3);
    outline: none;
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  }
  .search-icon {
    position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
    color: rgba(255,255,255,0.5); pointer-events: none;
  }
  .search-clear {
    position: absolute; right: 0; top: 0; bottom: 0; width: 36px;
    display: flex; align-items: center; justify-content: center;
    color: rgba(255,255,255,0.5); opacity: 0; pointer-events: none; transition: opacity 0.2s;
  }
  .search-input:not(:placeholder-shown) ~ .search-clear { opacity: 1; pointer-events: auto; }

  /* --- VIEW CONTAINER --- */
  .views-container {
    position: relative; flex: 1; overflow: hidden; z-index: 1;
  }
  
  .view {
    position: absolute; inset: 0;
    overflow-y: auto; overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
    padding: 8px var(--pad-x) 100px; /* –°–≤–µ—Ä—Ö—É –æ—Ç—Å—Ç—É–ø –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π */
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s ease;
    opacity: 0; pointer-events: none; transform: translateX(30px);
    background: transparent;
  }
  .view.active { opacity: 1; pointer-events: auto; transform: translateX(0); }
  .view.prev { transform: translateX(-10%) scale(0.98); opacity: 0; pointer-events: none; }

  /* --- CATEGORY GRID (Tighter & Premium) --- */
  .cat-grid {
    display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; /* –ü–ª–æ—Ç–Ω–∞—è —Å–µ—Ç–∫–∞ */
  }
  
  .cat-card {
    /* EXACT KBJU CARD STYLE */
    background: var(--surface-glass);
    border: 1px solid var(--surface-border);
    border-top: 1px solid var(--surface-highlight);
    border-radius: var(--radius-l); /* 20px */
    
    padding: 12px 14px; /* –ü–ª–æ—Ç–Ω–µ–µ */
    display: flex; flex-direction: column; justify-content: space-between;
    min-height: 96px; /* –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
    cursor: pointer; position: relative; overflow: hidden;
    transition: transform 0.1s, background 0.2s;
    
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  }
  .cat-card:active { transform: scale(0.96); background: rgba(255,255,255,0.05); }
  
  .cat-icon { font-size: 24px; margin-bottom: 8px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3)); }
  .cat-name { font-size: 14px; font-weight: 700; line-height: 1.1; margin-bottom: 2px; color: #fff; }
  .cat-meta { font-size: 11px; color: var(--text-muted); font-weight: 500; }
  
  /* Neon Progress Strip (Slim) */
  .cat-progress-track {
    position: absolute; bottom: 0; left: 0; right: 0; height: 2px; 
    background: rgba(255,255,255,0.05);
  }
  .cat-progress-fill {
    height: 100%; background: var(--acc-blue);
    width: 0%; transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 -1px 6px var(--acc-blue);
  }

  /* --- PRODUCT LIST --- */
  .list-header-area {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 8px; margin-top: 2px;
  }
  .btn-back {
    display: flex; align-items: center; gap: 4px;
    font-size: 14px; font-weight: 600; color: rgba(255,255,255,0.8);
    background: none; border: none; cursor: pointer; padding: 6px 0;
  }
  .btn-select-all {
    font-size: 12px; font-weight: 700; color: var(--acc-blue);
    background: rgba(10, 132, 255, 0.1);
    padding: 6px 10px; border-radius: 10px; border: 1px solid rgba(10, 132, 255, 0.15);
    cursor: pointer; transition: all 0.1s;
  }
  .btn-select-all:active { background: rgba(10, 132, 255, 0.25); transform: scale(0.96); }

  /* --- PRODUCT ROW (Dense & Animated) --- */
  .product-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px; /* –ü–ª–æ—Ç–Ω—ã–π –ø–∞–¥–¥–∏–Ω–≥ */
    margin-bottom: 6px;
    
    /* Glass Style */
    background: var(--surface-glass);
    border: 1px solid var(--surface-border);
    /* –£–±–∏—Ä–∞–µ–º border-top —É —Å–ø–∏—Å–∫–∞, —á—Ç–æ–±—ã –Ω–µ —Ä—è–±–∏–ª–æ, –∏–ª–∏ –¥–µ–ª–∞–µ–º —Å–ª–∞–±–µ–µ */
    border-top: 1px solid rgba(255,255,255,0.15);
    border-radius: 16px;
    
    cursor: pointer;
    /* –í–∞–∂–Ω–æ: transform –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ */
    transform: scale(1); 
    transition: background 0.15s ease, border-color 0.15s, box-shadow 0.15s;
    position: relative;
    overflow: hidden;
  }
  
  /* Selected State */
  .product-row.selected {
    background: linear-gradient(90deg, rgba(10, 132, 255, 0.15) 0%, rgba(10, 132, 255, 0.05) 100%);
    border-color: rgba(10, 132, 255, 0.4);
    border-top-color: rgba(10, 132, 255, 0.5);
    box-shadow: 0 0 15px rgba(10, 132, 255, 0.1);
  }
  
  /* BUMP ANIMATION (–§–∏–∑–∏–∫–∞ –Ω–∞–∂–∞—Ç–∏—è) */
  @keyframes bump { 
    0% { transform: scale(1); } 
    40% { transform: scale(0.96); } 
    100% { transform: scale(1); } 
  }
  .product-row.bump { 
    animation: bump 0.2s cubic-bezier(0.25, 1, 0.5, 1); 
  }

  .prod-info { flex: 1; z-index: 2; display: flex; flex-direction: column; gap: 1px; }
  .prod-name { font-size: 14px; font-weight: 600; color: #fff; line-height: 1.2; }
  .prod-meta { font-size: 11px; color: rgba(255,255,255,0.45); font-weight: 500; }
  
  /* Checkbox */
  .prod-check {
    width: 20px; height: 20px;
    border-radius: 50%;
    border: 1.5px solid rgba(255,255,255,0.25);
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s ease;
    background: rgba(0,0,0,0.2);
    z-index: 2; margin-left: 10px;
  }
  
  .product-row.selected .prod-check {
    background: var(--acc-blue);
    border-color: var(--acc-blue);
    transform: scale(1.1);
    box-shadow: 0 0 8px rgba(10, 132, 255, 0.6);
  }
  .prod-check svg { opacity: 0; transform: scale(0.5); transition: all 0.2s; }
  .product-row.selected .prod-check svg { opacity: 1; transform: scale(1); }

  /* --- BOTTOM BAR (Floating Glass) --- */
  .bottom-bar {
    position: absolute; bottom: 16px; left: 12px; right: 12px;
    height: 60px;
    
    background: rgba(20, 20, 20, 0.85); /* –ß—É—Ç—å —Ç–µ–º–Ω–µ–µ */
    backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
    border: 1px solid rgba(255,255,255,0.1);
    border-top: 1px solid rgba(255,255,255,0.2);
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    
    padding: 0 16px;
    display: flex; align-items: center; gap: 12px;
    z-index: 20;
    transform: translateY(150%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  .bottom-bar.visible { transform: translateY(0); }

  .bar-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
  .bar-count { font-size: 10px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; }
  .bar-val { font-size: 15px; font-weight: 800; color: #fff; }

  .btn-save {
    background: linear-gradient(135deg, var(--acc-blue), #0066cc);
    color: #fff; border: none;
    height: 36px; padding: 0 20px;
    border-radius: 12px;
    font-size: 14px; font-weight: 700;
    box-shadow: 0 4px 12px rgba(10, 132, 255, 0.3);
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: transform 0.1s, box-shadow 0.2s;
  }
  .btn-save:active { transform: scale(0.96); box-shadow: 0 2px 6px rgba(10, 132, 255, 0.2); }

  /* --- EMPTY STATE --- */
  .empty-state {
    text-align: center; margin-top: 60px; color: var(--text-muted);
  }
  .empty-icon { font-size: 40px; margin-bottom: 10px; opacity: 0.5; }

</style>
</head>
<body>

<!-- Background -->
<div class="fx-layer">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="noise"></div>
</div>

<!-- Header (Only Search) -->
<div class="app-header">
  <div class="search-box">
    <div class="search-icon">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    </div>
    <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤..." id="searchInput">
    <div class="search-clear" id="searchClear">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </div>
  </div>
</div>

<!-- Views Container -->
<div class="views-container">
  
  <!-- VIEW 1: Categories Grid -->
  <div class="view active" id="view-cats">
    <div class="cat-grid" id="catGrid">
      <!-- JS Injected -->
    </div>
  </div>

  <!-- VIEW 2: Product List -->
  <div class="view" id="view-list">
    <div class="list-header-area">
      <button class="btn-back" onclick="goBack()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        –ù–∞–∑–∞–¥
      </button>
      <button class="btn-select-all" id="btnSelectAll">–í—ã–±—Ä–∞—Ç—å –≤—Å—ë</button>
    </div>
    <h2 style="margin-bottom: 10px; font-size: 22px; font-weight: 800; letter-spacing: -0.5px; line-height: 1.1;" id="catTitle">–ù–∞–∑–≤–∞–Ω–∏–µ</h2>
    <div id="productList"></div>
  </div>

  <!-- VIEW 3: Search Results -->
  <div class="view" id="view-search">
    <div id="searchResults"></div>
  </div>

</div>

<!-- Floating Bottom Bar -->
<div class="bottom-bar visible" id="bottomBar">
  <div class="bar-info">
    <div class="bar-count">–í—ã–±—Ä–∞–Ω–æ</div>
    <div class="bar-val"><span id="totalCount">0</span> –ø—Ä–æ–¥—É–∫—Ç–æ–≤</div>
  </div>
  <button class="btn-save" onclick="saveSelection()">
    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
  </button>
</div>

<script>
  // --- MOCK DATA ---
  const DB = [
    { 
      id: 'c1', name: '–ë–µ–ª–∫–∏', icon: 'ü•©', 
      items: [
        { id: 'p1', name: '–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞', meta: '113 –∫–∫–∞–ª / 23.6 –ë' },
        { id: 'p2', name: '–ò–Ω–¥–µ–π–∫–∞ —Ñ–∏–ª–µ', meta: '115 –∫–∫–∞–ª / 24 –ë' },
        { id: 'p3', name: '–ì–æ–≤—è–¥–∏–Ω–∞ –ø–æ—Å—Ç–Ω–∞—è', meta: '180 –∫–∫–∞–ª / 20 –ë' },
        { id: 'p4', name: '–Ø–π—Ü–æ –∫—É—Ä–∏–Ω–æ–µ', meta: '86 –∫–∫–∞–ª / 7 –ë' },
        { id: 'p5', name: '–¢–≤–æ—Ä–æ–≥ 5%', meta: '121 –∫–∫–∞–ª / 16 –ë' },
        { id: 'p6', name: '–õ–æ—Å–æ—Å—å', meta: '208 –∫–∫–∞–ª / 20 –ë' },
      ]
    },
    { 
      id: 'c2', name: '–ö—Ä—É–ø—ã', icon: 'üçö', 
      items: [
        { id: 'p9', name: '–ì—Ä–µ—á–∫–∞', meta: '313 –∫–∫–∞–ª / 62 –£' },
        { id: 'p10', name: '–†–∏—Å –ë–∞—Å–º–∞—Ç–∏', meta: '350 –∫–∫–∞–ª / 78 –£' },
        { id: 'p11', name: '–û–≤—Å—è–Ω–∫–∞', meta: '360 –∫–∫–∞–ª / 65 –£' },
        { id: 'p12', name: '–ú–∞–∫–∞—Ä–æ–Ω—ã —Ç–≤/—Å', meta: '340 –∫–∫–∞–ª / 70 –£' },
        { id: 'p13', name: '–ö–∏–Ω–æ–∞', meta: '368 –∫–∫–∞–ª / 64 –£' },
      ]
    },
    { 
      id: 'c3', name: '–û–≤–æ—â–∏', icon: 'ü•¶', 
      items: [
        { id: 'p15', name: '–û–≥—É—Ä—Ü—ã', meta: '15 –∫–∫–∞–ª' },
        { id: 'p16', name: '–ü–æ–º–∏–¥–æ—Ä—ã', meta: '20 –∫–∫–∞–ª' },
        { id: 'p17', name: '–ë—Ä–æ–∫–∫–æ–ª–∏', meta: '34 –∫–∫–∞–ª' },
        { id: 'p18', name: '–®–ø–∏–Ω–∞—Ç', meta: '23 –∫–∫–∞–ª' },
        { id: 'p19', name: '–ë–æ–ª–≥–∞—Ä—Å–∫–∏–π –ø–µ—Ä–µ—Ü', meta: '27 –∫–∫–∞–ª' },
      ]
    },
    {
      id: 'c4', name: '–§—Ä—É–∫—Ç—ã', icon: 'üçé',
      items: [
        { id: 'p21', name: '–Ø–±–ª–æ–∫–æ', meta: '47 –∫–∫–∞–ª' },
        { id: 'p22', name: '–ë–∞–Ω–∞–Ω', meta: '89 –∫–∫–∞–ª' },
        { id: 'p23', name: '–ê–ø–µ–ª—å—Å–∏–Ω', meta: '43 –∫–∫–∞–ª' },
        { id: 'p24', name: '–ì–æ–ª—É–±–∏–∫–∞', meta: '57 –∫–∫–∞–ª' },
      ]
    },
    {
      id: 'c5', name: '–ñ–∏—Ä—ã', icon: 'ü•ë',
      items: [
        { id: 'p25', name: '–û–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ', meta: '884 –∫–∫–∞–ª' },
        { id: 'p26', name: '–ê–≤–æ–∫–∞–¥–æ', meta: '160 –∫–∫–∞–ª' },
        { id: 'p27', name: '–ì—Ä–µ—Ü–∫–∏–π –æ—Ä–µ—Ö', meta: '654 –∫–∫–∞–ª' },
        { id: 'p28', name: '–ú–∏–Ω–¥–∞–ª—å', meta: '579 –∫–∫–∞–ª' },
      ]
    },
    {
      id: 'c6', name: '–°–Ω–µ–∫–∏', icon: 'üç´',
      items: [
        { id: 'p30', name: '–ü—Ä–æ—Ç–µ–∏–Ω–æ–≤—ã–π –±–∞—Ç–æ–Ω—á–∏–∫', meta: '200 –∫–∫–∞–ª' },
        { id: 'p31', name: '–•–ª–µ–±—Ü—ã', meta: '300 –∫–∫–∞–ª' },
      ]
    }
  ];

  // --- STATE ---
  const state = {
    selected: new Set(),
    activeCatId: null,
    searchMode: false
  };

  // --- DOM ELEMENTS ---
  const el = {
    catGrid: document.getElementById('catGrid'),
    productList: document.getElementById('productList'),
    viewCats: document.getElementById('view-cats'),
    viewList: document.getElementById('view-list'),
    viewSearch: document.getElementById('view-search'),
    catTitle: document.getElementById('catTitle'),
    totalCount: document.getElementById('totalCount'),
    btnSelectAll: document.getElementById('btnSelectAll'),
    searchInput: document.getElementById('searchInput'),
    searchClear: document.getElementById('searchClear'),
    searchResults: document.getElementById('searchResults'),
    bottomBar: document.getElementById('bottomBar')
  };

  // --- HAPTIC HELPER (Safe) ---
  function haptic(type = 'light') {
    try {
      const tg = window.Telegram?.WebApp?.HapticFeedback;
      if (!tg) return;
      if (type === 'light') tg.impactOccurred('light');
      if (type === 'medium') tg.impactOccurred('medium');
      if (type === 'heavy') tg.impactOccurred('heavy');
      if (type === 'success') tg.notificationOccurred('success');
      if (type === 'changed') tg.selectionChanged();
    } catch(e) {}
  }

  // --- INIT ---
  function init() {
    // Pre-select some for demo
    ['p1', 'p2', 'p15'].forEach(id => state.selected.add(id));
    
    renderCategories();
    updateBottomBar();
    
    // Listeners
    el.searchInput.addEventListener('input', handleSearch);
    el.searchClear.addEventListener('click', clearSearch);
  }

  // --- RENDER CATEGORIES ---
  function renderCategories() {
    el.catGrid.innerHTML = '';
    
    DB.forEach(cat => {
      const totalItems = cat.items.length;
      const selectedItems = cat.items.filter(i => state.selected.has(i.id)).length;
      const progress = (selectedItems / totalItems) * 100;
      
      const card = document.createElement('div');
      card.className = 'cat-card';
      card.onclick = () => openCategory(cat.id);
      
      card.innerHTML = `
        <div>
          <div class="cat-icon">${cat.icon}</div>
          <div class="cat-name">${cat.name}</div>
          <div class="cat-meta">${selectedItems} –∏–∑ ${totalItems}</div>
        </div>
        <div class="cat-progress-track">
          <div class="cat-progress-fill" style="width: ${progress}%"></div>
        </div>
      `;
      el.catGrid.appendChild(card);
    });
  }

  // --- NAVIGATION ---
  function openCategory(id) {
    haptic('light');
    state.activeCatId = id;
    const cat = DB.find(c => c.id === id);
    
    el.catTitle.textContent = cat.name;
    renderProductList(cat.items, el.productList);
    updateSelectAllBtn(cat);

    // Slide Transition
    el.viewCats.classList.add('prev');
    el.viewCats.classList.remove('active');
    el.viewList.classList.add('active');
    el.viewList.classList.remove('next');
  }

  function goBack() {
    haptic('light');
    state.activeCatId = null;
    
    // Slide Back
    el.viewList.classList.remove('active');
    el.viewCats.classList.add('active');
    el.viewCats.classList.remove('prev');
    
    // Re-render to update progress bars
    setTimeout(renderCategories, 300); 
  }

  // --- RENDER LIST ---
  function renderProductList(items, container) {
    container.innerHTML = '';
    
    items.forEach((item, index) => {
      const isSel = state.selected.has(item.id);
      const row = document.createElement('div');
      row.className = `product-row ${isSel ? 'selected' : ''}`;
      row.onclick = () => toggleProduct(item.id, row);
      
      // Stagger animation for list items
      row.style.animation = `fadeInUp 0.2s ease forwards ${index * 0.02}s`;
      row.style.opacity = '0';
      row.style.transform = 'translateY(8px)';
      
      row.innerHTML = `
        <div class="prod-info">
          <div class="prod-name">${item.name}</div>
          <div class="prod-meta">${item.meta}</div>
        </div>
        <div class="prod-check">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        </div>
      `;
      container.appendChild(row);
    });
  }

  // Add keyframes for staggered list
  const styleSheet = document.createElement("style");
  styleSheet.innerText = `
    @keyframes fadeInUp {
      to { opacity: 1; transform: translateY(0); }
    }
  `;
  document.head.appendChild(styleSheet);

  // --- INTERACTION ---
  function toggleProduct(id, rowEl) {
    // Haptic & Animation
    haptic('light');
    
    // BUMP Animation (RESET TRICK)
    rowEl.classList.remove('bump');
    void rowEl.offsetWidth; // trigger reflow
    rowEl.classList.add('bump');

    if (state.selected.has(id)) {
      state.selected.delete(id);
      rowEl.classList.remove('selected');
    } else {
      state.selected.add(id);
      rowEl.classList.add('selected');
    }
    
    updateBottomBar();
    
    if (state.activeCatId && !state.searchMode) {
        const cat = DB.find(c => c.id === state.activeCatId);
        updateSelectAllBtn(cat);
    }
  }

  function updateBottomBar() {
    const count = state.selected.size;
    el.totalCount.textContent = count;
    
    // Keep bar visible for prototype
    el.bottomBar.classList.add('visible');
  }

  function updateSelectAllBtn(cat) {
    const allSelected = cat.items.every(i => state.selected.has(i.id));
    el.btnSelectAll.textContent = allSelected ? '–°–Ω—è—Ç—å –≤—Å—ë' : '–í—ã–±—Ä–∞—Ç—å –≤—Å—ë';
    el.btnSelectAll.onclick = () => toggleAllInCategory(cat, !allSelected);
  }

  function toggleAllInCategory(cat, select) {
    haptic('medium');
    cat.items.forEach(i => {
      if (select) state.selected.add(i.id);
      else state.selected.delete(i.id);
    });
    renderProductList(cat.items, el.productList);
    updateSelectAllBtn(cat);
    updateBottomBar();
  }

  // --- SEARCH ---
  function handleSearch(e) {
    const query = e.target.value.toLowerCase().trim();
    if (query.length > 0) {
      if (!state.searchMode) enterSearchMode();
      
      let results = [];
      DB.forEach(cat => {
        const matches = cat.items.filter(i => i.name.toLowerCase().includes(query));
        results = [...results, ...matches];
      });
      
      if (results.length === 0) {
        el.searchResults.innerHTML = '<div class="empty-state"><div class="empty-icon">üîç</div><div>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div></div>';
      } else {
        renderProductList(results, el.searchResults);
      }
    } else {
      exitSearchMode();
    }
  }

  function enterSearchMode() {
    state.searchMode = true;
    el.viewCats.classList.remove('active');
    el.viewList.classList.remove('active');
    el.viewSearch.classList.add('active');
  }

  function exitSearchMode() {
    state.searchMode = false;
    el.viewSearch.classList.remove('active');
    
    if (state.activeCatId) {
      el.viewList.classList.add('active');
    } else {
      el.viewCats.classList.add('active');
      renderCategories();
    }
  }

  function clearSearch() {
    el.searchInput.value = '';
    exitSearchMode();
  }

  function saveSelection() {
    haptic('success');
    alert(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${state.selected.size} –ø—Ä–æ–¥—É–∫—Ç–æ–≤!`);
  }

  init();

</script>
</body>
</html>
