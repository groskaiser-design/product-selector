<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Ultima Premium</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root {
    --bg-core: #000000;
    --bg-gradient: radial-gradient(circle at 50% 0%, #1e1e2e 0%, #000000 70%);
    --text-main: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.6);
    
    --glass-bg: rgba(10, 10, 10, 0.75);
    --glass-border: rgba(255, 255, 255, 0.08);
    
    --accent: #0A84FF;
    --accent-glow: rgba(10, 132, 255, 0.4);
    
    --pad-x: 16px;
    --radius-card: 20px;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body {
    margin: 0; padding: 0;
    background: var(--bg-core);
    background-image: var(--bg-gradient);
    background-attachment: fixed;
    color: var(--text-main);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
    height: 100vh;
    overflow: hidden;
    display: flex; flex-direction: column;
    -webkit-font-smoothing: antialiased;
  }

  /* --- 1. HEADER (SEARCH) --- */
  .app-header {
    padding: 12px var(--pad-x);
    z-index: 50;
    flex-shrink: 0;
  }
  
  .search-box {
    position: relative;
    height: 44px;
    background: rgba(255,255,255,0.08);
    border-radius: 12px;
    display: flex; align-items: center;
    padding: 0 12px;
    border: 1px solid rgba(255,255,255,0.05);
  }
  
  .search-input {
    background: transparent; border: none; outline: none;
    color: #fff; font-size: 17px; width: 100%;
    margin-left: 8px;
  }
  .search-input::placeholder { color: rgba(255,255,255,0.4); }

  /* --- 2. LAYOUT --- */
  .views-container {
    flex: 1; position: relative; overflow: hidden;
  }
  
  .view {
    position: absolute; inset: 0;
    overflow-y: auto; overflow-x: hidden;
    padding: 10px var(--pad-x) 120px; /* Bottom padding for button space */
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s;
    opacity: 0; pointer-events: none; transform: translateX(20px);
  }
  
  .view.active { opacity: 1; pointer-events: auto; transform: translateX(0); }
  .view.prev { transform: translateX(-10%) scale(0.98); opacity: 0; pointer-events: none; }

  /* --- 3. CATEGORIES GRID (–û–ë–ù–û–í–õ–ï–ù–ù–´–ô –î–ò–ó–ê–ô–ù) --- */
  .cat-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
  }
  
  .cat-card {
    background: rgba(255,255,255,0.05);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-card);
    /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã */
    padding: 12px;
    /* –£–º–µ–Ω—å—à–µ–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
    min-height: 85px;
    display: flex; flex-direction: column; justify-content: space-between;
    position: relative; overflow: hidden;
    cursor: pointer;
    transition: transform 0.1s, background 0.2s;
  }
  .cat-card:active { transform: scale(0.98); background: rgba(255,255,255,0.08); }
  
  .cat-icon { 
    /* –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π —ç–º–æ–¥–∑–∏ */
    font-size: 20px; 
    margin-bottom: 4px; 
  }
  .cat-title { 
    /* –¢–æ–Ω–∫–∏–π —à—Ä–∏—Ñ—Ç */
    font-weight: 400; 
    /* –ê–∫–∫—É—Ä–∞—Ç–Ω—ã–π —Ä–∞–∑–º–µ—Ä */
    font-size: 14px; 
    line-height: 1.2; 
  }
  .cat-count { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
  
  .progress-bar {
    position: absolute; bottom: 0; left: 0; right: 0; height: 3px;
    background: rgba(255,255,255,0.05);
  }
  .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }

  /* --- 4. PRODUCT LIST (PREMIUM) --- */
  #view-list {
    padding: 0; /* Reset global padding */
    display: flex; flex-direction: column;
  }

  /* GLASS HEADER FOR LIST */
  .glass-header {
    position: absolute; top: 0; left: 0; right: 0;
    height: 60px;
    z-index: 20;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 var(--pad-x);
    
    background: var(--glass-bg);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--glass-border);
  }
  
  .header-title { font-size: 18px; font-weight: 700; }
  .btn-action { color: var(--accent); font-weight: 600; font-size: 15px; background: none; border: none; }

  /* SCROLLABLE AREA */
  .list-scroll-area {
    flex: 1;
    overflow-y: auto;
    padding: 70px var(--pad-x) 140px; /* Top for header, Bottom for button */
    -webkit-overflow-scrolling: touch;
  }

  .product-row {
    display: flex; align-items: center; gap: 12px;
    padding: 14px 16px;
    margin-bottom: 8px;
    background: rgba(255,255,255,0.03);
    border-radius: 16px;
    border: 1px solid transparent;
    transition: all 0.2s;
  }
  .product-row:active { background: rgba(255,255,255,0.06); transform: scale(0.99); }
  .product-row.selected {
    background: rgba(10, 132, 255, 0.1);
    border-color: rgba(10, 132, 255, 0.3);
  }

  .check-circle {
    width: 22px; height: 22px; border-radius: 50%;
    border: 2px solid rgba(255,255,255,0.4);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; transition: 0.2s;
  }
  .product-row.selected .check-circle {
    background: var(--accent); border-color: var(--accent);
  }
  .check-circle::after {
    content: ''; width: 8px; height: 4px; border-left: 2px solid #fff; border-bottom: 2px solid #fff;
    transform: rotate(-45deg) translate(1px, -1px); opacity: 0;
  }
  .product-row.selected .check-circle::after { opacity: 1; }

  .prod-info { display: flex; flex-direction: column; gap: 2px; }
  .prod-name { font-size: 15px; font-weight: 500; color: #fff; }
  .prod-meta { font-size: 12px; color: var(--text-muted); }

  /* --- 5. FLOATING CAPSULE BUTTON --- */
  .floater-container {
    position: absolute; bottom: 0; left: 0; right: 0;
    z-index: 30;
    pointer-events: none;
    
    /* Gradient fade out to black */
    background: linear-gradient(to top, #000000 30%, rgba(0,0,0,0) 100%);
    height: 120px;
    display: flex; align-items: flex-end; justify-content: center;
    padding-bottom: 30px;
  }
  
  .btn-capsule {
    pointer-events: auto;
    background: var(--accent);
    color: white;
    font-size: 16px; font-weight: 600;
    border: none;
    height: 52px;
    padding: 0 32px;
    min-width: 200px;
    border-radius: 100px; /* Capsule shape */
    box-shadow: 0 8px 24px var(--accent-glow);
    display: flex; align-items: center; justify-content: center; gap: 8px;
    transition: transform 0.1s, background 0.2s, opacity 0.2s;
  }
  
  .btn-capsule:active { transform: scale(0.96); }
  
  .btn-capsule.disabled {
    background: rgba(255,255,255,0.1);
    color: rgba(255,255,255,0.3);
    box-shadow: none;
    pointer-events: none;
  }

  /* UTILS */
  ::-webkit-scrollbar { display: none; }
  .bump { animation: bump 0.2s ease; }
  @keyframes bump { 50% { transform: scale(0.95); } }
  .empty-state { text-align: center; color: var(--text-muted); padding-top: 40px; }
</style>
</head>
<body>
<div class="fx-layer">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="noise"></div>
</div>
<!-- HEADER (GLOBAL) -->
<div class="app-header">
  <div class="search-box">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫" id="searchInput">
    <div id="searchClear" style="opacity:0; padding:4px;" onclick="clearSearch()">‚úï</div>
  </div>
</div>

<div class="views-container">
  
  <!-- 1. CATEGORIES -->
  <div class="view active" id="view-cats">
    <div class="cat-grid" id="catGrid"></div>
  </div>

  <!-- 2. PRODUCTS LIST -->
  <div class="view" id="view-list">
    <!-- Sticky Glass Header -->
    <div class="glass-header">
      <div class="header-title" id="catTitle">–ü—Ä–æ–¥—É–∫—Ç—ã</div>
      <button class="btn-action" id="btnSelectAll">–í—ã–±—Ä–∞—Ç—å –≤—Å—ë</button>
    </div>
    
    <!-- Scrollable Content -->
    <div class="list-scroll-area" id="productList"></div>
    <div id="sentinel" style="height:1px;"></div>
  </div>

  <!-- 3. SEARCH RESULTS -->
  <div class="view" id="view-search">
    <div class="list-scroll-area" id="searchResults" style="padding-top:10px;"></div>
  </div>

</div>

<!-- FLOATING ACTION BUTTON -->
<div class="floater-container">
  <button class="btn-capsule" id="btnSave" onclick="saveSelection()">
    <span id="saveBtnText">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
  </button>
</div>

<script>
  // üî¥ 1. CONFIG
  const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbybxqI4xOLAUOcMXGReNl0PVjGToGg6_x3ZxlKNnUHg3XcaZGhkbsu61Adgkb4emrkm/exec';

  const tg = window.Telegram?.WebApp;
  
  // üî• SAFE BOOT LOGIC
  (function initTMA() {
    try {
      if (!tg) return;
      tg.ready(); tg.expand();
      try { tg.setHeaderColor('#000000'); tg.setBackgroundColor('#000000'); } catch(e){}
      try {
         if (tg.BackButton) {
             tg.BackButton.show();
             tg.BackButton.offClick();
             tg.BackButton.onClick(() => {
                 if(state.searchMode) exitSearchMode();
                 else if(state.activeCatId) goBack();
                 else window.location.href = 'router.html';
             });
         }
      } catch(e){}
      try { if(tg.disableVerticalSwipes) tg.disableVerticalSwipes(); } catch(e){}
    } catch(e) { console.error(e); }
  })();

  // üî¥ 2. STATE
  const state = {
    selected: new Set(),
    activeCatId: null,
    searchMode: false,
    queue: [],    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ë—ã–ª–æ renderQueue, –Ω–æ –ª–æ–≥–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ queue
    idx: 0,       // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ë—ã–ª–æ renderIndex, –Ω–æ –ª–æ–≥–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ idx
    BATCH_SIZE: 30
  };

  const el = {
    catGrid: document.getElementById('catGrid'),
    productList: document.getElementById('productList'),
    viewCats: document.getElementById('view-cats'),
    viewList: document.getElementById('view-list'),
    viewSearch: document.getElementById('view-search'),
    catTitle: document.getElementById('catTitle'),
    btnSelectAll: document.getElementById('btnSelectAll'),
    searchInput: document.getElementById('searchInput'),
    searchResults: document.getElementById('searchResults'),
    btnSave: document.getElementById('btnSave'),
    saveBtnText: document.getElementById('saveBtnText'),
    sentinel: document.getElementById('sentinel'),
    searchClear: document.getElementById('searchClear')
  };

  // üî¥ 3. DATA SERVICE
  const DataService = {
    categories: [], productsMap: {}, allValidIds: new Set(),
    
    async init() {
      this.loadCache();
      this.sanitize();
      renderCategories();
      updateSaveButton();
      await this.fetch();
    },

    loadCache() {
      try {
        const c = localStorage.getItem('u_cat');
        if(c) this.process(JSON.parse(c));
        const s = localStorage.getItem('u_cart');
        if(s) state.selected = new Set(JSON.parse(s));
      } catch(e){}
    },

    async fetch() {
      try {
        const ver = localStorage.getItem('u_ver') || 0;
        const res = await fetch(BACKEND_URL, {
          method:'POST', 
          body: JSON.stringify({ action:'init', clientVer: ver, initData: tg?.initData||'' })
        });
        const data = await res.json();
        
        if(data.ok) {
           if(data.needUpdate && data.catalog) {
               this.process(data.catalog);
               localStorage.setItem('u_cat', JSON.stringify(data.catalog));
               localStorage.setItem('u_ver', data.serverVer);
               this.sanitize();
               if(!state.activeCatId && !state.searchMode) renderCategories();
           }
           if(data.userSelection) {
               let set = new Set();
               try { 
                 const p = typeof data.userSelection==='string' ? JSON.parse(data.userSelection) : data.userSelection;
                 if(Array.isArray(p)) set = new Set(p);
               } catch(e){}
               state.selected = set;
               this.sanitize();
               saveLocal();
               updateSaveButton();
               if(!state.activeCatId) renderCategories();
           }
        }
      } catch(e){}
    },

    process(raw) {
       if(!raw) return;
       this.categories = raw.categories || [];
       this.productsMap = {};
       this.allValidIds.clear();
       (raw.products || []).forEach(r => {
           const [id, cat, name, meta] = r;
           this.allValidIds.add(String(id));
           if(!this.productsMap[cat]) this.productsMap[cat] = [];
           this.productsMap[cat].push({id, name, meta});
       });
    },

    sanitize() {
       if(this.allValidIds.size === 0) return;
       let ch = false;
       state.selected.forEach(id => {
           if(!this.allValidIds.has(String(id))) { state.selected.delete(id); ch=true; }
       });
       if(ch) { saveLocal(); updateSaveButton(); }
    },
    
    getProd(catId) { return this.productsMap[catId] || []; },
    search(q) {
       const r=[]; const l=q.toLowerCase();
       Object.values(this.productsMap).forEach(arr => arr.forEach(p => {
           if(p.name.toLowerCase().includes(l)) r.push(p);
       }));
       return r;
    }
  };

  // üî¥ 4. UI LOGIC
  function saveLocal() {
     try { localStorage.setItem('u_cart', JSON.stringify([...state.selected])); } catch(e){}
  }
  
  function haptic() { try{tg?.HapticFeedback.impactOccurred('light');}catch(e){} }

  function renderCategories() {
     el.catGrid.innerHTML = '';
     DataService.categories.forEach(c => {
         const all = DataService.getProd(c.id);
         const sel = all.filter(p => state.selected.has(p.id)).length;
         const pct = all.length ? (sel/all.length)*100 : 0;
         
         const div = document.createElement('div');
         div.className = 'cat-card';
         div.onclick = () => openCategory(c.id);
         div.innerHTML = `
           <div>
             <div class="cat-icon">${c.icon||'üì¶'}</div>
             <div class="cat-title">${c.name}</div>
             <div class="cat-count">${sel} / ${all.length}</div>
           </div>
           <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
         `;
         el.catGrid.appendChild(div);
     });
  }

  function openCategory(id) {
     state.activeCatId = id;
     const cat = DataService.categories.find(c => c.id === id);
     el.catTitle.textContent = cat ? cat.name : '–ö–∞—Ç–µ–≥–æ—Ä–∏—è';
     
     const prods = DataService.getProd(id);
     startRender(prods, el.productList);
     updateSelectAll();
     
     el.viewCats.classList.add('prev');
     el.viewCats.classList.remove('active');
     el.viewList.classList.add('active');
     updateSaveButton();
  }

  function goBack() {
     state.activeCatId = null;
     el.viewList.classList.remove('active');
     el.viewCats.classList.add('active');
     el.viewCats.classList.remove('prev');
     setTimeout(renderCategories, 200);
     updateSaveButton();
  }

  function startRender(items, container) {
      container.innerHTML = '';
      state.queue = items;
      state.idx = 0;
      state.cont = container;
      if(!items.length) container.innerHTML = '<div class="empty-state">–ü—É—Å—Ç–æ</div>';
      else renderBatch();
  }

  function renderBatch() {
      // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –æ—á–µ—Ä–µ–¥—å –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–ª–∏–Ω—ã
      if(!state.queue || state.idx >= state.queue.length) return;
      
      const chunk = state.queue.slice(state.idx, state.idx + state.BATCH_SIZE);
      const frag = document.createDocumentFragment();
      
      chunk.forEach(p => {
          const isSel = state.selected.has(p.id);
          const row = document.createElement('div');
          row.className = `product-row ${isSel?'selected':''}`;
          row.onclick = () => toggle(p.id, row);
          row.innerHTML = `
            <div class="check-circle"></div>
            <div class="prod-info">
              <div class="prod-name">${p.name}</div>
              <div class="prod-meta">${p.meta||''}</div>
            </div>
          `;
          frag.appendChild(row);
      });
      state.cont.appendChild(frag);
      state.idx += state.BATCH_SIZE;
  }

  function toggle(id, node) {
     haptic();
     if(state.selected.has(id)) { state.selected.delete(id); node.classList.remove('selected'); }
     else { state.selected.add(id); node.classList.add('selected'); }
     saveLocal();
     updateSaveButton();
     if(state.activeCatId && !state.searchMode) updateSelectAll();
  }

  function updateSaveButton() {
     const count = state.selected.size;
     el.btnSave.classList.remove('disabled');
     
     if(state.activeCatId) {
        // In category mode
        const inCat = DataService.getProd(state.activeCatId).filter(p=>state.selected.has(p.id)).length;
        el.saveBtnText.textContent = inCat > 0 ? `–í—ã–±—Ä–∞–Ω–æ (${inCat})` : '–ù–∞–∑–∞–¥';
     } else {
        // Main mode
        el.saveBtnText.textContent = `–°–æ—Ö—Ä–∞–Ω–∏—Ç—å (${count})`;
        if(count === 0) el.btnSave.classList.add('disabled');
     }
  }

  function updateSelectAll() {
     if(!state.activeCatId) return;
     const all = DataService.getProd(state.activeCatId);
     const isAll = all.length > 0 && all.every(p => state.selected.has(p.id));
     el.btnSelectAll.textContent = isAll ? '–°–Ω—è—Ç—å –≤—Å—ë' : '–í—ã–±—Ä–∞—Ç—å –≤—Å—ë';
     el.btnSelectAll.onclick = () => {
         haptic();
         all.forEach(p => isAll ? state.selected.delete(p.id) : state.selected.add(p.id));
         saveLocal();
         startRender(all, el.productList);
         updateSelectAll();
         updateSaveButton();
     };
  }

  // SEARCH
  el.searchInput.addEventListener('input', (e) => {
     const q = e.target.value.trim();
     el.searchClear.style.opacity = q ? 1 : 0;
     if(!q) { el.searchResults.innerHTML=''; return; }
     
     if(!state.searchMode) {
        state.searchMode = true;
        el.viewCats.classList.remove('active');
        el.viewList.classList.remove('active');
        el.viewSearch.classList.add('active');
     }
     startRender(DataService.search(q), el.searchResults);
  });
  
  function clearSearch() {
     el.searchInput.value = '';
     exitSearchMode();
  }
  
  function exitSearchMode() {
     state.searchMode = false;
     el.viewSearch.classList.remove('active');
     el.searchClear.style.opacity = 0;
     if(state.activeCatId) el.viewList.classList.add('active');
     else el.viewCats.classList.add('active');
  }

  async function saveSelection() {
     haptic();
     if(state.activeCatId && !state.searchMode) { goBack(); return; }
     
     el.saveBtnText.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
     try {
       await fetch(BACKEND_URL, {
          method: 'POST',
          body: JSON.stringify({ action:'save', selection: [...state.selected], initData: tg?.initData||'' })
       });
       tg?.showPopup({title:'–ì–æ—Ç–æ–≤–æ', message:'–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', buttons:[{type:'ok'}]});
     } catch(e) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
     updateSaveButton();
  }

  // Observer
  new IntersectionObserver(e => { if(e[0].isIntersecting) renderBatch(); }, {rootMargin:'200px'}).observe(el.sentinel);

  DataService.init();

</script>
</body>
</html>
