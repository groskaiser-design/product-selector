<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>–í—ã–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤ Ultima</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  /* üî• –°–ö–†–´–í–ê–ï–ú –°–ö–†–û–õ–õ–ë–ê–† –í–ï–ó–î–ï */
  /* –î–ª—è Chrome, Safari, iOS, Android */
  *::-webkit-scrollbar {
    display: none;
    width: 0;
    height: 0;
  }

  /* –î–ª—è Firefox –∏ Edge */
  * {
    -ms-overflow-style: none;  /* IE –∏ Edge */
    scrollbar-width: none;  /* Firefox */
  }
  :root {
    /* --- PALETTE --- */
    --bg-core: #050505;
    --text-main: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.55);
    
    /* --- GLASS SURFACES --- */
    --surface-glass: rgba(255, 255, 255, 0.07);
    --surface-dark: rgba(0, 0, 0, 0.3);
    --surface-border: rgba(255, 255, 255, 0.1);
    --surface-border-light: rgba(255, 255, 255, 0.2);
    
    /* --- ACCENTS --- */
    --acc-blue: #0a84ff;
    --acc-green: #30d158;
    
    /* --- KBJU VARS --- */
    --okA: #4facfe; 
    --okB: #0a84ff;
    
    /* --- METRICS --- */
    --radius-xl: 28px;
    --radius-l: 24px;
    --radius-m: 16px;
    --pad-x: 16px; 
    --gap: 8px;
  }

  * { 
    box-sizing: border-box; 
    margin: 0; 
    padding: 0; 
    
    /* üî• –í–û–¢ –≠–¢–ê –°–¢–†–û–ö–ê –£–ë–ò–†–ê–ï–¢ –õ–Æ–ë–û–ï –°–ò–°–¢–ï–ú–ù–û–ï –ú–ò–ì–ê–ù–ò–ï –ü–†–ò –ù–ê–ñ–ê–¢–ò–ò: */
    -webkit-tap-highlight-color: transparent !important; 
  }
  
  /* üî• CRITICAL FOR IOS RESPONSIVENESS */
  html, body, button, .cat-card, .product-row, .btn-save { 
    touch-action: manipulation; 
  }

  body {
    background-color: var(--bg-core) !important;
    color: var(--text-main);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', Roboto, Helvetica, Arial, sans-serif;
    height: 100vh;
    overflow: hidden; 
    display: flex;
    flex-direction: column;
    -webkit-font-smoothing: antialiased;
  }

  /* --- FX LAYER --- */
  .fx-layer { 
    position: fixed; 
    /* –ò—Å–ø–æ–ª—å–∑—É–µ–º top/left/width/height –≤–º–µ—Å—Ç–æ inset:0 */
    top: 0; 
    left: 0;
    width: 100vw;
    height: 100vh; /* –°—Ç–∞–Ω–¥–∞—Ä—Ç */
    
    /* üî• –≠–¢–ê –°–¢–†–û–ö–ê –í–ê–ñ–ù–ê: 100lvh –æ–∑–Ω–∞—á–∞–µ—Ç "–≤—ã—Å–æ—Ç–∞ —ç–∫—Ä–∞–Ω–∞ –ë–ï–ó —É—á–µ—Ç–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã" */
    /* –†–∞–±–æ—Ç–∞–µ—Ç –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö */
    height: 100lvh; 
    
    z-index: 0; 
    pointer-events: none; 
    transform: translate3d(0,0,0); 
  }
  .orb { position: absolute; border-radius: 50%; will-change: transform; animation: float 30s infinite linear; }
  .orb-1 { width: 90vw; height: 90vw; opacity: 0.4; background: radial-gradient(circle, rgba(108, 92, 231, 0.8) 0%, transparent 70%); top: -20%; left: -20%; }
  .orb-2 { 
    width: 400px; 
    height: 400px; 
    opacity: 0.5; 
    background: radial-gradient(circle, rgba(108, 92, 231, 0.8) 0%, transparent 70%); 
    
    /* üëá –ë–´–õ–û: bottom: -150px; (—ç—Ç–æ –∑–∞—Å—Ç–∞–≤–ª—è–ª–æ —à–∞—Ä –ø—Ä—ã–≥–∞—Ç—å) */
    /* üëá –°–¢–ê–õ–û: –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ –≤–µ—Ä—Ö—É –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö */
    top: 80%; 
    
    right: -100px; 
    animation: breathe 6s infinite ease-in-out; 
  }
  
  .noise { position: fixed; inset: 0; z-index: 0; opacity: 0.04; background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); pointer-events: none; }
  @keyframes float { 0% {transform:rotate(0deg)} 100% {transform:rotate(360deg)} }
  @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.4; } 50% { transform: scale(1.1); opacity: 0.6; } }

/* --- LAYOUT --- */
  .app-header {
    position: relative;
    z-index: 10;
    padding: 12px var(--pad-x) 4px;
    background: transparent !important;
    backdrop-filter: none !important;
    border: none !important;
    box-shadow: none !important;
  }
  
  .app-header::after, .app-header::before { display: none !important; }

  /* üî• –ù–û–í–´–ô –ö–û–ù–¢–ï–ô–ù–ï–†: –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –ø–æ–∏—Å–∫ –∏ –∫–Ω–æ–ø–∫—É –≤ —Ä—è–¥ */
  .header-flex {
    display: flex;
    align-items: center;
    width: 100%;
    gap: 0;
  }

  /* Search Bar (—Ç–µ–ø–µ—Ä—å —É–º–µ–µ—Ç —Å–∂–∏–º–∞—Ç—å—Å—è) */
  .search-box { 
    position: relative; 
    flex: 1; /* –†–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –≤—Å–µ –º–µ—Å—Ç–æ */
    transition: margin-right 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
  }

  .search-input {
    width: 100%; height: 40px; background: var(--surface-dark);
    border: 1px solid var(--surface-border); border-top: 1px solid var(--surface-border-light);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-radius: 14px; padding: 0 36px 0 40px;
    color: #fff; font-size: 16px; font-weight: 500;
    transition: all 0.2s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    line-height: normal;
  }
  .search-input::placeholder { color: rgba(255,255,255,0.35); font-weight: 400; }
  .search-input:focus { background: rgba(0, 0, 0, 0.5); border-color: rgba(255, 255, 255, 0.25); outline: none; }

  /* –õ—É–ø–∞ */
  .search-icon {
    position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
    color: rgba(255,255,255,0.4); pointer-events: none; z-index: 10;
    display: flex; align-items: center; justify-content: center; margin-top: 1px; 
  }

  /* –ö—Ä–µ—Å—Ç–∏–∫ –æ—á–∏—Å—Ç–∫–∏ */
  .search-clear {
    position: absolute; right: 0; top: 0; bottom: 0; width: 36px;
    display: flex; align-items: center; justify-content: center;
    color: rgba(255,255,255,0.4); opacity: 0; pointer-events: auto; transition: opacity 0.2s;
  }
  .search-input:not(:placeholder-shown) ~ .search-clear { opacity: 1; }

  /* üî• –°–¢–ò–õ–ò –ö–ù–û–ü–ö–ò –û–¢–ú–ï–ù–ê */
  .search-cancel-btn {
    background: none;
    border: none;
    color: var(--acc-blue); /* –°–∏–Ω–∏–π —Ü–≤–µ—Ç */
    font-size: 17px;
    font-weight: 500;
    padding: 0;
    
    /* –°–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    width: 0; 
    opacity: 0;
    overflow: hidden;
    white-space: nowrap;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
  }

  /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É, –∫–æ–≥–¥–∞ –∞–∫—Ç–∏–≤–µ–Ω –ø–æ–∏—Å–∫ */
  body.search-active .search-cancel-btn {
    width: 100px; 
    opacity: 1;
    padding-left: 10px;
  }

  /* --- VIEW CONTAINER --- */
  .views-container { position: relative; flex: 1; overflow: hidden; z-index: 1; }
  
  .view {
    position: absolute; inset: 0; overflow-y: auto; overflow-x: hidden;
    -webkit-overflow-scrolling: touch; padding: 12px var(--pad-x) 140px;
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s ease;
    opacity: 0; pointer-events: none; transform: translateX(30px);
    background: transparent;
  }
  .view.active { opacity: 1; pointer-events: auto; transform: translateX(0); }
  .view.prev { transform: translateX(-10%) scale(0.98); opacity: 0; pointer-events: none; }

  /* --- CATEGORY GRID --- */
  .cat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--gap); }
  
  .cat-card {
    /* üëá –ë–´–õ–û (—Å–ª–∏—à–∫–æ–º —Ç–µ–º–Ω–æ–µ): 
       background: var(--surface-dark) !important; 
    */
    
    /* üëá –°–¢–ê–õ–û (–∫–∞–∫ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏): */
    background: linear-gradient(165deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%) !important;
    
    /* –î–µ–ª–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã —Ç–∞–∫–∏–º–∏ –∂–µ, –∫–∞–∫ –≤ —Å–ø–∏—Å–∫–µ */
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    
    border-radius: var(--radius-l) !important;
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.2) !important;
    padding: 14px;
    display: flex; flex-direction: column; justify-content: space-between;
    min-height: 110px;
    cursor: pointer; position: relative; overflow: hidden;
    transition: background 0.2s; 
    will-change: transform;
  }
  
 
  
 .cat-icon { 
    font-size: 20px; /* –ë—ã–ª–æ 24px */ 
    margin-bottom: 10px; 
    filter: drop-shadow(0 4px 12px rgba(0,0,0,0.3)); 
  }
 .cat-name { 
    font-size: 14px; 
    font-weight: 500; /* –ë—ã–ª–æ 700 */
    line-height: 1.3; /* –ß—É—Ç—å –±–æ–ª—å—à–µ –≤–æ–∑–¥—É—Ö–∞ */
    margin-bottom: 2px; 
    color: #fff; 
    letter-spacing: 0.3px; 
    
    /* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤ 2 —Å—Ç—Ä–æ–∫–∏ */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    min-height: 2.6em; /* –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –º–µ—Å—Ç–æ –ø–æ–¥ 2 —Å—Ç—Ä–æ–∫–∏, —á—Ç–æ–±—ã –∫–∞—Ä—Ç–æ—á–∫–∏ –±—ã–ª–∏ —Ä–æ–≤–Ω—ã–º–∏ */
  }
  
  /* –û–±–Ω–æ–≤–ª—è–µ–º –±–ª–æ–∫ —Å —Ü–∏—Ñ—Ä–∞–º–∏, —á—Ç–æ–±—ã –æ–Ω —Å—Ç–∞–ª –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º –¥–ª—è –ø–æ–ª–æ—Å–∫–∏ –∏ —Ç–µ–∫—Å—Ç–∞ */
  .cat-meta {
    display: flex;
    flex-direction: column; /* üî• –¢–µ–ø–µ—Ä—å —ç–ª–µ–º–µ–Ω—Ç—ã –¥—Ä—É–≥ –ø–æ–¥ –¥—Ä—É–≥–æ–º */
    align-items: flex-start; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é */
    justify-content: flex-end;
    gap: 6px; /* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É —Ü–∏—Ñ—Ä–∞–º–∏ –∏ –ø–æ–ª–æ—Å–∫–æ–π */
    
    font-size: 12px;
    color: rgba(255,255,255,0.55);
    font-weight: 500;
    margin-top: auto;
    width: 100%;
  }

  .mini-track {
    width: 40px; /* –®–∏—Ä–∏–Ω–∞ "–±–∞—Ç–∞—Ä–µ–π–∫–∏". –ú–æ–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å 100%, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –≤–æ –≤—Å—é —à–∏—Ä–∏–Ω—É */
    height: 4px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
    overflow: hidden;
  }

  .mini-fill {
    height: 100%;
    background: var(--acc-blue);
    border-radius: 2px;
    transition: width 0.3s ease;
  }
  /* --- HEADER LIST --- */
  .list-header-area { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding: 0 4px; }
  .list-title { font-size: 20px; font-weight: 800; letter-spacing: 0.3px; color: #fff; }
  .btn-select-all {
    font-size: 15px; font-weight: 600; color: var(--acc-blue);
    background: none; border: none; padding: 6px 0; cursor: pointer; transition: opacity 0.2s;
  }
  .btn-select-all:active { opacity: 0.7; }

  /* --- PRODUCT LIST CONTAINER --- */
  .product-list-container {
    display: flex; flex-direction: column; gap: 8px;
    background: linear-gradient(165deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    padding: 14px; border-radius: 20px; backdrop-filter: blur(10px);
    min-height: 50px;
  }

  /* --- PRODUCT ROW --- */
  .product-row {
    display: flex; align-items: center; justify-content: flex-start;
    gap: 12px;
    padding: 12px 14px; border-radius: 12px;
    position: relative; cursor: pointer; background: transparent;
    transition: background 0.15s ease;
    will-change: transform;
    opacity: 1;
  }
  

  .product-row.selected { background: transparent; } 

  /* üî• ANIMATION: BUMP */
  .bump { animation: bump 0.15s cubic-bezier(0.34, 1.56, 0.64, 1) !important; }
  @keyframes bump { 
    0% { transform: scale(1); } 
    50% { transform: scale(0.95); } 
    100% { transform: scale(1); } 
  }

  .prod-info { flex: 1; z-index: 2; display: flex; flex-direction: column; gap: 3px; }
  .prod-name {
    font-size: 14px;  /* –ë—ã–ª–æ 15px. –°–¥–µ–ª–∞–ª–∏ –ø–æ–º–µ–Ω—å—à–µ */
    font-weight: 400; /* –ë—ã–ª–æ 600. –°–¥–µ–ª–∞–ª–∏ –æ–±—ã—á–Ω—ã–º (–Ω–µ –∂–∏—Ä–Ω—ã–º) */
    color: #fff;
    line-height: 1.3;
  }
  .prod-meta { font-size: 12px; color: rgba(255,255,255,0.5); font-weight: 500; letter-spacing: 0.2px; }
  
  /* --- CHECKBOX --- */
  .check-square {
    width: 22px; height: 22px; border-radius: 6px;
    border: 2px solid rgba(255,255,255,.65);
    display: inline-flex; align-items: center; justify-content: center;
    flex-shrink: 0; transition: all .2s ease; background: transparent;
  }
  .check-square::after {
    content: ""; width: 12px; height: 12px; border-radius: 3px;
    background: #fff; opacity: 0; transform: scale(.7); transition: all .2s ease;
  }
  .product-row.selected .check-square {
    background: linear-gradient(135deg, var(--okA), var(--okB)); border-color: var(--okB);
    transform: scale(1.05);
  }
  .product-row.selected .check-square::after { opacity: 1; transform: scale(1); }

  /* --- FLOATING SAVE BUTTON --- */
  .save-floater { position: absolute; bottom: 34px; left: 0; right: 0; display: flex; justify-content: center; z-index: 30; pointer-events: none; }
  
/* --- 1. –ö–û–ù–¢–ï–ô–ù–ï–† --- */
 .btn-save {
    position: relative;
    z-index: 100;
    isolation: isolate;
    
    /* üî• –≠–¢–ê –°–¢–†–û–ö–ê –ß–ò–ù–ò–¢ –ö–ù–û–ü–ö–£: */
    pointer-events: auto; 
    
    background: transparent;
    border: none;
    height: auto;
    min-width: 160px;
    padding: 14px 28px;
    
    /* –û—Å—Ç–∞–ª—å–Ω—ã–µ –≤–∞—à–∏ —Å—Ç–∏–ª–∏... */
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', Roboto, sans-serif;
    font-size: 16px;
    font-weight: 600; 
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    cursor: pointer;
    transition: transform 0.2s;
    transform: translateY(100px);
    opacity: 0;
  }
  
  /* --- 2. –ë–õ–Æ–†-–ü–û–î–õ–û–ñ–ö–ê (–°–í–ï–¢–õ–ê–Ø) --- */
  .btn-save::before {
    content: "";
    position: absolute;
    z-index: -2;
    
    /* üî• –û–¢–°–¢–£–ü–´: –ß—É—Ç—å –ø—Ä–∏–∂–∞–ª–∏ –∫ –∫–Ω–æ–ø–∫–µ (–±—ã–ª–æ -10px) */
    top: -8px;
    bottom: -8px;
    left: -8px;
    right: -8px;
    
    /* üî• –†–ê–î–ò–£–°: –¢–µ–ø–µ—Ä—å –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∫–æ–Ω—Ç—É—Ä –∫–Ω–æ–ø–∫–∏ (16px + 8px = 24px) */
    border-radius: 24px;
    
    /* –°–≤–µ—Ç–ª—ã–π —ç—Ñ—Ñ–µ–∫—Ç —Å—Ç–µ–∫–ª–∞ */
    background: rgba(255, 255, 255, 0.15); 
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.05);
    
    pointer-events: none;
  }

  /* --- 3. –°–ò–ù–Ø–Ø –ö–ù–û–ü–ö–ê --- */
  .btn-save::after {
    content: "";
    position: absolute;
    z-index: -1;
    inset: 0;
    
    /* –û—Å–Ω–æ–≤–Ω–æ–π —Ä–∞–¥–∏—É—Å –∫–Ω–æ–ø–∫–∏ */
    border-radius: 16px; 
    background: linear-gradient(135deg, var(--okA), var(--okB));
    
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    transition: transform 0.1s;
  }

  /* --- –°–û–°–¢–û–Ø–ù–ò–Ø --- */
  .btn-save.visible { transform: translateY(0); opacity: 1; }
  .btn-save:active { transform: scale(0.96); }
 
  /* --- EMPTY STATE --- */
  .empty-state {
    display: flex; flex-direction: column; align-items: center;
    margin-top: 60px; color: var(--text-muted); padding: 20px;
    background: var(--surface-dark); border-radius: 24px;
    border: 1px solid var(--surface-border); backdrop-filter: blur(10px);
  }
  .empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.6; }
  
  #sentinel { height: 20px; width: 100%; opacity: 0; pointer-events: none; }

/* üî• –ü–†–Ø–ß–ï–ú –ù–ò–ñ–ù–Æ–Æ –ö–ù–û–ü–ö–£ –ü–†–ò –ü–û–ò–°–ö–ï */
  body.search-active .btn-save {
    transform: translateY(150px) !important;
    opacity: 0 !important;
    pointer-events: none !important;
  }
/* –ß–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ" */
  /* –ß–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç –ø–æ —Ü–µ–Ω—Ç—Ä—É */
  .simple-no-results {
    width: 100%;
    height: 30vh; /* –ó–∞–Ω–∏–º–∞–µ–º 30% –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞ (—á—Ç–æ–±—ã –±—ã—Ç—å –Ω–∞–¥ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π) */
    display: flex;
    align-items: center;
    justify-content: center;
    
    color: rgba(255, 255, 255, 0.4);
    font-size: 17px;
    font-weight: 500;
  }
  
  /* --- LOADER --- */
  .loader-container {
    position: fixed; inset: 0; z-index: 9999;
    background: var(--bg-core); /* –¶–≤–µ—Ç —Ñ–æ–Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    transition: opacity 0.3s ease;
    opacity: 0; pointer-events: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
  }
  
  /* –ö–ª–∞—Å—Å –¥–ª—è –ø–æ–∫–∞–∑–∞ */
  .loader-container.active { opacity: 1; pointer-events: auto; }
  
  .spinner {
    width: 36px; height: 36px;
    border: 3px solid rgba(255, 255, 255, 0.1);
    border-top-color: var(--acc-blue); /* –°–∏–Ω–∏–π –∞–∫—Ü–µ–Ω—Ç */
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 12px;
  }
  
  .loader-text { 
    color: var(--text-muted); 
    font-size: 15px; 
    font-weight: 500; 
  }
  
  @keyframes spin { to { transform: rotate(360deg); } }

  
</style>
</head>
<body>

<div class="fx-layer">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="noise"></div>
</div>

  <div class="loader-container" id="appLoader">
  <div class="spinner"></div>
  <div class="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<div class="app-header">
  <div class="header-flex">
    
    <div class="search-box">
      <div class="search-icon">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      </div>
      <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤" id="searchInput" onfocus="enterSearchMode()">
      
      <div class="search-clear" id="searchClear">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </div>
    </div>

    <button class="search-cancel-btn" id="btnSearchCancel" onclick="exitSearchMode()">–û—Ç–º–µ–Ω–∞</button>
  
  </div>
</div>

<div class="views-container">
  
  <div class="view active" id="view-cats">
    <div class="cat-grid" id="catGrid"></div>
  </div>

  <div class="view" id="view-list">
    <div class="list-header-area">
      <h2 class="list-title" id="catTitle">–ù–∞–∑–≤–∞–Ω–∏–µ</h2>
      <button class="btn-select-all" id="btnSelectAll">–í—ã–±—Ä–∞—Ç—å –≤—Å—ë</button>
    </div>
    <div class="product-list-container" id="productList"></div>
    <div id="sentinel"></div>
  </div>

  <div class="view" id="view-search">
    <div class="product-list-container" id="searchResults" style="display:none; background:transparent!important; border:none!important; box-shadow:none!important; backdrop-filter:none!important;"></div>
  </div>

</div>

<div class="save-floater">
  <button class="btn-save" id="btnSave" onclick="saveSelection()">
    <span id="saveBtnText">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
  </button>
</div>

<script>
  // =========================================================
  // üü¢ 1. CONFIGURATION (IMPORTANT)
  // –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–® URL –ò–ó GOOGLE APPS SCRIPT
  // =========================================================
  const API_URL = "https://script.google.com/macros/s/AKfycbybxqI4xOLAUOcMXGReNl0PVjGToGg6_x3ZxlKNnUHg3XcaZGhkbsu61Adgkb4emrkm/exec"; 

  // üü¢ 2. TELEGRAM INIT
  const tg = window.Telegram?.WebApp;
  const TG_INIT_DATA = tg?.initData || "";

  if (tg) {
    tg.ready();
    tg.expand();
    try { tg.setHeaderColor('#050505'); tg.setBackgroundColor('#050505'); } catch(e){}
    
    // –ü–µ—Ä–µ—Ö–≤–∞—Ç –∫–Ω–æ–ø–∫–∏ –ù–∞–∑–∞–¥ (—Å–∏—Å—Ç–µ–º–Ω–æ–π)
    tg.BackButton.onClick(() => {
      if (state.searchMode) exitSearchMode();
      else if (state.activeCatId) goBack();
      else tg.close(); 
    });
  }

  // üü¢ 3. DATA SERVICE (GAS INTEGRATION)
  const DataService = {
    categories: [],
    productsMap: {}, 
    serverVer: 0,
    
    async init() {
      // 1. –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—ç—à
      const hasCache = this.loadFromCache();
      
      if (hasCache) {
        // –ï—Å–ª–∏ –∫—ç—à –µ—Å—Ç—å ‚Äî —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
        renderCategories();
      } else {
        // üî• –ï—Å–ª–∏ –∫—ç—à–∞ –Ω–µ—Ç ‚Äî –≤–∫–ª—é—á–∞–µ–º –õ–æ–∞–¥–µ—Ä
        document.getElementById('appLoader').classList.add('active');
      }
      
      updateSaveButton();

      // 2. –§–æ–Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
      await this.syncWithServer();
    },

    loadFromCache() {
      try {
        const cached = localStorage.getItem('ultima_data_v2');
        if (cached) {
          const data = JSON.parse(cached);
          this.categories = data.categories || [];
          this.productsMap = data.productsMap || {};
          this.serverVer = data.serverVer || 0;
          
          const savedSelection = localStorage.getItem('ultima_cart_v1');
          if (savedSelection) state.selected = new Set(JSON.parse(savedSelection));
          
          return true; // ‚úÖ –î–∞–Ω–Ω—ã–µ –µ—Å—Ç—å
        }
      } catch(e) { console.error("Cache load error", e); }
      return false; // ‚ùå –î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
    },

    async syncWithServer() {
      try {
        if (!API_URL.includes("script.google.com")) { console.warn("No API URL"); return; }

        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify({ action: 'init', clientVer: this.serverVer, initData: TG_INIT_DATA })
        });

        const res = await response.json();
        
        if (res.ok && res.needUpdate && res.catalog) {
            this.processCatalog(res.catalog, res.serverVer);
        }

        if (res.ok && res.userSelection) {
            try {
                const serverSel = JSON.parse(res.userSelection);
                state.selected = new Set(serverSel);
                saveSelectionToCache();
                updateSaveButton();
                renderCategories();
            } catch(e) {}
        }
        
        // üî• –ï—Å–ª–∏ –ª–æ–∞–¥–µ—Ä –≤–∏—Å–∏—Ç ‚Äî —É–±–∏—Ä–∞–µ–º –µ–≥–æ, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –Ω–µ –±—ã–ª–æ
        document.getElementById('appLoader').classList.remove('active');

      } catch(e) { 
         console.warn("Sync skipped:", e); 
         // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ ‚Äî —Ç–æ–∂–µ —É–±–∏—Ä–∞–µ–º –ª–æ–∞–¥–µ—Ä, —á—Ç–æ–±—ã –Ω–µ –≤–∏—Å–µ–ª –≤–µ—á–Ω–æ
         document.getElementById('appLoader').classList.remove('active');
      }
    },

    processCatalog(catalogData, newVer) {
        this.categories = catalogData.categories.map(c => ({
            id: String(c.id), name: c.name, icon: c.icon
        }));

        const newMap = {};
        this.categories.forEach(c => newMap[c.id] = []);

        if (catalogData.products && Array.isArray(catalogData.products)) {
            catalogData.products.forEach(row => {
                const pId = String(row[0]);
                const cId = String(row[1]);
                if (!newMap[cId]) newMap[cId] = [];
                newMap[cId].push({ id: pId, name: row[2], meta: row[3] });
            });
        }

        this.productsMap = newMap;
        this.serverVer = newVer;

        localStorage.setItem('ultima_data_v2', JSON.stringify({
            categories: this.categories,
            productsMap: this.productsMap,
            serverVer: this.serverVer
        }));
        
        renderCategories();
        
        // üî• –î–∞–Ω–Ω—ã–µ –ø—Ä–∏—à–ª–∏ ‚Äî –≤—ã–∫–ª—é—á–∞–µ–º –ª–æ–∞–¥–µ—Ä
        document.getElementById('appLoader').classList.remove('active');
    },

    getProducts(catId) { return this.productsMap[catId] || []; },
    
    search(query) {
      const res = []; const q = query.toLowerCase();
      Object.values(this.productsMap).flat().forEach(p => {
        if (p.name.toLowerCase().includes(q)) res.push(p);
      });
      return res;
    },

    async saveSelectionToServer() {
        saveSelectionToCache();
        try {
            await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({
                    action: 'save',
                    initData: TG_INIT_DATA,
                    selection: Array.from(state.selected)
                })
            });
            return true;
        } catch(e) { return false; }
    }
  };

    // üî• –ü–†–ï–û–ë–†–ê–ó–û–í–ê–ù–ò–ï –î–ê–ù–ù–´–• (–ë–≠–ö -> –§–†–û–ù–¢)
    processCatalog(catalogData, newVer) {
        // 1. –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
        this.categories = catalogData.categories.map(c => ({
            id: String(c.id), 
            name: c.name, 
            icon: c.icon
        }));

        // 2. –ü—Ä–æ–¥—É–∫—Ç—ã (–ú–∞—Å—Å–∏–≤ -> Map)
        const newMap = {};
        this.categories.forEach(c => newMap[c.id] = []);

        if (catalogData.products && Array.isArray(catalogData.products)) {
            catalogData.products.forEach(row => {
                // row —Ñ–æ—Ä–º–∞—Ç —Å –±—ç–∫–∞: [0:id, 1:catId, 2:name, 3:macros]
                const pId = String(row[0]);
                const cId = String(row[1]);
                
                if (!newMap[cId]) newMap[cId] = [];
                
                newMap[cId].push({
                    id: pId,
                    name: row[2],
                    meta: row[3] // üî• –í–ê–ñ–ù–û: –ú–∞–ø–ø–∏–Ω–≥ Macros -> Meta
                });
            });
        }

        this.productsMap = newMap;
        this.serverVer = newVer;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –∫—ç—à
        localStorage.setItem('ultima_data_v2', JSON.stringify({
            categories: this.categories,
            productsMap: this.productsMap,
            serverVer: this.serverVer
        }));
        
        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º UI
        renderCategories();
    },

    getProducts(catId) { return this.productsMap[catId] || []; },
    
    search(query) {
      const res = []; const q = query.toLowerCase();
      Object.values(this.productsMap).flat().forEach(p => {
        if (p.name.toLowerCase().includes(q)) res.push(p);
      });
      return res;
    },

    async saveSelectionToServer() {
        // –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
        saveSelectionToCache();
        
        try {
            await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({
                    action: 'save',
                    initData: TG_INIT_DATA,
                    selection: Array.from(state.selected)
                })
            });
            return true;
        } catch(e) { 
            console.error(e);
            return false; 
        }
    }
  };

  // üü¢ 4. STATE MANAGEMENT
  const state = {
    selected: new Set(),
    activeCatId: null,
    searchMode: false,
    renderQueue: [],
    renderIndex: 0,
    BATCH_SIZE: 20,
    currentContainer: null
  };

  function saveSelectionToCache() {
    try { 
        localStorage.setItem('ultima_cart_v1', JSON.stringify(Array.from(state.selected))); 
    } catch(e){}
  }

  const el = {
    catGrid: document.getElementById('catGrid'),
    productList: document.getElementById('productList'),
    viewCats: document.getElementById('view-cats'),
    viewList: document.getElementById('view-list'),
    viewSearch: document.getElementById('view-search'),
    catTitle: document.getElementById('catTitle'),
    btnSelectAll: document.getElementById('btnSelectAll'),
    searchInput: document.getElementById('searchInput'),
    searchClear: document.getElementById('searchClear'),
    searchResults: document.getElementById('searchResults'),
    btnSearchCancel: document.getElementById('btnSearchCancel'),
    btnSave: document.getElementById('btnSave'),
    saveBtnText: document.getElementById('saveBtnText'),
    sentinel: document.getElementById('sentinel')
  };

  // üü¢ 5. UTILS & UI LOGIC (–û–†–ò–ì–ò–ù–ê–õ)
  function haptic(type = 'light') {
    try { 
        const t = window.Telegram?.WebApp?.HapticFeedback; 
        if(t) type==='light'?t.impactOccurred('light'):type==='medium'?t.impactOccurred('medium'):t.notificationOccurred('success'); 
    } catch(e){}
  }

  const bump = el => { 
      if(!el) return; 
      el.classList.remove('bump'); 
      void el.offsetWidth; 
      el.classList.add('bump'); 
  };

  document.addEventListener('touchstart', (e) => {
    const el = e.target.closest('.cat-card, .btn-save');
    if (!el) return; 
    haptic('light'); 
    bump(el);
  }, {passive: true});

  function init() {
    // Fix iOS Background
    let viewportWidth = window.innerWidth;
    const fxLayer = document.querySelector('.fx-layer');
    const fixBackground = () => { fxLayer.style.height = window.innerHeight + 'px'; viewportWidth = window.innerWidth; };
    fixBackground(); 
    window.addEventListener('resize', () => { if (window.innerWidth !== viewportWidth) fixBackground(); });

    DataService.init(); 
    
    el.searchInput.addEventListener('input', handleSearch);
    el.searchClear.addEventListener('click', clearSearch);
    
    if(tg) tg.BackButton.show();

    // Infinite Scroll
    const observer = new IntersectionObserver((entries) => {
      if (entries[0].isIntersecting) renderNextBatch();
    }, { rootMargin: '200px' });
    observer.observe(el.sentinel);
  }

  // --- RENDER LOGIC ---
  function renderCategories() {
    el.catGrid.innerHTML = '';
    DataService.categories.forEach(cat => {
      const products = DataService.getProducts(cat.id);
      const total = products.length;
      const sel = products.filter(i => state.selected.has(i.id)).length;
      const progress = total > 0 ? (sel / total) * 100 : 0;
      
      const card = document.createElement('div');
      card.className = 'cat-card';
      card.onclick = () => openCategory(cat.id);
      
      card.innerHTML = `
        <div style="width: 100%">
          <div class="cat-icon">${cat.icon}</div>
          <div class="cat-name">${cat.name}</div>
        </div>
        <div class="cat-meta">
          <span>${sel} –∏–∑ ${total}</span>
          <div class="mini-track"><div class="mini-fill" style="width: ${progress}%"></div></div>
        </div>
      `;
      el.catGrid.appendChild(card);
    });
  }

  function openCategory(id) {
    state.activeCatId = id;
    const cat = DataService.categories.find(c => c.id === id);
    el.catTitle.textContent = cat.name;
    el.productList.style.display = 'flex';
    
    const products = DataService.getProducts(id);
    startInfiniteRender(products, el.productList);
    
    updateSelectAllBtn();
    el.viewCats.classList.add('prev');
    el.viewCats.classList.remove('active');
    el.viewList.classList.add('active');
    el.viewList.classList.remove('next');
    updateSaveButton(); 
    if(tg) tg.BackButton.show();
  }

  function goBack() {
    state.activeCatId = null;
    el.viewList.classList.remove('active');
    el.viewCats.classList.add('active');
    el.viewCats.classList.remove('prev');
    setTimeout(renderCategories, 300); 
    updateSaveButton();
    if(tg) tg.BackButton.show(); 
  }

  function startInfiniteRender(items, container, isSearch = false) {
    container.innerHTML = '';
    container.style.cssText = ''; 

    if (items.length === 0 && isSearch) {
        container.innerHTML = '<div class="simple-no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
        return; 
    }

    state.renderQueue = items;
    state.renderIndex = 0;
    
    let target = container;
    if (isSearch) {
        const wrapper = document.createElement('div');
        wrapper.className = 'product-list-container';
        wrapper.style.background = 'transparent';
        wrapper.style.border = 'none';
        wrapper.style.boxShadow = 'none';
        container.appendChild(wrapper);
        target = wrapper;
    }
    state.currentContainer = target;
    renderNextBatch(isSearch);
  }

  function renderNextBatch(isSearch = false) {
    if (state.renderIndex >= state.renderQueue.length) return;
    const batch = state.renderQueue.slice(state.renderIndex, state.renderIndex + state.BATCH_SIZE);
    const fragment = document.createDocumentFragment();

    batch.forEach((item, i) => {
      const isSel = state.selected.has(item.id);
      const row = document.createElement('div');
      row.className = `product-row ${isSel ? 'selected' : ''}`;
      
      row.addEventListener('touchstart', () => haptic('light'), {passive: true});
      row.onclick = () => toggleProduct(item.id, row);
      
      // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ø–∏—Å–∫–∞)
      if (!isSearch) {
        row.style.opacity = '0';
        row.style.animation = `fadeInUp 0.2s ease forwards ${i * 0.02}s`;
        setTimeout(() => { row.style.opacity = '1'; row.style.animation = 'none'; row.style.transform = 'none'; }, (i * 20) + 300);
      }
      
      row.innerHTML = `
        <div class="check-square"></div>
        <div class="prod-info">
          <div class="prod-name">${item.name}</div>
          <div class="prod-meta">${item.meta}</div>
        </div>
      `;
      fragment.appendChild(row);
    });

    state.currentContainer.appendChild(fragment);
    state.renderIndex += state.BATCH_SIZE;
  }

  // Inject animation styles
  const styleSheet = document.createElement("style");
  styleSheet.innerText = `@keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }`;
  document.head.appendChild(styleSheet);

  function toggleProduct(id, rowEl) {
    if (state.selected.has(id)) {
      state.selected.delete(id);
      rowEl.classList.remove('selected');
    } else {
      state.selected.add(id);
      rowEl.classList.add('selected');
    }
    
    if (state.searchMode && el.btnSearchCancel) {
        el.btnSearchCancel.textContent = state.selected.size > 0 ? '–í—ã–±—Ä–∞—Ç—å' : '–û—Ç–º–µ–Ω–∞';
        el.btnSearchCancel.style.fontWeight = state.selected.size > 0 ? '600' : '500';
    }

    saveSelectionToCache(); 
    updateSaveButton();
    if (state.activeCatId && !state.searchMode) updateSelectAllBtn();
  }

  function updateSaveButton() {
    let count = 0; let text = '';
    if (state.activeCatId) {
        const products = DataService.getProducts(state.activeCatId);
        count = products.filter(i => state.selected.has(i.id)).length;
        text = count > 0 ? `–í—ã–±—Ä–∞—Ç—å (${count})` : `–ù–∞–∑–∞–¥`;
        el.btnSave.classList.add('visible'); 
    } else {
        count = state.selected.size;
        text = `–°–æ—Ö—Ä–∞–Ω–∏—Ç—å (${count})`;
        if (count > 0) el.btnSave.classList.add('visible');
        else el.btnSave.classList.remove('visible');
    }
    el.saveBtnText.textContent = text;
  }

  function updateSelectAllBtn() {
    if (!state.activeCatId) return;
    const products = DataService.getProducts(state.activeCatId);
    const allSelected = products.length > 0 && products.every(i => state.selected.has(i.id));
    el.btnSelectAll.textContent = allSelected ? '–°–Ω—è—Ç—å –≤—Å—ë' : '–í—ã–±—Ä–∞—Ç—å –≤—Å—ë';
    el.btnSelectAll.onclick = () => toggleAllInCategory(products, !allSelected);
  }

  function toggleAllInCategory(products, select) {
    haptic('medium');
    products.forEach(i => {
      if (select) state.selected.add(i.id);
      else state.selected.delete(i.id);
    });
    saveSelectionToCache(); 
    startInfiniteRender(products, el.productList); 
    updateSelectAllBtn();
    updateSaveButton();
  }

  function handleSearch(e) {
    const query = e.target.value.toLowerCase().trim();
    if (query.length > 0) {
      if (!state.searchMode) enterSearchMode();
      const results = DataService.search(query);
      el.searchResults.style.display = 'block';
      startInfiniteRender(results, el.searchResults, true);
    } else {
      el.searchResults.innerHTML = '';
    }
  }

  function clearSearch() { exitSearchMode(); }

  // üü¢ 6. SAVE & EXIT LOGIC
  async function saveSelection() {
    haptic('success'); 
    
    // –ï—Å–ª–∏ –º—ã –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ - –∫–Ω–æ–ø–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ "–ù–∞–∑–∞–¥"
    if (state.activeCatId && !state.searchMode) {
        goBack();
        return;
    }
    
    const oldText = el.saveBtnText.textContent;
    el.saveBtnText.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
    el.btnSave.style.pointerEvents = 'none'; // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
    
    const ok = await DataService.saveSelectionToServer();
    
    el.btnSave.style.pointerEvents = 'auto'; // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º
    
    if (ok) {
        el.saveBtnText.textContent = "–ì–æ—Ç–æ–≤–æ!";
        setTimeout(() => {
            if (tg && tg.close) tg.close();
            else {
                // –§–æ–ª–ª–±—ç–∫ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞
                alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü—É!");
                if (state.searchMode) exitSearchMode();
                el.saveBtnText.textContent = oldText;
            }
        }, 800);
    } else {
        el.saveBtnText.textContent = "–û—à–∏–±–∫–∞!";
        setTimeout(() => el.saveBtnText.textContent = oldText, 2000);
    }
  }

  function enterSearchMode() {
    state.searchMode = true;
    if (el.btnSearchCancel) {
        el.btnSearchCancel.textContent = '–û—Ç–º–µ–Ω–∞';
        el.btnSearchCancel.style.fontWeight = '500';
    }
    document.body.classList.add('search-active');
    el.viewCats.classList.remove('active');
    el.viewList.classList.remove('active');
    el.viewSearch.classList.add('active');
    if(tg) tg.BackButton.show();
  }

  function exitSearchMode() {
    state.searchMode = false;
    document.body.classList.remove('search-active'); 
    el.searchInput.blur(); 
    el.viewSearch.classList.remove('active');
    el.searchResults.style.display = 'none';
    el.searchInput.value = '';
    
    if (state.activeCatId) el.viewList.classList.add('active');
    else {
        el.viewCats.classList.add('active');
        renderCategories();
    }
    updateSaveButton();
  }

  // START APP
  init();
</script>
</body>
</html>
