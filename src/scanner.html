<!DOCTYPE html>
<html lang="ru">
<head>
<script src="version-control.js?t=1"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
<title>Ultima FoodCam</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
 :root {
  --bg-core: #050505;
  --orb-purple: rgba(108, 92, 231, 0.8);
  --acc-blue: #0a84ff;
  --surface-glass: rgba(28, 28, 30, 0.65);
  --acc-green: #30d158;
  --acc-red: #ff453a;
  --acc-orange: #ff9f0a;
  --text-main: #ffffff;
  --text-muted: rgba(255, 255, 255, 0.55);
  --font-stack: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Roboto', sans-serif;
  --safe-bottom: calc(12px + env(safe-area-inset-bottom));
}

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

/* === 1. BODY IS STATIC (FIX –î–õ–Ø –ö–õ–ê–í–ò–ê–¢–£–†–´) === */
html, body {
  background-color: #000000; /* –°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç –±–µ–ª—ã—Ö –≤—Å–ø—ã—à–µ–∫ */
  margin: 0; padding: 0; 
  width: 100%; 
  height: 100%; /* 100% –Ω–∞–¥–µ–∂–Ω–µ–µ —á–µ–º 100vh –Ω–∞ iOS */
  overflow: hidden; 
  position: fixed; 
  top: 0; left: 0;
  overscroll-behavior: none;
  touch-action: none; 
  font-family: var(--font-stack);
}

/* === 2. –§–û–ù (–ù–ï –†–ï–ê–ì–ò–†–£–ï–¢ –ù–ê –ö–õ–ê–í–ò–ê–¢–£–†–£) === */
.fx-layer { 
  position: fixed; 
  top: 0; left: 0; 
  width: 100vw; 
  height: 100vh; 
  z-index: 0; /* –õ–µ–∂–∏—Ç –ø–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º */
  pointer-events: none; 
  overflow: hidden;
  background-color: var(--bg-core);
}

.orb { 
  position: absolute; border-radius: 50%; 
  will-change: transform; filter: blur(80px); 
}
.orb-1 { 
  width: 100vw; height: 100vw; opacity: 0.8; 
  background: radial-gradient(circle, var(--orb-purple) 0%, transparent 70%); 
  top: -20%; left: -10%; animation: float 30s infinite linear; 
}
.orb-2 { 
  width: 300px; height: 300px; opacity: 0.4; 
  background: radial-gradient(circle, var(--acc-blue) 0%, transparent 70%); 
  bottom: -50px; right: -50px; animation: breathe 8s infinite ease-in-out; 
}
.noise { 
  position: fixed; inset: 0; opacity: 0.05; 
  background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); 
  pointer-events: none; 
}

@keyframes float { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.3; } 50% { transform: scale(1.2); opacity: 0.5; } }

/* === 3. –ò–ù–¢–ï–†–§–ï–ô–° (–†–ï–ê–ì–ò–†–£–ï–¢ –ù–ê –ö–õ–ê–í–ò–ê–¢–£–†–£) === */
.app-layout {
  position: absolute; 
  z-index: 1; 
  top: 0; left: 0; right: 0;
  /* –í—ã—Å–æ—Ç–∞ –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è JS-–æ–º (visualViewport) */
  overflow: hidden;
  display: flex; 
  flex-direction: column;
}

/* === –ö–ê–õ–ï–ù–î–ê–†–¨ === */
.calendar-block {
  flex: 0 0 auto; /* –ù–µ —Å–∂–∏–º–∞—Ç—å—Å—è */
  position: absolute; /* –ü–∞—Ä–∏—Ç —Å–≤–µ—Ä—Ö—É */
  top: 0; left: 0; right: 0;
  z-index: 50;
  background: transparent;
  padding-top: calc(12px + env(safe-area-inset-top));
  padding-bottom: 8px;
  user-select: none;
  transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
}
.calendar-header { display: flex; align-items: center; justify-content: space-between; padding: 0 16px 8px 16px; }
.month-label { font-size: 11px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.9; }
.calendar-swipe-area { width: 100%; height: 52px; overflow: hidden; position: relative; touch-action: pan-y; cursor: grab; }
.calendar-track { display: flex; width: 300%; height: 100%; transform: translateX(-33.333333%); will-change: transform; }
.calendar-week { flex: 1; display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; height: 100%; padding: 0 10px; }
.day-cell { height: 52px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; background: transparent; transition: background 0.2s, transform 0.1s; position: relative; cursor: pointer; user-select: none; }
.day-cell:active { transform: scale(0.92); }
.dc-name { font-size: 9px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 3px; }
.dc-num { font-size: 17px; font-weight: 600; color: var(--text-main); font-variant-numeric: tabular-nums; font-feature-settings: "tnum"; }
.day-cell.selected { background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05)); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 4px 12px rgba(0,0,0,0.2); transform: scale(1); }
.day-cell.selected .dc-name { color: #fff; opacity: 0.8; }
.day-cell.selected .dc-num { color: #fff; font-weight: 700; }
.day-cell.is-today::after { content: ''; position: absolute; bottom: 5px; width: 4px; height: 4px; border-radius: 50%; background: #0a84ff; box-shadow: 0 0 6px #0a84ff; }

/* === –í–ò–î–ñ–ï–¢–´ === */
.dashboard-layer {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 15; 
  padding-top: calc(90px + env(safe-area-inset-top)); 
  transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s;
  pointer-events: none;
}
.dashboard-layer.hidden-mode { transform: translateY(-30px); opacity: 0; pointer-events: none !important; }
.carousel-wrap { pointer-events: auto; }
.carousel-track { display: flex; gap: 12px; padding: 30px 16px 40px 16px; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; cursor: grab; }
.carousel-track::-webkit-scrollbar { display: none; }
.widget { flex: 0 0 calc(100% - 16px); scroll-snap-align: center; height: 160px; border-radius: 28px; background: rgba(20, 20, 20, 0.75); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); position: relative; overflow: hidden; padding: 16px 12px; transition: 0.3s ease; }
/* Styles for macros/water widgets... (–°–æ–∫—Ä–∞—â–µ–Ω–æ –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏, —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å —Ç–µ –∂–µ) */
.macros-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; height: 100%; align-items: center; }
.macro-item { display: flex; flex-direction: column; align-items: center; justify-content: center; }
.donut-box { width: 100%; max-width: 74px; aspect-ratio: 1; position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; }
.mini-donut { width: 100%; height: 100%; transform: rotate(-90deg); filter: drop-shadow(0 4px 8px rgba(0,0,0,0.25)); }
.md-bg { fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 7; }
.md-val { fill: none; stroke-width: 7; stroke-linecap: round; stroke-dasharray: 151; transition: stroke-dashoffset 1s ease; }
.m-icon { position: absolute; font-size: 20px; }
.m-data { display: flex; flex-direction: column; align-items: center; }
.m-nums { font-size: 13px; font-weight: 800; color: #fff; font-variant-numeric: tabular-nums; }
.m-nums span { color: rgba(255,255,255,0.45); font-size: 11px; margin-left: 1px; }
.m-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; color: rgba(255,255,255,0.5); margin-top: 2px; }
.stroke-kcal { stroke: url(#grad-kcal); } .stroke-prot { stroke: url(#grad-prot); } .stroke-fats { stroke: url(#grad-fats); } .stroke-carb { stroke: url(#grad-carb); }
.widget.water-widget { display: flex; flex-direction: column; padding: 16px 20px; justify-content: space-between; }
.water-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.water-title { font-size: 11px; font-weight: 800; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-muted); opacity: 0.8; }
.water-percent { font-size: 12px; font-weight: 700; color: var(--acc-blue); transition: color 0.3s; }
.widget.is-overload .water-percent { color: #00f2ea; text-shadow: 0 0 8px rgba(0, 242, 234, 0.6); }
.water-cols { display: flex; justify-content: space-between; align-items: flex-end; height: 50px; gap: 6px; margin: 8px 0; }
.water-tube { flex: 1; height: 100%; background: rgba(0,0,0,0.4); border-radius: 6px; border: 1px solid rgba(255,255,255,0.06); position: relative; overflow: hidden; }
.water-fill { position: absolute; bottom: 0; left: 0; right: 0; height: var(--h, 0%); background: var(--acc-blue); transition: height 0.3s cubic-bezier(0.25, 1, 0.5, 1), background-color 0.3s; box-shadow: 0 0 12px rgba(10, 132, 255, 0.5); }
.water-fill::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: rgba(255,255,255,0.6); opacity: 0.8; }
.widget.is-overload .water-fill { background: #00f2ea; box-shadow: 0 0 15px rgba(0, 242, 234, 0.6); }
.water-footer { display: flex; justify-content: space-between; align-items: flex-end; }
.water-info { display: flex; flex-direction: column; gap: 2px; }
.wf-row { display: flex; align-items: baseline; gap: 4px; }
.wf-fact { font-size: 28px; font-weight: 800; color: #fff; line-height: 1; letter-spacing: -0.5px; }
.wf-unit { font-size: 12px; font-weight: 600; color: var(--text-muted); }
.wf-plan { font-size: 11px; font-weight: 500; color: var(--text-muted); opacity: 0.7; }
.water-controls { display: flex; gap: 24px; }
.water-btn { width: 54px; height: 44px; border-radius: 14px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); color: #fff; font-size: 22px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
.water-btn:active { background: var(--acc-blue); transform: scale(0.92); }
.dots { display: flex; justify-content: center; gap: 6px; margin-top: 0px; pointer-events: none; transform: translateY(-20px); }
.dot { width: 6px; height: 6px; border-radius: 10px; background: rgba(255,255,255,0.2); transition: 0.3s; }
.dot.active { width: 20px; background: #fff; }

/* === OMNI-BAR === */
.omni-bar { 
  position: absolute; /* Absolute –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –Ω–∏–∑—É app-layout */
  bottom: 0; left: 0; right: 0; 
  background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, transparent 100%); 
  padding: 10px 12px calc(10px + env(safe-area-inset-bottom)) 12px; 
  z-index: 100; 
  display: flex; align-items: flex-end; gap: 10px; 
  transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
  border-top: none;
}
.omni-bar.hidden { transform: translateY(100%); }
.omni-icon-btn, .cam-trigger-btn { width: 44px !important; height: 44px !important; border-radius: 50% !important; background: rgba(255, 255, 255, 0.1) !important; backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; transition: 0.2s; }
.cam-trigger-btn.mode-send { background-color: rgba(255, 255, 255, 0.1) !important; box-shadow: none !important; }
.cam-trigger-btn:active, .omni-icon-btn:active { background: rgba(255,255,255,0.2) !important; transform: scale(0.92); }
.input-wrap { flex: 1; min-height: 44px; background: rgba(20, 20, 20, 0.5); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 22px; padding: 2px 16px; display: flex; align-items: center; transition: border-color 0.2s; }
.input-wrap:focus-within { border-color: rgba(255, 255, 255, 0.3); background: rgba(20, 20, 20, 0.7); }
.omni-input { width: 100%; background: transparent; border: none; color: #fff; font-size: 16px; resize: none; padding: 11px 0; margin: 0; max-height: 100px; font-family: inherit; line-height: 20px; }
.omni-input::placeholder { color: rgba(255,255,255,0.5); }
.icon-hidden { display: none !important; }
.omni-btn-icon { width: 24px; height: 24px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
#icoSend { margin-right: 2px; margin-top: 2px; }

/* === CAMERA VIEWPORT === */
.cam-viewport {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  z-index: 0; /* –ü–æ–¥ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º */
  margin: 0; padding: 0;
  display: flex;
}
#video { width: 100%; height: 100%; object-fit: cover !important; position: absolute; inset: 0; }
.cam-loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 5; display: flex; align-items: center; justify-content: center; pointer-events: none; }
.spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
#uiCanvas { position: absolute; inset: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
.ui-layer { position: absolute; inset: 0; z-index: 20; display: flex; flex-direction: column; justify-content: space-between; padding: calc(16px + env(safe-area-inset-top)) 16px calc(32px + env(safe-area-inset-bottom)) 16px; pointer-events: none; transition: opacity 0.3s ease; }
.ui-layer.idle { opacity: 0; pointer-events: none; }
.top-bar { display: flex; justify-content: space-between; align-items: center; pointer-events: auto; height: 48px; }
.btn-close { width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.4); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; color: #fff !important; cursor: pointer; border: 1px solid rgba(255,255,255,0.3) !important; }
.status-chip { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 8px 16px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 600; color: #fff !important; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
.status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--acc-orange); box-shadow: 0 0 8px var(--acc-orange); transition: 0.3s; }
.status-dot.ok { background: var(--acc-green); box-shadow: 0 0 8px var(--acc-green); }
.controls-grid { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; pointer-events: auto; width: 100%; margin-bottom: 10px; }
.grid-cell-left { display: flex; justify-content: flex-start; } .grid-cell-center { display: flex; justify-content: center; } .grid-cell-right { display: flex; justify-content: flex-end; }
.action-btn { width: 56px; height: 56px; border-radius: 50%; background: rgba(30,30,30,0.6); backdrop-filter: blur(12px); display: flex; align-items: center; justify-content: center; color: #fff; border: 1px solid rgba(255,255,255,0.15); cursor: pointer; transition: transform 0.15s, background 0.2s; }
.action-btn:active { transform: scale(0.92); background: rgba(60,60,60,0.8); }
.action-btn.hidden { opacity: 0; pointer-events: none; } .action-btn.disabled { opacity: 0.5; pointer-events: none; }
.shutter-outer { width: 80px; height: 80px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.8); display:flex; align-items:center; justify-content:center; transition: 0.3s; background: transparent; }
.shutter-inner { width: 62px; height: 62px; border-radius: 50%; background: #fff; transition: 0.3s; cursor: pointer; }
.shutter-outer.disabled { border-color: rgba(255, 69, 58, 0.5); }
.shutter-outer.disabled .shutter-inner { background: var(--acc-red); transform: scale(0.4); opacity: 0.8; }
.shutter-outer.active { border-color: var(--acc-green); transform: scale(1.05); }
.shutter-outer:active:not(.disabled) .shutter-inner { transform: scale(0.9); }
.cam-toast { position: absolute; top: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: #fff; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 500; pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 50; backdrop-filter: blur(4px); }
.cam-toast.visible { opacity: 1; }

/* === OVERLAYS (PERM, PREVIEW, DRAFT) === */
.perm-overlay { position: absolute; inset: 0; z-index: 100; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 32px; gap: 24px; }
.perm-btn { background: var(--acc-blue); color: #fff; border: none; padding: 14px 28px; border-radius: 14px; font-size: 16px; font-weight: 600; cursor: pointer; }
.preview-overlay { position: absolute; inset: 0; z-index: 200; background: #000; display: none; flex-direction: column; height: 100%; overflow: hidden; }
.preview-img { flex: 1; width: 100%; object-fit: contain; background: #111; margin-bottom: 12px; min-height: 0; }
.comment-wrap { flex-shrink: 0; padding: 0 24px 16px 24px; width: 100%; }
.comment-label { display: block; color: rgba(255,255,255,0.6); font-size: 13px; margin-bottom: 8px; margin-left: 4px; }
.comment-input { width: 100%; height: 80px; background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 12px 16px; color: #fff; font-size: 16px; font-family: var(--font-stack); resize: none; outline: none; transition: 0.2s; }
.comment-input:focus { background: rgba(255,255,255,0.18); border-color: var(--acc-blue); }
.preview-controls { flex-shrink: 0; padding: 0 24px 34px 24px; display: flex; gap: 16px; background: #000; }
.btn { flex: 1; padding: 14px; border-radius: 14px; font-weight: 600; font-size: 16px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.1); color: #fff; cursor: pointer; text-align: center; }
.btn.primary { background: var(--acc-blue); border-color: transparent; }
.hidden { display: none !important; }

/* PROCESSING & DRAFT */
.processing-overlay { position: fixed; inset: 0; z-index: 1000; background: rgba(5, 5, 5, 0.6); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.4s ease; }
.processing-overlay.active { opacity: 1; pointer-events: auto; }
.proc-card { width: 90%; max-width: 320px; background: rgba(30, 30, 30, 0.6); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 30px 20px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
.proc-visual { position: relative; width: 60px; height: 60px; margin-bottom: 20px; }
.proc-orb { position: absolute; inset: 0; border-radius: 50%; background: radial-gradient(circle, #0a84ff 0%, transparent 70%); animation: pulse-ai 2s infinite; }
.proc-ring { position: absolute; inset: -10px; border-radius: 50%; border: 2px solid rgba(10, 132, 255, 0.3); border-top-color: #0a84ff; animation: spin-ai 1.5s infinite linear; }
@keyframes pulse-ai { 0% { opacity: 0.5; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.5; transform: scale(0.8); } }
@keyframes spin-ai { 100% { transform: rotate(360deg); } }
.proc-title { font-size: 17px; font-weight: 700; color: #fff; margin-bottom: 20px; letter-spacing: 0.5px; }
.proc-steps { width: 100%; display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
.step { display: flex; align-items: center; gap: 10px; opacity: 0.4; transition: 0.3s; transform: translateX(-10px); }
.step.active { opacity: 1; transform: translateX(0); font-weight: 600; } .step.done { opacity: 0.5; transform: translateX(0); color: var(--acc-green); }
.s-icon { font-size: 14px; width: 20px; text-align: center; } .s-lbl { font-size: 13px; color: #fff; }
.proc-close { margin-top: 10px; font-size: 13px; color: rgba(255,255,255,0.4); text-decoration: underline; cursor: pointer; }
.draft-overlay { position: fixed; inset: 0; z-index: 1100; background: rgba(0,0,0,0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); display: flex; flex-direction: column; justify-content: flex-end; opacity: 0; pointer-events: none; transition: 0.3s; }
.draft-overlay.visible { opacity: 1; pointer-events: auto; }
.draft-sheet { background: #1c1c1e; border-radius: 24px !important; border: 1px solid rgba(255,255,255,0.1); margin: 0 12px calc(12px + env(safe-area-inset-bottom)) 12px; padding: 24px 20px 20px 20px; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.1, 0.8, 0.2, 1); max-height: 80vh; overflow-y: auto; }
.draft-overlay.visible .draft-sheet { transform: translateY(0); }
.ds-header { margin-bottom: 20px; }
.ds-title { font-size: 22px; font-weight: 800; margin-bottom: 8px; color: #fff; letter-spacing: 0.3px; }
.ds-subtitle { font-size: 13px; color: rgba(255,255,255,0.6); line-height: 1.5; }
.draft-item { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.06); padding: 12px; border-radius: 16px; margin-bottom: 10px; }
.di-icon { font-size: 20px; } .di-inputs { flex: 1; display: flex; flex-direction: column; gap: 6px; }
.di-name { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; padding: 8px 12px; margin-bottom: 4px; color: #fff; font-size: 16px; font-weight: 600; width: 100%; transition: border-color 0.2s, background 0.2s; }
.di-name:focus { background: rgba(255,255,255,0.1); border-color: #0a84ff; }
.di-row { display: flex; align-items: center; gap: 8px; }
.di-weight { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #0a84ff; font-weight: 700; width: 60px; text-align: center; padding: 6px; font-size: 15px; -moz-appearance: textfield; }
.di-weight::-webkit-inner-spin-button { -webkit-appearance: none; }
.di-unit { font-size: 13px; color: var(--text-muted); }
.di-del { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; color: var(--acc-red); opacity: 0.7; cursor: pointer; }
.ds-actions { display: flex; gap: 12px; margin-top: 20px; }
.ds-btn { flex: 1; height: 48px; border-radius: 14px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; }
.ds-btn.sec { background: rgba(255,255,255,0.1); color: #fff; } .ds-btn.prim { background: var(--acc-blue); color: #fff; box-shadow: 0 4px 12px rgba(10,132,255,0.3); }
</style>
</head>
<body>
  <div class="fx-layer" id="fxLayer">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="noise"></div>
  </div>

  <div class="app-layout" id="appLayout">
    <div class="calendar-block" id="calendarBlock">
      <div class="calendar-header">
        <div class="month-label" id="monthLabel">...</div>
      </div>
      <div class="calendar-swipe-area" id="swipeArea">
        <div class="calendar-track" id="calTrack">
          <div class="calendar-week" id="weekPrev"></div>
          <div class="calendar-week" id="weekCurr"></div>
          <div class="calendar-week" id="weekNext"></div>
        </div>
      </div>
    </div>

    <div class="cam-viewport">
      <video id="video" autoplay playsinline muted></video>
      <div id="loader" class="cam-loader hidden"><div class="spinner"></div></div>

      <svg width="0" height="0" style="position:absolute">
        <defs>
          <linearGradient id="grad-kcal"><stop offset="0%" stop-color="#ff9f0a"/><stop offset="100%" stop-color="#ff453a"/></linearGradient>
          <linearGradient id="grad-prot"><stop offset="0%" stop-color="#48bfe3"/><stop offset="100%" stop-color="#5e60ce"/></linearGradient>
          <linearGradient id="grad-fats"><stop offset="0%" stop-color="#f1c40f"/><stop offset="100%" stop-color="#e67e22"/></linearGradient>
          <linearGradient id="grad-carb"><stop offset="0%" stop-color="#2ecc71"/><stop offset="100%" stop-color="#1abc9c"/></linearGradient>
        </defs>
      </svg>

      <div class="dashboard-layer" id="dashboardLayer">
        <div class="carousel-wrap">
          <div class="carousel-track" id="widgetTrack">
            <div class="widget">
              <div class="macros-grid">
                <div class="macro-item"><div class="donut-box"><svg class="mini-donut" viewBox="0 0 60 60"><circle class="md-bg" cx="30" cy="30" r="24"/><circle class="md-val stroke-kcal" cx="30" cy="30" r="24" style="stroke-dashoffset: 45px"/></svg><div class="m-icon">üî•</div></div><div class="m-data"><div class="m-nums">1450<span>/2100</span></div><div class="m-lbl">–ö–ö–ê–õ</div></div></div>
                <div class="macro-item"><div class="donut-box"><svg class="mini-donut" viewBox="0 0 60 60"><circle class="md-bg" cx="30" cy="30" r="24"/><circle class="md-val stroke-prot" cx="30" cy="30" r="24" style="stroke-dashoffset: 100px"/></svg><div class="m-icon">üêì</div></div><div class="m-data"><div class="m-nums">110<span>/160</span></div><div class="m-lbl">–ë–ï–õ–ö–ò</div></div></div>
                <div class="macro-item"><div class="donut-box"><svg class="mini-donut" viewBox="0 0 60 60"><circle class="md-bg" cx="30" cy="30" r="24"/><circle class="md-val stroke-fats" cx="30" cy="30" r="24" style="stroke-dashoffset: 110px"/></svg><div class="m-icon">ü•ë</div></div><div class="m-data"><div class="m-nums">45<span>/70</span></div><div class="m-lbl">–ñ–ò–†–´</div></div></div>
                <div class="macro-item"><div class="donut-box"><svg class="mini-donut" viewBox="0 0 60 60"><circle class="md-bg" cx="30" cy="30" r="24"/><circle class="md-val stroke-carb" cx="30" cy="30" r="24" style="stroke-dashoffset: 60px"/></svg><div class="m-icon">üåæ</div></div><div class="m-data"><div class="m-nums">180<span>/250</span></div><div class="m-lbl">–£–ì–õ–ò</div></div></div>
              </div>
            </div>
            <div class="widget water-widget" id="waterCard">
              <div class="water-header"><div class="water-title">–í–æ–¥–Ω—ã–π –±–∞–ª–∞–Ω—Å</div><div class="water-percent" id="lbl-pct">0%</div></div>
              <div class="water-cols">
                <div class="water-tube"><div class="water-fill" id="c1"></div></div>
                <div class="water-tube"><div class="water-fill" id="c2"></div></div>
                <div class="water-tube"><div class="water-fill" id="c3"></div></div>
                <div class="water-tube"><div class="water-fill" id="c4"></div></div>
                <div class="water-tube"><div class="water-fill" id="c5"></div></div>
              </div>
              <div class="water-footer">
                <div class="water-info"><div class="wf-row"><div class="wf-fact" id="lbl-fact">0</div><div class="wf-unit">–º–ª</div></div><div class="wf-plan">–¶–µ–ª—å: 2500</div></div>
                <div class="water-controls">
                  <div class="water-btn" onclick="updateWater(-250)">‚àí</div>
                  <div class="water-btn" onclick="updateWater(250)">+</div>
                </div>
              </div>
            </div>
          </div>
          <div class="dots"><div class="dot active"></div><div class="dot"></div></div>
        </div>
      </div>

      <canvas id="uiCanvas"></canvas>
      <div id="camToast" class="cam-toast">Camera</div>

      <div class="ui-layer idle" id="camUI">
        <div class="top-bar">
          <div class="btn-close" id="btnClose"><svg class="icon-svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></div>
          <div class="status-chip" id="lvlChip"><div class="status-dot" id="lvlDot"></div><span id="lvlText">–£—Ä–æ–≤–µ–Ω—å</span></div>
          <div class="spacer"></div>
        </div>
        <div class="controls-grid">
          <div class="grid-cell-left"><div class="action-btn" id="btnTorch"><svg class="icon-svg" viewBox="0 0 24 24"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg></div></div>
          <div class="grid-cell-center"><div class="shutter-outer disabled" id="shutterBtn"><div class="shutter-inner"></div></div></div>
          <div class="grid-cell-right"><div class="action-btn hidden" id="btnSwitch"><svg class="icon-svg" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg></div></div>
        </div>
      </div>

      <div class="omni-bar" id="omniBar">
        <div class="omni-icon-btn"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg></div>
        <div class="input-wrap"><textarea class="omni-input" rows="1" placeholder="–Ø–±–ª–æ–∫–æ 200–≥, –∫–æ—Ñ–µ..."></textarea></div>
        <div class="cam-trigger-btn" id="btnStartCam">
          <svg id="icoCam" class="omni-btn-icon" viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
          <svg id="icoSend" class="omni-btn-icon icon-hidden" viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
        </div>
      </div>
    </div>
  </div>

  <div id="permReq" class="perm-overlay hidden">
    <div style="font-size:48px; margin-bottom:10px">üìê</div>
    <h2 style="margin:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∞</h2>
    <p style="color:var(--text-muted)">–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –¥–∞—Ç—á–∏–∫–∞–º.</p>
    <button class="perm-btn" onclick="requestSensors()">–†–∞–∑—Ä–µ—à–∏—Ç—å</button>
  </div>

  <div id="previewScreen" class="preview-overlay">
    <img id="finalPhoto" class="preview-img">
    <div class="comment-wrap">
      <label class="comment-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
      <textarea id="commentInput" class="comment-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Ä–∏—Å 200, —Ç—Ä–µ—Å–∫–∞ 150"></textarea>
    </div>
    <div class="preview-controls">
      <button class="btn" onclick="retake()">–ü–µ—Ä–µ—Å–Ω—è—Ç—å</button>
      <button class="btn primary" id="btnSend" onclick="sendPhoto()">–ì–æ—Ç–æ–≤–æ</button>
    </div>
  </div>

  <div class="processing-overlay" id="procOverlay">
    <div class="proc-card">
      <div class="proc-visual"><div class="proc-orb"></div><div class="proc-ring"></div></div>
      <div class="proc-title">–ê–Ω–∞–ª–∏–∑ —Å–Ω–∏–º–∫–∞</div>
      <div class="proc-steps" id="procSteps"></div>
      <div class="proc-close" onclick="cancelProcessing()">–û—Ç–º–µ–Ω–∞</div>
    </div>
  </div>

  <div class="draft-overlay" id="draftOverlay">
    <div class="draft-sheet">
      <div class="ds-header"><div class="ds-title">–ü—Ä–æ–≤–µ—Ä—å –¥–∞–Ω–Ω—ã–µ</div><div class="ds-subtitle">AI –æ–ø—Ä–µ–¥–µ–ª–∏–ª —Å–æ—Å—Ç–∞–≤. –ò—Å–ø—Ä–∞–≤—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.</div></div>
      <div class="ds-list" id="draftList"></div>
      <div class="ds-actions">
        <button class="ds-btn sec" onclick="closeDraft()">–û—Ç–º–µ–Ω–∞</button>
        <button class="ds-btn prim" id="btnConfirmDraft" onclick="confirmDraftToNutritionist()">–í –¥–Ω–µ–≤–Ω–∏–∫</button>
      </div>
    </div>
  </div>

<script>
// === –ë–ï–ó–£–ü–†–ï–ß–ù–´–ô –†–ï–°–ê–ô–ó (VISUAL VIEWPORT) ===
(function initStableLayout() {
  const app = document.getElementById('appLayout'); 
  const fxLayer = document.getElementById('fxLayer');
  function handleResize() {
    const vh = window.visualViewport ? window.visualViewport.height : window.innerHeight;
    const fullH = window.innerHeight;
    if (app) { app.style.height = `${vh}px`; app.style.overflow = 'hidden'; }
    if (fxLayer) { fxLayer.style.height = `${fullH}px`; }
    window.scrollTo(0, 0);
  }
  if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', handleResize);
    window.visualViewport.addEventListener('scroll', handleResize);
  }
  window.addEventListener('resize', handleResize);
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.ready(); tg.expand();
    if(tg.isVersionAtLeast('7.7')) tg.disableVerticalSwipes();
    tg.onEvent('viewportChanged', handleResize);
  }
  handleResize();
  document.querySelectorAll('input, textarea').forEach(el => {
     el.addEventListener('focus', () => { setTimeout(handleResize, 100); });
     el.addEventListener('blur', () => { setTimeout(handleResize, 100); });
  });
})();

// === CONFIG & INIT ===
const API_URL = "https://script.google.com/macros/s/AKfycbx0fUaaCH-JwnG5R_3TFgU5FSibsEuhuS0ZZZfyxPNVPQ1ZpCfUIaa5aE8vjgqitac/exec";
const tg = window.Telegram?.WebApp;
if(tg) { tg.ready(); tg.expand(); tg.setHeaderColor('#000000'); }

const API = {
  blobToBase64: (blob) => { return new Promise((resolve, _) => { const reader = new FileReader(); reader.onloadend = () => { resolve(reader.result); }; reader.readAsDataURL(blob); }); },
  send: async (action, payload) => {
    const user = tg?.initDataUnsafe?.user || { id: 0, first_name: 'BrowserTest' };
    const body = { action, user, initData: tg?.initData || '', ...payload };
    const response = await fetch(API_URL, { method: "POST", headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify(body) });
    const json = await response.json();
    if (!json.ok) throw new Error(json.error || 'Server Error');
    return json;
  }
};

const state = { stream: null, track: null, levelOK: false, angleX: 0, angleY: 0, photoBlob: null, isCapturing: false, isSwitching: false, devices: [], currentDevIdx: 0, torchOn: false, sensorActive: false, uiMode: 'menu' };
const DOM = {
  video: document.getElementById('video'), canvas: document.getElementById('uiCanvas'), ctx: document.getElementById('uiCanvas').getContext('2d'), shutter: document.getElementById('shutterBtn'),
  lvlDot: document.getElementById('lvlDot'), lvlText: document.getElementById('lvlText'), permReq: document.getElementById('permReq'), preview: document.getElementById('previewScreen'),
  finalImg: document.getElementById('finalPhoto'), btnSend: document.getElementById('btnSend'), commentInput: document.getElementById('commentInput'), btnTorch: document.getElementById('btnTorch'),
  btnSwitch: document.getElementById('btnSwitch'), toast: document.getElementById('camToast'), loader: document.getElementById('loader'),
  omniBar: document.getElementById('omniBar'), camUI: document.getElementById('camUI'), omniInput: document.querySelector('.omni-input'),
  icoCam: document.getElementById('icoCam'), icoSend: document.getElementById('icoSend'), btnStartCam: document.getElementById('btnStartCam'), btnClose: document.getElementById('btnClose')
};

// === LOGIC ===
DOM.omniInput.addEventListener('input', () => {
  const hasText = DOM.omniInput.value.trim().length > 0;
  DOM.omniInput.style.height = 'auto'; DOM.omniInput.style.height = Math.min(DOM.omniInput.scrollHeight, 80) + 'px';
  if (hasText) { DOM.btnStartCam.classList.add('mode-send'); DOM.icoCam.classList.add('icon-hidden'); DOM.icoSend.classList.remove('icon-hidden'); } 
  else { DOM.btnStartCam.classList.remove('mode-send'); DOM.icoCam.classList.remove('icon-hidden'); DOM.icoSend.classList.add('icon-hidden'); }
});

// === UTILS ===
let toastTimer;
function showToast(msg) { DOM.toast.textContent = msg; DOM.toast.classList.add('visible'); clearTimeout(toastTimer); toastTimer = setTimeout(() => { DOM.toast.classList.remove('visible'); }, 2000); }
function haptic(style) { if (!tg || !tg.HapticFeedback) return; if (['error', 'success', 'warning'].includes(style)) { tg.HapticFeedback.notificationOccurred(style); } else { tg.HapticFeedback.impactOccurred(style); } }

// === CAMERA FUNCTIONS ===
function stopStream() {
  if (state.stream) { state.stream.getTracks().forEach(t => t.stop()); state.stream = null; }
  state.track = null; state.torchOn = false; updateTorchUI(); DOM.video.srcObject = null; DOM.video.classList.remove('active');
}
async function startStream(deviceId) {
  if (state.stream) stopStream();
  const constraints = { audio: false, video: { deviceId: deviceId ? { exact: deviceId } : undefined, facingMode: deviceId ? undefined : 'environment', width: { ideal: 1920 }, height: { ideal: 2560 } } };
  try {
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    state.stream = stream; state.track = stream.getVideoTracks()[0]; DOM.video.srcObject = stream; DOM.video.classList.add('active');
    const settings = state.track.getSettings(); if (settings.deviceId) localStorage.setItem('ultima_cam_id', settings.deviceId);
    const caps = state.track.getCapabilities(); if (caps.focusMode?.includes('continuous')) { try { await state.track.applyConstraints({ advanced: [{ focusMode: 'continuous' }] }); } catch(e){} }
  } catch (e) { if (deviceId) { localStorage.removeItem('ultima_cam_id'); await startStream(null); } else { alert("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: " + e.message); } }
}
async function initCamera() { try { const savedId = localStorage.getItem('ultima_cam_id'); await startStream(savedId); await updateDeviceList(); resizeCanvas(); window.addEventListener('resize', resizeCanvas); requestAnimationFrame(drawLoop); checkSensorPerms(); } catch (e) { console.warn("Init Error:", e); } }
async function updateDeviceList() { try { const allDevices = await navigator.mediaDevices.enumerateDevices(); state.devices = allDevices.filter(d => d.kind === 'videoinput'); if (state.devices.length > 1) { DOM.btnSwitch.classList.remove('hidden'); } else { DOM.btnSwitch.classList.add('hidden'); } if (state.track) { const currentId = state.track.getSettings().deviceId; state.currentDevIdx = state.devices.findIndex(d => d.deviceId === currentId); if(state.currentDevIdx === -1) state.currentDevIdx = 0; } } catch(e) {} }

// === CONTROL HANDLERS ===
DOM.btnSwitch.onclick = async () => { if (state.devices.length < 2 || state.isSwitching) return; state.isSwitching = true; haptic('medium'); DOM.loader.classList.remove('hidden'); DOM.btnSwitch.classList.add('disabled'); DOM.btnTorch.classList.add('disabled'); DOM.shutter.classList.add('disabled'); const svg = DOM.btnSwitch.querySelector('svg'); svg.style.transition = 'transform 0.4s'; svg.style.transform = 'rotate(180deg)'; if (state.stream) state.stream.getTracks().forEach(t => t.stop()); await new Promise(r => setTimeout(r, 500)); let nextIdx = state.currentDevIdx + 1; if (nextIdx >= state.devices.length) nextIdx = 0; state.currentDevIdx = nextIdx; await startStream(state.devices[nextIdx].deviceId); DOM.loader.classList.add('hidden'); DOM.btnSwitch.classList.remove('disabled'); DOM.btnTorch.classList.remove('disabled'); DOM.shutter.classList.remove('disabled'); state.isSwitching = false; setTimeout(() => svg.style.transform = '', 400); };
DOM.btnTorch.onclick = async () => { if(!state.track) return; const caps = state.track.getCapabilities(); if (!caps.torch) { showToast("–í—Å–ø—ã—à–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"); haptic('error'); return; } const newState = !state.torchOn; try { await state.track.applyConstraints({ advanced: [{ torch: newState }] }); state.torchOn = newState; updateTorchUI(); haptic('light'); } catch(e) { showToast("–û—à–∏–±–∫–∞ –≤—Å–ø—ã—à–∫–∏"); } };
function updateTorchUI() { if (state.torchOn) { DOM.btnTorch.style.backgroundColor = 'var(--acc-orange)'; DOM.btnTorch.style.color = '#000'; } else { DOM.btnTorch.style.backgroundColor = ''; DOM.btnTorch.style.color = '#fff'; } }

// === SENSORS & CANVAS ===
function checkSensorPerms() { if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') { DOM.permReq.classList.remove('hidden'); } else { window.addEventListener('deviceorientation', handleOrientation); } }
async function requestSensors() { try { const resp = await DeviceOrientationEvent.requestPermission(); if (resp === 'granted') { window.addEventListener('deviceorientation', handleOrientation); } } catch (e) {} finally { DOM.permReq.classList.add('hidden'); } }
function handleOrientation(e) { let x = e.beta; let y = e.gamma; if (x === null || y === null) return; state.sensorActive = true; state.angleX = x; state.angleY = y; }
function updateUI() { if (state.uiMode === 'menu' || state.isCapturing || state.isSwitching) return; if (!state.sensorActive) { DOM.lvlDot.classList.remove('ok'); DOM.lvlText.textContent = "–ö–∞–º–µ—Ä–∞"; DOM.shutter.classList.remove('disabled'); DOM.shutter.classList.add('active'); return; } if (state.levelOK) { DOM.lvlDot.classList.add('ok'); DOM.lvlText.textContent = "–†–æ–≤–Ω–æ"; DOM.shutter.classList.remove('disabled'); DOM.shutter.classList.add('active'); } else { DOM.lvlDot.classList.remove('ok'); DOM.lvlText.textContent = "–í—ã—Ä–æ–≤–Ω—è–π—Ç–µ"; DOM.shutter.classList.add('disabled'); DOM.shutter.classList.remove('active'); } }
function resizeCanvas() { const w = window.innerWidth; const h = window.innerHeight; if (DOM.canvas.width !== w || DOM.canvas.height !== h) { DOM.canvas.width = w; DOM.canvas.height = h; } }
function drawLoop() { const ctx = DOM.ctx; const w = DOM.canvas.width; const h = DOM.canvas.height; ctx.clearRect(0, 0, w, h); if (state.uiMode === 'menu') { requestAnimationFrame(drawLoop); return; } const cx = w / 2; const cy = h / 2; const cardRatio = 1.586; const cardW = w * 0.22; const cardH = cardW * cardRatio; const cardX = cx + 80; const cardY = cy - cardH / 2; const r = 8; ctx.beginPath(); ctx.moveTo(cardX + r, cardY); ctx.lineTo(cardX + cardW - r, cardY); ctx.quadraticCurveTo(cardX + cardW, cardY, cardX + cardW, cardY + r); ctx.lineTo(cardX + cardW, cardY + cardH - r); ctx.quadraticCurveTo(cardX + cardW, cardY + cardH, cardX + cardW - r, cardY + cardH); ctx.lineTo(cardX + r, cardY + cardH); ctx.quadraticCurveTo(cardX, cardY + cardH, cardX, cardY + cardH - r); ctx.lineTo(cardX, cardY + r); ctx.quadraticCurveTo(cardX, cardY, cardX + r, cardY); ctx.fillStyle = 'rgba(255, 255, 255, 0.2)'; ctx.fill(); ctx.save(); ctx.translate(cardX + cardW / 2, cardY + cardH / 2); ctx.rotate(-Math.PI / 2); ctx.fillStyle = '#ffffff'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.font = 'bold 12px sans-serif'; ctx.fillText("CREDIT CARD", 0, -10); ctx.font = '10px sans-serif'; ctx.fillText("(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)", 0, 10); ctx.restore(); if (state.sensorActive) { const rBubble = 14; const rTarget = 18; const maxOffset = 60; const rawX = (isNaN(state.angleY) || state.angleY === null) ? 0 : state.angleY; const rawY = (isNaN(state.angleX) || state.angleX === null) ? 0 : state.angleX; const clamp = (val) => Math.max(-20, Math.min(20, val)); const dx = (clamp(rawX) / 20) * maxOffset; const dy = (clamp(rawY) / 20) * maxOffset; const dist = Math.hypot(dx, dy); const isInside = (dist + rBubble) <= rTarget; if (state.levelOK !== isInside && !state.isCapturing && !state.isSwitching) { state.levelOK = isInside; updateUI(); if(isInside) haptic('medium'); } ctx.shadowBlur = 4; ctx.shadowColor = 'rgba(0,0,0,0.5)'; ctx.beginPath(); ctx.arc(cx, cy, rTarget, 0, Math.PI * 2); const color = (state.levelOK || state.isCapturing) ? '#30d158' : 'rgba(255,255,255,0.85)'; ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.stroke(); ctx.beginPath(); ctx.arc(cx + dx, cy + dy, rBubble, 0, Math.PI * 2); ctx.fillStyle = color; ctx.fill(); ctx.shadowBlur = 0; } else { ctx.strokeStyle = 'rgba(255,255,255,0.5)'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(cx-10, cy); ctx.lineTo(cx+10, cy); ctx.stroke(); ctx.beginPath(); ctx.moveTo(cx, cy-10); ctx.lineTo(cx, cy+10); ctx.stroke(); } requestAnimationFrame(drawLoop); }

// === SHUTTER & SEND ===
DOM.shutter.addEventListener('click', async () => {
  if (state.isCapturing || state.isSwitching) return;
  if (state.sensorActive && !state.levelOK) { haptic('error'); showToast("–í—ã—Ä–æ–≤–Ω—è–π—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω"); return; }
  try {
    state.isCapturing = true; haptic('heavy'); DOM.shutter.style.transform = 'scale(0.8)'; DOM.shutter.style.opacity = '0.5';
    await new Promise(r => setTimeout(r, 50));
    const vid = DOM.video; if (vid.readyState < 2 || vid.videoWidth === 0) throw new Error("–ö–∞–º–µ—Ä–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞");
    const MAX_SIDE = 1024; let w = vid.videoWidth; let h = vid.videoHeight;
    if (w > h) { if (w > MAX_SIDE) { h *= MAX_SIDE / w; w = MAX_SIDE; } } else { if (h > MAX_SIDE) { w *= MAX_SIDE / h; h = MAX_SIDE; } }
    const c = document.createElement('canvas'); c.width = w; c.height = h; const ctx = c.getContext('2d'); ctx.drawImage(vid, 0, 0, w, h);
    const blob = await new Promise(resolve => c.toBlob(resolve, 'image/jpeg', 0.7));
    if (!blob) throw new Error("–ü—É—Å—Ç–æ–π –∫–∞–¥—Ä"); showPreview(blob);
  } catch(err) { console.error(err); haptic('error'); showToast("–û—à–∏–±–∫–∞: " + err.message); state.isCapturing = false; updateUI(); } 
  finally { DOM.shutter.style.transform = ''; DOM.shutter.style.opacity = ''; state.isCapturing = false; }
});
function showPreview(blob) { if(!blob) return; state.photoBlob = blob; DOM.finalImg.src = URL.createObjectURL(blob); DOM.preview.style.display = 'flex'; }
function retake() { DOM.preview.style.display = 'none'; if(DOM.finalImg.src) URL.revokeObjectURL(DOM.finalImg.src); DOM.finalImg.src = ''; state.photoBlob = null; DOM.commentInput.value = ''; }
async function sendPhoto() {
  const btn = DOM.btnSend; if (btn.disabled) return; DOM.preview.style.display = 'none'; haptic('heavy');
  try {
    if (!state.photoBlob) throw new Error("–ù–µ—Ç —Ñ–æ—Ç–æ");
    startProcessingUI('photo');
    const base64 = await API.blobToBase64(state.photoBlob); const userText = DOM.commentInput.value;
    const result = await API.send('scan', { image: base64, userText: userText });
    stopProcessingUI();
    if (result.ok) { openDraftSheet(result.data, result.scanId); } else { throw new Error(result.error || "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"); }
  } catch (e) { stopProcessingUI(); console.error(e); haptic('error'); alert("–û—à–∏–±–∫–∞: " + e.message); DOM.preview.style.display = 'flex'; btn.disabled = false; }
}

// === PROCESSING UI ===
let procInterval;
function startProcessingUI(mode) {
  const container = document.getElementById('procSteps'); const overlay = document.getElementById('procOverlay');
  if (mode === 'text') { container.innerHTML = `<div class="step pending" id="step-1"><div class="s-icon">üõ°Ô∏è</div><div class="s-lbl">Gatekeeper: –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞...</div></div><div class="step pending" id="step-2"><div class="s-icon">üß†</div><div class="s-lbl">TextParser: –ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ USDA...</div></div><div class="step pending" id="step-3"><div class="s-icon">üìù</div><div class="s-lbl">Synthesizer: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...</div></div>`; } 
  else { container.innerHTML = `<div class="step pending" id="step-1"><div class="s-icon">üõ°Ô∏è</div><div class="s-lbl">Gatekeeper: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞...</div></div><div class="step pending" id="step-2"><div class="s-icon">üïµÔ∏è</div><div class="s-lbl">Detective: –ü–æ–∏—Å–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤...</div></div><div class="step pending" id="step-3"><div class="s-icon">üìê</div><div class="s-lbl">Physicist: –†–∞—Å—á–µ—Ç –≤–µ—Å–∞ (3D)...</div></div><div class="step pending" id="step-4"><div class="s-icon">üç≥</div><div class="s-lbl">Technologist: –ê–Ω–∞–ª–∏–∑ –∂–∏—Ä–Ω–æ—Å—Ç–∏...</div></div><div class="step pending" id="step-5"><div class="s-icon">üìù</div><div class="s-lbl">Synthesizer: –°–±–æ—Ä–∫–∞ –æ—Ç—á–µ—Ç–∞...</div></div>`; }
  overlay.classList.add('active'); let step = 1; const maxSteps = mode === 'text' ? 3 : 5; updateStep(1, 'active');
  procInterval = setInterval(() => { updateStep(step, 'done'); step++; if(step > maxSteps) step = maxSteps; updateStep(step, 'active'); }, 2000);
}
function updateStep(num, status) { const el = document.getElementById('step-'+num); if(el) { el.classList.remove('pending', 'active', 'done'); el.classList.add(status); } }
function stopProcessingUI() { clearInterval(procInterval); document.getElementById('procOverlay').classList.remove('active'); }
function cancelProcessing() { stopProcessingUI(); retake(); }

// === DRAFT SHEET ===
let currentDraftItems = []; let currentScanId = null;
function openDraftSheet(data, scanId) {
  currentScanId = scanId; if (!data || !data.items) { alert("–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."); return; }
  currentDraftItems = data.items; renderDraftList(); document.getElementById('draftOverlay').classList.add('visible'); haptic('success');
}
function renderDraftList() {
  const container = document.getElementById('draftList'); container.innerHTML = '';
  if (currentDraftItems.length === 0) { container.innerHTML = '<div style="text-align:center; opacity:0.5; padding:20px">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>'; return; }
  currentDraftItems.forEach((item, index) => {
    let icon = "üçΩÔ∏è"; if (item.cooking_method === 'Raw') icon = "üçé"; if (item.fat_modifier === 'High Oil') icon = "üç≥";
    const div = document.createElement('div'); div.className = 'draft-item';
    div.innerHTML = `<div class="di-icon">${icon}</div><div class="di-inputs"><input type="text" class="di-name" value="${item.name}" onchange="updateDraftItem(${index}, 'name', this.value)"><div class="di-row"><input type="number" class="di-weight" value="${item.weight_g || ''}" placeholder="0" onchange="updateDraftItem(${index}, 'weight_g', this.value)"><div class="di-unit">–≥</div></div></div><div class="di-del" onclick="removeDraftItem(${index})">‚úï</div>`;
    container.appendChild(div);
  });
}
window.updateDraftItem = (index, field, value) => { if (field === 'weight_g') value = parseInt(value) || 0; currentDraftItems[index][field] = value; };
window.removeDraftItem = (index) => { currentDraftItems.splice(index, 1); renderDraftList(); };
window.closeDraft = () => { document.getElementById('draftOverlay').classList.remove('visible'); retake(); };
window.confirmDraftToNutritionist = async () => {
  const btn = document.getElementById('btnConfirmDraft'); btn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...'; btn.disabled = true;
  try {
    const result = await API.send('calculate', { data: currentDraftItems, scanId: currentScanId });
    haptic('success'); document.getElementById('draftOverlay').classList.remove('visible');
    alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –¥–Ω–µ–≤–Ω–∏–∫! \n" + JSON.stringify(result.data?.total_nutrition || {})); retake();
  } catch (e) { alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + e.message); } finally { btn.textContent = '–í –¥–Ω–µ–≤–Ω–∏–∫'; btn.disabled = false; }
};

// === CALENDAR & WIDGETS LOGIC ===
let currentWeekStart = getStartOfWeek(new Date()); let selectedDate = new Date(); let isDragging = false; let startX = 0; let currentTranslate = 0;
const area = document.getElementById('swipeArea'); const track = document.getElementById('calTrack'); const prevEl = document.getElementById('weekPrev'); const currEl = document.getElementById('weekCurr'); const nextEl = document.getElementById('weekNext');
function getStartOfWeek(date) { const d = new Date(date); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1); return new Date(d.setDate(diff)); }
function initCalendar() { renderAllWeeks(); area.onpointerdown = handleStart; area.onpointermove = handleMove; area.onpointerup = handleEnd; area.onpointercancel = handleEnd; area.onpointerleave = handleEnd; }
function renderWeekData(container, startDate) {
  container.innerHTML = ''; const weekDays = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å']; const today = new Date();
  for(let i=0; i<7; i++) {
    const d = new Date(startDate); d.setDate(d.getDate() + i); const isToday = d.toDateString() === today.toDateString(); const isSelected = d.toDateString() === selectedDate.toDateString();
    const el = document.createElement('div'); el.className = `day-cell ${isSelected ? 'selected' : ''} ${isToday ? 'is-today' : ''}`; el.innerHTML = `<div class="dc-name">${weekDays[i]}</div><div class="dc-num">${d.getDate()}</div>`;
    el.onclick = (e) => { if(Math.abs(currentTranslate) > 5) return; document.querySelectorAll('.day-cell').forEach(c => c.classList.remove('selected')); el.classList.add('selected'); selectedDate = new Date(d); if(window.haptic) window.haptic('selection'); renderAllWeeks(); }; container.appendChild(el);
  }
}
function renderAllWeeks() {
  renderWeekData(currEl, currentWeekStart); const dPrev = new Date(currentWeekStart); dPrev.setDate(dPrev.getDate() - 7); renderWeekData(prevEl, dPrev);
  const dNext = new Date(currentWeekStart); dNext.setDate(dNext.getDate() + 7); renderWeekData(nextEl, dNext);
  const mid = new Date(currentWeekStart); mid.setDate(mid.getDate() + 3); document.getElementById('monthLabel').textContent = mid.toLocaleString('ru', { month: 'long', year: 'numeric' });
}
function handleStart(e) { if (e.button !== 0) return; isDragging = true; startX = e.clientX; currentTranslate = 0; track.style.transition = 'none'; area.style.cursor = 'grabbing'; }
function handleMove(e) { if (!isDragging) return; currentTranslate = e.clientX - startX; track.style.transform = `translateX(calc(-33.333333% + ${currentTranslate}px))`; }
function handleEnd(e) { if (!isDragging) return; isDragging = false; area.style.cursor = 'grab'; const threshold = 60; track.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)'; if (currentTranslate > threshold) { if(window.haptic) window.haptic('light'); track.style.transform = `translateX(0%)`; setTimeout(() => shiftWeeks(-1), 300); } else if (currentTranslate < -threshold) { if(window.haptic) window.haptic('light'); track.style.transform = `translateX(-66.666666%)`; setTimeout(() => shiftWeeks(1), 300); } else { track.style.transform = `translateX(-33.333333%)`; } }
function shiftWeeks(direction) { currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7)); track.style.transition = 'none'; renderAllWeeks(); track.style.transform = `translateX(-33.333333%)`; }
initCalendar();

// === WATER & WIDGETS ===
let currentMl = 1250; const targetMl = 2500;
window.updateWater = function(delta) { if(window.haptic) window.haptic('light'); else if(tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light'); currentMl = Math.max(0, currentMl + delta); renderWater(); };
function renderWater() {
  document.getElementById('lbl-fact').innerText = currentMl; document.getElementById('lbl-pct').innerText = Math.round((currentMl/targetMl)*100) + '%';
  const card = document.getElementById('waterCard'); if(currentMl > targetMl) card.classList.add('is-overload'); else card.classList.remove('is-overload');
  for(let i=1; i<=5; i++) { const el = document.getElementById('c'+i); const th = i*(targetMl/5); const prevTh = (i-1)*(targetMl/5); let pct = 0; if(currentMl >= th) pct=100; else if(currentMl > prevTh) pct = ((currentMl-prevTh)/(targetMl/5))*100; el.style.setProperty('--h', Math.min(100, pct)+'%'); }
}
const wTrack = document.getElementById('widgetTrack'); const dots = document.querySelectorAll('.dot');
if(wTrack) { wTrack.addEventListener('scroll', () => { const idx = Math.round(wTrack.scrollLeft / wTrack.clientWidth); dots.forEach((d,i) => d.classList.toggle('active', i===idx)); }); }
renderWater();

// === üöÄ –ì–õ–ê–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–Ø –†–ï–ñ–ò–ú–û–í ===

// 1. –û–¢–ö–†–´–¢–ò–ï –ö–ê–ú–ï–†–´
DOM.btnStartCam.onclick = async () => {
  const text = DOM.omniInput.value.trim();
  if (text.length > 0) {
    await sendTextOnly(text);
  } else {
    state.uiMode = 'camera';
    // –£–≤–æ–¥–∏–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
    const cal = document.getElementById('calendarBlock');
    if(cal) cal.style.transform = 'translateY(-150%)'; 
    // –°–∫—Ä—ã–≤–∞–µ–º –≤–∏–¥–∂–µ—Ç—ã
    const dash = document.getElementById('dashboardLayer');
    if(dash) dash.classList.add('hidden-mode');

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º UI –∫–∞–º–µ—Ä—ã
    DOM.omniBar.classList.add('hidden');
    DOM.camUI.classList.remove('idle');
    DOM.camUI.style.pointerEvents = 'auto'; 
    
    if(tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    await initCamera(); 
  }
};

// 2. –ó–ê–ö–†–´–¢–ò–ï –ö–ê–ú–ï–†–´ (–ö—Ä–µ—Å—Ç–∏–∫)
DOM.btnClose.onclick = () => {
  state.uiMode = 'menu';
  // UI –∫–∞–º–µ—Ä—ã —Å–∫—Ä—ã—Ç—å
  DOM.camUI.classList.add('idle');
  DOM.camUI.style.pointerEvents = 'none';
  DOM.omniBar.classList.remove('hidden');
  
  // –í–µ—Ä–Ω—É—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å
  const cal = document.getElementById('calendarBlock');
  if(cal) cal.style.transform = 'translateY(0)';

  // –í–µ—Ä–Ω—É—Ç—å –≤–∏–¥–∂–µ—Ç—ã
  const dash = document.getElementById('dashboardLayer');
  if(dash) dash.classList.remove('hidden-mode');

  stopStream(); 
};

// 3. –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞
async function sendTextOnly(text) {
   const btn = DOM.btnStartCam; btn.style.opacity = '0.5'; haptic('medium');
   try {
     startProcessingUI('text');
     const result = await API.send('scan', { image: null, userText: text });
     stopProcessingUI(); DOM.omniInput.value = '';
     if (result.ok) { openDraftSheet(result.data, result.scanId); } else { throw new Error(result.error); }
   } catch(e) { stopProcessingUI(); alert("–û—à–∏–±–∫–∞: " + e.message); } finally { btn.style.opacity = '1'; }
}
</script>
</body>
</html>