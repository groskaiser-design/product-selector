<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Macros • Замеры</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --bg1:#1c2035; --bg2:#2a275a;
    --card:rgba(255,255,255,.06);
    --border:rgba(255,255,255,.12);
    --text:#fff; --muted:#c9c9d6; --accent:#87b2ff;
    --ok:#36d399; --warn:#f6ad55; --err:#f87171;
    --radius:18px;
  }
  html,body{margin:0;padding:0;height:100%;color:var(--text);background:linear-gradient(160deg,var(--bg1),var(--bg2)) fixed;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";}
  .wrap{max-width:820px;margin:0 auto;padding:16px 14px 28px;box-sizing:border-box;}
  .card{background:var(--card);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 10px 26px rgba(0,0,0,.22);margin:12px 0;overflow:hidden}
  .row{padding:16px 16px}
  .title{display:flex;align-items:center;justify-content:space-between;gap:10px;font-weight:600}
  .title small{color:var(--muted);font-weight:400}
  .hint{color:var(--muted);font-size:13px;line-height:1.45;margin-top:8px}
  .muted{color:var(--muted)}
  .btn{display:inline-flex;align-items:center;gap:8px;border-radius:12px;border:1px solid var(--border);padding:10px 14px;background:rgba(255,255,255,.06);color:var(--text);cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .hr{height:1px;background:var(--border);margin:0}
  /* Комментарий ИИ */
  #ai-comment{padding:0;margin:12px 0}
  .ai-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px}
  .ai-status{display:flex;align-items:center;gap:8px;font-size:13px}
  .dot{width:8px;height:8px;border-radius:50%}
  .dot.gray{background:#9aa0aa}
  .dot.green{background:var(--ok)}
  .dot.yellow{background:var(--warn)}
  .dot.red{background:var(--err)}
  .ai-body{padding:14px 16px}
  .ai-body.empty{color:var(--muted);font-style:italic}
  .ai-html{background:rgba(255,255,255,.05);border:1px dashed var(--border);border-radius:12px;padding:12px}
  /* немного красоты для HTML из Make */
  .ai-html h1,.ai-html h2,.ai-html h3{margin:.4em 0}
  .ai-html p{margin:.5em 0;line-height:1.5}
  .ai-html ul{margin:.5em 0 .5em 1.2em}
  .kbd{font:12px ui-monospace,Menlo,Consolas,monospace;background:rgba(0,0,0,.35);padding:2px 6px;border-radius:6px;border:1px solid var(--border)}
  .foot{padding:10px 0 0;color:var(--muted);font-size:12px;text-align:center}
</style>
</head>
<body>
  <div class="wrap">
    <!-- Замеры -->
    <div class="card">
      <div class="row title">
        <div>Замеры</div>
        <small id="last-measure">—</small>
      </div>
      <div class="row hint">
        Сохраняй замеры — мы мгновенно отправим их в Make. После обработки данные отобразятся в блоке «Комментарий ИИ».
      </div>
    </div>

    <!-- Аналитика (заглушка, как было) -->
    <div class="card">
      <div class="row title">
        <div>Аналитика</div>
        <small class="muted">появится после ≥2 замеров</small>
      </div>
      <div class="row hint">Динамика ключевых метрик появится после сохранения хотя бы двух замеров.</div>
    </div>

    <!-- Комментарий ИИ -->
    <div class="card" id="ai-comment">
      <div class="ai-head">
        <div class="title" style="gap:10px">
          <div>Комментарий ИИ</div>
        </div>
        <div class="ai-status" id="ai-status">
          <span class="dot gray" id="ai-dot"></span>
          <span id="ai-state">нет данных</span>
        </div>
      </div>
      <div class="hr"></div>
      <div class="ai-body empty" id="ai-body">
        Нет данных для комментария.
      </div>
    </div>

    <div class="foot">
      Если после сохранения не видишь обновления — открой заново мини-апп или нажми <span class="kbd">Обновить</span> в меню.
    </div>
  </div>

<script>
/** =========================
 *  НАСТРОЙКИ
 *  ========================= */
const API_URL = (new URLSearchParams(location.search).get('api')) ||
  // ⬇️ ВСТАВЬ СВОЙ URL ВЕБ-ПРИЛОЖЕНИЯ APPS SCRIPT (.../exec)
  "https://script.google.com/macros/s/AKfycbytmsmTE4NdsR6zopPe2s3hz69iS2ej2ldwWCrtiS6Lu_iiRkEtCAUXm406dWKdR4IdOQ/exec";

const AI_LONGPOLL_MAX_MS   = 25000; // синхронно ждём от Make до 25с
const AI_LONGPOLL_STEP_MS  = 200;
const STORAGE_AI_CACHE_KEY = "macros.ai.lastHtml";
const STORAGE_LASTDAY_KEY  = "macros.ai.lastDay";

/** =========================
 *  TG И ТЕМА
 *  ========================= */
const tg = window.Telegram?.WebApp;
if (tg) {
  tg.ready();
  try {
    tg.setHeaderColor("secondary_bg_color");
    tg.setBackgroundColor(tg.themeParams?.bg_color || "#1c2035");
  } catch(_) {}
}

/** =========================
 *  ХЕЛПЕРЫ
 *  ========================= */
function tz() {
  try {
    return Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
  } catch(_) { return 'UTC'; }
}
function fmtDay(dStr) {
  if (!dStr) return "—";
  try { return new Date(dStr + "T00:00:00").toLocaleDateString(); } catch(_) { return dStr; }
}
function setStatus(kind, text){
  const dot = document.getElementById('ai-dot');
  const st  = document.getElementById('ai-state');
  dot.className = 'dot ' + (kind||'gray');
  st.textContent = text || '';
}
function renderAI(html){
  const body = document.getElementById('ai-body');
  if (html && String(html).trim() !== '') {
    body.classList.remove('empty');
    body.innerHTML = `<div class="ai-html">${html}</div>`;
  } else {
    body.classList.add('empty');
    body.textContent = "Нет данных для комментария.";
  }
}
function saveCache(day, html){
  try {
    if (day) localStorage.setItem(STORAGE_LASTDAY_KEY, day);
    if (typeof html === 'string') localStorage.setItem(STORAGE_AI_CACHE_KEY, html);
  } catch(_) {}
}
function readCache(){
  try {
    return {
      day:  localStorage.getItem(STORAGE_LASTDAY_KEY) || null,
      html: localStorage.getItem(STORAGE_AI_CACHE_KEY) || ""
    };
  } catch(_) { return {day:null, html:""} }
}

/** =========================
 *  БАЗОВЫЙ ВЫЗОВ БЕКЕНДА
 *  ========================= */
async function apiPost(action, extra){
  const payload = Object.assign({
    action,
    tz: tz(),
    init_data: tg?.initData || ""  // Telegram initData для подписи на бэке
  }, extra||{});

  const resp = await fetch(API_URL, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload),
    // NB: для разработки на GitHub Pages CORS заблокирует ответ Apps Script.
    // В Telegram WebApp всё ок. Если нужен предпросмотр в браузере — подними прокси.
    credentials: 'omit',
    mode: 'cors',
  });

  // 2xx — ок, иначе бросаем для единого catch
  if (!resp.ok) {
    const text = await resp.text().catch(()=>String(resp.status));
    throw new Error(`API ${action} → ${resp.status}: ${text.slice(0,200)}`);
  }
  return resp.json();
}

/** =========================
 *  ИНИЦИАЛИЗАЦИЯ
 *  ========================= */
async function initPage(){
  // Пытаемся показать кеш сразу (чтобы не было пусто)
  const cached = readCache();
  if (cached.html) {
    setStatus('green','из базы');
    renderAI(cached.html);
  }

  // Загружаем last для "Замеры"
  try {
    const res = await apiPost('init', {});
    const lastDay = res?.last?.day_local || null;
    document.getElementById('last-measure').textContent =
      lastDay ? `Последний замер: ${fmtDay(lastDay)}` : 'Нет замеров';
    if (!cached.html) setStatus('gray','нет данных');
  } catch(e) {
    console.warn('init failed', e);
  }

  // При старте — одноразовая попытка достать текущий HTML из calc (без ожидания)
  try {
    const ai0 = await apiPost('ai_comment', { wait_ms: 0 });
    if (ai0 && ai0.ok && !ai0.pending) {
      setStatus('green','готово');
      renderAI(ai0.ai_comment || "");
      saveCache(ai0.day_local, ai0.ai_comment || "");
    }
  } catch(e) {
    console.debug('ai initial read skipped', e?.message||e);
  }

  // Если анкета была только что сохранена — запускаем лонг-поллинг
  const justSavedFlag = sessionStorage.getItem('macros.justSaved');
  if (justSavedFlag === '1') {
    sessionStorage.removeItem('macros.justSaved');
    await pollAiComment();
  }
}

/** =========================
 *  ЛОНГ-ПОЛЛИНГ ИИ-КОММЕНТАРИЯ
 *  ========================= */
let aiAbort = null;

async function pollAiComment(customDay){
  if (aiAbort) { aiAbort.abort(); aiAbort = null; }
  aiAbort = new AbortController();

  setStatus('yellow','ожидание от Make…');
  // крутим несколько раундов до AI_LONGPOLL_MAX_MS
  const started = Date.now();
  try {
    // один длинный запрос (бэк сам ждёт до 25с)
    const res = await apiPost('ai_comment', {
      wait_ms: AI_LONGPOLL_MAX_MS,
      day_local: customDay || undefined
    });
    if (res && res.ok && !res.pending) {
      setStatus('green','обновлено');
      renderAI(res.ai_comment || "");
      saveCache(res.day_local, res.ai_comment || "");
      return true;
    }
  } catch(e) {
    console.warn('ai_comment error', e);
  }

  // если не получилось за один раз — делаем короткие дожимы
  while (Date.now() - started < (AI_LONGPOLL_MAX_MS + 5000)) {
    try {
      const res2 = await apiPost('ai_comment', { wait_ms: 1200, day_local: customDay || undefined });
      if (res2 && res2.ok && !res2.pending) {
        setStatus('green','обновлено');
        renderAI(res2.ai_comment || "");
        saveCache(res2.day_local, res2.ai_comment || "");
        return true;
      }
    } catch(_) {}
    await new Promise(r => setTimeout(r, AI_LONGPOLL_STEP_MS));
  }
  // таймаут — остаёмся на старом тексте
  const had = readCache().html;
  setStatus(had ? 'green':'gray', had ? 'из базы' : 'нет данных');
  if (!had) renderAI('');
  return false;
}

/** =========================
 *  СИГНАЛ О СОХРАНЕНИИ
 *  =========================
 *  Вызывай это из страницы с анкетой сразу после успешного save():
 *   sessionStorage.setItem('macros.justSaved','1');
 *   window.parent.postMessage({type:'macros:saved', day_local}, '*');
 */
window.addEventListener('message', (ev)=>{
  if (!ev?.data) return;
  if (ev.data.type === 'macros:saved') {
    try { sessionStorage.setItem('macros.justSaved','1'); } catch(_){}
    pollAiComment(ev.data.day_local);
  }
});
/* также даю удобный глобальный хук для консоли/других страниц */
window.MacrosAI = {
  refresh: (day)=>pollAiComment(day),
  showCache: ()=>readCache(),
};

/** =========================
 *  СТАРТ
 *  ========================= */
document.addEventListener('DOMContentLoaded', initPage);
</script>
</body>
</html>
