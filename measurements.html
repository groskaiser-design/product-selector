<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Измерения тела</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 0; background: #fafafa; color: #222; }
    .wrap { max-width: 480px; margin: 0 auto; padding: 16px; }
    .field { margin-bottom: 14px; }
    .label { font-weight: 600; margin-bottom: 4px; }
    .wheel { display: flex; gap: 4px; }
    select { flex: 1; padding: 6px; border-radius: 8px; border: 1px solid #ccc; }
    button.save { width: 100%; padding: 12px; font-size: 16px; font-weight: 600; background: #0a84ff; color: #fff; border: none; border-radius: 10px; }
    button.save.disabled { background: #ccc; color: #777; }
    .status { margin-top: 12px; font-size: 14px; color: #555; text-align: center; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Измерения</h2>
    <div class="field">
      <div class="label">Вес</div>
      <div class="wheel">
        <select id="weight-int"></select>
        <select id="weight-frac"></select>
      </div>
    </div>
    <div class="field">
      <div class="label">Объём талии</div>
      <div class="wheel">
        <select id="waist-int"></select>
        <select id="waist-frac"></select>
      </div>
    </div>
    <button class="save" id="saveBtn">Сохранить</button>
    <div class="status" id="status"></div>
  </div>

  <script>
  const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbzi5b6W_RbJF_t9ojiZoBR2ndeqWhs3v9xbpSVhweYXUGB8EXa3qyzzayU0GxBiq-782A/exec';
  const APP_VERSION = '2.3.1';

  const LS_KEY_LAST = 'body_measurements:last';
  const LS_KEY_DRAFT = 'body_measurements:draft';

  function safeInitData(){ return window.Telegram?.WebApp?.initData || ''; }

  // === helpers ===
  function readJSON(k){ try{ return JSON.parse(localStorage.getItem(k)||'null'); }catch(_){return null;} }
  function writeJSON(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

  function genSaveId(){ return 's:' + Date.now() + ':' + Math.random().toString(36).slice(2,8); }

  async function fetchText(url, options = {}, timeoutMs = 6500){
    const ctl = new AbortController();
    const id = setTimeout(() => ctl.abort(), timeoutMs);
    try{
      const r = await fetch(url, {...options, signal: ctl.signal});
      return await r.text();
    } finally { clearTimeout(id); }
  }

  async function callBackend(action, extra = {}) {
    const base = { action, init_data: safeInitData(), app_version: APP_VERSION, locale: navigator.language || 'ru-RU', ...extra };

    // 1) GET без preflight
    const qs = new URLSearchParams();
    qs.set('action', action);
    qs.set('init_data', base.init_data);
    qs.set('json', JSON.stringify(base));
    qs.set('_t', String(Date.now()));
    try {
      const tx = await fetchText(BACKEND_URL + '?' + qs.toString(), {cache:'no-cache'}, 6500);
      const res = JSON.parse(tx);
      if (res && typeof res === 'object') return res;
    } catch(_) {}

    // 2) POST fallback
    try {
      const tp = await fetchText(BACKEND_URL, {
        method:'POST',
        headers:{'Content-Type':'text/plain;charset=UTF-8'},
        body: JSON.stringify(base),
        keepalive:true, redirect:'follow', credentials:'omit', referrerPolicy:'no-referrer'
      }, 8000);
      return JSON.parse(tp);
    } catch(e) {
      return { ok:false, error: e?.name === 'AbortError' ? 'timeout' : (e?.message || 'network_error') };
    }
  }

  // === wheels ===
  function fillWheel(intSel, fracSel, min=0, max=200){
    for(let i=min;i<=max;i++) intSel.insertAdjacentHTML('beforeend', `<option value="${i}">${i}</option>`);
    for(let i=0;i<10;i++) fracSel.insertAdjacentHTML('beforeend', `<option value="${i}">.${i}</option>`);
  }

  const weightInt = document.getElementById('weight-int');
  const weightFrac = document.getElementById('weight-frac');
  const waistInt = document.getElementById('waist-int');
  const waistFrac = document.getElementById('waist-frac');

  fillWheel(weightInt, weightFrac, 30, 200);
  fillWheel(waistInt, waistFrac, 40, 200);

  function collectCurrentData(){
    return {
      weight: Number(weightInt.value) + Number(weightFrac.value)/10,
      waist: Number(waistInt.value) + Number(waistFrac.value)/10
    };
  }

  function applyDataToUI(data){
    if (!data) return;
    if (data.weight){ 
      const [wi, wf] = String(data.weight.toFixed(1)).split('.');
      weightInt.value = wi; weightFrac.value = wf||0;
    }
    if (data.waist){
      const [wi, wf] = String(data.waist.toFixed(1)).split('.');
      waistInt.value = wi; waistFrac.value = wf||0;
    }
  }

  // === save ===
  const saveBtn = document.getElementById('saveBtn');
  const statusEl = document.getElementById('status');
  let isSaving = false;

  async function onSaveClick(){
    if (isSaving || saveBtn.disabled) return;
    isSaving = true;
    saveBtn.classList.add('disabled');
    statusEl.textContent = 'Сохраняем...';
    const data = collectCurrentData();
    const payload = {
      tz: Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC',
      source:'webapp', app_version: APP_VERSION,
      t_client: Date.now(),
      save_id: genSaveId(),
      data
    };
    const res = await callBackend('save', payload);
    if (res && res.ok){
      statusEl.textContent = '✅ Сохранено';
      writeJSON(LS_KEY_LAST, {data, ts: Date.now()});
    } else {
      statusEl.textContent = '❌ Ошибка сохранения';
    }
    isSaving = false;
    saveBtn.classList.remove('disabled');
  }

  saveBtn.addEventListener('click', onSaveClick);

  // === init ===
  async function fetchAndApplyFromBackend(){
    const cached = readJSON(LS_KEY_LAST);
    if (cached?.data) applyDataToUI(cached.data);
    const res = await callBackend('init', { tz: Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC' });
    if (res?.ok && res.last){
      const data = res.last.data || {};
      applyDataToUI(data);
      writeJSON(LS_KEY_LAST, {data, ts: Date.now()});
    }
  }

  fetchAndApplyFromBackend();
  </script>
</body>
</html>
