<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="tma:home-url" content="./index.html" />
<meta name="tma:home-hash" content="" />
<title>–ó–∞–º–µ—Ä—ã ‚Äî –∞–Ω–∫–µ—Ç–∞</title>

 <!-- === FORCE-FRESH HTML: –∫–∞–∂–¥—ã–π –∑–∞—Ö–æ–¥ –≥—Ä—É–∑–∏–º —Å —Å–µ—Ç–∏ === -->
<script>
(function enforceFreshOnVisit(){
  var url = new URL(location.href);
  if (!url.searchParams.has('_nc')) {
    url.searchParams.set('_nc', Date.now().toString(36));
    location.replace(url.href); // –ø—Ä–æ–±–∏–≤–∞–µ—Ç –∫–µ—à –∏ –Ω–µ –∑–∞—Å–æ—Ä—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é
  }
})();

window.addEventListener('pageshow', function(e){
  var nav = (performance && performance.getEntriesByType)
    ? performance.getEntriesByType('navigation')[0]
    : null;
  var isBackForward = !!(nav && nav.type === 'back_forward');

  if (e.persisted || isBackForward) {
    var url = new URL(location.href);
    url.searchParams.set('_nc', Date.now().toString(36));
    location.replace(url.href);
  }
}, { once: true });
</script>
  
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  /* === BLOCK A: DESIGN / UI (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –≤–∞—à–µ–π –≤—ë—Ä—Å—Ç–∫–µ) === */
  :root{
    --bg: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    --cardA: rgba(255,255,255,.18);
    --cardB: rgba(255,255,255,.16);
    --border: rgba(255,255,255,.28);
    --shadow: 0 8px 28px rgba(0,0,0,.18);
    --okA:#fbbf24; --okB:#f59e0b;
    --row: 36px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  html{background:transparent;}
  body{
    min-height:100svh;
    background:transparent;
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
    color:#fff;
    position:relative;
    isolation:isolate;
  }
  body::before{content:"";position:fixed;inset:0;background:var(--bg);z-index:0;pointer-events:none;transform:translateZ(0);}
  .page{max-width:560px;margin:0 auto;padding:18px 14px 24px;position:relative;z-index:1}

  .section{background:linear-gradient(180deg,var(--cardA),var(--cardB));border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);overflow:hidden;margin-bottom:14px;}
  .section-h{display:flex;align-items:center;gap:10px;padding:14px 16px;cursor:pointer;user-select:none}
  .section-h h2{font-size:16px;font-weight:800;flex:1}
  .meta{font-size:11px;opacity:.9}
  .toggle{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;opacity:.9}
  .toggle svg{transition:transform .18s ease}
  .section.collapsed .toggle svg{transform:rotate(-90deg)}
  .section-content{padding:0}
  .section.collapsed .section-content{display:none}

  .field{padding:12px}
  .field + .field{border-top:1px solid rgba(255,255,255,.14)}
  .row{display:flex;align-items:center;justify-content:space-between}
  .label{font-size:13px;font-weight:800}
  .unit{font-size:12px;opacity:.9}
  .help{margin-top:6px;text-align:center;font-size:12px;opacity:.8}

/* === WHEELS (final) === */
.duo{
  position:relative;
  display:flex;
  gap:6px;
  padding:12px;
  border-radius:14px;
  background:rgba(255,255,255,.12);
  border:1px solid rgba(255,255,255,.24);
  max-width:320px;
  margin:8px auto 0;
  justify-content:center;

  /* –≤–∞–∂–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞ –∏ –∂–µ—Å—Ç–æ–≤ */
  touch-action: pan-y;
  overscroll-behavior-y: contain;
}

.duo::after{
  content:"";
  position:absolute;
  left:4px; right:4px; top:50%;
  height:var(--row);
  transform:translateY(-50%);
  background:rgba(255,255,255,.14);
  border:1px solid rgba(255,255,255,.35);
  border-radius:10px;
  pointer-events:none;
}

.col{
  flex:0 0 92px;
  height:180px;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  overscroll-behavior: contain;
  scrollbar-width:none;
  scroll-snap-type:y mandatory;
  mask-image: linear-gradient(180deg, transparent, #000 18%, #000 82%, transparent);
  -webkit-mask-image: linear-gradient(180deg, transparent, #000 18%, #000 82%, transparent);

  /* —Ñ–∏–∫—Å ¬´—Å—Ç—Ä–∞–Ω–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏¬ª –∏ –ø—Ä–æ–ø–∞–∂–∏ —Ö–∞–ø—Ç–∏–∫–∞ –Ω–∞ –ø–µ—Ä–≤—ã—Ö –∫–æ–ª—ë—Å–∞—Ö */
  touch-action: pan-y;
}

.col::-webkit-scrollbar{ display:none; }

.option{
  height:var(--row);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  font-size:18px;
  color:#eef2ff;
  opacity:.55;
  scroll-snap-align:center;
}

.option.active{
  color:#fff;
  opacity:1;
  text-shadow:0 1px 0 rgba(0,0,0,.2);
}

.sep{
  display:flex;
  align-items:center;
  justify-content:center;
  width:10px;
  color:#e5e7eb;
  font-weight:800;
}

.optline{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  margin-top:8px;
}

.optline input{ width:18px; height:18px; }
/* === /WHEELS (final) === */


  .savebar{display:flex;justify-content:center;padding:12px;border-top:1px solid rgba(255,255,255,.14);padding-bottom: calc(12px + env(safe-area-inset-bottom));}
  .btn{min-width:160px;padding:12px 16px;border:0;border-radius:14px;background:linear-gradient(135deg,var(--okA),var(--okB));color:#fff;font-weight:900;box-shadow:var(--shadow);transition: transform .08s ease, box-shadow .12s ease, filter .12s ease, opacity .12s ease;-webkit-tap-highlight-color:transparent;touch-action: manipulation;display:inline-flex;align-items:center;justify-content:center;gap:10px;}
  .btn:focus-visible{outline:2px solid rgba(255,255,255,.7);outline-offset:2px;border-radius:16px}
  @media (prefers-reduced-motion: reduce){ .btn{transition:none;} }
  .btn.pressed{transform:translateY(1px) scale(.98);box-shadow:var(--shadow);filter:saturate(.95);}
  .btn.loading{opacity:.9;pointer-events:none;}
  .spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,.55);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg);}}
  .disabled{opacity:.4;filter:saturate(.6)}

  #ai-comment .field h4{margin:8px 0 6px;font-weight:900;}
  #ai-comment .field h3{margin:10px 0 6px;font-weight:900;}
  #ai-comment .field p{margin:8px 0;}
  #ai-comment .field ul,#ai-comment .field ol{margin:8px 0 8px 18px;}
  #ai-comment .field li{margin:4px 0;}
  #ai-comment .field hr{border:0;border-top:1px solid rgba(255,255,255,.22);margin:10px 0;}
  #ai-comment .field a{color:#fff;text-decoration:underline;}
</style>
</head>
<body>
  <div class="page">

    <section class="section collapsed" id="sec-measures">
      <div class="section-h" data-toggle="sec-measures" role="button" tabindex="0" aria-controls="sec-measures" aria-expanded="false">
        <h2>–ó–∞–º–µ—Ä—ã</h2>
        <div class="meta" id="lastTime">–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–º–µ—Ä: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
        <div class="toggle" aria-hidden="true">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M8 10l4 4 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
      </div>
      <div class="section-content">
        <div id="fields"></div>
        <div class="savebar">
          <button class="btn" id="saveBtn" aria-busy="false">
            <span class="btn-label">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
            <span class="spinner" aria-hidden="true" hidden></span>
          </button>
        </div>
      </div>
    </section>

    <section class="section" id="sec-analytics">
      <div class="section-h" data-toggle="sec-analytics" role="button" tabindex="0" aria-controls="sec-analytics" aria-expanded="true">
        <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
        <div class="toggle" aria-hidden="true">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M8 10l4 4 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
      </div>
      <div class="section-content" id="analytics">
        <div class="field"><div class="help">–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –≥—Ä–∞—Ñ–∏–∫–∏.</div></div>
      </div>
    </section>

    <section class="section" id="sec-ai">
      <div class="section-h" data-toggle="sec-ai" role="button" tabindex="0" aria-controls="sec-ai" aria-expanded="true">
        <h2>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h2>
        <div class="toggle" aria-hidden="true">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M8 10l4 4 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
      </div>
      <div class="section-content" id="ai-comment">
        <div class="field"><div class="help">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –±—ç–∫–µ–Ω–¥ ‚Äî –∑–¥–µ—Å—å –±—É–¥–µ—Ç —Ç–µ–∫—Å—Ç.</div></div>
      </div>
    </section>

  </div>

<script>
/* ============================================================
 *  BLOCK 0: TMA boot (—Ü–≤–µ—Ç–∞/–Ω–∞–∑–∞–¥)
 * ============================================================ */
(function initTMA(){
  const tg = window.Telegram?.WebApp;
  if (!tg) return;
  try { tg.ready(); tg.expand(); tg.setHeaderColor('secondary_bg_color'); } catch(e){}
  try {
    tg.BackButton?.offClick?.();
    tg.BackButton?.show();
    tg.BackButton?.onClick(()=>{ try{ window.location.href='router.html'; }catch(_){} });
  } catch(e){}
})();

/* ============================================================
 *  BLOCK A: –û–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã UI
 * ============================================================ */
const ROW_VAR = getComputedStyle(document.documentElement).getPropertyValue('--row').trim();
const rowH = ROW_VAR.endsWith('px') ? parseFloat(ROW_VAR) : (parseFloat(ROW_VAR) || 36);
const pad = 4;
const clamp=(v,a,b)=>Math.min(b,Math.max(a,v));


/* ============================================================
  BLOCK A1: –ö–æ–º–ø–æ–Ω–µ–Ω—Ç "–∫–æ–ª—ë—Å–∞" + ensureWheel (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π)
============================================================ */
function buildWheel(fieldEl, initial){
  const min = +fieldEl.dataset.min;
  const max = +fieldEl.dataset.max;
  const minInt = Math.floor(min);
  const maxInt = Math.floor(max);
  const intRange = maxInt - minInt;
  const key = fieldEl.dataset.key;

  console.log(`üîß buildWheel START: key="${key}", initial=${initial}, min=${min}, max=${max}`);

  const intCol = fieldEl.querySelector('.col-int');
  const fracCol = fieldEl.querySelector('.col-frac');
  const duo = fieldEl.querySelector('.duo');

  // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏
  const isVisible = intCol.offsetParent !== null;
  const clientH = intCol.clientHeight;
  console.log(`   üëÅÔ∏è –í–∏–¥–∏–º–æ—Å—Ç—å: isVisible=${isVisible}, clientHeight=${clientH}`);

  const opt = t => { const d=document.createElement('div'); d.className='option'; d.textContent=t; return d; };
  function fillCol(col, from, to){
    const frag=document.createDocumentFragment();
    for(let i=0;i<pad;i++) frag.appendChild(opt(''));
    for(let i=from;i<=to;i++) frag.appendChild(opt(i));
    for(let i=0;i<pad;i++) frag.appendChild(opt(''));
    col.innerHTML=''; col.appendChild(frag);
  }
  fillCol(intCol, minInt, maxInt);
  fillCol(fracCol, 0, 9);

  const nearestIndex = col =>
    Math.round((col.scrollTop + (col.clientHeight - rowH)/2)/rowH) - pad;

  const lastActiveIdx = new WeakMap();
  function markActive(col){
    const idx = nearestIndex(col) + pad;
    const prev = lastActiveIdx.get(col);

    // –•–∞–ø—Ç–∏–∫ –ø—Ä–∏ —Å–º–µ–Ω–µ –∞–∫—Ç–∏–≤–Ω–æ–π —Ü–∏—Ñ—Ä—ã
    if (typeof prev === 'number' && prev !== idx && !isProgrammatic) {
      try {
        const tg = window.Telegram?.WebApp;
        tg?.HapticFeedback?.selectionChanged?.();
      } catch(e){}
    }

    if (typeof prev === 'number' && col.children[prev]) col.children[prev].classList.remove('active');
    const el = col.children[idx];
    if (el) el.classList.add('active');
    lastActiveIdx.set(col, idx);
  }

  // –§–æ–ª–±–µ–∫, –µ—Å–ª–∏ —Å–µ–∫—Ü–∏—è —Å–∫—Ä—ã—Ç–∞ (clientHeight=0)
  const setScrollInstant = (col, idx) => {
    const ch = col.clientHeight || rowH * 5; // ¬´–≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è¬ª –≤—ã—Å–æ—Ç–∞ –ø–æ–∫–∞ —Å–∫—Ä—ã—Ç–æ
    const top = (idx + pad) * rowH - (ch - rowH)/2;
    console.log(`   üìú setScrollInstant: idx=${idx}, clientHeight=${col.clientHeight}, usedClientH=${ch}, scrollTop=${top}`);
    col.scrollTop = top;
    requestAnimationFrame(()=> markActive(col));
  };

  function withNoSnap(fn){
    const prevInt = intCol.style.scrollSnapType;
    const prevFrac = fracCol.style.scrollSnapType;
    intCol.style.scrollSnapType = 'none';
    fracCol.style.scrollSnapType = 'none';
    try { fn(); }
    finally {
      requestAnimationFrame(()=>{
        intCol.style.scrollSnapType = prevInt || '';
        fracCol.style.scrollSnapType = prevFrac || '';
        markActive(intCol); markActive(fracCol);
      });
    }
  }

  let isProgrammatic = false;
  let rafInt = 0, rafFrac = 0;
  let snapTimer=null;
  const supportsScrollEnd = ('onscrollend' in window);
  let disabled = false;

  // –ú–æ–¥–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç DOM
  let modelValue = (typeof initial === 'number')
    ? clamp(+initial, min, max)
    : clamp(min + (max - min) / 2, min, max);

  function applyFracLock(iVal){
    if (disabled) return;
    const lock = (iVal === maxInt);
    fracCol.style.pointerEvents = lock ? 'none' : 'auto';
    fracCol.style.opacity = lock ? 0.5 : 1;
  }

  function dispatchChange(){
    const v = api.value;
    document.dispatchEvent(new CustomEvent('wheelchange', {
      detail:{ key, value: v, programmatic: isProgrammatic }
    }));
  }

  function setValue(v){
    console.log(`   üéØ setValue called: key="${key}", value=${v}, isProgrammatic=${isProgrammatic}`);
    const clamped = clamp(+v, min, max);
    const rounded = Math.round(clamped * 10) / 10;
    modelValue = rounded;

    const iVal = Math.trunc(rounded);
    let f = Math.round((rounded - iVal) * 10);
    if (iVal === maxInt) f = 0;
    const iIdx = iVal - minInt;

    const prev = isProgrammatic; isProgrammatic = true;
    withNoSnap(()=>{
      setScrollInstant(intCol, iIdx);
      setScrollInstant(fracCol, f);
    });
    applyFracLock(iVal);
    markActive(intCol); markActive(fracCol);
    requestAnimationFrame(()=>{ isProgrammatic = prev; dispatchChange(); });
  }

  function snapNow(){
    if (isProgrammatic) return;
    let iIdx = clamp(nearestIndex(intCol), 0, intRange);
    let f = clamp(nearestIndex(fracCol), 0, 9);
    const iVal = minInt + iIdx;
    if (iVal === maxInt) f = 0;

    modelValue = +(iVal + f/10).toFixed(1);

    const prev = isProgrammatic; isProgrammatic = true;
    setScrollInstant(intCol, iIdx);
    setScrollInstant(fracCol, f);
    applyFracLock(iVal);
    markActive(intCol); markActive(fracCol);
    requestAnimationFrame(()=>{ isProgrammatic = prev; dispatchChange(); });
  }

  function onScrollInt(){
    if (isProgrammatic) return;
    if (rafInt) cancelAnimationFrame(rafInt);
    rafInt = requestAnimationFrame(()=>markActive(intCol));
    scheduleSnap();
  }
  function onScrollFrac(){
    if (isProgrammatic) return;
    if (rafFrac) cancelAnimationFrame(rafFrac);
    rafFrac = requestAnimationFrame(()=>markActive(fracCol));
    scheduleSnap();
  }

  // –í—Å–µ–≥–¥–∞ –∏–º–µ—Ç—å —Ç–∞–π–º–µ—Ä-—Ñ–æ–ª–±–µ–∫ (scrollend ‚Äî –¥–æ–ø–æ–ª–Ω—è–µ—Ç)
  function scheduleSnap(){
    clearTimeout(snapTimer);
    snapTimer = setTimeout(snapNow, 80);
  }

  intCol.addEventListener('scroll', onScrollInt, {passive:true});
  fracCol.addEventListener('scroll', onScrollFrac, {passive:true});
  if (supportsScrollEnd){
    intCol.addEventListener('scrollend', snapNow, {passive:true});
    fracCol.addEventListener('scrollend', snapNow, {passive:true});
  }

  function setDisabled(dis, programmatic=false){
    const prev = isProgrammatic; if (programmatic) isProgrammatic = true;
    disabled = dis;
    duo.classList.toggle('disabled', dis);
    duo.setAttribute('aria-disabled', String(dis));
    [intCol, fracCol].forEach(c=>c.style.pointerEvents = dis ? 'none' : 'auto');
    if (!dis){
      const iIdx = clamp(nearestIndex(intCol), 0, intRange);
      const iVal = minInt + iIdx;
      applyFracLock(iVal);
    }
    dispatchChange();
    isProgrammatic = prev;
  }

  const initVal = (typeof initial==='number') ? initial : (min + (max - min) / 2);
  console.log(`   ‚è∞ Scheduling initial setValue(${initVal}) via double RAF`);
  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    console.log(`   ‚è∞ EXECUTING setValue(${initVal}) for key="${key}"`);
    setValue(initVal);
  }));

  const api = {
    setValue,
    get value(){
      const iIdx = clamp(nearestIndex(intCol), 0, intRange);
      let f = clamp(nearestIndex(fracCol), 0, 9);
      const iVal = minInt + iIdx;
      if (iVal === maxInt) f = 0;
      return +(iVal + f/10).toFixed(1);
    },
    getModelValue(){ return modelValue; },
    setDisabled,
    destroy(){
      clearTimeout(snapTimer);
      intCol.removeEventListener('scroll', onScrollInt);
      fracCol.removeEventListener('scroll', onScrollFrac);
      if (supportsScrollEnd){
        intCol.removeEventListener('scrollend', snapNow);
        fracCol.removeEventListener('scrollend', snapNow);
      }
    }
  };

  console.log(`‚úÖ buildWheel END: key="${key}"`);
  return api;
}

// === –ù–ï –£–î–ê–õ–Ø–¢–¨. –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è ensureWheel ===
function ensureWheel(fieldEl, cfg){
  console.log(`üîç ensureWheel START: key="${cfg.key}"`);

  let w = wheelMap.get(fieldEl);
  if (w) {
    console.log(`   ‚ôªÔ∏è Wheel already exists for key="${cfg.key}"`);
    return w;
  }

  console.log(`   üÜï Creating NEW wheel for key="${cfg.key}"`);

  // 1) Pending –∏–∑ –ø—Ä–µ—Ñ–∏–ª–ª–∞
  const pend = (window.__pendingInputs || {});
  const hasPend = Object.prototype.hasOwnProperty.call(pend, cfg.key);
  const pendVal = hasPend ? pend[cfg.key] : undefined;
  console.log(`   üì¶ Pending data: hasPend=${hasPend}, pendVal=${pendVal}`);

  // 2) –°—Ç–∞—Ä—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
  const initVal = (typeof pendVal === 'number') ? pendVal : cfg.initial;
  console.log(`   üé≤ Initial value: ${initVal} (from ${typeof pendVal === 'number' ? 'pending' : 'cfg.initial'})`);

  // 3) –°–æ–∑–¥–∞—ë–º –∫–æ–ª–µ—Å–æ
  w = buildWheel(fieldEl, initVal);
  wheelMap.set(fieldEl, w);
  wheels[cfg.key] = w;

  // 4) –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
  if (cfg.optional){
    let cb = fieldEl.querySelector('#opt_'+cfg.key);
    if (!cb){
      const opt = document.createElement('div');
      opt.className = 'optline';
      opt.innerHTML = `<label style="display:flex;align-items:center;gap:8px;opacity:.95">
          <input type="checkbox" id="opt_${cfg.key}"> –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
        </label>`;
      fieldEl.appendChild(opt);
      cb = opt.querySelector('input');
    }
    if (!cb._bound){
      cb.addEventListener('change', ()=>{ w.setDisabled(cb.checked); }, {passive:true});
      cb._bound = true;
    }
    if (hasPend && pendVal == null){
      console.log(`   ‚òëÔ∏è Setting optional checkbox for key="${cfg.key}"`);
      cb.checked = true;
      w.setDisabled(true, /*programmatic*/true);
    }
  }

  // 5) –ß–∏—Å—Ç–∏–º pending
  if (hasPend && typeof pendVal === 'number'){
    console.log(`   üóëÔ∏è Clearing pending for key="${cfg.key}"`);
    delete pend[cfg.key];
  }

  console.log(`‚úÖ ensureWheel END: key="${cfg.key}"\n`);
  return w;
}

/*  ============================================================
     BLOCK A1.5 ‚Äî –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–ª—ë—Å —Å—Ä–∞–∑—É (eager, –±–µ–∑ IntersectionObserver)
     –≠–¢–û–¢ –ë–õ–û–ö –ü–û–î–ú–ï–ù–Ø–ï–¢ –ø—Ä–µ–∂–Ω–∏–π "Lazy init –∫–æ–ª—ë—Å ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–∞—Å–∫—Ä—ã—Ç–∏–∏ —Å–µ–∫—Ü–∏–∏"
     ============================================================ */

(function initWheelsEager(){
  try {
    // –î–≤–æ–π–Ω–æ–π RAF ‚Äî –¥–∞—ë–º DOM—É –ø—Ä–æ–º–µ—Ä–∏—Ç—å—Å—è, —á—Ç–æ–±—ã scrollTop —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–ª—Å—è –≤–µ—Ä–Ω–æ
    requestAnimationFrame(() => requestAnimationFrame(() => {
      const pend = (window.__pendingInputs || {});

      for (const cfg of FIELDS){
        const el = fieldByKey[cfg.key];
        if (!el) continue;

        // –°–æ–∑–¥–∞—ë–º –∫–æ–ª–µ—Å–æ (–µ—Å–ª–∏ –µ–≥–æ –µ—â—ë –Ω–µ—Ç)
        const w = ensureWheel(el, cfg);

        // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, –µ—Å–ª–∏ –µ—Å—Ç—å
        if (Object.prototype.hasOwnProperty.call(pend, cfg.key)){
          const v = pend[cfg.key];

          if (v == null && cfg.optional){
            // –ü–æ–º–µ—á–∞–µ–º "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö" –∏ –≤—ã–∫–ª—é—á–∞–µ–º –∫–æ–ª–µ—Å–æ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ
            let cb = el.querySelector('#opt_'+cfg.key);
            if (!cb){
              const opt = document.createElement('div');
              opt.className = 'optline';
              opt.innerHTML = `<label style="display:flex;align-items:center;gap:8px;opacity:.95">
                  <input type="checkbox" id="opt_${cfg.key}"> –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
                </label>`;
              el.appendChild(opt);
              cb = opt.querySelector('input');
            }
            cb.checked = true;
            if (w && typeof w.setDisabled === 'function'){
              w.setDisabled(true, /*programmatic*/true);
            }
          } else if (typeof v === 'number'){
            // –ü—Ä–æ—Å—Ç–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏ –≤–∫–ª—é—á–∞–µ–º (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –±—ã–ª–æ disabled)
            if (w && typeof w.setDisabled === 'function') {
              w.setDisabled(false, /*programmatic*/true);
            }
            if (w && typeof w.setValue === 'function') {
              w.setValue(v);
            }
          }
        }
      }

      // –°—á–∏—Ç–∞–µ–º, —á—Ç–æ ¬´–Ω–∞–±–ª—é–¥–µ–Ω–∏–µ¬ª —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ ‚Äî —á—Ç–æ–±—ã –∫–æ–¥ –≤ BLOCK Z –Ω–µ –¥—ë—Ä–≥–∞–ª observeFields
      if (typeof fieldsWrap !== 'undefined') fieldsWrap._observed = true;
    }));
  } catch (e){
    console.error('initWheelsEager error:', e);
  }
})();

// (–ó–∞–≥–ª—É—à–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –µ—â—ë –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è observeFields)
function observeFields(){ /* eager-init —É–∂–µ —Å–¥–µ–ª–∞–ª –≤—Å—ë –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ */ }



/* ============================================================
 *  BLOCK B: –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö (–∫–æ–Ω—Ñ–∏–≥ –ø–æ–ª–µ–π + —Ä–µ–Ω–¥–µ—Ä)
 * ============================================================ */
const FIELDS = [
  { key:'weight', label:'–í–µ—Å', unit:'–∫–≥', min:40, max:250, initial:70.0 },
  { key:'height', label:'–†–æ—Å—Ç', unit:'—Å–º', min:120, max:230, initial:160.0 },
  { key:'fat',    label:'% –∂–∏—Ä–∞', unit:'%', min:3,  max:60,  initial:20.0, optional:true },

  { key:'neck',   label:'–®–µ—è', unit:'—Å–º', min:20, max:70, initial:38 },
  { key:'shoulders',label:'–ü–ª–µ—á–∏ –æ–±—Ö–≤–∞—Ç', unit:'—Å–º', min:60, max:180, initial:90.0 },
  { key:'chest',  label:'–ì—Ä—É–¥—å', unit:'—Å–º', min:60, max:160, initial:100 },
  { key:'waist',  label:'–¢–∞–ª–∏—è', unit:'—Å–º', min:40, max:160, initial:70 },

  { key:'bicep_l_rel', label:'–ë–∏—Ü–µ–ø—Å –ª–µ–≤—ã–π (—Ä–∞—Å—Å–ª–∞–±.)', unit:'—Å–º', min:15, max:70, initial:31 },
  { key:'bicep_r_rel', label:'–ë–∏—Ü–µ–ø—Å –ø—Ä–∞–≤—ã–π (—Ä–∞—Å—Å–ª–∞–±.)', unit:'—Å–º', min:15, max:70, initial:31 },
  { key:'bicep_l_flex',label:'–ë–∏—Ü–µ–ø—Å –ª–µ–≤—ã–π (–Ω–∞–ø—Ä—è–∂.)',  unit:'—Å–º', min:15, max:70, initial:31 },
  { key:'bicep_r_flex',label:'–ë–∏—Ü–µ–ø—Å –ø—Ä–∞–≤—ã–π (–Ω–∞–ø—Ä—è–∂.)', unit:'—Å–º', min:15, max:70, initial:31 },

  { key:'thigh_l', label:'–ë–µ–¥—Ä–æ –ª–µ–≤–æ–µ', unit:'—Å–º', min:30, max:100, initial:50 },
  { key:'thigh_r', label:'–ë–µ–¥—Ä–æ –ø—Ä–∞–≤–æ–µ', unit:'—Å–º', min:30, max:100, initial:50 },

  { key:'calf_l',  label:'–ò–∫—Ä–∞ –ª–µ–≤–∞—è', unit:'—Å–º', min:25, max:70, initial:35 },
  { key:'calf_r',  label:'–ò–∫—Ä–∞ –ø—Ä–∞–≤–∞—è', unit:'—Å–º', min:25, max:70, initial:35 },

  { key:'hips',    label:'–Ø–≥–æ–¥–∏—Ü—ã', unit:'—Å–º', min:70, max:160, initial:90 },
  { key:'wrist',   label:'–û–±—Ö–≤–∞—Ç –∑–∞–ø—è—Å—Ç—å—è', unit:'—Å–º', min:10, max:30, initial:17 },
  { key:'knee',    label:'–û–±—Ö–≤–∞—Ç –∫–æ–ª–µ–Ω–∞',   unit:'—Å–º', min:25, max:60, initial:36 },
  { key:'ankle',   label:'–û–±—Ö–≤–∞—Ç –ª–æ–¥—ã–∂–∫–∏',  unit:'—Å–º', min:15, max:35, initial:22 },
];
const CFG = Object.fromEntries(FIELDS.map(f=>[f.key, f]));
const fieldsWrap = document.getElementById('fields');
const wheels = {};
const wheelMap = new WeakMap();
const fieldByKey = Object.create(null);

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –±—É—Ñ–µ—Ä –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏–π, –µ—Å–ª–∏ –∫–æ–ª—ë—Å–∞ –µ—â—ë –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
window.__pendingInputs = window.__pendingInputs || {};


// –†–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ–ª–µ–π
for (const cfg of FIELDS){
  const f = document.createElement('div');
  f.className = 'field';
  f.dataset.key = cfg.key;
  f.dataset.min = cfg.min;
  f.dataset.max = cfg.max;

  f.innerHTML = `
    <div class="row"><div class="label">${cfg.label}</div><div class="unit">${cfg.unit}</div></div>
    <div class="duo"><div class="col col-int"></div><div class="sep">,</div><div class="col col-frac"></div></div>
  `;
  const h = document.createElement('div');
  h.className = 'help';
  h.textContent = cfg.unit==='–∫–≥' ? '–∫–≥: —Ü–µ–ª—ã–µ –∏ –¥–µ—Å—è—Ç—ã–µ' :
                  cfg.unit==='—Å–º' ? '—Å–º: —Ü–µ–ª—ã–µ –∏ –¥–µ—Å—è—Ç—ã–µ (1 –¥–µ—Å—è—Ç–∞—è = 1 –º–º)' :
                  '–ø—Ä–æ—Ü–µ–Ω—Ç—ã: —Ü–µ–ª—ã–µ –∏ –¥–µ—Å—è—Ç—ã–µ';
  f.appendChild(h);

  fieldsWrap.appendChild(f);
  fieldByKey[cfg.key] = f;
}

/* Lazy init –∫–æ–ª—ë—Å ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–∞—Å–∫—Ä—ã—Ç–∏–∏ —Å–µ–∫—Ü–∏–∏ */
const allFields = Array.from(fieldsWrap.querySelectorAll('.field'));
const canObserve = 'IntersectionObserver' in window;
function observeFields(){
  if (!canObserve){
    for (const f of allFields){ ensureWheel(f, CFG[f.dataset.key]); }
    return;
  }
  const io = new IntersectionObserver((entries)=>{
    for (const e of entries){
      if (e.isIntersecting){
        const f = e.target;
        ensureWheel(f, CFG[f.dataset.key]);
        io.unobserve(f);
      }
    }
  }, {root:null, rootMargin:'100px 0px', threshold:0});

  for (const f of allFields){
    const rect = f.getBoundingClientRect();
    if (rect.top < (window.innerHeight + 100) && rect.bottom > -100){
      ensureWheel(f, CFG[f.dataset.key]);
    } else {
      io.observe(f);
    }
  }
}
if (!document.getElementById('sec-measures').classList.contains('collapsed')){
  observeFields(); fieldsWrap._observed = true;
}

  
/* ===========================
 * BLOCK C ‚Äî SAVE TO DB (Apps Script, no preflight, pure logic)
 * =========================== */

const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbwjvkS5P7IcvTCFRbAb9jflLuD-R2IN3Azhg5_niKywHN3pJLDTBCL4kD2W-eDjKNnJmA/exec';
const APP_VERSION  = 'frontend-2025-10-21';
const REQUEST_TIMEOUT_MS = 15000;

function nowIso(){ return new Date().toISOString(); }
function todayLocalISO(tz){
  try{
    const d = new Date();
    const y  = new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric'}).format(d);
    const m  = new Intl.DateTimeFormat('en-CA',{timeZone:tz,month:'2-digit'}).format(d);
    const da = new Intl.DateTimeFormat('en-CA',{timeZone:tz,day:'2-digit'}).format(d);
    return `${y}-${m}-${da}`;
  }catch{ return new Date().toISOString().slice(0,10); }
}
function clientTZ(){
  try{ return Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC'; }
  catch{ return 'UTC'; }
}
function genSaveId(){ return Date.now() + '_' + Math.random().toString(36).slice(2,10); }

/**
 * –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Apps Script
 * @param {Object} values ‚Äî –∑–Ω–∞—á–µ–Ω–∏—è –∫—Ä—É—Ç–∏–ª–æ–∫ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã)
 * @returns {Promise<{ok:boolean,row_all:number,row_calc:number,day_local:string,ts_iso:string}>}
 */
async function saveMeasurementsToDB(values){
  if (!values || typeof values !== 'object') {
    throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.');
  }

  const tg       = window.Telegram?.WebApp;
  const tz       = clientTZ();
  const dayLocal = todayLocalISO(tz);

  const payload = {
    action: 'save',
    init_data: String(tg?.initData || ''),
    tz,
    client_day_local: dayLocal,
    locale: tg?.initDataUnsafe?.user?.language_code || '',
    source: 'webapp',
    app_version: APP_VERSION,
    t_client: nowIso(),
    save_id: genSaveId(),
    data: values
  };

  const controller = new AbortController();
const t = setTimeout(() => controller.abort(), REQUEST_TIMEOUT_MS);

let resp, raw, json = null;
try {
  resp = await fetch(BACKEND_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset=UTF-8' }, // –±–µ–∑ preflight
    body: JSON.stringify(payload),
    redirect: 'follow',
    cache: 'no-store',
    credentials: 'omit',
    mode: 'cors',
    signal: controller.signal
  });
  raw = await resp.text();
  try { json = raw ? JSON.parse(raw) : null; } catch {}
} catch (err) {
  if (err && err.name === 'AbortError') {
    const e = new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –≤–æ–≤—Ä–µ–º—è'); e.code = 408; throw e;
  }
  throw err;
} finally {
  clearTimeout(t);
}


  // --- —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –¥–µ—Ç–µ–∫—Ç –ª–∏–º–∏—Ç–∞ ---
  const isRateLimited =
    resp?.status === 429 ||
    (json && (json.code === 429 || json.status === 429)) ||
    /(?:too\s*many\s*requests|rate[-_\s]*limit|429|—Å–ª–∏—à–∫–æ–º\s+—á–∞—Å—Ç–æ)/i.test(
      String(json?.error || raw || resp?.statusText || '')
    );

  if (!resp?.ok || !json || json.ok !== true) {
    const msg = (json && json.error) ? json.error : `HTTP ${resp?.status ?? '0'} ${resp?.statusText ?? ''}`.trim();
    if (isRateLimited) { const e = new Error('Too many requests'); e.code = 429; throw e; }
    if (msg === 'timeout' || /timeout|network/i.test(String(msg))) { const e = new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –≤–æ–≤—Ä–µ–º—è'); e.code = 408; throw e; }
    const e = new Error(msg || 'Save failed'); e.code = resp?.status ?? 0; throw e;
  }

  return {
    ok: true,
    day_local: json.day_local,
    ts_iso:    json.ts_iso,
    row_all:   Number(json.row_all),
    row_calc:  Number(json.row_calc)
  };
}

/* ============================================================
 * BLOCK D ‚Äî –ñ–Å–°–¢–ö–ò–ô –∫—É–ª–¥–∞—É–Ω XX —Å–µ–∫—É–Ω–¥ —Å –ü–ï–†–°–ò–°–¢–û–ú, –ø–æ–ø–∞–ø –≤—Å–µ–≥–¥–∞,
 * –±–µ–∑ disabled/pointer-events:none, –≤–∏–±—Ä–æ, —Ö–∏—Ç-—Ç–µ—Å—Ç, submit-–≥–µ–π—Ç,
 * –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞.
 * + –ü–ê–¢–ß: –±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∫–ª–∏–∫–∏ (–Ω–∏–∫–∞–∫–∏—Ö POST) –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "Too many requests".
 * ============================================================ */
/* ============================================================
 * BLOCK D ‚Äî –ö–£–õ–î–ê–£–ù (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê)
 * ============================================================ */

// === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
var SAVE_IN_PROGRESS = false;
var COOLDOWN_MS = 60000;
var COOLDOWN_KEY = 'save_unlock_time';

// === –§–£–ù–ö–¶–ò–ò –ö–£–õ–î–ê–£–ù–ê ===
function getUnlockTime(){
  try {
    var val = localStorage.getItem(COOLDOWN_KEY);
    var num = Number(val) || 0;
    return num;
  } catch(e) {
    console.error('‚ùå getUnlockTime error:', e);
    return 0;
  }
}

function setUnlockTime(time){
  try {
    localStorage.setItem(COOLDOWN_KEY, String(time));
    console.log('üîí –ö—É–ª–¥–∞—É–Ω –¥–æ:', new Date(time).toLocaleTimeString());
  } catch(e) {
    console.error('‚ùå setUnlockTime error:', e);
  }
}

function canSaveNow(){
  if (SAVE_IN_PROGRESS) {
    console.log('üî¥ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ');
    return false;
  }
  
  var now = Date.now();
  var unlockAt = getUnlockTime();
  
  // –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê: –µ—Å–ª–∏ unlockAt –ë–û–õ–¨–®–ï now - –±–ª–æ–∫–∏—Ä—É–µ–º
  if (unlockAt > now) {
    var remaining = Math.ceil((unlockAt - now) / 1000);
    console.log('üî¥ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞: –æ—Å—Ç–∞–ª–æ—Å—å', remaining, '—Å–µ–∫');
    return false;
  }
  
  console.log('‚úÖ –ú–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å');
  return true;
}

// === PER-USER ROW_CALC ===
var ROWCALC_KEY_PREFIX = 'macros:last_row_calc:';

function currentUserId(){ 
  try { 
    return (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user && window.Telegram.WebApp.initDataUnsafe.user.id) || 'anon'; 
  } catch(e){ 
    return 'anon'; 
  }
}

function rowCalcKey(uid){ 
  return ROWCALC_KEY_PREFIX + String(uid); 
}

function setRowCalcForUser(rowCalc, uid){
  if (typeof uid === 'undefined') uid = currentUserId();
  try { localStorage.setItem(rowCalcKey(uid), String(rowCalc)); }
  catch(e) { try { sessionStorage.setItem(rowCalcKey(uid), String(rowCalc)); } catch(e2){} }
  if (!window.__rowCalcByUid) window.__rowCalcByUid = {};
  window.__rowCalcByUid[String(uid)] = Number(rowCalc);
}

function getRowCalcForUser(uid){
  if (typeof uid === 'undefined') uid = currentUserId();
  if (window.__rowCalcByUid && (String(uid) in window.__rowCalcByUid)) return window.__rowCalcByUid[String(uid)];
  var v = null; 
  try { v = localStorage.getItem(rowCalcKey(uid)); } 
  catch(e) { try { v = sessionStorage.getItem(rowCalcKey(uid)); } catch(e2){} }
  var n = (v == null) ? null : Number(v);
  if (!window.__rowCalcByUid) window.__rowCalcByUid = {};
  window.__rowCalcByUid[String(uid)] = isNaN(n) ? null : n;
  return window.__rowCalcByUid[String(uid)];
}

window.getRowCalcForUser = getRowCalcForUser;
window.setRowCalcForUser = setRowCalcForUser;

// === LAST MEASUREMENT TIME ===
var LASTTIME_KEY_PREFIX = 'macros:last_measurement_time:';

function lastTimeKey(uid){ 
  return LASTTIME_KEY_PREFIX + String(uid); 
}

function setLastMeasurementTime(timestamp, uid){
  if (typeof uid === 'undefined') uid = currentUserId();
  try { 
    localStorage.setItem(lastTimeKey(uid), String(timestamp)); 
  } catch(e) { 
    try { sessionStorage.setItem(lastTimeKey(uid), String(timestamp)); } catch(e2){} 
  }
  if (!window.__lastTimeByUid) window.__lastTimeByUid = {};
  window.__lastTimeByUid[String(uid)] = Number(timestamp);
  updateLastTimeDisplay(timestamp);
}

function getLastMeasurementTime(uid){
  if (typeof uid === 'undefined') uid = currentUserId();
  if (window.__lastTimeByUid && (String(uid) in window.__lastTimeByUid)) {
    return window.__lastTimeByUid[String(uid)];
  }
  var v = null; 
  try { v = localStorage.getItem(lastTimeKey(uid)); } 
  catch(e) { try { v = sessionStorage.getItem(lastTimeKey(uid)); } catch(e2){} }
  var n = (v == null) ? null : Number(v);
  if (!window.__lastTimeByUid) window.__lastTimeByUid = {};
  window.__lastTimeByUid[String(uid)] = isNaN(n) ? null : n;
  return window.__lastTimeByUid[String(uid)];
}

function updateLastTimeDisplay(timestamp){
  var el = document.getElementById('lastTime');
  if (!el) return;
  
  if (!timestamp) {
    el.textContent = '–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–º–µ—Ä: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
    return;
  }
  
  var date = new Date(timestamp);
  var dateStr = date.toLocaleDateString('ru-RU', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric'
  });
  var timeStr = date.toLocaleTimeString('ru-RU', {
    hour: '2-digit',
    minute: '2-digit'
  });
  
  el.textContent = '–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–º–µ—Ä: ' + dateStr + ' ' + timeStr;
}

window.setLastMeasurementTime = setLastMeasurementTime;
window.getLastMeasurementTime = getLastMeasurementTime;
  
// === UI ===
function getSaveBtn(){ 
  return document.getElementById('saveBtn'); 
}

function setSavingState(isSaving){
  var btn = getSaveBtn(); 
  if (!btn) return;
  var label = btn.querySelector('.btn-label');
  var sp = btn.querySelector('.spinner');
  
  if (isSaving) { 
    btn.classList.add('loading'); 
  } else { 
    btn.classList.remove('loading'); 
  }
  btn.setAttribute('aria-busy', String(isSaving));
  
  if (sp) sp.hidden = !isSaving;
  if (label) label.textContent = isSaving ? '–û–±—Ä–∞–±–æ—Ç–∫–∞‚Ä¶' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
}

function showPopup(title, message, haptic){
  console.log('üì¢ –ü–æ–ø–∞–ø:', title);
  var tg = window.Telegram && window.Telegram.WebApp;
  
  if (haptic && tg && tg.HapticFeedback && tg.HapticFeedback.notificationOccurred) {
    try { tg.HapticFeedback.notificationOccurred(haptic); } catch(e){}
  }
  
  if (tg && tg.showPopup) {
    tg.showPopup({ 
      title: title, 
      message: message, 
      buttons: [{type:'ok'}] 
    });
  } else {
    alert(title + '\n\n' + message);
  }
}

function collapseAccordionSafe(){
  var act = function(){
    if (typeof window.collapseMeasures === 'function') { 
      try{ window.collapseMeasures(); return; }catch(e){} 
    }
    var list1 = document.querySelectorAll('details[open]#sec-measures, details[open][data-section="measures"], #sec-measures details[open]');
    Array.prototype.forEach.call(list1, function(d){ d.open = false; });
    var list2 = document.querySelectorAll('#sec-measures .collapse.show, [data-section="measures"] .collapse.show, .accordion .collapse.show');
    Array.prototype.forEach.call(list2, function(p){ 
      p.classList.remove('show'); 
      p.style.height=''; 
      p.setAttribute('aria-hidden','true'); 
    });
    var list3 = document.querySelectorAll('[data-bs-toggle="collapse"][aria-expanded="true"], [aria-controls="sec-measures"][aria-expanded="true"]');
    Array.prototype.forEach.call(list3, function(t){ 
      t.setAttribute('aria-expanded','false'); 
      try{ t.dispatchEvent(new Event('click',{bubbles:true})); }catch(e){} 
    });
    var section = document.getElementById('sec-measures') || document.querySelector('[data-section="measures"]');
    if (section){ 
      section.classList.add('collapsed'); 
      section.setAttribute('aria-hidden','true'); 
    }
  };
  try { 
    requestAnimationFrame(function(){ requestAnimationFrame(act); }); 
  } catch(e) { 
    act(); 
  }
}

function collectWheelValues(){
  if (typeof window._collectWheelValues === 'function') return window._collectWheelValues();
  var out = {};
  for (var i=0; i<FIELDS.length; i++){
    var cfg = FIELDS[i];
    var fieldEl = fieldByKey[cfg.key];
    var w = (wheels[cfg.key] || ensureWheel(fieldEl, cfg));
    var cb = fieldEl ? fieldEl.querySelector('#opt_' + cfg.key) : null;
    out[cfg.key] = (cfg.optional && cb && cb.checked) ? null : w.value;
  }
  return out;
}

// === –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ===
function handleSaveClick(e){
  console.log('üñ±Ô∏è === –ö–õ–ò–ö ===');
  
  if (e && e.preventDefault) {
    try { e.preventDefault(); } catch(ex){}
  }
  
  // –ü–†–û–í–ï–†–ö–ê
  if (!canSaveNow()) {
    showPopup('Too many requests', '–ù–µ –Ω—É–∂–Ω–æ —Ç–∞–∫ —á–∞—Å—Ç–æ –Ω–∞–∂–∏–º–∞—Ç—å —ç—Ç—É –∫–Ω–æ–ø–∫—É', 'error');
    return;
  }
  
  console.log('‚úÖ –ù–∞—á–∏–Ω–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ');
  
  var tg = window.Telegram && window.Telegram.WebApp;
  var now = Date.now();
  
  // –ë–õ–û–ö–ò–†–£–ï–ú
  SAVE_IN_PROGRESS = true;
  setUnlockTime(now + COOLDOWN_MS);
  setSavingState(true);
  
  if (tg && tg.HapticFeedback && tg.HapticFeedback.impactOccurred) {
    try { tg.HapticFeedback.impactOccurred('light'); } catch(e){}
  }
  
  var values = collectWheelValues();
  
  saveMeasurementsToDB(values)
    .then(function(res){
      console.log('‚úÖ –£—Å–ø–µ—Ö');
      
      setRowCalcForUser(res.row_calc);
      startFrontDataFlow(res.row_calc); // ‚Üê —á—Ç–æ–±—ã —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∏—Ç—å AQ –∏ –∫–æ–ª—ë—Å–∞ –¥–ª—è —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
      setLastMeasurementTime(Date.parse(res.ts_iso));
      setSavingState(false);
      collapseAccordionSafe();
      
      if (tg && tg.HapticFeedback && tg.HapticFeedback.notificationOccurred) {
        try { tg.HapticFeedback.notificationOccurred('success'); } catch(e){}
      }
      
      showPopup('–ì–æ—Ç–æ–≤–æ', '–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.', 'success');
      
      SAVE_IN_PROGRESS = false;
      console.log('üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ');
    })
    .catch(function(err){
      console.error('‚ùå –û—à–∏–±–∫–∞:', err);
      
      setSavingState(false);
      
      var msg = String((err && err.message) || err || '');
      if ((err && err.code === 429) || /too\s*many\s*requests|rate[-_\s]*limit|—Å–ª–∏—à–∫–æ–º\s+—á–∞—Å—Ç–æ|429/i.test(msg)){
        showPopup('Too many requests', '–ù–µ –Ω—É–∂–Ω–æ —Ç–∞–∫ —á–∞—Å—Ç–æ –Ω–∞–∂–∏–º–∞—Ç—å —ç—Ç—É –∫–Ω–æ–ø–∫—É', 'error');
      } else if ((err && err.code === 408) || /timeout/i.test(msg)) {
        showPopup('–ù–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ', '–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –≤–æ–≤—Ä–µ–º—è. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∑–∂–µ.', 'error');
      } else {
        showPopup('–ù–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.', 'error');
      }
      
      SAVE_IN_PROGRESS = false;
      console.log('üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ (–æ—à–∏–±–∫–∞)');
    });
}

// === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
(function(){
  console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏');
  
  var btn = document.getElementById('saveBtn');
  if (!btn) {
    console.error('‚ùå –ö–Ω–æ–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
    return;
  }
  
  var newBtn = btn.cloneNode(true);
  btn.parentNode.replaceChild(newBtn, btn);
  newBtn.addEventListener('click', handleSaveClick, false);
  
  console.log('‚úÖ –ì–æ—Ç–æ–≤–æ');
})();

 

/* ============================================================
 *  BLOCK E: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (AI-–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π + –ø—Ä–µ—Ñ–∏–ª–ª –∫–æ–ª—ë—Å)
 *  –í–ê–ñ–ù–û: –∞–Ω–∞–ª–∏—Ç–∏–∫—É –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –Ω–µ –∑–∞–ª–∏–≤–∞–µ–º ‚Äî —Ç–æ–ª—å–∫–æ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä.
 *  –í—ã–∑–æ–≤—ã –∫ –±—ç–∫—É –±–µ–∑ preflight. front_wait ‚Äî –ë–ï–ó row (–±—ç–∫ —Å–∞–º —Ä–µ—à–∏—Ç).
 * ============================================================ */
(function frontDataFlowInit(){
  const tg = window.Telegram?.WebApp;
  const BACKEND = (typeof BACKEND_URL !== 'undefined' && BACKEND_URL) ? BACKEND_URL : '';

  // DOM
  const elAI = ()=>document.getElementById('ai-comment');
  const elAnalytics = ()=>document.getElementById('analytics');

  // –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã
  function setAIStatus(text){
    const host = elAI(); if (!host) return;
    host.innerHTML = `<div class="field"><div class="help">${text}</div></div>`;
  }
  function setAnalyticsPlaceholder(){
    const host = elAnalytics(); if (!host) return;
    host.innerHTML = `<div class="field"><div class="help">–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –≥—Ä–∞—Ñ–∏–∫–∏.</div></div>`;
  }

  // === API (–±–µ–∑ preflight)
  async function apiUserRow(){
    const payload = { action:'user_row', init_data: String(tg?.initData || '') };
    const resp = await fetch(BACKEND, {
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=UTF-8'},
      body:JSON.stringify(payload),
      cache:'no-store', credentials:'omit', mode:'cors'
    });
    const raw = await resp.text();
    let json = null; try{ json = raw ? JSON.parse(raw) : null; }catch(_){}
    if (!resp.ok || !json || json.ok !== true) throw new Error(json?.error || `HTTP ${resp.status}`);
    return json;
  }

  // ‚ö†Ô∏è row –ù–ï —à–ª—ë–º ‚Äî —Å–µ—Ä–≤–µ—Ä —Å–∞–º –±–µ—Ä—ë—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Ç—Ä–æ–∫—É –∏–∑ users_index –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞
  async function apiFrontWait(timeoutSec){
    const payload = {
      action:'front_wait',
      init_data:String(tg?.initData || ''),
      timeout_sec: Math.max(0, Math.min(25, Number(timeoutSec)||25))
    };
    const resp = await fetch(BACKEND, {
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=UTF-8'},
      body:JSON.stringify(payload),
      cache:'no-store', credentials:'omit', mode:'cors'
    });
    const raw = await resp.text();
    let json = null; try{ json = raw ? JSON.parse(raw) : null; }catch(_){}
    if (!resp.ok || !json) throw new Error(`HTTP ${resp.status}`);
    return json;
  }

  async function apiLastInputs(){
    const payload = { action:'user_last_inputs', init_data: String(tg?.initData || '') };
    const resp = await fetch(BACKEND, {
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=UTF-8'},
      body:JSON.stringify(payload),
      cache:'no-store', credentials:'omit', mode:'cors'
    });
    const raw = await resp.text();
    let json = null; try{ json = raw ? JSON.parse(raw) : null; }catch(_){}
    if (!resp.ok || !json || json.ok !== true) throw new Error(json?.error || `HTTP ${resp.status}`);
    return json;
  }

  // === –†–µ–Ω–¥–µ—Ä –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
  function renderAIComment(html){
    const host = elAI(); if (!host) return;
    host.innerHTML = html
      ? `<div class="field">${html}</div>`
      : `<div class="field"><div class="help">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ–∫–∞ –Ω–µ –≥–æ—Ç–æ–≤‚Ä¶</div></div>`;
  }

  // === –§–æ—Ä—Å-–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –ø—Ä–µ—Ñ–∏–ª–ª –≤—Å–µ—Ö –∫–æ–ª—ë—Å (–¥–∞–∂–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–æ–π —Å–µ–∫—Ü–∏–∏)
  function forceInitAllWheels(){
    try {
      for (const cfg of FIELDS){
        const el = fieldByKey[cfg.key];
        if (el) ensureWheel(el, cfg);
      }
    } catch(e) {
      console.error('forceInitAllWheels error:', e);
    }
  }

  function applyInputsToWheels(inputs){
    if (!inputs || typeof inputs !== 'object') return;

    // –°–æ–∑–¥–∞—ë–º –í–°–ï –∫–æ–ª—ë—Å–∞ –∑–∞—Ä–∞–Ω–µ–µ, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ ¬´–ø—É—Å—Ç–æ—Ç—ã¬ª –ø—Ä–∏ —Ä–∞—Å–∫—Ä—ã—Ç–∏–∏
    forceInitAllWheels();

    for (const [k, v] of Object.entries(inputs)){
      const cfg = CFG[k]; if (!cfg) continue;
      const el = fieldByKey[k];
      const w  = wheels[k];

      if (v == null){
        // pending=null (–µ—Å–ª–∏ –∫–∞–∫–æ–µ-—Ç–æ –∫–æ–ª–µ—Å–æ –µ—â—ë –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–æ—Å—å)
        window.__pendingInputs = window.__pendingInputs || {};
        window.__pendingInputs[k] = null;

        if (cfg.optional && el){
          let cb = el.querySelector('#opt_'+k);
          if (!cb){
            const opt = document.createElement('div');
            opt.className = 'optline';
            opt.innerHTML = `<label style="display:flex;align-items:center;gap:8px;opacity:.95">
                <input type="checkbox" id="opt_${k}"> –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
              </label>`;
            el.appendChild(opt);
            cb = opt.querySelector('input');
          }
          cb.checked = true;
          if (w) w.setDisabled(true, /*programmatic*/true);
        }
        continue;
      }

      if (typeof v === 'number'){
        if (w) w.setValue(v);
        else {
          window.__pendingInputs = window.__pendingInputs || {};
          window.__pendingInputs[k] = v;
        }
      }
    }
  }

  // === –õ–æ–Ω–≥-–ø–æ–ª–ª —Ç–æ–ª—å–∫–æ –¥–ª—è AI-–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è (–∞–Ω–∞–ª–∏—Ç–∏–∫—É –Ω–µ —Ç—Ä–æ–≥–∞–µ–º)
  let _pollTimer = 0;

  async function pollOnce(){
    try{
      const res = await apiFrontWait(25);

      // ‚ö†Ô∏è –ù–ï —Ä–∏—Å—É–µ–º —Ç–∞–±–ª–∏—Ü—É –∑–Ω–∞—á–µ–Ω–∏–π –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ
      // –ì—Ä–∞—Ñ–∏–∫–∏ –ø–æ–¥–∫–ª—é—á–∏–º –æ—Ç–¥–µ–ª—å–Ω–æ ‚Äî —Ç—É—Ç –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä.

      if (res?.ready){
        renderAIComment(res.html || '');
        return {done:true};
      }
      setAIStatus('–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º‚Ä¶ (–∂–¥—ë–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π)');
      const wait = Math.max(300, Math.min(2000, Number(res?.retry_after_ms) || 1000));
      return {done:false, wait};
    } catch(_){
      setAIStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
      return {done:false, wait:1500};
    }
  }

  async function pollLoop(){
    clearTimeout(_pollTimer);
    const r = await pollOnce();
    if (r.done) return;
    _pollTimer = setTimeout(()=>pollLoop(), r.wait);
  }

  // –ü—É–±–ª–∏—á–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏–∑ save(); row –Ω–µ –Ω—É–∂–µ–Ω ‚Äî –±—ç–∫ —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç ¬´–ø—Ä–∞–≤–∏–ª—å–Ω—É—é¬ª —Å—Ç—Ä–æ–∫—É
  window.startFrontDataFlow = function(){
    pollLoop();
  };

  // –°—Ç–∞—Ä—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  setAIStatus('–ñ–¥—ë–º –¥–∞–Ω–Ω—ã–µ‚Ä¶');
  setAnalyticsPlaceholder();
  window.startFrontDataFlow();

  // –ü–æ–¥—Ç—è–Ω—É—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≤–≤–æ–¥—ã –∏ –°–†–ê–ó–£ –∑–∞–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª—ë—Å–∞
  apiLastInputs()
    .then(r => {
      if (r && r.found && r.inputs) applyInputsToWheels(r.inputs);
      else forceInitAllWheels();
    })
    .catch(()=>{ forceInitAllWheels(); });

})();

  
/* ============================================================
 *  BLOCK Z: –ê–∫–∫–æ—Ä–¥–µ–æ–Ω + FIX –¥–ª—è –ø–µ—Ä–µ—Å—á—ë—Ç–∞ scroll –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
 *           –º–æ–¥–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å–µ–∫—Ü–∏–∏
 * ============================================================ */
function setAriaExpanded(h){
  const sec = document.getElementById(h.getAttribute('data-toggle'));
  h.setAttribute('aria-expanded', String(!sec.classList.contains('collapsed')));
}

function toggleSectionByHeader(h){
  const id = h.getAttribute('data-toggle');
  const sec = document.getElementById(id);
  const willBeCollapsed = sec.classList.toggle('collapsed');
  h.setAttribute('aria-expanded', String(!willBeCollapsed));

  if (id === 'sec-measures' && !willBeCollapsed){
    // –°–µ–∫—Ü–∏—è ¬´–ó–∞–º–µ—Ä—ã¬ª —Å—Ç–∞–ª–∞ –≤–∏–¥–∏–º–æ–π ‚Äî –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∫–æ–ª—ë—Å
    if (typeof fieldsWrap !== 'undefined' && !fieldsWrap._observed){
      observeFields();
      fieldsWrap._observed = true;
    }

    // –ù–∞ –≤–∏–¥–∏–º–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ,
    // –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ –ø—Ä–∏–º–µ–Ω—è—è –º–æ–¥–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        try {
          const pend = (window.__pendingInputs || {});
          for (const cfg of FIELDS){
            const el = fieldByKey[cfg.key];
            // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–ª–µ—Å–∞
            let w = wheels[cfg.key];
            if (!w && el){
              try { w = ensureWheel(el, cfg); } catch(_){}
            }
            if (!w) continue;

            // –≤—ã–±–∏—Ä–∞–µ–º ¬´–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã¬ª:
            // 1) –º–æ–¥–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –∫–æ–ª–µ—Å–∞ (–Ω–æ–≤—ã–π API),
            // 2) –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (__pendingInputs),
            // 3) –∏–Ω–∞—á–µ –ø—Ä–æ—Å—Ç–æ ¬´—Ñ–∏–∫—Å–∏—Ä—É–µ–º¬ª —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é
            let modelVal;
            if (typeof w.getModelValue === 'function'){
              modelVal = w.getModelValue();
            } else if (Object.prototype.hasOwnProperty.call(pend, cfg.key)){
              modelVal = pend[cfg.key];
            }

            if (modelVal == null){
              // null => ¬´–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö¬ª –¥–ª—è optional-–ø–æ–ª–µ–π
              if (cfg.optional){
                const cb = el && el.querySelector ? el.querySelector('#opt_'+cfg.key) : null;
                if (cb) cb.checked = true;
                if (typeof w.setDisabled === 'function'){
                  w.setDisabled(true, /*programmatic*/true);
                }
              } else {
                // –Ω–µ optional ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª —Å —Ç–µ–∫—É—â–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
                if (typeof w.setValue === 'function'){
                  w.setValue(w.value);
                }
              }
            } else if (typeof modelVal === 'number'){
              if (typeof w.setDisabled === 'function') w.setDisabled(false, /*programmatic*/true);
              if (typeof w.setValue === 'function') w.setValue(modelVal);
            } else {
              // –Ω–∞ –∫—Ä–∞–π–Ω–∏–π —Å–ª—É—á–∞–π ‚Äî ¬´—Ñ–∏–∫—Å–∏—Ä—É–µ–º¬ª —Ç–µ–∫—É—â–∏–π —Å–∫—Ä–æ–ª–ª
              if (typeof w.setValue === 'function'){
                w.setValue(w.value);
              }
            }
          }
        } catch(e){
          console.error('BLOCK Z resync error:', e);
        }
      });
    });
  }
}

(function bindAccordion(){
  const root = document;

  root.addEventListener('click', (e)=>{
    const h = e.target.closest ? e.target.closest('.section-h') : null;
    if (!h) return;
    if (!h.hasAttribute('role')) h.setAttribute('role','button');
    if (!h.hasAttribute('tabindex')) h.setAttribute('tabindex','0');
    if (!h.hasAttribute('aria-controls')) h.setAttribute('aria-controls', h.getAttribute('data-toggle'));
    toggleSectionByHeader(h);
  }, {passive:true});

  root.addEventListener('keydown', (e)=>{
    const h = e.target && e.target.closest ? e.target.closest('.section-h') : null;
    if (!h) return;
    if (e.key==='Enter' || e.key===' '){ e.preventDefault(); toggleSectionByHeader(h); }
  });

  // –Ω–∞—á–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è aria-expanded –¥–ª—è –≤—Å–µ—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
  document.querySelectorAll('.section-h').forEach(setAriaExpanded);

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º ¬´–ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–º–µ—Ä¬ª –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (—Ñ—É–Ω–∫—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤—ã—à–µ)
  (function(){
    var lastTime = getLastMeasurementTime && getLastMeasurementTime();
    if (lastTime) {
      updateLastTimeDisplay(lastTime);
    }
  })();
})();

</script>
</body>
</html>
