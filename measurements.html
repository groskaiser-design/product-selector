<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Замеры — анкета (двойные колёса)</title>
<style>
  :root{
    --bg: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    --cardA: rgba(255,255,255,.18);
    --cardB: rgba(255,255,255,.16);
    --border: rgba(255,255,255,.28);
    --shadow: 0 8px 28px rgba(0,0,0,.18);
    --okA:#34d399; --okB:#10b981;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{min-height:100svh;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;color:#fff}
  .page{max-width:560px;margin:0 auto;padding:18px 14px 24px}

  .section{
    background:linear-gradient(180deg,var(--cardA),var(--cardB));
    border:1px solid var(--border); border-radius:18px;
    box-shadow:var(--shadow);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    overflow:hidden;
  }
  .section-h{display:flex;align-items:center;gap:10px;padding:14px 16px}
  .section-h h2{font-size:16px;font-weight:800;flex:1}

  .field{padding:12px}
  .field + .field{border-top:1px solid rgba(255,255,255,.14)}
  .row{display:flex;align-items:center;justify-content:space-between}
  .label{font-size:13px;font-weight:800}
  .unit{font-size:12px;opacity:.9}

  .help{margin-top:6px;text-align:center;font-size:12px;opacity:.8}

  /* ===== duo-wheel ===== */
  .duo{
    position:relative; display:flex; gap:6px; padding:12px;
    border-radius:14px; background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.24);
    max-width:320px; margin:8px auto 0; justify-content:center;
  }
  .duo::after{
    content:""; position:absolute; left:4px; right:4px; top:50%;
    height:36px; transform:translateY(-50%);
    background:rgba(255,255,255,.14); border:1px solid rgba(255,255,255,.35);
    border-radius:10px; pointer-events:none;
  }
  .col{
    flex:0 0 92px; height:180px; overflow:auto; -webkit-overflow-scrolling:touch;
    overscroll-behavior: contain;
    scrollbar-width:none; scroll-snap-type: y mandatory;
    mask-image: linear-gradient(180deg, transparent, #000 18%, #000 82%, transparent);
    -webkit-mask-image: linear-gradient(180deg, transparent, #000 18%, #000 82%, transparent);
  }
  .col::-webkit-scrollbar{display:none}
  .option{
    height:36px; display:flex; align-items:center; justify-content:center;
    font-weight:900; font-size:18px; color:#eef2ff; opacity:.55; scroll-snap-align:center;
  }
  .option.active{ color:#fff; opacity:1; text-shadow:0 1px 0 rgba(0,0,0,.2); }
  .sep{display:flex;align-items:center;justify-content:center;width:10px;color:#e5e7eb;font-weight:800}

  .optline{display:flex;align-items:center;justify-content:center;gap:8px;margin-top:8px}
  .optline input{width:18px;height:18px}

  .savebar{display:flex;justify-content:flex-end;padding:12px;border-top:1px solid rgba(255,255,255,.14)}
  .btn{
    min-width:160px;padding:12px 16px;border:0;border-radius:14px;
    background:linear-gradient(135deg,var(--okA),var(--okB)); color:#fff;font-weight:900;
    box-shadow:0 12px 26px rgba(16,185,129,.35), inset 0 1px 0 rgba(255,255,255,.4);
  }
  .disabled{opacity:.4;filter:saturate(.6)}
</style>
</head>
<body>
  <div class="page">
    <section class="section" id="form">
      <div class="section-h"><h2>Анкета замеров2</h2></div>
      <div id="fields"></div>
      <div class="savebar"><button class="btn" id="saveBtn">Сохранить</button></div>
    </section>
  </div>

<script>
/* ===== utils ===== */
const clamp=(v,a,b)=>Math.min(b,Math.max(a,v));
const rowH = 36, pad = 4;

/* ===== duo-wheel ===== */
function buildWheel(fieldEl, initial){
  const min = +fieldEl.dataset.min;
  const max = +fieldEl.dataset.max;
  const minInt = Math.floor(min);
  const maxInt = Math.floor(max);

  const intCol = fieldEl.querySelector('.col-int');
  const fracCol = fieldEl.querySelector('.col-frac');

  const opt = t => { const d=document.createElement('div'); d.className='option'; d.textContent=t; return d; };
  function fillCol(col, from, to){
    const frag=document.createDocumentFragment();
    for(let i=0;i<pad;i++) frag.appendChild(opt(''));
    for(let i=from;i<=to;i++) frag.appendChild(opt(i));
    for(let i=0;i<pad;i++) frag.appendChild(opt(''));
    col.innerHTML=''; col.appendChild(frag);
  }
  fillCol(intCol, minInt, maxInt);
  fillCol(fracCol, 0, 9);

  const nearestIndex = col =>
    Math.round((col.scrollTop + (col.clientHeight-rowH)/2)/rowH) - pad;

  const markActive = col => {
    const idx = nearestIndex(col);
    Array.from(col.children).forEach((el,i)=>el.classList.toggle('active', i===idx+pad));
  };

  const setScrollInstant = (col, idx) => {
    const top = (idx + pad) * rowH - (col.clientHeight-rowH)/2;
    col.scrollTop = top; // без анимации, без доп. событий
  };

  let isProgrammatic = false;

  function setValue(v){
    const clamped = clamp(+v, min, max);
    const rounded = Math.round(clamped * 10) / 10;  // до десятых
    const i = Math.trunc(rounded);
    let f = Math.round((rounded - i) * 10);
    if (i === maxInt) f = 0;                         // у максимума дроби нет

    isProgrammatic = true;
    setScrollInstant(intCol, i);
    setScrollInstant(fracCol, f);
    fracCol.style.opacity = (i===maxInt)?0.5:1;
    markActive(intCol); markActive(fracCol);
    requestAnimationFrame(()=>{ isProgrammatic = false; });
  }

  let snapTimer=null;
  function onScroll(){
    if (isProgrammatic) return;
    markActive(this);
    clearTimeout(snapTimer);
    snapTimer = setTimeout(()=>{
      if (isProgrammatic) return;
      let i = clamp(nearestIndex(intCol), minInt, maxInt);
      let f = clamp(nearestIndex(fracCol), 0, 9);
      if (i === maxInt) f = 0;

      isProgrammatic = true;
      setScrollInstant(intCol, i);
      setScrollInstant(fracCol, f);
      fracCol.style.opacity = (i===maxInt)?0.5:1;
      markActive(intCol); markActive(fracCol);
      requestAnimationFrame(()=>{ isProgrammatic = false; });
    }, 80);
  }
  intCol.addEventListener('scroll', onScroll, {passive:true});
  fracCol.addEventListener('scroll', onScroll, {passive:true});

  function setDisabled(dis){
    fieldEl.classList.toggle('disabled', dis);
    [intCol, fracCol].forEach(c=>c.style.pointerEvents = dis ? 'none':'auto');
  }

  // надёжная инициализация ровно в initial
  const initVal = (typeof initial==='number') ? initial : (min + (max - min) / 2);
  requestAnimationFrame(()=>requestAnimationFrame(()=>setValue(initVal)));

  return {
    setValue,
    get value(){
      const i = clamp(nearestIndex(intCol), minInt, maxInt);
      let f = clamp(nearestIndex(fracCol), 0, 9);
      if (i === maxInt) f = 0;
      return +(i + f/10).toFixed(1);
    },
    setDisabled
  };
}

/* ===== config ===== */
const FIELDS = [
  { key:'weight', label:'Вес', unit:'кг', min:40, max:250, initial:70.0 },
  { key:'height', label:'Рост', unit:'см', min:120, max:230, initial:160.0 },
  { key:'fat',    label:'% жира', unit:'%',  min:3,  max:60,  initial:20.0, optional:true },

  { key:'neck',   label:'Шея', unit:'см', min:20, max:70, initial:38 },
  { key:'shoulders',label:'Плечи обхват', unit:'см', min:60, max:180, initial:90.0 },
  { key:'chest',  label:'Грудь', unit:'см', min:60, max:160, initial:100 },
  { key:'waist',  label:'Талия', unit:'см', min:40, max:160, initial:70 },

  { key:'bicep_l_rel', label:'Бицепс Л (расслаб.)', unit:'см', min:15, max:70, initial:31 },
  { key:'bicep_r_rel', label:'Бицепс П (расслаб.)', unit:'см', min:15, max:70, initial:31 },
  { key:'bicep_l_flex',label:'Бицепс Л (напряж.)',  unit:'см', min:15, max:70, initial:31 },
  { key:'bicep_r_flex',label:'Бицепс П (напряж.)',  unit:'см', min:15, max:70, initial:31 },

  { key:'thigh_l', label:'Бедро Л', unit:'см', min:30, max:100, initial:50 },
  { key:'thigh_r', label:'Бедро П', unit:'см', min:30, max:100, initial:50 },

  { key:'calf_l',  label:'Икра Л', unit:'см', min:25, max:70, initial:35 },
  { key:'calf_r',  label:'Икра П', unit:'см', min:25, max:70, initial:35 },

  { key:'hips',    label:'Ягодицы', unit:'см', min:70, max:160, initial:90 },
  { key:'wrist',   label:'Обхват запястья', unit:'см', min:10, max:30, initial:17 },
  { key:'knee',    label:'Обхват колена',   unit:'см', min:25, max:60, initial:36 },
  { key:'ankle',   label:'Обхват лодыжки',  unit:'см', min:15, max:35, initial:22 },
];

/* ===== render ===== */
const fieldsWrap = document.getElementById('fields');
const wheels = {};

for (const cfg of FIELDS){
  const f = document.createElement('div');
  f.className = 'field';
  f.dataset.key = cfg.key;
  f.dataset.min = cfg.min;
  f.dataset.max = cfg.max;

  f.innerHTML = `
    <div class="row">
      <div class="label">${cfg.label}</div>
      <div class="unit">${cfg.unit}</div>
    </div>
    <div class="duo">
      <div class="col col-int"></div>
      <div class="sep">,</div>
      <div class="col col-frac"></div>
    </div>
  `;

  if (cfg.optional){
    const opt = document.createElement('div');
    opt.className = 'optline';
    opt.innerHTML = `<label style="display:flex;align-items:center;gap:8px;opacity:.95">
        <input type="checkbox" id="opt_${cfg.key}"> нет данных
      </label>`;
    f.appendChild(opt);
  }

  const h = document.createElement('div');
  h.className = 'help';
  h.textContent = cfg.unit==='кг' ? 'кг и десятые доли' :
                  cfg.unit==='см' ? 'сантиметры и миллиметры' : 'проценты с десятыми';
  f.appendChild(h);

  fieldsWrap.appendChild(f);

  const wheel = buildWheel(f, cfg.initial);
  wheels[cfg.key] = wheel;

  if (cfg.optional){
    const cb = f.querySelector('#opt_'+cfg.key);
    cb.addEventListener('change', ()=> wheel.setDisabled(cb.checked));
  }
}

/* ===== save (stub) ===== */
document.getElementById('saveBtn').addEventListener('click', ()=>{
  const data = {};
  for (const cfg of FIELDS){
    if (cfg.optional){
      const cb = document.getElementById('opt_'+cfg.key);
      data[cfg.key] = cb && cb.checked ? null : wheels[cfg.key].value;
    } else {
      data[cfg.key] = wheels[cfg.key].value;
    }
  }
  alert('Сохраняем:\n' + JSON.stringify(data, null, 2));
});
</script>
</body>
</html>
