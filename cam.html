<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Raw Camera</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  body {
    margin: 0; 
    background: #000; 
    height: 100vh; 
    display: flex; 
    flex-direction: column;
    justify-content: center; /* Центруем видео */
    overflow: hidden;
  }

  /* === САМОЕ ВАЖНОЕ === */
  video {
    width: 100%;
    height: 100%;
    /* contain = Вписать картинку целиком. Будут черные полосы, но НЕ БУДЕТ зума/кропа */
    object-fit: contain; 
    display: block;
  }

  /* Слой интерфейса поверх видео */
  .ui-layer {
    position: absolute;
    inset: 0;
    pointer-events: none; /* Чтобы клики проходили сквозь слой */
    display: flex;
    flex-direction: column;
    justify-content: flex-end; /* Кнопки снизу */
    padding-bottom: 40px;
    align-items: center;
  }

  /* Канвас для уровня */
  canvas {
    position: absolute;
    inset: 0;
    width: 100%; height: 100%;
  }

  /* Кнопка */
  .shutter-btn {
    pointer-events: auto;
    width: 80px; height: 80px;
    background: #fff;
    border-radius: 50%;
    border: 4px solid #555;
    opacity: 0.5; /* Disabled look by default */
    transition: 0.2s;
  }
  .shutter-btn.active {
    opacity: 1;
    border-color: #30d158;
    transform: scale(1.1);
  }

  /* Текст статуса */
  .status-text {
    color: #fff; 
    font-family: sans-serif; 
    margin-bottom: 20px;
    font-size: 16px;
    background: rgba(0,0,0,0.5);
    padding: 5px 10px;
    border-radius: 8px;
  }
  
  /* Превью результата */
  #previewOverlay {
    position: absolute; inset:0; background:#000; z-index:99;
    display:none; flex-direction:column;
  }
  #previewImg { flex:1; object-fit:contain; }
  .preview-btns { display:flex; padding:20px; gap:10px; }
  button { flex:1; padding:15px; font-size:16px; border-radius:10px; border:none; cursor:pointer;}
</style>
</head>
<body>

  <video id="video" autoplay playsinline muted></video>
  
  <canvas id="canvas"></canvas>

  <div class="ui-layer">
    <div class="status-text" id="status">Запуск...</div>
    <div class="shutter-btn" id="shutter"></div>
  </div>

  <div id="previewOverlay">
    <img id="previewImg">
    <div class="preview-btns">
       <button onclick="window.location.reload()" style="background:#333; color:#fff">Заново</button>
       <button onclick="send()" style="background:#007aff; color:#fff">Отправить</button>
    </div>
  </div>

<script>
  const tg = window.Telegram?.WebApp;
  if(tg) { tg.ready(); tg.expand(); }

  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const shutter = document.getElementById('shutter');
  const statusEl = document.getElementById('status');
  
  let state = { levelOK: false, isCapturing: false };

  // === 1. ПРОСТОЙ ЗАПУСК КАМЕРЫ ===
  async function start() {
    try {
      // Просим стандартное 16:9, без выпендрежа.
      // Это самый нативный формат для Андроида.
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: false,
        video: {
          facingMode: 'environment',
          width: { ideal: 1920 },
          height: { ideal: 1080 } 
        }
      });
      video.srcObject = stream;
      
      // Сброс зума, если поддерживается
      const track = stream.getVideoTracks()[0];
      const caps = track.getCapabilities();
      if (caps.zoom) {
         try { await track.applyConstraints({ advanced: [{ zoom: 1 }] }); } catch(e){}
      }

      loop();
      initSensors();
    } catch (e) {
      statusEl.textContent = "Ошибка камеры: " + e.message;
    }
  }

  // === 2. ДАТЧИКИ (УРОВЕНЬ) ===
  function initSensors() {
    if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
      // iOS требует клика, добавим временную кнопку если нужно, но пока пробуем так
      statusEl.textContent = "Нужен доступ к датчикам (iOS)";
      document.body.onclick = async () => {
         await DeviceOrientationEvent.requestPermission();
         window.addEventListener('deviceorientation', handleGyro);
         document.body.onclick = null;
      };
    } else {
      window.addEventListener('deviceorientation', handleGyro);
    }
  }

  let angleX = 0, angleY = 0;
  function handleGyro(e) {
    if (e.beta) { angleX = e.beta; angleY = e.gamma; }
  }

  // === 3. ОТРИСОВКА ===
  function loop() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    // Очистка
    ctx.clearRect(0,0, canvas.width, canvas.height);

    const cx = canvas.width / 2;
    const cy = canvas.height / 2;
    
    // Логика уровня
    const maxOffset = 50; // Чувствительность
    const dx = (angleY || 0) / 20 * maxOffset; // Gamma (наклон влево-вправо)
    const dy = (angleX || 0) / 20 * maxOffset; // Beta (наклон вперед-назад)

    // Проверка (радиус допуска 15px)
    const dist = Math.hypot(dx, dy);
    const isLevel = dist < 15;
    
    // Обновление UI
    if (isLevel !== state.levelOK) {
        state.levelOK = isLevel;
        shutter.className = isLevel ? 'shutter-btn active' : 'shutter-btn';
        statusEl.textContent = isLevel ? "РОВНО" : "ВЫРОВНЯЙТЕ";
        if(isLevel && tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
    }

    // Рисуем прицел (белый круг)
    ctx.beginPath();
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 2;
    ctx.arc(cx, cy, 20, 0, Math.PI*2);
    ctx.stroke();

    // Рисуем пузырек (зеленый если ок)
    ctx.beginPath();
    ctx.fillStyle = isLevel ? '#30d158' : 'red';
    ctx.arc(cx + dx, cy + dy, 10, 0, Math.PI*2);
    ctx.fill();

    requestAnimationFrame(loop);
  }

  // === 4. СЪЕМКА ===
  shutter.onclick = () => {
    if(!state.levelOK) return;
    
    const c = document.createElement('canvas');
    c.width = video.videoWidth;
    c.height = video.videoHeight;
    c.getContext('2d').drawImage(video, 0, 0); // Берем ПОЛНЫЙ кадр видео
    
    document.getElementById('previewImg').src = c.toDataURL('image/jpeg');
    document.getElementById('previewOverlay').style.display = 'flex';
  };
  
  window.send = () => {
    // Тут заглушка отправки
    tg.close();
  };

  start();

</script>
</body>
</html>
