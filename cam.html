<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Lens Selector</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body {
    margin: 0; padding: 0;
    background: #000;
    height: 100vh; 
    overflow: hidden;
    display: flex; flex-direction: column;
  }

  /* –í–∏–¥–µ–æ –≤–ø–∏—Å–∞–Ω–æ –≤ —ç–∫—Ä–∞–Ω (—Å –ø–æ–ª–æ—Å–∞–º–∏, –Ω–æ –±–µ–∑ –∫—Ä–æ–ø–∞) */
  video {
    width: 100%; height: 100%;
    object-fit: contain; 
    display: block;
    background: #000;
  }

  /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
  .ui-layer {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 140px;
    background: rgba(0,0,0,0.5);
    display: flex; 
    flex-direction: column;
    align-items: center; 
    justify-content: center;
    z-index: 10;
    padding-bottom: 20px;
  }

  /* –†—è–¥ –∫–Ω–æ–ø–æ–∫ */
  .btn-row {
    display: flex; align-items: center; gap: 40px;
  }

  /* –ö–Ω–æ–ø–∫–∞ —Å–º–µ–Ω—ã –ª–∏–Ω–∑—ã */
  .lens-btn {
    color: #fff;
    font-size: 14px;
    font-weight: 600;
    background: rgba(255,255,255,0.2);
    padding: 10px 20px;
    border-radius: 20px;
    cursor: pointer;
    border: 1px solid rgba(255,255,255,0.3);
    display: flex; gap: 6px; align-items: center;
  }
  
  /* –ö–Ω–æ–ø–∫–∞ –∑–∞—Ç–≤–æ—Ä–∞ */
  .shutter-btn {
    width: 70px; height: 70px;
    background: rgba(255,255,255,0.2);
    border: 4px solid #fff;
    border-radius: 50%;
    cursor: pointer;
    position: relative;
  }
  .shutter-btn::after {
    content:''; position:absolute; 
    top:50%; left:50%; transform:translate(-50%,-50%);
    width: 54px; height: 54px; 
    background: #fff; border-radius: 50%;
  }

  /* –ò–Ω—Ñ–æ –æ —Ç–µ–∫—É—â–µ–π –∫–∞–º–µ—Ä–µ */
  .debug-info {
    position: absolute; top: 40px; left: 0; right: 0;
    text-align: center; color: rgba(255,255,255,0.5);
    font-size: 12px; pointer-events: none;
  }

  /* –ü—Ä–µ–≤—å—é */
  #preview {
    position: absolute; inset: 0; z-index: 20;
    background: #000; display: none; flex-direction: column;
  }
  #previewImg { flex: 1; object-fit: contain; }
  .controls { display: flex; padding: 20px; gap: 15px; background: #000; }
  .btn {
    flex: 1; padding: 15px;
    border-radius: 12px; border: none;
    font-size: 16px; font-weight: 600;
    cursor: pointer; color: #fff; background: #333;
  }
</style>
</head>
<body>

  <div class="debug-info" id="camName">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
  <video id="video" autoplay playsinline muted></video>

  <div class="ui-layer">
    <div class="btn-row">
        <div class="lens-btn" id="btnSwitch">
            <span>üîÑ</span> <span id="lensLabel">CAM 1</span>
        </div>

        <div class="shutter-btn" id="btnSnap"></div>
        
        <div style="width: 80px;"></div>
    </div>
  </div>

  <div id="preview">
    <img id="previewImg">
    <div class="controls">
      <button class="btn" onclick="retake()">–ó–∞–Ω–æ–≤–æ</button>
      <button class="btn" style="background:#007aff" onclick="send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>

<script>
  const tg = window.Telegram?.WebApp;
  if(tg) { tg.ready(); tg.expand(); tg.setHeaderColor('#000000'); }

  const video = document.getElementById('video');
  const preview = document.getElementById('preview');
  const previewImg = document.getElementById('previewImg');
  const camNameEl = document.getElementById('camName');
  const lensLabel = document.getElementById('lensLabel');
  
  // –•—Ä–∞–Ω–∏–ª–∏—â–µ –∫–∞–º–µ—Ä
  let videoDevices = [];
  let currentCamIndex = 0;

  async function init() {
    try {
      // 1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø, —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä –¥–∞–ª –ø—Ä–∞–≤–∞
      // –∏ –º—ã –º–æ–≥–ª–∏ —É–≤–∏–¥–µ—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è –∫–∞–º–µ—Ä (labels)
      const initialStream = await navigator.mediaDevices.getUserMedia({ video: true });
      initialStream.getTracks().forEach(t => t.stop()); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ä–∞–∑—É

      // 2. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
      const devices = await navigator.mediaDevices.enumerateDevices();
      
      // 3. –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –≤–∏–¥–µ–æ –∏ —Ç–æ–ª—å–∫–æ –∑–∞–¥–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å –∏–Ω—Ñ–æ)
      const allVideo = devices.filter(d => d.kind === 'videoinput');
      
      // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∑–∞–¥–Ω–∏–µ –∫–∞–º–µ—Ä—ã –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—è–º "back", "environment", "rear"
      // –ï—Å–ª–∏ —Ç–∞–∫–∏—Ö –Ω–µ—Ç (–∏–Ω–æ–≥–¥–∞ –±—ã–≤–∞–µ—Ç), –±–µ—Ä–µ–º –≤—Å–µ –≤–∏–¥–µ–æ-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
      const backCams = allVideo.filter(d => {
          const l = d.label.toLowerCase();
          return l.includes('back') || l.includes('rear') || l.includes('environment');
      });

      // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –∑–∞–¥–Ω–∏–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö. –ï—Å–ª–∏ –Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ.
      videoDevices = backCams.length > 0 ? backCams : allVideo;

      if (videoDevices.length === 0) {
        alert("–ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
        return;
      }

      // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—É—é –∫–∞–º–µ—Ä—É
      startCamera(0);

    } catch (e) {
      alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞: " + e.message);
    }
  }

  async function startCamera(index) {
    if (index >= videoDevices.length) index = 0;
    currentCamIndex = index;

    const device = videoDevices[index];
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    lensLabel.textContent = `CAM ${index + 1}`;
    camNameEl.textContent = device.label || `Camera ${device.deviceId.slice(0,8)}...`;

    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –ø–æ—Ç–æ–∫
    if (video.srcObject) {
      video.srcObject.getTracks().forEach(t => t.stop());
    }

    try {
      // –ó–ê–ü–†–û–° –ö–û–ù–ö–†–ï–¢–ù–û–ô –ö–ê–ú–ï–†–´ –ü–û ID
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: false,
        video: {
          deviceId: { exact: device.deviceId },
          // –ù–µ –ø—Ä–æ—Å–∏–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ, –ø—É—Å—Ç—å –¥—Ä–∞–π–≤–µ—Ä –¥–∞—Å—Ç —Ä–æ–¥–Ω–æ–µ –¥–ª—è —ç—Ç–æ–π –ª–∏–Ω–∑—ã
        }
      });
      video.srcObject = stream;
    } catch (e) {
      camNameEl.textContent = "–û—à–∏–±–∫–∞: " + e.message;
    }
  }

  // –ö–ù–û–ü–ö–ê –°–ú–ï–ù–´ –õ–ò–ù–ó–´
  document.getElementById('btnSwitch').onclick = () => {
    let next = currentCamIndex + 1;
    if (next >= videoDevices.length) next = 0;
    
    if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
    startCamera(next);
  };

  // –°–™–ï–ú–ö–ê
  document.getElementById('btnSnap').onclick = () => {
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    
    canvas.toBlob(blob => {
      previewImg.src = URL.createObjectURL(blob);
      preview.style.display = 'flex';
      if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
    }, 'image/jpeg');
  };

  window.retake = () => {
    preview.style.display = 'none';
    previewImg.src = '';
  };

  window.send = () => {
    if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
    tg.close();
  };

  init();
</script>
</body>
</html>
