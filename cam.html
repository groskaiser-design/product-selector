<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Ultimate Cam</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body {
    margin: 0; padding: 0;
    background: #000;
    height: 100vh; 
    overflow: hidden;
    display: flex; flex-direction: column;
  }

  /* –í–∏–¥–µ–æ: –í–ø–∏—Å–∞–Ω–æ –≤ —ç–∫—Ä–∞–Ω (—á–µ—Ä–Ω—ã–µ –ø–æ–ª–æ—Å—ã), –∑–∞—Ç–æ –ß–ï–°–¢–ù–´–ô –∫–∞–¥—Ä –±–µ–∑ –∑—É–º–∞ */
  video {
    width: 100%; height: 100%;
    object-fit: contain; 
    display: block;
    background: #000;
    transform: scaleX(1); /* –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, —á—Ç–æ–±—ã –Ω–µ –∑–µ—Ä–∫–∞–ª–∏–ª–æ */
  }

  /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å */
  .ui-layer {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 140px; 
    background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
    display: flex; 
    flex-direction: column;
    align-items: center; 
    justify-content: flex-end;
    padding-bottom: 30px;
    z-index: 10;
  }

  .btn-row {
    display: flex; align-items: center; gap: 40px;
  }

  /* –ö–Ω–æ–ø–∫–∞ —Å–º–µ–Ω—ã –ª–∏–Ω–∑—ã */
  .lens-btn {
    color: rgba(255,255,255,0.9);
    font-size: 13px; font-weight: 600;
    background: rgba(255,255,255,0.15);
    padding: 10px 16px;
    border-radius: 20px;
    cursor: pointer;
    backdrop-filter: blur(4px);
    display: none; /* –°–∫—Ä—ã—Ç–∞, –ø–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–º –∫–∞–º–µ—Ä—ã */
    gap: 6px; align-items: center;
    border: 1px solid rgba(255,255,255,0.1);
  }
  
  /* –ó–∞—Ç–≤–æ—Ä */
  .shutter-btn {
    width: 76px; height: 76px;
    background: rgba(255,255,255,0.2);
    border: 4px solid #fff;
    border-radius: 50%;
    cursor: pointer;
    position: relative;
    transition: 0.1s;
  }
  .shutter-btn::after {
    content:''; position:absolute; 
    top:50%; left:50%; transform:translate(-50%,-50%);
    width: 60px; height: 60px; 
    background: #fff; border-radius: 50%;
  }
  .shutter-btn:active { transform: scale(0.95); opacity: 0.8; }

  /* –ü—Ä–µ–≤—å—é */
  #preview {
    position: absolute; inset: 0; z-index: 20;
    background: #000; display: none; flex-direction: column;
  }
  #previewImg { flex: 1; object-fit: contain; }
  .controls { display: flex; padding: 20px; gap: 15px; background: #000; }
  .btn {
    flex: 1; padding: 15px;
    border-radius: 12px; border: none;
    font-size: 16px; font-weight: 600;
    cursor: pointer; color: #fff; background: #333;
  }
</style>
</head>
<body>

  <video id="video" autoplay playsinline muted></video>

  <div class="ui-layer">
    <div class="btn-row">
        <div class="lens-btn" id="btnSwitch">
            <span>üîÑ</span> <span id="lensName">Lens</span>
        </div>

        <div class="shutter-btn" id="btnSnap"></div>
        
        <div style="width: 80px;"></div> 
    </div>
  </div>

  <div id="preview">
    <img id="previewImg">
    <div class="controls">
      <button class="btn" onclick="retake()">–ó–∞–Ω–æ–≤–æ</button>
      <button class="btn" style="background:#007aff" onclick="send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>

<script>
  const tg = window.Telegram?.WebApp;
  if(tg) { tg.ready(); tg.expand(); tg.setHeaderColor('#000000'); }

  const video = document.getElementById('video');
  const preview = document.getElementById('preview');
  const previewImg = document.getElementById('previewImg');
  const btnSwitch = document.getElementById('btnSwitch');
  const lensName = document.getElementById('lensName');
  
  let availableCams = []; // –°—é–¥–∞ —Å–ª–æ–∂–∏–º —Ç–æ–ª—å–∫–æ –ó–ê–î–ù–ò–ï –∫–∞–º–µ—Ä—ã
  let currentCamIndex = 0;
  const STORAGE_KEY = 'ultima_cam_id_v2';

  async function init() {
    try {
      // 1. –ü–†–û–í–ï–†–Ø–ï–ú –ü–ê–ú–Ø–¢–¨
      const savedId = localStorage.getItem(STORAGE_KEY);
      
      let constraints = { audio: false };

      if (savedId) {
          // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è - –ø—Ä–æ–±—É–µ–º –µ—ë –ø–æ ID
          constraints.video = { deviceId: { exact: savedId } };
      } else {
          // –ï–°–õ–ò –ó–ê–ü–£–°–ö –í–ü–ï–†–í–´–ï:
          // –ü—Ä–∏–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–∫—Ä—ã—Ç—å "environment" (–∑–∞–¥–Ω—é—é). 
          // –≠—Ç–æ –∑–∞—Å—Ç–∞–≤–∏—Ç iPhone –æ—Ç–∫—Ä—ã—Ç—å –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –Ω–µ –æ—Ç–¥–∞–ª —Å–ø–∏—Å–æ–∫.
          constraints.video = { facingMode: 'environment' };
      }

      // 2. –ó–ê–ü–£–°–ö–ê–ï–ú –ü–û–¢–û–ö
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;

      // 3. –¢–ï–ü–ï–†–¨ (–∫–æ–≥–¥–∞ –µ—Å—Ç—å –ø—Ä–∞–≤–∞) –°–ö–ê–ù–ò–†–£–ï–ú –£–°–¢–†–û–ô–°–¢–í–ê
      await scanDevices();

    } catch (e) {
      // –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π ID —Å–ª–æ–º–∞–ª—Å—è, –ø—Ä–æ–±—É–µ–º —Å–±—Ä–æ—Å –Ω–∞ –¥–µ—Ñ–æ–ª—Ç
      if (localStorage.getItem(STORAGE_KEY)) {
          localStorage.removeItem(STORAGE_KEY);
          init(); // –†–µ—Å—Ç–∞—Ä—Ç
          return;
      }
      alert("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: " + e.message);
    }
  }

  async function scanDevices() {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videoInputs = devices.filter(d => d.kind === 'videoinput');

    // 4. –§–ò–õ–¨–¢–†–£–ï–ú: –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–¥–Ω–∏–µ
    // –õ–æ–≥–∏–∫–∞: –ï—Å–ª–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –µ—Å—Ç—å 'front', –≤—ã–∫–∏–¥—ã–≤–∞–µ–º.
    // –ï—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—É—Å—Ç–æ–µ (—Ä–µ–¥–∫–∏–π –±–∞–≥ –ø–æ—Å–ª–µ –ø—Ä–∞–≤), –æ—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π.
    const backCams = videoInputs.filter(d => {
        const l = d.label.toLowerCase();
        return !l.includes('front') && !l.includes('user') && !l.includes('selfie');
    });

    availableCams = backCams.length > 0 ? backCams : videoInputs;

    // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –±–æ–ª—å—à–µ 1 –∫–∞–º–µ—Ä—ã, –≤–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É
    if (availableCams.length > 1) {
        btnSwitch.style.display = 'flex';
        updateLensLabel();
    }
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∏ –∫–Ω–æ–ø–∫–∏ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –º–æ–∂–Ω–æ –≤–∏–¥–µ—Ç—å –Ω–æ–º–µ—Ä)
  function updateLensLabel() {
      // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–Ω—è—Ç—å, –∫–∞–∫–∞—è —Å–µ–π—á–∞—Å –∞–∫—Ç–∏–≤–Ω–∞
      if (!video.srcObject) return;
      const track = video.srcObject.getVideoTracks()[0];
      const currentSettings = track.getSettings();
      
      // –ò—â–µ–º –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–π –∫–∞–º–µ—Ä—ã –≤ –Ω–∞—à–µ–º —Å–ø–∏—Å–∫–µ
      const idx = availableCams.findIndex(c => c.deviceId === currentSettings.deviceId);
      if (idx !== -1) currentCamIndex = idx;
      
      lensName.textContent = `Lens ${currentCamIndex + 1}`;
  }

  // –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ö–ê–ú–ï–†–´ (–ö–Ω–æ–ø–∫–∞)
  btnSwitch.onclick = async () => {
    if (availableCams.length < 2) return;
    
    if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();

    // –°–ª–µ–¥—É—é—â–∏–π –∏–Ω–¥–µ–∫—Å
    currentCamIndex = (currentCamIndex + 1) % availableCams.length;
    const nextCam = availableCams[currentCamIndex];

    // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –≤—ã–±–æ—Ä!
    localStorage.setItem(STORAGE_KEY, nextCam.deviceId);
    lensName.textContent = `...`; // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏

    // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–æ—Ç–æ–∫–∞
    if (video.srcObject) {
      video.srcObject.getTracks().forEach(t => t.stop());
    }

    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: false,
        video: { deviceId: { exact: nextCam.deviceId } }
      });
      video.srcObject = stream;
      updateLensLabel();
    } catch (e) {
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å: " + e.message);
    }
  };

  // –°–™–ï–ú–ö–ê
  document.getElementById('btnSnap').onclick = () => {
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    
    canvas.toBlob(blob => {
      previewImg.src = URL.createObjectURL(blob);
      preview.style.display = 'flex';
      if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    }, 'image/jpeg');
  };

  window.retake = () => {
    preview.style.display = 'none';
    previewImg.src = '';
  };

  window.send = () => {
    if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
    tg.close();
  };

  init();
</script>
</body>
</html>
