<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Smart Cam</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body {
    margin: 0; padding: 0;
    background: #000;
    height: 100vh; 
    overflow: hidden;
    display: flex; flex-direction: column;
  }

  /* –í–∏–¥–µ–æ: –ü–æ–ª–Ω—ã–π –∫–∞–¥—Ä (contain) - —á–µ—Ä–Ω—ã–µ –ø–æ–ª–æ—Å—ã, –Ω–æ –±–µ–∑ –∑—É–º–∞ */
  video {
    width: 100%; height: 100%;
    object-fit: contain; 
    display: block;
    background: #000;
  }

  /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å */
  .ui-layer {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 120px; /* –ö–æ–º–ø–∞–∫—Ç–Ω–µ–µ */
    background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
    display: flex; 
    flex-direction: column;
    align-items: center; 
    justify-content: flex-end;
    padding-bottom: 30px;
    z-index: 10;
  }

  .btn-row {
    display: flex; align-items: center; gap: 40px;
  }

  /* –ö–Ω–æ–ø–∫–∞ —Å–º–µ–Ω—ã –∫–∞–º–µ—Ä—ã */
  .lens-btn {
    color: rgba(255,255,255,0.9);
    font-size: 13px; font-weight: 600;
    background: rgba(255,255,255,0.15);
    padding: 10px 16px;
    border-radius: 20px;
    cursor: pointer;
    backdrop-filter: blur(4px);
    display: flex; gap: 6px; align-items: center;
  }
  
  /* –ó–∞—Ç–≤–æ—Ä */
  .shutter-btn {
    width: 72px; height: 72px;
    background: rgba(255,255,255,0.2);
    border: 4px solid #fff;
    border-radius: 50%;
    cursor: pointer;
    position: relative;
    transition: 0.1s;
  }
  .shutter-btn::after {
    content:''; position:absolute; 
    top:50%; left:50%; transform:translate(-50%,-50%);
    width: 56px; height: 56px; 
    background: #fff; border-radius: 50%;
  }
  .shutter-btn:active { transform: scale(0.95); opacity: 0.8; }

  /* –¢–µ–∫—Å—Ç —Å–≤–µ—Ä—Ö—É –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —é–∑–µ—Ä—É –ø–æ–Ω—è—Ç—å –∫–∞–∫–∞—è –∫–∞–º–µ—Ä–∞) */
  .cam-label {
    position: absolute; top: 20px; width: 100%;
    text-align: center; color: rgba(255,255,255,0.4);
    font-size: 11px; pointer-events: none; z-index: 5;
  }

  /* –ü—Ä–µ–≤—å—é */
  #preview {
    position: absolute; inset: 0; z-index: 20;
    background: #000; display: none; flex-direction: column;
  }
  #previewImg { flex: 1; object-fit: contain; }
  .controls { display: flex; padding: 20px; gap: 15px; background: #000; }
  .btn {
    flex: 1; padding: 15px;
    border-radius: 12px; border: none;
    font-size: 16px; font-weight: 600;
    cursor: pointer; color: #fff; background: #333;
  }
</style>
</head>
<body>

  <div class="cam-label" id="camInfo"></div>
  <video id="video" autoplay playsinline muted></video>

  <div class="ui-layer">
    <div class="btn-row">
        <div class="lens-btn" id="btnSwitch" style="display:none">
            <span>üîÑ</span> Lens
        </div>

        <div class="shutter-btn" id="btnSnap"></div>
        
        <div style="width: 70px;"></div> 
    </div>
  </div>

  <div id="preview">
    <img id="previewImg">
    <div class="controls">
      <button class="btn" onclick="retake()">–ü–µ—Ä–µ—Å–Ω—è—Ç—å</button>
      <button class="btn" style="background:#007aff" onclick="send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>

<script>
  const tg = window.Telegram?.WebApp;
  if(tg) { tg.ready(); tg.expand(); tg.setHeaderColor('#000000'); }

  const video = document.getElementById('video');
  const preview = document.getElementById('preview');
  const previewImg = document.getElementById('previewImg');
  const camInfo = document.getElementById('camInfo');
  const btnSwitch = document.getElementById('btnSwitch');
  
  let videoDevices = [];
  let currentCamIndex = 0;
  const STORAGE_KEY = 'ultima_preferred_cam_id';

  async function init() {
    try {
      // 1. –ü—Ä–æ–≥—Ä–µ–≤ –ø—Ä–∞–≤ (–∏–Ω–∞—á–µ –Ω–µ —É–≤–∏–¥–∏–º –ª–µ–π–±–ª—ã)
      const testStream = await navigator.mediaDevices.getUserMedia({ video: true });
      testStream.getTracks().forEach(t => t.stop());

      // 2. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
      const devices = await navigator.mediaDevices.enumerateDevices();
      const allVideo = devices.filter(d => d.kind === 'videoinput');

      // 3. –£–ú–ù–´–ô –§–ò–õ–¨–¢–†: –ò—Å–∫–ª—é—á–∞–µ–º —Ñ—Ä–æ–Ω—Ç–∞–ª–∫–∏
      // –ò—â–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, –æ–±–æ–∑–Ω–∞—á–∞—é—â–∏–µ "–ü–µ—Ä–µ–¥–Ω—é—é" –∫–∞–º–µ—Ä—É
      const backCams = allVideo.filter(d => {
          const label = d.label.toLowerCase();
          // –ï—Å–ª–∏ —è–≤–Ω–æ –Ω–∞–ø–∏—Å–∞–Ω–æ "front" –∏–ª–∏ "user" - —ç—Ç–æ —Å–µ–ª—Ñ–∏, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
          if (label.includes('front') || label.includes('user') || label.includes('selfie')) return false;
          return true;
      });

      // –ï—Å–ª–∏ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å (—Å—Ç—Ä–∞–Ω–Ω—ã–π –¥–µ–≤–∞–π—Å), –±–µ—Ä–µ–º –≤—Å–µ —á—Ç–æ –±—ã–ª–æ
      videoDevices = backCams.length > 0 ? backCams : allVideo;

      if (videoDevices.length === 0) return alert("–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

      // –ï—Å–ª–∏ –∫–∞–º–µ—Ä –±–æ–ª—å—à–µ 1, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
      if (videoDevices.length > 1) {
          btnSwitch.style.display = 'flex';
      }

      // 4. –ü–†–û–í–ï–†–ö–ê –ü–ê–ú–Ø–¢–ò: –ö–∞–∫—É—é –∫–∞–º–µ—Ä—É —é–∑–µ—Ä –ª—é–±–∏–ª –≤ –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑?
      const savedId = localStorage.getItem(STORAGE_KEY);
      let startIndex = 0;

      if (savedId) {
          const foundIndex = videoDevices.findIndex(d => d.deviceId === savedId);
          if (foundIndex !== -1) {
              startIndex = foundIndex; // –ù–∞—à–ª–∏ –ª—é–±–∏–º—É—é –∫–∞–º–µ—Ä—É!
          }
      }

      startCamera(startIndex);

    } catch (e) {
      alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞: " + e.message);
    }
  }

  async function startCamera(index) {
    if (index >= videoDevices.length) index = 0;
    currentCamIndex = index;
    const device = videoDevices[index];

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ù–ê –í–ï–ö–ê
    localStorage.setItem(STORAGE_KEY, device.deviceId);

    // –í—ã–≤–æ–¥ –∏–Ω—Ñ—ã (–º–æ–∂–Ω–æ —Å–∫—Ä—ã—Ç—å –ø–æ—Ç–æ–º)
    // camInfo.textContent = `CAM ${index+1}/${videoDevices.length}: ${device.label}`;

    if (video.srcObject) {
      video.srcObject.getTracks().forEach(t => t.stop());
    }

    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: false,
        video: {
          deviceId: { exact: device.deviceId }
          // –ù–µ —É–∫–∞–∑—ã–≤–∞–µ–º width/height, –±–µ—Ä–µ–º –Ω–∞—Ç–∏–≤
        }
      });
      video.srcObject = stream;
    } catch (e) {
      console.error(e);
    }
  }

  // –°–º–µ–Ω–∞ –∫–∞–º–µ—Ä—ã –ø–æ –∫—Ä—É–≥—É
  btnSwitch.onclick = () => {
    if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
    let next = currentCamIndex + 1;
    if (next >= videoDevices.length) next = 0;
    startCamera(next);
  };

  // –°—ä–µ–º–∫–∞
  document.getElementById('btnSnap').onclick = () => {
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    
    canvas.toBlob(blob => {
      previewImg.src = URL.createObjectURL(blob);
      preview.style.display = 'flex';
      if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    }, 'image/jpeg');
  };

  window.retake = () => {
    preview.style.display = 'none';
    previewImg.src = '';
  };

  window.send = () => {
    if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
    tg.close();
  };

  init();
</script>
</body>
</html>
