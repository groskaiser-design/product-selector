<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Ultima AI Cam</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body {
    margin: 0; padding: 0;
    background: #000;
    height: 100vh; 
    overflow: hidden;
    display: flex; flex-direction: column;
  }

  /* 1. –í–ò–î–ï–û (–ß–ï–°–¢–ù–´–ô –ö–ê–î–†) */
  video {
    width: 100%; height: 100%;
    object-fit: contain; /* –í–ø–∏—Å—ã–≤–∞–µ–º –≤–∏–¥–µ–æ —Ü–µ–ª–∏–∫–æ–º, —á–µ—Ä–Ω—ã–µ –ø–æ–ª–æ—Å—ã –¥–æ–ø—É—Å—Ç–∏–º—ã */
    display: block;
    background: #000;
  }

  /* 2. –°–õ–û–ô –£–†–û–í–ù–Ø (CANVAS) */
  #levelCanvas {
    position: absolute; inset: 0;
    width: 100%; height: 100%;
    z-index: 5;
    pointer-events: none; /* –ö–ª–∏–∫–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç —Å–∫–≤–æ–∑—å –Ω–µ–≥–æ */
  }

  /* 3. –ò–ù–¢–ï–†–§–ï–ô–° */
  .ui-layer {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 140px; 
    background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
    display: flex; 
    flex-direction: column;
    align-items: center; 
    justify-content: flex-end;
    padding-bottom: 30px;
    z-index: 10;
  }

  .btn-row {
    display: flex; align-items: center; gap: 40px;
  }

  /* –ö–Ω–æ–ø–∫–∞ —Å–º–µ–Ω—ã –∫–∞–º–µ—Ä—ã */
  .lens-btn {
    color: rgba(255,255,255,0.9);
    font-size: 13px; font-weight: 600;
    background: rgba(255,255,255,0.15);
    padding: 10px 16px;
    border-radius: 20px;
    cursor: pointer;
    backdrop-filter: blur(4px);
    display: none; /* –°–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    gap: 6px; align-items: center;
    border: 1px solid rgba(255,255,255,0.1);
  }
  
  /* –ö–Ω–æ–ø–∫–∞ –∑–∞—Ç–≤–æ—Ä–∞ */
  .shutter-btn {
    width: 76px; height: 76px;
    background: rgba(255,255,255,0.2);
    border: 4px solid #fff;
    border-radius: 50%;
    cursor: pointer;
    position: relative;
    transition: 0.2s;
  }
  .shutter-btn::after {
    content:''; position:absolute; 
    top:50%; left:50%; transform:translate(-50%,-50%);
    width: 60px; height: 60px; 
    background: #fff; border-radius: 50%;
    transition: 0.2s;
  }
  .shutter-btn:active { transform: scale(0.95); opacity: 0.8; }
  
  /* –ï—Å–ª–∏ —É—Ä–æ–≤–µ–Ω—å –Ω–µ —Ä–æ–≤–Ω—ã–π, –¥–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–æ–π (–≤–∏–∑—É–∞–ª—å–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞) */
  .shutter-btn.bad-angle { opacity: 0.5; border-color: #ff453a; }
  .shutter-btn.bad-angle::after { background: #ff453a; }

  /* –û–≤–µ—Ä–ª–µ–π —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–∞—Ç—á–∏–∫–æ–≤ (iOS) */
  #sensorPermBtn {
    position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
    background: #0a84ff; color: #fff; border: none; padding: 10px 20px;
    border-radius: 20px; font-size: 14px; font-weight: 600; z-index: 50;
    display: none; cursor: pointer;
  }

  /* –ü—Ä–µ–≤—å—é */
  #preview {
    position: absolute; inset: 0; z-index: 100;
    background: #000; display: none; flex-direction: column;
  }
  #previewImg { flex: 1; object-fit: contain; }
  .controls { display: flex; padding: 20px; gap: 15px; background: #000; }
  .btn {
    flex: 1; padding: 15px;
    border-radius: 12px; border: none;
    font-size: 16px; font-weight: 600;
    cursor: pointer; color: #fff; background: #333;
  }
</style>
</head>
<body>

  <button id="sensorPermBtn">–í–∫–ª—é—á–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å üìê</button>

  <video id="video" autoplay playsinline muted></video>
  <canvas id="levelCanvas"></canvas>

  <div class="ui-layer">
    <div class="btn-row">
        <div class="lens-btn" id="btnSwitch">
            <span>üîÑ</span> <span id="lensName">Lens</span>
        </div>

        <div class="shutter-btn" id="btnSnap"></div>
        
        <div style="width: 80px;"></div> 
    </div>
  </div>

  <div id="preview">
    <img id="previewImg">
    <div class="controls">
      <button class="btn" onclick="retake()">–ü–µ—Ä–µ—Å–Ω—è—Ç—å</button>
      <button class="btn" style="background:#007aff" onclick="send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>

<script>
  const tg = window.Telegram?.WebApp;
  if(tg) { tg.ready(); tg.expand(); tg.setHeaderColor('#000000'); }

  // === UI ELEMENTS ===
  const video = document.getElementById('video');
  const canvas = document.getElementById('levelCanvas');
  const ctx = canvas.getContext('2d');
  const shutterBtn = document.getElementById('btnSnap');
  const btnSwitch = document.getElementById('btnSwitch');
  const lensName = document.getElementById('lensName');
  const preview = document.getElementById('preview');
  const previewImg = document.getElementById('previewImg');
  const sensorBtn = document.getElementById('sensorPermBtn');
  
  // === STATE ===
  let videoDevices = [];
  let currentCamIndex = 0;
  const STORAGE_KEY = 'ultima_cam_id_v3';
  
  let state = {
    angleX: 0, // Beta (–Ω–∞–∫–ª–æ–Ω –≤–ø–µ—Ä–µ–¥-–Ω–∞–∑–∞–¥)
    angleY: 0, // Gamma (–Ω–∞–∫–ª–æ–Ω –≤–ª–µ–≤–æ-–≤–ø—Ä–∞–≤–æ)
    levelOK: false // –†–æ–≤–Ω–æ –ª–∏ –¥–µ—Ä–∂–∏–º
  };

  // 1. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
  async function init() {
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –¥–∞—Ç—á–∏–∫–∏ (–¥–ª—è iOS 13+)
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
        sensorBtn.style.display = 'block';
        sensorBtn.onclick = async () => {
            try {
                const resp = await DeviceOrientationEvent.requestPermission();
                if (resp === 'granted') {
                    sensorBtn.style.display = 'none';
                    window.addEventListener('deviceorientation', handleOrientation);
                }
            } catch(e) { alert(e); }
        };
    } else {
        window.addEventListener('deviceorientation', handleOrientation);
    }

    // –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã
    try {
      // –ü—Ä–æ–±—É–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—à–ª—É—é –∫–∞–º–µ—Ä—É
      const savedId = localStorage.getItem(STORAGE_KEY);
      let constraints = { audio: false };
      
      if (savedId) {
          constraints.video = { deviceId: { exact: savedId } };
      } else {
          constraints.video = { facingMode: 'environment' };
      }

      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;

      // –ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Å–∫–∞–Ω–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ "—à–∏—Ä–∏–∫"
      await scanDevices();
      
      // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç—Ä–∏—Å–æ–≤–∫—É —É—Ä–æ–≤–Ω—è
      requestAnimationFrame(drawLoop);

    } catch (e) {
      // –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π ID —Å–ª–æ–º–∞–ª—Å—è (–∫–∞–º–µ—Ä–∞ —Å–º–µ–Ω–∏–ª–∞—Å—å), —Å–±—Ä–æ—Å
      if (localStorage.getItem(STORAGE_KEY)) {
         localStorage.removeItem(STORAGE_KEY);
         init(); 
         return;
      }
      alert("–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: " + e.message);
    }
  }

  // 2. –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï –£–°–¢–†–û–ô–°–¢–í
  async function scanDevices() {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videoInputs = devices.filter(d => d.kind === 'videoinput');

    // –§–∏–ª—å—Ç—Ä —Ñ—Ä–æ–Ω—Ç–∞–ª–æ–∫
    const backCams = videoInputs.filter(d => {
        const l = d.label.toLowerCase();
        return !l.includes('front') && !l.includes('user') && !l.includes('selfie');
    });

    videoDevices = backCams.length > 0 ? backCams : videoInputs;

    if (videoDevices.length > 1) {
        btnSwitch.style.display = 'flex';
        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–Ω—è—Ç—å —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å
        if(video.srcObject) {
            const track = video.srcObject.getVideoTracks()[0];
            const sid = track.getSettings().deviceId;
            const idx = videoDevices.findIndex(c => c.deviceId === sid);
            if(idx !== -1) currentCamIndex = idx;
        }
        lensName.textContent = `Lens ${currentCamIndex + 1}`;
    }
  }

  // 3. –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ö–ê–ú–ï–†–´
  btnSwitch.onclick = async () => {
    if (videoDevices.length < 2) return;
    if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();

    currentCamIndex = (currentCamIndex + 1) % videoDevices.length;
    const nextCam = videoDevices[currentCamIndex];
    localStorage.setItem(STORAGE_KEY, nextCam.deviceId);
    lensName.textContent = `...`;

    if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());

    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: false,
        video: { deviceId: { exact: nextCam.deviceId } }
      });
      video.srcObject = stream;
      lensName.textContent = `Lens ${currentCamIndex + 1}`;
    } catch (e) { alert("Err switch: " + e.message); }
  };

  // 4. –î–ê–¢–ß–ò–ö–ò –ò –£–†–û–í–ï–ù–¨
  function handleOrientation(e) {
    // –ü–æ–ª—É—á–∞–µ–º —É–≥–ª—ã. –î–ª—è —Ñ–æ—Ç–æ —Å–≤–µ—Ä—Ö—É –Ω–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç Beta –∏ Gamma.
    // –ö–æ–≥–¥–∞ —Ç–µ–ª–µ—Ñ–æ–Ω –ª–µ–∂–∏—Ç –Ω–∞ —Å—Ç–æ–ª–µ: Beta ~ 0, Gamma ~ 0.
    if (e.beta !== null && e.gamma !== null) {
        state.angleX = e.gamma; // –ù–∞–∫–ª–æ–Ω –≤–ª–µ–≤–æ-–≤–ø—Ä–∞–≤–æ
        state.angleY = e.beta;  // –ù–∞–∫–ª–æ–Ω –≤–ø–µ—Ä–µ–¥-–Ω–∞–∑–∞–¥
    }
  }

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }

  function drawLoop() {
    const w = canvas.width;
    const h = canvas.height;
    ctx.clearRect(0, 0, w, h);

    const cx = w / 2;
    const cy = h / 2;

    // –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ —É—Ä–æ–≤–Ω—è
    // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (—á–µ–º –º–µ–Ω—å—à–µ –¥–µ–ª–∏—Ç–µ–ª—å, —Ç–µ–º —Ä–µ–∑—á–µ –±–µ–≥–∞–µ—Ç —Ç–æ—á–∫–∞)
    const sensitivity = 4; 
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ, —á—Ç–æ–±—ã —Ç–æ—á–∫–∞ –Ω–µ —É–ª–µ—Ç–∞–ª–∞ –∑–∞ —ç–∫—Ä–∞–Ω
    const clamp = (val, max) => Math.max(-max, Math.min(max, val));
    
    const dx = clamp(state.angleX * sensitivity, w/2 - 20);
    const dy = clamp(state.angleY * sensitivity, h/2 - 20);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–ø–∞–ª–∏ –ª–∏ –≤ —Ü–µ–Ω—Ç—Ä (–¥–æ–ø—É—Å–∫ 10 –≥—Ä–∞–¥—É—Å–æ–≤ —Å–º–µ—â–µ–Ω–∏—è)
    // 10 –≥—Ä–∞–¥—É—Å–æ–≤ * sensitivity(4) = 40 –ø–∏–∫—Å–µ–ª–µ–π —Ä–∞–¥–∏—É—Å
    const dist = Math.hypot(dx, dy);
    const threshold = 30; // –†–∞–¥–∏—É—Å "–∑–µ–ª–µ–Ω–æ–π –∑–æ–Ω—ã" –≤ –ø–∏–∫—Å–µ–ª—è—Ö
    const isLevel = dist < threshold;

    if (isLevel !== state.levelOK) {
        state.levelOK = isLevel;
        // –í–∏–∑—É–∞–ª—å–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è –∫–Ω–æ–ø–∫–∏ —Å–ø—É—Å–∫–∞
        if(isLevel) {
            shutterBtn.classList.remove('bad-angle');
            if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
        } else {
            shutterBtn.classList.add('bad-angle');
        }
    }

    // –†–ò–°–£–ï–ú
    
    // 1. –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –ø—Ä–∏—Ü–µ–ª (–∫—Ä–µ—Å—Ç–∏–∫ –∏–ª–∏ –∫—Ä—É–≥)
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(cx, cy, threshold, 0, Math.PI * 2); // –ö—Ä—É–≥ –¥–æ–ø—É—Å–∫–∞
    ctx.stroke();
    
    // –õ–∏–Ω–∏–∏ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∏—è
    ctx.beginPath();
    ctx.moveTo(cx - 10, cy); ctx.lineTo(cx - threshold, cy);
    ctx.moveTo(cx + 10, cy); ctx.lineTo(cx + threshold, cy);
    ctx.moveTo(cx, cy - 10); ctx.lineTo(cx, cy - threshold);
    ctx.moveTo(cx, cy + 10); ctx.lineTo(cx, cy + threshold);
    ctx.stroke();

    // 2. –ë–µ–≥–∞—é—â–∞—è —Ç–æ—á–∫–∞ (–ü—É–∑—ã—Ä–µ–∫)
    ctx.fillStyle = isLevel ? '#30d158' : '#ff453a'; // –ó–µ–ª–µ–Ω—ã–π –∏–ª–∏ –ö—Ä–∞—Å–Ω—ã–π
    ctx.beginPath();
    ctx.arc(cx + dx, cy + dy, 8, 0, Math.PI * 2);
    ctx.fill();
    
    // –¢–µ–Ω—å/–°–≤–µ—á–µ–Ω–∏–µ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
    ctx.shadowColor = isLevel ? '#30d158' : '#ff453a';
    ctx.shadowBlur = 10;
    ctx.stroke();
    ctx.shadowBlur = 0;

    requestAnimationFrame(drawLoop);
  }

  // 5. –°–™–ï–ú–ö–ê (–¢–æ–ª—å–∫–æ —Ñ–æ—Ç–æ, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ)
  shutterBtn.onclick = () => {
    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É: if(!state.levelOK) return; 
    // –ù–æ –ª—É—á—à–µ –æ—Å—Ç–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–Ω—è—Ç—å "–∫—Ä–∏–≤–æ", –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑–∞–≤ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ.
    
    if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('heavy');
    
    const c = document.createElement('canvas');
    c.width = video.videoWidth;
    c.height = video.videoHeight;
    // –†–∏—Å—É–µ–º —á–∏—Å—Ç—ã–π –∫–∞–¥—Ä –≤–∏–¥–µ–æ
    c.getContext('2d').drawImage(video, 0, 0);
    
    c.toBlob(blob => {
      previewImg.src = URL.createObjectURL(blob);
      preview.style.display = 'flex';
    }, 'image/jpeg');
  };

  window.retake = () => {
    preview.style.display = 'none';
    previewImg.src = '';
  };

  window.send = () => {
    if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
    tg.close();
  };

  init();
</script>
</body>
</html>
