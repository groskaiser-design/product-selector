<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Ultima FoodCam</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root {
    --bg-core: #050505;
    --surface-glass: rgba(20, 20, 20, 0.6);
    --surface-border: rgba(255, 255, 255, 0.15);
    --acc-green: #30d158;
    --acc-red: #ff453a;
    --acc-orange: #ff9f0a;
    --acc-blue: #0a84ff;
    --text-main: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.6);
    --font-stack: -apple-system, BlinkMacSystemFont, 'SF Pro Text', Roboto, sans-serif;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body {
    margin: 0; padding: 0;
    background: #000;
    color: var(--text-main);
    font-family: var(--font-stack);
    height: 100vh; overflow: hidden;
    display: flex; flex-direction: column;
    overscroll-behavior-y: none;
  }

  /* === CAMERA VIEWPORT === */
  .cam-viewport {
    position: relative;
    flex: 1;
    width: 100%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #000;
  }

  /* Video */
  video {
    position: absolute;
    width: 100%; height: 100%;
    object-fit: cover; 
    z-index: 1;
  }
  
  /* –ó–µ—Ä–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ —Ç–æ–ª—å–∫–æ –¥–ª—è CSS (–≤–∏–∑—É–∞–ª—å–Ω–æ), –µ—Å–ª–∏ –Ω—É–∂–Ω–æ */
  video.mirrored { transform: scaleX(-1); }

  /* Canvas UI (Level) */
  #uiCanvas {
    position: absolute;
    inset: 0;
    width: 100%; height: 100%;
    z-index: 10;
    pointer-events: none;
  }

  /* === UI LAYERS === */
  .ui-layer {
    position: absolute;
    inset: 0;
    z-index: 20;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: calc(16px + env(safe-area-inset-top)) 16px calc(32px + env(safe-area-inset-bottom)) 16px;
    pointer-events: none;
  }

  /* Top Bar */
  .top-bar {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    pointer-events: auto;
  }

  .status-chip {
    background: var(--surface-glass);
    border: 1px solid var(--surface-border);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    padding: 8px 16px;
    border-radius: 20px;
    display: flex;
    align-items: center; gap: 8px;
    font-size: 13px; font-weight: 600;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
  }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--acc-orange); box-shadow: 0 0 8px var(--acc-orange); transition: 0.3s; }
  .status-dot.ok { background: var(--acc-green); box-shadow: 0 0 8px var(--acc-green); }

  .icon-btn {
    width: 44px; height: 44px;
    border-radius: 50%;
    background: rgba(40,40,40,0.5);
    border: 1px solid var(--surface-border);
    backdrop-filter: blur(10px);
    display: flex; align-items: center; justify-content: center;
    color: #fff; cursor: pointer;
    transition: transform 0.2s, background 0.2s;
  }
  .icon-btn:active { transform: scale(0.9); background: rgba(80,80,80,0.6); }

  /* Guide overlay */
  .card-guide {
    position: absolute;
    right: 20px; top: 50%; transform: translateY(-50%);
    width: 100px; height: 160px; 
    border: 2px dashed rgba(255,255,255,0.4);
    border-radius: 12px;
    background: rgba(255,255,255,0.05);
    display: flex; align-items: center; justify-content: center;
    text-align: center;
    padding: 8px; 
    pointer-events: none;
  }
  .card-guide span { font-size: 11px; color: rgba(255,255,255,0.7); font-weight: 600; }

  /* Bottom Controls */
  .controls-area {
    display: flex;
    align-items: center;
    justify-content: space-between; 
    pointer-events: auto;
    position: relative;
  }

  .shutter-outer {
    width: 84px; height: 84px;
    border-radius: 50%;
    border: 4px solid rgba(255,255,255,0.3);
    display:flex; align-items:center; justify-content:center;
    transition: 0.3s;
  }
  .shutter-inner {
    width: 64px; height: 64px;
    border-radius: 50%;
    background: #fff;
    transition: 0.3s;
    cursor: pointer;
  }
  
  .shutter-outer.disabled { opacity: 0.5; border-color: var(--acc-red); }
  .shutter-outer.disabled .shutter-inner { background: var(--acc-red); transform: scale(0.4); }
  .shutter-outer.active { border-color: var(--acc-green); transform: scale(1.05); }
  .shutter-outer:active:not(.disabled) .shutter-inner { transform: scale(0.9); }

  /* Permission Overlay */
  .perm-overlay {
    position: absolute; inset: 0; z-index: 100;
    background: rgba(5,5,5,0.85);
    backdrop-filter: blur(20px);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    text-align: center; padding: 32px; gap: 24px;
  }
  .perm-btn {
    background: var(--acc-blue); color: #fff;
    border: none; padding: 16px 32px;
    border-radius: 16px; font-size: 17px; font-weight: 700;
    cursor: pointer;
  }

  /* === RESULT PREVIEW === */
  .preview-overlay {
    position: absolute; inset: 0; z-index: 200;
    background: #000;
    display: none; 
    flex-direction: column;
  }
  
  .preview-img { 
    flex: 1; 
    width: 100%; 
    min-height: 0;
    object-fit: contain; 
    background: #111; 
    margin-bottom: 12px;
  }

  .comment-wrap {
    padding: 0 24px 16px 24px;
    width: 100%;
  }
  
  .comment-label {
    display: block;
    color: var(--text-muted);
    font-size: 13px;
    margin-bottom: 8px;
    margin-left: 4px;
    font-weight: 500;
  }

  .comment-input {
    width: 100%;
    height: 80px;
    background: rgba(255,255,255,0.1);
    border: 1px solid var(--surface-border);
    border-radius: 16px;
    padding: 12px 16px;
    color: #fff;
    font-size: 16px;
    font-family: var(--font-stack);
    resize: none;
    outline: none;
    -webkit-appearance: none;
    transition: 0.2s;
  }
  .comment-input::placeholder { color: rgba(255,255,255,0.3); }
  .comment-input:focus { 
    background: rgba(255,255,255,0.15); 
    border-color: var(--acc-blue); 
  }

  .preview-controls {
    padding: 0 24px 34px 24px;
    display: flex; gap: 16px;
    background: #000;
  }
  
  .btn {
    flex: 1; padding: 14px;
    border-radius: 14px;
    font-weight: 600; font-size: 16px;
    border: 1px solid var(--surface-border);
    background: var(--surface-glass);
    color: #fff; cursor: pointer; text-align: center;
    transition: 0.2s;
  }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn.primary { background: var(--acc-blue); border-color: transparent; }

  /* === TOAST NOTIFICATION === */
  .toast-msg {
    position: absolute;
    top: 100px;
    left: 50%;
    transform: translateX(-50%) translateY(-20px);
    background: rgba(20, 20, 20, 0.9);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    color: #fff;
    padding: 10px 20px;
    border-radius: 30px;
    font-size: 14px;
    font-weight: 600;
    pointer-events: none;
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    z-index: 300;
    display: flex; align-items: center; gap: 8px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    white-space: nowrap;
  }
  .toast-msg.visible { opacity: 1; transform: translateX(-50%) translateY(0); }

  .hidden { display: none !important; }
</style>
</head>
<body>

  <div id="toast" class="toast-msg"></div>

  <div class="cam-viewport">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="uiCanvas"></canvas>
    
    <div class="ui-layer">
      <div class="top-bar">
        <div class="icon-btn" id="btnClose">‚úï</div>
        <div class="status-chip" id="lvlChip">
          <div class="status-dot" id="lvlDot"></div>
          <span id="lvlText">–£—Ä–æ–≤–µ–Ω—å</span>
        </div>
        <div class="icon-btn" id="btnTorch">‚ö°</div>
      </div>

      <div class="card-guide">
        <span>–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
      </div>

      <div class="controls-area">
        <div class="icon-btn" id="btnSwitch">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M23 4v6h-6"></path>
                <path d="M1 20v-6h6"></path>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"></path>
                <path d="M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
        </div>

        <div class="shutter-outer disabled" id="shutterBtn">
          <div class="shutter-inner"></div>
        </div>
        
        <div class="icon-btn" id="btnGallery">üñºÔ∏è</div>
      </div>
    </div>
  </div>

  <div id="permReq" class="perm-overlay hidden">
    <div style="font-size:48px; margin-bottom:10px">üìê</div>
    <h2 style="margin:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∞</h2>
    <p style="color:var(--text-muted)">–î–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –Ω–∞–º –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–∏—Ä–æ—Å–∫–æ–ø —Ç–µ–ª–µ—Ñ–æ–Ω–∞.</p>
    <button class="perm-btn" onclick="requestSensors()">–†–∞–∑—Ä–µ—à–∏—Ç—å</button>
  </div>

  <div id="previewScreen" class="preview-overlay">
    <img id="finalPhoto" class="preview-img">
    
    <div class="comment-wrap">
      <label class="comment-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä: –≤–µ—Å, —Å–æ—Å—Ç–∞–≤)</label>
      <textarea id="commentInput" class="comment-input" placeholder="–¢—Ä–µ—Å–∫–∞ 200–≥, —Ä–∏—Å –±–µ–ª—ã–π 150–≥..."></textarea>
    </div>

    <div class="preview-controls">
      <button id="btnRetake" class="btn" onclick="retake()">–ü–µ—Ä–µ—Å–Ω—è—Ç—å</button>
      <button id="btnSend" class="btn primary" onclick="sendPhoto()">–ì–æ—Ç–æ–≤–æ</button>
    </div>
  </div>

  <input type="file" id="fileInput" accept="image/*" class="hidden">

<script>
  // === TELEGRAM INIT ===
  const tg = window.Telegram?.WebApp;
  if(tg) {
    tg.ready(); tg.expand();
    tg.setHeaderColor('#000000');
    if(tg.disableVerticalSwipes) tg.disableVerticalSwipes();
  }

  // === CONFIG ===
  const TARGET_RES_H = 4096; // –ú–∞–∫—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã (–Ω–µ —Ñ–æ—Ç–æ)
  const TARGET_ASPECT = 0.75; // 3:4 –ø–æ—Ä—Ç—Ä–µ—Ç
  const COMPRESS_MAX_SIZE = 1024; // –ú–∞–∫—Å —Å—Ç–æ—Ä–æ–Ω–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
  const COMPRESS_QUALITY = 0.6;   // –ö–∞—á–µ—Å—Ç–≤–æ JPEG (0-1)

  // === STATE ===
  const state = {
    stream: null,
    track: null,
    imageCapture: null,
    levelOK: false,
    angleX: 0,
    angleY: 0,
    photoBlob: null, // –ó–¥–µ—Å—å —Ö—Ä–∞–Ω–∏—Ç—Å—è –ø–æ–ª–Ω–æ—Ä–∞–∑–º–µ—Ä–Ω—ã–π –æ—Ä–∏–≥–∏–Ω–∞–ª
    isCapturing: false,
    facingMode: 'environment', // 'environment' | 'user'
    isLoopRunning: false
  };

  const DOM = {
    video: document.getElementById('video'),
    canvas: document.getElementById('uiCanvas'),
    ctx: document.getElementById('uiCanvas').getContext('2d'),
    shutter: document.getElementById('shutterBtn'),
    lvlDot: document.getElementById('lvlDot'),
    lvlText: document.getElementById('lvlText'),
    permReq: document.getElementById('permReq'),
    preview: document.getElementById('previewScreen'),
    finalImg: document.getElementById('finalPhoto'),
    btnSend: document.getElementById('btnSend'),
    btnRetake: document.getElementById('btnRetake'),
    fileInput: document.getElementById('fileInput'),
    commentInput: document.getElementById('commentInput'),
    btnSwitch: document.getElementById('btnSwitch'),
    toast: document.getElementById('toast'),
    btnTorch: document.getElementById('btnTorch')
  };

  // --- 1. UTILS: COMPRESSION & TOAST ---
  
  // –§—É–Ω–∫—Ü–∏—è —Å–∂–∞—Ç–∏—è (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ)
  async function compressImage(sourceBlob, quality, maxWidth) {
    const img = new Image();
    const url = URL.createObjectURL(sourceBlob);
    img.src = url;
    
    // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –≤ Image —ç–ª–µ–º–µ–Ω—Ç
    await new Promise((resolve, reject) => {
        img.onload = resolve;
        img.onerror = reject;
    });

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
    let w = img.width;
    let h = img.height;
    const scale = Math.min(maxWidth / w, maxWidth / h, 1);
    
    canvas.width = w * scale;
    canvas.height = h * scale;

    // –†–∏—Å—É–µ–º —É–º–µ–Ω—å—à–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    
    // –û—á–∏—â–∞–µ–º –ø–∞–º—è—Ç—å –æ—Ç ObjectURL –∏—Å—Ö–æ–¥–Ω–∏–∫–∞ (–¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏)
    URL.revokeObjectURL(url);

    return new Promise(resolve => {
        canvas.toBlob(blob => {
            console.log(`[Compression] Original: ${(sourceBlob.size/1024).toFixed(0)}KB -> Compressed: ${(blob.size/1024).toFixed(0)}KB`);
            resolve(blob);
        }, 'image/jpeg', quality);
    });
  }

  let toastTimeout;
  function showToast(text) {
    DOM.toast.textContent = text;
    DOM.toast.classList.add('visible');
    
    if(toastTimeout) clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => {
      DOM.toast.classList.remove('visible');
    }, 2000);
  }

  // --- 2. CAMERA CORE ---
  async function initCamera(mode = 'environment') {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –ø–æ—Ç–æ–∫ (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è Android)
    if (state.stream) {
        state.stream.getTracks().forEach(track => track.stop());
    }

    try {
      const constraints = {
        audio: false,
        video: {
          facingMode: mode, 
          aspectRatio: { ideal: TARGET_ASPECT },
          height: { ideal: TARGET_RES_H },
          width: { ideal: 3072 } 
        }
      };

      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      state.stream = stream;
      state.track = stream.getVideoTracks()[0];
      state.facingMode = mode;
      DOM.video.srcObject = stream;

      // –ü—Ä–∏–º–µ–Ω—è–µ–º Continuous Focus, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–¥–Ω–µ–π –∫–∞–º–µ—Ä—ã)
      const caps = state.track.getCapabilities();
      if (mode === 'environment' && caps.focusMode && caps.focusMode.includes('continuous')) {
        try { await state.track.applyConstraints({ advanced: [{ focusMode: 'continuous' }] }); } catch(e){}
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ImageCapture API (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º)
      if (window.ImageCapture) {
        state.imageCapture = new ImageCapture(state.track);
      } else {
        state.imageCapture = null;
      }
      
      // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–æ–π –≤—Å–ø—ã—à–∫–∏ (—Å–∫—Ä—ã–≤–∞–µ–º –Ω–∞ —Ñ—Ä–æ–Ω—Ç–∞–ª–∫–µ)
      if (mode === 'user') DOM.btnTorch.style.display = 'none';
      else DOM.btnTorch.style.display = 'flex';

      // –ó–∞–ø—É—Å–∫–∞–µ–º UI Loop –æ–¥–∏–Ω —Ä–∞–∑
      if (!state.isLoopRunning) {
          resizeCanvas();
          window.addEventListener('resize', resizeCanvas);
          requestAnimationFrame(drawLoop);
          checkSensorPerms();
          state.isLoopRunning = true;
      }

    } catch (e) {
      console.warn("Camera Init Error:", e);
      // Fallback –Ω–∞ –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –∫–∞–º–µ—Ä—É
      try {
         const fs = await navigator.mediaDevices.getUserMedia({ video: true });
         state.stream = fs;
         state.track = fs.getVideoTracks()[0];
         DOM.video.srcObject = fs;
         if(!state.isLoopRunning) {
             requestAnimationFrame(drawLoop);
             state.isLoopRunning = true;
         }
      } catch(e2){ 
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∞–≤."); 
      }
    }
  }

  // --- 3. SENSORS (GYROSCOPE) ---
  function checkSensorPerms() {
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
      DOM.permReq.classList.remove('hidden'); 
    } else {
      window.addEventListener('deviceorientation', handleOrientation);
    }
  }

  async function requestSensors() {
    try {
      const resp = await DeviceOrientationEvent.requestPermission();
      if (resp === 'granted') {
        DOM.permReq.classList.add('hidden');
        window.addEventListener('deviceorientation', handleOrientation);
      } else {
        alert("–ë–µ–∑ –≥–∏—Ä–æ—Å–∫–æ–ø–∞ —É—Ä–æ–≤–µ–Ω—å –±—É–¥–µ—Ç –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω, –Ω–æ —Ñ–æ—Ç–æ –¥–µ–ª–∞—Ç—å –º–æ–∂–Ω–æ.");
        DOM.permReq.classList.add('hidden');
      }
    } catch (e) { alert("–û—à–∏–±–∫–∞ –¥–∞—Ç—á–∏–∫–æ–≤: " + e); }
  }

  function handleOrientation(e) {
    if (e.beta === null || e.gamma === null) return;
    state.angleX = e.beta; 
    state.angleY = e.gamma; 
  }

  // --- 4. UI LOOP & DRAWING ---
  function updateUI() {
    if (state.isCapturing) return;

    if (state.levelOK) {
      DOM.lvlDot.classList.add('ok');
      DOM.lvlText.textContent = "–†–æ–≤–Ω–æ";
      DOM.shutter.classList.remove('disabled');
      DOM.shutter.classList.add('active');
    } else {
      DOM.lvlDot.classList.remove('ok');
      DOM.lvlText.textContent = "–í—ã—Ä–æ–≤–Ω—è–π—Ç–µ";
      DOM.shutter.classList.add('disabled');
      DOM.shutter.classList.remove('active');
    }
  }

  function resizeCanvas() {
    const w = window.innerWidth;
    const h = window.innerHeight;
    if (DOM.canvas.width !== w || DOM.canvas.height !== h) {
        DOM.canvas.width = w;
        DOM.canvas.height = h;
    }
  }

  function drawLoop() {
    const ctx = DOM.ctx;
    const w = DOM.canvas.width;
    const h = DOM.canvas.height;
    ctx.clearRect(0, 0, w, h);
    const cx = w / 2;
    const cy = h / 2;

    const rBubble = 14; 
    const rTarget = 16;
    const maxOffset = 60; 
    
    // –ó–∞—â–∏—Ç–∞ –æ—Ç Null –∑–Ω–∞—á–µ–Ω–∏–π
    const rawX = (state.angleY === null) ? 0 : state.angleY;
    const rawY = (state.angleX === null) ? 0 : state.angleX;
    
    const clamp = (val) => Math.max(-20, Math.min(20, val));
    const dx = (clamp(rawX) / 20) * maxOffset; 
    const dy = (clamp(rawY) / 20) * maxOffset;

    const dist = Math.hypot(dx, dy);
    const isInside = (dist + rBubble) <= rTarget;

    if (state.levelOK !== isInside && !state.isCapturing) {
      state.levelOK = isInside;
      updateUI();
      if(isInside) haptic('medium');
    }

    // –†–∏—Å–æ–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è
    ctx.shadowBlur = 4;
    ctx.shadowColor = 'rgba(0,0,0,0.5)';
    
    // –ö—Ä—É–≥ —Ü–µ–ª–∏
    ctx.beginPath();
    ctx.arc(cx, cy, rTarget, 0, Math.PI * 2); 
    const color = (state.levelOK || state.isCapturing) ? '#30d158' : 'rgba(255,255,255,0.85)';
    ctx.strokeStyle = color;
    ctx.lineWidth = 3;
    ctx.stroke();

    // –ü—É–∑—ã—Ä–µ–∫
    ctx.beginPath();
    ctx.arc(cx + dx, cy + dy, rBubble, 0, Math.PI * 2); 
    ctx.fillStyle = color;
    ctx.fill();
    ctx.shadowBlur = 0;

    requestAnimationFrame(drawLoop);
  }

  // --- 5. ACTION: CAPTURE (INSTANT) ---
  DOM.shutter.addEventListener('click', async () => {
    if (state.isCapturing) return; 
    if (!state.levelOK) { haptic('error'); return; }

    try {
        state.isCapturing = true; 
        haptic('heavy');
        
        // UI Feedback
        DOM.shutter.style.transform = 'scale(0.8)';
        DOM.shutter.style.opacity = '0.5'; 

        // –î–∞–µ–º UI –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å—Å—è –ø–µ—Ä–µ–¥ –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π –ø–æ—Ç–æ–∫–∞
        await new Promise(r => setTimeout(r, 50));

        let blob = null;

        // A. –ü—Ä–æ–±—É–µ–º ImageCapture (–õ—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ)
        if (state.imageCapture) {
          try {
            blob = await state.imageCapture.takePhoto();
          } catch(e) { console.log('Capture error, fallback to canvas'); }
        }

        // B. Fallback –Ω–∞ Canvas (–ï—Å–ª–∏ ImageCapture –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ —É–ø–∞–ª)
        if (!blob) {
             const vid = DOM.video;
             const c = document.createElement('canvas');
             c.width = vid.videoWidth;
             c.height = vid.videoHeight;
             const ctx = c.getContext('2d');
             
             // –ï—Å–ª–∏ —Ñ—Ä–æ–Ω—Ç–∞–ª–∫–∞ - –º–æ–∂–Ω–æ –∑–µ—Ä–∫–∞–ª–∏—Ç—å, –Ω–æ –¥–ª—è AI –ª—É—á—à–µ "—á–µ—Å—Ç–Ω–æ–µ" —Ñ–æ—Ç–æ
             // –î–ª—è –ø—Ä–µ–≤—å—é —é–∑–µ—Ä–∞ –æ–±—ã—á–Ω–æ –∑–µ—Ä–∫–∞–ª—è—Ç, –Ω–æ –º—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
             ctx.drawImage(vid, 0, 0);
             
             blob = await new Promise(r => c.toBlob(r, 'image/jpeg', 0.95));
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –±–µ–∑ —Å–∂–∞—Ç–∏—è (–±—ã—Å—Ç—Ä–æ)
        showPreview(blob);

    } catch(err) {
        console.error("Critical Capture Error:", err);
        haptic('error');
        alert("–û—à–∏–±–∫–∞ —Å—ä–µ–º–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
    } finally {
        state.isCapturing = false;
        DOM.shutter.style.transform = '';
        DOM.shutter.style.opacity = '';
        updateUI(); 
    }
  });

  // --- 6. ACTION: PREVIEW & SEND (COMPRESSED) ---
  function showPreview(blob) {
    if(!blob) return;
    state.photoBlob = blob;
    // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ blob –¥–ª—è –ø–æ–∫–∞–∑–∞
    DOM.finalImg.src = URL.createObjectURL(blob);
    DOM.preview.style.display = 'flex';
  }

  function retake() {
    DOM.preview.style.display = 'none';
    
    // –û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏
    if(DOM.finalImg.src) {
        URL.revokeObjectURL(DOM.finalImg.src);
        DOM.finalImg.src = '';
    }
    state.photoBlob = null;
    DOM.commentInput.value = ''; 
    
    // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–æ–∫ (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –±—ã–ª–∞ –æ—Ç–º–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏)
    DOM.btnSend.disabled = false;
    DOM.btnSend.textContent = '–ì–æ—Ç–æ–≤–æ';
  }

  async function sendPhoto() {
    if (!state.photoBlob) return;

    const comment = DOM.commentInput.value.trim();
    const btn = DOM.btnSend;
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    btn.disabled = true;
    DOM.btnRetake.disabled = true;
    btn.textContent = '–°–∂–∞—Ç–∏–µ...';
    haptic('light');

    try {
        // 1. –°–ñ–ê–¢–ò–ï (Heavy Task)
        const compressedBlob = await compressImage(state.photoBlob, COMPRESS_QUALITY, COMPRESS_MAX_SIZE);

        btn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

        // 2. –ü–û–î–ì–û–¢–û–í–ö–ê –î–ê–ù–ù–´–• (Base64)
        const reader = new FileReader();
        reader.readAsDataURL(compressedBlob);
        
        reader.onloadend = () => {
            const base64data = reader.result.split(',')[1];
            
            // LOG –î–õ–Ø –û–¢–õ–ê–î–ö–ò (–ü–æ—Ç–æ–º –∑–¥–µ—Å—å –±—É–¥–µ—Ç fetch –≤ GAS)
            console.log(">>> READY TO UPLOAD <<<");
            console.log("Payload Size:", (base64data.length / 1024).toFixed(2), "KB");
            console.log("Comment:", comment);

            // TODO: –í—Å—Ç–∞–≤—å—Ç–µ –∑–¥–µ—Å—å –≤—ã–∑–æ–≤ –≤–∞—à–µ–≥–æ API / telegramData
            // tg.sendData(JSON.stringify({ image: base64data, text: comment })); 
            
            // –ò–º–∏—Ç–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
            setTimeout(() => {
                haptic('success');
                btn.textContent = '–£—Å–ø–µ—à–Ω–æ!';
                setTimeout(() => { 
                    retake(); 
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –Ω–æ—Ä–º—É
                    btn.disabled = false;
                    DOM.btnRetake.disabled = false;
                    btn.textContent = '–ì–æ—Ç–æ–≤–æ';
                }, 1000);
            }, 1000);
        };

    } catch (e) {
        console.error("Send Error:", e);
        btn.textContent = '–û—à–∏–±–∫–∞';
        haptic('error');
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        setTimeout(() => { 
            btn.textContent = '–ì–æ—Ç–æ–≤–æ'; 
            btn.disabled = false;
            DOM.btnRetake.disabled = false;
        }, 2000);
    }
  }

  // --- 7. ACTION: SWITCH CAMERA & TOOLS ---
  DOM.btnSwitch.onclick = () => {
    haptic('medium');
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –∏–∫–æ–Ω–∫–∏
    const icon = DOM.btnSwitch.querySelector('svg');
    icon.style.transition = 'transform 0.5s ease';
    icon.style.transform = 'rotate(180deg)';
    setTimeout(() => icon.style.transform = '', 500);

    // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
    const newMode = state.facingMode === 'environment' ? 'user' : 'environment';
    initCamera(newMode);

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    showToast(newMode === 'environment' ? "–û—Å–Ω–æ–≤–Ω–∞—è –∫–∞–º–µ—Ä–∞" : "–§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞");
  };

  let torchState = false;
  DOM.btnTorch.onclick = async () => {
    if(!state.track) return;
    torchState = !torchState;
    try { 
        await state.track.applyConstraints({ advanced: [{ torch: torchState }] }); 
        haptic('light');
    } catch(e){
        torchState = !torchState; // –í–µ—Ä–Ω—É—Ç—å –∫–∞–∫ –±—ã–ª–æ –µ—Å–ª–∏ –æ—à–∏–±–∫–∞
        showToast("–§–æ–Ω–∞—Ä–∏–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
    }
  };

  // –ì–∞–ª–µ—Ä–µ—è
  document.getElementById('btnGallery').onclick = () => DOM.fileInput.click();
  DOM.fileInput.onchange = (e) => {
    const file = e.target.files[0];
    if(file) {
        showPreview(file);
    }
    e.target.value = ''; // –°–±—Ä–æ—Å, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤—ã–±—Ä–∞—Ç—å —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª —Å–Ω–æ–≤–∞
  };

  document.getElementById('btnClose').onclick = () => {
     if (tg) tg.close();
     else window.history.back();
  };

  function haptic(style) { if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred(style); }

  // START
  initCamera();

</script>

</body>
</html>
