<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Ultima FoodCam</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root {
    --bg-core: #050505;
    --surface-glass: rgba(20, 20, 20, 0.6);
    --surface-border: rgba(255, 255, 255, 0.15);
    --acc-green: #30d158;
    --acc-red: #ff453a;
    --acc-orange: #ff9f0a;
    --acc-blue: #0a84ff;
    --text-main: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.6);
    --font-stack: -apple-system, BlinkMacSystemFont, 'SF Pro Text', Roboto, sans-serif;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body {
    margin: 0; padding: 0;
    background: #000;
    color: var(--text-main);
    font-family: var(--font-stack);
    height: 100vh; overflow: hidden;
    display: flex; flex-direction: column;
    overscroll-behavior-y: none;
  }

  /* === CAMERA VIEWPORT === */
  .cam-viewport {
    position: relative;
    flex: 1;
    width: 100%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #000;
  }

  video {
    position: absolute;
    width: 100%; height: 100%;
    object-fit: cover; 
    z-index: 1;
  }

  #uiCanvas {
    position: absolute; inset: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none;
  }

  /* === UI LAYERS === */
  .ui-layer {
    position: absolute; inset: 0; z-index: 20;
    display: flex; flex-direction: column; justify-content: space-between;
    padding: calc(16px + env(safe-area-inset-top)) 16px calc(32px + env(safe-area-inset-bottom)) 16px;
    pointer-events: none;
  }

  .top-bar { display: flex; justify-content: space-between; align-items: flex-start; pointer-events: auto; }
  
  .status-chip {
    background: var(--surface-glass);
    border: 1px solid var(--surface-border);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    padding: 8px 16px; border-radius: 20px;
    display: flex; align-items: center; gap: 8px;
    font-size: 13px; font-weight: 600;
    transition: all 0.3s ease;
  }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--acc-orange); box-shadow: 0 0 8px var(--acc-orange); transition: 0.3s; }
  .status-dot.ok { background: var(--acc-green); box-shadow: 0 0 8px var(--acc-green); }

  .icon-btn {
    width: 44px; height: 44px; border-radius: 50%;
    background: rgba(40,40,40,0.5); border: 1px solid var(--surface-border);
    backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center;
    color: #fff; cursor: pointer; transition: transform 0.1s;
  }
  .icon-btn:active { transform: scale(0.9); background: rgba(80,80,80,0.6); }

  .card-guide {
    position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
    width: 100px; height: 160px; 
    border: 2px dashed rgba(255,255,255,0.4); border-radius: 12px;
    background: rgba(255,255,255,0.05);
    display: flex; align-items: center; justify-content: center;
    text-align: center; padding: 8px; pointer-events: none;
  }
  .card-guide span { font-size: 11px; color: rgba(255,255,255,0.7); font-weight: 600; }

  .controls-area {
    display: flex; align-items: center; justify-content: space-between; 
    pointer-events: auto; position: relative;
  }

  .shutter-outer {
    width: 84px; height: 84px; border-radius: 50%;
    border: 4px solid rgba(255,255,255,0.3);
    display:flex; align-items:center; justify-content:center; transition: 0.3s;
  }
  .shutter-inner {
    width: 64px; height: 64px; border-radius: 50%; background: #fff; transition: 0.3s; cursor: pointer;
  }
  
  .shutter-outer.disabled { opacity: 0.5; border-color: var(--acc-red); pointer-events: none; }
  .shutter-outer.disabled .shutter-inner { background: var(--acc-red); transform: scale(0.4); }
  .shutter-outer.active { border-color: var(--acc-green); transform: scale(1.05); }
  .shutter-outer:active:not(.disabled) .shutter-inner { transform: scale(0.9); }

  /* Permission Overlay */
  .perm-overlay {
    position: absolute; inset: 0; z-index: 100;
    background: rgba(5,5,5,0.85); backdrop-filter: blur(20px);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    text-align: center; padding: 32px; gap: 24px;
  }
  .perm-btn {
    background: var(--acc-blue); color: #fff; border: none; padding: 16px 32px;
    border-radius: 16px; font-size: 17px; font-weight: 700; cursor: pointer;
  }

  /* Result Preview */
  .preview-overlay {
    position: absolute; inset: 0; z-index: 200; background: #000;
    display: none; flex-direction: column;
  }
  .preview-img { flex: 1; width: 100%; min-height: 0; object-fit: contain; background: #111; margin-bottom: 12px; }
  .comment-wrap { padding: 0 24px 16px 24px; width: 100%; }
  .comment-label { display: block; color: var(--text-muted); font-size: 13px; margin-bottom: 8px; margin-left: 4px; font-weight: 500; }
  .comment-input {
    width: 100%; height: 80px; background: rgba(255,255,255,0.1); border: 1px solid var(--surface-border);
    border-radius: 16px; padding: 12px 16px; color: #fff; font-size: 16px;
    font-family: var(--font-stack); resize: none; outline: none; -webkit-appearance: none;
  }
  .preview-controls { padding: 0 24px 34px 24px; display: flex; gap: 16px; background: #000; }
  .btn {
    flex: 1; padding: 14px; border-radius: 14px; font-weight: 600; font-size: 16px;
    border: 1px solid var(--surface-border); background: var(--surface-glass); color: #fff; cursor: pointer; text-align: center;
  }
  .btn.primary { background: var(--acc-blue); border-color: transparent; }

  .hidden { display: none !important; }
</style>
</head>
<body>

  <div class="cam-viewport">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="uiCanvas"></canvas>
    
    <div class="ui-layer">
      <div class="top-bar">
        <div class="icon-btn" id="btnClose">‚úï</div>
        <div class="status-chip" id="lvlChip">
          <div class="status-dot" id="lvlDot"></div>
          <span id="lvlText">–£—Ä–æ–≤–µ–Ω—å</span>
        </div>
        <div class="icon-btn" id="btnTorch">‚ö°</div>
      </div>

      <div class="card-guide"><span>–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞<br>(–¥–ª—è –º–∞—Å—à—Ç–∞–±–∞)</span></div>

      <div class="controls-area">
        <div class="icon-btn" style="opacity:0; pointer-events:none"></div>
        <div class="shutter-outer disabled" id="shutterBtn"><div class="shutter-inner"></div></div>
        <div class="icon-btn" id="btnGallery">üñºÔ∏è</div>
      </div>
    </div>
  </div>

  <div id="permReq" class="perm-overlay hidden">
    <div style="font-size:48px; margin-bottom:10px">üìê</div>
    <h2 style="margin:0">–î–∞—Ç—á–∏–∫–∏</h2>
    <p style="color:var(--text-muted)">–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∞–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —É—Ä–æ–≤–Ω—è.</p>
    <button class="perm-btn" onclick="requestSensors()">–†–∞–∑—Ä–µ—à–∏—Ç—å</button>
  </div>

  <div id="previewScreen" class="preview-overlay">
    <img id="finalPhoto" class="preview-img">
    <div class="comment-wrap">
      <label class="comment-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
      <textarea id="commentInput" class="comment-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Å—Ç–µ–π–∫ 200–≥, —Ä–∏—Å..."></textarea>
    </div>
    <div class="preview-controls">
      <button class="btn" onclick="retake()">–ü–µ—Ä–µ—Å–Ω—è—Ç—å</button>
      <button class="btn primary" id="btnSend" onclick="sendPhoto()">–ì–æ—Ç–æ–≤–æ</button>
    </div>
  </div>

  <input type="file" id="fileInput" accept="image/*" class="hidden">

<script>
  // === TELEGRAM INIT ===
  const tg = window.Telegram?.WebApp;
  if(tg) {
    tg.ready(); tg.expand(); tg.setHeaderColor('#000000');
    if(tg.disableVerticalSwipes) tg.disableVerticalSwipes();
  }

  // === STATE ===
  const state = {
    stream: null,
    track: null,
    levelOK: false,
    accX: 0, 
    accY: 0,
    photoBlob: null,
    isCapturing: false
  };

  const DOM = {
    video: document.getElementById('video'),
    canvas: document.getElementById('uiCanvas'),
    ctx: document.getElementById('uiCanvas').getContext('2d'),
    shutter: document.getElementById('shutterBtn'),
    lvlDot: document.getElementById('lvlDot'),
    lvlText: document.getElementById('lvlText'),
    permReq: document.getElementById('permReq'),
    preview: document.getElementById('previewScreen'),
    finalImg: document.getElementById('finalPhoto'),
    btnSend: document.getElementById('btnSend'),
    fileInput: document.getElementById('fileInput'),
    commentInput: document.getElementById('commentInput')
  };

  // --- 1. CAMERA INIT ---
  async function initCamera() {
    try {
      // –ü—ã—Ç–∞–µ–º—Å—è –∂–µ—Å—Ç–∫–æ –≤—ã–±—Ä–∞—Ç—å –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É
      const constraints = {
        audio: false,
        video: {
          facingMode: { ideal: 'environment' }, // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∑–∞–¥–Ω–µ–π –∫–∞–º–µ—Ä—ã
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        }
      };

      state.stream = await navigator.mediaDevices.getUserMedia(constraints);
      state.track = state.stream.getVideoTracks()[0];
      DOM.video.srcObject = state.stream;

      // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ–∫—É—Å–∞, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
      const caps = state.track.getCapabilities();
      if (caps.focusMode && caps.focusMode.includes('continuous')) {
        try { await state.track.applyConstraints({ advanced: [{ focusMode: 'continuous' }] }); } catch(e){}
      }

      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      requestAnimationFrame(drawLoop);
      checkSensorPerms();

    } catch (e) {
      alert("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: " + e.message);
    }
  }

  // --- 2. ACCELEROMETER (–í–ú–ï–°–¢–û –ì–ò–†–û–°–ö–û–ü–ê) ---
  function checkSensorPerms() {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è iOS 13+ (DeviceMotion)
    if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
      DOM.permReq.classList.remove('hidden'); 
    } else {
      window.addEventListener('devicemotion', handleMotion);
    }
  }

  async function requestSensors() {
    try {
      const resp = await DeviceMotionEvent.requestPermission();
      if (resp === 'granted') {
        DOM.permReq.classList.add('hidden');
        window.addEventListener('devicemotion', handleMotion);
      } else {
        alert("–ë–µ–∑ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞—Ç—á–∏–∫–∞–º —É—Ä–æ–≤–µ–Ω—å —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ –±—É–¥–µ—Ç");
        DOM.permReq.classList.add('hidden');
      }
    } catch (e) { alert(e); }
  }

  function handleMotion(e) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—é –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–∫–ª–æ–Ω–∞
    // –ï—Å–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –ª–µ–∂–∏—Ç –Ω–∞ —Å—Ç–æ–ª–µ —ç–∫—Ä–∞–Ω–æ–º –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑: X –∏ Y –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–∫–æ–ª–æ 0
    const acc = e.accelerationIncludingGravity;
    if (!acc) return;

    // –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ (Low Pass Filter)
    const alpha = 0.2;
    state.accX = (state.accX * (1-alpha)) + (acc.x * alpha);
    state.accY = (state.accY * (1-alpha)) + (acc.y * alpha);
  }

  // --- 3. UI LOOP ---
  function updateUI() {
    if (state.isCapturing) return;

    if (state.levelOK) {
      DOM.lvlDot.classList.add('ok');
      DOM.lvlText.textContent = "–û—Ç–ª–∏—á–Ω–æ";
      DOM.shutter.classList.remove('disabled');
      DOM.shutter.classList.add('active');
    } else {
      DOM.lvlDot.classList.remove('ok');
      DOM.lvlText.textContent = "–í—ã—Ä–æ–≤–Ω—è–π—Ç–µ";
      DOM.shutter.classList.add('disabled');
      DOM.shutter.classList.remove('active');
    }
  }

  function resizeCanvas() {
    DOM.canvas.width = window.innerWidth;
    DOM.canvas.height = window.innerHeight;
  }

  function drawLoop() {
    const ctx = DOM.ctx;
    const w = DOM.canvas.width;
    const h = DOM.canvas.height;
    ctx.clearRect(0, 0, w, h);
    
    // –†–∏—Å—É–µ–º —É—Ä–æ–≤–µ–Ω—å
    const cx = w / 2;
    const cy = h / 2;
    const maxOffset = 60;
    
    // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º X –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏ –ø—É–∑—ã—Ä—å–∫–∞
    // –ú–Ω–æ–∂–∏—Ç–µ–ª—å 6 —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—á—Ç–æ–±—ã –ø—É–∑—ã—Ä–µ–∫ –±–µ–≥–∞–ª –±—ã—Å—Ç—Ä–µ–µ)
    const dx = -(state.accX * 6); 
    const dy = (state.accY * 6);

    const dist = Math.hypot(dx, dy);
    // –ü–æ—Ä–æ–≥ 20px –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ = —Ä–æ–≤–Ω–æ
    const isInside = (dist <= 20);

    if (state.levelOK !== isInside && !state.isCapturing) {
      state.levelOK = isInside;
      updateUI();
      if(isInside) haptic('medium');
    }

    // –ö—Ä—É–≥ —Ü–µ–ª–∏
    ctx.beginPath();
    ctx.arc(cx, cy, 20, 0, Math.PI * 2); 
    const color = (state.levelOK || state.isCapturing) ? '#30d158' : 'rgba(255,255,255,0.7)';
    ctx.strokeStyle = color;
    ctx.lineWidth = 3;
    ctx.stroke();

    // –ü—É–∑—ã—Ä–µ–∫
    ctx.beginPath();
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã–ª–µ—Ç –ø—É–∑—ã—Ä—å–∫–∞ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —Ü–µ–ª–∏ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã UI
    const limit = 20; 
    const angle = Math.atan2(dy, dx);
    const r = Math.min(dist, limit); // –ü—É–∑—ã—Ä–µ–∫ "–ø—Ä–∏–ª–∏–ø–∞–µ—Ç" –∫ –∫—Ä–∞—é –µ—Å–ª–∏ –¥–∞–ª–µ–∫–æ
    
    // –ï—Å–ª–∏ —É—Ä–æ–≤–µ–Ω—å —Å–∏–ª—å–Ω–æ —Å–±–∏—Ç, –ø—É–∑—ã—Ä–µ–∫ —Ä–∏—Å—É–µ–º –¥–∞–ª—å—à–µ, —á—Ç–æ–±—ã –≤–∏–¥–Ω–æ –±—ã–ª–æ –∫—É–¥–∞ –Ω–∞–∫–ª–æ–Ω—è—Ç—å
    const visualR = (dist > limit) ? limit + (Math.min(dist, 50) - limit)/2 : dist;
    
    ctx.arc(cx + Math.cos(angle)*visualR, cy + Math.sin(angle)*visualR, 12, 0, Math.PI * 2); 
    ctx.fillStyle = color;
    ctx.fill();

    requestAnimationFrame(drawLoop);
  }

  // --- 4. BURST CAPTURE LOGIC (–°–ï–†–ò–Ø) ---
  
  // –§—É–Ω–∫—Ü–∏—è –æ—Ü–µ–Ω–∫–∏ —Ä–µ–∑–∫–æ—Å—Ç–∏ (–ø—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É)
  function getSharpnessScore(ctx, w, h) {
      const cw = w * 0.4; // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º 40% —Ü–µ–Ω—Ç—Ä–∞
      const ch = h * 0.4;
      const sx = (w - cw) / 2;
      const sy = (h - ch) / 2;
      const data = ctx.getImageData(sx, sy, cw, ch).data;
      let score = 0;
      // –°—á–∏—Ç–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É –ø–∏–∫—Å–µ–ª—è–º–∏ (—à–∞–≥ 8 –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏)
      for(let i=0; i<data.length; i+=32) {
          if(i+4 < data.length) {
              score += Math.abs(data[i] - data[i+4]); // Red channel diff
          }
      }
      return score;
  }

  DOM.shutter.addEventListener('click', async () => {
    if (state.isCapturing || !state.levelOK) { 
        if(!state.levelOK) haptic('error');
        return; 
    }

    state.isCapturing = true;
    haptic('heavy');
    DOM.shutter.style.opacity = '0.5';

    try {
        const shots = [];
        const tmpCanvas = document.createElement('canvas');
        tmpCanvas.width = DOM.video.videoWidth;
        tmpCanvas.height = DOM.video.videoHeight;
        const tmpCtx = tmpCanvas.getContext('2d');

        // –°–ï–†–ò–Ø –ò–ó 3 –§–û–¢–û
        for(let i=0; i<3; i++) {
            // –ñ–¥–µ–º —á—É—Ç—å-—á—É—Ç—å (—Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ —Ç–∞–ø–∞ –∏ –º–µ–∂–¥—É –∫–∞–¥—Ä–∞–º–∏)
            await new Promise(r => setTimeout(r, i===0 ? 50 : 100));
            
            // –ó–∞—Ö–≤–∞—Ç –∫–∞–¥—Ä–∞ —Å –≤–∏–¥–µ–æ (–±—ã—Å—Ç—Ä–µ–µ —á–µ–º takePhoto)
            tmpCtx.drawImage(DOM.video, 0, 0);
            const score = getSharpnessScore(tmpCtx, tmpCanvas.width, tmpCanvas.height);
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ Blob
            const blob = await new Promise(r => tmpCanvas.toBlob(r, 'image/jpeg', 0.9));
            shots.push({ blob, score });
            console.log(`Shot ${i+1}: Sharpness ${score}`);
        }

        // –í—ã–±–∏—Ä–∞–µ–º –ª—É—á—à–∏–π
        shots.sort((a, b) => b.score - a.score);
        const best = shots[0];

        showPreview(best.blob);

    } catch(err) {
        console.error(err);
        alert("–û—à–∏–±–∫–∞ —Å—ä–µ–º–∫–∏");
        state.isCapturing = false;
        updateUI();
    }
  });

  function showPreview(blob) {
    state.photoBlob = blob;
    DOM.finalImg.src = URL.createObjectURL(blob);
    DOM.preview.style.display = 'flex';
  }

  function retake() {
    DOM.preview.style.display = 'none';
    if(DOM.finalImg.src) URL.revokeObjectURL(DOM.finalImg.src);
    state.photoBlob = null;
    state.isCapturing = false;
    DOM.shutter.style.opacity = '';
    updateUI();
  }

  // --- 5. FINISH & SCRIPT GAS ---
  function sendPhoto() {
    const comment = DOM.commentInput.value.trim();
    DOM.btnSend.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
    haptic('success');

    // –ò–º–∏—Ç–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è / –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ —Ç—É—Ç –±—É–¥–µ—Ç fetch('https://script.google.com/macros/s/...', formData)
    
    // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (—á—Ç–æ–±—ã —Å–∫–∞–Ω–µ—Ä –∏—Ö –ø–æ–¥—Ö–≤–∞—Ç–∏–ª)
    // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ —Ñ–æ—Ç–æ –ª—É—á—à–µ –≥—Ä—É–∑–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å ID/URL,
    // –Ω–æ –¥–ª—è –¥–µ–º–æ –ø–µ—Ä–µ–¥–∞–µ–º —Ñ–ª–∞–≥.
    sessionStorage.setItem('run_ai_scan', 'true'); 
    
    // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å —Å–∞–º –±–ª–æ–±/–∫–æ–º–º–µ–Ω—Ç, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å IndexedDB –∏–ª–∏ Global State,
    // –ó–¥–µ—Å—å –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è.
    
    setTimeout(() => {
        // –í–û–ó–í–†–ê–¢ –í SCANNER.HTML, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—É—Å—Ç–∏—Ç AI Flow
        window.location.href = 'scanner.html';
    }, 500);
  }

  function haptic(style) { if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred(style); }
  
  let torchState = false;
  document.getElementById('btnTorch').onclick = async () => {
    if(!state.track) return;
    torchState = !torchState;
    try { await state.track.applyConstraints({ advanced: [{ torch: torchState }] }); } catch(e){}
    haptic('light');
  };

  document.getElementById('btnGallery').onclick = () => DOM.fileInput.click();
  DOM.fileInput.onchange = (e) => {
    const file = e.target.files[0];
    if(file) showPreview(file);
    e.target.value = '';
  };

  document.getElementById('btnClose').onclick = () => window.history.back();

  initCamera();

</script>

</body>
</html>
