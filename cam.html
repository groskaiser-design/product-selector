<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Ultima FoodCam</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root {
    --bg-core: #050505;
    --surface-glass: rgba(20, 20, 20, 0.6);
    --surface-border: rgba(255, 255, 255, 0.15);
    --acc-green: #30d158;
    --acc-red: #ff453a;
    --acc-orange: #ff9f0a;
    --acc-blue: #0a84ff;
    --text-main: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.6);
    --font-stack: -apple-system, BlinkMacSystemFont, 'SF Pro Text', Roboto, sans-serif;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body {
    margin: 0; padding: 0;
    background: #000;
    color: var(--text-main);
    font-family: var(--font-stack);
    height: 100vh; overflow: hidden;
    display: flex; flex-direction: column;
    overscroll-behavior-y: none;
  }

  /* === CAMERA VIEWPORT === */
  .cam-viewport {
    position: relative;
    flex: 1;
    width: 100%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #000;
  }

  /* Video: –ò—Å–ø–æ–ª—å–∑—É–µ–º cover –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã UI, –Ω–æ –∑–∞—Ö–≤–∞—Ç –∏–¥–µ—Ç —Å –ø–æ–ª–Ω–æ–≥–æ —Å–µ–Ω—Å–æ—Ä–∞ */
  video {
    position: absolute;
    width: 100%; height: 100%;
    object-fit: cover; 
    z-index: 1;
  }

  /* Canvas: –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —É—Ä–æ–≤–Ω—è –∏ —Å–µ—Ç–∫–∏ */
  #uiCanvas {
    position: absolute;
    inset: 0;
    width: 100%; height: 100%;
    z-index: 10;
    pointer-events: none;
  }

  /* === UI LAYERS === */
  .ui-layer {
    position: absolute;
    inset: 0;
    z-index: 20;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: calc(16px + env(safe-area-inset-top)) 16px calc(32px + env(safe-area-inset-bottom)) 16px;
    pointer-events: none;
  }

  /* Top Bar */
  .top-bar {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    pointer-events: auto;
  }

  .status-chip {
    background: var(--surface-glass);
    border: 1px solid var(--surface-border);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    padding: 8px 16px;
    border-radius: 20px;
    display: flex;
    align-items: center; gap: 8px;
    font-size: 13px; font-weight: 600;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
  }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--acc-orange); box-shadow: 0 0 8px var(--acc-orange); transition: 0.3s; }
  .status-dot.ok { background: var(--acc-green); box-shadow: 0 0 8px var(--acc-green); }

  .icon-btn {
    width: 44px; height: 44px;
    border-radius: 50%;
    background: rgba(40,40,40,0.5);
    border: 1px solid var(--surface-border);
    backdrop-filter: blur(10px);
    display: flex; align-items: center; justify-content: center;
    color: #fff; cursor: pointer;
    transition: transform 0.1s;
  }
  .icon-btn:active { transform: scale(0.9); background: rgba(80,80,80,0.6); }

  /* Guide overlay for card */
  .card-guide {
    position: absolute;
    right: 20px; top: 50%; transform: translateY(-50%);
    width: 80px; height: 130px; /* –ü—Ä–æ–ø–æ—Ä—Ü–∏–∏ –∫—Ä–µ–¥–∏—Ç–∫–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ */
    border: 2px dashed rgba(255,255,255,0.4);
    border-radius: 12px;
    background: rgba(255,255,255,0.05);
    display: flex; align-items: center; justify-content: center;
    text-align: center;
    pointer-events: none;
  }
  .card-guide span { font-size: 10px; color: rgba(255,255,255,0.7); font-weight: 600; padding: 4px; }

  /* Bottom Controls */
  .controls-area {
    display: flex;
    align-items: center;
    justify-content: space-between; 
    pointer-events: auto;
    position: relative;
  }

  .shutter-outer {
    width: 84px; height: 84px;
    border-radius: 50%;
    border: 4px solid rgba(255,255,255,0.3);
    display:flex; align-items:center; justify-content:center;
    transition: 0.3s;
  }
  .shutter-inner {
    width: 64px; height: 64px;
    border-radius: 50%;
    background: #fff;
    transition: 0.3s;
    cursor: pointer;
  }
  
  /* Shutter states */
  .shutter-outer.disabled { opacity: 0.5; border-color: var(--acc-red); }
  .shutter-outer.disabled .shutter-inner { background: var(--acc-red); transform: scale(0.4); }
  .shutter-outer.active { border-color: var(--acc-green); transform: scale(1.05); }
  .shutter-outer:active:not(.disabled) .shutter-inner { transform: scale(0.9); }

  /* Permission Overlay (iOS) */
  .perm-overlay {
    position: absolute; inset: 0; z-index: 100;
    background: rgba(5,5,5,0.85);
    backdrop-filter: blur(20px);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    text-align: center; padding: 32px; gap: 24px;
  }
  .perm-btn {
    background: var(--acc-blue); color: #fff;
    border: none; padding: 16px 32px;
    border-radius: 16px; font-size: 17px; font-weight: 700;
    cursor: pointer;
  }

  /* Result Preview */
  .preview-overlay {
    position: absolute; inset: 0; z-index: 200;
    background: #000;
    display: none; 
    flex-direction: column;
  }
  .preview-img { flex: 1; width: 100%; object-fit: contain; background: #111; }
  .preview-controls {
    padding: 24px;
    display: flex; gap: 16px;
    background: var(--bg-core);
    border-top: 1px solid var(--surface-border);
  }
  .btn {
    flex: 1; padding: 14px;
    border-radius: 14px;
    font-weight: 600; font-size: 16px;
    border: 1px solid var(--surface-border);
    background: var(--surface-glass);
    color: #fff; cursor: pointer; text-align: center;
  }
  .btn.primary { background: var(--acc-blue); border-color: transparent; }

  .hidden { display: none !important; }
</style>
</head>
<body>

  <div class="cam-viewport">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="uiCanvas"></canvas> <div class="ui-layer">
      
      <div class="top-bar">
        <div class="icon-btn" id="btnClose">‚úï</div>
        <div class="status-chip" id="lvlChip">
          <div class="status-dot" id="lvlDot"></div>
          <span id="lvlText">–£—Ä–æ–≤–µ–Ω—å</span>
        </div>
        <div class="icon-btn" id="btnTorch">‚ö°</div>
      </div>

      <div class="card-guide">
        <span>–ö–∞—Ä—Ç–∞<br>(–≠—Ç–∞–ª–æ–Ω)</span>
      </div>

      <div class="controls-area">
        <div class="icon-btn" style="opacity:0; pointer-events:none"></div> <div class="shutter-outer disabled" id="shutterBtn">
          <div class="shutter-inner"></div>
        </div>

        <div class="icon-btn" id="btnGallery">üñºÔ∏è</div>
      </div>
    </div>
  </div>

  <div id="permReq" class="perm-overlay hidden">
    <div style="font-size:48px; margin-bottom:10px">üìê</div>
    <h2 style="margin:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∞</h2>
    <p style="color:var(--text-muted)">–î–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –Ω–∞–º –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–∏—Ä–æ—Å–∫–æ–ø —Ç–µ–ª–µ—Ñ–æ–Ω–∞.</p>
    <button class="perm-btn" onclick="requestSensors()">–†–∞–∑—Ä–µ—à–∏—Ç—å</button>
  </div>

  <div id="previewScreen" class="preview-overlay">
    <img id="finalPhoto" class="preview-img">
    <div class="preview-controls">
      <button class="btn" onclick="retake()">–ü–µ—Ä–µ—Å–Ω—è—Ç—å</button>
      <button class="btn primary" id="btnSend" onclick="sendPhoto()">–ì–æ—Ç–æ–≤–æ</button>
    </div>
  </div>

  <input type="file" id="fileInput" accept="image/*" class="hidden">

<script>
  // === TELEGRAM INIT ===
  const tg = window.Telegram?.WebApp;
  if(tg) {
    tg.ready(); tg.expand();
    tg.setHeaderColor('#000000');
    if(tg.disableVerticalSwipes) tg.disableVerticalSwipes();
  }

  // === CONFIG ===
  const MAX_TILT = 5; // –î–æ–ø—É—Å—Ç–∏–º—ã–π –Ω–∞–∫–ª–æ–Ω –≤ –≥—Ä–∞–¥—É—Å–∞—Ö
  const TARGET_RES_H = 4096; // –¶–µ–ª–µ–≤–∞—è –≤—ã—Å–æ—Ç–∞ (4K)
  const TARGET_ASPECT = 0.75; // 3:4 (–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ)

  // === STATE ===
  const state = {
    stream: null,
    track: null,
    imageCapture: null,
    levelOK: false,
    angleX: 0,
    angleY: 0,
    photoBlob: null
  };

  const DOM = {
    video: document.getElementById('video'),
    canvas: document.getElementById('uiCanvas'),
    ctx: document.getElementById('uiCanvas').getContext('2d'),
    shutter: document.getElementById('shutterBtn'),
    lvlDot: document.getElementById('lvlDot'),
    lvlText: document.getElementById('lvlText'),
    permReq: document.getElementById('permReq'),
    preview: document.getElementById('previewScreen'),
    finalImg: document.getElementById('finalPhoto'),
    btnSend: document.getElementById('btnSend'),
    fileInput: document.getElementById('fileInput')
  };

  // --- 1. CAMERA INIT (HIGH RES / VERTICAL) ---
  async function initCamera() {
    try {
      // –ò—â–µ–º –∏–º–µ–Ω–Ω–æ –∑–∞–¥–Ω–∏–µ –∫–∞–º–µ—Ä—ã
      const devices = await navigator.mediaDevices.enumerateDevices();
      const hasBack = devices.some(d => d.kind === 'videoinput' && d.label.toLowerCase().includes('back'));
      const facing = hasBack ? { ideal: 'environment' } : 'environment';

      // Constraints:
      // 1. facingMode: environment (–∑–∞–¥–Ω—è—è)
      // 2. aspectRatio: 0.75 (3:4 –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ) - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫—Ä–æ–ø/–∑—É–º
      // 3. height: 4096 (–º–∞–∫—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ)
      const constraints = {
        audio: false,
        video: {
          facingMode: facing,
          aspectRatio: { ideal: TARGET_ASPECT },
          height: { ideal: TARGET_RES_H },
          width: { ideal: 3072 } 
        }
      };

      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      state.stream = stream;
      state.track = stream.getVideoTracks()[0];
      DOM.video.srcObject = stream;

      // –ü–æ–ø—ã—Ç–∫–∞ –≤–∫–ª—é—á–∏—Ç—å –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π –∞–≤—Ç–æ—Ñ–æ–∫—É—Å
      const caps = state.track.getCapabilities();
      if (caps.focusMode && caps.focusMode.includes('continuous')) {
        try { await state.track.applyConstraints({ advanced: [{ focusMode: 'continuous' }] }); } catch(e){}
      }

      // Android High-Res Capture support
      if (window.ImageCapture) {
        state.imageCapture = new ImageCapture(state.track);
      }

      // Start Loops
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      requestAnimationFrame(drawLoop);

      // Check iOS Sensors
      checkSensorPerms();

    } catch (e) {
      console.warn("4K Init failed, retrying basic", e);
      try {
         // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
         const fs = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
         state.stream = fs;
         state.track = fs.getVideoTracks()[0];
         DOM.video.srcObject = fs;
         requestAnimationFrame(drawLoop);
      } catch(e2){ alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ"); }
    }
  }

  // --- 2. SENSORS (GYRO) ---
  function checkSensorPerms() {
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
      DOM.permReq.classList.remove('hidden'); // iOS 13+ —Ç—Ä–µ–±—É–µ—Ç –∫–Ω–æ–ø–∫–∏
    } else {
      window.addEventListener('deviceorientation', handleOrientation); // Android —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ä–∞–∑—É
    }
  }

  async function requestSensors() {
    try {
      const resp = await DeviceOrientationEvent.requestPermission();
      if (resp === 'granted') {
        DOM.permReq.classList.add('hidden');
        window.addEventListener('deviceorientation', handleOrientation);
      } else {
        alert("–ë–µ–∑ –≥–∏—Ä–æ—Å–∫–æ–ø–∞ —É—Ä–æ–≤–µ–Ω—å —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ –±—É–¥–µ—Ç");
        DOM.permReq.classList.add('hidden');
      }
    } catch (e) { alert(e); }
  }

  function handleOrientation(e) {
    let x = e.beta;  // –ù–∞–∫–ª–æ–Ω –≤–ø–µ—Ä–µ–¥-–Ω–∞–∑–∞–¥
    let y = e.gamma; // –ù–∞–∫–ª–æ–Ω –≤–ª–µ–≤–æ-–≤–ø—Ä–∞–≤–æ
    if (x === null || y === null) return;

    // –ü—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —É–≥–ª—ã, —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–∏–º–µ—Ç drawLoop
    state.angleX = x;
    state.angleY = y;
  }
  
  // --- 3. UI LOOPS ---
  function updateUI() {
    if (state.levelOK) {
      DOM.lvlDot.classList.add('ok');
      DOM.lvlText.textContent = "–†–æ–≤–Ω–æ";
      DOM.shutter.classList.remove('disabled');
      DOM.shutter.classList.add('active');
    } else {
      DOM.lvlDot.classList.remove('ok');
      DOM.lvlText.textContent = "–í—ã—Ä–æ–≤–Ω—è–π—Ç–µ";
      DOM.shutter.classList.add('disabled');
      DOM.shutter.classList.remove('active');
    }
  }

  function resizeCanvas() {
    DOM.canvas.width = window.innerWidth;
    DOM.canvas.height = window.innerHeight;
  }

  function drawLoop() {
    const ctx = DOM.ctx;
    const w = DOM.canvas.width;
    const h = DOM.canvas.height;
    ctx.clearRect(0, 0, w, h);

    const cx = w / 2;
    const cy = h / 2;

    // === –ù–ê–°–¢–†–û–ô–ö–ò –†–ê–ó–ú–ï–†–û–í ===
    const rBubble = 14;       // –†–∞–¥–∏—É—Å —Ç–æ—á–∫–∏
    const rTarget = 17;       // –†–∞–¥–∏—É—Å —Ü–µ–ª–∏ (–≤—Å–µ–≥–æ –Ω–∞ 2px –±–æ–ª—å—à–µ)
    // ==========================

    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    // maxOffset: –Ω–∞—Å–∫–æ–ª—å–∫–æ –¥–∞–ª–µ–∫–æ —É–ª–µ—Ç–∞–µ—Ç —à–∞—Ä–∏–∫ –ø—Ä–∏ –Ω–∞–∫–ª–æ–Ω–µ. 
    // –ß–µ–º –º–µ–Ω—å—à–µ —á–∏—Å–ª–æ, —Ç–µ–º "—Ç—É–∂–µ" —Ö–æ–¥–∏—Ç —à–∞—Ä–∏–∫ (–ª–µ–≥—á–µ –ø–æ–π–º–∞—Ç—å —Ü–µ–Ω—Ç—Ä).
    const maxOffset = 60; 
    const clamp = (val) => Math.max(-20, Math.min(20, val));
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø—É–∑—ã—Ä—å–∫–∞)
    const dx = (clamp(state.angleY) / 20) * maxOffset; 
    const dy = (clamp(state.angleX) / 20) * maxOffset;

    // === –ù–û–í–ê–Ø –°–¢–†–û–ì–ê–Ø –õ–û–ì–ò–ö–ê ===
    // –°—á–∏—Ç–∞–µ–º –¥–∏—Å—Ç–∞–Ω—Ü–∏—é –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –¥–æ —Ü–µ–Ω—Ç—Ä–∞ —Å–º–µ—â–µ–Ω–Ω–æ–≥–æ –ø—É–∑—ã—Ä—å–∫–∞
    const dist = Math.hypot(dx, dy);
    
    // –£—Å–ª–æ–≤–∏–µ: –ø—É–∑—ã—Ä–µ–∫ —Ü–µ–ª–∏–∫–æ–º –≤–Ω—É—Ç—Ä–∏ –∫—Ä—É–≥–∞
    // (–¥–∏—Å—Ç–∞–Ω—Ü–∏—è –¥–æ —Ü–µ–Ω—Ç—Ä–∞ + —Ä–∞–¥–∏—É—Å –ø—É–∑—ã—Ä—å–∫–∞) –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–µ–Ω—å—à–µ —Ä–∞–¥–∏—É—Å–∞ —Ü–µ–ª–∏
    const isInside = (dist + rBubble) <= rTarget;

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è
    if (state.levelOK !== isInside) {
      state.levelOK = isInside;
      updateUI();
      if(isInside) haptic('medium');
    }
    // ============================

    // 1. –†–∏—Å—É–µ–º –í–Ω–µ—à–Ω–∏–π –∫—Ä—É–≥ (–¶–µ–ª—å)
    ctx.beginPath();
    ctx.arc(cx, cy, rTarget, 0, Math.PI * 2); 
    // –ï—Å–ª–∏ –û–ö - –∑–µ–ª–µ–Ω—ã–π, –µ—Å–ª–∏ –Ω–µ—Ç - –±–µ–ª—ã–π –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π
    ctx.strokeStyle = state.levelOK ? '#30d158' : 'rgba(255,255,255,0.5)';
    ctx.lineWidth = 2;
    ctx.stroke();

    // 2. –†–∏—Å—É–µ–º –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø—É–∑—ã—Ä–µ–∫
    ctx.beginPath();
    ctx.arc(cx + dx, cy + dy, rBubble, 0, Math.PI * 2); 
    // –ï—Å–ª–∏ –û–ö - –∑–µ–ª–µ–Ω—ã–π, –µ—Å–ª–∏ –Ω–µ—Ç - –±–µ–ª—ã–π
    ctx.fillStyle = state.levelOK ? '#30d158' : '#ffffff';
    ctx.fill();

    requestAnimationFrame(drawLoop);
  }

  // --- 4. CAPTURE LOGIC ---
  DOM.shutter.addEventListener('click', async () => {
    if (!state.levelOK) { haptic('error'); return; }
    haptic('heavy');
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏
    DOM.shutter.style.transform = 'scale(0.9)';
    setTimeout(()=> DOM.shutter.style.transform = '', 100);

    // –í–ê–†–ò–ê–ù–¢ –ê: Native Android Photo (–°–∞–º–æ–µ –≤—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ)
    if (state.imageCapture) {
      try {
        const blob = await state.imageCapture.takePhoto();
        showPreview(blob);
        return;
      } catch(e) { console.log('ImageCapture failed, fallback to canvas'); }
    }

    // –í–ê–†–ò–ê–ù–¢ –ë: iOS High-Res Grab (–ü–æ–ª–Ω—ã–π —Å–µ–Ω—Å–æ—Ä)
    // –ú—ã –±–µ—Ä–µ–º –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –≤ –µ–≥–æ —Ä–µ–∞–ª—å–Ω–æ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 3000x4000), 
    // –∞ –Ω–µ —Ç–æ, —á—Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ.
    const vid = DOM.video;
    const c = document.createElement('canvas');
    c.width = vid.videoWidth;
    c.height = vid.videoHeight;
    c.getContext('2d').drawImage(vid, 0, 0);
    c.toBlob(blob => showPreview(blob), 'image/jpeg', 0.95);
  });

  function showPreview(blob) {
    state.photoBlob = blob;
    DOM.finalImg.src = URL.createObjectURL(blob);
    DOM.preview.style.display = 'flex';
  }

  function retake() {
    DOM.preview.style.display = 'none';
    if(DOM.finalImg.src) URL.revokeObjectURL(DOM.finalImg.src);
    DOM.finalImg.src = '';
    state.photoBlob = null;
  }

  function sendPhoto() {
    DOM.btnSend.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
    haptic('light');

    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    console.log("Photo ready to send:", state.photoBlob.size, "bytes");
    
    // –ò–º–∏—Ç–∞—Ü–∏—è —É—Å–ø–µ—Ö–∞
    setTimeout(() => {
        haptic('success');
        DOM.btnSend.textContent = '–£—Å–ø–µ—à–Ω–æ!';
        setTimeout(() => { 
            // window.Telegram.WebApp.close(); // –ú–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –∞–ø–ø
            retake(); 
            DOM.btnSend.textContent = '–ì–æ—Ç–æ–≤–æ';
        }, 1000);
    }, 1000);
  }

  // --- UTILS ---
  function haptic(style) { if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred(style); }
  
  // Torch
  let torchState = false;
  document.getElementById('btnTorch').onclick = async () => {
    if(!state.track) return;
    torchState = !torchState;
    try { await state.track.applyConstraints({ advanced: [{ torch: torchState }] }); } catch(e){}
    haptic('light');
  };

  // Gallery
  document.getElementById('btnGallery').onclick = () => DOM.fileInput.click();
  DOM.fileInput.onchange = (e) => {
    const file = e.target.files[0];
    if(file) showPreview(file);
    e.target.value = '';
  };

  document.getElementById('btnClose').onclick = () => window.history.back();

  // Start
  initCamera();

</script>
</body>
</html>
