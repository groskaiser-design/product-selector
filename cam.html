<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Ultima Scanner v3.0 (Merged)</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  /* =========================================
     CORE STYLES (SCANNER)
     ========================================= */
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
  *::-webkit-scrollbar { display: none; width: 0; height: 0; background: transparent; }
  
  :root {
    --bg-core: #050505;
    --text-main: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.55);
    --surface-glass: rgba(255, 255, 255, 0.07);
    --surface-border: rgba(255, 255, 255, 0.1);
    --acc-green: #30d158;
    --acc-blue: #0a84ff;
    --acc-yellow: #ffcc00;
    --acc-red: #ff453a;
    --acc-over: #00f2ea;
    --acc-over-glow: rgba(0, 242, 234, 0.6);
    --radius-xl: 28px;
    --radius-l: 22px;
    --safe-top: calc(12px + env(safe-area-inset-top));
    --safe-bottom: calc(12px + env(safe-area-inset-bottom));
    --header-height: 340px; 
  }

  body {
    background-color: var(--bg-core);
    margin: 0; padding: 0; width: 100%; height: 100vh;
    overflow: hidden; 
    color: var(--text-main);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Roboto', sans-serif;
    position: fixed; top: 0; left: 0;
    -webkit-font-smoothing: antialiased; 
  }

  /* FX LAYER */
  .fx-layer { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
  .orb { position: absolute; border-radius: 50%; animation: float 30s infinite linear; }
  .orb-1 { width: 90vw; height: 90vw; opacity: 0.4; background: radial-gradient(circle, rgba(108, 92, 231, 0.8) 0%, transparent 70%); top: -20%; left: -20%; }
  .orb-2 { width: 400px; height: 400px; opacity: 0.5; background: radial-gradient(circle, rgba(10, 132, 255, 0.6) 0%, transparent 70%); bottom: -150px; right: -100px; animation: breathe 6s infinite ease-in-out; }
  .noise { position: fixed; inset: 0; opacity: 0.04; background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); pointer-events: none; }
  @keyframes float { 0% {transform:rotate(0deg)} 100% {transform:rotate(360deg)} }
  @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.4; } 50% { transform: scale(1.1); opacity: 0.6; } }

  /* SCANNER LAYOUT */
  .app-layout { position: relative; z-index: 1; height: 100%; display: flex; flex-direction: column; }
  .fixed-header-group { position: absolute; top: 0; left: 0; right: 0; z-index: 50; background: linear-gradient(180deg, rgba(5,5,5,0.95) 0%, rgba(5,5,5,0.85) 70%, rgba(5,5,5,0) 100%); backdrop-filter: blur(10px); }
  
  /* CALENDAR & WIDGETS (Condensed for brevity) */
  .calendar-block { padding-top: var(--safe-top); padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
  .calendar-header { display: flex; justify-content: space-between; padding: 0 16px 8px; }
  .month-label { font-size: 11px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; }
  .calendar-swipe-area { height: 52px; overflow: hidden; position: relative; }
  .calendar-track { display: flex; width: 300%; height: 100%; transform: translateX(-33.333%); will-change: transform; }
  .calendar-week { flex: 1; display: grid; grid-template-columns: repeat(7, 1fr); padding: 0 10px; }
  .day-cell { display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; height: 52px; }
  .day-cell.selected { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); }
  .dc-name { font-size: 9px; color: var(--text-muted); margin-bottom: 3px; }
  .dc-num { font-size: 17px; font-weight: 600; }
  
  .carousel-wrap { padding: 0; }
  .carousel-track { display: flex; gap: 12px; padding: 30px 16px 40px; overflow-x: auto; scrollbar-width: none; }
  .widget { flex: 0 0 calc(100% - 16px); height: 160px; border-radius: 28px; background: rgba(255,255,255,0.05); border: 1px solid var(--surface-border); padding: 16px; position: relative; }
  
  /* MACROS WIDGET */
  .macros-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; height: 100%; align-items: center; }
  .macro-item { display: flex; flex-direction: column; align-items: center; }
  .donut-box { width: 100%; max-width: 74px; aspect-ratio: 1; position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; }
  .mini-donut { width: 100%; height: 100%; transform: rotate(-90deg); }
  .md-bg { fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 7; }
  .md-val { fill: none; stroke-width: 7; stroke-linecap: round; stroke-dasharray: 151; }
  .m-icon { position: absolute; font-size: 20px; }
  .m-nums { font-size: 13px; font-weight: 800; font-variant-numeric: tabular-nums; }
  .m-lbl { font-size: 9px; font-weight: 700; color: rgba(255,255,255,0.5); }

  /* WATER WIDGET */
  .water-widget { display: flex; flex-direction: column; justify-content: space-between; }
  .water-header { display: flex; justify-content: space-between; align-items: center; }
  .water-title { font-size: 11px; font-weight: 800; text-transform: uppercase; color: var(--text-muted); }
  .water-percent { font-size: 12px; font-weight: 700; color: var(--acc-blue); }
  .water-cols { display: flex; gap: 6px; height: 50px; align-items: flex-end; margin: 8px 0; }
  .water-tube { flex: 1; height: 100%; background: rgba(0,0,0,0.4); border-radius: 6px; overflow: hidden; position: relative; }
  .water-fill { position: absolute; bottom: 0; width: 100%; background: var(--acc-blue); transition: height 0.3s; }
  .water-footer { display: flex; justify-content: space-between; align-items: flex-end; }
  .wf-fact { font-size: 28px; font-weight: 800; line-height: 1; }
  .water-btn { width: 54px; height: 44px; border-radius: 14px; background: rgba(255,255,255,0.06); display: flex; align-items: center; justify-content: center; font-size: 22px; }

  /* SCROLL & MEAL CARDS */
  .scroll-container { flex: 1; overflow-y: auto; padding-top: var(--header-height); padding-bottom: 120px; }
  .timeline { padding: 10px 16px; display: flex; flex-direction: column; gap: 12px; }
  .meal-card { background: var(--surface-glass); border: 1px solid var(--surface-border); border-radius: var(--radius-l); padding: 14px; animation: slideIn 0.4s ease; }
  
  .col-headers, .prod-item { display: grid; grid-template-columns: minmax(0, 1fr) 34px 30px 22px 22px 22px; gap: 5px; align-items: center; font-size: 13px; }
  .col-headers { margin-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.08); padding-bottom: 6px; }
  .pi-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .pi-val { text-align: right; }

  /* OMNI BAR */
  .omni-bar { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(10,10,10,0.85); backdrop-filter: blur(30px); border-top: 1px solid var(--surface-border); padding: 8px 12px var(--safe-bottom) 12px; z-index: 100; display: flex; align-items: flex-end; gap: 8px; }
  .icon-btn-omni { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; }
  .input-wrap { flex: 1; min-height: 42px; background: rgba(255,255,255,0.08); border-radius: 20px; padding: 4px 16px; display: flex; align-items: center; }
  textarea { width: 100%; background: transparent; border: none; color: #fff; font-size: 15px; resize: none; padding: 10px 0; }
  .action-btn { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
  .mode-cam { color: #fff; }
  .mode-send { background: var(--acc-blue); color: #fff; }

  /* =========================================
     CAMERA MODULE STYLES (INTEGRATED)
     ========================================= */
  .camera-module {
    position: fixed; inset: 0; z-index: 2000;
    background: #000;
    display: flex; flex-direction: column;
    transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
  }
  .camera-module.visible { transform: translateY(0); }

  .cam-viewport { position: relative; flex: 1; width: 100%; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #000; }
  .cam-video { position: absolute; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
  .cam-canvas { position: absolute; inset: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
  
  .cam-ui-layer { position: absolute; inset: 0; z-index: 20; display: flex; flex-direction: column; justify-content: space-between; padding: calc(16px + env(safe-area-inset-top)) 16px calc(32px + env(safe-area-inset-bottom)) 16px; pointer-events: none; }
  
  .cam-top-bar { display: flex; justify-content: space-between; align-items: flex-start; pointer-events: auto; }
  .status-chip { background: rgba(20,20,20,0.6); border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(20px); padding: 8px 16px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 600; }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--acc-yellow); box-shadow: 0 0 8px var(--acc-yellow); transition: 0.3s; }
  .status-dot.ok { background: var(--acc-green); box-shadow: 0 0 8px var(--acc-green); }

  .cam-icon-btn { width: 44px; height: 44px; border-radius: 50%; background: rgba(40,40,40,0.5); border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; }
  
  .cam-controls { display: flex; align-items: center; justify-content: space-between; pointer-events: auto; }
  .shutter-outer { width: 84px; height: 84px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.3); display:flex; align-items:center; justify-content:center; transition: 0.3s; cursor: pointer;}
  .shutter-inner { width: 64px; height: 64px; border-radius: 50%; background: #fff; transition: 0.3s; }
  .shutter-outer.active { border-color: var(--acc-green); transform: scale(1.05); }
  .shutter-outer.disabled { opacity: 0.5; border-color: var(--acc-red); pointer-events: none; }
  
  /* PREVIEW IN CAM */
  .cam-preview-overlay { position: absolute; inset: 0; z-index: 2010; background: #000; display: none; flex-direction: column; }
  .cam-preview-img { flex: 1; width: 100%; object-fit: contain; background: #111; margin-bottom: 12px; }
  .cam-comment-wrap { padding: 0 24px 16px; }
  .cam-comment-input { width: 100%; height: 80px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15); border-radius: 16px; padding: 12px; color: #fff; font-size: 16px; resize: none; }
  .cam-preview-controls { padding: 0 24px 34px; display: flex; gap: 16px; }
  .cam-btn { flex: 1; padding: 14px; border-radius: 14px; font-weight: 600; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.07); color: #fff; }
  .cam-btn.primary { background: var(--acc-blue); border-color: transparent; }

  /* =========================================
     AI PROCESSING & DRAFT STYLES
     ========================================= */
  .processing-overlay { position: fixed; inset: 0; z-index: 3000; background: rgba(5,5,5,0.6); backdrop-filter: blur(15px); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.4s; }
  .processing-overlay.active { opacity: 1; pointer-events: auto; }
  .proc-card { width: 90%; max-width: 320px; background: rgba(30,30,30,0.6); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 30px 20px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
  .proc-visual { position: relative; width: 60px; height: 60px; margin-bottom: 20px; }
  .proc-orb { position: absolute; inset: 0; border-radius: 50%; background: radial-gradient(circle, #0a84ff 0%, transparent 70%); animation: pulse-ai 2s infinite; }
  .proc-ring { position: absolute; inset: -10px; border-radius: 50%; border: 2px solid rgba(10,132,255,0.3); border-top-color: #0a84ff; animation: spin-ai 1.5s infinite linear; }
  @keyframes pulse-ai { 0% { opacity: 0.5; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.5; transform: scale(0.8); } }
  @keyframes spin-ai { 100% { transform: rotate(360deg); } }
  .proc-steps { width: 100%; display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
  .step { display: flex; align-items: center; gap: 10px; opacity: 0.4; transition: 0.3s; transform: translateX(-10px); }
  .step.active { opacity: 1; transform: translateX(0); font-weight: 600; }
  .step.done { opacity: 0.5; transform: translateX(0); color: var(--acc-green); }
  
  .draft-overlay { position: fixed; inset: 0; z-index: 3100; background: rgba(0,0,0,0.5); display: flex; flex-direction: column; justify-content: flex-end; opacity: 0; pointer-events: none; transition: 0.3s; }
  .draft-overlay.visible { opacity: 1; pointer-events: auto; }
  .draft-sheet { background: #1c1c1e; border-radius: 24px 24px 0 0; padding: 24px 20px calc(20px + env(safe-area-inset-bottom)); transform: translateY(100%); transition: transform 0.3s; }
  .draft-overlay.visible .draft-sheet { transform: translateY(0); }
  .draft-item { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.06); padding: 12px; border-radius: 16px; margin-bottom: 10px; }
  .di-inputs { flex: 1; }
  .di-name { background: transparent; border: none; color: #fff; width: 100%; font-weight: 600; }
  .di-weight { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--acc-blue); width: 60px; text-align: center; font-weight: 700; }
  
  @keyframes slideIn { from { opacity: 0; transform: translateY(-20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
  .hidden { display: none !important; }
</style>
</head>
<body>

<svg width="0" height="0" style="position:absolute"><defs>
  <linearGradient id="grad-kcal"><stop offset="0%" stop-color="#ff9f0a"/><stop offset="100%" stop-color="#ff453a"/></linearGradient>
  <linearGradient id="grad-prot"><stop offset="0%" stop-color="#48bfe3"/><stop offset="100%" stop-color="#5e60ce"/></linearGradient>
  <linearGradient id="grad-fats"><stop offset="0%" stop-color="#f1c40f"/><stop offset="100%" stop-color="#e67e22"/></linearGradient>
  <linearGradient id="grad-carb"><stop offset="0%" stop-color="#2ecc71"/><stop offset="100%" stop-color="#1abc9c"/></linearGradient>
</defs></svg>

<div class="fx-layer"><div class="orb orb-1"></div><div class="orb orb-2"></div><div class="noise"></div></div>

<div class="app-layout" id="appLayout">
  <div class="fixed-header-group">
    <div class="calendar-block">
      <div class="calendar-header"><div class="month-label" id="monthLabel">...</div></div>
      <div class="calendar-swipe-area" id="swipeArea"><div class="calendar-track" id="calTrack"><div class="calendar-week" id="weekPrev"></div><div class="calendar-week" id="weekCurr"></div><div class="calendar-week" id="weekNext"></div></div></div>
    </div>
    <div class="carousel-wrap"><div class="carousel-track" id="track">
      <div class="widget"><div class="macros-grid">
         <div class="macro-item"><div class="donut-box"><svg class="mini-donut" viewBox="0 0 60 60"><circle class="md-bg" cx="30" cy="30" r="24"/><circle class="md-val stroke-kcal" cx="30" cy="30" r="24" style="stroke-dashoffset: 45px"/></svg><div class="m-nums">1450</div><div class="m-lbl">–ö–ö–ê–õ</div></div></div>
         <div class="macro-item"><div class="donut-box"><svg class="mini-donut" viewBox="0 0 60 60"><circle class="md-bg" cx="30" cy="30" r="24"/><circle class="md-val stroke-prot" cx="30" cy="30" r="24" style="stroke-dashoffset: 100px"/></svg><div class="m-nums">110</div><div class="m-lbl">–ë–ï–õ–ö–ò</div></div></div>
         <div class="macro-item"><div class="donut-box"><svg class="mini-donut" viewBox="0 0 60 60"><circle class="md-bg" cx="30" cy="30" r="24"/><circle class="md-val stroke-fats" cx="30" cy="30" r="24" style="stroke-dashoffset: 110px"/></svg><div class="m-nums">45</div><div class="m-lbl">–ñ–ò–†–´</div></div></div>
         <div class="macro-item"><div class="donut-box"><svg class="mini-donut" viewBox="0 0 60 60"><circle class="md-bg" cx="30" cy="30" r="24"/><circle class="md-val stroke-carb" cx="30" cy="30" r="24" style="stroke-dashoffset: 60px"/></svg><div class="m-nums">180</div><div class="m-lbl">–£–ì–õ–ò</div></div></div>
      </div></div>
      <div class="widget water-widget" id="waterCard">
         <div class="water-header"><div class="water-title">–í–æ–¥–∞</div><div class="water-percent" id="lbl-pct">50%</div></div>
         <div class="water-cols"><div class="water-tube"><div class="water-fill" style="height:50%"></div></div><div class="water-tube"><div class="water-fill" style="height:20%"></div></div><div class="water-tube"><div class="water-fill"></div></div></div>
         <div class="water-footer"><div class="wf-fact">1250</div><div class="water-btn" onclick="updateWater(250)">+</div></div>
      </div>
    </div></div>
  </div>

  <div class="scroll-container" id="scrollContainer">
    <div class="timeline" id="feed">
      <div class="meal-card">
        <div class="col-headers"><div class="mh-time">09:00</div><div>–í–µ—Å</div><div>–ö</div><div>–ë</div><div>–ñ</div><div>–£</div></div>
        <div class="prod-item"><div class="pi-name">–û–≤—Å—è–Ω–∫–∞</div><div class="pi-val">250</div><div class="pi-val">220</div><div class="pi-val">8</div><div class="pi-val">6</div><div class="pi-val">32</div></div>
      </div>
    </div>
  </div>

  <div class="omni-bar" id="omniBar">
    <div class="icon-btn-omni">üìÅ</div>
    <div class="input-wrap"><textarea id="msgInput" rows="1" placeholder="–Ø–±–ª–æ–∫–æ 200–≥..."></textarea></div>
    <div class="action-btn mode-cam" id="actionBtn" onclick="handleAction()">
       <svg id="iconCam" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
       <svg id="iconSend" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" style="display:none"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
    </div>
  </div>
</div>

<div class="camera-module" id="camModule">
  <div class="cam-viewport">
    <video id="camVideo" class="cam-video" autoplay playsinline muted></video>
    <canvas id="camCanvas" class="cam-canvas"></canvas>
    <div class="cam-ui-layer">
      <div class="cam-top-bar">
        <div class="cam-icon-btn" onclick="CamModule.close()">‚úï</div>
        <div class="status-chip"><div class="status-dot" id="lvlDot"></div><span id="lvlText">–£—Ä–æ–≤–µ–Ω—å</span></div>
        <div class="cam-icon-btn" id="btnTorch">‚ö°</div>
      </div>
      <div class="cam-controls">
        <div style="width:44px"></div>
        <div class="shutter-outer disabled" id="shutterBtn"><div class="shutter-inner"></div></div>
        <div class="cam-icon-btn">üñºÔ∏è</div>
      </div>
    </div>
  </div>
  <div class="cam-preview-overlay" id="camPreview">
    <img id="camFinalImg" class="cam-preview-img">
    <div class="cam-comment-wrap">
      <textarea id="camComment" class="cam-comment-input" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (—Å–æ—Å—Ç–∞–≤, –≤–µ—Å)..."></textarea>
    </div>
    <div class="cam-preview-controls">
      <button class="cam-btn" onclick="CamModule.retake()">–ü–µ—Ä–µ—Å–Ω—è—Ç—å</button>
      <button class="cam-btn primary" onclick="CamModule.send()">–ì–æ—Ç–æ–≤–æ</button>
    </div>
  </div>
</div>

<div class="processing-overlay" id="procOverlay">
  <div class="proc-card">
    <div class="proc-visual"><div class="proc-orb"></div><div class="proc-ring"></div></div>
    <div style="color:#fff; font-weight:700; margin-bottom:20px">–ê–Ω–∞–ª–∏–∑ —Å–Ω–∏–º–∫–∞</div>
    <div class="proc-steps" id="procSteps">
      <div class="step pending" id="step-1">üõ°Ô∏è Gatekeeper: –ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
      <div class="step pending" id="step-2">üïµÔ∏è Detective: –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã...</div>
      <div class="step pending" id="step-3">üìê Physicist: –û–±—ä–µ–º...</div>
      <div class="step pending" id="step-4">üç≥ Technologist: –ñ–∏—Ä–Ω–æ—Å—Ç—å...</div>
    </div>
    <div style="color:#666; font-size:13px; margin-top:10px" onclick="closeProcessing()">–û—Ç–º–µ–Ω–∞</div>
  </div>
</div>

<div class="draft-overlay" id="draftOverlay">
  <div class="draft-sheet">
    <div style="font-size:20px; font-weight:800; color:#fff; margin-bottom:5px">–ü—Ä–æ–≤–µ—Ä—å –¥–∞–Ω–Ω—ã–µ</div>
    <div style="color:#888; font-size:13px; margin-bottom:20px">AI –æ–ø—Ä–µ–¥–µ–ª–∏–ª —Å–æ—Å—Ç–∞–≤. –ò—Å–ø—Ä–∞–≤—å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ.</div>
    <div id="draftList"></div>
    <div style="display:flex; gap:12px; margin-top:20px">
      <button class="cam-btn" onclick="closeDraft()">–û—Ç–º–µ–Ω–∞</button>
      <button class="cam-btn primary" onclick="confirmDraft()">–í –¥–Ω–µ–≤–Ω–∏–∫</button>
    </div>
  </div>
</div>

<script>
/* =========================================
   SCANNER CORE LOGIC (–û—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
   ========================================= */
function haptic(type) { if (navigator.vibrate) navigator.vibrate(10); if(window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred(type || 'light'); }

const txt = document.getElementById('msgInput');
const btn = document.getElementById('actionBtn');
const iCam = document.getElementById('iconCam');
const iSend = document.getElementById('iconSend');

txt.addEventListener('input', () => {
   if(txt.value.trim().length > 0) {
      btn.classList.replace('mode-cam','mode-send'); iCam.style.display='none'; iSend.style.display='block';
   } else {
      btn.classList.replace('mode-send','mode-cam'); iCam.style.display='block'; iSend.style.display='none';
   }
});

function handleAction() {
   haptic('light');
   if(txt.value.trim().length > 0) {
      console.log('Text send:', txt.value);
      txt.value=''; txt.blur();
      btn.classList.replace('mode-send','mode-cam'); iCam.style.display='block'; iSend.style.display='none';
   } else {
      CamModule.open();
   }
}

/* =========================================
   CAMERA MODULE v3 (BURST + ACCELEROMETER ONLY)
   ========================================= */
const CamModule = {
  el: document.getElementById('camModule'),
  video: document.getElementById('camVideo'),
  canvas: document.getElementById('camCanvas'),
  ctx: document.getElementById('camCanvas').getContext('2d'),
  shutter: document.getElementById('shutterBtn'),
  preview: document.getElementById('camPreview'),
  finalImg: document.getElementById('camFinalImg'),
  
  // State
  stream: null,
  isLevel: false,
  loopId: null,
  
  // Accelerometer Data
  accX: 0, accY: 0, // –ù–∞–∫–ª–æ–Ω (–ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è)
  shakeScore: 0,    // –¢—Ä—è—Å–∫–∞ (–†—ã–≤–∫–∏)

  open: async function() {
    this.el.classList.add('visible');
    try {
       // 1. Video Stream
       const devices = await navigator.mediaDevices.enumerateDevices();
       const hasBack = devices.some(d => d.kind === 'videoinput' && d.label.toLowerCase().includes('back'));
       
       // HD —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ (1080p) - –∑–æ–ª–æ—Ç–∞—è —Å–µ—Ä–µ–¥–∏–Ω–∞ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑–∞ –∏ –∫–∞—á–µ—Å—Ç–≤–∞
       const constraints = {
          video: { 
            facingMode: hasBack ? 'environment' : 'user', 
            width: { ideal: 1920 },
            height: { ideal: 1080 } 
          }
       };
       this.stream = await navigator.mediaDevices.getUserMedia(constraints);
       this.video.srcObject = this.stream;
       
       // 2. ONLY Accelerometer (One sensor for everything)
       // –ò—Å–ø–æ–ª—å–∑—É–µ–º devicemotion. –û–Ω–æ –¥–∞–µ—Ç –∏ –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—é (–¥–ª—è —É—Ä–æ–≤–Ω—è), –∏ —É—Å–∫–æ—Ä–µ–Ω–∏–µ (–¥–ª—è —Ç—Ä—è—Å–∫–∏)
       if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
           // iOS 13+ requires permission
           try { await DeviceMotionEvent.requestPermission(); } catch(e){}
       }
       window.addEventListener('devicemotion', this.handleMotion);
       
       this.resize();
       this.loop();
    } catch(e) {
       alert('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: ' + e);
       this.close();
    }
  },

  close: function() {
    this.el.classList.remove('visible');
    if(this.stream) { this.stream.getTracks().forEach(t => t.stop()); this.stream = null; }
    window.removeEventListener('devicemotion', this.handleMotion);
    cancelAnimationFrame(this.loopId);
    this.retake();
  },

  // === –ï–î–ò–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –î–ê–¢–ß–ò–ö–û–í ===
  handleMotion: function(e) {
    const acc = e.accelerationIncludingGravity;
    if(!acc) return;

    // 1. –õ–û–ì–ò–ö–ê –£–†–û–í–ù–Ø (Low Pass Filter - –ø–ª–∞–≤–Ω–æ—Å—Ç—å)
    // –ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è ~9.8 –º/—Å¬≤. –ï—Å–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –ª–µ–∂–∏—Ç –ø–ª–æ—Å–∫–æ: X=0, Y=0, Z=9.8
    // –ú—ã –±–µ—Ä–µ–º X –∏ Y, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å –Ω–∞–∫–ª–æ–Ω.
    const alpha = 0.2; // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
    CamModule.accX = (CamModule.accX * (1-alpha)) + (acc.x * alpha);
    CamModule.accY = (CamModule.accY * (1-alpha)) + (acc.y * alpha);

    // 2. –õ–û–ì–ò–ö–ê –¢–†–Ø–°–ö–ò (High Pass Filter - —Ä–µ–∑–∫–æ—Å—Ç—å)
    // e.acceleration (–±–µ–∑ –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏–∏) –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–º–µ–Ω–Ω–æ —Ä—ã–≤–∫–∏ —Ä—É–∫–∏
    const pureAcc = e.acceleration; 
    if(pureAcc) {
        const jerk = Math.abs(pureAcc.x) + Math.abs(pureAcc.y) + Math.abs(pureAcc.z);
        CamModule.shakeScore = (CamModule.shakeScore * 0.8) + (jerk * 2);
    }
  },

  // === –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø ===
  loop: function() {
     const w = CamModule.canvas.width; const h = CamModule.canvas.height;
     CamModule.ctx.clearRect(0,0,w,h);
     
     const cx = w/2; const cy = h/2;
     
     // –†–∏—Å—É–µ–º —É—Ä–æ–≤–µ–Ω—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –ê–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä–∞
     // –£–º–Ω–æ–∂–∞–µ–º –Ω–∞ 40, —á—Ç–æ–±—ã —É—Å–∏–ª–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –ø—É–∑—ã—Ä—å–∫–∞
     const dx = -CamModule.accX * 40; 
     const dy = CamModule.accY * 40;
     const dist = Math.hypot(dx,dy);
     
     // –ü–æ—Ä–æ–≥: –µ—Å–ª–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ < 15px –∏ —Ç—Ä—è—Å–∫–∞ –Ω–µ–±–æ–ª—å—à–∞—è
     CamModule.isLevel = (dist < 20); 

     // –¶–≤–µ—Ç –∫–æ–ª—å—Ü–∞: –ó–µ–ª–µ–Ω—ã–π (–û–ö) / –ñ–µ–ª—Ç—ã–π (–¢—Ä—è—Å–∫–∞) / –ë–µ–ª—ã–π (–ö—Ä–∏–≤–æ)
     let color = 'rgba(255,255,255,0.7)';
     if (CamModule.isLevel) {
        color = (CamModule.shakeScore > 2) ? '#ffcc00' : '#30d158'; // –ñ–µ–ª—Ç—ã–π –µ—Å–ª–∏ —Ç—Ä—è—Å–µ—Ç, –ó–µ–ª–µ–Ω—ã–π –µ—Å–ª–∏ –∏–¥–µ–∞–ª
     }

     // –†–∏—Å—É–µ–º UI
     CamModule.ctx.beginPath();
     CamModule.ctx.arc(cx, cy, 20, 0, Math.PI*2);
     CamModule.ctx.strokeStyle = color;
     CamModule.ctx.lineWidth = 4;
     CamModule.ctx.stroke();
     
     CamModule.ctx.beginPath();
     // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ –ø—É–∑—ã—Ä—å–∫–∞ –∫—Ä—É–≥–æ–º
     const limit = 20;
     const angle = Math.atan2(dy, dx);
     const r = Math.min(dist, limit);
     CamModule.ctx.arc(cx + Math.cos(angle)*r, cy + Math.sin(angle)*r, 12, 0, Math.PI*2);
     CamModule.ctx.fillStyle = color;
     CamModule.ctx.fill();

     // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
     const dot = document.getElementById('lvlDot');
     const txt = document.getElementById('lvlText');
     if(CamModule.isLevel) {
        dot.classList.add('ok'); 
        txt.innerText = (CamModule.shakeScore > 2) ? "–ó–∞–º—Ä–∏—Ç–µ..." : "–û—Ç–ª–∏—á–Ω–æ";
        CamModule.shutter.classList.remove('disabled');
     } else {
        dot.classList.remove('ok'); 
        txt.innerText = "–í—ã—Ä–æ–≤–Ω—è–π—Ç–µ";
        CamModule.shutter.classList.add('disabled');
     }

     CamModule.loopId = requestAnimationFrame(CamModule.loop);
  },

  resize: function() {
     this.canvas.width = window.innerWidth;
     this.canvas.height = window.innerHeight;
  },

  // === –ê–õ–ì–û–†–ò–¢–ú –†–ï–ó–ö–û–°–¢–ò (Edge Detection) ===
  getSharpnessScore: function(ctx, w, h) {
      // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ü–µ–Ω—Ç—Ä –∫–∞–¥—Ä–∞ (50% —à–∏—Ä–∏–Ω—ã/–≤—ã—Å–æ—Ç—ã), —Ç–∞–º –æ–±—ã—á–Ω–æ –µ–¥–∞
      const centerW = w * 0.5;
      const centerH = h * 0.5;
      const startX = (w - centerW) / 2;
      const startY = (h - centerH) / 2;
      
      const imageData = ctx.getImageData(startX, startY, centerW, centerH);
      const data = imageData.data;
      let score = 0;
      
      // –ü—Ä–æ—Ö–æ–¥–∏–º —Å —à–∞–≥–æ–º 8 (–¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏), —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å–æ—Å–µ–¥–Ω–∏–µ –ø–∏–∫—Å–µ–ª–∏
      // –ß–µ–º –±–æ–ª—å—à–µ —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É —Å–æ—Å–µ–¥—è–º–∏, —Ç–µ–º —Ä–µ–∑—á–µ –≥—Ä–∞–Ω–∏—Ü—ã
      for (let i = 0; i < data.length; i += 32) { 
          const r = data[i];
          const g = data[i+1];
          const b = data[i+2];
          
          // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –ø–∏–∫—Å–µ–ª–µ–º, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞ 4 —à–∞–≥–∞ –¥–∞–ª—å—à–µ
          if (i + 16 < data.length) {
             const r2 = data[i+16];
             const g2 = data[i+17];
             const b2 = data[i+18];
             score += Math.abs(r - r2) + Math.abs(g - g2) + Math.abs(b - b2);
          }
      }
      return score;
  },

  // === BURST SHOOTING (–°–ï–†–ò–ô–ù–ê–Ø –°–™–ï–ú–ö–ê) ===
  snap: async function() {
     if(!this.isLevel) { haptic('error'); return; }
     haptic('medium'); // –¢–∞–∫—Ç–∏–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫ –Ω–∞—á–∞–ª–∞ —Å–µ—Ä–∏–∏
     
     // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
     this.shutter.classList.add('disabled');
     
     const shots = [];
     const tempCanvas = document.createElement('canvas');
     tempCanvas.width = this.video.videoWidth;
     tempCanvas.height = this.video.videoHeight;
     const tCtx = tempCanvas.getContext('2d');
     
     // –î–µ–ª–∞–µ–º 3 —Å–Ω–∏–º–∫–∞ —Å –ø–∞—É–∑–æ–π 80–º—Å
     // 1. –°—Ä–∞–∑—É (–º–æ–∂–µ—Ç –±—ã—Ç—å —Å–º–∞–∑ –æ—Ç –Ω–∞–∂–∞—Ç–∏—è)
     // 2. –ß–µ—Ä–µ–∑ 80–º—Å (—Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è)
     // 3. –ß–µ—Ä–µ–∑ 160–º—Å (–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π)
     for(let i=0; i<3; i++) {
        tCtx.drawImage(this.video, 0, 0);
        
        // –°—á–∏—Ç–∞–µ–º —Ä–µ–∑–∫–æ—Å—Ç—å
        const sharpness = this.getSharpnessScore(tCtx, tempCanvas.width, tempCanvas.height);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º Blob
        const blob = await new Promise(r => tempCanvas.toBlob(r, 'image/jpeg', 0.85));
        
        shots.push({ blob, sharpness });
        console.log(`Shot ${i+1}: Sharpness Score = ${sharpness}`);
        
        await new Promise(r => setTimeout(r, 80)); // –ü–∞—É–∑–∞
     }
     
     // –í—ã–±–∏—Ä–∞–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è (—Å–∞–º—ã–π –±–æ–ª—å—à–æ–π score)
     shots.sort((a, b) => b.sharpness - a.sharpness);
     const bestShot = shots[0];
     
     console.log('Winner:', bestShot);
     
     // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
     this.finalImg.src = URL.createObjectURL(bestShot.blob);
     this.preview.style.display = 'flex';
     haptic('success'); // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—Å–ø–µ—Ö–∞
     
     this.shutter.classList.remove('disabled');
  },

  retake: function() {
     this.preview.style.display = 'none';
     this.finalImg.src = '';
     document.getElementById('camComment').value = '';
  },

  send: function() {
     haptic('success');
     this.close();
     startProcessingFlow();
  }
};

CamModule.shutter.addEventListener('click', () => CamModule.snap());

// === AI PROCESSING & STARTUP ===
function startProcessingFlow() {
  document.getElementById('procOverlay').classList.add('active');
  const steps = [1,2,3,4];
  let delay = 1000;
  steps.forEach(i => {
     setTimeout(() => {
        const el = document.getElementById('step-'+i);
        if(el) { el.classList.remove('pending'); el.classList.add('active'); }
        haptic('light');
        if(i>1) { document.getElementById('step-'+(i-1)).classList.replace('active','done'); }
     }, delay);
     delay += 1500;
  });
  setTimeout(() => { closeProcessing(); openDraftSheet(); }, delay + 500);
}

function closeProcessing() { document.getElementById('procOverlay').classList.remove('active'); setTimeout(() => { document.querySelectorAll('.step').forEach(el => el.className='step pending'); }, 500); }

function openDraftSheet() {
   const list = document.getElementById('draftList');
   list.innerHTML = `
      <div class="draft-item"><div style="font-size:20px">üçó</div><div class="di-inputs"><input class="di-name" value="–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞"></div><input class="di-weight" type="number" value="145"><div style="font-size:12px;color:#666">–≥</div></div>
      <div class="draft-item"><div style="font-size:20px">üçö</div><div class="di-inputs"><input class="di-name" value="–†–∏—Å –±–µ–ª—ã–π"></div><input class="di-weight" type="number" value="200"><div style="font-size:12px;color:#666">–≥</div></div>`;
   document.getElementById('draftOverlay').classList.add('visible'); haptic('success');
}
function closeDraft() { document.getElementById('draftOverlay').classList.remove('visible'); }
function confirmDraft() { closeDraft(); haptic('heavy'); 
   const feed = document.getElementById('feed');
   feed.insertAdjacentHTML('afterbegin', `<div class="meal-card"><div class="col-headers"><div class="mh-time">–°–µ–π—á–∞—Å</div><div>–í–µ—Å</div><div>–ö</div><div>–ë</div><div>–ñ</div><div>–£</div></div><div class="prod-item"><div class="pi-name">–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞</div><div class="pi-val">145</div><div class="pi-val">239</div><div class="pi-val">45</div><div class="pi-val">5</div><div class="pi-val">0</div></div><div class="prod-item"><div class="pi-name">–†–∏—Å –±–µ–ª—ã–π</div><div class="pi-val">200</div><div class="pi-val">260</div><div class="pi-val">5</div><div class="pi-val">0</div><div class="pi-val">56</div></div></div>`);
}

function setSize() { document.getElementById('appLayout').style.height = window.innerHeight + 'px'; }
window.addEventListener('resize', setSize); setSize();
</script>
  
</body>
</html>
